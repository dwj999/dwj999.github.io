<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="MySQL,AWS,EC2,VIP,MHA," />





  <link rel="alternate" href="/atom.xml" title="Jiessie's' Blog" type="application/atom+xml" />






<meta name="description" content="前言随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在AWS EC2结合MHA做MySQL的高可用，EC2不支持VIP，可通过绑定私有IP的方式来实现。 MHA简介M">
<meta name="keywords" content="MySQL,AWS,EC2,VIP,MHA">
<meta property="og:type" content="article">
<meta property="og:title" content="AWS EC2搭建MHA+VIP+MySQL5.7">
<meta property="og:url" content="https://dwj999.github.io/AWS-EC2搭建MHA-VIP-MySQL5-7.html">
<meta property="og:site_name" content="Jiessie&#39;s&#39; Blog">
<meta property="og:description" content="前言随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在AWS EC2结合MHA做MySQL的高可用，EC2不支持VIP，可通过绑定私有IP的方式来实现。 MHA简介M">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://note.youdao.com/yws/public/resource/bba80193f9c2d29f073784f4e498b134/xmlnote/0A43FC640BD84154ADCD175F765F82E1/33468">
<meta property="og:updated_time" content="2020-05-20T03:46:16.745Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AWS EC2搭建MHA+VIP+MySQL5.7">
<meta name="twitter:description" content="前言随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在AWS EC2结合MHA做MySQL的高可用，EC2不支持VIP，可通过绑定私有IP的方式来实现。 MHA简介M">
<meta name="twitter:image" content="http://note.youdao.com/yws/public/resource/bba80193f9c2d29f073784f4e498b134/xmlnote/0A43FC640BD84154ADCD175F765F82E1/33468">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dwj999.github.io/AWS-EC2搭建MHA-VIP-MySQL5-7.html"/>





  <title>AWS EC2搭建MHA+VIP+MySQL5.7 | Jiessie's' Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/you"><img width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_darkblue_121621.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jiessie's' Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">没伞的孩子必须努力奔跑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/AWS-EC2搭建MHA-VIP-MySQL5-7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">AWS EC2搭建MHA+VIP+MySQL5.7</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T16:51:22+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/集群高可用/" itemprop="url" rel="index">
                    <span itemprop="name">集群高可用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在AWS EC2结合MHA做MySQL的高可用，EC2不支持VIP，可通过绑定私有IP的方式来实现。</p>
<h2 id="MHA简介"><a href="#MHA简介" class="headerlink" title="MHA简介"></a>MHA简介</h2><p>MHA是由日本MySQL专家youshimaton(现就职于Facebook公司)用Perl写的一套MySQL故障切换方案，以保障数据库的高可用性。在MySQL故障切换过程中，MHA能做到在0~30s之内实现主MySQL故障转移。<br>该软件由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）。MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：Amazon Linux<br>master:172.31.13.126<br>slave:172.31.9.182<br>vip:172.31.0.200<br>其中，使用两台机器，分别部署主库和从库，MHA默认部署在从库上，下方中的VIP通指私有IP。  </p>
<h2 id="系统初始化修改"><a href="#系统初始化修改" class="headerlink" title="系统初始化修改"></a>系统初始化修改</h2><h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><h4 id="主库修改主机名"><a href="#主库修改主机名" class="headerlink" title="主库修改主机名"></a>主库修改主机名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/sysconfig/network</span><br><span class="line">NETWORKING=yes</span><br><span class="line">HOSTNAME=master</span><br></pre></td></tr></table></figure>
<h4 id="从库修改主机名"><a href="#从库修改主机名" class="headerlink" title="从库修改主机名"></a>从库修改主机名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/sysconfig/network</span><br><span class="line">NETWORKING=yes</span><br><span class="line">HOSTNAME=slave</span><br></pre></td></tr></table></figure>
<h3 id="修改时区"><a href="#修改时区" class="headerlink" title="修改时区"></a>修改时区</h3><p>Amazon Linux默认安装好后英国时间，需要在主库和从库修改时区<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ln -sf /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</span><br><span class="line">[root@master ~]# /usr/sbin/ntpdate 0.centos.pool.ntp.org &amp;&amp; /sbin/hwclock -w &amp;&gt;/dev/null</span><br></pre></td></tr></table></figure></p>
<h3 id="设置防火墙"><a href="#设置防火墙" class="headerlink" title="设置防火墙"></a>设置防火墙</h3><h4 id="主库设置，允许从库访问"><a href="#主库设置，允许从库访问" class="headerlink" title="主库设置，允许从库访问"></a>主库设置，允许从库访问</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/iptables status|grep 172.31.9.182</span><br><span class="line">15   ACCEPT     all  --  172.31.9.182         0.0.0.0/0           </span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<p>其中，172.31.9.182是允许从库的访问规则</p>
<h4 id="从库设置，允许主库访问"><a href="#从库设置，允许主库访问" class="headerlink" title="从库设置，允许主库访问"></a>从库设置，允许主库访问</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# /etc/init.d/iptables status|grep 172.31.13.126 </span><br><span class="line">15   ACCEPT     all  --  172.31.13.126        0.0.0.0/0           </span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<p>其中，172.31.13.126是允许主库的访问规则</p>
<h3 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h3><p>由于使用的操作系统为Amazon Linux，通过查看无selinux设置。</p>
<h2 id="建立SSH无密码登录"><a href="#建立SSH无密码登录" class="headerlink" title="建立SSH无密码登录"></a>建立SSH无密码登录</h2><h3 id="主库设置"><a href="#主库设置" class="headerlink" title="主库设置"></a>主库设置</h3><p>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no。<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# sed &apos;/^#/d;/^$/d&apos; /etc/ssh/ssh_config |grep GSSAPIAuthentication</span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root@master ~]# sed &apos;/^#/d;/^$/d&apos; /etc/ssh/sshd_config |grep -E &apos;PasswordAuthentication|PermitRootLogin&apos;</span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PermitRootLogin forced-commands-only</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root@master ~]# /etc/init.d/sshd restart</span><br><span class="line">停止 sshd：                                                [确定]</span><br><span class="line">正在启动 sshd：                                            [确定]</span><br></pre></td></tr></table></figure></p>
<p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ssh-keygen</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">43:a3:80:f1:8c:d4:5e:8d:3c:99:e5:39:39:e3:89:9a root@master</span><br><span class="line">The key&apos;s randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|  o. . *.        |</span><br><span class="line">| . *. B..o       |</span><br><span class="line">|  o.+. .X        |</span><br><span class="line">|    .. = *       |</span><br><span class="line">|      o S        |</span><br><span class="line">|     o   .       |</span><br><span class="line">|    E            |</span><br><span class="line">|                 |</span><br><span class="line">|                 |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@master ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.9.182</span><br><span class="line">The authenticity of host &apos;172.31.9.182 (172.31.9.182)&apos; can&apos;t be established.</span><br><span class="line">ECDSA key fingerprint is 72:71:66:dc:6c:b0:31:e7:6c:77:4c:8d:32:69:e0:88.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root@172.31.9.182&apos;s password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   &quot;ssh &apos;root@172.31.9.182&apos;&quot;</span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line">[root@master ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.13.126</span><br><span class="line">The authenticity of host &apos;172.31.13.126 (172.31.13.126)&apos; can&apos;t be established.</span><br><span class="line">ECDSA key fingerprint is b6:ef:9f:f0:5e:fd:8f:49:ef:be:79:fb:44:ea:63:08.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root@172.31.13.126&apos;s password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   &quot;ssh &apos;root@172.31.13.126&apos;&quot;</span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root@master ~]# ssh &apos;root@172.31.9.182&apos;</span><br><span class="line">Last login: Thu Jul 20 04:51:07 2017</span><br><span class="line"></span><br><span class="line">       __|  __|_  )</span><br><span class="line">       _|  (     /   Amazon Linux AMI</span><br><span class="line">      ___|\___|___|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root@slave ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.9.182 closed.</span><br><span class="line">[root@master ~]# ssh &apos;root@172.31.13.126&apos;</span><br><span class="line">Last login: Thu Jul 20 04:37:13 2017</span><br><span class="line"></span><br><span class="line">       __|  __|_  )</span><br><span class="line">       _|  (     /   Amazon Linux AMI</span><br><span class="line">      ___|\___|___|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root@master ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br></pre></td></tr></table></figure></p>
<h3 id="从库设置"><a href="#从库设置" class="headerlink" title="从库设置"></a>从库设置</h3><p>和主库的配置相同<br>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no。<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# sed &apos;/^#/d;/^$/d&apos; /etc/ssh/ssh_config |grep GSSAPIAuthentication</span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root@slave ~]# sed &apos;/^#/d;/^$/d&apos; /etc/ssh/sshd_config |grep -E &apos;PasswordAuthentication|PermitRootLogin&apos;</span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PermitRootLogin forced-commands-only</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root@slave ~]# /etc/init.d/sshd restart</span><br><span class="line">停止 sshd：                                                [确定]</span><br><span class="line">正在启动 sshd：                                            [确定]</span><br></pre></td></tr></table></figure></p>
<p>使用命令ssh-keygen生成公钥，发送到主库，同时尝试在从库无密码形式登录主库，而且也要保证本机无密码登录本机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ssh-keygen</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">7d:57:15:e0:20:6f:6f:45:00:76:c4:ba:66:32:fd:b3 root@slave</span><br><span class="line">The key&apos;s randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|         . ++=ooo|</span><br><span class="line">|          + +.. .|</span><br><span class="line">|           o.. ..|</span><br><span class="line">|         .... .. |</span><br><span class="line">|        S o oo.  |</span><br><span class="line">|         o *..   |</span><br><span class="line">|          = .    |</span><br><span class="line">|             o   |</span><br><span class="line">|             Eo  |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@slave ~]# ssh-keygen</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">da:ea:e3:1c:fb:4b:f5:84:da:a3:47:ea:2c:fa:3c:a6 root@slave</span><br><span class="line">The key&apos;s randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|                 |</span><br><span class="line">|                 |</span><br><span class="line">|                 |</span><br><span class="line">|           .     |</span><br><span class="line">|        S o .    |</span><br><span class="line">|       o +.o     |</span><br><span class="line">|      o +oo .    |</span><br><span class="line">|     o=*....     |</span><br><span class="line">|    EBO**o       |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@slave ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.13.126</span><br><span class="line">The authenticity of host &apos;172.31.13.126 (172.31.13.126)&apos; can&apos;t be established.</span><br><span class="line">ECDSA key fingerprint is b6:ef:9f:f0:5e:fd:8f:49:ef:be:79:fb:44:ea:63:08.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root@172.31.13.126&apos;s password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   &quot;ssh &apos;root@172.31.13.126&apos;&quot;</span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root@slave ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.9.182</span><br><span class="line">The authenticity of host &apos;172.31.9.182 (172.31.9.182)&apos; can&apos;t be established.</span><br><span class="line">ECDSA key fingerprint is 72:71:66:dc:6c:b0:31:e7:6c:77:4c:8d:32:69:e0:88.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root@172.31.9.182&apos;s password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   &quot;ssh &apos;root@172.31.9.182&apos;&quot;</span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root@slave ~]# ssh &apos;root@172.31.13.126&apos;</span><br><span class="line">Last login: Thu Jul 20 05:36:57 2017 from 172.31.13.126</span><br><span class="line"></span><br><span class="line">       __|  __|_  )</span><br><span class="line">       _|  (     /   Amazon Linux AMI</span><br><span class="line">      ___|\___|___|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root@master ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br><span class="line">[root@slave ~]# ssh &apos;root@172.31.9.182&apos; </span><br><span class="line">Last login: Thu Jul 20 05:36:46 2017 from 172.31.13.126</span><br><span class="line"></span><br><span class="line">       __|  __|_  )</span><br><span class="line">       _|  (     /   Amazon Linux AMI</span><br><span class="line">      ___|\___|___|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root@slave ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.9.182 closed.</span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL安装"><a href="#MySQL安装" class="headerlink" title="MySQL安装"></a>MySQL安装</h2><p>使用的是自己打包的RPM包，分别登录主库和从库，直接rpm -ivh percona-server-5.7.18-15.x86_64.rpm 即可，也可使用其他方式安装MySQL<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mv /home/zhouting/percona-server-5.7.18-15.x86_64.rpm  /usr/src/</span><br><span class="line">[root@master ~]# rpm -ivh /usr/src/percona-server-5.7.18-15.x86_64.rpm </span><br><span class="line">Preparing...                          ################################# [100%]</span><br><span class="line">Updating / installing...</span><br><span class="line">   1:percona-server-5.7.18-15         ################################# [100%]</span><br><span class="line">error reading information on service /etc/rc.d/init.d/mysqld: No such file or directory</span><br><span class="line"> ERROR! MySQL (Percona Server) PID file could not be found!</span><br><span class="line">Starting MySQL (Percona Server).. SUCCESS! </span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Warning: Since password will be sent to server in plain text, use ssl connection to ensure password safety.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br></pre></td></tr></table></figure></p>
<p>查看是否安装成功，分别登录主库和从库查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 11</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 16:57:43 &gt; select version();</span><br><span class="line">+---------------+</span><br><span class="line">| version()     |</span><br><span class="line">+---------------+</span><br><span class="line">| 5.7.18-15-log |</span><br><span class="line">+---------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 16:57:47 &gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL互为主备"><a href="#MySQL互为主备" class="headerlink" title="MySQL互为主备"></a>MySQL互为主备</h2><h3 id="重要参数配置"><a href="#重要参数配置" class="headerlink" title="重要参数配置"></a>重要参数配置</h3><p>主库必须包含以下参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 1</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 1</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br></pre></td></tr></table></figure></p>
<p>从库必须包含以下参数，注意slave需要动态设置read_only=1，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 2</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 2</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br><span class="line">relay_log_purge=0</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e &quot;show variables like &apos;read_only&apos;&quot;</span><br><span class="line">Enter password: </span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| read_only     | OFF   |</span><br><span class="line">+---------------+-------+</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e &quot;set global read_only=1&quot;</span><br><span class="line">Enter password: </span><br><span class="line">[root@slave ~]# mysql -uroot -p -e &quot;show variables like &apos;read_only&apos;&quot;</span><br><span class="line">Enter password: </span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| read_only     | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="复制帐号建立"><a href="#复制帐号建立" class="headerlink" title="复制帐号建立"></a>复制帐号建立</h3><p>由于MySQL版本使用的是5.7，创建用户的方法以之前有些不同  </p>
<h4 id="主库创建"><a href="#主库创建" class="headerlink" title="主库创建"></a>主库创建</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 6</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:16:52 &gt; create user &apos;slave01&apos;@&apos;172.31.9.182&apos; identified by &apos;slave123456&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:17:21 &gt; grant replication slave,replication client on *.* to &apos;slave01&apos;@&apos;172.31.9.182&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:17:34 &gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:17:38 &gt; exit</span><br></pre></td></tr></table></figure>
<h4 id="从库创建"><a href="#从库创建" class="headerlink" title="从库创建"></a>从库创建</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 6</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:19:24 &gt; create user &apos;slave01&apos;@&apos;172.31.13.126&apos; identified by &apos;slave123456&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:19:49 &gt; grant replication slave,replication client on *.* to &apos;slave01&apos;@&apos;172.31.13.126&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:20:02 &gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:20:05 &gt; exit</span><br></pre></td></tr></table></figure>
<h4 id="复制帐号验证"><a href="#复制帐号验证" class="headerlink" title="复制帐号验证"></a>复制帐号验证</h4><p>主库登录从库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -h172.31.9.182 -uslave01 -pslave123456</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:22:15 &gt; exit</span><br></pre></td></tr></table></figure></p>
<p>从库登录主库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -h172.31.13.126 -uslave01 -pslave123456             </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:22:57 &gt; exit</span><br></pre></td></tr></table></figure></p>
<h3 id="复制关系配置"><a href="#复制关系配置" class="headerlink" title="复制关系配置"></a>复制关系配置</h3><h4 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h4><p>登录主库，设置复制关系，来源于从库的复制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 17</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:32:19 &gt; change master to master_host=&apos;172.31.9.182&apos;,master_user=&apos;slave01&apos;,master_password=&apos;slave123456&apos;,master_auto_position=1;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.04 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:33:03 &gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:33:47 &gt; show slave status\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.31.9.182</span><br><span class="line">                  Master_User: slave01</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000003</span><br><span class="line">          Read_Master_Log_Pos: 810</span><br><span class="line">               Relay_Log_File: master-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 1023</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000003</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 810</span><br><span class="line">              Relay_Log_Space: 1231</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 2</span><br><span class="line">                  Master_UUID: a1c1d189-6b96-11e7-9825-02a13635a5ca</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: a1c1d189-6b96-11e7-9825-02a13635a5ca:1-3</span><br><span class="line">            Executed_Gtid_Set: 9a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17,</span><br><span class="line">a1c1d189-6b96-11e7-9825-02a13635a5ca:1-3</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:33:54 &gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h4><p>登录从库，设置复制关系，来源于主库的复制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 10</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:34:41 &gt; change master to master_host=&apos;172.31.13.126&apos;,master_user=&apos;slave01&apos;,master_password=&apos;slave123456&apos;,master_auto_position=1;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.03 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:35:14 &gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:35:15 &gt; show slave status\G;</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 172.31.0.139</span><br><span class="line">                  Master_User: slave01</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 4455</span><br><span class="line">               Relay_Log_File: slave-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 4059</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 4455</span><br><span class="line">              Relay_Log_Space: 4266</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: 9a7b78fc-6b96-11e7-9856-0232d9c5deea</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: 9a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17</span><br><span class="line">            Executed_Gtid_Set: 9a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17,</span><br><span class="line">a1c1d189-6b96-11e7-9825-02a13635a5ca:1-3</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">ERROR: </span><br><span class="line">No query specified</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:35:18 &gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="复制测试"><a href="#复制测试" class="headerlink" title="复制测试"></a>复制测试</h3><h4 id="主库登录测试"><a href="#主库登录测试" class="headerlink" title="主库登录测试"></a>主库登录测试</h4><p>登录主库，插入测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 37</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:35:48 &gt; create database if not exists test11;use test11;                                                           </span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] 17:35:52 &gt; create table if not exists t11(id int unsigned not null auto_increment,name varchar(20),primary key(`id`));</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 17:35:55 &gt; insert into t11 values(null,&apos;master11&apos;);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 17:35:58 &gt; select * from t11;</span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | master11 |</span><br><span class="line">+----+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 17:36:02 &gt;</span><br></pre></td></tr></table></figure></p>
<p>登录从库，查看测试数据，此时数据已经复制过来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p </span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 29</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:36:25 &gt; select * from test11.t11;</span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | master11 |</span><br><span class="line">+----+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:36:30 &gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="从库登录测试"><a href="#从库登录测试" class="headerlink" title="从库登录测试"></a>从库登录测试</h4><p>登录从库，插入测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p </span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 32</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:37:59 &gt; create database if not exists test11;use test11;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.01 sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] 17:38:03 &gt; create table if not exists t22(id int unsigned not null auto_increment,name varchar(20),primary key(`id`));     </span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 17:38:18 &gt; insert into t22 values(null,&apos;slave11&apos;); </span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 17:38:30 &gt; select * from t22;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  2 | slave11 |</span><br><span class="line">+----+---------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 17:38:35 &gt;</span><br></pre></td></tr></table></figure></p>
<p>登录主库，查看测试数据，此时数据已经复制过来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 38</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:39:09 &gt; select * from test11.t22;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  2 | slave11 |</span><br><span class="line">+----+---------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:39:15 &gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="MHA帐号建立"><a href="#MHA帐号建立" class="headerlink" title="MHA帐号建立"></a>MHA帐号建立</h3><h4 id="主库创建-1"><a href="#主库创建-1" class="headerlink" title="主库创建"></a>主库创建</h4><p>登录主库，创建允许主库和从库连接的MHA用户信息，再分别尝试使用MHA用户登录(省略)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 41</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 09:36:55 &gt; create user &apos;mha01&apos;@&apos;172.31.9.182&apos; identified by &apos;mha123456&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 09:37:14 &gt; grant all privileges on *.* to &apos;mha01&apos;@&apos;172.31.9.182&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 09:38:02 &gt; create user &apos;mha01&apos;@&apos;172.31.13.126&apos; identified by &apos;mha123456&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 09:38:14 &gt; grant all privileges on *.* to &apos;mha01&apos;@&apos;172.31.13.126&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 09:38:18 &gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="从库创建-1"><a href="#从库创建-1" class="headerlink" title="从库创建"></a>从库创建</h4><p>登录从库，由于复制已经把在主库创建的MHA用户信息复制了过来，尝试登录即可(省略)</p>
<h2 id="MHA安装"><a href="#MHA安装" class="headerlink" title="MHA安装"></a>MHA安装</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>分别在主库和从库上安装，执行命令：<br>yum -y install gcc gcc-c++ make openssl-devel perl perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Config-IniFiles perl-Time-HiRes perl-Module-Install.noarch mailx jwhois</p>
<h3 id="主库安装mha4mysql-node"><a href="#主库安装mha4mysql-node" class="headerlink" title="主库安装mha4mysql-node"></a>主库安装mha4mysql-node</h3><p>MHA管理端安装在从库上，主库上只需要mha4mysql-node即可，由于MySQL使用5.7版本，MHA也使用最新的0.57版本，采用编译安装方式。下载地址：<a href="https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw" target="_blank" rel="noopener">https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd /usr/src/</span><br><span class="line">[root@master src]# tar -zxf mha4mysql-node-0.57.tar.gz</span><br><span class="line">[root@master mha4mysql-node-0.57]# perl Makefile.PL             #编译过程省略</span><br><span class="line">[root@master mha4mysql-node-0.57]# make</span><br><span class="line">[root@master mha4mysql-node-0.57]# make install</span><br><span class="line">[root@master mha4mysql-node-0.57]# ll /usr/local/bin/ -t        #查看安装，有以下文件则mha4mysql-node安装成功</span><br><span class="line">total 1760</span><br><span class="line">-r-xr-xr-x 1 root root  16381 Jul 21 09:41 apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x 1 root root   8261 Jul 21 09:41 purge_relay_logs</span><br><span class="line">-r-xr-xr-x 1 root root   7525 Jul 21 09:41 save_binary_logs</span><br><span class="line">-r-xr-xr-x 1 root root   4807 Jul 21 09:41 filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p>
<h3 id="从库安装mha4mysql-manager和mha4mysql-node"><a href="#从库安装mha4mysql-manager和mha4mysql-node" class="headerlink" title="从库安装mha4mysql-manager和mha4mysql-node"></a>从库安装mha4mysql-manager和mha4mysql-node</h3><p>MHA管理端安装在从库，从库需要安装manager端和node端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cd /usr/src/</span><br><span class="line">[root@slave src]# tar -zxf mha4mysql-manager-0.57.tar.gz </span><br><span class="line">[root@slave src]# cd mha4mysql-manager-0.57</span><br><span class="line">[root@slave mha4mysql-manager-0.57]# perl Makefile.PL           #编译过程省略</span><br><span class="line">[root@slave mha4mysql-manager-0.57]# make</span><br><span class="line">[root@slave mha4mysql-manager-0.57]# make install </span><br><span class="line">[root@slave mha4mysql-manager-0.57]# ll /usr/local/bin/ -t      #查看安装，有以下文件则mha4mysql-manager安装成功</span><br><span class="line">total 1756</span><br><span class="line">-r-xr-xr-x 1 root root   1779 Jul 21 09:48 masterha_check_ssh</span><br><span class="line">-r-xr-xr-x 1 root root   2517 Jul 21 09:48 masterha_manager</span><br><span class="line">-r-xr-xr-x 1 root root   2373 Jul 21 09:48 masterha_master_switch</span><br><span class="line">-r-xr-xr-x 1 root root   5171 Jul 21 09:48 masterha_secondary_check</span><br><span class="line">-r-xr-xr-x 1 root root   1995 Jul 21 09:48 masterha_check_repl</span><br><span class="line">-r-xr-xr-x 1 root root   1865 Jul 21 09:48 masterha_check_status</span><br><span class="line">-r-xr-xr-x 1 root root   3201 Jul 21 09:48 masterha_conf_host</span><br><span class="line">-r-xr-xr-x 1 root root   2165 Jul 21 09:48 masterha_master_monitor</span><br><span class="line">-r-xr-xr-x 1 root root   1739 Jul 21 09:48 masterha_stop</span><br><span class="line">[root@slave mha4mysql-manager-0.57]# cd ..</span><br><span class="line">[root@slave src]# tar -zxf mha4mysql-node-0.57.tar.gz </span><br><span class="line">[root@slave src]# cd mha4mysql-node-0.57</span><br><span class="line">[root@slave mha4mysql-node-0.57]# perl Makefile.PL              #编译过程省略        </span><br><span class="line">[root@slave mha4mysql-node-0.57]# make</span><br><span class="line">[root@slave mha4mysql-node-0.57]# make install</span><br><span class="line">[root@slave mha4mysql-node-0.57]# ll /usr/local/bin/ -t         #查看安装，有以下文件则mha4mysql-node安装成功</span><br><span class="line">total 1800</span><br><span class="line">-r-xr-xr-x 1 root root  16381 Jul 21 09:54 apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x 1 root root   8261 Jul 21 09:54 purge_relay_logs</span><br><span class="line">-r-xr-xr-x 1 root root   7525 Jul 21 09:54 save_binary_logs</span><br><span class="line">-r-xr-xr-x 1 root root   4807 Jul 21 09:54 filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p>
<h2 id="MHA目录结构说明"><a href="#MHA目录结构说明" class="headerlink" title="MHA目录结构说明"></a>MHA目录结构说明</h2><h3 id="MHAManager"><a href="#MHAManager" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>mhamanager工具包主要包括以下工具<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@slave  ~]# ll /usr/local/bin/</span><br><span class="line">总用量 84</span><br><span class="line">-r-xr-xr-x  1 root root  1995 7月  19 11:49 masterha_check_repl         #检查MySQL复制情况</span><br><span class="line">-r-xr-xr-x  1 root root  1779 7月  19 11:49 masterha_check_ssh          #检查MHA的SSH配置情况</span><br><span class="line">-r-xr-xr-x  1 root root  1865 7月  19 11:49 masterha_check_status       #检测当前MHA运行状态</span><br><span class="line">-r-xr-xr-x  1 root root  3201 7月  19 11:49 masterha_conf_host          #添加或删除配置的server信息</span><br><span class="line">-r-xr-xr-x  1 root root  2517 7月  19 11:49 masterha_manager            #启动MHA</span><br><span class="line">-r-xr-xr-x  1 root root  2165 7月  19 11:49 masterha_master_monitor     #检测Master是否宕机</span><br><span class="line">-r-xr-xr-x  1 root root  2373 7月  19 11:49 masterha_master_switch      #控制故障转移，自动或者手动</span><br><span class="line">-r-xr-xr-x  1 root root  5172 7月  19 11:49 masterha_secondary_check    #通过其他路由检测Master是否真的宕机</span><br><span class="line">-r-xr-xr-x  1 root root  1739 7月  19 11:49 masterha_stop               #停止MHA</span><br></pre></td></tr></table></figure></p>
<h3 id="MHANode"><a href="#MHANode" class="headerlink" title="MHANode"></a>MHANode</h3><p>mhanode工具包主要包括以下工具<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master  ~]# ll /usr/local/bin/</span><br><span class="line">总用量 44</span><br><span class="line">-r-xr-xr-x  1 root root 16371 7月  19 11:41 apply_diff_relay_logs       #识别差异日志的中继日志，并将其差异事件应用于其他Slave</span><br><span class="line">-r-xr-xr-x  1 root root  4807 7月  19 11:41 filter_mysqlbinlog          #去除不必要的Rollback事件</span><br><span class="line">-r-xr-xr-x  1 root root  8263 7月  19 11:41 purge_relay_logs            #删除无用的Relay log，避免延时</span><br><span class="line">-r-xr-xr-x  1 root root  7525 7月  19 11:41 save_binary_logs            #保存和复制down掉的主服务器二进制日志</span><br></pre></td></tr></table></figure></p>
<h3 id="自定义扩展脚本说明"><a href="#自定义扩展脚本说明" class="headerlink" title="自定义扩展脚本说明"></a>自定义扩展脚本说明</h3><p>secondary_check_script          #通过多条网络路由检测master的可用性<br>master_ip_failover_script       #自动failover时候的切换脚本，可将vip信息写入此脚本中<br>shutdown_script                 #强制关闭master节点执行脚本<br>report_script                   #发送报告<br>init_conf_load_script           #加载初始配置参数，如不想在配置中写明文密码<br>master_ip_online_change_script  #手动failover时候的切换脚本  </p>
<h2 id="MHA扩展脚本"><a href="#MHA扩展脚本" class="headerlink" title="MHA扩展脚本"></a>MHA扩展脚本</h2><p>由于使用的AWS EC2，不支持VIP，可通过辅助IP的形式实现，这里使用脚本来辅助实现HA。</p>
<h3 id="aws-vip-change-sh"><a href="#aws-vip-change-sh" class="headerlink" title="aws_vip_change.sh"></a>aws_vip_change.sh</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# cat /usr/local/bin/aws_vip_change.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line"></span><br><span class="line">if [ $# -lt 2 ]; then</span><br><span class="line">        echo &quot;Illegal param count.count = $#&quot;</span><br><span class="line">        exit 1</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># High Availability IP variables</span><br><span class="line"># Other node&apos;s IP to ping and VIP to swap if other node goes down</span><br><span class="line">VIP_ENI_ID=eni-7a5c7722</span><br><span class="line"></span><br><span class="line">NEW_MASTER_IP=$1</span><br><span class="line">OLD_MASTER_IP=$2</span><br><span class="line"></span><br><span class="line">echo &quot;NEW_MASTER_IP=$&#123;NEW_MASTER_IP&#125;,OLD_MASTER_IP=$&#123;OLD_MASTER_IP&#125;&quot;</span><br><span class="line"></span><br><span class="line"># Specify the EC2 region that this will be running in   #以下为当前用户能够执行aws cli命令的key信息</span><br><span class="line">REGION=cn-north-1</span><br><span class="line">AWSAccessKeyId=AKIAPUXGZV6F6EKCOK7Q</span><br><span class="line">AWSSecretKey=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       </span><br><span class="line"></span><br><span class="line"># Run aws-apitools-common.sh to set up default environment variables and to</span><br><span class="line"># leverage AWS security credentials provided by EC2 roles</span><br><span class="line">. /etc/profile.d/aws-apitools-common.sh</span><br><span class="line"></span><br><span class="line">ACCESS_USER_OPTION=&quot;--aws-access-key $&#123;AWSAccessKeyId&#125; --aws-secret-key $&#123;AWSSecretKey&#125;&quot;</span><br><span class="line"></span><br><span class="line">ssh -t -t root@$&#123;OLD_MASTER_IP&#125; /sbin/ifconfig eth4 down    #其中eth4网卡名要与下文中，新申请ENI并绑定实例ID对应的网卡名相同</span><br><span class="line"></span><br><span class="line">VIP_ATTACHMENT_ID=`ec2-describe-network-interface-attribute $&#123;VIP_ENI_ID&#125; $&#123;ACCESS_USER_OPTION&#125; --region $&#123;REGION&#125; -a | grep ATTACHMENT -m 1 | awk &apos;&#123;print $3;&#125;&apos;`</span><br><span class="line">echo &quot;VIP_ATTACHMENT_ID=$&#123;VIP_ATTACHMENT_ID&#125;&quot;</span><br><span class="line"></span><br><span class="line">/opt/aws/bin/ec2-detach-network-interface $&#123;VIP_ATTACHMENT_ID&#125; $&#123;ACCESS_USER_OPTION&#125; --force --region $&#123;REGION&#125;</span><br><span class="line">sleep 10</span><br><span class="line"></span><br><span class="line">INSTANCE_ID=`ssh root@$&#123;NEW_MASTER_IP&#125; /usr/bin/curl --silent http://169.254.169.254/latest/meta-data/instance-id`  #其中169.254.169.254从本地链路中获取实例ID</span><br><span class="line">echo &quot;INSTANCE_ID=$&#123;INSTANCE_ID&#125;&quot;</span><br><span class="line"></span><br><span class="line">/opt/aws/bin/ec2-attach-network-interface $&#123;VIP_ENI_ID&#125; -i $&#123;INSTANCE_ID&#125; -d 1 $&#123;ACCESS_USER_OPTION&#125; --region $&#123;REGION&#125;</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h3 id="master-ip-failover"><a href="#master-ip-failover" class="headerlink" title="master_ip_failover"></a>master_ip_failover</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# cat /usr/local/bin/master_ip_failover </span><br><span class="line">#!/usr/bin/env perl</span><br><span class="line"></span><br><span class="line">#  Copyright (C) 2011 DeNA Co.,Ltd.</span><br><span class="line">#</span><br><span class="line">#  This program is free software; you can redistribute it and/or modify</span><br><span class="line">#  it under the terms of the GNU General Public License as published by</span><br><span class="line">#  the Free Software Foundation; either version 2 of the License, or</span><br><span class="line">#  (at your option) any later version.</span><br><span class="line">#</span><br><span class="line">#  This program is distributed in the hope that it will be useful,</span><br><span class="line">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span><br><span class="line">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span><br><span class="line">#  GNU General Public License for more details.</span><br><span class="line">#</span><br><span class="line">#  You should have received a copy of the GNU General Public License</span><br><span class="line">#   along with this program; if not, write to the Free Software</span><br><span class="line">#  Foundation, Inc.,</span><br><span class="line">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span><br><span class="line"></span><br><span class="line">## Note: This is a sample script and is not complete. Modify the script based on your environment.</span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; &apos;all&apos;;</span><br><span class="line"></span><br><span class="line">use Getopt::Long;</span><br><span class="line">use MHA::DBHelper;</span><br><span class="line"></span><br><span class="line">my (</span><br><span class="line">  $command,        $ssh_user,         $orig_master_host,</span><br><span class="line">  $orig_master_ip, $orig_master_port, $new_master_host,</span><br><span class="line">  $new_master_ip,  $new_master_port,  $new_master_user,</span><br><span class="line">  $new_master_password</span><br><span class="line">);</span><br><span class="line">GetOptions(</span><br><span class="line">  &apos;command=s&apos;             =&gt; \$command,</span><br><span class="line">  &apos;ssh_user=s&apos;            =&gt; \$ssh_user,</span><br><span class="line">  &apos;orig_master_host=s&apos;    =&gt; \$orig_master_host,</span><br><span class="line">  &apos;orig_master_ip=s&apos;      =&gt; \$orig_master_ip,</span><br><span class="line">  &apos;orig_master_port=i&apos;    =&gt; \$orig_master_port,</span><br><span class="line">  &apos;new_master_host=s&apos;     =&gt; \$new_master_host,</span><br><span class="line">  &apos;new_master_ip=s&apos;       =&gt; \$new_master_ip,</span><br><span class="line">  &apos;new_master_port=i&apos;     =&gt; \$new_master_port,</span><br><span class="line">  &apos;new_master_user=s&apos;     =&gt; \$new_master_user,</span><br><span class="line">  &apos;new_master_password=s&apos; =&gt; \$new_master_password,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">exit &amp;main();</span><br><span class="line"></span><br><span class="line">sub main &#123;</span><br><span class="line">  if ( $command eq &quot;stop&quot; || $command eq &quot;stopssh&quot; ) &#123;</span><br><span class="line"></span><br><span class="line">    # $orig_master_host, $orig_master_ip, $orig_master_port are passed.</span><br><span class="line">    # If you manage master ip address at global catalog database,</span><br><span class="line">    # invalidate orig_master_ip here.</span><br><span class="line">    my $exit_code = 1;</span><br><span class="line">    eval &#123;</span><br><span class="line"></span><br><span class="line">      # updating global catalog, etc</span><br><span class="line">      $exit_code = 0;</span><br><span class="line">    &#125;;</span><br><span class="line">    if ($@) &#123;</span><br><span class="line">      warn &quot;Got Error: $@\n&quot;;</span><br><span class="line">      exit $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    exit $exit_code;</span><br><span class="line">  &#125;</span><br><span class="line">  elsif ( $command eq &quot;start&quot; ) &#123;</span><br><span class="line">    my $exit_code = 10;</span><br><span class="line">    my @vip_change_cmd = (&quot;/usr/local/bin/aws_vip_change.sh&quot;,$new_master_host,$orig_master_host);</span><br><span class="line">    system @vip_change_cmd;</span><br><span class="line">    $exit_code = 0;</span><br><span class="line">    if ($@) &#123;</span><br><span class="line">      warn $@;</span><br><span class="line"></span><br><span class="line">      # If you want to continue failover, exit 10.</span><br><span class="line">      exit $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    exit $exit_code;</span><br><span class="line">  &#125;</span><br><span class="line">  elsif ( $command eq &quot;status&quot; ) &#123;</span><br><span class="line"></span><br><span class="line">    # do nothing</span><br><span class="line">    exit 0;</span><br><span class="line">  &#125;</span><br><span class="line">  else &#123;</span><br><span class="line">    &amp;usage();</span><br><span class="line">    exit 1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub usage &#123;</span><br><span class="line">  print</span><br><span class="line">&quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h3 id="send-report"><a href="#send-report" class="headerlink" title="send_report"></a>send_report</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# cat /usr/local/bin/send_report </span><br><span class="line">#!/usr/bin/perl</span><br><span class="line"> </span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; &apos;all&apos;;</span><br><span class="line">use Mail::Sender;</span><br><span class="line">use Getopt::Long;</span><br><span class="line"> </span><br><span class="line">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span><br><span class="line">my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );</span><br><span class="line">my $smtp=&apos;smtp.126.com&apos;;</span><br><span class="line">my $mail_from=&apos;xxx@126.com&apos;;</span><br><span class="line">my $mail_user=&apos;xxx@126.com&apos;;</span><br><span class="line">my $mail_pass=&apos;xxx&apos;;</span><br><span class="line">#my $mail_to=[&apos;xxx&apos;,&apos;xxx&apos;];</span><br><span class="line">my $mail_to=&apos;xxx&apos;;</span><br><span class="line">GetOptions(</span><br><span class="line">  &apos;orig_master_host=s&apos; =&gt; \$dead_master_host,</span><br><span class="line">  &apos;new_master_host=s&apos;  =&gt; \$new_master_host,</span><br><span class="line">  &apos;new_slave_hosts=s&apos;  =&gt; \$new_slave_hosts,</span><br><span class="line">  &apos;subject=s&apos;          =&gt; \$subject,</span><br><span class="line">  &apos;body=s&apos;             =&gt; \$body,</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);</span><br><span class="line"> </span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_;</span><br><span class="line">    open my $DEBUG, &quot;&gt; /var/log/masterha/app1/manager.log&quot;</span><br><span class="line">        or die &quot;Can&apos;t open the debug      file:$!\n&quot;;</span><br><span class="line">    my $sender = new Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; &apos;text/plain; charset=utf-8&apos;,</span><br><span class="line">        encoding    =&gt; &apos;utf-8&apos;,</span><br><span class="line">        smtp        =&gt; $smtp,</span><br><span class="line">        from        =&gt; $mail_from,</span><br><span class="line">        auth        =&gt; &apos;LOGIN&apos;,</span><br><span class="line">        TLS_allowed =&gt; &apos;0&apos;,</span><br><span class="line">        authid      =&gt; $user,</span><br><span class="line">        authpwd     =&gt; $passwd,</span><br><span class="line">        to          =&gt; $mail_to,</span><br><span class="line">        subject     =&gt; $subject,</span><br><span class="line">        debug       =&gt; $DEBUG</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    $sender-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; $msg,</span><br><span class="line">            debug =&gt; $DEBUG</span><br><span class="line">        &#125;</span><br><span class="line">    ) or print $Mail::Sender::Error;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"># Do whatever you want here</span><br><span class="line"> </span><br><span class="line">exit 0;</span><br></pre></td></tr></table></figure>
<h2 id="主库手动绑定ENI和实例关系"><a href="#主库手动绑定ENI和实例关系" class="headerlink" title="主库手动绑定ENI和实例关系"></a>主库手动绑定ENI和实例关系</h2><p>在主库上先申请新的ENI，注意申请时先绑定的group，以满足其他EC2能够连接些ENI。<br>申请成功后，根据新的ENI和当前主实例的实例ID绑定，最终确认新的VIP是否绑定上。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@master ~]# ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:E6:0B:68:5C:1C  </span><br><span class="line">          inet addr:172.31.13.126  Bcast:172.31.15.255  Mask:255.255.240.0</span><br><span class="line">          inet6 addr: fe80::e6:bff:fe68:5c1c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:9001  Metric:1</span><br><span class="line">          RX packets:4063 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:3292 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:691839 (675.6 KiB)  TX bytes:390499 (381.3 KiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:79 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:79 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1 </span><br><span class="line">          RX bytes:16736 (16.3 KiB)  TX bytes:16736 (16.3 KiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]# aws ec2 create-network-interface --subnet-id subnet-33859151 --private-ip-address 172.31.0.200 --groups sg-e50a1c87 sg-6b1f0809</span><br><span class="line">&#123;</span><br><span class="line">    &quot;NetworkInterface&quot;: &#123;</span><br><span class="line">        &quot;Status&quot;: &quot;pending&quot;, </span><br><span class="line">        &quot;MacAddress&quot;: &quot;02:12:25:83:a0:22&quot;, </span><br><span class="line">        &quot;SourceDestCheck&quot;: true, </span><br><span class="line">        &quot;VpcId&quot;: &quot;vpc-b18195d3&quot;, </span><br><span class="line">        &quot;Description&quot;: &quot;&quot;, </span><br><span class="line">        &quot;NetworkInterfaceId&quot;: &quot;eni-7a5c7722&quot;,   #新申请的ENI名字</span><br><span class="line">        &quot;PrivateIpAddresses&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;PrivateDnsName&quot;: &quot;ip-172-31-0-200.cn-north-1.compute.internal&quot;, </span><br><span class="line">                &quot;Primary&quot;: true, </span><br><span class="line">                &quot;PrivateIpAddress&quot;: &quot;172.31.0.200&quot;  #新ENI绑定的私有IP</span><br><span class="line">            &#125;</span><br><span class="line">        ], </span><br><span class="line">        &quot;RequesterManaged&quot;: false, </span><br><span class="line">        &quot;Groups&quot;: [</span><br><span class="line">            &#123;</span><br><span class="line">                &quot;GroupName&quot;: &quot;For Mysql&quot;, </span><br><span class="line">                &quot;GroupId&quot;: &quot;sg-e50a1c87&quot;</span><br><span class="line">            &#125;, </span><br><span class="line">            &#123;</span><br><span class="line">                &quot;GroupName&quot;: &quot;OnlySSH-Allow&quot;, </span><br><span class="line">                &quot;GroupId&quot;: &quot;sg-6b1f0809&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        ], </span><br><span class="line">        &quot;PrivateDnsName&quot;: &quot;ip-172-31-0-200.cn-north-1.compute.internal&quot;, </span><br><span class="line">        &quot;AvailabilityZone&quot;: &quot;cn-north-1a&quot;, </span><br><span class="line">        &quot;RequesterId&quot;: &quot;AIDAPVDKK6NLF6SZ553KS&quot;, </span><br><span class="line">        &quot;SubnetId&quot;: &quot;subnet-33859151&quot;, </span><br><span class="line">        &quot;OwnerId&quot;: &quot;981100955930&quot;, </span><br><span class="line">        &quot;TagSet&quot;: [], </span><br><span class="line">        &quot;PrivateIpAddress&quot;: &quot;172.31.0.200&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@master ~]# aws ec2 attach-network-interface --network-interface-id eni-7a5c7722 --instance-id i-0a259e4950b0b3cf9 --device-index 1    #将ENI和实例绑定</span><br><span class="line">&#123;</span><br><span class="line">    &quot;AttachmentId&quot;: &quot;eni-attach-2b2c9345&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">[root@master ~]# ifconfig   #查看ip：172.31.0.200已绑定成功，同时要在其他EC2确定此安全组是否能够满足需求，否则还需要重新调整。</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:E6:0B:68:5C:1C  </span><br><span class="line">          inet addr:172.31.13.126  Bcast:172.31.15.255  Mask:255.255.240.0</span><br><span class="line">          inet6 addr: fe80::e6:bff:fe68:5c1c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:9001  Metric:1</span><br><span class="line">          RX packets:5435 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:4190 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:810999 (791.9 KiB)  TX bytes:501986 (490.2 KiB)</span><br><span class="line"></span><br><span class="line">eth4      Link encap:Ethernet  HWaddr 02:12:25:83:A0:22  </span><br><span class="line">          inet addr:172.31.0.200  Bcast:172.31.15.255  Mask:255.255.240.0</span><br><span class="line">          inet6 addr: fe80::12:25ff:fe83:a022/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:9001  Metric:1</span><br><span class="line">          RX packets:11 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:26 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:1218 (1.1 KiB)  TX bytes:2664 (2.6 KiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:79 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:79 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1 </span><br><span class="line">          RX bytes:16736 (16.3 KiB)  TX bytes:16736 (16.3 KiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h2 id="从库配置MHAManager"><a href="#从库配置MHAManager" class="headerlink" title="从库配置MHAManager"></a>从库配置MHAManager</h2><p>创建配置目录/etc/masterha/，同时创建一个项目上的配置文件，仅配置自动FailOver部分，只需要master_ip_failover和report_script脚本，其他脚本暂时不定义。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mkdir -p /etc/masterha/</span><br><span class="line">[root@slave ~]# cd /etc/masterha/</span><br><span class="line">[root@slave masterha]# </span><br><span class="line">[root@slave masterha]# cat app1.cnf </span><br><span class="line">[server default]</span><br><span class="line">manager_workdir=/var/log/masterha/app1                              #manager工作目录</span><br><span class="line">manager_log=/var/log/masterha/app1/manager.log                      #manager日志</span><br><span class="line">master_binlog_dir=/hwdata/data/percona                              #mysql数据目录</span><br><span class="line">password=mha123456                                                  #mha连接密码</span><br><span class="line">user=mha01                                                          #mha连接用户</span><br><span class="line">ping_interval=1                                                     #监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行failover</span><br><span class="line">remote_workdir=/tmp                                                 #远端mysql在发生切换时binlog的保存位置</span><br><span class="line">repl_password=slave123456                                           #复制密码</span><br><span class="line">repl_user=slave01                                                   #复制用户</span><br><span class="line">ssh_user=root                                                       #ssh用户</span><br><span class="line">master_ip_failover_script=/usr/local/bin/master_ip_failover         #自动failover切换脚本</span><br><span class="line">#master_ip_online_change_script= /usr/local/bin/master_ip_online_change      #手动failover切换脚本</span><br><span class="line">report_script=/usr/local/bin/send_report                            #报告发送脚本(不是必须)</span><br><span class="line">#shutdown_script=                                                   #故障发生后关闭主机的脚本(不是必须)</span><br><span class="line">secondary_check_script = masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306 #通过第三方机器确认目标主库是否存活，这里的ip可换成其他机器，用于检测</span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname=172.31.13.126                                              #主库地址</span><br><span class="line">port=3306</span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">hostname=172.31.9.182                                               #从库地址</span><br><span class="line">port=3306</span><br><span class="line">candidate_master=1                                                  #候选master</span><br></pre></td></tr></table></figure></p>
<h2 id="测试MHAManager-SSH"><a href="#测试MHAManager-SSH" class="headerlink" title="测试MHAManager SSH"></a>测试MHAManager SSH</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_ssh --conf=/etc/masterha/app1.cnf </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Mon Jul 24 13:58:04 2017 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Mon Jul 24 13:58:04 2017 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Mon Jul 24 13:58:04 2017 - [info] Starting SSH connection tests..</span><br><span class="line">Mon Jul 24 13:58:04 2017 - [debug] </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [debug]  Connecting via SSH from root@172.31.13.126(172.31.13.126:22) to root@172.31.9.182(172.31.9.182:22)..</span><br><span class="line">Mon Jul 24 13:58:04 2017 - [debug]   ok.</span><br><span class="line">Mon Jul 24 13:58:05 2017 - [debug] </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [debug]  Connecting via SSH from root@172.31.9.182(172.31.9.182:22) to root@172.31.13.126(172.31.13.126:22)..</span><br><span class="line">Mon Jul 24 13:58:04 2017 - [debug]   ok.</span><br><span class="line">Mon Jul 24 13:58:05 2017 - [info] All SSH connection tests passed successfully.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h2 id="测试MHAManager-复制"><a href="#测试MHAManager-复制" class="headerlink" title="测试MHAManager 复制"></a>测试MHAManager 复制</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_repl --conf=/etc/masterha/app1.cnf </span><br><span class="line">Mon Jul 24 13:58:17 2017 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Mon Jul 24 13:58:17 2017 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Mon Jul 24 13:58:17 2017 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Mon Jul 24 13:58:17 2017 - [info] MHA::MasterMonitor version 0.57.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] Master configurations are as below: </span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating from 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating from 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] GTID failover mode = 1</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] Dead Servers:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] Alive Servers:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] Alive Slaves:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info]     GTID ON</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] Current Alive Master: 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] Checking slave configurations..</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] HealthCheck: SSH to 172.31.13.126 is reachable.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] Checking replication health on 172.31.9.182..</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info]  ok.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 </span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info]  OK.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [warning] shutdown_script is not defined.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [info] Got exit code 0 (Not master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health is OK.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h2 id="启动MHAManager"><a href="#启动MHAManager" class="headerlink" title="启动MHAManager"></a>启动MHAManager</h2><h3 id="启动进程"><a href="#启动进程" class="headerlink" title="启动进程"></a>启动进程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;</span><br><span class="line">[1] 4439</span><br><span class="line">[root@slave masterha]# nohup: ignoring input and appending output to ‘nohup.out’</span><br><span class="line"></span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h3 id="查看启动日志"><a href="#查看启动日志" class="headerlink" title="查看启动日志"></a>查看启动日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /var/log/masterha/app1/manager.log </span><br><span class="line">Mon Jul 24 14:04:10 2017 - [info] MHA::MasterMonitor version 0.57.  #检查版本</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306) #获取当前主节点ip</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] Master configurations are as below:   #获取复制结构</span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating from 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating from 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] GTID failover mode = 1    #GTID模式</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] Dead Servers:</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] Alive Servers:            #当前在线实例列表</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] Alive Slaves:             #当前在线slave列表及版本信息</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info]     GTID ON</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] Current Alive Master: 172.31.13.126(172.31.13.126:3306)   #当前主实例信息</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] Checking slave configurations..</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info]  binlog_do_db= , binlog_ignore_db=                        #复制过滤</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] HealthCheck: SSH to 172.31.13.126 is reachable.           #ssh可用</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)                                          #再次确认当前复制架构</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 </span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info]  OK.</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [warning] shutdown_script is not defined.                        #shutdown_script脚本未定义    </span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] Set master ping interval 1 seconds.</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] Set secondary check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306                                                #第三方检查登录</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] Starting ping health check on 172.31.13.126(172.31.13.126:3306)..</span><br><span class="line">Mon Jul 24 14:04:11 2017 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn&apos;t respond.. #启动成功，等待failover</span><br><span class="line">[root@slave masterha]# ps aux|grep master</span><br><span class="line">root      4439  0.0  0.2 287004 23636 pts/0    S    14:04   0:00 perl /usr/local/bin/masterha_manager --conf=/etc/masterha/app1.cnf #进程存在</span><br><span class="line">root      5008  0.0  0.0 110456  2092 pts/0    S+   14:13   0:00 grep --color=auto master</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h2 id="模拟主库故障"><a href="#模拟主库故障" class="headerlink" title="模拟主库故障"></a>模拟主库故障</h2><h3 id="确认当前VIP状态"><a href="#确认当前VIP状态" class="headerlink" title="确认当前VIP状态"></a>确认当前VIP状态</h3><p>在主库上执行停止服务，观察MHAManager日志，并确认VIP是否切换到从库上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ifconfig       #确认当前VIP：172.31.0.200在主库上</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:E6:0B:68:5C:1C  </span><br><span class="line">          inet addr:172.31.13.126  Bcast:172.31.15.255  Mask:255.255.240.0</span><br><span class="line">          inet6 addr: fe80::e6:bff:fe68:5c1c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:9001  Metric:1</span><br><span class="line">          RX packets:9629 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:8119 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:1202679 (1.1 MiB)  TX bytes:1113439 (1.0 MiB)</span><br><span class="line"></span><br><span class="line">eth4      Link encap:Ethernet  HWaddr 02:12:25:83:A0:22  </span><br><span class="line">          inet addr:172.31.0.200  Bcast:172.31.15.255  Mask:255.255.240.0</span><br><span class="line">          inet6 addr: fe80::12:25ff:fe83:a022/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:9001  Metric:1</span><br><span class="line">          RX packets:4 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:4 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:562 (562.0 b)  TX bytes:600 (600.0 b)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:90 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:90 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1 </span><br><span class="line">          RX bytes:17324 (16.9 KiB)  TX bytes:17324 (16.9 KiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="确认MHAManger进程状态"><a href="#确认MHAManger进程状态" class="headerlink" title="确认MHAManger进程状态"></a>确认MHAManger进程状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# ps aux|grep master</span><br><span class="line">root     11333  0.4  0.2 287004 23604 pts/0    S    15:36   0:00 perl /usr/local/bin/masterha_manager --conf=/etc/masterha/app1.cnf</span><br><span class="line">root     11377  0.0  0.0 110456  2252 pts/0    S+   15:37   0:00 grep --color=auto master</span><br><span class="line">[root@slave masterha]# cd /var/log/masterha/app1/</span><br><span class="line">[root@slave app1]# ll</span><br><span class="line">total 8</span><br><span class="line">-rw-r--r-- 1 root root   36 Jul 24 15:37 app1.master_status.health</span><br><span class="line">-rw-r--r-- 1 root root 2833 Jul 24 15:36 manager.log</span><br><span class="line">[root@slave app1]# cat manager.log |tail -2</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Starting ping health check on 172.31.13.126(172.31.13.126:3306)..</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn&apos;t respond..     #正在等待主库FailOver</span><br><span class="line">[root@slave app1]# ifconfig     #当前从库没有存在VIP：172.31.0.200</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:0E:FB:F1:E9:4E  </span><br><span class="line">          inet addr:172.31.9.182  Bcast:172.31.15.255  Mask:255.255.240.0</span><br><span class="line">          inet6 addr: fe80::e:fbff:fef1:e94e/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:9001  Metric:1</span><br><span class="line">          RX packets:16565 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:17269 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:2084631 (1.9 MiB)  TX bytes:2304176 (2.1 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:2556 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:2556 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1 </span><br><span class="line">          RX bytes:605471 (591.2 KiB)  TX bytes:605471 (591.2 KiB)</span><br><span class="line"></span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure>
<h3 id="停止主库服务，触发主库FailOver"><a href="#停止主库服务，触发主库FailOver" class="headerlink" title="停止主库服务，触发主库FailOver"></a>停止主库服务，触发主库FailOver</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/mysqld stop                    #服务停止</span><br><span class="line">Shutting down MySQL (Percona Server)............ SUCCESS! </span><br><span class="line">[root@master ~]# ifconfig                                   #VIP已经不存在</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:E6:0B:68:5C:1C  </span><br><span class="line">          inet addr:172.31.13.126  Bcast:172.31.15.255  Mask:255.255.240.0</span><br><span class="line">          inet6 addr: fe80::e6:bff:fe68:5c1c/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:9001  Metric:1</span><br><span class="line">          RX packets:10242 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:8535 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:1256340 (1.1 MiB)  TX bytes:1175340 (1.1 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:92 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:92 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1 </span><br><span class="line">          RX bytes:17424 (17.0 KiB)  TX bytes:17424 (17.0 KiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<h3 id="观察FailOver日志"><a href="#观察FailOver日志" class="headerlink" title="观察FailOver日志"></a>观察FailOver日志</h3><p>登录从库，查看MHAManager日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# cat manager.log </span><br><span class="line">Mon Jul 24 15:36:52 2017 - [info] MHA::MasterMonitor version 0.57.</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Master configurations are as below: </span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating from 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating from 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] GTID failover mode = 1</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Dead Servers:</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Alive Servers:</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Alive Slaves:</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info]     GTID ON</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Current Alive Master: 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Checking slave configurations..</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] HealthCheck: SSH to 172.31.13.126 is reachable.</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 </span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info]  OK.</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [warning] shutdown_script is not defined.</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Set master ping interval 1 seconds.</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Set secondary check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Starting ping health check on 172.31.13.126(172.31.13.126:3306)..</span><br><span class="line">Mon Jul 24 15:36:54 2017 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn&apos;t respond..         #等待主库FailOver</span><br><span class="line">Mon Jul 24 15:40:01 2017 - [warning] Got error on MySQL select ping: 2006 (MySQL server has gone away)</span><br><span class="line">Mon Jul 24 15:40:01 2017 - [info] Executing secondary network check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306  --user=root  --master_host=172.31.13.126  --master_ip=172.31.13.126  --master_port=3306 --master_user=mha01 --master_password=mha123456 --ping_type=SELECT</span><br><span class="line">Mon Jul 24 15:40:01 2017 - [info] Executing SSH check script: exit 0</span><br><span class="line">Mon Jul 24 15:40:01 2017 - [info] HealthCheck: SSH to 172.31.13.126 is reachable.</span><br><span class="line">Monitoring server 172.31.13.126 is reachable, Master is not reachable from 172.31.13.126. OK.</span><br><span class="line">Monitoring server 172.31.9.182 is reachable, Master is not reachable from 172.31.9.182. OK.</span><br><span class="line">Mon Jul 24 15:40:01 2017 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span><br><span class="line">Mon Jul 24 15:40:02 2017 - [warning] Got error on MySQL connect: 2003 (Can&apos;t connect to MySQL server on &apos;172.31.13.126&apos; (111))</span><br><span class="line">Mon Jul 24 15:40:02 2017 - [warning] Connection failed 2 time(s)..</span><br><span class="line">Mon Jul 24 15:40:03 2017 - [warning] Got error on MySQL connect: 2003 (Can&apos;t connect to MySQL server on &apos;172.31.13.126&apos; (111))</span><br><span class="line">Mon Jul 24 15:40:03 2017 - [warning] Connection failed 3 time(s)..</span><br><span class="line">Mon Jul 24 15:40:04 2017 - [warning] Got error on MySQL connect: 2003 (Can&apos;t connect to MySQL server on &apos;172.31.13.126&apos; (111))</span><br><span class="line">Mon Jul 24 15:40:04 2017 - [warning] Connection failed 4 time(s)..</span><br><span class="line">Mon Jul 24 15:40:04 2017 - [warning] Master is not reachable from health checker!</span><br><span class="line">Mon Jul 24 15:40:04 2017 - [warning] Master 172.31.13.126(172.31.13.126:3306) is not reachable!</span><br><span class="line">Mon Jul 24 15:40:04 2017 - [warning] SSH is reachable.</span><br><span class="line">Mon Jul 24 15:40:04 2017 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha_default.cnf and /etc/masterha/app1.cnf again, and trying to connect to all servers to check server status..</span><br><span class="line">Mon Jul 24 15:40:04 2017 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Mon Jul 24 15:40:04 2017 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Mon Jul 24 15:40:04 2017 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info] GTID failover mode = 1</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info] Dead Servers:</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info] Alive Servers:</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info] Alive Slaves:</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info]     GTID ON</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info] Checking slave configurations..</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info] Master is down!</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info] Terminating monitoring script.</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info] Got exit code 20 (Master dead).</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info] MHA::MasterFailover version 0.57.</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info] Starting master failover.</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info] * Phase 1: Configuration Check Phase..</span><br><span class="line">Mon Jul 24 15:40:05 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] GTID failover mode = 1</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] Dead Servers:</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] Checking master reachability via MySQL(double check)...</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]  ok.</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] Alive Servers:</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] Alive Slaves:</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]     GTID ON</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] Starting GTID based failover.</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] ** Phase 1: Configuration Check Phase completed.</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] * Phase 2: Dead Master Shutdown Phase..</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] Forcing shutdown so that applications never connect to the current master..</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] Executing master IP deactivation script:</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]   /usr/local/bin/master_ip_failover --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 --command=stopssh --ssh_user=root  </span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]  done.</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] * Phase 3: Master Recovery Phase..</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] The latest binary log file/position on all slaves is mysql-bin.000011:234</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] Latest slaves (Slaves that received relay log files to the latest):</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]     GTID ON</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] The oldest binary log file/position on all slaves is mysql-bin.000011:234</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] Oldest slaves:</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]     GTID ON</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] * Phase 3.3: Determining New Master Phase..</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] Searching new master from slaves..</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]  Candidate masters from the configuration file:</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]     GTID ON</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]  Non-candidate masters:</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] New master is 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] Starting master failover..</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] </span><br><span class="line">From:</span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">To:</span><br><span class="line">172.31.9.182(172.31.9.182:3306) (new master)</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] * Phase 3.3: New Master Recovery Phase..</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]  Waiting all logs to be applied.. </span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]   done.</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] Getting new master&apos;s binlog name and position..</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]  mysql-bin.000008:234</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&apos;172.31.9.182&apos;, MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER=&apos;slave01&apos;, MASTER_PASSWORD=&apos;xxx&apos;;</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000008, 234, 28a037e5-6d0f-11e7-b43a-02e60b685c1c:1-15,</span><br><span class="line">39292a50-6d0f-11e7-999e-020efbf1e94e:1-4</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info] Executing master IP activate script:</span><br><span class="line">Mon Jul 24 15:40:07 2017 - [info]   /usr/local/bin/master_ip_failover --command=start --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 --new_master_host=172.31.9.182 --new_master_ip=172.31.9.182 --new_master_port=3306 --new_master_user=&apos;mha01&apos;   --new_master_password=xxx</span><br><span class="line">NEW_MASTER_IP=172.31.9.182,OLD_MASTER_IP=172.31.13.126</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br><span class="line">VIP_ATTACHMENT_ID=eni-attach-5b219e35</span><br><span class="line">ATTACHMENT              eni-attach-5b219e35     detaching</span><br><span class="line">INSTANCE_ID=i-03135a59c242e9bad</span><br><span class="line">eni-attach-0f209f61</span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info]  OK.</span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] Setting read_only=0 on 172.31.9.182(172.31.9.182:3306)..</span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info]  ok.</span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] ** Finished master recovery successfully.</span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] * Phase 3: Master Recovery Phase completed.</span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] * Phase 4: Slaves Recovery Phase..</span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] * Phase 4.1: Starting Slaves in parallel..</span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] All new slave servers recovered successfully.</span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] * Phase 5: New master cleanup phase..</span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] </span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] Resetting slave info on the new master..</span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info]  172.31.9.182: Resetting slave info succeeded.</span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] Master failover to 172.31.9.182(172.31.9.182:3306) completed successfully.</span><br><span class="line">Mon Jul 24 15:40:22 2017 - [info] </span><br><span class="line"></span><br><span class="line">----- Failover Report -----</span><br><span class="line"></span><br><span class="line">app1: MySQL Master failover 172.31.13.126(172.31.13.126:3306) to 172.31.9.182(172.31.9.182:3306) succeeded</span><br><span class="line"></span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306) is down!</span><br><span class="line"></span><br><span class="line">Check MHA Manager logs at slave:/var/log/masterha/app1/manager.log for details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated master IP address on 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Selected 172.31.9.182(172.31.9.182:3306) as a new master.</span><br><span class="line">172.31.9.182(172.31.9.182:3306): OK: Applying all logs succeeded.</span><br><span class="line">172.31.9.182(172.31.9.182:3306): OK: Activated master IP address.</span><br><span class="line">172.31.9.182(172.31.9.182:3306): Resetting slave info succeeded.</span><br><span class="line">Master failover to 172.31.9.182(172.31.9.182:3306) completed successfully.</span><br><span class="line">Mon Jul 24 16:27:13 2017 - [info] Sending mail..</span><br><span class="line">defined(@array) is deprecated at /usr/share/perl5/vendor_perl/Mail/Sender.pm line 318.</span><br><span class="line">        (Maybe you should just omit the defined()?)</span><br><span class="line">defined(@array) is deprecated at /usr/share/perl5/vendor_perl/Mail/Sender.pm line 2693.</span><br><span class="line">        (Maybe you should just omit the defined()?)</span><br><span class="line">Option new_slave_hosts requires an argument</span><br><span class="line">Unknown option: conf</span><br><span class="line">tail: manager.log: file truncated</span><br><span class="line">&gt;&gt; 220 126.com Anti-spam GT for Coremail System (126com[20140526])</span><br><span class="line">&lt;&lt; EHLO slave</span><br><span class="line">&gt;&gt; 250-mail</span><br><span class="line">&gt;&gt; 250-PIPELINING</span><br><span class="line">&gt;&gt; 250-AUTH LOGIN PLAIN</span><br><span class="line">&gt;&gt; 250-AUTH=LOGIN PLAIN</span><br><span class="line">&gt;&gt; 250-coremail 1Uxr2xKj7kG0xkI17xGrU7I0s8FY2U3Uj8Cz28x1UUUUU7Ic2I0Y2Ur0Vl_3UCa0xDrUUUUj</span><br><span class="line">&gt;&gt; 250-STARTTLS</span><br><span class="line">&gt;&gt; 250 8BITMIME</span><br><span class="line">&lt;&lt; AUTH LOGIN</span><br><span class="line">&gt;&gt; 334 dXNlcm5hbWU6</span><br><span class="line">&lt;&lt; ZHdqNTY4NTg4QDEyNi5jb20=</span><br><span class="line">&gt;&gt; 334 UGFzc3dvcmQ6</span><br><span class="line">&lt;&lt; RHdqMTIzNDU=</span><br><span class="line">&gt;&gt; 235 Authentication successful</span><br><span class="line">&lt;&lt; MAIL FROM:&lt;dwj568588@126.com&gt;</span><br><span class="line">&gt;&gt; 250 Mail OK</span><br><span class="line">&lt;&lt; RCPT TO:&lt;duanwenjie@huan.tv&gt;</span><br><span class="line">&gt;&gt; 250 Mail OK</span><br><span class="line">&lt;&lt; DATA</span><br><span class="line">&gt;&gt; 354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span><br><span class="line">&lt;&lt; To: duanwenjie@huan.tv</span><br><span class="line">&lt;&lt; From: dwj568588@126.com</span><br><span class="line">&lt;&lt; Subject: app1: MySQL Master failover 172.31.13.126(172.31.13.126:3306) to 172.31.9.182(172.31.9.182:3306) succeeded</span><br><span class="line">&lt;&lt; Date: Mon, 24 Jul 2017 16:27:15 +0800</span><br><span class="line">&lt;&lt; X-Mailer: Perl script &quot;send_report&quot;</span><br><span class="line">&lt;&lt;      using Mail::Sender 0.8.16 by Jenda Krynicky, Czechlands</span><br><span class="line">&lt;&lt;      running on slave ()</span><br><span class="line">&lt;&lt;      under account &quot;zhouting&quot;</span><br><span class="line">&lt;&lt; Message-ID: &lt;20170724_082715_056339.dwj568588@126.com&gt;</span><br><span class="line">&lt;&lt; MIME-Version: 1.0</span><br><span class="line">&lt;&lt; Content-type: text/plain; charset=utf-8</span><br><span class="line">&lt;&lt; </span><br><span class="line">&lt;&lt; Master 172.31.13.126(172.31.13.126:3306) is down!</span><br><span class="line">&lt;&lt; </span><br><span class="line">&lt;&lt; Check MHA Manager logs at slave:/var/log/masterha/app1/manager.log for details.</span><br><span class="line">&lt;&lt; </span><br><span class="line">&lt;&lt; Started automated(non-interactive) failover.</span><br><span class="line">&lt;&lt; Invalidated master IP address on 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">&lt;&lt; Selected 172.31.9.182(172.31.9.182:3306) as a new master.</span><br><span class="line">&lt;&lt; 172.31.9.182(172.31.9.182:3306): OK: Applying all logs succeeded.</span><br><span class="line">&lt;&lt; 172.31.9.182(172.31.9.182:3306): OK: Activated master IP address.</span><br><span class="line">&lt;&lt; 172.31.9.182(172.31.9.182:3306): Resetting slave info succeeded.</span><br><span class="line">&lt;&lt; Master failover to 172.31.9.182(172.31.9.182:3306) completed successfully.</span><br><span class="line">&lt;&lt; </span><br><span class="line">&lt;&lt; .</span><br><span class="line">&gt;&gt; 250 Mail OK queued as smtp1,C8mowAAH7yZhr3VZFR+JCA--.54250S2 1500884834</span><br><span class="line">&lt;&lt; QUIT</span><br><span class="line">&gt;&gt; 221 Bye</span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure></p>
<h3 id="日志过程解析"><a href="#日志过程解析" class="headerlink" title="日志过程解析"></a>日志过程解析</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">启动前的准备工作</span><br><span class="line">检查数据库服务器状态,获取相关参数设置</span><br><span class="line">检查GTID、candidate_master、过滤DB是否设置</span><br><span class="line">测试ssh连接是否成功</span><br><span class="line">测试MHA node是否可用</span><br><span class="line">创建MHA日志目录</span><br><span class="line">开始检查slave的差异日志应用权限</span><br><span class="line">确定当前的复制架构</span><br><span class="line">调试master_ip_failover_script</span><br><span class="line">调试shutdown_script</span><br><span class="line">设置二次检查的主机masterha_secondary_check</span><br><span class="line">MHA启动完毕,进入监测状态</span><br><span class="line">监测master服务器挂了</span><br><span class="line">通过定义的二次监测,确认master是否挂了</span><br><span class="line">确认master挂了,开始进入failover流程</span><br><span class="line">再试尝试连接master和master的ssh</span><br><span class="line">通过MHA配置文件,监测其他slave的状态</span><br><span class="line">再次监测slave的配置是否有变化,是否符合failover条件</span><br><span class="line">正式开始failover</span><br><span class="line">再次对slave配置做检查</span><br><span class="line">对原Master做master_ip_failover_script和shutdown_script的操作</span><br><span class="line">开始差异日志的恢复，获取slave最后得到的binlog位置</span><br><span class="line">获取原master的binlog日志</span><br><span class="line">确定新的master</span><br><span class="line">在new master上应用差异的binlog日志</span><br><span class="line">获取new master的binlog位置。</span><br><span class="line">执行master_ip_failover_script,调用aws_vip_change.sh，执行VIP漂移</span><br><span class="line">开始恢复其他slave的差异日志</span><br><span class="line">差异日志应用完成以后,切换所有slave到new master。</span><br><span class="line">failover操作完成,生成failover报告</span><br><span class="line">最后发送邮件通知</span><br></pre></td></tr></table></figure>
<h3 id="确认FailOver状态"><a href="#确认FailOver状态" class="headerlink" title="确认FailOver状态"></a>确认FailOver状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# ifconfig             #vip已经添加到从库上</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 02:0E:FB:F1:E9:4E  </span><br><span class="line">          inet addr:172.31.9.182  Bcast:172.31.15.255  Mask:255.255.240.0</span><br><span class="line">          inet6 addr: fe80::e:fbff:fef1:e94e/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:9001  Metric:1</span><br><span class="line">          RX packets:17060 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:17883 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:2142676 (2.0 MiB)  TX bytes:2390595 (2.2 MiB)</span><br><span class="line"></span><br><span class="line">eth1      Link encap:Ethernet  HWaddr 02:12:25:83:A0:22  </span><br><span class="line">          inet addr:172.31.0.200  Bcast:172.31.15.255  Mask:255.255.240.0</span><br><span class="line">          inet6 addr: fe80::12:25ff:fe83:a022/64 Scope:Link</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:9001  Metric:1</span><br><span class="line">          RX packets:8 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:18 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:798 (798.0 b)  TX bytes:1828 (1.7 KiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          inet6 addr: ::1/128 Scope:Host</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:2789 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:2789 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1 </span><br><span class="line">          RX bytes:669913 (654.2 KiB)  TX bytes:669913 (654.2 KiB)</span><br><span class="line"></span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure>
<h3 id="查看邮件发送状态"><a href="#查看邮件发送状态" class="headerlink" title="查看邮件发送状态"></a>查看邮件发送状态</h3><p>登录邮件，查看是否收到报警邮件。<br><img src="http://note.youdao.com/yws/public/resource/bba80193f9c2d29f073784f4e498b134/xmlnote/0A43FC640BD84154ADCD175F765F82E1/33468" alt="image">  </p>
<h3 id="手动FailOver"><a href="#手动FailOver" class="headerlink" title="手动FailOver"></a>手动FailOver</h3><p>MHA的手动FailOver不在本文范围，详情理论可参考官方文档。  </p>
<h3 id="参数列表"><a href="#参数列表" class="headerlink" title="参数列表"></a>参数列表</h3><table>
<thead>
<tr>
<th>参数名</th>
<th>是否必须</th>
<th>参数使用域</th>
<th>默认值</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr>
<td>hostname</td>
<td>Yes</td>
<td>Local Only</td>
<td>-</td>
<td>hostname=master,hostname=slave</td>
</tr>
<tr>
<td>ip</td>
<td>No</td>
<td>Local Only</td>
<td>gethostbyname($hostname)</td>
<td>ip=192.168.1.100</td>
</tr>
<tr>
<td>port</td>
<td>No</td>
<td>Local/App/Global</td>
<td>3306</td>
<td>port=3306</td>
</tr>
<tr>
<td>ssh_host</td>
<td>No</td>
<td>Local Only</td>
<td>same as hostname</td>
<td>ssh_host=master,ssh_host=slave</td>
</tr>
<tr>
<td>ssh_ip</td>
<td>No</td>
<td>Local Only</td>
<td>gethostbyname($ssh_host)</td>
<td>ssh_ip=192.168.1.101</td>
</tr>
<tr>
<td>ssh_port</td>
<td>No</td>
<td>Local/App/Global</td>
<td>22</td>
<td>ssh_port=22</td>
</tr>
<tr>
<td>ssh_connection_timeout</td>
<td>No</td>
<td>Local/App/Global</td>
<td>5</td>
<td>ssh_connection_timeout=20</td>
</tr>
<tr>
<td>ssh_options</td>
<td>No</td>
<td>Local/App/Global</td>
<td>“”(empty string)</td>
<td>ssh_options=”-i /root/.ssh/id_dsa2”</td>
</tr>
<tr>
<td>candidate_master</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>candidate_master=1</td>
</tr>
<tr>
<td>no_master</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>no_master=1</td>
</tr>
<tr>
<td>ignore_fail</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>ignore_fail=1</td>
</tr>
<tr>
<td>skip_init_ssh_check</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>skip_init_ssh_check=1</td>
</tr>
<tr>
<td>skip_reset_slave</td>
<td>No</td>
<td>Local/App/Global</td>
<td>0</td>
<td>skip_reset_slave=1</td>
</tr>
<tr>
<td>user</td>
<td>No</td>
<td>Local/App/Global</td>
<td>root</td>
<td>user=root</td>
</tr>
<tr>
<td>password</td>
<td>No</td>
<td>Local/App/Global</td>
<td>“”(empty string)</td>
<td>password=rootpass</td>
</tr>
<tr>
<td>repl_user</td>
<td>No</td>
<td>Local/App/Global</td>
<td>Master_User value from SHOW SLAVE STATUS</td>
<td>repl_user=repl</td>
</tr>
<tr>
<td>repl_password</td>
<td>No</td>
<td>Local/App/Global</td>
<td>(current replication password)</td>
<td>repl_user=replpass</td>
</tr>
<tr>
<td>disable_log_bin</td>
<td>No</td>
<td>Local/App/Global</td>
<td>0</td>
<td>disable_log_bin=1</td>
</tr>
<tr>
<td>master_pid_file</td>
<td>No</td>
<td>Local/App/Global</td>
<td>“”(empty string)</td>
<td>master_pid_file=/var/lib/mysql/master1.pid</td>
</tr>
<tr>
<td>ssh_user</td>
<td>No</td>
<td>Local/App/Global</td>
<td>current OS user</td>
<td>ssh_user=root</td>
</tr>
<tr>
<td>remote_workdir</td>
<td>No</td>
<td>Local/App/Global</td>
<td>/var/tmp</td>
<td>remote_workdir=/var/log/masterha/app1</td>
</tr>
<tr>
<td>master_binlog_dir</td>
<td>No</td>
<td>Local/App/Global</td>
<td>/var/lib/mysql</td>
<td>master_binlog_dir=/data/mysql1</td>
</tr>
<tr>
<td>log_level</td>
<td>No</td>
<td>App/Global</td>
<td>info</td>
<td>log_level=debug</td>
</tr>
<tr>
<td>manager_workdir</td>
<td>No</td>
<td>App</td>
<td>/var/tmp</td>
<td>manager_workdir=/var/log/masterha</td>
</tr>
<tr>
<td>client_bindir</td>
<td>No</td>
<td>App</td>
<td>-</td>
<td>client_bindir=/usr/mysql/bin</td>
</tr>
<tr>
<td>client_libdir</td>
<td>No</td>
<td>App</td>
<td>-</td>
<td>client_libdir=/usr/lib/mysql</td>
</tr>
<tr>
<td>manager_log</td>
<td>No</td>
<td>App</td>
<td>STDERR</td>
<td>manager_log=/var/log/masterha/app1.log</td>
</tr>
<tr>
<td>check_repl_delay</td>
<td>No</td>
<td>App/Global</td>
<td>1</td>
<td>check_repl_delay=0</td>
</tr>
<tr>
<td>check_repl_filter</td>
<td>No</td>
<td>App/Global</td>
<td>1</td>
<td>check_repl_filter=0</td>
</tr>
<tr>
<td>latest_priority</td>
<td>No</td>
<td>App/Global</td>
<td>1</td>
<td>latest_priority=0</td>
</tr>
<tr>
<td>multi_tier_slave</td>
<td>No</td>
<td>App/Global</td>
<td>0</td>
<td>multi_tier_slave=1</td>
</tr>
<tr>
<td>ping_interval</td>
<td>No</td>
<td>App/Global</td>
<td>3</td>
<td>ping_interval=5</td>
</tr>
<tr>
<td>ping_type</td>
<td>No</td>
<td>App/Global</td>
<td>SELECT</td>
<td>ping_type=CONNECT</td>
</tr>
<tr>
<td>secondary_check_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>secondary_check_script= masterha_secondary_check -s remote_dc1 -s remote_dc2</td>
</tr>
<tr>
<td>master_ip_failover_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>master_ip_failover_script=/usr/local/bin/master_ip_failover</td>
</tr>
<tr>
<td>master_ip_online_change_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>master_ip_online_change_script= /usr/local/bin/master_ip_online_change</td>
</tr>
<tr>
<td>shutdown_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>shutdown_script= /usr/local/bin/master_shutdown</td>
</tr>
<tr>
<td>report_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>report_script= /usr/local/bin/report</td>
</tr>
</tbody>
</table>
<h4 id="详情解释"><a href="#详情解释" class="headerlink" title="详情解释"></a>详情解释</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">Local Scope:        针对每个server级别有效的选项.local scope级别的参数需要在配置文件的 [server_xxx]段落配置  </span><br><span class="line">App Scope:          这个参数可以理解为针对一组master-slave集群. 这些参数需要在 [server_default]段落配置  </span><br><span class="line">Global Scope:       这个参数针对所有的MHA管理的实例. global scope级别的配置只有你在使用一个manager server管理多组master-slave时使用 </span><br><span class="line">hostname：          目标Mysql服务器的主机名或者IP地址,这个参数是强制的,并且必须配置在[server_xxx]段落</span><br><span class="line">ip：                目标Mysql服务器的IP地址,默认是通过$hostname变量获取.MHA manager和MHA Node</span><br><span class="line">                    内部使用这个IP地址链接到Mysql和SSH.通常你不需要配置这个参数,因为它可以通过$hostname解析获得</span><br><span class="line">port：              mysql服务器使用的端口号,默认是3306,MHA链接到mysql通过IP地址和端口</span><br><span class="line">ssh_host：          从0.53版本开始支持此参数,此参数的主要目的在于你mysql复制使用的IP地址由于安全策略,不能直接连接,</span><br><span class="line">                    所以需要通过其他IP和端口连接到mysql server或者ssh,默认这个参数和hostname的值相同</span><br><span class="line">ssh_ip：            从0.53版本开始支持此参数,连接到目标mysql server的ssh ip地址,默认从$ssh_host获取</span><br><span class="line">ssh_port：          从0.53版本开始支持此参数,连接到目标mysql server的ssh端口,默认是22</span><br><span class="line">ssh_connection_timeout：从0.54开始支持此参数,默认是5秒,添加此参数的原因是以前我们在程序里面写死了</span><br><span class="line">ssh_options：       从0.53开始支持此参数,可以添加SSH命令行的参数</span><br><span class="line">candidate_master：  </span><br><span class="line">你的slave的硬件配置或者用途可能不太一样,你想要提升更加可靠的slave作为新的master</span><br><span class="line">如果设置candidate_master的值为1,那么这个server会优先成为master,只要它满足成为master的条件(binlog开启的,没有严重的复制延时等)</span><br><span class="line">所以意味着配置了candiate_master=1的服务器并不是肯定可以成为new master,但是这个参数能够帮助提高优先级</span><br><span class="line">如果你在多个服务器上设置了candidate_master=1,那么在配置文件中[server_xxx]的配置顺序,会成为第二排序规则,排在上面的越优先</span><br><span class="line">no_master：         no_master=1是默认值,意思是这个server从来不会成为新的master,这个参数用来标记某些从来不用成为new master的服务器</span><br><span class="line">ignore_fail：       </span><br><span class="line">默认是0,当某个slave的ssh或者mysql当掉或者复制失败的时候,MHA manager不启动failover。</span><br><span class="line">但是有些环境下,你想要在某个特定的slave失败的时候继续执行failover,把么就设置这个ignore_fail=1,即时这个slave失败的时候,failover依然继续执行</span><br><span class="line">skip_init_ssh_check：启动的时候跳过ssh连接测试</span><br><span class="line">skip_reset_slave：  从0.56版本开始支持此参数,在master执行failover以后跳过执行reset slave all(译者感觉应该是方便MM复制的后期恢复)</span><br><span class="line">user：              mysql管理员命令,建议赋予all privileges权限</span><br><span class="line">password：          上面mysql user的密码</span><br><span class="line">repl_user：         mysql复制使用的用户名,需要执行change master to命令和show slave status命令等.一般赋予replication slave,replication client权限</span><br><span class="line">repl_password：     上面用户对应的密码.默认情况下,使用的是当前复制的密码</span><br><span class="line">disable_log_bin：   当这个参数设置以后,当应用差异日志到slave的时候,slave不会生成binlog. Internally MHA passes --disable-log-bin to mysqlbinlog command</span><br><span class="line">master_pid_file：   设置master的pid文件位置,当你的服务器上运行了多个mysql的时候使用</span><br><span class="line">ssh_user：          </span><br><span class="line">MHA manager和MHA node通过这个用户连接到mysql server的OS上,在对应的OS上执行相关命令和拷贝差异日志等等</span><br><span class="line">这个用户必须有读取mysql binary/relay 相关日志文件的权限,还有日志目录的写入权限.(remote_workdir目录)</span><br><span class="line">这个用户必须可以直接连接到服务器上,不用任何交互的操作.通过使用ssh public key作为认证方式.默认使用的用户是manager当前的用户</span><br><span class="line">remote_workdir：    </span><br><span class="line">每个MHA node上,MHA工作使用的目录的绝对路径.如果目录不存在,MHA会自动创建,如果权限不够,那么MHA node会意外终止,</span><br><span class="line">注意MHA manager和MHA node都不会检查这个目录的磁盘可用空间,你需要自己保证有足够的可用空间.默认的remote_workdir是&apos;/var/tmp&apos;</span><br><span class="line">master_binlog_dir： </span><br><span class="line">master mysql保存binlog的目录的绝对路径.如果参数的主要目的是在master mysql宕机以后,为了通过ssh拷贝需要的binlog event</span><br><span class="line">这个参数是需要的,因为当mysql宕机以后,没法自动获取binary log的目录</span><br><span class="line">默认情况下,master_binlog_dir的值是&quot;/var/lib/mysql/,/var/log/mysql/&quot;,/var/lib/mysql/是大部分mysql发布版本的默认mysql输出目录,</span><br><span class="line">你可以设置多个目录,使用逗号分隔.比如(/data1,/data2,/data3)</span><br><span class="line">log_level：         MHA manager 的日志级别,默认是info级别,在大多数环境下没有问题.可用的级别有.debug/info/warning/error</span><br><span class="line">manager_workdir：   MHA manager使用的工作目录,如果没有设置,默认使用/var/tmp</span><br><span class="line">client_bindir：     如果mysql命令行工具没有安装在默认目录,可以使用这个选项配置</span><br><span class="line">client_libdir：     如果mysql lib没有安装在默认目录,可以使用这个选项配置</span><br><span class="line">manager_log：       MHA manager日志文件的绝对目录和文件名,如果没有设置,那么将直接打印到标准输出和标准错误输出</span><br><span class="line">当执行交互式的failover时,MHA manager将会忽略manager_log设置,直接答应到标准输出和标准错误输出</span><br><span class="line">check_repl_delay：  </span><br><span class="line">默认情况下如果一个slave比master延时了100M的relay logs.MHA不会选择这个slave作为新的master.因为他需要更多的时间来recovery</span><br><span class="line">设置check_repl_delay=0,MHA在选择new master时将会忽略复制的延时.这个参数通常和candidate_master=1同时使用</span><br><span class="line">check_repl_filter： </span><br><span class="line">默认情况下如果master和slave有不同的binary log/replication 过滤规则的话,MHA打印错误,不进行start monitoring或者failover</span><br><span class="line">这么做的目的是为了避免recover的时候出现意外的错误,例如&quot;Table not exists&quot;,如果你100%确定你不同的过滤规则不会导致recover时候报错,</span><br><span class="line">那么你可以设置check_repl_fiter=0,这样的话,MHA在应用差异日志的时候将不会在检查过滤规则.使用这个参数的时候需要非常小心</span><br><span class="line">latest_priority：   默认情况下,接收到了最新的binlog的slave优先被选为new master,如果你想要控制优先级的顺序,比如(host2&gt;host3&gt;host4),那么设置latest_priority=0会有所帮助</span><br><span class="line">multi_tier_slave：  </span><br><span class="line">MHA manager从0.5.2开始支持多主复制.默认情况下,它不支持三层以上的复制架构.例如,host2是host1的slave,host3是host2的slave,</span><br><span class="line">默认不允许把这个三个主机写到同一个配置文件中因为这是一个三层的复制架构,并且MHA会因此报错,并停止工作.如果设置了multi_tier_slave,</span><br><span class="line">MHA manager不会因为多层架构而终止,它会忽略三层及以上的主机,例如master(host1)挂掉以后,host2会被选为新的master,host3将继续从host2复制</span><br><span class="line">ping_interval：     </span><br><span class="line">这个参数声明MHA manager pings(通过执行sql来ping) master的间隔.当连续三次ping失败,MHA manager认为这个Mysql master宕机,从宕机到检测到宕机,</span><br><span class="line">最大的消耗时间是这个参数的四倍,这个参数默认值是3(3秒),如果MHA manager因为权限问题多次连接失败,这不认为master dead</span><br><span class="line">ping_type：</span><br><span class="line">从MHA manager 0.53开始支持这个参数, MHA建立一个长连接到master,然后通过执行&quot;SELECT 1&quot; (ping_type=SELECT)来判断master是否可用</span><br><span class="line">但是在一些环境下,最好使用短连接的方式,因为这样的方式更严格,也能检测TCP连接级别的失败.设置ping_type=CONNECT可以实现.从0.56版本开始,支持ping_type=INSERT</span><br><span class="line">secondary_check_script：</span><br><span class="line">通常情况,强力推荐使用两个或者多个路由检测Mysql master默认MHA通过一个路由检测:从manager到master.这是不推荐的</span><br><span class="line">MHA manager可以通过secondary_check_script参数调用一个内部脚本来实现两个或者多个路由的检测.下面是一个配置实例</span><br><span class="line">secondary_check_script = masterha_secondary_check -s remote_host1 -s remote_host2</span><br><span class="line">MHA manager包含masterha_secondary_check 脚本.内置的masterha_secondary_check脚本可以满足大多是环境,当然你也可以调用你自定义的脚本.</span><br><span class="line">在上面的实例中,MHA manager通过这两个路由检测master主机</span><br><span class="line">Manager-(A)-&gt;remote_host1-(B)-&gt;master_host</span><br><span class="line">Manager-(A)-&gt;remote_host2-(B)-&gt;master_host</span><br><span class="line">如果两条路径中,A都是成功的,B都是不成功的,那么masterha_secondary_check将会退出,返回状态0.MHA manager将会认为Mysql master宕机,开始failover</span><br><span class="line">如果A失败,那么masterha_secondary_check将退出,返回状态2,MHA manager网络出现问题,不会开始failover</span><br><span class="line">如果B检测成功,masterha_secondary_check退出并返回状态3,MHA manager明确的知道mysql master是活跃的,不开始failover</span><br><span class="line">通常来讲,remote_host1和remote_host2必须和 MHA manager及Mysql server不在同一个网段,这样才更有意义</span><br><span class="line">MHA调用secondary_check_script参数对应的脚本会自动传递以下参数(所以你不需要在配置文件中设置),</span><br><span class="line">masterha_secondary_check适用于大多数环境,如果你需要其他的功能可以自己写一个网络检查的脚本.</span><br><span class="line">--user=(SSH username of the remote hosts. ssh_user parameter value will be passed)</span><br><span class="line">--master_host=(master&apos;s hostname)</span><br><span class="line">--master_ip=(master&apos;s ip address)</span><br><span class="line">--master_port=(master&apos;s port number)</span><br><span class="line">注意:</span><br><span class="line">masterha_secondary_check脚本依赖于IO::Socket::INET perl包,在perl v5.6.0中默认包含,masterha_secondary_check脚本会通过</span><br><span class="line">ssh连接到所有的remote servers.所以SSH public key 认证需要设置.另外masterha_secondary_check脚本尝试使用TCP连接从remote server到mysql master.这意味着服务器设置的max_connections参数对此连接无效,并且如果TCP连接成功,Aborted_connects状态将会加1</span><br><span class="line">master_ip_failover_script：</span><br><span class="line">常见的HA环境下,大多是情况会给master分配一个虚拟IP,如果master宕机,HA软件像一个Pacemaker将虚拟IP转移到备用的master上</span><br><span class="line">另外一种常见的方法就是创建一个全局目录数据库,包含所有应用和writer/reader ip地址.例如&#123;app_master1,192.168.0.1&#125;,&#123;app_master2,192.168.0.2&#125;...,代替使用虚拟IP,</span><br><span class="line">这种情况,你需要在master宕机的时候更新目录数据库</span><br><span class="line">两种方法都有好的或者不好的地方,MHA不强制要求使用哪一种,但是提供了master_ip_failover_script参数来完成此目的</span><br><span class="line">换句话说,你需要写一个脚本来调整应用服务连接到新的master,然后定义master_ip_failover_script的参数,下面是一个实例</span><br><span class="line">master_ip_failover_script= /usr/local/bin/master_ip_failover</span><br><span class="line">你可以从(MHA Manager package)/samples/scripts/master_ip_failover找到一个简单的脚本.这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">MHA manager会调用master_ip_failover_script三次,</span><br><span class="line">第一次,在开始master monitor之前调用(目的是检查脚本是否可用),</span><br><span class="line">第二次是在调用shutdown_script脚本前调用,</span><br><span class="line">第三次是在new master应用完所有的差异日志以后,MHA manager会传递给脚本如下参数.(你不用在配置文件中指明这些参数)</span><br><span class="line">Checking phase</span><br><span class="line">--command=status</span><br><span class="line">--ssh_user=(current master&apos;s ssh username)</span><br><span class="line">--orig_master_host=(current master&apos;s hostname)</span><br><span class="line">--orig_master_ip=(current master&apos;s ip address)</span><br><span class="line">--orig_master_port=(current master&apos;s port number)</span><br><span class="line">Current master shutdown phase</span><br><span class="line">--command=stop or stopssh</span><br><span class="line">--ssh_user=(dead master&apos;s ssh username, if reachable via ssh)</span><br><span class="line">--orig_master_host=(current(dead) master&apos;s hostname)</span><br><span class="line">--orig_master_ip=(current(dead) master&apos;s ip address)</span><br><span class="line">--orig_master_port=(current(dead) master&apos;s port number)</span><br><span class="line">New master activation phase</span><br><span class="line">--command=start</span><br><span class="line">--ssh_user=(new master&apos;s ssh username)</span><br><span class="line">--orig_master_host=(dead master&apos;s hostname)</span><br><span class="line">--orig_master_ip=(dead master&apos;s ip address)</span><br><span class="line">--orig_master_port=(dead master&apos;s port number)</span><br><span class="line">--new_master_host=(new master&apos;s hostname)</span><br><span class="line">--new_master_ip=(new master&apos;s ip address)</span><br><span class="line">--new_master_port(new master&apos;s port number)</span><br><span class="line">--new_master_user=(new master&apos;s user)</span><br><span class="line">--new_master_password(new master&apos;s password)</span><br><span class="line">如果你使用共享虚拟IP的方法,你不需要在master shutdown阶段做任何事情,只要通过shutdown_script脚本关掉原来master的电源,在激活new master阶段,</span><br><span class="line">你需要分配虚拟IP给new master.如果你使用目录数据库的方法,你需要在宕机的master shutdown阶段删除或者更新失效master的记录</span><br><span class="line">在new master生效阶段需要插入或者更新new master的记录.另外你可以做任何事情来保证应用程序可以成功的写入new master</span><br><span class="line">比如SET GLOBAL read_only=0，创建有写入权限的数据库用户等等</span><br><span class="line">MHA manager检查脚本的退出状态,如果脚本退出状态是0或者10,MHA manager继续操作,如果脚本退出状态不是0或者10,MHA manager将会意外终止,并不继续continue failover.默认这个参数是空的</span><br><span class="line">master_ip_online_change_script：</span><br><span class="line">这是几个简单版本的master_ip_failover_script参数,但是master failover命令并不调用它.master online change命令会调用它.(masterha_master_switch --master_state=alive),传递以下参数</span><br><span class="line">Current master write freezing phase</span><br><span class="line">--command=stop or stopssh</span><br><span class="line">--orig_master_host=(current master&apos;s hostname)</span><br><span class="line">--orig_master_ip=(current master&apos;s ip address)</span><br><span class="line">--orig_master_port=(current master&apos;s port number)</span><br><span class="line">--orig_master_user=(current master&apos;s user)</span><br><span class="line">--orig_master_password=(current master&apos;s password)</span><br><span class="line">--orig_master_ssh_user=(from 0.56, current master&apos;s ssh user)</span><br><span class="line">--orig_master_is_new_slave=(from 0.56, notifying whether the orig master will be new slave or not)</span><br><span class="line">New master granting write phase</span><br><span class="line">--command=start</span><br><span class="line">--orig_master_host=(orig master&apos;s hostname)</span><br><span class="line">--orig_master_ip=(orig master&apos;s ip address)</span><br><span class="line">--orig_master_port=(orig master&apos;s port number)</span><br><span class="line">--new_master_host=(new master&apos;s hostname)</span><br><span class="line">--new_master_ip=(new master&apos;s ip address)</span><br><span class="line">--new_master_port(new master&apos;s port number)</span><br><span class="line">--new_master_user=(new master&apos;s user)</span><br><span class="line">--new_master_password=(new master&apos;s password)</span><br><span class="line">--new_master_ssh_user=(from 0.56, new master&apos;s ssh user)</span><br><span class="line">MHA在当前的master write freezing阶段后执行FLUASH TABLES WITH READ LOCK, 在new mastergranting write阶段你可以执行一些类似master_ip_failover_script的操作</span><br><span class="line">比如创建一个有写入权限的用户,执行SET GLOBAL read_only=0,更新目录数据库等.如果你的脚本退出返回状态不是1或者10,那么MHA manager将会意外终止,</span><br><span class="line">停止master switch这个参数默认为空,所以MHA manager不做任何调用你可以从(MHA Manager package)/samples/scripts/master_ip_online_change找到一个简单的脚本</span><br><span class="line">这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">shutdown_script：</span><br><span class="line">你可能需要强制关闭master服务器,避免他再次提供服务,这对于避免脑裂很重要.下面是一个实例</span><br><span class="line">shutdown_script= /usr/local/bin/power_manager</span><br><span class="line">你可以从(MHA Manager package)/samples/scripts/power_manager找到一个简单的脚本.这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">在调用shutdown_script脚本之前,MHA manager内部会通过ssh尝试连接到mysql master,如果ssh可以连接(意思就是OS是存活的,但是Mysqld没有运行),MHAmanager就会传递下面的参数</span><br><span class="line">--command=stopssh (这个意思就是指停止服务,不会关机)</span><br><span class="line">--ssh_user=(ssh username so that you can connect to the master)</span><br><span class="line">--host=(master&apos;s hostname)</span><br><span class="line">--ip=(master&apos;s ip address)</span><br><span class="line">--port=(master&apos;s port number)</span><br><span class="line">--pid_file=(master&apos;s pid file)</span><br><span class="line">如果master主机的ssh不能连接,那么MHA会使用如下参数</span><br><span class="line">--command=stop (这个会通过fence设备关掉电源)</span><br><span class="line">--host=(master&apos;s hostname)</span><br><span class="line">--ip=(master&apos;s ip address)</span><br><span class="line">这个脚本的大概功能如下,如果--command=stopssh被调用,脚本会使用killall -9 杀掉目标服务器上所有的mysqld_safe服务</span><br><span class="line">如果--pid_file被设置,脚本尝试kill指定的进程.如果脚本执行成功,那么脚本会退出返回状态10.如果退出状态为10,</span><br><span class="line">MHA manager后面会通过ssh连接到master,获取需要的binary log.如果脚本通过ssh连接到服务器失败,那么就会传递--command=stop参数,这个参数尝试关闭机器的电源,</span><br><span class="line">关闭电源依赖于H/W.HP(ILO),DELL(DRAC).如果power off成功,脚本会然会状态0,其他情况会返回状态1.当返回状态是0的时候MHA manager </span><br><span class="line">开始failover.如果返回状态不是0或者10,那么MHA manager会意外终止.这个参数默认是空,所以MHA manager不会调用任何脚本</span><br><span class="line">另外,MHA manager在启动monitoring之前调用shutdown_script.这时候会传递下面的参数.目的是检测脚本是否可用,如果发现错误,你可以提前知道</span><br><span class="line">--command=status</span><br><span class="line">--host=(master&apos;s hostname)</span><br><span class="line">--ip=(master&apos;s ip address)</span><br><span class="line">report_script：</span><br><span class="line">你希望当failover发生以后可以发送一个报告(例如email),report_script可以达到这个目的,MHA manager传递下面的参数</span><br><span class="line">--orig_master_host=(dead master&apos;s hostname)</span><br><span class="line">--new_master_host=(new master&apos;s hostname)</span><br><span class="line">--new_slave_hosts=(new slaves&apos; hostnames, delimited by commas)</span><br><span class="line">--subject=(mail subject)</span><br><span class="line">--body=(body)</span><br><span class="line">默认这个参数是空的,所以MHA manager不调用任何脚本，你可以从(MHA Manager package)/samples/scripts/send_report找到一个简单的脚本</span><br><span class="line">这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">init_conf_load_script：</span><br><span class="line">这个脚本可以在你不想在配置文件中写明文密码的时候使用.你可以覆盖全局配置参数.实例脚本如下</span><br><span class="line">#!/usr/bin/perl</span><br><span class="line">print &quot;password=$ROOT_PASS\n&quot;;</span><br><span class="line">print &quot;repl_password=$REPL_PASS\n&quot;;</span><br><span class="line">这个参数默认为空,所以MHA manager默认不调用任何脚本</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>MySQL Master High Available 理论篇：<br><a href="https://yq.aliyun.com/articles/58004?spm=5176.100239.blogcont57855.9.jUuCt0" target="_blank" rel="noopener">https://yq.aliyun.com/articles/58004?spm=5176.100239.blogcont57855.9.jUuCt0</a></p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>云服务器上MySQL高可用，也可通过云负载均衡产品+MySQL复制来实现，但在数据安全性上，没有MHA+VIP+MySQL相对安全。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MySQL/" rel="tag"># MySQL</a>
          
            <a href="/tags/AWS/" rel="tag"># AWS</a>
          
            <a href="/tags/EC2/" rel="tag"># EC2</a>
          
            <a href="/tags/VIP/" rel="tag"># VIP</a>
          
            <a href="/tags/MHA/" rel="tag"># MHA</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/MongoDB从MMAPv1在线迁移至WiredTiger引擎.html" rel="next" title="MongoDB从MMAPv1在线迁移至WiredTiger引擎">
                <i class="fa fa-chevron-left"></i> MongoDB从MMAPv1在线迁移至WiredTiger引擎
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/误删除frm、ibd文件恢复案例.html" rel="prev" title="误删除frm、ibd文件恢复案例">
                误删除frm、ibd文件恢复案例 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jiessie</p>
              <p class="site-description motion-element" itemprop="description">最怕一生碌碌无为,还说平凡难能可贵！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA简介"><span class="nav-number">2.</span> <span class="nav-text">MHA简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备"><span class="nav-number">3.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统初始化修改"><span class="nav-number">4.</span> <span class="nav-text">系统初始化修改</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#修改主机名"><span class="nav-number">4.1.</span> <span class="nav-text">修改主机名</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库修改主机名"><span class="nav-number">4.1.1.</span> <span class="nav-text">主库修改主机名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库修改主机名"><span class="nav-number">4.1.2.</span> <span class="nav-text">从库修改主机名</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改时区"><span class="nav-number">4.2.</span> <span class="nav-text">修改时区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置防火墙"><span class="nav-number">4.3.</span> <span class="nav-text">设置防火墙</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库设置，允许从库访问"><span class="nav-number">4.3.1.</span> <span class="nav-text">主库设置，允许从库访问</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库设置，允许主库访问"><span class="nav-number">4.3.2.</span> <span class="nav-text">从库设置，允许主库访问</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭SELINUX"><span class="nav-number">4.4.</span> <span class="nav-text">关闭SELINUX</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立SSH无密码登录"><span class="nav-number">5.</span> <span class="nav-text">建立SSH无密码登录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主库设置"><span class="nav-number">5.1.</span> <span class="nav-text">主库设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从库设置"><span class="nav-number">5.2.</span> <span class="nav-text">从库设置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL安装"><span class="nav-number">6.</span> <span class="nav-text">MySQL安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL互为主备"><span class="nav-number">7.</span> <span class="nav-text">MySQL互为主备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#重要参数配置"><span class="nav-number">7.1.</span> <span class="nav-text">重要参数配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制帐号建立"><span class="nav-number">7.2.</span> <span class="nav-text">复制帐号建立</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库创建"><span class="nav-number">7.2.1.</span> <span class="nav-text">主库创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库创建"><span class="nav-number">7.2.2.</span> <span class="nav-text">从库创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#复制帐号验证"><span class="nav-number">7.2.3.</span> <span class="nav-text">复制帐号验证</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制关系配置"><span class="nav-number">7.3.</span> <span class="nav-text">复制关系配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库配置"><span class="nav-number">7.3.1.</span> <span class="nav-text">主库配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库配置"><span class="nav-number">7.3.2.</span> <span class="nav-text">从库配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制测试"><span class="nav-number">7.4.</span> <span class="nav-text">复制测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库登录测试"><span class="nav-number">7.4.1.</span> <span class="nav-text">主库登录测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库登录测试"><span class="nav-number">7.4.2.</span> <span class="nav-text">从库登录测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHA帐号建立"><span class="nav-number">7.5.</span> <span class="nav-text">MHA帐号建立</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库创建-1"><span class="nav-number">7.5.1.</span> <span class="nav-text">主库创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库创建-1"><span class="nav-number">7.5.2.</span> <span class="nav-text">从库创建</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA安装"><span class="nav-number">8.</span> <span class="nav-text">MHA安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装依赖"><span class="nav-number">8.1.</span> <span class="nav-text">安装依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主库安装mha4mysql-node"><span class="nav-number">8.2.</span> <span class="nav-text">主库安装mha4mysql-node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从库安装mha4mysql-manager和mha4mysql-node"><span class="nav-number">8.3.</span> <span class="nav-text">从库安装mha4mysql-manager和mha4mysql-node</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA目录结构说明"><span class="nav-number">9.</span> <span class="nav-text">MHA目录结构说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MHAManager"><span class="nav-number">9.1.</span> <span class="nav-text">MHAManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHANode"><span class="nav-number">9.2.</span> <span class="nav-text">MHANode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义扩展脚本说明"><span class="nav-number">9.3.</span> <span class="nav-text">自定义扩展脚本说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA扩展脚本"><span class="nav-number">10.</span> <span class="nav-text">MHA扩展脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#aws-vip-change-sh"><span class="nav-number">10.1.</span> <span class="nav-text">aws_vip_change.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#master-ip-failover"><span class="nav-number">10.2.</span> <span class="nav-text">master_ip_failover</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#send-report"><span class="nav-number">10.3.</span> <span class="nav-text">send_report</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#主库手动绑定ENI和实例关系"><span class="nav-number">11.</span> <span class="nav-text">主库手动绑定ENI和实例关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#从库配置MHAManager"><span class="nav-number">12.</span> <span class="nav-text">从库配置MHAManager</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试MHAManager-SSH"><span class="nav-number">13.</span> <span class="nav-text">测试MHAManager SSH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试MHAManager-复制"><span class="nav-number">14.</span> <span class="nav-text">测试MHAManager 复制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动MHAManager"><span class="nav-number">15.</span> <span class="nav-text">启动MHAManager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动进程"><span class="nav-number">15.1.</span> <span class="nav-text">启动进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看启动日志"><span class="nav-number">15.2.</span> <span class="nav-text">查看启动日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模拟主库故障"><span class="nav-number">16.</span> <span class="nav-text">模拟主库故障</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#确认当前VIP状态"><span class="nav-number">16.1.</span> <span class="nav-text">确认当前VIP状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#确认MHAManger进程状态"><span class="nav-number">16.2.</span> <span class="nav-text">确认MHAManger进程状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#停止主库服务，触发主库FailOver"><span class="nav-number">16.3.</span> <span class="nav-text">停止主库服务，触发主库FailOver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#观察FailOver日志"><span class="nav-number">16.4.</span> <span class="nav-text">观察FailOver日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志过程解析"><span class="nav-number">16.5.</span> <span class="nav-text">日志过程解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#确认FailOver状态"><span class="nav-number">16.6.</span> <span class="nav-text">确认FailOver状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看邮件发送状态"><span class="nav-number">16.7.</span> <span class="nav-text">查看邮件发送状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手动FailOver"><span class="nav-number">16.8.</span> <span class="nav-text">手动FailOver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参数列表"><span class="nav-number">16.9.</span> <span class="nav-text">参数列表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#详情解释"><span class="nav-number">16.9.1.</span> <span class="nav-text">详情解释</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">17.</span> <span class="nav-text">参考</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结束语"><span class="nav-number">18.</span> <span class="nav-text">结束语</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiessie</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
