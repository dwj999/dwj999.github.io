<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="MySQL,AWS,EC2,VIP,MHA," />





  <link rel="alternate" href="/atom.xml" title="Jiessie's' Blog" type="application/atom+xml" />






<meta name="description" content="前言随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在AWS EC2结合MHA做MySQL的高可用，EC2不支持VIP，可通过绑定私有IP的方式来实现。 MHA简介M">
<meta name="keywords" content="MySQL,AWS,EC2,VIP,MHA">
<meta property="og:type" content="article">
<meta property="og:title" content="AWS EC2搭建MHA+VIP+MySQL5.7">
<meta property="og:url" content="https://dwj999.github.io/AWS-EC2搭建MHA-VIP-MySQL5-7.html">
<meta property="og:site_name" content="Jiessie&#39;s&#39; Blog">
<meta property="og:description" content="前言随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在AWS EC2结合MHA做MySQL的高可用，EC2不支持VIP，可通过绑定私有IP的方式来实现。 MHA简介M">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://note.youdao.com/yws/public/resource/bba80193f9c2d29f073784f4e498b134/xmlnote/0A43FC640BD84154ADCD175F765F82E1/33468">
<meta property="og:updated_time" content="2020-05-20T03:46:16.745Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="AWS EC2搭建MHA+VIP+MySQL5.7">
<meta name="twitter:description" content="前言随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在AWS EC2结合MHA做MySQL的高可用，EC2不支持VIP，可通过绑定私有IP的方式来实现。 MHA简介M">
<meta name="twitter:image" content="http://note.youdao.com/yws/public/resource/bba80193f9c2d29f073784f4e498b134/xmlnote/0A43FC640BD84154ADCD175F765F82E1/33468">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dwj999.github.io/AWS-EC2搭建MHA-VIP-MySQL5-7.html"/>





<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

  <title>AWS EC2搭建MHA+VIP+MySQL5.7 | Jiessie's' Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"><a href="https://github.com/dwj999" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jiessie's' Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">没伞的孩子必须努力奔跑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/AWS-EC2搭建MHA-VIP-MySQL5-7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">AWS EC2搭建MHA+VIP+MySQL5.7</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T16:51:22+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/集群高可用/" itemprop="url" rel="index">
                    <span itemprop="name">集群高可用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在AWS EC2结合MHA做MySQL的高可用，EC2不支持VIP，可通过绑定私有IP的方式来实现。</p>
<h2 id="MHA简介"><a href="#MHA简介" class="headerlink" title="MHA简介"></a>MHA简介</h2><p>MHA是由日本MySQL专家youshimaton(现就职于Facebook公司)用Perl写的一套MySQL故障切换方案，以保障数据库的高可用性。在MySQL故障切换过程中，MHA能做到在0~30s之内实现主MySQL故障转移。<br>该软件由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）。MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：Amazon Linux<br>master:172.31.13.126<br>slave:172.31.9.182<br>vip:172.31.0.200<br>其中，使用两台机器，分别部署主库和从库，MHA默认部署在从库上，下方中的VIP通指私有IP。  </p>
<h2 id="系统初始化修改"><a href="#系统初始化修改" class="headerlink" title="系统初始化修改"></a>系统初始化修改</h2><h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><h4 id="主库修改主机名"><a href="#主库修改主机名" class="headerlink" title="主库修改主机名"></a>主库修改主机名</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/sysconfig/network</span><br><span class="line"><span class="attribute">NETWORKING</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">HOSTNAME</span>=master</span><br></pre></td></tr></table></figure>
<h4 id="从库修改主机名"><a href="#从库修改主机名" class="headerlink" title="从库修改主机名"></a>从库修改主机名</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/sysconfig/network</span><br><span class="line"><span class="attribute">NETWORKING</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">HOSTNAME</span>=slave</span><br></pre></td></tr></table></figure>
<h3 id="修改时区"><a href="#修改时区" class="headerlink" title="修改时区"></a>修改时区</h3><p>Amazon Linux默认安装好后英国时间，需要在主库和从库修改时区<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# ln</span> -sf /usr/share/zone<span class="literal">inf</span>o/Asia/Shanghai /etc/localtime</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# /usr</span>/sbin/ntpdate <span class="number">0</span>.centos.pool.ntp.org &amp;&amp; /sbin/hwclock -w &amp;&gt;/dev/null</span><br></pre></td></tr></table></figure></p>
<h3 id="设置防火墙"><a href="#设置防火墙" class="headerlink" title="设置防火墙"></a>设置防火墙</h3><h4 id="主库设置，允许从库访问"><a href="#主库设置，允许从库访问" class="headerlink" title="主库设置，允许从库访问"></a>主库设置，允许从库访问</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/iptables status|grep <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span></span><br><span class="line"><span class="number">15</span>   ACCEPT     all  --  <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span>         <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>           </span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<p>其中，172.31.9.182是允许从库的访问规则</p>
<h4 id="从库设置，允许主库访问"><a href="#从库设置，允许主库访问" class="headerlink" title="从库设置，允许主库访问"></a>从库设置，允许主库访问</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# /etc/init.d/iptables status|grep <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span> </span><br><span class="line"><span class="number">15</span>   ACCEPT     all  --  <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span>        <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>           </span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<p>其中，172.31.13.126是允许主库的访问规则</p>
<h3 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h3><p>由于使用的操作系统为Amazon Linux，通过查看无selinux设置。</p>
<h2 id="建立SSH无密码登录"><a href="#建立SSH无密码登录" class="headerlink" title="建立SSH无密码登录"></a>建立SSH无密码登录</h2><h3 id="主库设置"><a href="#主库设置" class="headerlink" title="主库设置"></a>主库设置</h3><p>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no。<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# sed</span> '/^<span class="comment">#/d;/^$/d' /etc/ssh/ssh_config |grep GSSAPIAuthentication</span></span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# sed</span> '/^<span class="comment">#/d;/^$/d' /etc/ssh/sshd_config |grep -E 'PasswordAuthentication|PermitRootLogin'</span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PermitRootLogin forced-commands-only</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# /etc</span>/init.d/sshd restart</span><br><span class="line">停止 sshd：                                                [确定]</span><br><span class="line">正在启动 sshd：                                            [确定]</span><br></pre></td></tr></table></figure></p>
<p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">43:a3:80:f1:8c:d4:5e:8d:3c:99:e5:39:39:e3:89:9a root<span class="meta">@master</span></span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|<span class="string">  o. . *.        </span>|</span><br><span class="line">|<span class="string"> . *. B..o       </span>|</span><br><span class="line">|<span class="string">  o.+. .X        </span>|</span><br><span class="line">|<span class="string">    .. = *       </span>|</span><br><span class="line">|<span class="string">      o S        </span>|</span><br><span class="line">|<span class="string">     o   .       </span>|</span><br><span class="line">|<span class="string">    E            </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">+-----------------+</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.9.182</span></span><br><span class="line">The authenticity of host '172.31.9.182 (172.31.9.182)' can't be established.</span><br><span class="line">ECDSA key fingerprint is 72:71:66:dc:6c:b0:31:e7:6c:77:4c:8d:32:69:e0:88.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.9.182's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.9.182'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.13.126</span></span><br><span class="line">The authenticity of host '172.31.13.126 (172.31.13.126)' can't be established.</span><br><span class="line">ECDSA key fingerprint is b6:ef:9f:f0:5e:fd:8f:49:ef:be:79:fb:44:ea:63:08.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.13.126's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.13.126'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh 'root@172.31.9.182'</span></span><br><span class="line">Last login: Thu Jul 20 04:51:07 2017</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.9.182 closed.</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh 'root@172.31.13.126'</span></span><br><span class="line">Last login: Thu Jul 20 04:37:13 2017</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br></pre></td></tr></table></figure></p>
<h3 id="从库设置"><a href="#从库设置" class="headerlink" title="从库设置"></a>从库设置</h3><p>和主库的配置相同<br>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no。<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># sed <span class="string">'/^#/d;/^$/d'</span> /etc/ssh/ssh_config |grep GSSAPIAuthentication</span></span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># sed <span class="string">'/^#/d;/^$/d'</span> /etc/ssh/sshd_config |grep -E <span class="string">'PasswordAuthentication|PermitRootLogin'</span></span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PermitRootLogin forced-commands-only</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># /etc/init.d/sshd restart</span></span><br><span class="line">停止 sshd：                                                [确定]</span><br><span class="line">正在启动 sshd：                                            [确定]</span><br></pre></td></tr></table></figure></p>
<p>使用命令ssh-keygen生成公钥，发送到主库，同时尝试在从库无密码形式登录主库，而且也要保证本机无密码登录本机<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">7d:57:15:e0:20:6f:6f:45:00:76:c4:ba:66:32:fd:b3 root<span class="meta">@slave</span></span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|<span class="string">         . ++=ooo</span>|</span><br><span class="line">|<span class="string">          + +.. .</span>|</span><br><span class="line">|<span class="string">           o.. ..</span>|</span><br><span class="line">|<span class="string">         .... .. </span>|</span><br><span class="line">|<span class="string">        S o oo.  </span>|</span><br><span class="line">|<span class="string">         o *..   </span>|</span><br><span class="line">|<span class="string">          = .    </span>|</span><br><span class="line">|<span class="string">             o   </span>|</span><br><span class="line">|<span class="string">             Eo  </span>|</span><br><span class="line">+-----------------+</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">da:ea:e3:1c:fb:4b:f5:84:da:a3:47:ea:2c:fa:3c:a6 root<span class="meta">@slave</span></span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">           .     </span>|</span><br><span class="line">|<span class="string">        S o .    </span>|</span><br><span class="line">|<span class="string">       o +.o     </span>|</span><br><span class="line">|<span class="string">      o +oo .    </span>|</span><br><span class="line">|<span class="string">     o=*....     </span>|</span><br><span class="line">|<span class="string">    EBO**o       </span>|</span><br><span class="line">+-----------------+</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.13.126</span></span><br><span class="line">The authenticity of host '172.31.13.126 (172.31.13.126)' can't be established.</span><br><span class="line">ECDSA key fingerprint is b6:ef:9f:f0:5e:fd:8f:49:ef:be:79:fb:44:ea:63:08.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.13.126's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.13.126'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.9.182</span></span><br><span class="line">The authenticity of host '172.31.9.182 (172.31.9.182)' can't be established.</span><br><span class="line">ECDSA key fingerprint is 72:71:66:dc:6c:b0:31:e7:6c:77:4c:8d:32:69:e0:88.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.9.182's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.9.182'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh 'root@172.31.13.126'</span></span><br><span class="line">Last login: Thu Jul 20 05:36:57 2017 from 172.31.13.126</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh 'root@172.31.9.182' </span></span><br><span class="line">Last login: Thu Jul 20 05:36:46 2017 from 172.31.13.126</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.9.182 closed.</span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL安装"><a href="#MySQL安装" class="headerlink" title="MySQL安装"></a>MySQL安装</h2><p>使用的是自己打包的RPM包，分别登录主库和从库，直接rpm -ivh percona-server-5.7.18-15.x86_64.rpm 即可，也可使用其他方式安装MySQL<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mv /home/zhouting/percona-server-5.7.18-15.x86_64.rpm  /usr/src/</span><br><span class="line">[root@master ~]# rpm -ivh /usr/src/percona-server-5.7.18-15.x86_64.rpm </span><br><span class="line">Preparing<span class="built_in">..</span>.                          ################################# [100%]</span><br><span class="line">Updating / installing<span class="built_in">..</span>.</span><br><span class="line">   1:percona-server-5.7.18-15         ################################# [100%]</span><br><span class="line"><span class="builtin-name">error</span> reading information on<span class="built_in"> service </span>/etc/rc.d/init.d/mysqld: <span class="literal">No</span> such file <span class="keyword">or</span> directory</span><br><span class="line"> ERROR! MySQL (Percona Server) PID file could <span class="keyword">not</span> be found!</span><br><span class="line">Starting MySQL (Percona Server)<span class="built_in">..</span> SUCCESS! </span><br><span class="line">mysqladmin: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">Warning: Since password will be sent <span class="keyword">to</span><span class="built_in"> server </span><span class="keyword">in</span> plain text, use ssl<span class="built_in"> connection </span><span class="keyword">to</span> ensure password safety.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br></pre></td></tr></table></figure></p>
<p>查看是否安装成功，分别登录主库和从库查看<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">11</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">16</span>:<span class="number">57</span>:<span class="number">43</span> &gt; select <span class="built_in">version</span>();</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| <span class="built_in">version</span>()     |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">16</span>:<span class="number">57</span>:<span class="number">47</span> &gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL互为主备"><a href="#MySQL互为主备" class="headerlink" title="MySQL互为主备"></a>MySQL互为主备</h2><h3 id="重要参数配置"><a href="#重要参数配置" class="headerlink" title="重要参数配置"></a>重要参数配置</h3><p>主库必须包含以下参数<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># cat /etc/my.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 1</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 1</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br></pre></td></tr></table></figure></p>
<p>从库必须包含以下参数，注意slave需要动态设置read_only=1，<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/my.cnf </span><br><span class="line"><span class="meta">[mysqld]</span></span><br><span class="line">server-id = 2</span><br><span class="line">autocommit = 1</span><br><span class="line">auto<span class="emphasis">_increment_</span>increment = 2</span><br><span class="line">auto<span class="emphasis">_increment_</span>offset = 2</span><br><span class="line">log<span class="emphasis">_bin = mysql-bin</span></span><br><span class="line"><span class="emphasis">gtid_</span>mode = on</span><br><span class="line">enforce<span class="emphasis">_gtid_</span>consistency = 1</span><br><span class="line">log<span class="emphasis">_slave_</span>updates</span><br><span class="line">relay<span class="emphasis">_log_</span>purge=0</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e "show variables like <span class="emphasis">'read_only'</span>"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| read_</span>only     | OFF   |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e "set global read<span class="emphasis">_only=1"</span></span><br><span class="line"><span class="emphasis">Enter password: </span></span><br><span class="line"><span class="emphasis">[root@slave ~]# mysql -uroot -p -e "show variables like 'read_</span>only'"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| read_</span>only     | ON    |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="复制帐号建立"><a href="#复制帐号建立" class="headerlink" title="复制帐号建立"></a>复制帐号建立</h3><p>由于MySQL版本使用的是5.7，创建用户的方法以之前有些不同  </p>
<h4 id="主库创建"><a href="#主库创建" class="headerlink" title="主库创建"></a>主库创建</h4><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">6</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">16</span>:<span class="number">52</span> &gt; <span class="keyword">create</span> user <span class="string">'slave01'</span>@<span class="string">'172.31.9.182'</span> identified <span class="keyword">by</span> <span class="string">'slave123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">17</span>:<span class="number">21</span> &gt; grant replication slave,replication client <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'172.31.9.182'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">17</span>:<span class="number">34</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">17</span>:<span class="number">38</span> &gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>
<h4 id="从库创建"><a href="#从库创建" class="headerlink" title="从库创建"></a>从库创建</h4><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">6</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">19</span>:<span class="number">24</span> &gt; <span class="keyword">create</span> user <span class="string">'slave01'</span>@<span class="string">'172.31.13.126'</span> identified <span class="keyword">by</span> <span class="string">'slave123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">19</span>:<span class="number">49</span> &gt; grant replication slave,replication client <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'172.31.13.126'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">20</span>:<span class="number">02</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">20</span>:<span class="number">05</span> &gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>
<h4 id="复制帐号验证"><a href="#复制帐号验证" class="headerlink" title="复制帐号验证"></a>复制帐号验证</h4><p>主库登录从库<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -h172.31.9.182 -uslave01 -pslave123456</span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQ<span class="class">L monitor.  Commands end with ;</span><span class="built_in"> or </span>\g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC<span class="built_in"> and/or </span>its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle<span class="built_in"> and/or </span>its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation<span class="built_in"> and/or </span>its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;'<span class="built_in"> or </span>'\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:22:15 &gt; exit</span><br></pre></td></tr></table></figure></p>
<p>从库登录主库<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -h172.31.13.126 -uslave01 -pslave123456             </span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQ<span class="class">L monitor.  Commands end with ;</span><span class="built_in"> or </span>\g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC<span class="built_in"> and/or </span>its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle<span class="built_in"> and/or </span>its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation<span class="built_in"> and/or </span>its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;'<span class="built_in"> or </span>'\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:22:57 &gt; exit</span><br></pre></td></tr></table></figure></p>
<h3 id="复制关系配置"><a href="#复制关系配置" class="headerlink" title="复制关系配置"></a>复制关系配置</h3><h4 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h4><p>登录主库，设置复制关系，来源于从库的复制<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-p</span></span><br><span class="line"><span class="string">Enter</span> <span class="attr">password:</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">the</span> <span class="string">MySQL</span> <span class="string">monitor.</span>  <span class="string">Commands</span> <span class="string">end</span> <span class="string">with</span> <span class="string">;</span> <span class="string">or</span> <span class="string">\g.</span></span><br><span class="line"><span class="string">Your</span> <span class="string">MySQL</span> <span class="string">connection</span> <span class="string">id</span> <span class="string">is</span> <span class="number">17</span></span><br><span class="line"><span class="string">Server</span> <span class="attr">version:</span> <span class="number">5.7</span><span class="number">.18</span><span class="bullet">-15</span><span class="bullet">-log</span> <span class="string">PLD/Linux</span> <span class="string">Distribution</span> <span class="string">Percona</span> <span class="string">Server</span> <span class="string">RPM</span></span><br><span class="line"></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2009</span><span class="bullet">-2017</span> <span class="string">Percona</span> <span class="string">LLC</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2000</span><span class="string">,</span> <span class="number">2017</span><span class="string">,</span> <span class="string">Oracle</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates.</span> <span class="string">All</span> <span class="string">rights</span> <span class="string">reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Oracle</span> <span class="string">is</span> <span class="string">a</span> <span class="string">registered</span> <span class="string">trademark</span> <span class="string">of</span> <span class="string">Oracle</span> <span class="string">Corporation</span> <span class="string">and/or</span> <span class="string">its</span></span><br><span class="line"><span class="string">affiliates.</span> <span class="string">Other</span> <span class="string">names</span> <span class="string">may</span> <span class="string">be</span> <span class="string">trademarks</span> <span class="string">of</span> <span class="string">their</span> <span class="string">respective</span></span><br><span class="line"><span class="string">owners.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Type</span> <span class="string">'help;'</span> <span class="string">or</span> <span class="string">'\h'</span> <span class="string">for</span> <span class="string">help.</span> <span class="string">Type</span> <span class="string">'\c'</span> <span class="string">to</span> <span class="string">clear</span> <span class="string">the</span> <span class="string">current</span> <span class="string">input</span> <span class="string">statement.</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:32:19</span> <span class="string">&gt; change master to master_host='172.31.9.182',master_user='slave01',master_password='slave123456',master_auto_position=1;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected, 2 warnings (0.04 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:33:03 &gt; start slave;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:33:47 &gt; show slave status\G;</span></span><br><span class="line"><span class="string">*************************** 1. row ***************************</span></span><br><span class="line"><span class="string"></span><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">slave01</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">mysql-bin.000003</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">810</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">master-relay-bin.000002</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">1023</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">mysql-bin.000003</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">810</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">1231</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="string">a1c1d189-6b96-11e7-9825-02a13635a5ca</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">mysql.slave_master_info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">more</span> <span class="string">updates</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="attr">a1c1d189-6b96-11e7-9825-02a13635a5ca:1-3</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="number">9</span><span class="attr">a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17,</span></span><br><span class="line"><span class="attr">a1c1d189-6b96-11e7-9825-02a13635a5ca:</span><span class="number">1</span><span class="bullet">-3</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </span><br><span class="line"><span class="attr">                 Channel_Name:</span> </span><br><span class="line"><span class="attr">           Master_TLS_Version:</span> </span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ERROR:</span> </span><br><span class="line"><span class="literal">No</span> <span class="string">query</span> <span class="string">specified</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:33:54</span> <span class="string">&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h4><p>登录从库，设置复制关系，来源于主库的复制<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@slave</span> <span class="string">~]#</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-p</span></span><br><span class="line"><span class="string">Enter</span> <span class="attr">password:</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">the</span> <span class="string">MySQL</span> <span class="string">monitor.</span>  <span class="string">Commands</span> <span class="string">end</span> <span class="string">with</span> <span class="string">;</span> <span class="string">or</span> <span class="string">\g.</span></span><br><span class="line"><span class="string">Your</span> <span class="string">MySQL</span> <span class="string">connection</span> <span class="string">id</span> <span class="string">is</span> <span class="number">10</span></span><br><span class="line"><span class="string">Server</span> <span class="attr">version:</span> <span class="number">5.7</span><span class="number">.18</span><span class="bullet">-15</span><span class="bullet">-log</span> <span class="string">PLD/Linux</span> <span class="string">Distribution</span> <span class="string">Percona</span> <span class="string">Server</span> <span class="string">RPM</span></span><br><span class="line"></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2009</span><span class="bullet">-2017</span> <span class="string">Percona</span> <span class="string">LLC</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2000</span><span class="string">,</span> <span class="number">2017</span><span class="string">,</span> <span class="string">Oracle</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates.</span> <span class="string">All</span> <span class="string">rights</span> <span class="string">reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Oracle</span> <span class="string">is</span> <span class="string">a</span> <span class="string">registered</span> <span class="string">trademark</span> <span class="string">of</span> <span class="string">Oracle</span> <span class="string">Corporation</span> <span class="string">and/or</span> <span class="string">its</span></span><br><span class="line"><span class="string">affiliates.</span> <span class="string">Other</span> <span class="string">names</span> <span class="string">may</span> <span class="string">be</span> <span class="string">trademarks</span> <span class="string">of</span> <span class="string">their</span> <span class="string">respective</span></span><br><span class="line"><span class="string">owners.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Type</span> <span class="string">'help;'</span> <span class="string">or</span> <span class="string">'\h'</span> <span class="string">for</span> <span class="string">help.</span> <span class="string">Type</span> <span class="string">'\c'</span> <span class="string">to</span> <span class="string">clear</span> <span class="string">the</span> <span class="string">current</span> <span class="string">input</span> <span class="string">statement.</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:34:41</span> <span class="string">&gt; change master to master_host='172.31.13.126',master_user='slave01',master_password='slave123456',master_auto_position=1;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected, 2 warnings (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:35:14 &gt; start slave;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:35:15 &gt; show slave status\G;</span></span><br><span class="line"><span class="string">*************************** 1. row ***************************</span></span><br><span class="line"><span class="string"></span><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.139</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">slave01</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">4455</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">slave-relay-bin.000002</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">4059</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">4455</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">4266</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="number">9</span><span class="string">a7b78fc-6b96-11e7-9856-0232d9c5deea</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">mysql.slave_master_info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">more</span> <span class="string">updates</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="number">9</span><span class="attr">a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="number">9</span><span class="attr">a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17,</span></span><br><span class="line"><span class="attr">a1c1d189-6b96-11e7-9825-02a13635a5ca:</span><span class="number">1</span><span class="bullet">-3</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </span><br><span class="line"><span class="attr">                 Channel_Name:</span> </span><br><span class="line"><span class="attr">           Master_TLS_Version:</span> </span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ERROR:</span> </span><br><span class="line"><span class="literal">No</span> <span class="string">query</span> <span class="string">specified</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:35:18</span> <span class="string">&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="复制测试"><a href="#复制测试" class="headerlink" title="复制测试"></a>复制测试</h3><h4 id="主库登录测试"><a href="#主库登录测试" class="headerlink" title="主库登录测试"></a>主库登录测试</h4><p>登录主库，插入测试数据<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">37</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">35</span>:<span class="number">48</span> &gt; create database <span class="keyword">if</span> <span class="keyword">not</span> exists test11;use test11;                                                           </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">35</span>:<span class="number">52</span> &gt; create table <span class="keyword">if</span> <span class="keyword">not</span> exists t11(<span class="built_in">id</span> int unsigned <span class="keyword">not</span> null auto_increment,<span class="built_in">name</span> varchar(<span class="number">20</span>),primary key(`<span class="built_in">id</span>`));</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">35</span>:<span class="number">55</span> &gt; insert <span class="keyword">into</span> t11 values(null,'master11');</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">35</span>:<span class="number">58</span> &gt; select * <span class="keyword">from</span> t11;</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>     |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">|  <span class="number">1</span> | master11 |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">36</span>:<span class="number">02</span> &gt;</span><br></pre></td></tr></table></figure></p>
<p>登录从库，查看测试数据，此时数据已经复制过来<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -uroot -p </span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">29</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">36</span>:<span class="number">25</span> &gt; select * <span class="keyword">from</span> test11.t11;</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>     |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">|  <span class="number">1</span> | master11 |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">36</span>:<span class="number">30</span> &gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="从库登录测试"><a href="#从库登录测试" class="headerlink" title="从库登录测试"></a>从库登录测试</h4><p>登录从库，插入测试数据<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -uroot -p </span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">32</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">37</span>:<span class="number">59</span> &gt; create database <span class="keyword">if</span> <span class="keyword">not</span> exists test11;use test11;</span><br><span class="line">Query OK, <span class="number">1</span> row affected, <span class="number">1</span> warning (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">03</span> &gt; create table <span class="keyword">if</span> <span class="keyword">not</span> exists t22(<span class="built_in">id</span> int unsigned <span class="keyword">not</span> null auto_increment,<span class="built_in">name</span> varchar(<span class="number">20</span>),primary key(`<span class="built_in">id</span>`));     </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">18</span> &gt; insert <span class="keyword">into</span> t22 values(null,'slave11'); </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">30</span> &gt; select * <span class="keyword">from</span> t22;</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>    |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">|  <span class="number">2</span> | slave11 |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">35</span> &gt;</span><br></pre></td></tr></table></figure></p>
<p>登录主库，查看测试数据，此时数据已经复制过来<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">38</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">39</span>:<span class="number">09</span> &gt; select * <span class="keyword">from</span> test11.t22;</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>    |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">|  <span class="number">2</span> | slave11 |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">39</span>:<span class="number">15</span> &gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="MHA帐号建立"><a href="#MHA帐号建立" class="headerlink" title="MHA帐号建立"></a>MHA帐号建立</h3><h4 id="主库创建-1"><a href="#主库创建-1" class="headerlink" title="主库创建"></a>主库创建</h4><p>登录主库，创建允许主库和从库连接的MHA用户信息，再分别尝试使用MHA用户登录(省略)<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">41</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">36</span>:<span class="number">55</span> &gt; <span class="keyword">create</span> user <span class="string">'mha01'</span>@<span class="string">'172.31.9.182'</span> identified <span class="keyword">by</span> <span class="string">'mha123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">37</span>:<span class="number">14</span> &gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha01'</span>@<span class="string">'172.31.9.182'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">38</span>:<span class="number">02</span> &gt; <span class="keyword">create</span> user <span class="string">'mha01'</span>@<span class="string">'172.31.13.126'</span> identified <span class="keyword">by</span> <span class="string">'mha123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">38</span>:<span class="number">14</span> &gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha01'</span>@<span class="string">'172.31.13.126'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">38</span>:<span class="number">18</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="从库创建-1"><a href="#从库创建-1" class="headerlink" title="从库创建"></a>从库创建</h4><p>登录从库，由于复制已经把在主库创建的MHA用户信息复制了过来，尝试登录即可(省略)</p>
<h2 id="MHA安装"><a href="#MHA安装" class="headerlink" title="MHA安装"></a>MHA安装</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>分别在主库和从库上安装，执行命令：<br>yum -y install gcc gcc-c++ make openssl-devel perl perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Config-IniFiles perl-Time-HiRes perl-Module-Install.noarch mailx jwhois</p>
<h3 id="主库安装mha4mysql-node"><a href="#主库安装mha4mysql-node" class="headerlink" title="主库安装mha4mysql-node"></a>主库安装mha4mysql-node</h3><p>MHA管理端安装在从库上，主库上只需要mha4mysql-node即可，由于MySQL使用5.7版本，MHA也使用最新的0.57版本，采用编译安装方式。下载地址：<a href="https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw" target="_blank" rel="noopener">https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw</a><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cd</span> /usr/src/</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">src</span>]<span class="comment"># tar -zxf mha4mysql-node-0.57.tar.gz</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># perl Makefile.PL             #编译过程省略</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># make</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># make install</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># ll /usr/local/bin/ -t        #查看安装，有以下文件则mha4mysql-node安装成功</span></span><br><span class="line">total <span class="number">1760</span></span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root  <span class="number">16381</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">8261</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> purge_relay_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">7525</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> save_binary_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">4807</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p>
<h3 id="从库安装mha4mysql-manager和mha4mysql-node"><a href="#从库安装mha4mysql-manager和mha4mysql-node" class="headerlink" title="从库安装mha4mysql-manager和mha4mysql-node"></a>从库安装mha4mysql-manager和mha4mysql-node</h3><p>MHA管理端安装在从库，从库需要安装manager端和node端<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># cd /usr/src/</span></span><br><span class="line">[root@slave src]<span class="comment"># tar -zxf mha4mysql-manager-0.57.tar.gz </span></span><br><span class="line">[root@slave src]<span class="comment"># cd mha4mysql-manager-0.57</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># perl Makefile.PL           #编译过程省略</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># make</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># make install </span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># ll /usr/local/bin/ -t      #查看安装，有以下文件则mha4mysql-manager安装成功</span></span><br><span class="line">total 1756</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1779 </span>Jul<span class="number"> 21 </span>09:48 masterha_check_ssh</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 2517 </span>Jul<span class="number"> 21 </span>09:48 masterha_manager</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 2373 </span>Jul<span class="number"> 21 </span>09:48 masterha_master_switch</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 5171 </span>Jul<span class="number"> 21 </span>09:48 masterha_secondary_check</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1995 </span>Jul<span class="number"> 21 </span>09:48 masterha_check_repl</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1865 </span>Jul<span class="number"> 21 </span>09:48 masterha_check_status</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 3201 </span>Jul<span class="number"> 21 </span>09:48 masterha_conf_host</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 2165 </span>Jul<span class="number"> 21 </span>09:48 masterha_master_monitor</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1739 </span>Jul<span class="number"> 21 </span>09:48 masterha_stop</span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># cd ..</span></span><br><span class="line">[root@slave src]<span class="comment"># tar -zxf mha4mysql-node-0.57.tar.gz </span></span><br><span class="line">[root@slave src]<span class="comment"># cd mha4mysql-node-0.57</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># perl Makefile.PL              #编译过程省略        </span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># make</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># make install</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># ll /usr/local/bin/ -t         #查看安装，有以下文件则mha4mysql-node安装成功</span></span><br><span class="line">total 1800</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root <span class="number"> 16381 </span>Jul<span class="number"> 21 </span>09:54 apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 8261 </span>Jul<span class="number"> 21 </span>09:54 purge_relay_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 7525 </span>Jul<span class="number"> 21 </span>09:54 save_binary_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 4807 </span>Jul<span class="number"> 21 </span>09:54 filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p>
<h2 id="MHA目录结构说明"><a href="#MHA目录结构说明" class="headerlink" title="MHA目录结构说明"></a>MHA目录结构说明</h2><h3 id="MHAManager"><a href="#MHAManager" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>mhamanager工具包主要包括以下工具<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@slave  ~]<span class="comment"># ll /usr/local/bin/</span></span><br><span class="line">总用量 84</span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1995 </span>7月 <span class="number"> 19 </span>11:49 masterha_check_repl         <span class="comment">#检查MySQL复制情况</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1779 </span>7月 <span class="number"> 19 </span>11:49 masterha_check_ssh          <span class="comment">#检查MHA的SSH配置情况</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1865 </span>7月 <span class="number"> 19 </span>11:49 masterha_check_status       <span class="comment">#检测当前MHA运行状态</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 3201 </span>7月 <span class="number"> 19 </span>11:49 masterha_conf_host          <span class="comment">#添加或删除配置的server信息</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2517 </span>7月 <span class="number"> 19 </span>11:49 masterha_manager            <span class="comment">#启动MHA</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2165 </span>7月 <span class="number"> 19 </span>11:49 masterha_master_monitor     <span class="comment">#检测Master是否宕机</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2373 </span>7月 <span class="number"> 19 </span>11:49 masterha_master_switch      <span class="comment">#控制故障转移，自动或者手动</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 5172 </span>7月 <span class="number"> 19 </span>11:49 masterha_secondary_check    <span class="comment">#通过其他路由检测Master是否真的宕机</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1739 </span>7月 <span class="number"> 19 </span>11:49 masterha_stop               <span class="comment">#停止MHA</span></span><br></pre></td></tr></table></figure></p>
<h3 id="MHANode"><a href="#MHANode" class="headerlink" title="MHANode"></a>MHANode</h3><p>mhanode工具包主要包括以下工具<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master  ~]<span class="comment"># ll /usr/local/bin/</span></span><br><span class="line">总用量 44</span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root<span class="number"> 16371 </span>7月 <span class="number"> 19 </span>11:41 apply_diff_relay_logs       <span class="comment">#识别差异日志的中继日志，并将其差异事件应用于其他Slave</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 4807 </span>7月 <span class="number"> 19 </span>11:41 filter_mysqlbinlog          <span class="comment">#去除不必要的Rollback事件</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 8263 </span>7月 <span class="number"> 19 </span>11:41 purge_relay_logs            <span class="comment">#删除无用的Relay log，避免延时</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 7525 </span>7月 <span class="number"> 19 </span>11:41 save_binary_logs            <span class="comment">#保存和复制down掉的主服务器二进制日志</span></span><br></pre></td></tr></table></figure></p>
<h3 id="自定义扩展脚本说明"><a href="#自定义扩展脚本说明" class="headerlink" title="自定义扩展脚本说明"></a>自定义扩展脚本说明</h3><p>secondary_check_script          #通过多条网络路由检测master的可用性<br>master_ip_failover_script       #自动failover时候的切换脚本，可将vip信息写入此脚本中<br>shutdown_script                 #强制关闭master节点执行脚本<br>report_script                   #发送报告<br>init_conf_load_script           #加载初始配置参数，如不想在配置中写明文密码<br>master_ip_online_change_script  #手动failover时候的切换脚本  </p>
<h2 id="MHA扩展脚本"><a href="#MHA扩展脚本" class="headerlink" title="MHA扩展脚本"></a>MHA扩展脚本</h2><p>由于使用的AWS EC2，不支持VIP，可通过辅助IP的形式实现，这里使用脚本来辅助实现HA。</p>
<h3 id="aws-vip-change-sh"><a href="#aws-vip-change-sh" class="headerlink" title="aws_vip_change.sh"></a>aws_vip_change.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/aws_vip_change.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -lt 2 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Illegal param count.count = <span class="variable">$#</span>"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># High Availability IP variables</span></span><br><span class="line"><span class="comment"># Other node's IP to ping and VIP to swap if other node goes down</span></span><br><span class="line">VIP_ENI_ID=eni-7a5c7722</span><br><span class="line"></span><br><span class="line">NEW_MASTER_IP=<span class="variable">$1</span></span><br><span class="line">OLD_MASTER_IP=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"NEW_MASTER_IP=<span class="variable">$&#123;NEW_MASTER_IP&#125;</span>,OLD_MASTER_IP=<span class="variable">$&#123;OLD_MASTER_IP&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify the EC2 region that this will be running in   #以下为当前用户能够执行aws cli命令的key信息</span></span><br><span class="line">REGION=cn-north-1</span><br><span class="line">AWSAccessKeyId=AKIAPUXGZV6F6EKCOK7Q</span><br><span class="line">AWSSecretKey=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       </span><br><span class="line"></span><br><span class="line"><span class="comment"># Run aws-apitools-common.sh to set up default environment variables and to</span></span><br><span class="line"><span class="comment"># leverage AWS security credentials provided by EC2 roles</span></span><br><span class="line">. /etc/profile.d/aws-apitools-common.sh</span><br><span class="line"></span><br><span class="line">ACCESS_USER_OPTION=<span class="string">"--aws-access-key <span class="variable">$&#123;AWSAccessKeyId&#125;</span> --aws-secret-key <span class="variable">$&#123;AWSSecretKey&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">ssh -t -t root@<span class="variable">$&#123;OLD_MASTER_IP&#125;</span> /sbin/ifconfig eth4 down    <span class="comment">#其中eth4网卡名要与下文中，新申请ENI并绑定实例ID对应的网卡名相同</span></span><br><span class="line"></span><br><span class="line">VIP_ATTACHMENT_ID=`ec2-describe-network-interface-attribute <span class="variable">$&#123;VIP_ENI_ID&#125;</span> <span class="variable">$&#123;ACCESS_USER_OPTION&#125;</span> --region <span class="variable">$&#123;REGION&#125;</span> -a | grep ATTACHMENT -m 1 | awk <span class="string">'&#123;print $3;&#125;'</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"VIP_ATTACHMENT_ID=<span class="variable">$&#123;VIP_ATTACHMENT_ID&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">/opt/aws/bin/ec2-detach-network-interface <span class="variable">$&#123;VIP_ATTACHMENT_ID&#125;</span> <span class="variable">$&#123;ACCESS_USER_OPTION&#125;</span> --force --region <span class="variable">$&#123;REGION&#125;</span></span><br><span class="line">sleep 10</span><br><span class="line"></span><br><span class="line">INSTANCE_ID=`ssh root@<span class="variable">$&#123;NEW_MASTER_IP&#125;</span> /usr/bin/curl --silent http://169.254.169.254/latest/meta-data/instance-id`  <span class="comment">#其中169.254.169.254从本地链路中获取实例ID</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"INSTANCE_ID=<span class="variable">$&#123;INSTANCE_ID&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">/opt/aws/bin/ec2-attach-network-interface <span class="variable">$&#123;VIP_ENI_ID&#125;</span> -i <span class="variable">$&#123;INSTANCE_ID&#125;</span> -d 1 <span class="variable">$&#123;ACCESS_USER_OPTION&#125;</span> --region <span class="variable">$&#123;REGION&#125;</span></span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="master-ip-failover"><a href="#master-ip-failover" class="headerlink" title="master_ip_failover"></a>master_ip_failover</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/master_ip_failover </span></span><br><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">#  it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">#  GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment">#   along with this program; if not, write to the Free Software</span></span><br><span class="line"><span class="comment">#  Foundation, Inc.,</span></span><br><span class="line"><span class="comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## <span class="doctag">Note:</span> This is a sample script and is not complete. Modify the script based on your environment.</span></span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line">use Getopt::Long;</span><br><span class="line">use MHA::DBHelper;</span><br><span class="line"></span><br><span class="line">my (</span><br><span class="line">  <span class="variable">$command</span>,        <span class="variable">$ssh_user</span>,         <span class="variable">$orig_master_host</span>,</span><br><span class="line">  <span class="variable">$orig_master_ip</span>, <span class="variable">$orig_master_port</span>, <span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="variable">$new_master_ip</span>,  <span class="variable">$new_master_port</span>,  <span class="variable">$new_master_user</span>,</span><br><span class="line">  <span class="variable">$new_master_password</span></span><br><span class="line">);</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'command=s'</span>             =&gt; \<span class="variable">$command</span>,</span><br><span class="line">  <span class="string">'ssh_user=s'</span>            =&gt; \<span class="variable">$ssh_user</span>,</span><br><span class="line">  <span class="string">'orig_master_host=s'</span>    =&gt; \<span class="variable">$orig_master_host</span>,</span><br><span class="line">  <span class="string">'orig_master_ip=s'</span>      =&gt; \<span class="variable">$orig_master_ip</span>,</span><br><span class="line">  <span class="string">'orig_master_port=i'</span>    =&gt; \<span class="variable">$orig_master_port</span>,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>     =&gt; \<span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="string">'new_master_ip=s'</span>       =&gt; \<span class="variable">$new_master_ip</span>,</span><br><span class="line">  <span class="string">'new_master_port=i'</span>     =&gt; \<span class="variable">$new_master_port</span>,</span><br><span class="line">  <span class="string">'new_master_user=s'</span>     =&gt; \<span class="variable">$new_master_user</span>,</span><br><span class="line">  <span class="string">'new_master_password=s'</span> =&gt; \<span class="variable">$new_master_password</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line">sub main &#123;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="variable">$command</span> eq <span class="string">"stop"</span> || <span class="variable">$command</span> eq <span class="string">"stopssh"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># $orig_master_host, $orig_master_ip, $orig_master_port are passed.</span></span><br><span class="line">    <span class="comment"># If you manage master ip address at global catalog database,</span></span><br><span class="line">    <span class="comment"># invalidate orig_master_ip here.</span></span><br><span class="line">    my <span class="variable">$exit_code</span> = <span class="number">1</span>;</span><br><span class="line">    eval &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment"># updating global catalog, etc</span></span><br><span class="line">      <span class="variable">$exit_code</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">      warn <span class="string">"Got Error: $@\n"</span>;</span><br><span class="line">      <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  elsif ( <span class="variable">$command</span> eq <span class="string">"start"</span> ) &#123;</span><br><span class="line">    my <span class="variable">$exit_code</span> = <span class="number">10</span>;</span><br><span class="line">    my @vip_change_cmd = (<span class="string">"/usr/local/bin/aws_vip_change.sh"</span>,<span class="variable">$new_master_host</span>,<span class="variable">$orig_master_host</span>);</span><br><span class="line">    system @vip_change_cmd;</span><br><span class="line">    <span class="variable">$exit_code</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">      warn <span class="variable">$@</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment"># If you want to continue failover, exit 10.</span></span><br><span class="line">      <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  elsif ( <span class="variable">$command</span> eq <span class="string">"status"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># do nothing</span></span><br><span class="line">    <span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    &amp;usage();</span><br><span class="line">    <span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub usage &#123;</span><br><span class="line">  print</span><br><span class="line"><span class="string">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="send-report"><a href="#send-report" class="headerlink" title="send_report"></a>send_report</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/send_report </span></span><br><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">strict</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">warnings</span> <span class="title">FATAL</span> =&gt; '<span class="title">all</span>';</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mail</span>::<span class="title">Sender</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Getopt</span>::<span class="title">Long</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span></span><br><span class="line">my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );</span><br><span class="line">my $smtp=<span class="string">'smtp.126.com'</span>;</span><br><span class="line">my $mail_from=<span class="string">'xxx@126.com'</span>;</span><br><span class="line">my $mail_user=<span class="string">'xxx@126.com'</span>;</span><br><span class="line">my $mail_pass=<span class="string">'xxx'</span>;</span><br><span class="line"><span class="comment">#my $mail_to=['xxx','xxx'];</span></span><br><span class="line">my $mail_to=<span class="string">'xxx'</span>;</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'orig_master_host=s'</span> =&gt; \$dead_master_host,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span><br><span class="line">  <span class="string">'new_slave_hosts=s'</span>  =&gt; \$new_slave_hosts,</span><br><span class="line">  <span class="string">'subject=s'</span>          =&gt; \$subject,</span><br><span class="line">  <span class="string">'body=s'</span>             =&gt; \$body,</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);</span><br><span class="line"> </span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_;</span><br><span class="line">    open my $DEBUG, <span class="string">"&gt; /var/log/masterha/app1/manager.log"</span></span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Can't open the debug      file:$!\n"</span>;</span><br><span class="line">    my $sender = <span class="keyword">new</span> Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; <span class="string">'text/plain; charset=utf-8'</span>,</span><br><span class="line">        encoding    =&gt; <span class="string">'utf-8'</span>,</span><br><span class="line">        smtp        =&gt; $smtp,</span><br><span class="line">        from        =&gt; $mail_from,</span><br><span class="line">        auth        =&gt; <span class="string">'LOGIN'</span>,</span><br><span class="line">        TLS_allowed =&gt; <span class="string">'0'</span>,</span><br><span class="line">        authid      =&gt; $user,</span><br><span class="line">        authpwd     =&gt; $passwd,</span><br><span class="line">        to          =&gt; $mail_to,</span><br><span class="line">        subject     =&gt; $subject,</span><br><span class="line">        debug       =&gt; $DEBUG</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    $sender-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; $msg,</span><br><span class="line">            debug =&gt; $DEBUG</span><br><span class="line">        &#125;</span><br><span class="line">    ) <span class="keyword">or</span> <span class="keyword">print</span> $Mail::Sender::Error;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Do whatever you want here</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">exit</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<h2 id="主库手动绑定ENI和实例关系"><a href="#主库手动绑定ENI和实例关系" class="headerlink" title="主库手动绑定ENI和实例关系"></a>主库手动绑定ENI和实例关系</h2><p>在主库上先申请新的ENI，注意申请时先绑定的group，以满足其他EC2能够连接些ENI。<br>申请成功后，根据新的ENI和当前主实例的实例ID绑定，最终确认新的VIP是否绑定上。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">ifconfig</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:E6:0B:68:5C:1C</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.13.126</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::e6:bff:fe68:5c1c/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:4063</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:3292</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:691839</span> <span class="string">(675.6</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:390499</span> <span class="string">(381.3</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="string">::1/128</span> <span class="attr">Scope:Host</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">aws</span> <span class="string">ec2</span> <span class="string">create-network-interface</span> <span class="bullet">--subnet-id</span> <span class="string">subnet-33859151</span> <span class="bullet">--private-ip-address</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.200</span> <span class="bullet">--groups</span> <span class="string">sg-e50a1c87</span> <span class="string">sg-6b1f0809</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "NetworkInterface":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">        "Status":</span> <span class="string">"pending"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "MacAddress":</span> <span class="string">"02:12:25:83:a0:22"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "SourceDestCheck":</span> <span class="literal">true</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "VpcId":</span> <span class="string">"vpc-b18195d3"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "Description":</span> <span class="string">""</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "NetworkInterfaceId":</span> <span class="string">"eni-7a5c7722"</span><span class="string">,</span>   <span class="comment">#新申请的ENI名字</span></span><br><span class="line"><span class="attr">        "PrivateIpAddresses":</span> <span class="string">[</span></span><br><span class="line">            <span class="string">&#123;</span></span><br><span class="line"><span class="attr">                "PrivateDnsName":</span> <span class="string">"ip-172-31-0-200.cn-north-1.compute.internal"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "Primary":</span> <span class="literal">true</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "PrivateIpAddress":</span> <span class="string">"172.31.0.200"</span>  <span class="comment">#新ENI绑定的私有IP</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">],</span> </span><br><span class="line"><span class="attr">        "RequesterManaged":</span> <span class="literal">false</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "Groups":</span> <span class="string">[</span></span><br><span class="line">            <span class="string">&#123;</span></span><br><span class="line"><span class="attr">                "GroupName":</span> <span class="string">"For Mysql"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "GroupId":</span> <span class="string">"sg-e50a1c87"</span></span><br><span class="line">            <span class="string">&#125;,</span> </span><br><span class="line">            <span class="string">&#123;</span></span><br><span class="line"><span class="attr">                "GroupName":</span> <span class="string">"OnlySSH-Allow"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "GroupId":</span> <span class="string">"sg-6b1f0809"</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">],</span> </span><br><span class="line"><span class="attr">        "PrivateDnsName":</span> <span class="string">"ip-172-31-0-200.cn-north-1.compute.internal"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "AvailabilityZone":</span> <span class="string">"cn-north-1a"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "RequesterId":</span> <span class="string">"AIDAPVDKK6NLF6SZ553KS"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "SubnetId":</span> <span class="string">"subnet-33859151"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "OwnerId":</span> <span class="string">"981100955930"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "TagSet":</span> <span class="string">[],</span> </span><br><span class="line"><span class="attr">        "PrivateIpAddress":</span> <span class="string">"172.31.0.200"</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">aws</span> <span class="string">ec2</span> <span class="string">attach-network-interface</span> <span class="bullet">--network-interface-id</span> <span class="string">eni-7a5c7722</span> <span class="bullet">--instance-id</span> <span class="string">i-0a259e4950b0b3cf9</span> <span class="bullet">--device-index</span> <span class="number">1</span>    <span class="comment">#将ENI和实例绑定</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "AttachmentId":</span> <span class="string">"eni-attach-2b2c9345"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">ifconfig</span>   <span class="comment">#查看ip：172.31.0.200已绑定成功，同时要在其他EC2确定此安全组是否能够满足需求，否则还需要重新调整。</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:E6:0B:68:5C:1C</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.13.126</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::e6:bff:fe68:5c1c/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:5435</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:4190</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:810999</span> <span class="string">(791.9</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:501986</span> <span class="string">(490.2</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">eth4</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:12:25:83:A0:22</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.0.200</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::12:25ff:fe83:a022/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:11</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:26</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:1218</span> <span class="string">(1.1</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:2664</span> <span class="string">(2.6</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="string">::1/128</span> <span class="attr">Scope:Host</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span></span><br></pre></td></tr></table></figure></p>
<h2 id="从库配置MHAManager"><a href="#从库配置MHAManager" class="headerlink" title="从库配置MHAManager"></a>从库配置MHAManager</h2><p>创建配置目录/etc/masterha/，同时创建一个项目上的配置文件，仅配置自动FailOver部分，只需要master_ip_failover和report_script脚本，其他脚本暂时不定义。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mkdir -p /etc/masterha/</span></span><br><span class="line">[root@slave ~]<span class="comment"># cd /etc/masterha/</span></span><br><span class="line">[root@slave masterha]<span class="comment"># </span></span><br><span class="line">[root@slave masterha]<span class="comment"># cat app1.cnf </span></span><br><span class="line">[server default]</span><br><span class="line">manager_workdir=/var/log/masterha/app1                              <span class="comment">#manager工作目录</span></span><br><span class="line">manager_log=/var/log/masterha/app1/manager.log                      <span class="comment">#manager日志</span></span><br><span class="line">master_binlog_dir=/hwdata/data/percona                              <span class="comment">#mysql数据目录</span></span><br><span class="line">password=mha123456                                                  <span class="comment">#mha连接密码</span></span><br><span class="line">user=mha01                                                          <span class="comment">#mha连接用户</span></span><br><span class="line">ping_interval=1                                                     <span class="comment">#监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行failover</span></span><br><span class="line">remote_workdir=/tmp                                                 <span class="comment">#远端mysql在发生切换时binlog的保存位置</span></span><br><span class="line">repl_password=slave123456                                           <span class="comment">#复制密码</span></span><br><span class="line">repl_user=slave01                                                   <span class="comment">#复制用户</span></span><br><span class="line">ssh_user=root                                                       <span class="comment">#ssh用户</span></span><br><span class="line">master_ip_failover_script=/usr/local/bin/master_ip_failover         <span class="comment">#自动failover切换脚本</span></span><br><span class="line"><span class="comment">#master_ip_online_change_script= /usr/local/bin/master_ip_online_change      #手动failover切换脚本</span></span><br><span class="line">report_script=/usr/local/bin/send_report                            <span class="comment">#报告发送脚本(不是必须)</span></span><br><span class="line"><span class="comment">#shutdown_script=                                                   #故障发生后关闭主机的脚本(不是必须)</span></span><br><span class="line">secondary_check_script = masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306 <span class="comment">#通过第三方机器确认目标主库是否存活，这里的ip可换成其他机器，用于检测</span></span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname=172.31.13.126                                              <span class="comment">#主库地址</span></span><br><span class="line">port=3306</span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">hostname=172.31.9.182                                               <span class="comment">#从库地址</span></span><br><span class="line">port=3306</span><br><span class="line">candidate_master=1                                                  <span class="comment">#候选master</span></span><br></pre></td></tr></table></figure></p>
<h2 id="测试MHAManager-SSH"><a href="#测试MHAManager-SSH" class="headerlink" title="测试MHAManager SSH"></a>测试MHAManager SSH</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_ssh <span class="attribute">--conf</span>=/etc/masterha/app1.cnf </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">info</span>] Starting SSH<span class="built_in"> connection </span>tests<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@172.31.13.126(172.31.13.126:22) <span class="keyword">to</span> root@172.31.9.182(172.31.9.182:22)<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Mon Jul 24 13:58:05 2017 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@172.31.9.182(172.31.9.182:22) <span class="keyword">to</span> root@172.31.13.126(172.31.13.126:22)<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Mon Jul 24 13:58:05 2017 - [<span class="builtin-name">info</span>] All SSH<span class="built_in"> connection </span>tests passed successfully.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h2 id="测试MHAManager-复制"><a href="#测试MHAManager-复制" class="headerlink" title="测试MHAManager 复制"></a>测试MHAManager 复制</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_repl <span class="attribute">--conf</span>=/etc/masterha/app1.cnf </span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">info</span>] MHA::MasterMonitor version 0.57.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Master configurations are as below: </span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating <span class="keyword">from</span> 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating <span class="keyword">from</span> 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] GTID failover mode = 1</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Dead Servers:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Alive Servers:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Alive Slaves:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   172.31.9.182(172.31.9.182:3306)  <span class="attribute">Version</span>=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]     GTID ON</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Current Alive Master: 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking slave configurations<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking replication filtering settings<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  Replication filtering check ok.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] GTID (with auto-pos) is supported. Skipping all SSH <span class="keyword">and</span> Node package checking.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking SSH publickey authentication<span class="built_in"> settings </span>on the current master<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] HealthCheck: SSH <span class="keyword">to</span> 172.31.13.126 is reachable.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking replication<span class="built_in"> health </span>on 172.31.9.182<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   /usr/local/bin/master_ip_failover <span class="attribute">--command</span>=status <span class="attribute">--ssh_user</span>=root <span class="attribute">--orig_master_host</span>=172.31.13.126 <span class="attribute">--orig_master_ip</span>=172.31.13.126 <span class="attribute">--orig_master_port</span>=3306 </span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  OK.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">warning</span>] shutdown_script is <span class="keyword">not</span> defined.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Got exit code 0 (<span class="keyword">Not</span> master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication<span class="built_in"> Health </span>is OK.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h2 id="启动MHAManager"><a href="#启动MHAManager" class="headerlink" title="启动MHAManager"></a>启动MHAManager</h2><h3 id="启动进程"><a href="#启动进程" class="headerlink" title="启动进程"></a>启动进程</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta"># nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;</span></span><br><span class="line">[<span class="meta">1</span>] <span class="number">4439</span></span><br><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta"># nohup: ignoring input and appending output to ‘nohup.out’</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta">#</span></span><br></pre></td></tr></table></figure>
<h3 id="查看启动日志"><a href="#查看启动日志" class="headerlink" title="查看启动日志"></a>查看启动日志</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># cat /var/log/masterha/app1/manager.log </span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:10<span class="number"> 2017 </span>- [info] MHA::MasterMonitor version 0.57.  <span class="comment">#检查版本</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306) <span class="comment">#获取当前主节点ip</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Master configurations are as below:   <span class="comment">#获取复制结构</span></span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating from 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating from 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] GTID failover mode =<span class="number"> 1 </span>   <span class="comment">#GTID模式</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Alive Servers:            <span class="comment">#当前在线实例列表</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Alive Slaves:             <span class="comment">#当前在线slave列表及版本信息</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Current Alive Master: 172.31.13.126(172.31.13.126:3306)   <span class="comment">#当前主实例信息</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking slave configurations..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]  binlog_do_db= , binlog_ignore_db=                        <span class="comment">#复制过滤</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] HealthCheck: SSH to 172.31.13.126 is reachable.           <span class="comment">#ssh可用</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)                                          <span class="comment">#再次确认当前复制架构</span></span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 </span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]  OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [warning] shutdown_script is not defined.                        <span class="comment">#shutdown_script脚本未定义    </span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Set master ping interval<span class="number"> 1 </span>seconds.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Set secondary check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306                                                <span class="comment">#第三方检查登录</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Starting ping health check on 172.31.13.126(172.31.13.126:3306)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Ping(SELECT) succeeded, waiting until MySQL doesn't respond.. <span class="comment">#启动成功，等待failover</span></span><br><span class="line">[root@slave masterha]<span class="comment"># ps aux|grep master</span></span><br><span class="line">root     <span class="number"> 4439 </span> 0.0  0.2<span class="number"> 287004 </span>23636 pts/0    S    14:04   0:00 perl /usr/local/bin/masterha_manager --conf=/etc/masterha/app1.cnf <span class="comment">#进程存在</span></span><br><span class="line">root     <span class="number"> 5008 </span> 0.0  0.0<span class="number"> 110456 </span><span class="number"> 2092 </span>pts/0    S+   14:13   0:00 grep --color=auto master</span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="模拟主库故障"><a href="#模拟主库故障" class="headerlink" title="模拟主库故障"></a>模拟主库故障</h2><h3 id="确认当前VIP状态"><a href="#确认当前VIP状态" class="headerlink" title="确认当前VIP状态"></a>确认当前VIP状态</h3><p>在主库上执行停止服务，观察MHAManager日志，并确认VIP是否切换到从库上<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>       #确认当前<span class="selector-tag">VIP</span>：<span class="selector-tag">172</span><span class="selector-class">.31</span><span class="selector-class">.0</span><span class="selector-class">.200</span>在主库上</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:E6</span><span class="selector-pseudo">:0B</span><span class="selector-pseudo">:68</span><span class="selector-pseudo">:5C</span><span class="selector-pseudo">:1C</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.13.126</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::e6</span><span class="selector-pseudo">:bff</span><span class="selector-pseudo">:fe68</span><span class="selector-pseudo">:5c1c</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:9629</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8119</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1202679</span> (<span class="number">1.1</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1113439</span> (<span class="number">1.0</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth4</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:25</span><span class="selector-pseudo">:83</span><span class="selector-pseudo">:A0</span><span class="selector-pseudo">:22</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.0.200</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::12</span><span class="selector-pseudo">:25ff</span><span class="selector-pseudo">:fe83</span><span class="selector-pseudo">:a022</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:4</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:4</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:562</span> (<span class="number">562.0</span> b)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:600</span> (<span class="number">600.0</span> b)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-pseudo">::1</span>/<span class="selector-tag">128</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Host</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:90</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:90</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17324</span> (<span class="number">16.9</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17324</span> (<span class="number">16.9</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure></p>
<h3 id="确认MHAManger进程状态"><a href="#确认MHAManger进程状态" class="headerlink" title="确认MHAManger进程状态"></a>确认MHAManger进程状态</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@slave</span> <span class="string">masterha]#</span> <span class="string">ps</span> <span class="string">aux|grep</span> <span class="string">master</span></span><br><span class="line"><span class="string">root</span>     <span class="number">11333</span>  <span class="number">0.4</span>  <span class="number">0.2</span> <span class="number">287004</span> <span class="number">23604</span> <span class="string">pts/0</span>    <span class="string">S</span>    <span class="number">15</span><span class="string">:36</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">perl</span> <span class="string">/usr/local/bin/masterha_manager</span> <span class="bullet">--conf=/etc/masterha/app1.cnf</span></span><br><span class="line"><span class="string">root</span>     <span class="number">11377</span>  <span class="number">0.0</span>  <span class="number">0.0</span> <span class="number">110456</span>  <span class="number">2252</span> <span class="string">pts/0</span>    <span class="string">S+</span>   <span class="number">15</span><span class="string">:37</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">grep</span> <span class="bullet">--color=auto</span> <span class="string">master</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">masterha]#</span> <span class="string">cd</span> <span class="string">/var/log/masterha/app1/</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">ll</span></span><br><span class="line"><span class="string">total</span> <span class="number">8</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>   <span class="number">36</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:37</span> <span class="string">app1.master_status.health</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">2833</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:36</span> <span class="string">manager.log</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">cat</span> <span class="string">manager.log</span> <span class="string">|tail</span> <span class="bullet">-2</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:36:54</span> <span class="number">2017</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Starting</span> <span class="string">ping</span> <span class="string">health</span> <span class="string">check</span> <span class="string">on</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:36:54</span> <span class="number">2017</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Ping(SELECT)</span> <span class="string">succeeded,</span> <span class="string">waiting</span> <span class="string">until</span> <span class="string">MySQL</span> <span class="string">doesn't</span> <span class="string">respond..</span>     <span class="comment">#正在等待主库FailOver</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">ifconfig</span>     <span class="comment">#当前从库没有存在VIP：172.31.0.200</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:0E:FB:F1:E9:4E</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.9.182</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::e:fbff:fef1:e94e/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:16565</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:17269</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:2084631</span> <span class="string">(1.9</span> <span class="string">MiB)</span>  <span class="string">TX</span> <span class="attr">bytes:2304176</span> <span class="string">(2.1</span> <span class="string">MiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="string">::1/128</span> <span class="attr">Scope:Host</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:2556</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:2556</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:605471</span> <span class="string">(591.2</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:605471</span> <span class="string">(591.2</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span></span><br></pre></td></tr></table></figure>
<h3 id="停止主库服务，触发主库FailOver"><a href="#停止主库服务，触发主库FailOver" class="headerlink" title="停止主库服务，触发主库FailOver"></a>停止主库服务，触发主库FailOver</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">mysqld</span> <span class="selector-tag">stop</span>                    #服务停止</span><br><span class="line"><span class="selector-tag">Shutting</span> <span class="selector-tag">down</span> <span class="selector-tag">MySQL</span> (Percona Server)............ <span class="selector-tag">SUCCESS</span>! </span><br><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>                                   <span class="selector-id">#VIP</span>已经不存在</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:E6</span><span class="selector-pseudo">:0B</span><span class="selector-pseudo">:68</span><span class="selector-pseudo">:5C</span><span class="selector-pseudo">:1C</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.13.126</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::e6</span><span class="selector-pseudo">:bff</span><span class="selector-pseudo">:fe68</span><span class="selector-pseudo">:5c1c</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:10242</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8535</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1256340</span> (<span class="number">1.1</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1175340</span> (<span class="number">1.1</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-pseudo">::1</span>/<span class="selector-tag">128</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Host</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:92</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:92</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17424</span> (<span class="number">17.0</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17424</span> (<span class="number">17.0</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure>
<h3 id="观察FailOver日志"><a href="#观察FailOver日志" class="headerlink" title="观察FailOver日志"></a>观察FailOver日志</h3><p>登录从库，查看MHAManager日志<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]<span class="comment"># cat manager.log </span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:52<span class="number"> 2017 </span>- [info] MHA::MasterMonitor version 0.57.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Master configurations are as below: </span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating from 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating from 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] GTID failover mode = 1</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Alive Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Alive Slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Current Alive Master: 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking slave configurations..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] HealthCheck: SSH to 172.31.13.126 is reachable.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]  OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [warning] shutdown_script is not defined.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Set master ping interval<span class="number"> 1 </span>seconds.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Set secondary check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Starting ping health check on 172.31.13.126(172.31.13.126:3306)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Ping(SELECT) succeeded, waiting until MySQL doesn't respond..         <span class="comment">#等待主库FailOver</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [warning] Got error on MySQL select ping:<span class="number"> 2006 </span>(MySQL server has gone away)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] Executing secondary network check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306  --user=root  --master_host=172.31.13.126  --master_ip=172.31.13.126  --master_port=3306 --master_user=mha01 --master_password=mha123456 --ping_type=SELECT</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] Executing SSH check script: exit 0</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] HealthCheck: SSH to 172.31.13.126 is reachable.</span><br><span class="line">Monitoring server 172.31.13.126 is reachable, Master is not reachable from 172.31.13.126. OK.</span><br><span class="line">Monitoring server 172.31.9.182 is reachable, Master is not reachable from 172.31.9.182. OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] Master is not reachable from all other monitoring servers. Failover should start.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:02<span class="number"> 2017 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '172.31.13.126' (111))</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:02<span class="number"> 2017 </span>- [warning] Connection failed<span class="number"> 2 </span>time(s)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:03<span class="number"> 2017 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '172.31.13.126' (111))</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:03<span class="number"> 2017 </span>- [warning] Connection failed<span class="number"> 3 </span>time(s)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '172.31.13.126' (111))</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Connection failed<span class="number"> 4 </span>time(s)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Master is not reachable from health checker!</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Master 172.31.13.126(172.31.13.126:3306) is not reachable!</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] SSH is reachable.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [info] Connecting to a master server failed. Reading configuration file /etc/masterha_default.cnf and /etc/masterha/app1.cnf again, and trying to connect to all servers to check server status..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] GTID failover mode = 1</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Alive Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Alive Slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Checking slave configurations..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Master is down!</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Terminating monitoring script.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Got exit code<span class="number"> 20 </span>(Master dead).</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] MHA::MasterFailover version 0.57.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Starting master failover.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] * Phase 1: Configuration Check Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] GTID failover mode = 1</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Checking master reachability via MySQL(double check)...</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Alive Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Alive Slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Starting GTID based failover.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] ** Phase 1: Configuration Check Phase completed.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 2: Dead Master Shutdown Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Forcing shutdown so that applications never connect to the current master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Executing master IP deactivation script:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 --command=stopssh --ssh_user=root  </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  done.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 2: Dead Master Shutdown Phase completed.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3: Master Recovery Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3.1: Getting Latest Slaves Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] The latest binary log file/position on all slaves is mysql-bin.000011:234</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Latest slaves (Slaves that received relay log files to the latest):</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] The oldest binary log file/position on all slaves is mysql-bin.000011:234</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Oldest slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3.3: Determining New Master Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Searching new master from slaves..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Candidate masters from the configuration file:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Non-candidate masters:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Searching from candidate_master slaves which have received the latest relay log events..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] New master is 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Starting master failover..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">From:</span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">To:</span><br><span class="line">172.31.9.182(172.31.9.182:3306) (new master)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3.3: New Master Recovery Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Waiting all logs to be applied.. </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   done.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Getting new master's binlog name and position..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  mysql-bin.000008:234</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='172.31.9.182', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='slave01', MASTER_PASSWORD='xxx';</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000008, 234, 28a037e5-6d0f-11e7-b43a-02e60b685c1c:1-15,</span><br><span class="line">39292a50-6d0f-11e7-999e-020efbf1e94e:1-4</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Executing master IP activate script:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --command=start --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 --new_master_host=172.31.9.182 --new_master_ip=172.31.9.182 --new_master_port=3306 --new_master_user='mha01'   --new_master_password=xxx</span><br><span class="line">NEW_MASTER_IP=172.31.9.182,OLD_MASTER_IP=172.31.13.126</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br><span class="line">VIP_ATTACHMENT_ID=eni-attach-5b219e35</span><br><span class="line">ATTACHMENT              eni-attach-5b219e35     detaching</span><br><span class="line">INSTANCE_ID=i-03135a59c242e9bad</span><br><span class="line">eni-attach-0f209f61</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info]  OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] Setting read_only=0 on 172.31.9.182(172.31.9.182:3306)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info]  ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] ** Finished master recovery successfully.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 3: Master Recovery Phase completed.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 4: Slaves Recovery Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 4.1: Starting Slaves in parallel..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] All new slave servers recovered successfully.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 5: New master cleanup phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] Resetting slave info on the new master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info]  172.31.9.182: Resetting slave info succeeded.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] Master failover to 172.31.9.182(172.31.9.182:3306) completed successfully.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line"></span><br><span class="line">----- Failover Report --<span class="yaml"><span class="meta">---</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="attr">app1:</span> <span class="string">MySQL</span> <span class="string">Master</span> <span class="string">failover</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">succeeded</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Master</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">is</span> <span class="string">down!</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Check</span> <span class="string">MHA</span> <span class="string">Manager</span> <span class="string">logs</span> <span class="string">at</span> <span class="attr">slave:/var/log/masterha/app1/manager.log</span> <span class="string">for</span> <span class="string">details.</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Started</span> <span class="string">automated(non-interactive)</span> <span class="string">failover.</span></span></span><br><span class="line"><span class="yaml"><span class="string">Invalidated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address</span> <span class="string">on</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span></span></span><br><span class="line"><span class="yaml"><span class="string">Selected</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">as</span> <span class="string">a</span> <span class="string">new</span> <span class="string">master.</span></span></span><br><span class="line"><span class="yaml"><span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Applying</span> <span class="string">all</span> <span class="string">logs</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Activated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address.</span></span></span><br><span class="line"><span class="yaml"><span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="string">Resetting</span> <span class="string">slave</span> <span class="string">info</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="string">Master</span> <span class="string">failover</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">completed</span> <span class="string">successfully.</span></span></span><br><span class="line"><span class="yaml"><span class="string">Mon</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">16</span><span class="string">:27:13</span> <span class="number">2017</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Sending</span> <span class="string">mail..</span></span></span><br><span class="line"><span class="yaml"><span class="string">defined(@array)</span> <span class="string">is</span> <span class="string">deprecated</span> <span class="string">at</span> <span class="string">/usr/share/perl5/vendor_perl/Mail/Sender.pm</span> <span class="string">line</span> <span class="number">318.</span></span></span><br><span class="line"><span class="yaml">        <span class="string">(Maybe</span> <span class="string">you</span> <span class="string">should</span> <span class="string">just</span> <span class="string">omit</span> <span class="string">the</span> <span class="string">defined()?)</span></span></span><br><span class="line"><span class="yaml"><span class="string">defined(@array)</span> <span class="string">is</span> <span class="string">deprecated</span> <span class="string">at</span> <span class="string">/usr/share/perl5/vendor_perl/Mail/Sender.pm</span> <span class="string">line</span> <span class="number">2693.</span></span></span><br><span class="line"><span class="yaml">        <span class="string">(Maybe</span> <span class="string">you</span> <span class="string">should</span> <span class="string">just</span> <span class="string">omit</span> <span class="string">the</span> <span class="string">defined()?)</span></span></span><br><span class="line"><span class="yaml"><span class="string">Option</span> <span class="string">new_slave_hosts</span> <span class="string">requires</span> <span class="string">an</span> <span class="string">argument</span></span></span><br><span class="line"><span class="yaml"><span class="string">Unknown</span> <span class="attr">option:</span> <span class="string">conf</span></span></span><br><span class="line"><span class="yaml"><span class="attr">tail:</span> <span class="string">manager.log:</span> <span class="string">file</span> <span class="string">truncated</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">220</span> <span class="number">126.</span><span class="string">com</span> <span class="string">Anti-spam</span> <span class="string">GT</span> <span class="string">for</span> <span class="string">Coremail</span> <span class="string">System</span> <span class="string">(126com[20140526])</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">EHLO</span> <span class="string">slave</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-mail</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-PIPELINING</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-AUTH</span> <span class="string">LOGIN</span> <span class="string">PLAIN</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-AUTH=LOGIN</span> <span class="string">PLAIN</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-coremail</span> <span class="number">1</span><span class="string">Uxr2xKj7kG0xkI17xGrU7I0s8FY2U3Uj8Cz28x1UUUUU7Ic2I0Y2Ur0Vl_3UCa0xDrUUUUj</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-STARTTLS</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="number">8</span><span class="string">BITMIME</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">AUTH</span> <span class="string">LOGIN</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">334</span> <span class="string">dXNlcm5hbWU6</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">ZHdqNTY4NTg4QDEyNi5jb20=</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">334</span> <span class="string">UGFzc3dvcmQ6</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">RHdqMTIzNDU=</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">235</span> <span class="string">Authentication</span> <span class="string">successful</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">MAIL</span> <span class="attr">FROM:&lt;dwj568588@126.com&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="string">Mail</span> <span class="string">OK</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">RCPT</span> <span class="attr">TO:&lt;duanwenjie@huan.tv&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="string">Mail</span> <span class="string">OK</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">DATA</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">354</span> <span class="string">End</span> <span class="string">data</span> <span class="string">with</span> <span class="string">&lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">To:</span> <span class="string">duanwenjie@huan.tv</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">From:</span> <span class="string">dwj568588@126.com</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Subject:</span> <span class="attr">app1:</span> <span class="string">MySQL</span> <span class="string">Master</span> <span class="string">failover</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">succeeded</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Date:</span> <span class="string">Mon,</span> <span class="number">24</span> <span class="string">Jul</span> <span class="number">2017</span> <span class="number">16</span><span class="string">:27:15</span> <span class="string">+0800</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">X-Mailer:</span> <span class="string">Perl</span> <span class="string">script</span> <span class="string">"send_report"</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span>      <span class="string">using</span> <span class="attr">Mail::Sender</span> <span class="number">0.8</span><span class="number">.16</span> <span class="string">by</span> <span class="string">Jenda</span> <span class="string">Krynicky,</span> <span class="string">Czechlands</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span>      <span class="string">running</span> <span class="string">on</span> <span class="string">slave</span> <span class="string">()</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span>      <span class="string">under</span> <span class="string">account</span> <span class="string">"zhouting"</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Message-ID:</span> <span class="string">&lt;20170724_082715_056339.dwj568588@126.com&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">MIME-Version:</span> <span class="number">1.0</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Content-type:</span> <span class="string">text/plain;</span> <span class="string">charset=utf-8</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Master</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">is</span> <span class="string">down!</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Check</span> <span class="string">MHA</span> <span class="string">Manager</span> <span class="string">logs</span> <span class="string">at</span> <span class="attr">slave:/var/log/masterha/app1/manager.log</span> <span class="string">for</span> <span class="string">details.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Started</span> <span class="string">automated(non-interactive)</span> <span class="string">failover.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Invalidated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address</span> <span class="string">on</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Selected</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">as</span> <span class="string">a</span> <span class="string">new</span> <span class="string">master.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Applying</span> <span class="string">all</span> <span class="string">logs</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Activated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="string">Resetting</span> <span class="string">slave</span> <span class="string">info</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Master</span> <span class="string">failover</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">completed</span> <span class="string">successfully.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="string">Mail</span> <span class="string">OK</span> <span class="string">queued</span> <span class="string">as</span> <span class="string">smtp1,C8mowAAH7yZhr3VZFR+JCA--.54250S2</span> <span class="number">1500884834</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">QUIT</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">221</span> <span class="string">Bye</span></span></span><br><span class="line"><span class="yaml"><span class="string">[root@slave</span> <span class="string">app1]#</span></span></span><br></pre></td></tr></table></figure></p>
<h3 id="日志过程解析"><a href="#日志过程解析" class="headerlink" title="日志过程解析"></a>日志过程解析</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">启动前的准备工作</span><br><span class="line">检查数据库服务器状态,获取相关参数设置</span><br><span class="line">检查GTID、candidate_master、过滤DB是否设置</span><br><span class="line">测试ssh连接是否成功</span><br><span class="line">测试MHA <span class="keyword">node</span><span class="title">是否可用</span></span><br><span class="line"><span class="title">创建MHA</span>日志目录</span><br><span class="line">开始检查<span class="literal">slave</span>的差异日志应用权限</span><br><span class="line">确定当前的复制架构</span><br><span class="line">调试master_ip_failover_script</span><br><span class="line">调试shutdown_script</span><br><span class="line">设置二次检查的主机masterha_secondary_check</span><br><span class="line">MHA启动完毕,进入监测状态</span><br><span class="line">监测<span class="literal">master</span>服务器挂了</span><br><span class="line">通过定义的二次监测,确认<span class="literal">master</span>是否挂了</span><br><span class="line">确认<span class="literal">master</span>挂了,开始进入failover流程</span><br><span class="line">再试尝试连接<span class="literal">master</span>和<span class="literal">master</span>的ssh</span><br><span class="line">通过MHA配置文件,监测其他<span class="literal">slave</span>的状态</span><br><span class="line">再次监测<span class="literal">slave</span>的配置是否有变化,是否符合failover条件</span><br><span class="line">正式开始failover</span><br><span class="line">再次对<span class="literal">slave</span>配置做检查</span><br><span class="line">对原<span class="literal">Master</span>做master_ip_failover_script和shutdown_script的操作</span><br><span class="line">开始差异日志的恢复，获取<span class="literal">slave</span>最后得到的binlog位置</span><br><span class="line">获取原<span class="literal">master</span>的binlog日志</span><br><span class="line">确定新的<span class="literal">master</span></span><br><span class="line">在new <span class="literal">master</span>上应用差异的binlog日志</span><br><span class="line">获取new <span class="literal">master</span>的binlog位置。</span><br><span class="line">执行master_ip_failover_script,调用aws_vip_change.sh，执行VIP漂移</span><br><span class="line">开始恢复其他<span class="literal">slave</span>的差异日志</span><br><span class="line">差异日志应用完成以后,切换所有<span class="literal">slave</span>到new <span class="literal">master</span>。</span><br><span class="line">failover操作完成,生成failover报告</span><br><span class="line">最后发送邮件通知</span><br></pre></td></tr></table></figure>
<h3 id="确认FailOver状态"><a href="#确认FailOver状态" class="headerlink" title="确认FailOver状态"></a>确认FailOver状态</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@slave app1]</span># <span class="selector-tag">ifconfig</span>             <span class="selector-id">#vip</span>已经添加到从库上</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:FB</span><span class="selector-pseudo">:F1</span><span class="selector-pseudo">:E9</span><span class="selector-pseudo">:4E</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.9.182</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::e</span><span class="selector-pseudo">:fbff</span><span class="selector-pseudo">:fef1</span><span class="selector-pseudo">:e94e</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:17060</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:17883</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:2142676</span> (<span class="number">2.0</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:2390595</span> (<span class="number">2.2</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth1</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:25</span><span class="selector-pseudo">:83</span><span class="selector-pseudo">:A0</span><span class="selector-pseudo">:22</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.0.200</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::12</span><span class="selector-pseudo">:25ff</span><span class="selector-pseudo">:fe83</span><span class="selector-pseudo">:a022</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:18</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:798</span> (<span class="number">798.0</span> b)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1828</span> (<span class="number">1.7</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-pseudo">::1</span>/<span class="selector-tag">128</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Host</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:2789</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:2789</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:669913</span> (<span class="number">654.2</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:669913</span> (<span class="number">654.2</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@slave app1]</span>#</span><br></pre></td></tr></table></figure>
<h3 id="查看邮件发送状态"><a href="#查看邮件发送状态" class="headerlink" title="查看邮件发送状态"></a>查看邮件发送状态</h3><p>登录邮件，查看是否收到报警邮件。<br><img src="http://note.youdao.com/yws/public/resource/bba80193f9c2d29f073784f4e498b134/xmlnote/0A43FC640BD84154ADCD175F765F82E1/33468" alt="image">  </p>
<h3 id="手动FailOver"><a href="#手动FailOver" class="headerlink" title="手动FailOver"></a>手动FailOver</h3><p>MHA的手动FailOver不在本文范围，详情理论可参考官方文档。  </p>
<h3 id="参数列表"><a href="#参数列表" class="headerlink" title="参数列表"></a>参数列表</h3><table>
<thead>
<tr>
<th>参数名</th>
<th>是否必须</th>
<th>参数使用域</th>
<th>默认值</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr>
<td>hostname</td>
<td>Yes</td>
<td>Local Only</td>
<td>-</td>
<td>hostname=master,hostname=slave</td>
</tr>
<tr>
<td>ip</td>
<td>No</td>
<td>Local Only</td>
<td>gethostbyname($hostname)</td>
<td>ip=192.168.1.100</td>
</tr>
<tr>
<td>port</td>
<td>No</td>
<td>Local/App/Global</td>
<td>3306</td>
<td>port=3306</td>
</tr>
<tr>
<td>ssh_host</td>
<td>No</td>
<td>Local Only</td>
<td>same as hostname</td>
<td>ssh_host=master,ssh_host=slave</td>
</tr>
<tr>
<td>ssh_ip</td>
<td>No</td>
<td>Local Only</td>
<td>gethostbyname($ssh_host)</td>
<td>ssh_ip=192.168.1.101</td>
</tr>
<tr>
<td>ssh_port</td>
<td>No</td>
<td>Local/App/Global</td>
<td>22</td>
<td>ssh_port=22</td>
</tr>
<tr>
<td>ssh_connection_timeout</td>
<td>No</td>
<td>Local/App/Global</td>
<td>5</td>
<td>ssh_connection_timeout=20</td>
</tr>
<tr>
<td>ssh_options</td>
<td>No</td>
<td>Local/App/Global</td>
<td>“”(empty string)</td>
<td>ssh_options=”-i /root/.ssh/id_dsa2”</td>
</tr>
<tr>
<td>candidate_master</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>candidate_master=1</td>
</tr>
<tr>
<td>no_master</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>no_master=1</td>
</tr>
<tr>
<td>ignore_fail</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>ignore_fail=1</td>
</tr>
<tr>
<td>skip_init_ssh_check</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>skip_init_ssh_check=1</td>
</tr>
<tr>
<td>skip_reset_slave</td>
<td>No</td>
<td>Local/App/Global</td>
<td>0</td>
<td>skip_reset_slave=1</td>
</tr>
<tr>
<td>user</td>
<td>No</td>
<td>Local/App/Global</td>
<td>root</td>
<td>user=root</td>
</tr>
<tr>
<td>password</td>
<td>No</td>
<td>Local/App/Global</td>
<td>“”(empty string)</td>
<td>password=rootpass</td>
</tr>
<tr>
<td>repl_user</td>
<td>No</td>
<td>Local/App/Global</td>
<td>Master_User value from SHOW SLAVE STATUS</td>
<td>repl_user=repl</td>
</tr>
<tr>
<td>repl_password</td>
<td>No</td>
<td>Local/App/Global</td>
<td>(current replication password)</td>
<td>repl_user=replpass</td>
</tr>
<tr>
<td>disable_log_bin</td>
<td>No</td>
<td>Local/App/Global</td>
<td>0</td>
<td>disable_log_bin=1</td>
</tr>
<tr>
<td>master_pid_file</td>
<td>No</td>
<td>Local/App/Global</td>
<td>“”(empty string)</td>
<td>master_pid_file=/var/lib/mysql/master1.pid</td>
</tr>
<tr>
<td>ssh_user</td>
<td>No</td>
<td>Local/App/Global</td>
<td>current OS user</td>
<td>ssh_user=root</td>
</tr>
<tr>
<td>remote_workdir</td>
<td>No</td>
<td>Local/App/Global</td>
<td>/var/tmp</td>
<td>remote_workdir=/var/log/masterha/app1</td>
</tr>
<tr>
<td>master_binlog_dir</td>
<td>No</td>
<td>Local/App/Global</td>
<td>/var/lib/mysql</td>
<td>master_binlog_dir=/data/mysql1</td>
</tr>
<tr>
<td>log_level</td>
<td>No</td>
<td>App/Global</td>
<td>info</td>
<td>log_level=debug</td>
</tr>
<tr>
<td>manager_workdir</td>
<td>No</td>
<td>App</td>
<td>/var/tmp</td>
<td>manager_workdir=/var/log/masterha</td>
</tr>
<tr>
<td>client_bindir</td>
<td>No</td>
<td>App</td>
<td>-</td>
<td>client_bindir=/usr/mysql/bin</td>
</tr>
<tr>
<td>client_libdir</td>
<td>No</td>
<td>App</td>
<td>-</td>
<td>client_libdir=/usr/lib/mysql</td>
</tr>
<tr>
<td>manager_log</td>
<td>No</td>
<td>App</td>
<td>STDERR</td>
<td>manager_log=/var/log/masterha/app1.log</td>
</tr>
<tr>
<td>check_repl_delay</td>
<td>No</td>
<td>App/Global</td>
<td>1</td>
<td>check_repl_delay=0</td>
</tr>
<tr>
<td>check_repl_filter</td>
<td>No</td>
<td>App/Global</td>
<td>1</td>
<td>check_repl_filter=0</td>
</tr>
<tr>
<td>latest_priority</td>
<td>No</td>
<td>App/Global</td>
<td>1</td>
<td>latest_priority=0</td>
</tr>
<tr>
<td>multi_tier_slave</td>
<td>No</td>
<td>App/Global</td>
<td>0</td>
<td>multi_tier_slave=1</td>
</tr>
<tr>
<td>ping_interval</td>
<td>No</td>
<td>App/Global</td>
<td>3</td>
<td>ping_interval=5</td>
</tr>
<tr>
<td>ping_type</td>
<td>No</td>
<td>App/Global</td>
<td>SELECT</td>
<td>ping_type=CONNECT</td>
</tr>
<tr>
<td>secondary_check_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>secondary_check_script= masterha_secondary_check -s remote_dc1 -s remote_dc2</td>
</tr>
<tr>
<td>master_ip_failover_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>master_ip_failover_script=/usr/local/bin/master_ip_failover</td>
</tr>
<tr>
<td>master_ip_online_change_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>master_ip_online_change_script= /usr/local/bin/master_ip_online_change</td>
</tr>
<tr>
<td>shutdown_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>shutdown_script= /usr/local/bin/master_shutdown</td>
</tr>
<tr>
<td>report_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>report_script= /usr/local/bin/report</td>
</tr>
</tbody>
</table>
<h4 id="详情解释"><a href="#详情解释" class="headerlink" title="详情解释"></a>详情解释</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">Local Scope:        针对每个server级别有效的选项.local scope级别的参数需要在配置文件的 [server_xxx]段落配置  </span><br><span class="line">App Scope:          这个参数可以理解为针对一组master-slave集群. 这些参数需要在 [server_default]段落配置  </span><br><span class="line">Global Scope:       这个参数针对所有的MHA管理的实例. global scope级别的配置只有你在使用一个manager server管理多组master-slave时使用 </span><br><span class="line">hostname：          目标Mysql服务器的主机名或者IP地址,这个参数是强制的,并且必须配置在[server_xxx]段落</span><br><span class="line">ip：                目标Mysql服务器的IP地址,默认是通过$hostname变量获取.MHA manager和MHA Node</span><br><span class="line">                    内部使用这个IP地址链接到Mysql和SSH.通常你不需要配置这个参数,因为它可以通过$hostname解析获得</span><br><span class="line">port：              mysql服务器使用的端口号,默认是3306,MHA链接到mysql通过IP地址和端口</span><br><span class="line">ssh_host：          从0.53版本开始支持此参数,此参数的主要目的在于你mysql复制使用的IP地址由于安全策略,不能直接连接,</span><br><span class="line">                    所以需要通过其他IP和端口连接到mysql server或者ssh,默认这个参数和hostname的值相同</span><br><span class="line">ssh_ip：            从0.53版本开始支持此参数,连接到目标mysql server的ssh ip地址,默认从$ssh_host获取</span><br><span class="line">ssh_port：          从0.53版本开始支持此参数,连接到目标mysql server的ssh端口,默认是22</span><br><span class="line">ssh_connection_timeout：从0.54开始支持此参数,默认是5秒,添加此参数的原因是以前我们在程序里面写死了</span><br><span class="line">ssh_options：       从0.53开始支持此参数,可以添加SSH命令行的参数</span><br><span class="line">candidate_master：  </span><br><span class="line">你的slave的硬件配置或者用途可能不太一样,你想要提升更加可靠的slave作为新的master</span><br><span class="line">如果设置candidate_master的值为1,那么这个server会优先成为master,只要它满足成为master的条件(binlog开启的,没有严重的复制延时等)</span><br><span class="line">所以意味着配置了candiate_master=1的服务器并不是肯定可以成为new master,但是这个参数能够帮助提高优先级</span><br><span class="line">如果你在多个服务器上设置了candidate_master=1,那么在配置文件中[server_xxx]的配置顺序,会成为第二排序规则,排在上面的越优先</span><br><span class="line">no_master：         no_master=1是默认值,意思是这个server从来不会成为新的master,这个参数用来标记某些从来不用成为new master的服务器</span><br><span class="line">ignore_fail：       </span><br><span class="line">默认是0,当某个slave的ssh或者mysql当掉或者复制失败的时候,MHA manager不启动failover。</span><br><span class="line">但是有些环境下,你想要在某个特定的slave失败的时候继续执行failover,把么就设置这个ignore_fail=1,即时这个slave失败的时候,failover依然继续执行</span><br><span class="line">skip_init_ssh_check：启动的时候跳过ssh连接测试</span><br><span class="line">skip_reset_slave：  从0.56版本开始支持此参数,在master执行failover以后跳过执行<span class="keyword">reset</span> <span class="keyword">slave</span> all(译者感觉应该是方便MM复制的后期恢复)</span><br><span class="line"><span class="keyword">user</span>：              mysql管理员命令,建议赋予all <span class="keyword">privileges</span>权限</span><br><span class="line"><span class="keyword">password</span>：          上面mysql <span class="keyword">user</span>的密码</span><br><span class="line">repl_user：         mysql复制使用的用户名,需要执行<span class="keyword">change</span> <span class="keyword">master</span> <span class="keyword">to</span>命令和<span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>命令等.一般赋予<span class="keyword">replication</span> <span class="keyword">slave</span>,<span class="keyword">replication</span> <span class="keyword">client</span>权限</span><br><span class="line">repl_password：     上面用户对应的密码.默认情况下,使用的是当前复制的密码</span><br><span class="line">disable_log_bin：   当这个参数设置以后,当应用差异日志到<span class="keyword">slave</span>的时候,<span class="keyword">slave</span>不会生成binlog. Internally MHA passes <span class="comment">--disable-log-bin to mysqlbinlog command</span></span><br><span class="line">master_pid_file：   设置<span class="keyword">master</span>的pid文件位置,当你的服务器上运行了多个mysql的时候使用</span><br><span class="line">ssh_user：          </span><br><span class="line">MHA manager和MHA node通过这个用户连接到mysql <span class="keyword">server</span>的OS上,在对应的OS上执行相关命令和拷贝差异日志等等</span><br><span class="line">这个用户必须有读取mysql <span class="built_in">binary</span>/relay 相关日志文件的权限,还有日志目录的写入权限.(remote_workdir目录)</span><br><span class="line">这个用户必须可以直接连接到服务器上,不用任何交互的操作.通过使用ssh <span class="keyword">public</span> <span class="keyword">key</span>作为认证方式.默认使用的用户是manager当前的用户</span><br><span class="line">remote_workdir：    </span><br><span class="line">每个MHA node上,MHA工作使用的目录的绝对路径.如果目录不存在,MHA会自动创建,如果权限不够,那么MHA node会意外终止,</span><br><span class="line">注意MHA manager和MHA node都不会检查这个目录的磁盘可用空间,你需要自己保证有足够的可用空间.默认的remote_workdir是<span class="string">'/var/tmp'</span></span><br><span class="line">master_binlog_dir： </span><br><span class="line"><span class="keyword">master</span> mysql保存<span class="keyword">binlog</span>的目录的绝对路径.如果参数的主要目的是在<span class="keyword">master</span> mysql宕机以后,为了通过ssh拷贝需要的<span class="keyword">binlog</span> <span class="keyword">event</span></span><br><span class="line">这个参数是需要的,因为当mysql宕机以后,没法自动获取<span class="built_in">binary</span> <span class="keyword">log</span>的目录</span><br><span class="line">默认情况下,master_binlog_dir的值是<span class="string">"/var/lib/mysql/,/var/log/mysql/"</span>,/<span class="keyword">var</span>/lib/mysql/是大部分mysql发布版本的默认mysql输出目录,</span><br><span class="line">你可以设置多个目录,使用逗号分隔.比如(/data1,/data2,/data3)</span><br><span class="line">log_level：         MHA manager 的日志级别,默认是info级别,在大多数环境下没有问题.可用的级别有.debug/info/<span class="keyword">warning</span>/<span class="keyword">error</span></span><br><span class="line">manager_workdir：   MHA manager使用的工作目录,如果没有设置,默认使用/<span class="keyword">var</span>/tmp</span><br><span class="line">client_bindir：     如果mysql命令行工具没有安装在默认目录,可以使用这个选项配置</span><br><span class="line">client_libdir：     如果mysql lib没有安装在默认目录,可以使用这个选项配置</span><br><span class="line">manager_log：       MHA manager日志文件的绝对目录和文件名,如果没有设置,那么将直接打印到标准输出和标准错误输出</span><br><span class="line">当执行交互式的<span class="keyword">failover</span>时,MHA manager将会忽略manager_log设置,直接答应到标准输出和标准错误输出</span><br><span class="line">check_repl_delay：  </span><br><span class="line">默认情况下如果一个<span class="keyword">slave</span>比<span class="keyword">master</span>延时了<span class="number">100</span>M的relay logs.MHA不会选择这个<span class="keyword">slave</span>作为新的master.因为他需要更多的时间来<span class="keyword">recovery</span></span><br><span class="line">设置check_repl_delay=<span class="number">0</span>,MHA在选择<span class="keyword">new</span> <span class="keyword">master</span>时将会忽略复制的延时.这个参数通常和candidate_master=<span class="number">1</span>同时使用</span><br><span class="line">check_repl_filter： </span><br><span class="line">默认情况下如果<span class="keyword">master</span>和<span class="keyword">slave</span>有不同的<span class="built_in">binary</span> <span class="keyword">log</span>/<span class="keyword">replication</span> 过滤规则的话,MHA打印错误,不进行<span class="keyword">start</span> <span class="keyword">monitoring</span>或者<span class="keyword">failover</span></span><br><span class="line">这么做的目的是为了避免<span class="keyword">recover</span>的时候出现意外的错误,例如<span class="string">"Table not exists"</span>,如果你<span class="number">100</span>%确定你不同的过滤规则不会导致<span class="keyword">recover</span>时候报错,</span><br><span class="line">那么你可以设置check_repl_fiter=<span class="number">0</span>,这样的话,MHA在应用差异日志的时候将不会在检查过滤规则.使用这个参数的时候需要非常小心</span><br><span class="line">latest_priority：   默认情况下,接收到了最新的<span class="keyword">binlog</span>的<span class="keyword">slave</span>优先被选为<span class="keyword">new</span> <span class="keyword">master</span>,如果你想要控制优先级的顺序,比如(host2&gt;host3&gt;host4),那么设置latest_priority=<span class="number">0</span>会有所帮助</span><br><span class="line">multi_tier_slave：  </span><br><span class="line">MHA manager从<span class="number">0.5</span><span class="number">.2</span>开始支持多主复制.默认情况下,它不支持三层以上的复制架构.例如,host2是host1的<span class="keyword">slave</span>,host3是host2的<span class="keyword">slave</span>,</span><br><span class="line">默认不允许把这个三个主机写到同一个配置文件中因为这是一个三层的复制架构,并且MHA会因此报错,并停止工作.如果设置了multi_tier_slave,</span><br><span class="line">MHA manager不会因为多层架构而终止,它会忽略三层及以上的主机,例如<span class="keyword">master</span>(host1)挂掉以后,host2会被选为新的<span class="keyword">master</span>,host3将继续从host2复制</span><br><span class="line">ping_interval：     </span><br><span class="line">这个参数声明MHA manager pings(通过执行<span class="keyword">sql</span>来ping) <span class="keyword">master</span>的间隔.当连续三次ping失败,MHA manager认为这个Mysql <span class="keyword">master</span>宕机,从宕机到检测到宕机,</span><br><span class="line">最大的消耗时间是这个参数的四倍,这个参数默认值是<span class="number">3</span>(<span class="number">3</span>秒),如果MHA manager因为权限问题多次连接失败,这不认为<span class="keyword">master</span> dead</span><br><span class="line">ping_type：</span><br><span class="line">从MHA manager <span class="number">0.53</span>开始支持这个参数, MHA建立一个长连接到<span class="keyword">master</span>,然后通过执行<span class="string">"SELECT 1"</span> (ping_type=<span class="keyword">SELECT</span>)来判断<span class="keyword">master</span>是否可用</span><br><span class="line">但是在一些环境下,最好使用短连接的方式,因为这样的方式更严格,也能检测TCP连接级别的失败.设置ping_type=<span class="keyword">CONNECT</span>可以实现.从<span class="number">0.56</span>版本开始,支持ping_type=<span class="keyword">INSERT</span></span><br><span class="line">secondary_check_script：</span><br><span class="line">通常情况,强力推荐使用两个或者多个路由检测Mysql <span class="keyword">master</span>默认MHA通过一个路由检测:从manager到master.这是不推荐的</span><br><span class="line">MHA manager可以通过secondary_check_script参数调用一个内部脚本来实现两个或者多个路由的检测.下面是一个配置实例</span><br><span class="line">secondary_check_script = masterha_secondary_check -s remote_host1 -s remote_host2</span><br><span class="line">MHA manager包含masterha_secondary_check 脚本.内置的masterha_secondary_check脚本可以满足大多是环境,当然你也可以调用你自定义的脚本.</span><br><span class="line">在上面的实例中,MHA manager通过这两个路由检测<span class="keyword">master</span>主机</span><br><span class="line">Manager-(A)-&gt;remote_host1-(B)-&gt;master_host</span><br><span class="line">Manager-(A)-&gt;remote_host2-(B)-&gt;master_host</span><br><span class="line">如果两条路径中,A都是成功的,B都是不成功的,那么masterha_secondary_check将会退出,返回状态<span class="number">0.</span>MHA manager将会认为Mysql <span class="keyword">master</span>宕机,开始<span class="keyword">failover</span></span><br><span class="line">如果A失败,那么masterha_secondary_check将退出,返回状态<span class="number">2</span>,MHA manager网络出现问题,不会开始<span class="keyword">failover</span></span><br><span class="line">如果B检测成功,masterha_secondary_check退出并返回状态<span class="number">3</span>,MHA manager明确的知道mysql <span class="keyword">master</span>是活跃的,不开始<span class="keyword">failover</span></span><br><span class="line">通常来讲,remote_host1和remote_host2必须和 MHA manager及Mysql <span class="keyword">server</span>不在同一个网段,这样才更有意义</span><br><span class="line">MHA调用secondary_check_script参数对应的脚本会自动传递以下参数(所以你不需要在配置文件中设置),</span><br><span class="line">masterha_secondary_check适用于大多数环境,如果你需要其他的功能可以自己写一个网络检查的脚本.</span><br><span class="line"><span class="comment">--user=(SSH username of the remote hosts. ssh_user parameter value will be passed)</span></span><br><span class="line"><span class="comment">--master_host=(master's hostname)</span></span><br><span class="line"><span class="comment">--master_ip=(master's ip address)</span></span><br><span class="line"><span class="comment">--master_port=(master's port number)</span></span><br><span class="line">注意:</span><br><span class="line">masterha_secondary_check脚本依赖于IO::Socket::INET perl包,在perl v5<span class="number">.6</span><span class="number">.0</span>中默认包含,masterha_secondary_check脚本会通过</span><br><span class="line">ssh连接到所有的remote servers.所以SSH <span class="keyword">public</span> <span class="keyword">key</span> 认证需要设置.另外masterha_secondary_check脚本尝试使用TCP连接从remote <span class="keyword">server</span>到mysql master.这意味着服务器设置的max_connections参数对此连接无效,并且如果TCP连接成功,Aborted_connects状态将会加<span class="number">1</span></span><br><span class="line">master_ip_failover_script：</span><br><span class="line">常见的HA环境下,大多是情况会给<span class="keyword">master</span>分配一个虚拟IP,如果<span class="keyword">master</span>宕机,HA软件像一个Pacemaker将虚拟IP转移到备用的<span class="keyword">master</span>上</span><br><span class="line">另外一种常见的方法就是创建一个全局目录数据库,包含所有应用和writer/reader ip地址.例如&#123;app_master1,<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>&#125;,&#123;app_master2,<span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span>&#125;...,代替使用虚拟IP,</span><br><span class="line">这种情况,你需要在<span class="keyword">master</span>宕机的时候更新目录数据库</span><br><span class="line">两种方法都有好的或者不好的地方,MHA不强制要求使用哪一种,但是提供了master_ip_failover_script参数来完成此目的</span><br><span class="line">换句话说,你需要写一个脚本来调整应用服务连接到新的<span class="keyword">master</span>,然后定义master_ip_failover_script的参数,下面是一个实例</span><br><span class="line">master_ip_failover_script= /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/master_ip_failover</span><br><span class="line">你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/master_ip_failover找到一个简单的脚本.这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">MHA manager会调用master_ip_failover_script三次,</span><br><span class="line">第一次,在开始<span class="keyword">master</span> monitor之前调用(目的是检查脚本是否可用),</span><br><span class="line">第二次是在调用shutdown_script脚本前调用,</span><br><span class="line">第三次是在<span class="keyword">new</span> <span class="keyword">master</span>应用完所有的差异日志以后,MHA manager会传递给脚本如下参数.(你不用在配置文件中指明这些参数)</span><br><span class="line">Checking phase</span><br><span class="line"><span class="comment">--command=status</span></span><br><span class="line"><span class="comment">--ssh_user=(current master's ssh username)</span></span><br><span class="line"><span class="comment">--orig_master_host=(current master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(current master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(current master's port number)</span></span><br><span class="line"><span class="keyword">Current</span> <span class="keyword">master</span> <span class="keyword">shutdown</span> phase</span><br><span class="line"><span class="comment">--command=stop or stopssh</span></span><br><span class="line"><span class="comment">--ssh_user=(dead master's ssh username, if reachable via ssh)</span></span><br><span class="line"><span class="comment">--orig_master_host=(current(dead) master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(current(dead) master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(current(dead) master's port number)</span></span><br><span class="line"><span class="keyword">New</span> <span class="keyword">master</span> activation phase</span><br><span class="line"><span class="comment">--command=start</span></span><br><span class="line"><span class="comment">--ssh_user=(new master's ssh username)</span></span><br><span class="line"><span class="comment">--orig_master_host=(dead master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(dead master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(dead master's port number)</span></span><br><span class="line"><span class="comment">--new_master_host=(new master's hostname)</span></span><br><span class="line"><span class="comment">--new_master_ip=(new master's ip address)</span></span><br><span class="line"><span class="comment">--new_master_port(new master's port number)</span></span><br><span class="line"><span class="comment">--new_master_user=(new master's user)</span></span><br><span class="line"><span class="comment">--new_master_password(new master's password)</span></span><br><span class="line">如果你使用共享虚拟IP的方法,你不需要在<span class="keyword">master</span> <span class="keyword">shutdown</span>阶段做任何事情,只要通过shutdown_script脚本关掉原来<span class="keyword">master</span>的电源,在激活<span class="keyword">new</span> <span class="keyword">master</span>阶段,</span><br><span class="line">你需要分配虚拟IP给<span class="keyword">new</span> master.如果你使用目录数据库的方法,你需要在宕机的<span class="keyword">master</span> <span class="keyword">shutdown</span>阶段删除或者更新失效<span class="keyword">master</span>的记录</span><br><span class="line">在<span class="keyword">new</span> <span class="keyword">master</span>生效阶段需要插入或者更新<span class="keyword">new</span> <span class="keyword">master</span>的记录.另外你可以做任何事情来保证应用程序可以成功的写入<span class="keyword">new</span> <span class="keyword">master</span></span><br><span class="line">比如<span class="keyword">SET</span> <span class="keyword">GLOBAL</span> read_only=<span class="number">0</span>，创建有写入权限的数据库用户等等</span><br><span class="line">MHA manager检查脚本的退出状态,如果脚本退出状态是<span class="number">0</span>或者<span class="number">10</span>,MHA manager继续操作,如果脚本退出状态不是<span class="number">0</span>或者<span class="number">10</span>,MHA manager将会意外终止,并不继续continue failover.默认这个参数是空的</span><br><span class="line">master_ip_online_change_script：</span><br><span class="line">这是几个简单版本的master_ip_failover_script参数,但是<span class="keyword">master</span> <span class="keyword">failover</span>命令并不调用它.master <span class="keyword">online</span> <span class="keyword">change</span>命令会调用它.(masterha_master_switch <span class="comment">--master_state=alive),传递以下参数</span></span><br><span class="line"><span class="keyword">Current</span> <span class="keyword">master</span> write freezing phase</span><br><span class="line"><span class="comment">--command=stop or stopssh</span></span><br><span class="line"><span class="comment">--orig_master_host=(current master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(current master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(current master's port number)</span></span><br><span class="line"><span class="comment">--orig_master_user=(current master's user)</span></span><br><span class="line"><span class="comment">--orig_master_password=(current master's password)</span></span><br><span class="line"><span class="comment">--orig_master_ssh_user=(from 0.56, current master's ssh user)</span></span><br><span class="line"><span class="comment">--orig_master_is_new_slave=(from 0.56, notifying whether the orig master will be new slave or not)</span></span><br><span class="line"><span class="keyword">New</span> <span class="keyword">master</span> granting write phase</span><br><span class="line"><span class="comment">--command=start</span></span><br><span class="line"><span class="comment">--orig_master_host=(orig master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(orig master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(orig master's port number)</span></span><br><span class="line"><span class="comment">--new_master_host=(new master's hostname)</span></span><br><span class="line"><span class="comment">--new_master_ip=(new master's ip address)</span></span><br><span class="line"><span class="comment">--new_master_port(new master's port number)</span></span><br><span class="line"><span class="comment">--new_master_user=(new master's user)</span></span><br><span class="line"><span class="comment">--new_master_password=(new master's password)</span></span><br><span class="line"><span class="comment">--new_master_ssh_user=(from 0.56, new master's ssh user)</span></span><br><span class="line">MHA在当前的<span class="keyword">master</span> write freezing阶段后执行FLUASH <span class="keyword">TABLES</span> <span class="keyword">WITH</span> <span class="keyword">READ</span> <span class="keyword">LOCK</span>, 在<span class="keyword">new</span> mastergranting write阶段你可以执行一些类似master_ip_failover_script的操作</span><br><span class="line">比如创建一个有写入权限的用户,执行<span class="keyword">SET</span> <span class="keyword">GLOBAL</span> read_only=<span class="number">0</span>,更新目录数据库等.如果你的脚本退出返回状态不是<span class="number">1</span>或者<span class="number">10</span>,那么MHA manager将会意外终止,</span><br><span class="line">停止<span class="keyword">master</span> <span class="keyword">switch</span>这个参数默认为空,所以MHA manager不做任何调用你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/master_ip_online_change找到一个简单的脚本</span><br><span class="line">这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">shutdown_script：</span><br><span class="line">你可能需要强制关闭<span class="keyword">master</span>服务器,避免他再次提供服务,这对于避免脑裂很重要.下面是一个实例</span><br><span class="line">shutdown_script= /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/power_manager</span><br><span class="line">你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/power_manager找到一个简单的脚本.这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">在调用shutdown_script脚本之前,MHA manager内部会通过ssh尝试连接到mysql <span class="keyword">master</span>,如果ssh可以连接(意思就是OS是存活的,但是Mysqld没有运行),MHAmanager就会传递下面的参数</span><br><span class="line"><span class="comment">--command=stopssh (这个意思就是指停止服务,不会关机)</span></span><br><span class="line"><span class="comment">--ssh_user=(ssh username so that you can connect to the master)</span></span><br><span class="line"><span class="comment">--host=(master's hostname)</span></span><br><span class="line"><span class="comment">--ip=(master's ip address)</span></span><br><span class="line"><span class="comment">--port=(master's port number)</span></span><br><span class="line"><span class="comment">--pid_file=(master's pid file)</span></span><br><span class="line">如果<span class="keyword">master</span>主机的ssh不能连接,那么MHA会使用如下参数</span><br><span class="line"><span class="comment">--command=stop (这个会通过fence设备关掉电源)</span></span><br><span class="line"><span class="comment">--host=(master's hostname)</span></span><br><span class="line"><span class="comment">--ip=(master's ip address)</span></span><br><span class="line">这个脚本的大概功能如下,如果<span class="comment">--command=stopssh被调用,脚本会使用killall -9 杀掉目标服务器上所有的mysqld_safe服务</span></span><br><span class="line">如果<span class="comment">--pid_file被设置,脚本尝试kill指定的进程.如果脚本执行成功,那么脚本会退出返回状态10.如果退出状态为10,</span></span><br><span class="line">MHA manager后面会通过ssh连接到<span class="keyword">master</span>,获取需要的<span class="built_in">binary</span> log.如果脚本通过ssh连接到服务器失败,那么就会传递<span class="comment">--command=stop参数,这个参数尝试关闭机器的电源,</span></span><br><span class="line">关闭电源依赖于H/W.HP(ILO),DELL(DRAC).如果<span class="keyword">power</span> <span class="keyword">off</span>成功,脚本会然会状态<span class="number">0</span>,其他情况会返回状态<span class="number">1.</span>当返回状态是<span class="number">0</span>的时候MHA manager </span><br><span class="line">开始failover.如果返回状态不是<span class="number">0</span>或者<span class="number">10</span>,那么MHA manager会意外终止.这个参数默认是空,所以MHA manager不会调用任何脚本</span><br><span class="line">另外,MHA manager在启动<span class="keyword">monitoring</span>之前调用shutdown_script.这时候会传递下面的参数.目的是检测脚本是否可用,如果发现错误,你可以提前知道</span><br><span class="line"><span class="comment">--command=status</span></span><br><span class="line"><span class="comment">--host=(master's hostname)</span></span><br><span class="line"><span class="comment">--ip=(master's ip address)</span></span><br><span class="line">report_script：</span><br><span class="line">你希望当<span class="keyword">failover</span>发生以后可以发送一个报告(例如email),report_script可以达到这个目的,MHA manager传递下面的参数</span><br><span class="line"><span class="comment">--orig_master_host=(dead master's hostname)</span></span><br><span class="line"><span class="comment">--new_master_host=(new master's hostname)</span></span><br><span class="line"><span class="comment">--new_slave_hosts=(new slaves' hostnames, delimited by commas)</span></span><br><span class="line"><span class="comment">--subject=(mail subject)</span></span><br><span class="line"><span class="comment">--body=(body)</span></span><br><span class="line">默认这个参数是空的,所以MHA manager不调用任何脚本，你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/send_report找到一个简单的脚本</span><br><span class="line">这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">init_conf_load_script：</span><br><span class="line">这个脚本可以在你不想在配置文件中写明文密码的时候使用.你可以覆盖全局配置参数.实例脚本如下</span><br><span class="line">#!/usr/<span class="keyword">bin</span>/perl</span><br><span class="line">print <span class="string">"password=$ROOT_PASS\n"</span>;</span><br><span class="line">print "repl_password=$REPL_PASS\n";</span><br><span class="line">这个参数默认为空,所以MHA manager默认不调用任何脚本</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>MySQL Master High Available 理论篇：<br><a href="https://yq.aliyun.com/articles/58004?spm=5176.100239.blogcont57855.9.jUuCt0" target="_blank" rel="noopener">https://yq.aliyun.com/articles/58004?spm=5176.100239.blogcont57855.9.jUuCt0</a></p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>云服务器上MySQL高可用，也可通过云负载均衡产品+MySQL复制来实现，但在数据安全性上，没有MHA+VIP+MySQL相对安全。</p>

      
    </div>
    
    
    

    

    

    
<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

  
</div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MySQL/" rel="tag"># MySQL</a>
          
            <a href="/tags/AWS/" rel="tag"># AWS</a>
          
            <a href="/tags/EC2/" rel="tag"># EC2</a>
          
            <a href="/tags/VIP/" rel="tag"># VIP</a>
          
            <a href="/tags/MHA/" rel="tag"># MHA</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/MongoDB从MMAPv1在线迁移至WiredTiger引擎.html" rel="next" title="MongoDB从MMAPv1在线迁移至WiredTiger引擎">
                <i class="fa fa-chevron-left"></i> MongoDB从MMAPv1在线迁移至WiredTiger引擎
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/误删除ibdata1-Table-doesn-t-exist-恢复案例.html" rel="prev" title="误删除ibdata1(Table doesn,t exist)恢复案例">
                误删除ibdata1(Table doesn,t exist)恢复案例 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/jiessie.png"
                alt="Jiessie" />
            
              <p class="site-author-name" itemprop="name">Jiessie</p>
              <p class="site-description motion-element" itemprop="description">最怕一生碌碌无为,还说平凡难能可贵！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">25</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.percona.com/" target="_blank" title="Percona">
                      
                        <i class="fa fa-fw fa-globe"></i>Percona</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://mariadb.com/kb/zh-cn/mariadb/" target="_blank" title="MariaDB">
                      
                        <i class="fa fa-fw fa-globe"></i>MariaDB</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysqlserverteam.com/" target="_blank" title="serverteam">
                      
                        <i class="fa fa-fw fa-globe"></i>serverteam</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysqlhighavailability.com/" target="_blank" title="highavailability">
                      
                        <i class="fa fa-fw fa-globe"></i>highavailability</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysql.taobao.org/monthly/" target="_blank" title="淘宝月报">
                      
                        <i class="fa fa-fw fa-globe"></i>淘宝月报</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://dimitrik.free.fr/blog/" target="_blank" title="dimitrik">
                      
                        <i class="fa fa-fw fa-globe"></i>dimitrik</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA简介"><span class="nav-number">2.</span> <span class="nav-text">MHA简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备"><span class="nav-number">3.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统初始化修改"><span class="nav-number">4.</span> <span class="nav-text">系统初始化修改</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#修改主机名"><span class="nav-number">4.1.</span> <span class="nav-text">修改主机名</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库修改主机名"><span class="nav-number">4.1.1.</span> <span class="nav-text">主库修改主机名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库修改主机名"><span class="nav-number">4.1.2.</span> <span class="nav-text">从库修改主机名</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改时区"><span class="nav-number">4.2.</span> <span class="nav-text">修改时区</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置防火墙"><span class="nav-number">4.3.</span> <span class="nav-text">设置防火墙</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库设置，允许从库访问"><span class="nav-number">4.3.1.</span> <span class="nav-text">主库设置，允许从库访问</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库设置，允许主库访问"><span class="nav-number">4.3.2.</span> <span class="nav-text">从库设置，允许主库访问</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭SELINUX"><span class="nav-number">4.4.</span> <span class="nav-text">关闭SELINUX</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立SSH无密码登录"><span class="nav-number">5.</span> <span class="nav-text">建立SSH无密码登录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主库设置"><span class="nav-number">5.1.</span> <span class="nav-text">主库设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从库设置"><span class="nav-number">5.2.</span> <span class="nav-text">从库设置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL安装"><span class="nav-number">6.</span> <span class="nav-text">MySQL安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL互为主备"><span class="nav-number">7.</span> <span class="nav-text">MySQL互为主备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#重要参数配置"><span class="nav-number">7.1.</span> <span class="nav-text">重要参数配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制帐号建立"><span class="nav-number">7.2.</span> <span class="nav-text">复制帐号建立</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库创建"><span class="nav-number">7.2.1.</span> <span class="nav-text">主库创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库创建"><span class="nav-number">7.2.2.</span> <span class="nav-text">从库创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#复制帐号验证"><span class="nav-number">7.2.3.</span> <span class="nav-text">复制帐号验证</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制关系配置"><span class="nav-number">7.3.</span> <span class="nav-text">复制关系配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库配置"><span class="nav-number">7.3.1.</span> <span class="nav-text">主库配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库配置"><span class="nav-number">7.3.2.</span> <span class="nav-text">从库配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制测试"><span class="nav-number">7.4.</span> <span class="nav-text">复制测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库登录测试"><span class="nav-number">7.4.1.</span> <span class="nav-text">主库登录测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库登录测试"><span class="nav-number">7.4.2.</span> <span class="nav-text">从库登录测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHA帐号建立"><span class="nav-number">7.5.</span> <span class="nav-text">MHA帐号建立</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库创建-1"><span class="nav-number">7.5.1.</span> <span class="nav-text">主库创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库创建-1"><span class="nav-number">7.5.2.</span> <span class="nav-text">从库创建</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA安装"><span class="nav-number">8.</span> <span class="nav-text">MHA安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装依赖"><span class="nav-number">8.1.</span> <span class="nav-text">安装依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主库安装mha4mysql-node"><span class="nav-number">8.2.</span> <span class="nav-text">主库安装mha4mysql-node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从库安装mha4mysql-manager和mha4mysql-node"><span class="nav-number">8.3.</span> <span class="nav-text">从库安装mha4mysql-manager和mha4mysql-node</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA目录结构说明"><span class="nav-number">9.</span> <span class="nav-text">MHA目录结构说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MHAManager"><span class="nav-number">9.1.</span> <span class="nav-text">MHAManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHANode"><span class="nav-number">9.2.</span> <span class="nav-text">MHANode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义扩展脚本说明"><span class="nav-number">9.3.</span> <span class="nav-text">自定义扩展脚本说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA扩展脚本"><span class="nav-number">10.</span> <span class="nav-text">MHA扩展脚本</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#aws-vip-change-sh"><span class="nav-number">10.1.</span> <span class="nav-text">aws_vip_change.sh</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#master-ip-failover"><span class="nav-number">10.2.</span> <span class="nav-text">master_ip_failover</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#send-report"><span class="nav-number">10.3.</span> <span class="nav-text">send_report</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#主库手动绑定ENI和实例关系"><span class="nav-number">11.</span> <span class="nav-text">主库手动绑定ENI和实例关系</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#从库配置MHAManager"><span class="nav-number">12.</span> <span class="nav-text">从库配置MHAManager</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试MHAManager-SSH"><span class="nav-number">13.</span> <span class="nav-text">测试MHAManager SSH</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#测试MHAManager-复制"><span class="nav-number">14.</span> <span class="nav-text">测试MHAManager 复制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#启动MHAManager"><span class="nav-number">15.</span> <span class="nav-text">启动MHAManager</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#启动进程"><span class="nav-number">15.1.</span> <span class="nav-text">启动进程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看启动日志"><span class="nav-number">15.2.</span> <span class="nav-text">查看启动日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模拟主库故障"><span class="nav-number">16.</span> <span class="nav-text">模拟主库故障</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#确认当前VIP状态"><span class="nav-number">16.1.</span> <span class="nav-text">确认当前VIP状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#确认MHAManger进程状态"><span class="nav-number">16.2.</span> <span class="nav-text">确认MHAManger进程状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#停止主库服务，触发主库FailOver"><span class="nav-number">16.3.</span> <span class="nav-text">停止主库服务，触发主库FailOver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#观察FailOver日志"><span class="nav-number">16.4.</span> <span class="nav-text">观察FailOver日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志过程解析"><span class="nav-number">16.5.</span> <span class="nav-text">日志过程解析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#确认FailOver状态"><span class="nav-number">16.6.</span> <span class="nav-text">确认FailOver状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看邮件发送状态"><span class="nav-number">16.7.</span> <span class="nav-text">查看邮件发送状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手动FailOver"><span class="nav-number">16.8.</span> <span class="nav-text">手动FailOver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参数列表"><span class="nav-number">16.9.</span> <span class="nav-text">参数列表</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#详情解释"><span class="nav-number">16.9.1.</span> <span class="nav-text">详情解释</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">17.</span> <span class="nav-text">参考</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结束语"><span class="nav-number">18.</span> <span class="nav-text">结束语</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiessie</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

</body>
</html>
