<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="MySQL,Aliyun,ECS,VIP,MHA,Keepalived," />





  <link rel="alternate" href="/atom.xml" title="Jiessie's' Blog" type="application/atom+xml" />






<meta name="description" content="前言随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在Aliyun ECS结合MHA做MySQL的高可用，ECS不支持VIP，但阿里的产品高可用虚拟IP（HaVip）">
<meta name="keywords" content="MySQL,Aliyun,ECS,VIP,MHA,Keepalived">
<meta property="og:type" content="article">
<meta property="og:title" content="Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7">
<meta property="og:url" content="https://dwj999.github.io/Aliyun-ECS搭建MHA-Keepalived-VIP-MySQL5-7.html">
<meta property="og:site_name" content="Jiessie&#39;s&#39; Blog">
<meta property="og:description" content="前言随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在Aliyun ECS结合MHA做MySQL的高可用，ECS不支持VIP，但阿里的产品高可用虚拟IP（HaVip）">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://note.youdao.com/yws/public/resource/eed85389475569ba15ce22e5a266d5fb/xmlnote/E0CF3D2D9BE747299B2348C6AD4EAD30/37915">
<meta property="og:updated_time" content="2020-05-20T03:22:11.264Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7">
<meta name="twitter:description" content="前言随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在Aliyun ECS结合MHA做MySQL的高可用，ECS不支持VIP，但阿里的产品高可用虚拟IP（HaVip）">
<meta name="twitter:image" content="http://note.youdao.com/yws/public/resource/eed85389475569ba15ce22e5a266d5fb/xmlnote/E0CF3D2D9BE747299B2348C6AD4EAD30/37915">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dwj999.github.io/Aliyun-ECS搭建MHA-Keepalived-VIP-MySQL5-7.html"/>





  <title>Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7 | Jiessie's' Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jiessie's' Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">没伞的孩子必须努力奔跑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/Aliyun-ECS搭建MHA-Keepalived-VIP-MySQL5-7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-11T13:53:19+08:00">
                2017-10-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/集群高可用/" itemprop="url" rel="index">
                    <span itemprop="name">集群高可用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在Aliyun ECS结合MHA做MySQL的高可用，ECS不支持VIP，但阿里的产品高可用虚拟IP（HaVip）结合keepliaved等第三方软件可间接实现ip的漂移，可满足我们的需求。</p>
<h2 id="MHA简介"><a href="#MHA简介" class="headerlink" title="MHA简介"></a>MHA简介</h2><p>MHA是由日本MySQL专家youshimaton(现就职于Facebook公司)用Perl写的一套MySQL故障切换方案，以保障数据库的高可用性。在MySQL故障切换过程中，MHA能做到在0~30s之内实现主MySQL故障转移。<br>该软件由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）。MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p>
<h2 id="高可用虚拟IP限制"><a href="#高可用虚拟IP限制" class="headerlink" title="高可用虚拟IP限制"></a>高可用虚拟IP限制</h2><ul>
<li>每个VPC中最多只能同时存在5个vip对象</li>
<li>目前VPC中的网络通信不支持多播和广播，只支持单播；所以，如果用户是使用keepalived之类的第三方软件实现高可用，需要通过配置文件把通信方式改成单播；网上可以找到相应的方法 </li>
<li>如果是使用keepalived之类的第三方软件，需要把信条消息的源IP改成ECS的私网IP（而不要用HaVip的私网IP进行心跳检查），不然很容易造成脑裂</li>
<li>当HaVip与EIP绑定后，进行公网通信时，持有HaVip的ECS实例应该通过HaVip的私网ip进行公网通信（而不是ECS自己的私网IP）；因为这时EIP是映射在HaVip的私网IP上，而不是映射在ECS的私网IP上</li>
<li>类似的，当使用HaVip做自建SNAT网关的高可用时，SNAT实例上配置的SNAT规则中，source IP应该是havip的私网IP而不是自己的private IP</li>
</ul>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：Linux Centos 6.5<br>master：192.168.16.80<br>slave: 192.168.16.81<br>vip: 192.168.16.82  （<font color="#FF0000">注：需要和HaVip的私网IP一致</font>）<br>其中，使用两台机器，分别部署主库和从库，MHA默认部署在从库上，下方中的VIP通EIP，最终是要把EIP和HaVip绑定在一起  </p>
<h2 id="系统初始化修改"><a href="#系统初始化修改" class="headerlink" title="系统初始化修改"></a>系统初始化修改</h2><h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><h4 id="主库修改主机名"><a href="#主库修改主机名" class="headerlink" title="主库修改主机名"></a>主库修改主机名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/sysconfig/network|grep HOSTNAME</span><br><span class="line">HOSTNAME=master</span><br><span class="line">[root@master ~]# cat /etc/hosts|grep master</span><br><span class="line">192.168.16.80 master</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<h4 id="从库修改主机名"><a href="#从库修改主机名" class="headerlink" title="从库修改主机名"></a>从库修改主机名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/sysconfig/network|grep HOSTNAME</span><br><span class="line">HOSTNAME=slave</span><br><span class="line">[root@slave ~]# cat /etc/hosts|grep slave</span><br><span class="line">192.168.16.81 slave</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<h3 id="设置防火墙"><a href="#设置防火墙" class="headerlink" title="设置防火墙"></a>设置防火墙</h3><h4 id="主库设置，允许从库访问"><a href="#主库设置，允许从库访问" class="headerlink" title="主库设置，允许从库访问"></a>主库设置，允许从库访问</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/iptables status|grep 192.168.16.81</span><br><span class="line">11   ACCEPT     all  --  192.168.16.81        0.0.0.0/0           </span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<p>其中，192.168.16.81是允许从库的访问规则</p>
<h4 id="从库设置，允许主库访问"><a href="#从库设置，允许主库访问" class="headerlink" title="从库设置，允许主库访问"></a>从库设置，允许主库访问</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# /etc/init.d/iptables status|grep 192.168.16.80</span><br><span class="line">11   ACCEPT     all  --  192.168.16.80        0.0.0.0/0           </span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<p>其中，192.168.16.80是允许主库的访问规则</p>
<h3 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h3><h4 id="主库查看"><a href="#主库查看" class="headerlink" title="主库查看"></a>主库查看</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/sysconfig/selinux |grep -v &apos;#&apos; |grep &apos;SELINUX=&apos; </span><br><span class="line">SELINUX=disabled</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<h4 id="从库查看"><a href="#从库查看" class="headerlink" title="从库查看"></a>从库查看</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/sysconfig/selinux |grep -v &apos;#&apos; |grep &apos;SELINUX=&apos; </span><br><span class="line">SELINUX=disabled</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<h2 id="建立SSH无密码登录"><a href="#建立SSH无密码登录" class="headerlink" title="建立SSH无密码登录"></a>建立SSH无密码登录</h2><h3 id="主库设置"><a href="#主库设置" class="headerlink" title="主库设置"></a>主库设置</h3><p>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,同时AllowUsers把root也添加上,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# sed &apos;/^#/d;/^$/d&apos; /etc/ssh/ssh_config |grep GSSAPIAuthentication</span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root@master ~]# sed &apos;/^#/d;/^$/d&apos; /etc/ssh/sshd_config |grep -E &apos;PasswordAuthentication|PermitRootLogin&apos;</span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root@master ~]# /etc/init.d/sshd restart</span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line">[root@master ~]# cat /etc/hosts.allow |grep 192.168.16.81</span><br><span class="line">sshd: 192.168.16.81</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ssh-keygen </span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Created directory &apos;/root/.ssh&apos;.</span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">07:86:76:d6:4a:0f:ea:6e:88:00:eb:3d:5f:7e:08:7a root@master</span><br><span class="line">The key&apos;s randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|                 |</span><br><span class="line">|       . .       |</span><br><span class="line">|      o B .      |</span><br><span class="line">|.    . * =       |</span><br><span class="line">|..    . S o      |</span><br><span class="line">|o    o   .       |</span><br><span class="line">|......o..        |</span><br><span class="line">| ..+.E+. .       |</span><br><span class="line">|    +o...        |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@master ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.81</span><br><span class="line">The authenticity of host &apos;192.168.16.81 (192.168.16.81)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is 9f:1f:41:f6:2d:e9:20:83:30:be:cd:20:01:31:ea:6d.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &apos;192.168.16.81&apos; (RSA) to the list of known hosts.</span><br><span class="line">root@192.168.16.81&apos;s password: </span><br><span class="line">Now try logging into the machine, with &quot;ssh &apos;root@192.168.16.81&apos;&quot;, and check in:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">to make sure we haven&apos;t added extra keys that you weren&apos;t expecting.</span><br><span class="line"></span><br><span class="line">[root@master ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.80</span><br><span class="line">The authenticity of host &apos;192.168.16.80 (192.168.16.80)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is f2:f8:7d:7d:59:3f:b9:3c:a0:e6:66:54:1f:79:e2:40.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root@192.168.16.80&apos;s password: </span><br><span class="line">Now try logging into the machine, with &quot;ssh &apos;root@192.168.16.80&apos;&quot;, and check in:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">to make sure we haven&apos;t added extra keys that you weren&apos;t expecting.</span><br><span class="line"></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<p>测试登录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ssh root@192.168.16.81</span><br><span class="line">Last login: Wed Oct 11 14:45:10 2017 from 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome to aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@slave ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection to 192.168.16.81 closed.</span><br><span class="line">[root@master ~]# ssh root@192.168.16.80</span><br><span class="line">Last login: Wed Jan 18 16:25:59 2017</span><br><span class="line"></span><br><span class="line">Welcome to aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@master ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection to 192.168.16.80 closed.</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="从库设置"><a href="#从库设置" class="headerlink" title="从库设置"></a>从库设置</h3><p>和主库保持一致<br>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,同时AllowUsers把root也添加上,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# sed &apos;/^#/d;/^$/d&apos; /etc/ssh/ssh_config |grep GSSAPIAuthentication</span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root@slave ~]# sed &apos;/^#/d;/^$/d&apos; /etc/ssh/sshd_config |grep -E &apos;PasswordAuthentication|PermitRootLogin&apos;</span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root@slave ~]# /etc/init.d/sshd restart</span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line">[root@slave ~]# cat /etc/hosts.allow |grep 192.168.16.80</span><br><span class="line">sshd: 192.168.16.80</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ssh-keygen </span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">ae:04:32:4d:3e:d3:b7:5d:4e:d2:50:7a:4c:44:d7:0a root@slave</span><br><span class="line">The key&apos;s randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|           o= .. |</span><br><span class="line">|           =E.  .|</span><br><span class="line">|    .     o o. . |</span><br><span class="line">|   + .     +  .  |</span><br><span class="line">|  o * . S . +    |</span><br><span class="line">|   o + o o =     |</span><br><span class="line">|      . o . .    |</span><br><span class="line">|     . .         |</span><br><span class="line">|      .          |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@slave ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.80</span><br><span class="line">The authenticity of host &apos;192.168.16.80 (192.168.16.80)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is f2:f8:7d:7d:59:3f:b9:3c:a0:e6:66:54:1f:79:e2:40.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &apos;192.168.16.80&apos; (RSA) to the list of known hosts.</span><br><span class="line">root@192.168.16.80&apos;s password: </span><br><span class="line">Now try logging into the machine, with &quot;ssh &apos;root@192.168.16.80&apos;&quot;, and check in:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">to make sure we haven&apos;t added extra keys that you weren&apos;t expecting.</span><br><span class="line"></span><br><span class="line">[root@slave ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.81</span><br><span class="line">The authenticity of host &apos;192.168.16.81 (192.168.16.81)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is 9f:1f:41:f6:2d:e9:20:83:30:be:cd:20:01:31:ea:6d.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &apos;192.168.16.81&apos; (RSA) to the list of known hosts.</span><br><span class="line">root@192.168.16.81&apos;s password: </span><br><span class="line">Now try logging into the machine, with &quot;ssh &apos;root@192.168.16.81&apos;&quot;, and check in:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">to make sure we haven&apos;t added extra keys that you weren&apos;t expecting.</span><br><span class="line"></span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<p>测试登录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ssh root@192.168.16.80</span><br><span class="line">Last login: Wed Oct 11 14:48:14 2017 from 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome to aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@master ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection to 192.168.16.80 closed.</span><br><span class="line">[root@slave ~]# ssh root@192.168.16.81</span><br><span class="line">Last login: Wed Oct 11 14:48:10 2017 from 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome to aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@slave ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection to 192.168.16.81 closed.</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL安装"><a href="#MySQL安装" class="headerlink" title="MySQL安装"></a>MySQL安装</h2><p>使用的是自己打包的RPM包，分别登录主库和从库，直接rpm -ivh percona-server-5.7.18-15.x86_64.rpm 即可，也可使用其他方式安装MySQL<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mv /home/duanwenjie/percona-server-5.7.18-15.x86_64.rpm /usr/src/</span><br><span class="line">[root@master ~]# rpm -ivh /usr/src/percona-server-5.7.18-15.x86_64.rpm </span><br><span class="line">Preparing...                ########################################### [100%]</span><br><span class="line">Group &apos;mail&apos; not found. Creating the user mailbox file with 0600 mode.</span><br><span class="line">   1:percona-server         ########################################### [100%]</span><br><span class="line">error reading information on service /etc/rc.d/init.d/mysqld: No such file or directory</span><br><span class="line">MySQL (Percona Server) PID file could not be found![FAILED]</span><br><span class="line">Starting MySQL (Percona Server)...[  OK  ]</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Warning: Since password will be sent to server in plain text, use ssl connection to ensure password safety.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<p>查看是否安装成功,分别登录主库和从库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 12</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:03:27 &gt; select version();</span><br><span class="line">+---------------+</span><br><span class="line">| version()     |</span><br><span class="line">+---------------+</span><br><span class="line">| 5.7.18-15-log |</span><br><span class="line">+---------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:03:31 &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL互为主备"><a href="#MySQL互为主备" class="headerlink" title="MySQL互为主备"></a>MySQL互为主备</h2><h3 id="重要参数配置"><a href="#重要参数配置" class="headerlink" title="重要参数配置"></a>重要参数配置</h3><p>主库必须包含以下参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 1</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 1</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br></pre></td></tr></table></figure></p>
<p>从库必须包含以下参数，注意slave需要动态设置read_only=1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 2</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 2</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br><span class="line">relay_log_purge=0</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e &quot;show variables like &apos;read_only&apos;&quot;</span><br><span class="line">Enter password: </span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| read_only     | OFF   |</span><br><span class="line">+---------------+-------+</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e &quot;set global read_only=1&quot;</span><br><span class="line">Enter password: </span><br><span class="line">[root@slave ~]# mysql -uroot -p -e &quot;show variables like &apos;read_only&apos;&quot;</span><br><span class="line">Enter password: </span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| read_only     | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="复制帐号建立"><a href="#复制帐号建立" class="headerlink" title="复制帐号建立"></a>复制帐号建立</h3><p>由于MySQL版本使用的是5.7，创建用户的方法以之前有些不同</p>
<h4 id="主库创建"><a href="#主库创建" class="headerlink" title="主库创建"></a>主库创建</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 4</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:09:37 &gt; create user &apos;slave01&apos;@&apos;192.168.16.81&apos; identified by &apos;slave123456&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:10:13 &gt; grant replication slave,replication client on *.* to &apos;slave01&apos;@&apos;192.168.16.81&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:10:39 &gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:10:42 &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<h4 id="从库创建"><a href="#从库创建" class="headerlink" title="从库创建"></a>从库创建</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:11:18 &gt; create user &apos;slave01&apos;@&apos;192.168.16.80&apos; identified by &apos;slave123456&apos;; </span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:11:30 &gt; grant replication slave,replication client on *.* to &apos;slave01&apos;@&apos;192.168.16.80&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:11:40 &gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:11:43 &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<h3 id="复制帐号验证"><a href="#复制帐号验证" class="headerlink" title="复制帐号验证"></a>复制帐号验证</h3><p>主库登录从库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uslave01 -pslave123456 -h192.168.16.81 -e &quot;select version()&quot; </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+---------------+</span><br><span class="line">| version()     |</span><br><span class="line">+---------------+</span><br><span class="line">| 5.7.18-15-log |</span><br><span class="line">+---------------+</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<p>从库登录主库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uslave01 -pslave123456 -h192.168.16.80 -e &quot;select version()&quot; </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+---------------+</span><br><span class="line">| version()     |</span><br><span class="line">+---------------+</span><br><span class="line">| 5.7.18-15-log |</span><br><span class="line">+---------------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="复制关系配置"><a href="#复制关系配置" class="headerlink" title="复制关系配置"></a>复制关系配置</h3><h4 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h4><p>登录主库，设置复制关系，来源于从库的复制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 6</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:14:07 &gt; change master to master_host=&apos;192.168.16.81&apos;,master_user=&apos;slave01&apos;,master_password=&apos;slave123456&apos;,master_auto_position=1;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.03 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:14:46 &gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:14:49 &gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.16.81</span><br><span class="line">                  Master_User: slave01</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 812</span><br><span class="line">               Relay_Log_File: master-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 1025</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 812</span><br><span class="line">              Relay_Log_Space: 1233</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 2</span><br><span class="line">                  Master_UUID: e1ec82e8-ae51-11e7-8532-00163e128057</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: e1ec82e8-ae51-11e7-8532-00163e128057:1-3</span><br><span class="line">            Executed_Gtid_Set: df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3,</span><br><span class="line">e1ec82e8-ae51-11e7-8532-00163e128057:1-3</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:14:56 &gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h4><p>登录从库，设置复制关系，来源于主库的复制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 11</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:15:42 &gt; change master to master_host=&apos;192.168.16.80&apos;,master_user=&apos;slave01&apos;,master_password=&apos;slave123456&apos;,master_auto_position=1;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.05 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:15:53 &gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:15:55 &gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.16.80</span><br><span class="line">                  Master_User: slave01</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 1470</span><br><span class="line">               Relay_Log_File: slave-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 1072</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 1470</span><br><span class="line">              Relay_Log_Space: 1279</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: df5051fc-ae51-11e7-85ee-00163e0f0e4a</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3</span><br><span class="line">            Executed_Gtid_Set: df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3,</span><br><span class="line">e1ec82e8-ae51-11e7-8532-00163e128057:1-3</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:16:00 &gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="复制测试"><a href="#复制测试" class="headerlink" title="复制测试"></a>复制测试</h3><h4 id="主库登录测试"><a href="#主库登录测试" class="headerlink" title="主库登录测试"></a>主库登录测试</h4><p>登录主库，插入测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MySQL [test11] 15:17:10 &gt; create table if not exists t11(id int unsigned not null auto_increment,name varchar(20),primary key(`id`));</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:17:20 &gt; insert into t11 values(null,&apos;master11&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:17:28 &gt; select * from t11;</span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | master11 |</span><br><span class="line">+----+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>登录从库，查看测试数据，此时数据已经复制过来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p test11 -e &quot;select * from t11&quot;</span><br><span class="line">Enter password: </span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | master11 |</span><br><span class="line">+----+----------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h4 id="从库登录测试"><a href="#从库登录测试" class="headerlink" title="从库登录测试"></a>从库登录测试</h4><p>登录从库，插入测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 15:18:56 &gt; create database if not exists test11;use test11;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] 15:19:20 &gt; create table if not exists t22(id int unsigned not null auto_increment,name varchar(20),primary key(`id`));</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:38 &gt; insert into t22 values(null,&apos;slave11&apos;); </span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:43 &gt; select * from t22;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  2 | slave11 |</span><br><span class="line">+----+---------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:51 &gt;</span><br></pre></td></tr></table></figure></p>
<p>登录主库，查看测试数据，此时数据已经复制过来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p test11 -e &quot;select * from t22&quot;</span><br><span class="line">Enter password: </span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  2 | slave11 |</span><br><span class="line">+----+---------+</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="MHA帐号创建"><a href="#MHA帐号创建" class="headerlink" title="MHA帐号创建"></a>MHA帐号创建</h3><h4 id="主库创建-1"><a href="#主库创建-1" class="headerlink" title="主库创建"></a>主库创建</h4><p>登录主库，创建允许主库和从库连接的MHA用户信息，再分别尝试使用MHA用户登录(省略)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 29</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:23:16 &gt; create user &apos;mha01&apos;@&apos;192.168.16.81&apos; identified by &apos;mha123456&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:24:02 &gt; grant all privileges on *.* to &apos;mha01&apos;@&apos;192.168.16.81&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:24:27 &gt; create user &apos;mha01&apos;@&apos;192.168.16.80&apos; identified by &apos;mha123456&apos;; </span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:24:35 &gt; grant all privileges on *.* to &apos;mha01&apos;@&apos;192.168.16.80&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:24:41 &gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="从库创建-1"><a href="#从库创建-1" class="headerlink" title="从库创建"></a>从库创建</h4><p>登录从库，由于复制已经把在主库创建的MHA用户信息复制了过来，尝试登录即可(省略)</p>
<h2 id="MHA安装"><a href="#MHA安装" class="headerlink" title="MHA安装"></a>MHA安装</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>分别在主库和从库上安装，执行命令：<br>yum -y install gcc gcc-c++ make openssl-devel perl perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Config-IniFiles perl-Time-HiRes perl-Module-Install.noarch mailx jwhois cpan  </p>
<h3 id="主库安装mha4mysql-node"><a href="#主库安装mha4mysql-node" class="headerlink" title="主库安装mha4mysql-node"></a>主库安装mha4mysql-node</h3><p>MHA管理端安装在从库上，主库上只需要mha4mysql-node即可，由于MySQL使用5.7版本，MHA也使用最新的0.57版本，采用编译安装方式。下载地址：<a href="https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw" target="_blank" rel="noopener">https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd /usr/src/</span><br><span class="line">[root@master src]# tar -zxf mha4mysql-node-0.57.tar.gz</span><br><span class="line">[root@master mha4mysql-node-0.57]# perl Makefile.PL             #编译过程省略</span><br><span class="line">[root@master mha4mysql-node-0.57]# make</span><br><span class="line">[root@master mha4mysql-node-0.57]# make install</span><br><span class="line">[root@master mha4mysql-node-0.57]# ll /usr/local/bin/ -t        #查看安装，有以下文件则mha4mysql-node安装成功</span><br><span class="line">total 1760</span><br><span class="line">-r-xr-xr-x 1 root root  16381 Jul 21 09:41 apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x 1 root root   8261 Jul 21 09:41 purge_relay_logs</span><br><span class="line">-r-xr-xr-x 1 root root   7525 Jul 21 09:41 save_binary_logs</span><br><span class="line">-r-xr-xr-x 1 root root   4807 Jul 21 09:41 filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p>
<h3 id="从库安装mha4mysql-manager和mha4mysql-node"><a href="#从库安装mha4mysql-manager和mha4mysql-node" class="headerlink" title="从库安装mha4mysql-manager和mha4mysql-node"></a>从库安装mha4mysql-manager和mha4mysql-node</h3><p>MHA管理端安装在从库，从库需要安装manager端和node端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cd /usr/src/</span><br><span class="line">[root@slave src]# tar -zxf mha4mysql-manager-0.57.tar.gz </span><br><span class="line">[root@slave src]# cd mha4mysql-manager-0.57</span><br><span class="line">[root@slave mha4mysql-manager-0.57]# perl Makefile.PL           #编译过程省略</span><br><span class="line">[root@slave mha4mysql-manager-0.57]# make</span><br><span class="line">[root@slave mha4mysql-manager-0.57]# make install </span><br><span class="line">[root@slave mha4mysql-manager-0.57]# ll /usr/local/bin/ -t      #查看安装，有以下文件则mha4mysql-manager安装成功</span><br><span class="line">total 40</span><br><span class="line">-r-xr-xr-x 1 root root 1779 Oct 11 15:45 masterha_check_ssh</span><br><span class="line">-r-xr-xr-x 1 root root 2517 Oct 11 15:45 masterha_manager</span><br><span class="line">-r-xr-xr-x 1 root root 2373 Oct 11 15:45 masterha_master_switch</span><br><span class="line">-r-xr-xr-x 1 root root 5171 Oct 11 15:45 masterha_secondary_check</span><br><span class="line">-r-xr-xr-x 1 root root 1995 Oct 11 15:45 masterha_check_repl</span><br><span class="line">-r-xr-xr-x 1 root root 1865 Oct 11 15:45 masterha_check_status</span><br><span class="line">-r-xr-xr-x 1 root root 3201 Oct 11 15:45 masterha_conf_host</span><br><span class="line">-r-xr-xr-x 1 root root 2165 Oct 11 15:45 masterha_master_monitor</span><br><span class="line">-r-xr-xr-x 1 root root 1739 Oct 11 15:45 masterha_stop</span><br><span class="line">[root@slave mha4mysql-manager-0.57]# cd ..</span><br><span class="line">[root@slave src]# tar -zxf mha4mysql-node-0.57.tar.gz </span><br><span class="line">[root@slave src]# cd mha4mysql-node-0.57</span><br><span class="line">[root@slave mha4mysql-node-0.57]# perl Makefile.PL              #编译过程省略        </span><br><span class="line">[root@slave mha4mysql-node-0.57]# make</span><br><span class="line">[root@slave mha4mysql-node-0.57]# make install</span><br><span class="line">[root@slave mha4mysql-node-0.57]# ll /usr/local/bin/ -t         #查看安装，有以下文件则mha4mysql-node安装成功</span><br><span class="line">total 84</span><br><span class="line">-r-xr-xr-x 1 root root 16381 Oct 11 15:47 apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x 1 root root  4807 Oct 11 15:47 filter_mysqlbinlog</span><br><span class="line">-r-xr-xr-x 1 root root  8261 Oct 11 15:47 purge_relay_logs</span><br><span class="line">-r-xr-xr-x 1 root root  7525 Oct 11 15:47 save_binary_logs</span><br></pre></td></tr></table></figure></p>
<h2 id="MHA目录结构说明"><a href="#MHA目录结构说明" class="headerlink" title="MHA目录结构说明"></a>MHA目录结构说明</h2><h3 id="MHAManager"><a href="#MHAManager" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>mhamanager工具包主要包括以下工具<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@slave  ~]# ll /usr/local/bin/</span><br><span class="line">总用量 40</span><br><span class="line">-r-xr-xr-x  1 root root  1995 Oct 11 15:45 masterha_check_repl         #检查MySQL复制情况</span><br><span class="line">-r-xr-xr-x  1 root root  1779 Oct 11 15:45 masterha_check_ssh          #检查MHA的SSH配置情况</span><br><span class="line">-r-xr-xr-x  1 root root  1865 Oct 11 15:45 masterha_check_status       #检测当前MHA运行状态</span><br><span class="line">-r-xr-xr-x  1 root root  3201 Oct 11 15:45 masterha_conf_host          #添加或删除配置的server信息</span><br><span class="line">-r-xr-xr-x  1 root root  2517 Oct 11 15:45 masterha_manager            #启动MHA</span><br><span class="line">-r-xr-xr-x  1 root root  2165 Oct 11 15:45 masterha_master_monitor     #检测Master是否宕机</span><br><span class="line">-r-xr-xr-x  1 root root  2373 Oct 11 15:45 masterha_master_switch      #控制故障转移，自动或者手动</span><br><span class="line">-r-xr-xr-x  1 root root  5172 Oct 11 15:45 masterha_secondary_check    #通过其他路由检测Master是否真的宕机</span><br><span class="line">-r-xr-xr-x  1 root root  1739 Oct 11 15:45 masterha_stop               #停止MHA</span><br></pre></td></tr></table></figure></p>
<h3 id="MHANode"><a href="#MHANode" class="headerlink" title="MHANode"></a>MHANode</h3><p>mhanode工具包主要包括以下工具<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ll /usr/local/bin/ -t   </span><br><span class="line">total 84</span><br><span class="line">-r-xr-xr-x  1 root root 16371 Oct 11 15:47 apply_diff_relay_logs       #识别差异日志的中继日志，并将其差异事件应用于其他Slave</span><br><span class="line">-r-xr-xr-x  1 root root  4807 Oct 11 15:47 filter_mysqlbinlog          #去除不必要的Rollback事件</span><br><span class="line">-r-xr-xr-x  1 root root  8263 Oct 11 15:47 purge_relay_logs            #删除无用的Relay log，避免延时</span><br><span class="line">-r-xr-xr-x  1 root root  7525 Oct 11 15:47 save_binary_logs            #保存和复制down掉的主服务器二进制日志</span><br></pre></td></tr></table></figure></p>
<h3 id="自定义扩展脚本说明"><a href="#自定义扩展脚本说明" class="headerlink" title="自定义扩展脚本说明"></a>自定义扩展脚本说明</h3><p>secondary_check_script #通过多条网络路由检测master的可用性<br>master_ip_failover_script #自动failover时候的切换脚本，可将vip信息写入此脚本中<br>shutdown_script #强制关闭master节点执行脚本<br>report_script #发送报告<br>init_conf_load_script #加载初始配置参数，如不想在配置中写明文密码<br>master_ip_online_change_script #手动failover时候的切换脚本  </p>
<h2 id="keepalived安装"><a href="#keepalived安装" class="headerlink" title="keepalived安装"></a>keepalived安装</h2><p>MHA作为MySQL的HA软件,借助脚本或者第三方软件如keepalived,可实现自动的failover<br>本次环境使用yum安装keepalived,主库和从库分别执行安装: yum -y install keepalived<br>keepalived的配置文件,默认在主库上绑定EIP,priority要比备库高,同时为了避免脑裂,两个state同时设置为BACKUP,由于HaVip不支持组播和广播通讯,因此需要将keepalived的心跳方式设置为单播,添加unicast_src_ip和unicast_peer</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><h4 id="主库配置-1"><a href="#主库配置-1" class="headerlink" title="主库配置"></a>主库配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     duanwenjie@huan.tv</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.16.82 dev eth0 label eth0:havip</span><br><span class="line">    &#125;</span><br><span class="line">        unicast_src_ip 192.168.16.80</span><br><span class="line">        unicast_peer &#123;</span><br><span class="line">                192.168.16.81</span><br><span class="line">                        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="从库配置-1"><a href="#从库配置-1" class="headerlink" title="从库配置"></a>从库配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     duanwenjie@huan.tv</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.16.82 dev eth0 label eth0:havip</span><br><span class="line">    &#125;</span><br><span class="line">        unicast_src_ip 192.168.16.81</span><br><span class="line">        unicast_peer &#123;</span><br><span class="line">                192.168.16.80</span><br><span class="line">                        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="EIP漂移测试"><a href="#EIP漂移测试" class="headerlink" title="EIP漂移测试"></a>EIP漂移测试</h3><p>分别启动keepalived服务，查看默认EIP在哪台机器上，同时关闭EIP所在机器的keepalived服务，查看EIP是否漂移，最后恢复原状</p>
<h4 id="主库启动keepalived服务"><a href="#主库启动keepalived服务" class="headerlink" title="主库启动keepalived服务"></a>主库启动keepalived服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master keepalived]# /etc/init.d/keepalived start</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@master keepalived]#</span><br></pre></td></tr></table></figure>
<h4 id="从库启动keepalived服务"><a href="#从库启动keepalived服务" class="headerlink" title="从库启动keepalived服务"></a>从库启动keepalived服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave keepalived]# /etc/init.d/keepalived start</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@slave keepalived]#</span><br></pre></td></tr></table></figure>
<h4 id="查看默认EIP在主库上"><a href="#查看默认EIP在主库上" class="headerlink" title="查看默认EIP在主库上"></a>查看默认EIP在主库上</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.80  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:172562 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:71674 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:200695958 (191.3 MiB)  TX bytes:12526649 (11.9 MiB)</span><br><span class="line"></span><br><span class="line">eth0:havip Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.82  Bcast:0.0.0.0  Mask:255.255.255.255</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:7946 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:7946 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:510910 (498.9 KiB)  TX bytes:510910 (498.9 KiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<h4 id="关闭主库的keepalived服务"><a href="#关闭主库的keepalived服务" class="headerlink" title="关闭主库的keepalived服务"></a>关闭主库的keepalived服务</h4><p>关闭主库的keepalived服务后，EIP消失<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/keepalived stop</span><br><span class="line">Stopping keepalived:                                       [  OK  ]</span><br><span class="line">[root@master ~]# ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.80  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:172670 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:71803 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:200704346 (191.4 MiB)  TX bytes:12569281 (11.9 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:7976 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:7976 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:512770 (500.7 KiB)  TX bytes:512770 (500.7 KiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h4 id="查看EIP是否漂移到从库上"><a href="#查看EIP是否漂移到从库上" class="headerlink" title="查看EIP是否漂移到从库上"></a>查看EIP是否漂移到从库上</h4><p>此时EIP已经漂移到从库上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:12:80:57  </span><br><span class="line">          inet addr:192.168.16.81  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:164539 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:77532 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:202145589 (192.7 MiB)  TX bytes:12091265 (11.5 MiB)</span><br><span class="line"></span><br><span class="line">eth0:havip Link encap:Ethernet  HWaddr 00:16:3E:12:80:57  </span><br><span class="line">          inet addr:192.168.16.82  Bcast:0.0.0.0  Mask:255.255.255.255</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:7961 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:7961 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:508050 (496.1 KiB)  TX bytes:508050 (496.1 KiB)</span><br><span class="line"></span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h4 id="恢复原状"><a href="#恢复原状" class="headerlink" title="恢复原状"></a>恢复原状</h4><p>主库启动keepalived服务，查看EIP已经又漂移回来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/keepalived start</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@master ~]# ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.80  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:172863 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:71978 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:200717148 (191.4 MiB)  TX bytes:12627987 (12.0 MiB)</span><br><span class="line"></span><br><span class="line">eth0:havip Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.82  Bcast:0.0.0.0  Mask:255.255.255.255</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:8039 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:8039 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:516676 (504.5 KiB)  TX bytes:516676 (504.5 KiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h2 id="MHA配置"><a href="#MHA配置" class="headerlink" title="MHA配置"></a>MHA配置</h2><h3 id="MHAManager-1"><a href="#MHAManager-1" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>创建配置目录/etc/masterha/，同时创建一个项目上的配置文件，仅配置自动FailOver部分，脚本暂时不定义，下文会有MHA引入keepalived。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[server default]</span><br><span class="line">manager_workdir=/var/log/masterha/app1   </span><br><span class="line">manager_log=/var/log/masterha/app1/manager.log </span><br><span class="line">master_binlog_dir=/hwdata/data/percona        </span><br><span class="line">password=mha123456                             </span><br><span class="line">user=mha01                                     </span><br><span class="line">ping_interval=1                                    </span><br><span class="line">remote_workdir=/tmp                                                </span><br><span class="line">repl_password=slave123456                                          </span><br><span class="line">repl_user=slave01                                                 </span><br><span class="line">ssh_user=root                                                     </span><br><span class="line">#master_ip_failover_script=/usr/local/bin/master_ip_failover        </span><br><span class="line">#master_ip_online_change_script= /usr/local/bin/master_ip_online_change  </span><br><span class="line">#report_script=/usr/local/bin/send_report                         </span><br><span class="line">#shutdown_script=                                                 </span><br><span class="line">secondary_check_script = masterha_secondary_check -s 192.168.16.80 -s 192.168.16.81 --user=root hostname=192.168.16.80  --master_ip=192.168.16.80 --master_port=3306 </span><br><span class="line">[server1]</span><br><span class="line">hostname=192.168.16.80                                          </span><br><span class="line">port=3306</span><br><span class="line">[server2]</span><br><span class="line">hostname=192.168.16.81                                         </span><br><span class="line">port=3306</span><br><span class="line">candidate_master=1</span><br></pre></td></tr></table></figure></p>
<h3 id="测试MHAManager-SSH"><a href="#测试MHAManager-SSH" class="headerlink" title="测试MHAManager SSH"></a>测试MHAManager SSH</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_ssh --conf=/etc/masterha/app1.cnf </span><br><span class="line">Wed Oct 11 17:21:46 2017 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Oct 11 17:21:46 2017 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Oct 11 17:21:46 2017 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Oct 11 17:21:46 2017 - [info] Starting SSH connection tests..</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [debug] </span><br><span class="line">Wed Oct 11 17:21:46 2017 - [debug]  Connecting via SSH from root@192.168.16.80(192.168.16.80:22) to root@192.168.16.81(192.168.16.81:22)..</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [debug]   ok.</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [debug] </span><br><span class="line">Wed Oct 11 17:21:47 2017 - [debug]  Connecting via SSH from root@192.168.16.81(192.168.16.81:22) to root@192.168.16.80(192.168.16.80:22)..</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [debug]   ok.</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [info] All SSH connection tests passed successfully.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h3 id="测试MHAManager-复制"><a href="#测试MHAManager-复制" class="headerlink" title="测试MHAManager 复制"></a>测试MHAManager 复制</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_repl --conf=/etc/masterha/app1.cnf</span><br><span class="line">Wed Oct 11 17:22:47 2017 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Oct 11 17:22:47 2017 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Oct 11 17:22:47 2017 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Oct 11 17:22:47 2017 - [info] MHA::MasterMonitor version 0.57.</span><br><span class="line">Creating directory /var/log/masterha/app1.. done.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Multi-master configuration is detected. Current primary(writable) master is 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Master configurations are as below: </span><br><span class="line">Master 192.168.16.81(192.168.16.81:3306), replicating from 192.168.16.80(192.168.16.80:3306), read-only</span><br><span class="line">Master 192.168.16.80(192.168.16.80:3306), replicating from 192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] GTID failover mode = 1</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Dead Servers:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Alive Servers:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]   192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]   192.168.16.81(192.168.16.81:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Alive Slaves:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]   192.168.16.81(192.168.16.81:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]     GTID ON</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]     Replicating from 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Current Alive Master: 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Checking slave configurations..</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Checking replication filtering settings..</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]  Replication filtering check ok.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] HealthCheck: SSH to 192.168.16.80 is reachable.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] </span><br><span class="line">192.168.16.80(192.168.16.80:3306) (current master)</span><br><span class="line"> +--192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Checking replication health on 192.168.16.81..</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]  ok.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [warning] master_ip_failover_script is not defined.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [warning] shutdown_script is not defined.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Got exit code 0 (Not master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health is OK.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h2 id="MHA引入keepalived"><a href="#MHA引入keepalived" class="headerlink" title="MHA引入keepalived"></a>MHA引入keepalived</h2><p>把keepalived服务引入MHA，需要修改切换是触发的脚本文件master_ip_failover即可，在该脚本中添加在master发生宕机时对keepalived的处理。</p>
<h3 id="master-ip-failover脚本"><a href="#master-ip-failover脚本" class="headerlink" title="master_ip_failover脚本"></a>master_ip_failover脚本</h3><p>编辑脚本/usr/local/bin/master_ip_failover，修改后如下，这里完整的脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# cat /usr/local/bin/master_ip_failover </span><br><span class="line">#!/usr/bin/env perl</span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; &apos;all&apos;;</span><br><span class="line"></span><br><span class="line">use Getopt::Long;</span><br><span class="line"></span><br><span class="line">my (</span><br><span class="line">    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,</span><br><span class="line">    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">my $vip = &apos;192.168.16.82&apos;;</span><br><span class="line">my $ssh_start_vip = &quot;/etc/init.d/keepalived start&quot;;</span><br><span class="line">my $ssh_stop_vip = &quot;/etc/init.d/keepalived stop&quot;;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    &apos;command=s&apos;          =&gt; \$command,</span><br><span class="line">    &apos;ssh_user=s&apos;         =&gt; \$ssh_user,</span><br><span class="line">    &apos;orig_master_host=s&apos; =&gt; \$orig_master_host,</span><br><span class="line">    &apos;orig_master_ip=s&apos;   =&gt; \$orig_master_ip,</span><br><span class="line">    &apos;orig_master_port=i&apos; =&gt; \$orig_master_port,</span><br><span class="line">    &apos;new_master_host=s&apos;  =&gt; \$new_master_host,</span><br><span class="line">    &apos;new_master_ip=s&apos;    =&gt; \$new_master_ip,</span><br><span class="line">    &apos;new_master_port=i&apos;  =&gt; \$new_master_port,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">exit &amp;main();</span><br><span class="line"></span><br><span class="line">sub main &#123;</span><br><span class="line"></span><br><span class="line">    print &quot;\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n&quot;;</span><br><span class="line"></span><br><span class="line">    if ( $command eq &quot;stop&quot; || $command eq &quot;stopssh&quot; ) &#123;</span><br><span class="line"></span><br><span class="line">        my $exit_code = 1;</span><br><span class="line">        eval &#123;</span><br><span class="line">            print &quot;Disabling the VIP on old master: $orig_master_host \n&quot;;</span><br><span class="line">            &amp;stop_vip();</span><br><span class="line">            $exit_code = 0;</span><br><span class="line">        &#125;;</span><br><span class="line">        if ($@) &#123;</span><br><span class="line">            warn &quot;Got Error: $@\n&quot;;</span><br><span class="line">            exit $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        exit $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( $command eq &quot;start&quot; ) &#123;</span><br><span class="line"></span><br><span class="line">        my $exit_code = 10;</span><br><span class="line">        eval &#123;</span><br><span class="line">            print &quot;Enabling the VIP - $vip on the new master - $new_master_host \n&quot;;</span><br><span class="line">            &amp;start_vip();</span><br><span class="line">            $exit_code = 0;</span><br><span class="line">        &#125;;</span><br><span class="line">        if ($@) &#123;</span><br><span class="line">            warn $@;</span><br><span class="line">            exit $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        exit $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( $command eq &quot;status&quot; ) &#123;</span><br><span class="line">        print &quot;Checking the Status of the script.. OK \n&quot;;</span><br><span class="line">        #`ssh $ssh_user\@$orig_master_ip \&quot; $ssh_start_vip \&quot;`;</span><br><span class="line">        exit 0;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        &amp;usage();</span><br><span class="line">        exit 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># A simple system call that enable the VIP on the new master</span><br><span class="line">sub start_vip() &#123;</span><br><span class="line">    `ssh $ssh_user\@$new_master_host \&quot; $ssh_start_vip \&quot;`;</span><br><span class="line">&#125;</span><br><span class="line"># A simple system call that disable the VIP on the old_master</span><br><span class="line">sub stop_vip() &#123;</span><br><span class="line">     return 0  unless  ($ssh_user);</span><br><span class="line">    `ssh $ssh_user\@$orig_master_host \&quot; $ssh_stop_vip \&quot;`;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub usage &#123;</span><br><span class="line">    print</span><br><span class="line">    &quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure></p>
<p>添加权限<br>chmod +x /usr/local/bin/master_ip_failover</p>
<h3 id="send-report脚本"><a href="#send-report脚本" class="headerlink" title="send_report脚本"></a>send_report脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# cat /usr/local/bin/send_report </span><br><span class="line">#!/usr/bin/perl</span><br><span class="line"> </span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; &apos;all&apos;;</span><br><span class="line">use Mail::Sender;</span><br><span class="line">use Getopt::Long;</span><br><span class="line"> </span><br><span class="line">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span><br><span class="line">my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );</span><br><span class="line">my $smtp=&apos;smtp.126.com&apos;;</span><br><span class="line">my $mail_from=&apos;xxx@126.com&apos;;</span><br><span class="line">my $mail_user=&apos;xxx@126.com&apos;;</span><br><span class="line">my $mail_pass=&apos;xxx&apos;;</span><br><span class="line">#my $mail_to=[&apos;xxx&apos;,&apos;xxx&apos;];</span><br><span class="line">my $mail_to=&apos;xxx&apos;;</span><br><span class="line">GetOptions(</span><br><span class="line">  &apos;orig_master_host=s&apos; =&gt; \$dead_master_host,</span><br><span class="line">  &apos;new_master_host=s&apos;  =&gt; \$new_master_host,</span><br><span class="line">  &apos;new_slave_hosts=s&apos;  =&gt; \$new_slave_hosts,</span><br><span class="line">  &apos;subject=s&apos;          =&gt; \$subject,</span><br><span class="line">  &apos;body=s&apos;             =&gt; \$body,</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);</span><br><span class="line"> </span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_;</span><br><span class="line">    open my $DEBUG, &quot;&gt; /var/log/masterha/app1/manager.log&quot;</span><br><span class="line">        or die &quot;Can&apos;t open the debug      file:$!\n&quot;;</span><br><span class="line">    my $sender = new Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; &apos;text/plain; charset=utf-8&apos;,</span><br><span class="line">        encoding    =&gt; &apos;utf-8&apos;,</span><br><span class="line">        smtp        =&gt; $smtp,</span><br><span class="line">        from        =&gt; $mail_from,</span><br><span class="line">        auth        =&gt; &apos;LOGIN&apos;,</span><br><span class="line">        TLS_allowed =&gt; &apos;0&apos;,</span><br><span class="line">        authid      =&gt; $user,</span><br><span class="line">        authpwd     =&gt; $passwd,</span><br><span class="line">        to          =&gt; $mail_to,</span><br><span class="line">        subject     =&gt; $subject,</span><br><span class="line">        debug       =&gt; $DEBUG</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    $sender-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; $msg,</span><br><span class="line">            debug =&gt; $DEBUG</span><br><span class="line">        &#125;</span><br><span class="line">    ) or print $Mail::Sender::Error;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"># Do whatever you want here</span><br><span class="line"> </span><br><span class="line">exit 0;</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<p>添加权限<br>chmod +x /usr/local/bin/send_report</p>
<h3 id="MHAManager修改注释"><a href="#MHAManager修改注释" class="headerlink" title="MHAManager修改注释"></a>MHAManager修改注释</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# cat /etc/masterha/app1.cnf |grep master_ip_failover_script</span><br><span class="line">master_ip_failover_script=/usr/local/bin/master_ip_failover        </span><br><span class="line">[root@slave app1]# cat /etc/masterha/app1.cnf |grep report</span><br><span class="line">report_script=/usr/local/bin/send_report                         </span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure>
<h2 id="HaVip绑定EIP"><a href="#HaVip绑定EIP" class="headerlink" title="HaVip绑定EIP"></a>HaVip绑定EIP</h2><p>keepalived服务已经配置完成，VIP也可以自动漂移后，但是其还不能在内网中通讯，需要将EIP映射到HaVip中，创建高可用虚拟IP，把master和slave两个实例的绑定在一起，具体步骤省略，见下图<br><img src="http://note.youdao.com/yws/public/resource/eed85389475569ba15ce22e5a266d5fb/xmlnote/E0CF3D2D9BE747299B2348C6AD4EAD30/37915" alt="image"></p>
<h2 id="MHA启动"><a href="#MHA启动" class="headerlink" title="MHA启动"></a>MHA启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;</span><br><span class="line">[1] 6706</span><br><span class="line">[root@slave masterha]# nohup: ignoring input and appending output to `nohup.out&apos;</span><br></pre></td></tr></table></figure>
<h3 id="查看启动日志"><a href="#查看启动日志" class="headerlink" title="查看启动日志"></a>查看启动日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# cat /var/log/masterha/app1/manager.log</span><br><span class="line">Thu Oct 12 09:26:56 2017 - [info] MHA::MasterMonitor version 0.57.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Multi-master configuration is detected. Current primary(writable) master is 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Master configurations are as below: </span><br><span class="line">Master 192.168.16.81(192.168.16.81:3306), replicating from 192.168.16.80(192.168.16.80:3306), read-only</span><br><span class="line">Master 192.168.16.80(192.168.16.80:3306), replicating from 192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] GTID failover mode = 1</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Dead Servers:</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Alive Servers:</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]   192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]   192.168.16.81(192.168.16.81:3306)</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Alive Slaves:</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]   192.168.16.81(192.168.16.81:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]     GTID ON</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]     Replicating from 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Current Alive Master: 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Checking slave configurations..</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Checking replication filtering settings..</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]  Replication filtering check ok.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] HealthCheck: SSH to 192.168.16.80 is reachable.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] </span><br><span class="line">192.168.16.80(192.168.16.80:3306) (current master)</span><br><span class="line"> +--192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=192.168.16.80 --orig_master_ip=192.168.16.80 --orig_master_port=3306 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]  OK.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [warning] shutdown_script is not defined.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Set master ping interval 1 seconds.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Set secondary check script: masterha_secondary_check -s 192.168.16.80 -s 192.168.16.81 --user=root hostname=192.168.16.80  --master_ip=192.168.16.80 --master_port=3306</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Starting ping health check on 192.168.16.80(192.168.16.80:3306)..</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn&apos;t respond..</span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure>
<h2 id="模拟主库故障-自动FailOver"><a href="#模拟主库故障-自动FailOver" class="headerlink" title="模拟主库故障(自动FailOver)"></a>模拟主库故障(自动FailOver)</h2><h3 id="确认MHAManager进程状态"><a href="#确认MHAManager进程状态" class="headerlink" title="确认MHAManager进程状态"></a>确认MHAManager进程状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# ps aux|grep master</span><br><span class="line">root      1217  0.0  0.0  81520  3440 ?        Ss   Oct11   0:00 /usr/libexec/postfix/master</span><br><span class="line">root     20887  0.2  0.4 194688 18736 pts/1    S    08:57   0:00 perl /usr/local/bin/masterha_manager --conf=/etc/masterha/app1.cnf</span><br><span class="line">root     20998  0.0  0.0 103252   844 pts/1    S+   08:59   0:00 grep master</span><br><span class="line">[root@slave app1]# ifconfig     #VIP不在slave上</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:12:80:57  </span><br><span class="line">          inet addr:192.168.16.81  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:288188 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:129868 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:211584573 (201.7 MiB)  TX bytes:50227849 (47.9 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:50346 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:50346 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:3204922 (3.0 MiB)  TX bytes:3204922 (3.0 MiB)</span><br><span class="line"></span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure>
<h3 id="停止主库MySQL服务"><a href="#停止主库MySQL服务" class="headerlink" title="停止主库MySQL服务"></a>停止主库MySQL服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ifconfig   #停止前VIP存在于主库上</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.80  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:278061 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:223278 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:210643899 (200.8 MiB)  TX bytes:57552395 (54.8 MiB)</span><br><span class="line"></span><br><span class="line">eth0:havip Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.82  Bcast:0.0.0.0  Mask:255.255.255.255</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:50158 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:50158 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:3130070 (2.9 MiB)  TX bytes:3130070 (2.9 MiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]# /etc/init.d/mysqld stop</span><br><span class="line">Shutting down MySQL (Percona Server)............           [  OK  ]</span><br><span class="line">[root@master ~]# ifconfig   #停止后VIP已经漂移走</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.80  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:278240 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:223445 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:210664827 (200.9 MiB)  TX bytes:57596785 (54.9 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:50175 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:50175 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:3131100 (2.9 MiB)  TX bytes:3131100 (2.9 MiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<h3 id="查看FailOver日志"><a href="#查看FailOver日志" class="headerlink" title="查看FailOver日志"></a>查看FailOver日志</h3><p>登录从库，查看MHAManager日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# tail -f /var/log/masterha/app1/manager.log</span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]  OK.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [warning] shutdown_script is not defined.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Set master ping interval 1 seconds.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Set secondary check script: masterha_secondary_check -s 192.168.16.80 -s 192.168.16.81 --user=root hostname=192.168.16.80  --master_ip=192.168.16.80 --master_port=3306</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Starting ping health check on 192.168.16.80(192.168.16.80:3306)..</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn&apos;t respond..     #开始监听服务状态</span><br><span class="line">#监控到master故障后，MHA开始做自动FailOver</span><br><span class="line">Thu Oct 12 09:27:54 2017 - [warning] Got error on MySQL select ping: 2006 (MySQL server has gone away)</span><br><span class="line">Thu Oct 12 09:27:54 2017 - [info] Executing secondary network check script: masterha_secondary_check -s 192.168.16.80 -s 192.168.16.81 --user=root hostname=192.168.16.80  --master_ip=192.168.16.80 --master_port=3306  --user=root  --master_host=192.168.16.80  --master_ip=192.168.16.80  --master_port=3306 --master_user=mha01 --master_password=mha123456 --ping_type=SELECT</span><br><span class="line">Thu Oct 12 09:27:54 2017 - [info] Executing SSH check script: exit 0</span><br><span class="line">Thu Oct 12 09:27:54 2017 - [info] HealthCheck: SSH to 192.168.16.80 is reachable.</span><br><span class="line">Monitoring server 192.168.16.80 is reachable, Master is not reachable from 192.168.16.80. OK.</span><br><span class="line">Monitoring server 192.168.16.81 is reachable, Master is not reachable from 192.168.16.81. OK.</span><br><span class="line">Thu Oct 12 09:27:54 2017 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span><br><span class="line">Thu Oct 12 09:27:55 2017 - [warning] Got error on MySQL connect: 2013 (Lost connection to MySQL server at &apos;reading initial communication packet&apos;, system error: 111)</span><br><span class="line">Thu Oct 12 09:27:55 2017 - [warning] Connection failed 2 time(s)..</span><br><span class="line">Thu Oct 12 09:27:56 2017 - [warning] Got error on MySQL connect: 2013 (Lost connection to MySQL server at &apos;reading initial communication packet&apos;, system error: 111)</span><br><span class="line">Thu Oct 12 09:27:56 2017 - [warning] Connection failed 3 time(s)..</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [warning] Got error on MySQL connect: 2013 (Lost connection to MySQL server at &apos;reading initial communication packet&apos;, system error: 111)</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [warning] Connection failed 4 time(s)..</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [warning] Master is not reachable from health checker!</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [warning] Master 192.168.16.80(192.168.16.80:3306) is not reachable!</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [warning] SSH is reachable.</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha_default.cnf and /etc/masterha/app1.cnf again, and trying to connect to all servers to check server status..</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] GTID failover mode = 1</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Dead Servers:</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info]   192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Alive Servers:</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info]   192.168.16.81(192.168.16.81:3306)</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Alive Slaves:</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info]   192.168.16.81(192.168.16.81:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info]     GTID ON</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info]     Replicating from 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Checking slave configurations..</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Checking replication filtering settings..</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info]  Replication filtering check ok.</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Master is down!</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Terminating monitoring script.</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Got exit code 20 (Master dead).</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] MHA::MasterFailover version 0.57.</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Starting master failover.</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] * Phase 1: Configuration Check Phase..</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] GTID failover mode = 1</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Dead Servers:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Checking master reachability via MySQL(double check)...</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  ok.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Alive Servers:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   192.168.16.81(192.168.16.81:3306)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Alive Slaves:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   192.168.16.81(192.168.16.81:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     GTID ON</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Replicating from 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Starting GTID based failover.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] ** Phase 1: Configuration Check Phase completed.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 2: Dead Master Shutdown Phase..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Forcing shutdown so that applications never connect to the current master..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Executing master IP deactivation script:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   /usr/local/bin/master_ip_failover --orig_master_host=192.168.16.80 --orig_master_ip=192.168.16.80 --orig_master_port=3306 --command=stopssh --ssh_user=root  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Disabling the VIP on old master: 192.168.16.80 </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  done.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 3: Master Recovery Phase..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] The latest binary log file/position on all slaves is mysql-bin.000005:234</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Latest slaves (Slaves that received relay log files to the latest):</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   192.168.16.81(192.168.16.81:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     GTID ON</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Replicating from 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] The oldest binary log file/position on all slaves is mysql-bin.000005:234</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Oldest slaves:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   192.168.16.81(192.168.16.81:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     GTID ON</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Replicating from 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 3.3: Determining New Master Phase..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Searching new master from slaves..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  Candidate masters from the configuration file:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   192.168.16.81(192.168.16.81:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     GTID ON</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Replicating from 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  Non-candidate masters:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] New master is 192.168.16.81(192.168.16.81:3306)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Starting master failover..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">From:</span><br><span class="line">192.168.16.80(192.168.16.80:3306) (current master)</span><br><span class="line"> +--192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">To:</span><br><span class="line">192.168.16.81(192.168.16.81:3306) (new master)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 3.3: New Master Recovery Phase..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  Waiting all logs to be applied.. </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   done.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Getting new master&apos;s binlog name and position..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  mysql-bin.000002:4876</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&apos;192.168.16.81&apos;, MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER=&apos;slave01&apos;, MASTER_PASSWORD=&apos;xxx&apos;;</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000002, 4876, df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-15,</span><br><span class="line">e1ec82e8-ae51-11e7-8532-00163e128057:1-6</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Executing master IP activate script:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   /usr/local/bin/master_ip_failover --command=start --ssh_user=root --orig_master_host=192.168.16.80 --orig_master_ip=192.168.16.80 --orig_master_port=3306 --new_master_host=192.168.16.81 --new_master_ip=192.168.16.81 --new_master_port=3306 --new_master_user=&apos;mha01&apos;   --new_master_password=xxx</span><br><span class="line">Unknown option: new_master_user</span><br><span class="line">Unknown option: new_master_password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Enabling the VIP - 192.168.16.200 on the new master - 192.168.16.81 </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  OK.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Setting read_only=0 on 192.168.16.81(192.168.16.81:3306)..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  ok.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] ** Finished master recovery successfully.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 3: Master Recovery Phase completed.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 4: Slaves Recovery Phase..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 4.1: Starting Slaves in parallel..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] All new slave servers recovered successfully.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 5: New master cleanup phase..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Resetting slave info on the new master..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  192.168.16.81: Resetting slave info succeeded.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Master failover to 192.168.16.81(192.168.16.81:3306) completed successfully.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line"></span><br><span class="line">----- Failover Report -----</span><br><span class="line"></span><br><span class="line">app1: MySQL Master failover 192.168.16.80(192.168.16.80:3306) to 192.168.16.81(192.168.16.81:3306) succeeded</span><br><span class="line"></span><br><span class="line">Master 192.168.16.80(192.168.16.80:3306) is down!</span><br><span class="line"></span><br><span class="line">Check MHA Manager logs at slave:/var/log/masterha/app1/manager.log for details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated master IP address on 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Selected 192.168.16.81(192.168.16.81:3306) as a new master.</span><br><span class="line">192.168.16.81(192.168.16.81:3306): OK: Applying all logs succeeded.</span><br><span class="line">192.168.16.81(192.168.16.81:3306): OK: Activated master IP address.</span><br><span class="line">192.168.16.81(192.168.16.81:3306): Resetting slave info succeeded.</span><br><span class="line">Master failover to 192.168.16.81(192.168.16.81:3306) completed successfully.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Sending mail..</span><br><span class="line">Option new_slave_hosts requires an argument</span><br><span class="line">Unknown option: conf</span><br><span class="line">tail: /var/log/masterha/app1/manager.log: file truncated</span><br><span class="line">^C</span><br><span class="line">[1]+  Done                    nohup masterha_manager --conf=/etc/masterha/app1.cnf  (wd: /etc/masterha)</span><br><span class="line">(wd now: /var/log/masterha/app1)</span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure></p>
<p><font color="#FF0000">注意：<br>由于阿里云的ECS默认不允许发送邮件，它们把25端口已经封掉，如果需要开通25端口，主联系阿里云技术支持。本次切换日志在最后没有发送邮件，是由于这个原因导致的。</font></p>
<h3 id="日志解析过程"><a href="#日志解析过程" class="headerlink" title="日志解析过程"></a>日志解析过程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">启动前的准备工作</span><br><span class="line">检查数据库服务器状态,获取相关参数设置</span><br><span class="line">检查GTID、candidate_master、过滤DB是否设置</span><br><span class="line">测试ssh连接是否成功</span><br><span class="line">测试MHA node是否可用</span><br><span class="line">创建MHA日志目录</span><br><span class="line">开始检查slave的差异日志应用权限</span><br><span class="line">确定当前的复制架构</span><br><span class="line">调试master_ip_failover_script</span><br><span class="line">调试shutdown_script</span><br><span class="line">设置二次检查的主机masterha_secondary_check</span><br><span class="line">MHA启动完毕,进入监测状态</span><br><span class="line">监测master服务器挂了</span><br><span class="line">通过定义的二次监测,确认master是否挂了</span><br><span class="line">确认master挂了,开始进入failover流程</span><br><span class="line">再试尝试连接master和master的ssh</span><br><span class="line">通过MHA配置文件,监测其他slave的状态</span><br><span class="line">再次监测slave的配置是否有变化,是否符合failover条件</span><br><span class="line">正式开始failover</span><br><span class="line">再次对slave配置做检查</span><br><span class="line">对原Master做master_ip_failover_script和shutdown_script的操作</span><br><span class="line">开始差异日志的恢复，获取slave最后得到的binlog位置</span><br><span class="line">获取原master的binlog日志</span><br><span class="line">确定新的master</span><br><span class="line">在new master上应用差异的binlog日志</span><br><span class="line">获取new master的binlog位置。</span><br><span class="line">执行master_ip_failover_script,调用aws_vip_change.sh，执行VIP漂移</span><br><span class="line">开始恢复其他slave的差异日志</span><br><span class="line">差异日志应用完成以后,切换所有slave到new master。</span><br><span class="line">failover操作完成,生成failover报告</span><br><span class="line">最后发送邮件通知</span><br></pre></td></tr></table></figure>
<h3 id="确认FailOver状态"><a href="#确认FailOver状态" class="headerlink" title="确认FailOver状态"></a>确认FailOver状态</h3><p>登录从库，查看VIP是否漂移过程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# ifconfig     #VIP已经漂移过程</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:12:80:57  </span><br><span class="line">          inet addr:192.168.16.81  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:295022 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:135929 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:212253710 (202.4 MiB)  TX bytes:52246361 (49.8 MiB)</span><br><span class="line"></span><br><span class="line">eth0:havip Link encap:Ethernet  HWaddr 00:16:3E:12:80:57  </span><br><span class="line">          inet addr:192.168.16.82  Bcast:0.0.0.0  Mask:255.255.255.255</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:52973 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:52973 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:3597938 (3.4 MiB)  TX bytes:3597938 (3.4 MiB)</span><br><span class="line"></span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure></p>
<p>登录主库，查看VIP是否存在，keepalived服务状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ifconfig   #VIP已经不存在</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.80  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:284277 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:229786 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:211190989 (201.4 MiB)  TX bytes:60010868 (57.2 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:51564 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:51564 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:3217146 (3.0 MiB)  TX bytes:3217146 (3.0 MiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]# /etc/init.d/keepalived status  #keepalived服务已经停止</span><br><span class="line">keepalived is stopped</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="手动FailOver"><a href="#手动FailOver" class="headerlink" title="手动FailOver"></a>手动FailOver</h3><p>MHA的手动FailOver不在本文范围，详情理论可参考官方文档。</p>
<h3 id="参数列表"><a href="#参数列表" class="headerlink" title="参数列表"></a>参数列表</h3><p>请参考之前<a href="https://dwj999.github.io/AWS-EC2%E6%90%AD%E5%BB%BAmha-vip-MySQL5-7.html#参数列表">文章</a>。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://dwj999.github.io/AWS-EC2搭建mha-vip-MySQL5-7.htm">https://dwj999.github.io/AWS-EC2搭建mha-vip-MySQL5-7.htm</a></p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>云服务器上MySQL高可用，也可通过云负载均衡产品+MySQL复制来实现，但在数据安全性上，没有MHA+VIP+MySQL相对安全。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MySQL/" rel="tag"># MySQL</a>
          
            <a href="/tags/Aliyun/" rel="tag"># Aliyun</a>
          
            <a href="/tags/ECS/" rel="tag"># ECS</a>
          
            <a href="/tags/VIP/" rel="tag"># VIP</a>
          
            <a href="/tags/MHA/" rel="tag"># MHA</a>
          
            <a href="/tags/Keepalived/" rel="tag"># Keepalived</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/误删除frm、ibd文件恢复案例.html" rel="next" title="误删除frm、ibd文件恢复案例">
                <i class="fa fa-chevron-left"></i> 误删除frm、ibd文件恢复案例
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/MySQL-Group-Replication初探.html" rel="prev" title="MySQL Group Replication初探">
                MySQL Group Replication初探 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jiessie</p>
              <p class="site-description motion-element" itemprop="description">最怕一生碌碌无为,还说平凡难能可贵！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA简介"><span class="nav-number">2.</span> <span class="nav-text">MHA简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高可用虚拟IP限制"><span class="nav-number">3.</span> <span class="nav-text">高可用虚拟IP限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备"><span class="nav-number">4.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统初始化修改"><span class="nav-number">5.</span> <span class="nav-text">系统初始化修改</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#修改主机名"><span class="nav-number">5.1.</span> <span class="nav-text">修改主机名</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库修改主机名"><span class="nav-number">5.1.1.</span> <span class="nav-text">主库修改主机名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库修改主机名"><span class="nav-number">5.1.2.</span> <span class="nav-text">从库修改主机名</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置防火墙"><span class="nav-number">5.2.</span> <span class="nav-text">设置防火墙</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库设置，允许从库访问"><span class="nav-number">5.2.1.</span> <span class="nav-text">主库设置，允许从库访问</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库设置，允许主库访问"><span class="nav-number">5.2.2.</span> <span class="nav-text">从库设置，允许主库访问</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭SELINUX"><span class="nav-number">5.3.</span> <span class="nav-text">关闭SELINUX</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库查看"><span class="nav-number">5.3.1.</span> <span class="nav-text">主库查看</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库查看"><span class="nav-number">5.3.2.</span> <span class="nav-text">从库查看</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立SSH无密码登录"><span class="nav-number">6.</span> <span class="nav-text">建立SSH无密码登录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主库设置"><span class="nav-number">6.1.</span> <span class="nav-text">主库设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从库设置"><span class="nav-number">6.2.</span> <span class="nav-text">从库设置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL安装"><span class="nav-number">7.</span> <span class="nav-text">MySQL安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL互为主备"><span class="nav-number">8.</span> <span class="nav-text">MySQL互为主备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#重要参数配置"><span class="nav-number">8.1.</span> <span class="nav-text">重要参数配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制帐号建立"><span class="nav-number">8.2.</span> <span class="nav-text">复制帐号建立</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库创建"><span class="nav-number">8.2.1.</span> <span class="nav-text">主库创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库创建"><span class="nav-number">8.2.2.</span> <span class="nav-text">从库创建</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制帐号验证"><span class="nav-number">8.3.</span> <span class="nav-text">复制帐号验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制关系配置"><span class="nav-number">8.4.</span> <span class="nav-text">复制关系配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库配置"><span class="nav-number">8.4.1.</span> <span class="nav-text">主库配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库配置"><span class="nav-number">8.4.2.</span> <span class="nav-text">从库配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制测试"><span class="nav-number">8.5.</span> <span class="nav-text">复制测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库登录测试"><span class="nav-number">8.5.1.</span> <span class="nav-text">主库登录测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库登录测试"><span class="nav-number">8.5.2.</span> <span class="nav-text">从库登录测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHA帐号创建"><span class="nav-number">8.6.</span> <span class="nav-text">MHA帐号创建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库创建-1"><span class="nav-number">8.6.1.</span> <span class="nav-text">主库创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库创建-1"><span class="nav-number">8.6.2.</span> <span class="nav-text">从库创建</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA安装"><span class="nav-number">9.</span> <span class="nav-text">MHA安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装依赖"><span class="nav-number">9.1.</span> <span class="nav-text">安装依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主库安装mha4mysql-node"><span class="nav-number">9.2.</span> <span class="nav-text">主库安装mha4mysql-node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从库安装mha4mysql-manager和mha4mysql-node"><span class="nav-number">9.3.</span> <span class="nav-text">从库安装mha4mysql-manager和mha4mysql-node</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA目录结构说明"><span class="nav-number">10.</span> <span class="nav-text">MHA目录结构说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MHAManager"><span class="nav-number">10.1.</span> <span class="nav-text">MHAManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHANode"><span class="nav-number">10.2.</span> <span class="nav-text">MHANode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义扩展脚本说明"><span class="nav-number">10.3.</span> <span class="nav-text">自定义扩展脚本说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#keepalived安装"><span class="nav-number">11.</span> <span class="nav-text">keepalived安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置文件"><span class="nav-number">11.1.</span> <span class="nav-text">配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库配置-1"><span class="nav-number">11.1.1.</span> <span class="nav-text">主库配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库配置-1"><span class="nav-number">11.1.2.</span> <span class="nav-text">从库配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EIP漂移测试"><span class="nav-number">11.2.</span> <span class="nav-text">EIP漂移测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库启动keepalived服务"><span class="nav-number">11.2.1.</span> <span class="nav-text">主库启动keepalived服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库启动keepalived服务"><span class="nav-number">11.2.2.</span> <span class="nav-text">从库启动keepalived服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看默认EIP在主库上"><span class="nav-number">11.2.3.</span> <span class="nav-text">查看默认EIP在主库上</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关闭主库的keepalived服务"><span class="nav-number">11.2.4.</span> <span class="nav-text">关闭主库的keepalived服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看EIP是否漂移到从库上"><span class="nav-number">11.2.5.</span> <span class="nav-text">查看EIP是否漂移到从库上</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#恢复原状"><span class="nav-number">11.2.6.</span> <span class="nav-text">恢复原状</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA配置"><span class="nav-number">12.</span> <span class="nav-text">MHA配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MHAManager-1"><span class="nav-number">12.1.</span> <span class="nav-text">MHAManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试MHAManager-SSH"><span class="nav-number">12.2.</span> <span class="nav-text">测试MHAManager SSH</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试MHAManager-复制"><span class="nav-number">12.3.</span> <span class="nav-text">测试MHAManager 复制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA引入keepalived"><span class="nav-number">13.</span> <span class="nav-text">MHA引入keepalived</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#master-ip-failover脚本"><span class="nav-number">13.1.</span> <span class="nav-text">master_ip_failover脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#send-report脚本"><span class="nav-number">13.2.</span> <span class="nav-text">send_report脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHAManager修改注释"><span class="nav-number">13.3.</span> <span class="nav-text">MHAManager修改注释</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HaVip绑定EIP"><span class="nav-number">14.</span> <span class="nav-text">HaVip绑定EIP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA启动"><span class="nav-number">15.</span> <span class="nav-text">MHA启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查看启动日志"><span class="nav-number">15.1.</span> <span class="nav-text">查看启动日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模拟主库故障-自动FailOver"><span class="nav-number">16.</span> <span class="nav-text">模拟主库故障(自动FailOver)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#确认MHAManager进程状态"><span class="nav-number">16.1.</span> <span class="nav-text">确认MHAManager进程状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#停止主库MySQL服务"><span class="nav-number">16.2.</span> <span class="nav-text">停止主库MySQL服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看FailOver日志"><span class="nav-number">16.3.</span> <span class="nav-text">查看FailOver日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志解析过程"><span class="nav-number">16.4.</span> <span class="nav-text">日志解析过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#确认FailOver状态"><span class="nav-number">16.5.</span> <span class="nav-text">确认FailOver状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手动FailOver"><span class="nav-number">16.6.</span> <span class="nav-text">手动FailOver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参数列表"><span class="nav-number">16.7.</span> <span class="nav-text">参数列表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">17.</span> <span class="nav-text">参考</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结束语"><span class="nav-number">18.</span> <span class="nav-text">结束语</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiessie</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
