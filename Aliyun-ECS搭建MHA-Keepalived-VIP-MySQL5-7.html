<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="MySQL,VIP,MHA,Aliyun,ECS,Keepalived," />





  <link rel="alternate" href="/atom.xml" title="Jiessie's' Blog" type="application/atom+xml" />






<meta name="description" content="前言随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在Aliyun ECS结合MHA做MySQL的高可用，ECS不支持VIP，但阿里的产品高可用虚拟IP（HaVip）">
<meta name="keywords" content="MySQL,VIP,MHA,Aliyun,ECS,Keepalived">
<meta property="og:type" content="article">
<meta property="og:title" content="Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7">
<meta property="og:url" content="https://dwj999.github.io/Aliyun-ECS搭建MHA-Keepalived-VIP-MySQL5-7.html">
<meta property="og:site_name" content="Jiessie&#39;s&#39; Blog">
<meta property="og:description" content="前言随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在Aliyun ECS结合MHA做MySQL的高可用，ECS不支持VIP，但阿里的产品高可用虚拟IP（HaVip）">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://note.youdao.com/yws/public/resource/eed85389475569ba15ce22e5a266d5fb/xmlnote/E0CF3D2D9BE747299B2348C6AD4EAD30/37915">
<meta property="og:updated_time" content="2020-05-20T03:22:11.264Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7">
<meta name="twitter:description" content="前言随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在Aliyun ECS结合MHA做MySQL的高可用，ECS不支持VIP，但阿里的产品高可用虚拟IP（HaVip）">
<meta name="twitter:image" content="http://note.youdao.com/yws/public/resource/eed85389475569ba15ce22e5a266d5fb/xmlnote/E0CF3D2D9BE747299B2348C6AD4EAD30/37915">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dwj999.github.io/Aliyun-ECS搭建MHA-Keepalived-VIP-MySQL5-7.html"/>





<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

  <title>Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7 | Jiessie's' Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/dwj999"><img width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_darkblue_121621.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jiessie's' Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">没伞的孩子必须努力奔跑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/Aliyun-ECS搭建MHA-Keepalived-VIP-MySQL5-7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-11T13:53:19+08:00">
                2017-10-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/集群高可用/" itemprop="url" rel="index">
                    <span itemprop="name">集群高可用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在Aliyun ECS结合MHA做MySQL的高可用，ECS不支持VIP，但阿里的产品高可用虚拟IP（HaVip）结合keepliaved等第三方软件可间接实现ip的漂移，可满足我们的需求。</p>
<h2 id="MHA简介"><a href="#MHA简介" class="headerlink" title="MHA简介"></a>MHA简介</h2><p>MHA是由日本MySQL专家youshimaton(现就职于Facebook公司)用Perl写的一套MySQL故障切换方案，以保障数据库的高可用性。在MySQL故障切换过程中，MHA能做到在0~30s之内实现主MySQL故障转移。<br>该软件由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）。MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p>
<h2 id="高可用虚拟IP限制"><a href="#高可用虚拟IP限制" class="headerlink" title="高可用虚拟IP限制"></a>高可用虚拟IP限制</h2><ul>
<li>每个VPC中最多只能同时存在5个vip对象</li>
<li>目前VPC中的网络通信不支持多播和广播，只支持单播；所以，如果用户是使用keepalived之类的第三方软件实现高可用，需要通过配置文件把通信方式改成单播；网上可以找到相应的方法 </li>
<li>如果是使用keepalived之类的第三方软件，需要把信条消息的源IP改成ECS的私网IP（而不要用HaVip的私网IP进行心跳检查），不然很容易造成脑裂</li>
<li>当HaVip与EIP绑定后，进行公网通信时，持有HaVip的ECS实例应该通过HaVip的私网ip进行公网通信（而不是ECS自己的私网IP）；因为这时EIP是映射在HaVip的私网IP上，而不是映射在ECS的私网IP上</li>
<li>类似的，当使用HaVip做自建SNAT网关的高可用时，SNAT实例上配置的SNAT规则中，source IP应该是havip的私网IP而不是自己的private IP</li>
</ul>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：Linux Centos 6.5<br>master：192.168.16.80<br>slave: 192.168.16.81<br>vip: 192.168.16.82  （<font color="#FF0000">注：需要和HaVip的私网IP一致</font>）<br>其中，使用两台机器，分别部署主库和从库，MHA默认部署在从库上，下方中的VIP通EIP，最终是要把EIP和HaVip绑定在一起  </p>
<h2 id="系统初始化修改"><a href="#系统初始化修改" class="headerlink" title="系统初始化修改"></a>系统初始化修改</h2><h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><h4 id="主库修改主机名"><a href="#主库修改主机名" class="headerlink" title="主库修改主机名"></a>主库修改主机名</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cat</span> /etc/sysconfig/network|grep HOSTNAME</span><br><span class="line"><span class="attr">HOSTNAME=</span><span class="literal">master</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cat</span> /etc/hosts|grep <span class="literal">master</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">16.80</span> <span class="literal">master</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]#</span></span><br></pre></td></tr></table></figure>
<h4 id="从库修改主机名"><a href="#从库修改主机名" class="headerlink" title="从库修改主机名"></a>从库修改主机名</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="literal">slave</span> ~]<span class="comment"># cat /etc/sysconfig/network|grep HOSTNAME</span></span><br><span class="line"><span class="attr">HOSTNAME=</span><span class="literal">slave</span></span><br><span class="line">[root@<span class="literal">slave</span> ~]<span class="comment"># cat /etc/hosts|grep slave</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">16.81</span> <span class="literal">slave</span></span><br><span class="line">[root@<span class="literal">slave</span> ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="设置防火墙"><a href="#设置防火墙" class="headerlink" title="设置防火墙"></a>设置防火墙</h3><h4 id="主库设置，允许从库访问"><a href="#主库设置，允许从库访问" class="headerlink" title="主库设置，允许从库访问"></a>主库设置，允许从库访问</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/iptables status|grep <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span></span><br><span class="line"><span class="number">11</span>   ACCEPT     all  --  <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>        <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>           </span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<p>其中，192.168.16.81是允许从库的访问规则</p>
<h4 id="从库设置，允许主库访问"><a href="#从库设置，允许主库访问" class="headerlink" title="从库设置，允许主库访问"></a>从库设置，允许主库访问</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# /etc/init.d/iptables status|grep <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span></span><br><span class="line"><span class="number">11</span>   ACCEPT     all  --  <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>        <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>           </span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<p>其中，192.168.16.80是允许主库的访问规则</p>
<h3 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h3><h4 id="主库查看"><a href="#主库查看" class="headerlink" title="主库查看"></a>主库查看</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@master</span> ~]<span class="meta"># cat /etc/sysconfig/selinux |grep -v <span class="string">'#'</span> |grep <span class="string">'SELINUX='</span> </span></span><br><span class="line">SELINUX=disabled</span><br><span class="line">[root<span class="symbol">@master</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure>
<h4 id="从库查看"><a href="#从库查看" class="headerlink" title="从库查看"></a>从库查看</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># cat /etc/sysconfig/selinux |grep -v <span class="string">'#'</span> |grep <span class="string">'SELINUX='</span> </span></span><br><span class="line">SELINUX=disabled</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure>
<h2 id="建立SSH无密码登录"><a href="#建立SSH无密码登录" class="headerlink" title="建立SSH无密码登录"></a>建立SSH无密码登录</h2><h3 id="主库设置"><a href="#主库设置" class="headerlink" title="主库设置"></a>主库设置</h3><p>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,同时AllowUsers把root也添加上,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# sed</span> '/^<span class="comment">#/d;/^$/d' /etc/ssh/ssh_config |grep GSSAPIAuthentication</span></span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# sed</span> '/^<span class="comment">#/d;/^$/d' /etc/ssh/sshd_config |grep -E 'PasswordAuthentication|PermitRootLogin'</span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# /etc</span>/init.d/sshd restart</span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cat</span> /etc/hosts.allow |grep <span class="number">192.168</span>.<span class="number">16.81</span></span><br><span class="line">sshd: <span class="number">192.168</span>.<span class="number">16.81</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]#</span></span><br></pre></td></tr></table></figure></p>
<p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="meta"># ssh-keygen </span></span><br><span class="line">Generating <span class="keyword">public</span>/<span class="keyword">private</span> rsa <span class="keyword">key</span> pair.</span><br><span class="line">Enter file <span class="keyword">in</span> which <span class="keyword">to</span> save the <span class="keyword">key</span> (/root/.ssh/id_rsa): </span><br><span class="line">Created directory <span class="comment">'/root/.ssh'.</span></span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your <span class="keyword">public</span> <span class="keyword">key</span> has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The <span class="keyword">key</span> fingerprint <span class="keyword">is</span>:</span><br><span class="line"><span class="number">07</span>:<span class="number">86</span>:<span class="number">76</span>:d6:<span class="number">4</span>a:<span class="number">0</span>f:ea:<span class="number">6</span>e:<span class="number">88</span>:<span class="number">00</span>:eb:<span class="number">3</span>d:<span class="number">5</span>f:<span class="number">7</span>e:<span class="number">08</span>:<span class="number">7</span>a root@master</span><br><span class="line">The <span class="keyword">key</span><span class="comment">'s randomart image is:</span></span><br><span class="line">+--[ RSA <span class="number">2048</span>]----+</span><br><span class="line">|                 |</span><br><span class="line">|       . .       |</span><br><span class="line">|      o B .      |</span><br><span class="line">|.    . * =       |</span><br><span class="line">|..    . S o      |</span><br><span class="line">|o    o   .       |</span><br><span class="line">|......o..        |</span><br><span class="line">| ..+.E+. .       |</span><br><span class="line">|    +o...        |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@master ~]<span class="meta"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.81</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">'192.168.16.81 (192.168.16.81)' can't be established.</span></span><br><span class="line">RSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> <span class="number">9</span>f:<span class="number">1</span>f:<span class="number">41</span>:f6:<span class="number">2</span>d:e9:<span class="number">20</span>:<span class="number">83</span>:<span class="number">30</span>:be:cd:<span class="number">20</span>:<span class="number">01</span>:<span class="number">31</span>:ea:<span class="number">6</span>d.</span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added <span class="comment">'192.168.16.81' (RSA) to the list of known hosts.</span></span><br><span class="line">root@<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span><span class="comment">'s password: </span></span><br><span class="line">Now <span class="keyword">try</span> logging <span class="keyword">into</span> the machine, <span class="keyword">with</span> <span class="string">"ssh 'root@192.168.16.81'"</span>, <span class="keyword">and</span> check <span class="keyword">in</span>:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="keyword">to</span> make sure we haven<span class="comment">'t added extra keys that you weren't expecting.</span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="meta"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.80</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">'192.168.16.80 (192.168.16.80)' can't be established.</span></span><br><span class="line">RSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> f2:f8:<span class="number">7</span>d:<span class="number">7</span>d:<span class="number">59</span>:<span class="number">3</span>f:b9:<span class="number">3</span>c:a0:e6:<span class="number">66</span>:<span class="number">54</span>:<span class="number">1</span>f:<span class="number">79</span>:e2:<span class="number">40.</span></span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">root@<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span><span class="comment">'s password: </span></span><br><span class="line">Now <span class="keyword">try</span> logging <span class="keyword">into</span> the machine, <span class="keyword">with</span> <span class="string">"ssh 'root@192.168.16.80'"</span>, <span class="keyword">and</span> check <span class="keyword">in</span>:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="keyword">to</span> make sure we haven<span class="comment">'t added extra keys that you weren't expecting.</span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p>
<p>测试登录<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ssh root@192.168.16.81</span><br><span class="line">Last login: Wed Oct 11 14:45:10 2017 <span class="keyword">from</span> 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome <span class="keyword">to</span> aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@slave ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection <span class="keyword">to</span> 192.168.16.81 closed.</span><br><span class="line">[root@master ~]# ssh root@192.168.16.80</span><br><span class="line">Last login: Wed Jan 18 16:25:59 2017</span><br><span class="line"></span><br><span class="line">Welcome <span class="keyword">to</span> aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@master ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection <span class="keyword">to</span> 192.168.16.80 closed.</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="从库设置"><a href="#从库设置" class="headerlink" title="从库设置"></a>从库设置</h3><p>和主库保持一致<br>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,同时AllowUsers把root也添加上,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接  </p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># sed <span class="string">'/^#/d;/^$/d'</span> /etc/ssh/ssh_config |grep GSSAPIAuthentication</span></span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># sed <span class="string">'/^#/d;/^$/d'</span> /etc/ssh/sshd_config |grep -E <span class="string">'PasswordAuthentication|PermitRootLogin'</span></span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># /etc/init.d/sshd restart</span></span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># cat /etc/hosts.allow |grep 192.168.16.80</span></span><br><span class="line">sshd: <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span></span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure>
<p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="meta"># ssh-keygen </span></span><br><span class="line">Generating <span class="keyword">public</span>/<span class="keyword">private</span> rsa <span class="keyword">key</span> pair.</span><br><span class="line">Enter file <span class="keyword">in</span> which <span class="keyword">to</span> save the <span class="keyword">key</span> (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your <span class="keyword">public</span> <span class="keyword">key</span> has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The <span class="keyword">key</span> fingerprint <span class="keyword">is</span>:</span><br><span class="line">ae:<span class="number">04</span>:<span class="number">32</span>:<span class="number">4</span>d:<span class="number">3</span>e:d3:b7:<span class="number">5</span>d:<span class="number">4</span>e:d2:<span class="number">50</span>:<span class="number">7</span>a:<span class="number">4</span>c:<span class="number">44</span>:d7:<span class="number">0</span>a root@slave</span><br><span class="line">The <span class="keyword">key</span><span class="comment">'s randomart image is:</span></span><br><span class="line">+--[ RSA <span class="number">2048</span>]----+</span><br><span class="line">|           o= .. |</span><br><span class="line">|           =E.  .|</span><br><span class="line">|    .     o o. . |</span><br><span class="line">|   + .     +  .  |</span><br><span class="line">|  o * . S . +    |</span><br><span class="line">|   o + o o =     |</span><br><span class="line">|      . o . .    |</span><br><span class="line">|     . .         |</span><br><span class="line">|      .          |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@slave ~]<span class="meta"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.80</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">'192.168.16.80 (192.168.16.80)' can't be established.</span></span><br><span class="line">RSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> f2:f8:<span class="number">7</span>d:<span class="number">7</span>d:<span class="number">59</span>:<span class="number">3</span>f:b9:<span class="number">3</span>c:a0:e6:<span class="number">66</span>:<span class="number">54</span>:<span class="number">1</span>f:<span class="number">79</span>:e2:<span class="number">40.</span></span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added <span class="comment">'192.168.16.80' (RSA) to the list of known hosts.</span></span><br><span class="line">root@<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span><span class="comment">'s password: </span></span><br><span class="line">Now <span class="keyword">try</span> logging <span class="keyword">into</span> the machine, <span class="keyword">with</span> <span class="string">"ssh 'root@192.168.16.80'"</span>, <span class="keyword">and</span> check <span class="keyword">in</span>:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="keyword">to</span> make sure we haven<span class="comment">'t added extra keys that you weren't expecting.</span></span><br><span class="line"></span><br><span class="line">[root@slave ~]<span class="meta"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.81</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">'192.168.16.81 (192.168.16.81)' can't be established.</span></span><br><span class="line">RSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> <span class="number">9</span>f:<span class="number">1</span>f:<span class="number">41</span>:f6:<span class="number">2</span>d:e9:<span class="number">20</span>:<span class="number">83</span>:<span class="number">30</span>:be:cd:<span class="number">20</span>:<span class="number">01</span>:<span class="number">31</span>:ea:<span class="number">6</span>d.</span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added <span class="comment">'192.168.16.81' (RSA) to the list of known hosts.</span></span><br><span class="line">root@<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span><span class="comment">'s password: </span></span><br><span class="line">Now <span class="keyword">try</span> logging <span class="keyword">into</span> the machine, <span class="keyword">with</span> <span class="string">"ssh 'root@192.168.16.81'"</span>, <span class="keyword">and</span> check <span class="keyword">in</span>:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="keyword">to</span> make sure we haven<span class="comment">'t added extra keys that you weren't expecting.</span></span><br><span class="line"></span><br><span class="line">[root@slave ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p>
<p>测试登录<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ssh root@192.168.16.80</span><br><span class="line">Last login: Wed Oct 11 14:48:14 2017 <span class="keyword">from</span> 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome <span class="keyword">to</span> aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@master ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection <span class="keyword">to</span> 192.168.16.80 closed.</span><br><span class="line">[root@slave ~]# ssh root@192.168.16.81</span><br><span class="line">Last login: Wed Oct 11 14:48:10 2017 <span class="keyword">from</span> 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome <span class="keyword">to</span> aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@slave ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection <span class="keyword">to</span> 192.168.16.81 closed.</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL安装"><a href="#MySQL安装" class="headerlink" title="MySQL安装"></a>MySQL安装</h2><p>使用的是自己打包的RPM包，分别登录主库和从库，直接rpm -ivh percona-server-5.7.18-15.x86_64.rpm 即可，也可使用其他方式安装MySQL<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mv /home/duanwenjie/percona-server<span class="number">-5.7</span><span class="number">.18</span><span class="number">-15.</span>x86_64.rpm /usr/src/</span><br><span class="line">[root@master ~]# rpm -ivh /usr/src/percona-server<span class="number">-5.7</span><span class="number">.18</span><span class="number">-15.</span>x86_64.rpm </span><br><span class="line">Preparing...                ########################################### [<span class="number">100</span>%]</span><br><span class="line">Group <span class="string">'mail'</span> not found. Creating the user mailbox file <span class="keyword">with</span> <span class="number">0600</span> mode.</span><br><span class="line">   <span class="number">1</span>:percona-server         ########################################### [<span class="number">100</span>%]</span><br><span class="line">error reading information on service /etc/rc.d/init.d/mysqld: No such file or directory</span><br><span class="line">MySQL (Percona Server) PID file could not be found![FAILED]</span><br><span class="line">Starting MySQL (Percona Server)...[  OK  ]</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Warning: Since password will be sent to server <span class="keyword">in</span> plain text, use ssl connection to ensure password safety.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<p>查看是否安装成功,分别登录主库和从库<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">12</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">03</span>:<span class="number">27</span> &gt; select <span class="built_in">version</span>();</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| <span class="built_in">version</span>()     |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">03</span>:<span class="number">31</span> &gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@master ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL互为主备"><a href="#MySQL互为主备" class="headerlink" title="MySQL互为主备"></a>MySQL互为主备</h2><h3 id="重要参数配置"><a href="#重要参数配置" class="headerlink" title="重要参数配置"></a>重要参数配置</h3><p>主库必须包含以下参数<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># cat /etc/my.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 1</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 1</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br></pre></td></tr></table></figure></p>
<p>从库必须包含以下参数，注意slave需要动态设置read_only=1<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/my.cnf </span><br><span class="line"><span class="meta">[mysqld]</span></span><br><span class="line">server-id = 2</span><br><span class="line">autocommit = 1</span><br><span class="line">auto<span class="emphasis">_increment_</span>increment = 2</span><br><span class="line">auto<span class="emphasis">_increment_</span>offset = 2</span><br><span class="line">log<span class="emphasis">_bin = mysql-bin</span></span><br><span class="line"><span class="emphasis">gtid_</span>mode = on</span><br><span class="line">enforce<span class="emphasis">_gtid_</span>consistency = 1</span><br><span class="line">log<span class="emphasis">_slave_</span>updates</span><br><span class="line">relay<span class="emphasis">_log_</span>purge=0</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e "show variables like <span class="emphasis">'read_only'</span>"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| read_</span>only     | OFF   |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e "set global read<span class="emphasis">_only=1"</span></span><br><span class="line"><span class="emphasis">Enter password: </span></span><br><span class="line"><span class="emphasis">[root@slave ~]# mysql -uroot -p -e "show variables like 'read_</span>only'"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| read_</span>only     | ON    |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="复制帐号建立"><a href="#复制帐号建立" class="headerlink" title="复制帐号建立"></a>复制帐号建立</h3><p>由于MySQL版本使用的是5.7，创建用户的方法以之前有些不同</p>
<h4 id="主库创建"><a href="#主库创建" class="headerlink" title="主库创建"></a>主库创建</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands end <span class="keyword">with</span> ; <span class="keyword">or</span> <span class="string">\g.</span></span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">4</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. Type <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">09</span>:<span class="number">37</span> &gt; create user <span class="string">'slave01'</span>@<span class="string">'192.168.16.81'</span> identified <span class="keyword">by</span> <span class="string">'slave123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">10</span>:<span class="number">13</span> &gt; grant replication slave,replication client <span class="literal">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'192.168.16.81'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">10</span>:<span class="number">39</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">10</span>:<span class="number">42</span> &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@master ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h4 id="从库创建"><a href="#从库创建" class="headerlink" title="从库创建"></a>从库创建</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands end <span class="keyword">with</span> ; <span class="keyword">or</span> <span class="string">\g.</span></span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">7</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. Type <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">11</span>:<span class="number">18</span> &gt; create user <span class="string">'slave01'</span>@<span class="string">'192.168.16.80'</span> identified <span class="keyword">by</span> <span class="string">'slave123456'</span>; </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">11</span>:<span class="number">30</span> &gt; grant replication slave,replication client <span class="literal">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'192.168.16.80'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">11</span>:<span class="number">40</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">11</span>:<span class="number">43</span> &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@slave ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="复制帐号验证"><a href="#复制帐号验证" class="headerlink" title="复制帐号验证"></a>复制帐号验证</h3><p>主库登录从库<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uslave01 -pslave123456 -h192.168.16.81 -e "select version()" </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">| version()     |</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">| 5.7.18-15-log |</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<p>从库登录主库<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uslave01 -pslave123456 -h192.168.16.80 -e "select version()" </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">| version()     |</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">| 5.7.18-15-log |</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="复制关系配置"><a href="#复制关系配置" class="headerlink" title="复制关系配置"></a>复制关系配置</h3><h4 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h4><p>登录主库，设置复制关系，来源于从库的复制<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-p</span></span><br><span class="line"><span class="string">Enter</span> <span class="attr">password:</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">the</span> <span class="string">MySQL</span> <span class="string">monitor.</span>  <span class="string">Commands</span> <span class="string">end</span> <span class="string">with</span> <span class="string">;</span> <span class="string">or</span> <span class="string">\g.</span></span><br><span class="line"><span class="string">Your</span> <span class="string">MySQL</span> <span class="string">connection</span> <span class="string">id</span> <span class="string">is</span> <span class="number">6</span></span><br><span class="line"><span class="string">Server</span> <span class="attr">version:</span> <span class="number">5.7</span><span class="number">.18</span><span class="bullet">-15</span><span class="bullet">-log</span> <span class="string">PLD/Linux</span> <span class="string">Distribution</span> <span class="string">Percona</span> <span class="string">Server</span> <span class="string">RPM</span></span><br><span class="line"></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2009</span><span class="bullet">-2017</span> <span class="string">Percona</span> <span class="string">LLC</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2000</span><span class="string">,</span> <span class="number">2017</span><span class="string">,</span> <span class="string">Oracle</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates.</span> <span class="string">All</span> <span class="string">rights</span> <span class="string">reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Oracle</span> <span class="string">is</span> <span class="string">a</span> <span class="string">registered</span> <span class="string">trademark</span> <span class="string">of</span> <span class="string">Oracle</span> <span class="string">Corporation</span> <span class="string">and/or</span> <span class="string">its</span></span><br><span class="line"><span class="string">affiliates.</span> <span class="string">Other</span> <span class="string">names</span> <span class="string">may</span> <span class="string">be</span> <span class="string">trademarks</span> <span class="string">of</span> <span class="string">their</span> <span class="string">respective</span></span><br><span class="line"><span class="string">owners.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Type</span> <span class="string">'help;'</span> <span class="string">or</span> <span class="string">'\h'</span> <span class="string">for</span> <span class="string">help.</span> <span class="string">Type</span> <span class="string">'\c'</span> <span class="string">to</span> <span class="string">clear</span> <span class="string">the</span> <span class="string">current</span> <span class="string">input</span> <span class="string">statement.</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">15</span><span class="string">:14:07</span> <span class="string">&gt; change master to master_host='192.168.16.81',master_user='slave01',master_password='slave123456',master_auto_position=1;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected, 2 warnings (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 15:14:46 &gt; start slave;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.04 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 15:14:49 &gt; show slave status\G</span></span><br><span class="line"><span class="string">*************************** 1. row ***************************</span></span><br><span class="line"><span class="string"></span><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">slave01</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">812</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">master-relay-bin.000002</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">1025</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">812</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">1233</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="string">e1ec82e8-ae51-11e7-8532-00163e128057</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">mysql.slave_master_info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">more</span> <span class="string">updates</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="attr">e1ec82e8-ae51-11e7-8532-00163e128057:1-3</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="attr">df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3,</span></span><br><span class="line"><span class="attr">e1ec82e8-ae51-11e7-8532-00163e128057:</span><span class="number">1</span><span class="bullet">-3</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </span><br><span class="line"><span class="attr">                 Channel_Name:</span> </span><br><span class="line"><span class="attr">           Master_TLS_Version:</span> </span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">15</span><span class="string">:14:56</span> <span class="string">&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h4><p>登录从库，设置复制关系，来源于主库的复制<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@slave</span> <span class="string">~]#</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-p</span></span><br><span class="line"><span class="string">Enter</span> <span class="attr">password:</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">the</span> <span class="string">MySQL</span> <span class="string">monitor.</span>  <span class="string">Commands</span> <span class="string">end</span> <span class="string">with</span> <span class="string">;</span> <span class="string">or</span> <span class="string">\g.</span></span><br><span class="line"><span class="string">Your</span> <span class="string">MySQL</span> <span class="string">connection</span> <span class="string">id</span> <span class="string">is</span> <span class="number">11</span></span><br><span class="line"><span class="string">Server</span> <span class="attr">version:</span> <span class="number">5.7</span><span class="number">.18</span><span class="bullet">-15</span><span class="bullet">-log</span> <span class="string">PLD/Linux</span> <span class="string">Distribution</span> <span class="string">Percona</span> <span class="string">Server</span> <span class="string">RPM</span></span><br><span class="line"></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2009</span><span class="bullet">-2017</span> <span class="string">Percona</span> <span class="string">LLC</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2000</span><span class="string">,</span> <span class="number">2017</span><span class="string">,</span> <span class="string">Oracle</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates.</span> <span class="string">All</span> <span class="string">rights</span> <span class="string">reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Oracle</span> <span class="string">is</span> <span class="string">a</span> <span class="string">registered</span> <span class="string">trademark</span> <span class="string">of</span> <span class="string">Oracle</span> <span class="string">Corporation</span> <span class="string">and/or</span> <span class="string">its</span></span><br><span class="line"><span class="string">affiliates.</span> <span class="string">Other</span> <span class="string">names</span> <span class="string">may</span> <span class="string">be</span> <span class="string">trademarks</span> <span class="string">of</span> <span class="string">their</span> <span class="string">respective</span></span><br><span class="line"><span class="string">owners.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Type</span> <span class="string">'help;'</span> <span class="string">or</span> <span class="string">'\h'</span> <span class="string">for</span> <span class="string">help.</span> <span class="string">Type</span> <span class="string">'\c'</span> <span class="string">to</span> <span class="string">clear</span> <span class="string">the</span> <span class="string">current</span> <span class="string">input</span> <span class="string">statement.</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">15</span><span class="string">:15:42</span> <span class="string">&gt; change master to master_host='192.168.16.80',master_user='slave01',master_password='slave123456',master_auto_position=1;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected, 2 warnings (0.05 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 15:15:53 &gt; start slave;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.04 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 15:15:55 &gt; show slave status\G</span></span><br><span class="line"><span class="string">*************************** 1. row ***************************</span></span><br><span class="line"><span class="string"></span><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">slave01</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">1470</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">slave-relay-bin.000002</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">1072</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">1470</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">1279</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="string">df5051fc-ae51-11e7-85ee-00163e0f0e4a</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">mysql.slave_master_info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">more</span> <span class="string">updates</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="attr">df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="attr">df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3,</span></span><br><span class="line"><span class="attr">e1ec82e8-ae51-11e7-8532-00163e128057:</span><span class="number">1</span><span class="bullet">-3</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </span><br><span class="line"><span class="attr">                 Channel_Name:</span> </span><br><span class="line"><span class="attr">           Master_TLS_Version:</span> </span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">15</span><span class="string">:16:00</span> <span class="string">&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="复制测试"><a href="#复制测试" class="headerlink" title="复制测试"></a>复制测试</h3><h4 id="主库登录测试"><a href="#主库登录测试" class="headerlink" title="主库登录测试"></a>主库登录测试</h4><p>登录主库，插入测试数据<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MySQL [test11] 15:17:10 &gt; create table if not exists t11(id int unsigned not null auto<span class="emphasis">_increment,name varchar(20),primary key(`id`));</span></span><br><span class="line"><span class="emphasis">Query OK, 0 rows affected (0.04 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">MySQL [test11] 15:17:20 &gt; insert into t11 values(null,'master11');</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">MySQL [test11] 15:17:28 &gt; select * from t11;</span></span><br><span class="line"><span class="emphasis">+----+----------+</span></span><br><span class="line"><span class="emphasis">| id | name     |</span></span><br><span class="line"><span class="emphasis">+----+----------+</span></span><br><span class="line"><span class="emphasis">|  1 | master11 |</span></span><br><span class="line"><span class="emphasis">+----+----------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br></pre></td></tr></table></figure></p>
<p>登录从库，查看测试数据，此时数据已经复制过来<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p test11 -e "select * from t11"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+----+</span>----------+</span><br><span class="line">| id | name     |</span><br><span class="line"><span class="code">+----+</span>----------+</span><br><span class="line">|  1 | master11 |</span><br><span class="line"><span class="code">+----+</span>----------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h4 id="从库登录测试"><a href="#从库登录测试" class="headerlink" title="从库登录测试"></a>从库登录测试</h4><p>登录从库，插入测试数据<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 15:18:56 &gt; <span class="keyword">create</span> <span class="keyword">database</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> test11;use test11;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] 15:19:20 &gt; <span class="keyword">create</span> table <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> t22(id int unsigned <span class="keyword">not</span> <span class="literal">null</span> auto_increment,name varchar(<span class="number">20</span>),<span class="keyword">primary</span> <span class="keyword">key</span>(<span class="symbol">`id`</span>));</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:38 &gt; <span class="keyword">insert</span> <span class="keyword">into</span> t22 <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">'slave11'</span>); </span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:43 &gt; <span class="keyword">select</span> * <span class="keyword">from</span> t22;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  2 | slave11 |</span><br><span class="line">+----+---------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:51 &gt;</span><br></pre></td></tr></table></figure></p>
<p>登录主库，查看测试数据，此时数据已经复制过来<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p test11 -e "select * from t22"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+----+</span>---------+</span><br><span class="line">| id | name    |</span><br><span class="line"><span class="code">+----+</span>---------+</span><br><span class="line">|  2 | slave11 |</span><br><span class="line"><span class="code">+----+</span>---------+</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="MHA帐号创建"><a href="#MHA帐号创建" class="headerlink" title="MHA帐号创建"></a>MHA帐号创建</h3><h4 id="主库创建-1"><a href="#主库创建-1" class="headerlink" title="主库创建"></a>主库创建</h4><p>登录主库，创建允许主库和从库连接的MHA用户信息，再分别尝试使用MHA用户登录(省略)<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">29</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">23</span>:<span class="number">16</span> &gt; <span class="keyword">create</span> user <span class="string">'mha01'</span>@<span class="string">'192.168.16.81'</span> identified <span class="keyword">by</span> <span class="string">'mha123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">24</span>:<span class="number">02</span> &gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha01'</span>@<span class="string">'192.168.16.81'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">24</span>:<span class="number">27</span> &gt; <span class="keyword">create</span> user <span class="string">'mha01'</span>@<span class="string">'192.168.16.80'</span> identified <span class="keyword">by</span> <span class="string">'mha123456'</span>; </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">24</span>:<span class="number">35</span> &gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha01'</span>@<span class="string">'192.168.16.80'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">24</span>:<span class="number">41</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="从库创建-1"><a href="#从库创建-1" class="headerlink" title="从库创建"></a>从库创建</h4><p>登录从库，由于复制已经把在主库创建的MHA用户信息复制了过来，尝试登录即可(省略)</p>
<h2 id="MHA安装"><a href="#MHA安装" class="headerlink" title="MHA安装"></a>MHA安装</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>分别在主库和从库上安装，执行命令：<br>yum -y install gcc gcc-c++ make openssl-devel perl perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Config-IniFiles perl-Time-HiRes perl-Module-Install.noarch mailx jwhois cpan  </p>
<h3 id="主库安装mha4mysql-node"><a href="#主库安装mha4mysql-node" class="headerlink" title="主库安装mha4mysql-node"></a>主库安装mha4mysql-node</h3><p>MHA管理端安装在从库上，主库上只需要mha4mysql-node即可，由于MySQL使用5.7版本，MHA也使用最新的0.57版本，采用编译安装方式。下载地址：<a href="https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw" target="_blank" rel="noopener">https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw</a><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cd</span> /usr/src/</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">src</span>]<span class="comment"># tar -zxf mha4mysql-node-0.57.tar.gz</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># perl Makefile.PL             #编译过程省略</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># make</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># make install</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># ll /usr/local/bin/ -t        #查看安装，有以下文件则mha4mysql-node安装成功</span></span><br><span class="line">total <span class="number">1760</span></span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root  <span class="number">16381</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">8261</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> purge_relay_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">7525</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> save_binary_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">4807</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p>
<h3 id="从库安装mha4mysql-manager和mha4mysql-node"><a href="#从库安装mha4mysql-manager和mha4mysql-node" class="headerlink" title="从库安装mha4mysql-manager和mha4mysql-node"></a>从库安装mha4mysql-manager和mha4mysql-node</h3><p>MHA管理端安装在从库，从库需要安装manager端和node端<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># cd /usr/src/</span></span><br><span class="line">[root@slave src]<span class="comment"># tar -zxf mha4mysql-manager-0.57.tar.gz </span></span><br><span class="line">[root@slave src]<span class="comment"># cd mha4mysql-manager-0.57</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># perl Makefile.PL           #编译过程省略</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># make</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># make install </span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># ll /usr/local/bin/ -t      #查看安装，有以下文件则mha4mysql-manager安装成功</span></span><br><span class="line">total 40</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 1779 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_ssh</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 2517 </span>Oct<span class="number"> 11 </span>15:45 masterha_manager</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 2373 </span>Oct<span class="number"> 11 </span>15:45 masterha_master_switch</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 5171 </span>Oct<span class="number"> 11 </span>15:45 masterha_secondary_check</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 1995 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_repl</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 1865 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_status</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 3201 </span>Oct<span class="number"> 11 </span>15:45 masterha_conf_host</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 2165 </span>Oct<span class="number"> 11 </span>15:45 masterha_master_monitor</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 1739 </span>Oct<span class="number"> 11 </span>15:45 masterha_stop</span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># cd ..</span></span><br><span class="line">[root@slave src]<span class="comment"># tar -zxf mha4mysql-node-0.57.tar.gz </span></span><br><span class="line">[root@slave src]<span class="comment"># cd mha4mysql-node-0.57</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># perl Makefile.PL              #编译过程省略        </span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># make</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># make install</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># ll /usr/local/bin/ -t         #查看安装，有以下文件则mha4mysql-node安装成功</span></span><br><span class="line">total 84</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 16381 </span>Oct<span class="number"> 11 </span>15:47 apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root <span class="number"> 4807 </span>Oct<span class="number"> 11 </span>15:47 filter_mysqlbinlog</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root <span class="number"> 8261 </span>Oct<span class="number"> 11 </span>15:47 purge_relay_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root <span class="number"> 7525 </span>Oct<span class="number"> 11 </span>15:47 save_binary_logs</span><br></pre></td></tr></table></figure></p>
<h2 id="MHA目录结构说明"><a href="#MHA目录结构说明" class="headerlink" title="MHA目录结构说明"></a>MHA目录结构说明</h2><h3 id="MHAManager"><a href="#MHAManager" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>mhamanager工具包主要包括以下工具<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@slave  ~]<span class="comment"># ll /usr/local/bin/</span></span><br><span class="line">总用量 40</span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1995 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_repl         <span class="comment">#检查MySQL复制情况</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1779 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_ssh          <span class="comment">#检查MHA的SSH配置情况</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1865 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_status       <span class="comment">#检测当前MHA运行状态</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 3201 </span>Oct<span class="number"> 11 </span>15:45 masterha_conf_host          <span class="comment">#添加或删除配置的server信息</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2517 </span>Oct<span class="number"> 11 </span>15:45 masterha_manager            <span class="comment">#启动MHA</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2165 </span>Oct<span class="number"> 11 </span>15:45 masterha_master_monitor     <span class="comment">#检测Master是否宕机</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2373 </span>Oct<span class="number"> 11 </span>15:45 masterha_master_switch      <span class="comment">#控制故障转移，自动或者手动</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 5172 </span>Oct<span class="number"> 11 </span>15:45 masterha_secondary_check    <span class="comment">#通过其他路由检测Master是否真的宕机</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1739 </span>Oct<span class="number"> 11 </span>15:45 masterha_stop               <span class="comment">#停止MHA</span></span><br></pre></td></tr></table></figure></p>
<h3 id="MHANode"><a href="#MHANode" class="headerlink" title="MHANode"></a>MHANode</h3><p>mhanode工具包主要包括以下工具<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># ll /usr/local/bin/ -t   </span></span><br><span class="line">total 84</span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root<span class="number"> 16371 </span>Oct<span class="number"> 11 </span>15:47 apply_diff_relay_logs       <span class="comment">#识别差异日志的中继日志，并将其差异事件应用于其他Slave</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 4807 </span>Oct<span class="number"> 11 </span>15:47 filter_mysqlbinlog          <span class="comment">#去除不必要的Rollback事件</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 8263 </span>Oct<span class="number"> 11 </span>15:47 purge_relay_logs            <span class="comment">#删除无用的Relay log，避免延时</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 7525 </span>Oct<span class="number"> 11 </span>15:47 save_binary_logs            <span class="comment">#保存和复制down掉的主服务器二进制日志</span></span><br></pre></td></tr></table></figure></p>
<h3 id="自定义扩展脚本说明"><a href="#自定义扩展脚本说明" class="headerlink" title="自定义扩展脚本说明"></a>自定义扩展脚本说明</h3><p>secondary_check_script #通过多条网络路由检测master的可用性<br>master_ip_failover_script #自动failover时候的切换脚本，可将vip信息写入此脚本中<br>shutdown_script #强制关闭master节点执行脚本<br>report_script #发送报告<br>init_conf_load_script #加载初始配置参数，如不想在配置中写明文密码<br>master_ip_online_change_script #手动failover时候的切换脚本  </p>
<h2 id="keepalived安装"><a href="#keepalived安装" class="headerlink" title="keepalived安装"></a>keepalived安装</h2><p>MHA作为MySQL的HA软件,借助脚本或者第三方软件如keepalived,可实现自动的failover<br>本次环境使用yum安装keepalived,主库和从库分别执行安装: yum -y install keepalived<br>keepalived的配置文件,默认在主库上绑定EIP,priority要比备库高,同时为了避免脑裂,两个state同时设置为BACKUP,由于HaVip不支持组播和广播通讯,因此需要将keepalived的心跳方式设置为单播,添加unicast_src_ip和unicast_peer</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><h4 id="主库配置-1"><a href="#主库配置-1" class="headerlink" title="主库配置"></a>主库配置</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     duanwenjie@huan.tv</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">   <span class="built_in"> interface </span>eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.16.82 dev eth0 label eth0:havip</span><br><span class="line">    &#125;</span><br><span class="line">        unicast_src_ip 192.168.16.80</span><br><span class="line">        unicast_peer &#123;</span><br><span class="line">                192.168.16.81</span><br><span class="line">                        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="从库配置-1"><a href="#从库配置-1" class="headerlink" title="从库配置"></a>从库配置</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     duanwenjie@huan.tv</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">   <span class="built_in"> interface </span>eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.16.82 dev eth0 label eth0:havip</span><br><span class="line">    &#125;</span><br><span class="line">        unicast_src_ip 192.168.16.81</span><br><span class="line">        unicast_peer &#123;</span><br><span class="line">                192.168.16.80</span><br><span class="line">                        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="EIP漂移测试"><a href="#EIP漂移测试" class="headerlink" title="EIP漂移测试"></a>EIP漂移测试</h3><p>分别启动keepalived服务，查看默认EIP在哪台机器上，同时关闭EIP所在机器的keepalived服务，查看EIP是否漂移，最后恢复原状</p>
<h4 id="主库启动keepalived服务"><a href="#主库启动keepalived服务" class="headerlink" title="主库启动keepalived服务"></a>主库启动keepalived服务</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">keepalived</span>]<span class="comment"># /etc/init.d/keepalived start</span></span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">keepalived</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h4 id="从库启动keepalived服务"><a href="#从库启动keepalived服务" class="headerlink" title="从库启动keepalived服务"></a>从库启动keepalived服务</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@slave</span> keepalived]<span class="meta"># /etc/init.d/keepalived start</span></span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root<span class="symbol">@slave</span> keepalived]<span class="meta">#</span></span><br></pre></td></tr></table></figure>
<h4 id="查看默认EIP在主库上"><a href="#查看默认EIP在主库上" class="headerlink" title="查看默认EIP在主库上"></a>查看默认EIP在主库上</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span></span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:172562</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:71674</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:200695958</span> (191<span class="selector-class">.3</span> <span class="selector-tag">MiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:12526649</span> (11<span class="selector-class">.9</span> <span class="selector-tag">MiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7946</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7946</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:510910</span> (498<span class="selector-class">.9</span> <span class="selector-tag">KiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:510910</span> (498<span class="selector-class">.9</span> <span class="selector-tag">KiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure>
<h4 id="关闭主库的keepalived服务"><a href="#关闭主库的keepalived服务" class="headerlink" title="关闭主库的keepalived服务"></a>关闭主库的keepalived服务</h4><p>关闭主库的keepalived服务后，EIP消失<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">keepalived</span> <span class="selector-tag">stop</span></span><br><span class="line"><span class="selector-tag">Stopping</span> <span class="selector-tag">keepalived</span>:                                       <span class="selector-attr">[  OK  ]</span></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span></span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:172670</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:71803</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:200704346</span> (<span class="number">191.4</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:12569281</span> (<span class="number">11.9</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7976</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7976</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:512770</span> (<span class="number">500.7</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:512770</span> (<span class="number">500.7</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure></p>
<h4 id="查看EIP是否漂移到从库上"><a href="#查看EIP是否漂移到从库上" class="headerlink" title="查看EIP是否漂移到从库上"></a>查看EIP是否漂移到从库上</h4><p>此时EIP已经漂移到从库上<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@slave ~]</span># <span class="selector-tag">ifconfig</span></span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:80</span><span class="selector-pseudo">:57</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.81</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:164539</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:77532</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:202145589</span> (192<span class="selector-class">.7</span> <span class="selector-tag">MiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:12091265</span> (11<span class="selector-class">.5</span> <span class="selector-tag">MiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:80</span><span class="selector-pseudo">:57</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7961</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7961</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:508050</span> (496<span class="selector-class">.1</span> <span class="selector-tag">KiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:508050</span> (496<span class="selector-class">.1</span> <span class="selector-tag">KiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@slave ~]</span>#</span><br></pre></td></tr></table></figure></p>
<h4 id="恢复原状"><a href="#恢复原状" class="headerlink" title="恢复原状"></a>恢复原状</h4><p>主库启动keepalived服务，查看EIP已经又漂移回来<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">keepalived</span> <span class="selector-tag">start</span></span><br><span class="line"><span class="selector-tag">Starting</span> <span class="selector-tag">keepalived</span>:                                       <span class="selector-attr">[  OK  ]</span></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span></span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:172863</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:71978</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:200717148</span> (<span class="number">191.4</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:12627987</span> (<span class="number">12.0</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8039</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8039</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:516676</span> (<span class="number">504.5</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:516676</span> (<span class="number">504.5</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure></p>
<h2 id="MHA配置"><a href="#MHA配置" class="headerlink" title="MHA配置"></a>MHA配置</h2><h3 id="MHAManager-1"><a href="#MHAManager-1" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>创建配置目录/etc/masterha/，同时创建一个项目上的配置文件，仅配置自动FailOver部分，脚本暂时不定义，下文会有MHA引入keepalived。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[server default]</span><br><span class="line"><span class="attribute">manager_workdir</span>=/var/log/masterha/app1   </span><br><span class="line"><span class="attribute">manager_log</span>=/var/log/masterha/app1/manager.log </span><br><span class="line"><span class="attribute">master_binlog_dir</span>=/hwdata/data/percona        </span><br><span class="line"><span class="attribute">password</span>=mha123456                             </span><br><span class="line"><span class="attribute">user</span>=mha01                                     </span><br><span class="line"><span class="attribute">ping_interval</span>=1                                    </span><br><span class="line"><span class="attribute">remote_workdir</span>=/tmp                                                </span><br><span class="line"><span class="attribute">repl_password</span>=slave123456                                          </span><br><span class="line"><span class="attribute">repl_user</span>=slave01                                                 </span><br><span class="line"><span class="attribute">ssh_user</span>=root                                                     </span><br><span class="line"><span class="comment">#master_ip_failover_script=/usr/local/bin/master_ip_failover        </span></span><br><span class="line"><span class="comment">#master_ip_online_change_script= /usr/local/bin/master_ip_online_change  </span></span><br><span class="line"><span class="comment">#report_script=/usr/local/bin/send_report                         </span></span><br><span class="line"><span class="comment">#shutdown_script=                                                 </span></span><br><span class="line">secondary_check_script = masterha_secondary_check -s 192.168.16.80 -s 192.168.16.81 <span class="attribute">--user</span>=root <span class="attribute">hostname</span>=192.168.16.80  <span class="attribute">--master_ip</span>=192.168.16.80 <span class="attribute">--master_port</span>=3306 </span><br><span class="line">[server1]</span><br><span class="line"><span class="attribute">hostname</span>=192.168.16.80                                          </span><br><span class="line"><span class="attribute">port</span>=3306</span><br><span class="line">[server2]</span><br><span class="line"><span class="attribute">hostname</span>=192.168.16.81                                         </span><br><span class="line"><span class="attribute">port</span>=3306</span><br><span class="line"><span class="attribute">candidate_master</span>=1</span><br></pre></td></tr></table></figure></p>
<h3 id="测试MHAManager-SSH"><a href="#测试MHAManager-SSH" class="headerlink" title="测试MHAManager SSH"></a>测试MHAManager SSH</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_ssh <span class="attribute">--conf</span>=/etc/masterha/app1.cnf </span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">info</span>] Starting SSH<span class="built_in"> connection </span>tests<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.16.80(192.168.16.80:22) <span class="keyword">to</span> root@192.168.16.81(192.168.16.81:22)<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.16.81(192.168.16.81:22) <span class="keyword">to</span> root@192.168.16.80(192.168.16.80:22)<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">info</span>] All SSH<span class="built_in"> connection </span>tests passed successfully.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h3 id="测试MHAManager-复制"><a href="#测试MHAManager-复制" class="headerlink" title="测试MHAManager 复制"></a>测试MHAManager 复制</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_repl <span class="attribute">--conf</span>=/etc/masterha/app1.cnf</span><br><span class="line">Wed Oct 11 17:22:47 2017 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Wed Oct 11 17:22:47 2017 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:47 2017 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:47 2017 - [<span class="builtin-name">info</span>] MHA::MasterMonitor version 0.57.</span><br><span class="line">Creating directory /var/log/masterha/app1<span class="built_in">..</span> done.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Multi-master configuration is detected. Current primary(writable) master is 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Master configurations are as below: </span><br><span class="line">Master 192.168.16.81(192.168.16.81:3306), replicating <span class="keyword">from</span> 192.168.16.80(192.168.16.80:3306), read-only</span><br><span class="line">Master 192.168.16.80(192.168.16.80:3306), replicating <span class="keyword">from</span> 192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] GTID failover mode = 1</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Dead Servers:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Alive Servers:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]   192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]   192.168.16.81(192.168.16.81:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Alive Slaves:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]   192.168.16.81(192.168.16.81:3306)  <span class="attribute">Version</span>=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]     GTID ON</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Current Alive Master: 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Checking slave configurations<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Checking replication filtering settings<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]  Replication filtering check ok.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] GTID (with auto-pos) is supported. Skipping all SSH <span class="keyword">and</span> Node package checking.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Checking SSH publickey authentication<span class="built_in"> settings </span>on the current master<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] HealthCheck: SSH <span class="keyword">to</span> 192.168.16.80 is reachable.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] </span><br><span class="line">192.168.16.80(192.168.16.80:3306) (current master)</span><br><span class="line"> +--192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Checking replication<span class="built_in"> health </span>on 192.168.16.81<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">warning</span>] master_ip_failover_script is <span class="keyword">not</span> defined.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">warning</span>] shutdown_script is <span class="keyword">not</span> defined.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Got exit code 0 (<span class="keyword">Not</span> master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication<span class="built_in"> Health </span>is OK.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h2 id="MHA引入keepalived"><a href="#MHA引入keepalived" class="headerlink" title="MHA引入keepalived"></a>MHA引入keepalived</h2><p>把keepalived服务引入MHA，需要修改切换是触发的脚本文件master_ip_failover即可，在该脚本中添加在master发生宕机时对keepalived的处理。</p>
<h3 id="master-ip-failover脚本"><a href="#master-ip-failover脚本" class="headerlink" title="master_ip_failover脚本"></a>master_ip_failover脚本</h3><p>编辑脚本/usr/local/bin/master_ip_failover，修改后如下，这里完整的脚本<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]<span class="comment"># cat /usr/local/bin/master_ip_failover </span></span><br><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> warnings <span class="string">FATAL =&gt;</span> <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> Getopt::Long;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> (</span><br><span class="line">    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,</span><br><span class="line">    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $vip = <span class="string">'192.168.16.82'</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_start_vip = <span class="string">"/etc/init.d/keepalived start"</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_stop_vip = <span class="string">"/etc/init.d/keepalived stop"</span>;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    <span class="string">'command=s'</span>          =&gt; \$command,</span><br><span class="line">    <span class="string">'ssh_user=s'</span>         =&gt; \$ssh_user,</span><br><span class="line">    <span class="string">'orig_master_host=s'</span> =&gt; \$orig_master_host,</span><br><span class="line">    <span class="string">'orig_master_ip=s'</span>   =&gt; \$orig_master_ip,</span><br><span class="line">    <span class="string">'orig_master_port=i'</span> =&gt; \$orig_master_port,</span><br><span class="line">    <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span><br><span class="line">    <span class="string">'new_master_ip=s'</span>    =&gt; \$new_master_ip,</span><br><span class="line">    <span class="string">'new_master_port=i'</span>  =&gt; \$new_master_port,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( $command eq <span class="string">"stop"</span> || $command eq <span class="string">"stopssh"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">eval</span> &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Disabling the VIP on old master: $orig_master_host \n"</span>;</span><br><span class="line">            &amp;stop_vip();</span><br><span class="line">            $exit_code = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">            <span class="keyword">warn</span> <span class="string">"Got Error: $@\n"</span>;</span><br><span class="line">            <span class="keyword">exit</span> $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">"start"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">eval</span> &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Enabling the VIP - $vip on the new master - $new_master_host \n"</span>;</span><br><span class="line">            &amp;start_vip();</span><br><span class="line">            $exit_code = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">            <span class="keyword">warn</span> $@;</span><br><span class="line">            <span class="keyword">exit</span> $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">"status"</span> ) &#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Checking the Status of the script.. OK \n"</span>;</span><br><span class="line">        <span class="comment">#`ssh $ssh_user\@$orig_master_ip \" $ssh_start_vip \"`;</span></span><br><span class="line">        <span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        &amp;usage();</span><br><span class="line">        <span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># A simple system call that enable the VIP on the new master</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">start_vip</span>() </span>&#123;</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># A simple system call that disable the VIP on the old_master</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">stop_vip</span>() </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>  <span class="keyword">unless</span>  ($ssh_user);</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">usage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    <span class="string">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@slave app1]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<p>添加权限<br>chmod +x /usr/local/bin/master_ip_failover</p>
<h3 id="send-report脚本"><a href="#send-report脚本" class="headerlink" title="send_report脚本"></a>send_report脚本</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/send_report </span></span><br><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">strict</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">warnings</span> <span class="title">FATAL</span> =&gt; '<span class="title">all</span>';</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mail</span>::<span class="title">Sender</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Getopt</span>::<span class="title">Long</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span></span><br><span class="line">my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );</span><br><span class="line">my $smtp=<span class="string">'smtp.126.com'</span>;</span><br><span class="line">my $mail_from=<span class="string">'xxx@126.com'</span>;</span><br><span class="line">my $mail_user=<span class="string">'xxx@126.com'</span>;</span><br><span class="line">my $mail_pass=<span class="string">'xxx'</span>;</span><br><span class="line"><span class="comment">#my $mail_to=['xxx','xxx'];</span></span><br><span class="line">my $mail_to=<span class="string">'xxx'</span>;</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'orig_master_host=s'</span> =&gt; \$dead_master_host,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span><br><span class="line">  <span class="string">'new_slave_hosts=s'</span>  =&gt; \$new_slave_hosts,</span><br><span class="line">  <span class="string">'subject=s'</span>          =&gt; \$subject,</span><br><span class="line">  <span class="string">'body=s'</span>             =&gt; \$body,</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);</span><br><span class="line"> </span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_;</span><br><span class="line">    open my $DEBUG, <span class="string">"&gt; /var/log/masterha/app1/manager.log"</span></span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Can't open the debug      file:$!\n"</span>;</span><br><span class="line">    my $sender = <span class="keyword">new</span> Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; <span class="string">'text/plain; charset=utf-8'</span>,</span><br><span class="line">        encoding    =&gt; <span class="string">'utf-8'</span>,</span><br><span class="line">        smtp        =&gt; $smtp,</span><br><span class="line">        from        =&gt; $mail_from,</span><br><span class="line">        auth        =&gt; <span class="string">'LOGIN'</span>,</span><br><span class="line">        TLS_allowed =&gt; <span class="string">'0'</span>,</span><br><span class="line">        authid      =&gt; $user,</span><br><span class="line">        authpwd     =&gt; $passwd,</span><br><span class="line">        to          =&gt; $mail_to,</span><br><span class="line">        subject     =&gt; $subject,</span><br><span class="line">        debug       =&gt; $DEBUG</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    $sender-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; $msg,</span><br><span class="line">            debug =&gt; $DEBUG</span><br><span class="line">        &#125;</span><br><span class="line">    ) <span class="keyword">or</span> <span class="keyword">print</span> $Mail::Sender::Error;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Do whatever you want here</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>添加权限<br>chmod +x /usr/local/bin/send_report</p>
<h3 id="MHAManager修改注释"><a href="#MHAManager修改注释" class="headerlink" title="MHAManager修改注释"></a>MHAManager修改注释</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@slave</span> app1]<span class="comment"># cat /etc/masterha/app1.cnf |grep master_ip_failover_script</span></span><br><span class="line">master_ip_failover_script=<span class="regexp">/usr/local</span><span class="regexp">/bin/master</span>_ip_failover        </span><br><span class="line">[root<span class="variable">@slave</span> app1]<span class="comment"># cat /etc/masterha/app1.cnf |grep report</span></span><br><span class="line">report_script=<span class="regexp">/usr/local</span><span class="regexp">/bin/send</span>_report                         </span><br><span class="line">[root<span class="variable">@slave</span> app1]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="HaVip绑定EIP"><a href="#HaVip绑定EIP" class="headerlink" title="HaVip绑定EIP"></a>HaVip绑定EIP</h2><p>keepalived服务已经配置完成，VIP也可以自动漂移后，但是其还不能在内网中通讯，需要将EIP映射到HaVip中，创建高可用虚拟IP，把master和slave两个实例的绑定在一起，具体步骤省略，见下图<br><img src="http://note.youdao.com/yws/public/resource/eed85389475569ba15ce22e5a266d5fb/xmlnote/E0CF3D2D9BE747299B2348C6AD4EAD30/37915" alt="image"></p>
<h2 id="MHA启动"><a href="#MHA启动" class="headerlink" title="MHA启动"></a>MHA启动</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta"># nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;</span></span><br><span class="line">[<span class="meta">1</span>] <span class="number">6706</span></span><br><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta"># nohup: ignoring input and appending output to `nohup.out'</span></span><br></pre></td></tr></table></figure>
<h3 id="查看启动日志"><a href="#查看启动日志" class="headerlink" title="查看启动日志"></a>查看启动日志</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# cat /var/log/masterha/app1/manager.log</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2017</span> - [info] MHA::MasterMonitor version <span class="number">0.57</span>.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Multi-master configuration is detected. Current primary(writable) master is <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Master configurations are as below: </span><br><span class="line">Master <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>), replicating from <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>), read-only</span><br><span class="line">Master <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>), replicating from <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">1</span></span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Dead Servers:</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Alive Servers:</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Alive Slaves:</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="meta">.18</span>-<span class="number">15</span>-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]     GTID ON</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Current Alive Master: <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Checking slave configurations..</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Checking replication filtering settings..</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  Replication filtering check ok.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] GTID (with auto-pos) is supported. Skipping all SSH <span class="keyword">and</span> Node package checking.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] HealthCheck: SSH to <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> is reachable.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] </span><br><span class="line"><span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>) (current master)</span><br><span class="line"> +--<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Checking master_ip_failover_script status:</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> --orig_master_ip=<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> --orig_master_port=<span class="number">3306</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">IN</span> SCRIPT <span class="keyword">TEST</span>====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  OK.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] shutdown_script is <span class="keyword">not</span> defined.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Set master ping interval <span class="number">1</span> seconds.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Set secondary check script: masterha_secondary_check -s <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> -s <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span> --user=root hostname=<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>  --master_ip=<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> --master_port=<span class="number">3306</span></span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Starting ping health check on <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)..</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Ping(SELECT) succeeded, waiting until MySQL doesn<span class="string">'t respond..</span></span><br><span class="line"><span class="string">[root@slave app1]#</span></span><br></pre></td></tr></table></figure>
<h2 id="模拟主库故障-自动FailOver"><a href="#模拟主库故障-自动FailOver" class="headerlink" title="模拟主库故障(自动FailOver)"></a>模拟主库故障(自动FailOver)</h2><h3 id="确认MHAManager进程状态"><a href="#确认MHAManager进程状态" class="headerlink" title="确认MHAManager进程状态"></a>确认MHAManager进程状态</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">ps</span> <span class="string">aux|grep</span> <span class="string">master</span></span><br><span class="line"><span class="string">root</span>      <span class="number">1217</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">81520</span>  <span class="number">3440</span> <span class="string">?</span>        <span class="string">Ss</span>   <span class="string">Oct11</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">/usr/libexec/postfix/master</span></span><br><span class="line"><span class="string">root</span>     <span class="number">20887</span>  <span class="number">0.2</span>  <span class="number">0.4</span> <span class="number">194688</span> <span class="number">18736</span> <span class="string">pts/1</span>    <span class="string">S</span>    <span class="number">08</span><span class="string">:57</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">perl</span> <span class="string">/usr/local/bin/masterha_manager</span> <span class="bullet">--conf=/etc/masterha/app1.cnf</span></span><br><span class="line"><span class="string">root</span>     <span class="number">20998</span>  <span class="number">0.0</span>  <span class="number">0.0</span> <span class="number">103252</span>   <span class="number">844</span> <span class="string">pts/1</span>    <span class="string">S+</span>   <span class="number">08</span><span class="string">:59</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">grep</span> <span class="string">master</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">ifconfig</span>     <span class="comment">#VIP不在slave上</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">00</span><span class="string">:16:3E:12:80:57</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:192.168.16.81</span>  <span class="attr">Bcast:192.168.31.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:1500</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:288188</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:129868</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:211584573</span> <span class="string">(201.7</span> <span class="string">MiB)</span>  <span class="string">TX</span> <span class="attr">bytes:50227849</span> <span class="string">(47.9</span> <span class="string">MiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:50346</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:50346</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:0</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:3204922</span> <span class="string">(3.0</span> <span class="string">MiB)</span>  <span class="string">TX</span> <span class="attr">bytes:3204922</span> <span class="string">(3.0</span> <span class="string">MiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span></span><br></pre></td></tr></table></figure>
<h3 id="停止主库MySQL服务"><a href="#停止主库MySQL服务" class="headerlink" title="停止主库MySQL服务"></a>停止主库MySQL服务</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>   #停止前<span class="selector-tag">VIP</span>存在于主库上</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:278061</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:223278</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:210643899</span> (<span class="number">200.8</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:57552395</span> (<span class="number">54.8</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:50158</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:50158</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3130070</span> (<span class="number">2.9</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3130070</span> (<span class="number">2.9</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">mysqld</span> <span class="selector-tag">stop</span></span><br><span class="line"><span class="selector-tag">Shutting</span> <span class="selector-tag">down</span> <span class="selector-tag">MySQL</span> (Percona Server)............           <span class="selector-attr">[  OK  ]</span></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>   #停止后<span class="selector-tag">VIP</span>已经漂移走</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:278240</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:223445</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:210664827</span> (<span class="number">200.9</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:57596785</span> (<span class="number">54.9</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:50175</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:50175</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3131100</span> (<span class="number">2.9</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3131100</span> (<span class="number">2.9</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure>
<h3 id="查看FailOver日志"><a href="#查看FailOver日志" class="headerlink" title="查看FailOver日志"></a>查看FailOver日志</h3><p>登录从库，查看MHAManager日志<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# tail -f /var/<span class="built_in">log</span>/masterha/app1/manager.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">IN</span> SCRIPT TEST====/etc/init.d/keepalived <span class="keyword">stop</span>==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  OK.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] <span class="keyword">Set</span> master ping interval <span class="number">1</span> seconds.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] <span class="keyword">Set</span> secondary check script: masterha_secondary_check -s <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> -s <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> --user=root hostname=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>  --master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --master_port=<span class="number">3306</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Starting ping health check <span class="keyword">on</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Ping(<span class="keyword">SELECT</span>) succeeded, waiting until MySQL doesn<span class="comment">'t respond..     #开始监听服务状态</span></span><br><span class="line">#监控到master故障后，MHA开始做自动FailOver</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">select</span> ping: <span class="number">2006</span> (MySQL <span class="built_in">server</span> has gone away)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Executing secondary network check script: masterha_secondary_check -s <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> -s <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> --user=root hostname=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>  --master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --master_port=<span class="number">3306</span>  --user=root  --master_host=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>  --master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>  --master_port=<span class="number">3306</span> --master_user=mha01 --master_password=mha123456 --ping_type=<span class="keyword">SELECT</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Executing SSH check script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Monitoring <span class="built_in">server</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> <span class="keyword">is</span> reachable, Master <span class="keyword">is</span> <span class="keyword">not</span> reachable from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>. OK.</span><br><span class="line">Monitoring <span class="built_in">server</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> <span class="keyword">is</span> reachable, Master <span class="keyword">is</span> <span class="keyword">not</span> reachable from <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>. OK.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Master <span class="keyword">is</span> <span class="keyword">not</span> reachable from all other monitoring servers. Failover should start.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">55</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL connect: <span class="number">2013</span> (Lost connection <span class="keyword">to</span> MySQL <span class="built_in">server</span> at <span class="comment">'reading initial communication packet', system error: 111)</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">55</span> <span class="number">2017</span> - [warning] Connection failed <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">56</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL connect: <span class="number">2013</span> (Lost connection <span class="keyword">to</span> MySQL <span class="built_in">server</span> at <span class="comment">'reading initial communication packet', system error: 111)</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">56</span> <span class="number">2017</span> - [warning] Connection failed <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL connect: <span class="number">2013</span> (Lost connection <span class="keyword">to</span> MySQL <span class="built_in">server</span> at <span class="comment">'reading initial communication packet', system error: 111)</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Connection failed <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Master <span class="keyword">is</span> <span class="keyword">not</span> reachable from health checker!</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Master <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>) <span class="keyword">is</span> <span class="keyword">not</span> reachable!</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] SSH <span class="keyword">is</span> reachable.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> a master <span class="built_in">server</span> failed. Reading configuration file /etc/masterha_default.cnf <span class="keyword">and</span> /etc/masterha/app1.cnf again, <span class="keyword">and</span> trying <span class="keyword">to</span> connect <span class="keyword">to</span> all servers <span class="keyword">to</span> check <span class="built_in">server</span> status..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Reading application <span class="keyword">default</span> configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Reading <span class="built_in">server</span> configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">1</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Dead Servers:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Alive Servers:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Alive Slaves:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Checking slave configurations..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Checking replication filtering settings..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]  Replication filtering check ok.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Master <span class="keyword">is</span> down!</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Terminating monitoring script.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Got <span class="keyword">exit</span> code <span class="number">20</span> (Master dead).</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] MHA::MasterFailover version <span class="number">0.57</span>.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Starting master failover.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">1</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Dead Servers:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Checking master reachability via MySQL(double check)...</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  ok.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Alive Servers:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Alive Slaves:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Starting GTID based failover.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Forcing shutdown so that applications never connect <span class="keyword">to</span> the current master..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Executing master IP deactivation script:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   /usr/local/bin/master_ip_failover --orig_master_host=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --orig_master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --orig_master_port=<span class="number">3306</span> --command=stopssh --ssh_user=root  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">IN</span> SCRIPT TEST====/etc/init.d/keepalived <span class="keyword">stop</span>==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Disabling the VIP <span class="keyword">on</span> old master: <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  done.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping <span class="keyword">explicit</span> shutting down of the dead master.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] The latest binary <span class="built_in">log</span> file/position <span class="keyword">on</span> all slaves <span class="keyword">is</span> mysql-bin<span class="number">.000005</span>:<span class="number">234</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Latest slaves (Slaves that received relay <span class="built_in">log</span> files <span class="keyword">to</span> the latest):</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] The oldest binary <span class="built_in">log</span> file/position <span class="keyword">on</span> all slaves <span class="keyword">is</span> mysql-bin<span class="number">.000005</span>:<span class="number">234</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Oldest slaves:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining <span class="keyword">New</span> Master Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Searching <span class="keyword">new</span> master from slaves..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Candidate masters from the configuration file:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Non-candidate masters:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Searching from candidate_master slaves which have received the latest relay <span class="built_in">log</span> events..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] <span class="keyword">New</span> master <span class="keyword">is</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Starting master failover..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">From:</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>) (current master)</span><br><span class="line"> +-<span class="number">-192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span>:</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) (<span class="keyword">new</span> master)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: <span class="keyword">New</span> Master Recovery Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Waiting all logs <span class="keyword">to</span> be applied.. </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   done.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Getting <span class="keyword">new</span> master<span class="comment">'s binlog name and position..</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  mysql-bin<span class="number">.000002</span>:<span class="number">4876</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER <span class="keyword">TO</span> MASTER_HOST=<span class="comment">'192.168.16.81', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='slave01', MASTER_PASSWORD='xxx';</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin<span class="number">.000002</span>, <span class="number">4876</span>, df5051fc-ae51<span class="number">-11e7</span><span class="number">-85</span>ee<span class="number">-00163e0</span>f0e4a:<span class="number">1</span><span class="number">-15</span>,</span><br><span class="line">e1ec82e8-ae51<span class="number">-11e7</span><span class="number">-8532</span><span class="number">-00163e128057</span>:<span class="number">1</span><span class="number">-6</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Executing master IP activate script:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   /usr/local/bin/master_ip_failover --command=start --ssh_user=root --orig_master_host=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --orig_master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --orig_master_port=<span class="number">3306</span> --new_master_host=<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> --new_master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> --new_master_port=<span class="number">3306</span> --new_master_user=<span class="comment">'mha01'   --new_master_password=xxx</span></span><br><span class="line">Unknown <span class="keyword">option</span>: new_master_user</span><br><span class="line">Unknown <span class="keyword">option</span>: new_master_password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">IN</span> SCRIPT TEST====/etc/init.d/keepalived <span class="keyword">stop</span>==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Enabling the VIP - <span class="number">192.168</span><span class="number">.16</span><span class="number">.200</span> <span class="keyword">on</span> the <span class="keyword">new</span> master - <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  OK.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Setting read_only=<span class="number">0</span> <span class="keyword">on</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  ok.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] ** Finished master recovery successfully.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.1</span>: Starting Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] All <span class="keyword">new</span> slave servers recovered successfully.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> master cleanup phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Resetting slave info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>: Resetting slave info succeeded.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Master failover <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) completed successfully.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line"></span><br><span class="line">----- Failover Report -----</span><br><span class="line"></span><br><span class="line">app1: MySQL Master failover <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>) <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) succeeded</span><br><span class="line"></span><br><span class="line">Master <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line">Check MHA Manager logs at slave:/var/<span class="built_in">log</span>/masterha/app1/manager.<span class="built_in">log</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated master IP address <span class="keyword">on</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Selected <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) as a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>): OK: Applying all logs succeeded.</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>): OK: Activated master IP address.</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>): Resetting slave info succeeded.</span><br><span class="line">Master failover <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) completed successfully.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Sending mail..</span><br><span class="line"><span class="keyword">Option</span> new_slave_hosts requires an argument</span><br><span class="line">Unknown <span class="keyword">option</span>: conf</span><br><span class="line">tail: /var/<span class="built_in">log</span>/masterha/app1/manager.<span class="built_in">log</span>: file truncated</span><br><span class="line">^C</span><br><span class="line">[<span class="number">1</span>]+  Done                    nohup masterha_manager --conf=/etc/masterha/app1.cnf  (wd: /etc/masterha)</span><br><span class="line">(wd <span class="built_in">now</span>: /var/<span class="built_in">log</span>/masterha/app1)</span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure></p>
<p><font color="#FF0000">注意：<br>由于阿里云的ECS默认不允许发送邮件，它们把25端口已经封掉，如果需要开通25端口，主联系阿里云技术支持。本次切换日志在最后没有发送邮件，是由于这个原因导致的。</font></p>
<h3 id="日志解析过程"><a href="#日志解析过程" class="headerlink" title="日志解析过程"></a>日志解析过程</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">启动前的准备工作</span><br><span class="line">检查数据库服务器状态,获取相关参数设置</span><br><span class="line">检查GTID、candidate_master、过滤DB是否设置</span><br><span class="line">测试ssh连接是否成功</span><br><span class="line">测试MHA <span class="keyword">node</span><span class="title">是否可用</span></span><br><span class="line"><span class="title">创建MHA</span>日志目录</span><br><span class="line">开始检查<span class="literal">slave</span>的差异日志应用权限</span><br><span class="line">确定当前的复制架构</span><br><span class="line">调试master_ip_failover_script</span><br><span class="line">调试shutdown_script</span><br><span class="line">设置二次检查的主机masterha_secondary_check</span><br><span class="line">MHA启动完毕,进入监测状态</span><br><span class="line">监测<span class="literal">master</span>服务器挂了</span><br><span class="line">通过定义的二次监测,确认<span class="literal">master</span>是否挂了</span><br><span class="line">确认<span class="literal">master</span>挂了,开始进入failover流程</span><br><span class="line">再试尝试连接<span class="literal">master</span>和<span class="literal">master</span>的ssh</span><br><span class="line">通过MHA配置文件,监测其他<span class="literal">slave</span>的状态</span><br><span class="line">再次监测<span class="literal">slave</span>的配置是否有变化,是否符合failover条件</span><br><span class="line">正式开始failover</span><br><span class="line">再次对<span class="literal">slave</span>配置做检查</span><br><span class="line">对原<span class="literal">Master</span>做master_ip_failover_script和shutdown_script的操作</span><br><span class="line">开始差异日志的恢复，获取<span class="literal">slave</span>最后得到的binlog位置</span><br><span class="line">获取原<span class="literal">master</span>的binlog日志</span><br><span class="line">确定新的<span class="literal">master</span></span><br><span class="line">在new <span class="literal">master</span>上应用差异的binlog日志</span><br><span class="line">获取new <span class="literal">master</span>的binlog位置。</span><br><span class="line">执行master_ip_failover_script,调用aws_vip_change.sh，执行VIP漂移</span><br><span class="line">开始恢复其他<span class="literal">slave</span>的差异日志</span><br><span class="line">差异日志应用完成以后,切换所有<span class="literal">slave</span>到new <span class="literal">master</span>。</span><br><span class="line">failover操作完成,生成failover报告</span><br><span class="line">最后发送邮件通知</span><br></pre></td></tr></table></figure>
<h3 id="确认FailOver状态"><a href="#确认FailOver状态" class="headerlink" title="确认FailOver状态"></a>确认FailOver状态</h3><p>登录从库，查看VIP是否漂移过程<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@slave app1]</span># <span class="selector-tag">ifconfig</span>     <span class="selector-id">#VIP</span>已经漂移过程</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:80</span><span class="selector-pseudo">:57</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.81</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:295022</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:135929</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:212253710</span> (202<span class="selector-class">.4</span> <span class="selector-tag">MiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:52246361</span> (49<span class="selector-class">.8</span> <span class="selector-tag">MiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:80</span><span class="selector-pseudo">:57</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:52973</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:52973</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3597938</span> (3<span class="selector-class">.4</span> <span class="selector-tag">MiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3597938</span> (3<span class="selector-class">.4</span> <span class="selector-tag">MiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@slave app1]</span>#</span><br></pre></td></tr></table></figure></p>
<p>登录主库，查看VIP是否存在，keepalived服务状态<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>   <span class="selector-id">#VIP</span>已经不存在</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:284277</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:229786</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:211190989</span> (<span class="number">201.4</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:60010868</span> (<span class="number">57.2</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:51564</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:51564</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3217146</span> (<span class="number">3.0</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3217146</span> (<span class="number">3.0</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">keepalived</span> <span class="selector-tag">status</span>  <span class="selector-id">#keepalived</span>服务已经停止</span><br><span class="line"><span class="selector-tag">keepalived</span> <span class="selector-tag">is</span> <span class="selector-tag">stopped</span></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure></p>
<h3 id="手动FailOver"><a href="#手动FailOver" class="headerlink" title="手动FailOver"></a>手动FailOver</h3><p>MHA的手动FailOver不在本文范围，详情理论可参考官方文档。</p>
<h3 id="参数列表"><a href="#参数列表" class="headerlink" title="参数列表"></a>参数列表</h3><p>请参考之前<a href="https://dwj999.github.io/AWS-EC2%E6%90%AD%E5%BB%BAmha-vip-MySQL5-7.html#参数列表">文章</a>。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://dwj999.github.io/AWS-EC2搭建mha-vip-MySQL5-7.htm">https://dwj999.github.io/AWS-EC2搭建mha-vip-MySQL5-7.htm</a></p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>云服务器上MySQL高可用，也可通过云负载均衡产品+MySQL复制来实现，但在数据安全性上，没有MHA+VIP+MySQL相对安全。</p>

      
    </div>
    
    
    

    

    

    
<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

  
</div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MySQL/" rel="tag"># MySQL</a>
          
            <a href="/tags/VIP/" rel="tag"># VIP</a>
          
            <a href="/tags/MHA/" rel="tag"># MHA</a>
          
            <a href="/tags/Aliyun/" rel="tag"># Aliyun</a>
          
            <a href="/tags/ECS/" rel="tag"># ECS</a>
          
            <a href="/tags/Keepalived/" rel="tag"># Keepalived</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/ProxySQL-安装配置详解及读写分离、负载均衡.html" rel="next" title="ProxySQL 安装配置详解及读写分离、负载均衡">
                <i class="fa fa-chevron-left"></i> ProxySQL 安装配置详解及读写分离、负载均衡
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/MySQL-Group-Replication初探.html" rel="prev" title="MySQL Group Replication初探">
                MySQL Group Replication初探 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jiessie</p>
              <p class="site-description motion-element" itemprop="description">最怕一生碌碌无为,还说平凡难能可贵！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA简介"><span class="nav-number">2.</span> <span class="nav-text">MHA简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高可用虚拟IP限制"><span class="nav-number">3.</span> <span class="nav-text">高可用虚拟IP限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备"><span class="nav-number">4.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#系统初始化修改"><span class="nav-number">5.</span> <span class="nav-text">系统初始化修改</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#修改主机名"><span class="nav-number">5.1.</span> <span class="nav-text">修改主机名</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库修改主机名"><span class="nav-number">5.1.1.</span> <span class="nav-text">主库修改主机名</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库修改主机名"><span class="nav-number">5.1.2.</span> <span class="nav-text">从库修改主机名</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#设置防火墙"><span class="nav-number">5.2.</span> <span class="nav-text">设置防火墙</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库设置，允许从库访问"><span class="nav-number">5.2.1.</span> <span class="nav-text">主库设置，允许从库访问</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库设置，允许主库访问"><span class="nav-number">5.2.2.</span> <span class="nav-text">从库设置，允许主库访问</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#关闭SELINUX"><span class="nav-number">5.3.</span> <span class="nav-text">关闭SELINUX</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库查看"><span class="nav-number">5.3.1.</span> <span class="nav-text">主库查看</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库查看"><span class="nav-number">5.3.2.</span> <span class="nav-text">从库查看</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#建立SSH无密码登录"><span class="nav-number">6.</span> <span class="nav-text">建立SSH无密码登录</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主库设置"><span class="nav-number">6.1.</span> <span class="nav-text">主库设置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从库设置"><span class="nav-number">6.2.</span> <span class="nav-text">从库设置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL安装"><span class="nav-number">7.</span> <span class="nav-text">MySQL安装</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL互为主备"><span class="nav-number">8.</span> <span class="nav-text">MySQL互为主备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#重要参数配置"><span class="nav-number">8.1.</span> <span class="nav-text">重要参数配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制帐号建立"><span class="nav-number">8.2.</span> <span class="nav-text">复制帐号建立</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库创建"><span class="nav-number">8.2.1.</span> <span class="nav-text">主库创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库创建"><span class="nav-number">8.2.2.</span> <span class="nav-text">从库创建</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制帐号验证"><span class="nav-number">8.3.</span> <span class="nav-text">复制帐号验证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制关系配置"><span class="nav-number">8.4.</span> <span class="nav-text">复制关系配置</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库配置"><span class="nav-number">8.4.1.</span> <span class="nav-text">主库配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库配置"><span class="nav-number">8.4.2.</span> <span class="nav-text">从库配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#复制测试"><span class="nav-number">8.5.</span> <span class="nav-text">复制测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库登录测试"><span class="nav-number">8.5.1.</span> <span class="nav-text">主库登录测试</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库登录测试"><span class="nav-number">8.5.2.</span> <span class="nav-text">从库登录测试</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHA帐号创建"><span class="nav-number">8.6.</span> <span class="nav-text">MHA帐号创建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库创建-1"><span class="nav-number">8.6.1.</span> <span class="nav-text">主库创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库创建-1"><span class="nav-number">8.6.2.</span> <span class="nav-text">从库创建</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA安装"><span class="nav-number">9.</span> <span class="nav-text">MHA安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装依赖"><span class="nav-number">9.1.</span> <span class="nav-text">安装依赖</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主库安装mha4mysql-node"><span class="nav-number">9.2.</span> <span class="nav-text">主库安装mha4mysql-node</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#从库安装mha4mysql-manager和mha4mysql-node"><span class="nav-number">9.3.</span> <span class="nav-text">从库安装mha4mysql-manager和mha4mysql-node</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA目录结构说明"><span class="nav-number">10.</span> <span class="nav-text">MHA目录结构说明</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MHAManager"><span class="nav-number">10.1.</span> <span class="nav-text">MHAManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHANode"><span class="nav-number">10.2.</span> <span class="nav-text">MHANode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自定义扩展脚本说明"><span class="nav-number">10.3.</span> <span class="nav-text">自定义扩展脚本说明</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#keepalived安装"><span class="nav-number">11.</span> <span class="nav-text">keepalived安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置文件"><span class="nav-number">11.1.</span> <span class="nav-text">配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库配置-1"><span class="nav-number">11.1.1.</span> <span class="nav-text">主库配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库配置-1"><span class="nav-number">11.1.2.</span> <span class="nav-text">从库配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EIP漂移测试"><span class="nav-number">11.2.</span> <span class="nav-text">EIP漂移测试</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#主库启动keepalived服务"><span class="nav-number">11.2.1.</span> <span class="nav-text">主库启动keepalived服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从库启动keepalived服务"><span class="nav-number">11.2.2.</span> <span class="nav-text">从库启动keepalived服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看默认EIP在主库上"><span class="nav-number">11.2.3.</span> <span class="nav-text">查看默认EIP在主库上</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#关闭主库的keepalived服务"><span class="nav-number">11.2.4.</span> <span class="nav-text">关闭主库的keepalived服务</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#查看EIP是否漂移到从库上"><span class="nav-number">11.2.5.</span> <span class="nav-text">查看EIP是否漂移到从库上</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#恢复原状"><span class="nav-number">11.2.6.</span> <span class="nav-text">恢复原状</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA配置"><span class="nav-number">12.</span> <span class="nav-text">MHA配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MHAManager-1"><span class="nav-number">12.1.</span> <span class="nav-text">MHAManager</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试MHAManager-SSH"><span class="nav-number">12.2.</span> <span class="nav-text">测试MHAManager SSH</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#测试MHAManager-复制"><span class="nav-number">12.3.</span> <span class="nav-text">测试MHAManager 复制</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA引入keepalived"><span class="nav-number">13.</span> <span class="nav-text">MHA引入keepalived</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#master-ip-failover脚本"><span class="nav-number">13.1.</span> <span class="nav-text">master_ip_failover脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#send-report脚本"><span class="nav-number">13.2.</span> <span class="nav-text">send_report脚本</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MHAManager修改注释"><span class="nav-number">13.3.</span> <span class="nav-text">MHAManager修改注释</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HaVip绑定EIP"><span class="nav-number">14.</span> <span class="nav-text">HaVip绑定EIP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MHA启动"><span class="nav-number">15.</span> <span class="nav-text">MHA启动</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#查看启动日志"><span class="nav-number">15.1.</span> <span class="nav-text">查看启动日志</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#模拟主库故障-自动FailOver"><span class="nav-number">16.</span> <span class="nav-text">模拟主库故障(自动FailOver)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#确认MHAManager进程状态"><span class="nav-number">16.1.</span> <span class="nav-text">确认MHAManager进程状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#停止主库MySQL服务"><span class="nav-number">16.2.</span> <span class="nav-text">停止主库MySQL服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看FailOver日志"><span class="nav-number">16.3.</span> <span class="nav-text">查看FailOver日志</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#日志解析过程"><span class="nav-number">16.4.</span> <span class="nav-text">日志解析过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#确认FailOver状态"><span class="nav-number">16.5.</span> <span class="nav-text">确认FailOver状态</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#手动FailOver"><span class="nav-number">16.6.</span> <span class="nav-text">手动FailOver</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参数列表"><span class="nav-number">16.7.</span> <span class="nav-text">参数列表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">17.</span> <span class="nav-text">参考</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结束语"><span class="nav-number">18.</span> <span class="nav-text">结束语</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiessie</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count"></span>
  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

</body>
</html>
