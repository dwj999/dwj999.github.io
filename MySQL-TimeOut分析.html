<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="MySQL," />




  


  <link rel="alternate" href="/atom.xml" title="Jiessie's' Blog" type="application/atom+xml" />






<meta name="description" content="引言在做日常mysql数据库维护过程，时长会遇到关于mysql timeout的相关报错，了解mysql的连接过程和常见的错误类型，知己知彼，可以更好去运维mysql，做到心中有数。 MySQL连接参数和网络超时相关的参数，这里做下简单说明：  interactive_timeout 1服务器在关闭之前等待交互式连接的超时时间，交互式客户端定义为在mysql_real_connect()中使用CL">
<meta name="keywords" content="MySQL">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL TimeOut分析">
<meta property="og:url" content="https://dwj999.github.io/MySQL-TimeOut分析.html">
<meta property="og:site_name" content="Jiessie&#39;s&#39; Blog">
<meta property="og:description" content="引言在做日常mysql数据库维护过程，时长会遇到关于mysql timeout的相关报错，了解mysql的连接过程和常见的错误类型，知己知彼，可以更好去运维mysql，做到心中有数。 MySQL连接参数和网络超时相关的参数，这里做下简单说明：  interactive_timeout 1服务器在关闭之前等待交互式连接的超时时间，交互式客户端定义为在mysql_real_connect()中使用CL">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_1.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_2.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_3.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_4.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_5.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_6.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_7.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_8.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_9.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_10.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_11.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_12.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_13.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_14.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_15.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_16.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_17.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_18.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_19.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_20.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_21.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_22.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_23.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_24.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_25.png">
<meta property="og:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_26.png">
<meta property="og:updated_time" content="2020-05-21T01:26:03.431Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="MySQL TimeOut分析">
<meta name="twitter:description" content="引言在做日常mysql数据库维护过程，时长会遇到关于mysql timeout的相关报错，了解mysql的连接过程和常见的错误类型，知己知彼，可以更好去运维mysql，做到心中有数。 MySQL连接参数和网络超时相关的参数，这里做下简单说明：  interactive_timeout 1服务器在关闭之前等待交互式连接的超时时间，交互式客户端定义为在mysql_real_connect()中使用CL">
<meta name="twitter:image" content="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_1.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dwj999.github.io/MySQL-TimeOut分析.html"/>





<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

  <title>MySQL TimeOut分析 | Jiessie's' Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"><a href="https://github.com/dwj999" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jiessie's' Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">没伞的孩子必须努力奔跑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/MySQL-TimeOut分析.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">MySQL TimeOut分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-05T11:23:10+08:00">
                2018-08-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>在做日常mysql数据库维护过程，时长会遇到关于mysql timeout的相关报错，了解mysql的连接过程和常见的错误类型，知己知彼，可以更好去运维mysql，做到心中有数。</p>
<h2 id="MySQL连接参数"><a href="#MySQL连接参数" class="headerlink" title="MySQL连接参数"></a>MySQL连接参数</h2><p>和网络超时相关的参数，这里做下简单说明：</p>
<ul>
<li><p>interactive_timeout</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">服务器在关闭之前等待交互式连接的超时时间，交互式客户端定义为在mysql_real_<span class="keyword">connect</span><span class="params">()</span>中使用CLIENT_INTERACTIVE选项的客户端。像mysql客户端是交互式客户端。</span><br></pre></td></tr></table></figure>
</li>
<li><p>wait_timeout</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">服务器关闭非交互式连接之前等待活动的秒数，在线程启动时，根据全局<span class="selector-tag">wait_timeout</span>值或全局<span class="selector-tag">interactive_timeout</span>值初始化会话<span class="selector-tag">wait_timeout</span>值，取决于客户端类型(由mysql_real_connect()的连接选项CLIENT_INTERACTIVE定义)。像<span class="selector-tag">java</span>使用的<span class="selector-tag">jdbc</span>连接，<span class="selector-tag">php</span>使用<span class="selector-tag">pdo</span>连接等都是非交互式连接。</span><br></pre></td></tr></table></figure>
</li>
<li><p>net_read_timeout</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在终止读之前，从一个连接获得数据而等待的时间秒数；当服务正在从客户端读取数据时，net_read_timeout控制何时超时。例如<span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> <span class="keyword">infile</span>语句。</span><br></pre></td></tr></table></figure>
</li>
<li><p>net_write_timeout</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在终止写之前，等待多少秒把<span class="built_in">block</span>写到连接，当服务正在写数据到客户端时，net_write_timeout控制何时超时</span><br></pre></td></tr></table></figure>
</li>
<li><p>connect_timeout</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在连接认证阶段的网络交互超时时间(<span class="keyword">ref</span> login_connection)。</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="MySQL连接过程"><a href="#MySQL连接过程" class="headerlink" title="MySQL连接过程"></a>MySQL连接过程</h2><p>其中</p>
<ul>
<li>connect_timeout    在获取连接阶段（authenticate）起作用</li>
<li>interactive_timeout和wait_timeout    在连接空闲阶段（sleep）起作用</li>
<li>net_read_timeout和net_write_timeout    则是在连接繁忙阶段（query）起作用。<h3 id="mysql通信协议"><a href="#mysql通信协议" class="headerlink" title="mysql通信协议"></a>mysql通信协议</h3>mysql 客户端和服务端之间的通信协议是”半双工”， 在任何一个时刻，要么是由服务端向客户端发送数据，要么是由客户端向服务端发送数据，这两个动作不能同时发生。参数max_allowed_packet在做导入数据的时候，net_buffer_length在缓冲数据的时候就很重要了。<h3 id="connect-timeout"><a href="#connect-timeout" class="headerlink" title="connect_timeout"></a>connect_timeout</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Connect_timeout</span><br><span class="line">The number of seconds that the mysqld<span class="built_in"> server </span>waits <span class="keyword">for</span> a connect packet before responding with Bad handshake</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>MySQL连接一次连接需求经过6次“握手”方可成功，任意一次“握手”失败都有可能导致连接失败，前三次握手可以简单理解为TCP建立连接所必须的三次握手，MySQL无法控制，更多的受制于不TCP协议的不同实现，后面的三次握手过程超时与connect_timeout有关。<br><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_1.png" alt="image"></p>
<p>建立连接步骤：</p>
<ol>
<li>客户端向DB发起TCP握手</li>
<li>三次握手成功，由DB发送HandShake信息，这个Packet里面包含了MySql的能力、加密seed等信息。</li>
<li>客户端根据HandShake包里面的加密seed对MySql登录密码进行摘要后，构造Auth认证包发送给DB。</li>
<li>DB接收到客户端发过来的Auth包后会对密码摘要进行比对，从而确认是否能够登录。如果能，则发送Okay包返回。</li>
<li>客户端与DB的连接至此完毕。</li>
</ol>
<h3 id="net-read-timeout-amp-amp-net-write-timeout"><a href="#net-read-timeout-amp-amp-net-write-timeout" class="headerlink" title="net_read_timeout &amp;&amp; net_write_timeout"></a>net_read_timeout &amp;&amp; net_write_timeout</h3><p>当connect建立后，读取命令的流程如下：</p>
<ol>
<li>read_packet    通过函数my_net_read读取数据包，如果一次读不完成，则调用函数net_read_raw_loop进行循环读取，读取的超时由wait_timeout决定<br>1）    会先读取packet header，一个普通的packet header包含4个字节，压缩协议下则另外再加3个字节<br>2）    再从packet header中提取剩下的packet长度，继续从socket读取</li>
<li>vio_read_buff    vio封装了所有对socket的操作,当read_packet完成后，进入到vio相关的函数做封装处理，包括vio_init, vio_read_buffer,vio_read等。</li>
<li>my_net_write    mysql通过read_packet做过相关处理后，通过my_net_write函数将数据先拷贝到NET缓冲区，当长度大于MAX_PACKET_LENGTH(即4MB-1字节)会对Packet进行拆分成多个packet。每个Packet的头部都会留4个字节，其中：1~3字节，存储该packet的长度，第4个字节存储当前的packet的序号，每存储一次后递增net-&gt;pkt_nr。<br>每个Net对象有一个Buff(net-&gt;buff)，即将发送的数据被拷贝到这个buffer中，当Buffer满时需要立刻发出到客户端。如果Buffer足够大，则只做memcpy操作。net-&gt;write_pos被更新到写入结束的位置偏移量 (net_write_buff)。<br>如果一次写入的数据被拆分成多个Packet，那么net-&gt;pkt_nr也对应的递增多次. pkt_nr的作用是在客户端解析时，防止包发送乱序。</li>
<li>net_flush    在my_net_write函数中，如果net-&gt;buff不够用，已经会做网络写了，net_flush最终保证所有在buff中的数据被写到网络。</li>
<li>net_write_raw_loop    当packet准备好发送后，调用函数net_write_raw_loop开始进行数据发送。<br>1）    在发送模式受vio-&gt;write_timeout影响(通过参数net_write_timeout控制)；当该参数被设置成大于等于0时，使用非阻塞模式send数据包(MSG_DONTWAIT)<br>2）    若网络发送被中断（EINTR），会去尝试重传<br>3）    使用非阻塞模式send，每次并不保证数据全部发送完毕，因此需要循环的调用直到所有的数据都发送完毕<br>4）    当输出缓冲区满时，获得错误码EWOULDBLOCK/EAGAIN,则阻塞等待(vio_socket_io_wait)，最大等待时间为net_write_timeout，超时则返回错误</li>
</ol>
<h3 id="interactive-timeout-amp-amp-wait-timeout"><a href="#interactive-timeout-amp-amp-wait-timeout" class="headerlink" title="interactive_timeout &amp;&amp; wait_timeout"></a>interactive_timeout &amp;&amp; wait_timeout</h3><p>当query处理完成后，连接会进入到空闲阶段，此时受interactive_timeout和wait_timeout控制。关于interactive_timeout和wait_timeout，session和global有继承关系，可以自己测试，这里有篇<a href="http://blog.itpub.net/22664653/viewspace-2143671/" target="_blank" rel="noopener">文章</a>，测试的很详细。</p>
<h2 id="MySQL超时类型"><a href="#MySQL超时类型" class="headerlink" title="MySQL超时类型"></a>MySQL超时类型</h2><h3 id="Got-timeout-reading-communication-packets"><a href="#Got-timeout-reading-communication-packets" class="headerlink" title="Got timeout reading communication packets"></a>Got timeout reading communication packets</h3><h4 id="连接超时"><a href="#连接超时" class="headerlink" title="连接超时"></a>连接超时</h4><p>设置interactive_timeout和wait_timeout，使用mysql客户端连接，等待设置的超时时间后被mysql kill掉，在日志观察详情</p>
<h5 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h5><p>设置interactive_timeout和wait_timeout</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_2.png" alt="image"></p>
<h5 id="观察日志"><a href="#观察日志" class="headerlink" title="观察日志"></a>观察日志</h5><p>通过观察error log查看连接是否断开</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_3.png" alt="image"></p>
<p>其中，连接的thread_id为2885，超过10s后断开，出现<font color="FF0000"><b>日志详情</b></font><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-03</span><span class="string">T10:</span><span class="number">11</span>:<span class="number">48.650754</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">2885</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">2885</span> to <span class="string">db:</span> <span class="string">'unconnected'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got timeout reading communication packets).</span><br></pre></td></tr></table></figure></p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>其他常见的错误，可以参考<a href="https://dev.mysql.com/doc/refman/5.7/en/communication-errors.html" target="_blank" rel="noopener">官方文档</a>，有详情的介绍，也可根据实际测试结果来验证。</p>
<h3 id="Got-an-error-reading-communication-packets"><a href="#Got-an-error-reading-communication-packets" class="headerlink" title="Got an error reading communication packets"></a>Got an error reading communication packets</h3><h4 id="客户端异常退出-数据包异常"><a href="#客户端异常退出-数据包异常" class="headerlink" title="客户端异常退出(数据包异常)"></a>客户端异常退出(<font color="FF0000"><b>数据包异常</b></font>)</h4><p>使用pt-kill工具监控mysql的语句，通过在mysql确认pt-kill守护进程存在，kill掉此进程，观察日志的详情</p>
<h5 id="准备-1"><a href="#准备-1" class="headerlink" title="准备"></a>准备</h5><ol>
<li>pt-kill安装<br>安装pt-kill工具，测试机使用ubuntu 16.04机器，直接使用以下命令：<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -c https:<span class="comment">//www.percona.com/downloads/percona-toolkit/3.0.10/binary/debian/xenial/x86_64/percona-toolkit_3.0.10-1.xenial_amd64.deb</span></span><br><span class="line">dpkg -<span class="selector-tag">i</span> percona-toolkit_3.<span class="number">0.10</span>-<span class="number">1</span><span class="selector-class">.xenial_amd64</span><span class="selector-class">.deb</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="pt-kill测试"><a href="#pt-kill测试" class="headerlink" title="pt-kill测试"></a>pt-kill测试</h5><ol>
<li>运行pt-kill进程<br>命令：<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> localhost <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql/data/mysql.sock</span> <span class="params">--match-host=</span><span class="string">"127.0.0.1|localhost"</span> <span class="params">--match-user=</span><span class="string">"root"</span> <span class="params">--match-db=</span><span class="string">"sysbench|test"</span> <span class="params">--match-command=</span><span class="string">"Query"</span> <span class="params">--match-state=</span><span class="string">"statistics"</span> <span class="params">--match-info=</span><span class="string">"(?i-xsm:select)"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1  <span class="params">--kill-query</span> <span class="params">--daemonize</span> <span class="params">--print</span> <span class="params">--log=/tmp/pt-kill</span>.log</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_4.png" alt="image"></p>
<ol start="2">
<li>查看pt-kill进程</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_5.png" alt="image"></p>
<ol start="3">
<li>查看mysql相关pt-kill进程</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_6.png" alt="image"></p>
<ol start="4">
<li>Kill掉pt-kill进程</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_7.png" alt="image"></p>
<ol start="5">
<li>观察日志<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-02</span><span class="string">T15:</span><span class="number">21</span>:<span class="number">32.254962</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">62476</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">62476</span> to <span class="string">db:</span> <span class="string">'unconnected'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error readin</span><br><span class="line">g communication packets).</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_8.png" alt="image"></p>
<h4 id="网络错误"><a href="#网络错误" class="headerlink" title="网络错误"></a>网络错误</h4><h5 id="准备-2"><a href="#准备-2" class="headerlink" title="准备"></a>准备</h5><p>使用linux自带的tc命令篡改数据包，设置网卡随机产生30%的<font color="FF0000"><b>损坏数据包</b></font>，也可使用tc的其他场景，比如<font color="FF0000"><b>数据包重复</b></font>等待去做各种测试，这里仅使用2种场景分别测试损坏数据包时，是否产生Got an error writing communication packets的情况</p>
<ol>
<li>设置tc数据包修改: 命令，由于测试的机器包括多块网卡，这里全部设置：<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tc  qdisc  <span class="keyword">add</span><span class="bash">  dev  eth0  root  netem  corrupt  30% </span></span><br><span class="line"><span class="bash">tc  qdisc  add  dev  eth1  root  netem  corrupt  30%</span></span><br><span class="line"><span class="bash">tc  qdisc  add  dev  lo  root  netem  corrupt  30%</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_9.png" alt="image"></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_10.png" alt="image"></p>
<ol start="2">
<li>ping结果查看: 通过ping查看，tc的设置已经生效，出现了损坏数据包</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_11.png" alt="image"></p>
<h5 id="sysbench测试"><a href="#sysbench测试" class="headerlink" title="sysbench测试"></a>sysbench测试</h5><p>通过在sysbench压测过程中，人工设置，模拟网络出现问题的情况，观察日志</p>
<ol>
<li>sysbench压测<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/sysbench <span class="attribute">--db-driver</span>=mysql <span class="attribute">--mysql-socket</span>=/opt/mysql/data/mysql.sock <span class="attribute">--tables</span>=1 <span class="attribute">--table_size</span>=1000000 <span class="attribute">--report-interval</span>=10 <span class="attribute">--time</span>=3600 <span class="attribute">--mysql-port</span>=3306 <span class="attribute">--mysql-user</span>=root <span class="attribute">--mysql-password</span>=111111 <span class="attribute">--mysql-db</span>=sysbench <span class="attribute">--mysql-host</span>=10.30.167.90 <span class="attribute">--max-requests</span>=0 /usr/local/share/sysbench/oltp_read_write.lua <span class="attribute">--threads</span>=4 run</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>压测结果：</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_12.png" alt="image"></p>
<ol start="2">
<li>观察error log</li>
</ol>
<p>已经出现了Got an error writing communication packets相关告警信息<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-02</span><span class="string">T16:</span><span class="number">35</span>:<span class="number">51.858793</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">65764</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">65764</span> to <span class="string">db:</span> <span class="string">'sysbench'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error writing communication packets).</span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-02</span><span class="string">T16:</span><span class="number">35</span>:<span class="number">51.899059</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">65767</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">65767</span> to <span class="string">db:</span> <span class="string">'sysbench'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error writing communication packets).</span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-02</span><span class="string">T16:</span><span class="number">35</span>:<span class="number">51.899260</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">65765</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">65765</span> to <span class="string">db:</span> <span class="string">'sysbench'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error writing communication packets).</span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-02</span><span class="string">T16:</span><span class="number">35</span>:<span class="number">51.899339</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">65766</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">65766</span> to <span class="string">db:</span> <span class="string">'sysbench'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error writing communication packets).</span><br></pre></td></tr></table></figure></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_13.png" alt="image"></p>
<h5 id="php测试"><a href="#php测试" class="headerlink" title="php测试"></a>php测试</h5><p>通过以运行php代码的形式来访问数据，人工设置，模拟网络出现问题的情况，观察日志</p>
<ol>
<li>php代码运行<br>这里以互联网在线模拟为例子，地址：<a href="https://www.dooccn.com/php/" target="_blank" rel="noopener">https://www.dooccn.com/php/</a></li>
</ol>
<p>代码详情：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">header(<span class="string">'content-type:text/html;charset=utf-8'</span>);</span></span><br><span class="line"><span class="php"><span class="keyword">try</span> &#123;  </span></span><br><span class="line"><span class="php">    $db = <span class="keyword">new</span> PDO(<span class="string">'mysql:host=118.190.67.67;dbname=mysql'</span>, <span class="string">'root'</span>, <span class="string">'xxx'</span>);  </span></span><br><span class="line"><span class="php">    <span class="comment">//查询  </span></span></span><br><span class="line"><span class="php">	$rows = $db-&gt;query(<span class="string">'SELECT sleep(100)'</span>)-&gt;fetch(PDO::FETCH_ASSOC);</span></span><br><span class="line"><span class="php">	$rs = <span class="keyword">array</span>();</span></span><br><span class="line"><span class="php">    <span class="keyword">foreach</span>($rows <span class="keyword">as</span> $row) &#123;  </span></span><br><span class="line"><span class="php">        $rs[] = $row; </span></span><br><span class="line"><span class="php">    &#125;  </span></span><br><span class="line"><span class="php">    $db = <span class="keyword">null</span>;  </span></span><br><span class="line"><span class="php">&#125; <span class="keyword">catch</span> (PDOException $e) &#123;  </span></span><br><span class="line"><span class="php">    <span class="keyword">print</span> <span class="string">"Error!: "</span> . $e-&gt;getMessage() . <span class="string">"&lt;br/&gt;"</span>;  </span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>();  </span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">print_r($rs);</span></span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>观察error log</li>
</ol>
<p>已经出现了Got an error writing communication packets相关告警信息<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-02</span><span class="string">T16:</span><span class="number">37</span>:<span class="number">31.183490</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">66089</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">66089</span> to <span class="string">db:</span> <span class="string">'mysql'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'106.14.17.222'</span> (Got an error reading communication packets).</span><br></pre></td></tr></table></figure></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_14.png" alt="image"></p>
<h4 id="max-prepared-stmt-count"><a href="#max-prepared-stmt-count" class="headerlink" title="max_prepared_stmt_count"></a>max_prepared_stmt_count</h4><ul>
<li>max_prepared_stmt_count<br>此参数限制了同一时间在mysqld上所有session中prepared 语句的上限。一般做压力测试的prepare阶段可以会遇到此参数设置较小的问题，同时日志中会返回Got an error reading communication packets的错误，这里不再测试，在做压力测试时，需要将此参数设置大些。</li>
</ul>
<h5 id="准备-3"><a href="#准备-3" class="headerlink" title="准备"></a>准备</h5><ol>
<li>设置max_prepared_stmt_count</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_15.png" alt="image"></p>
<h5 id="sysbench测试-1"><a href="#sysbench测试-1" class="headerlink" title="sysbench测试"></a>sysbench测试</h5><ol>
<li><p>运行压力测试</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/sysbench <span class="attribute">--db-driver</span>=mysql <span class="attribute">--mysql-socket</span>=/opt/mysql/data/mysql.sock <span class="attribute">--tables</span>=1 <span class="attribute">--table_size</span>=1000000 <span class="attribute">--report-interval</span>=10 <span class="attribute">--time</span>=3600 <span class="attribute">--mysql-port</span>=3306 <span class="attribute">--mysql-user</span>=root <span class="attribute">--mysql-password</span>=111111 <span class="attribute">--mysql-db</span>=sysbench <span class="attribute">--mysql-host</span>=10.30.167.90 <span class="attribute">--max-requests</span>=0 /usr/local/share/sysbench/oltp_read_write.lua <span class="attribute">--threads</span>=4 run</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看sysbench日志</p>
</li>
</ol>
<p>在11.04的时候运行的压力测试</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_16.png" alt="image"></p>
<ol start="3">
<li>查看mysql log<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-03</span><span class="string">T11:</span><span class="number">04</span>:<span class="number">07.696809</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">5366</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">5366</span> to <span class="string">db:</span> <span class="string">'sysbench'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error reading communication packets).</span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-03</span><span class="string">T11:</span><span class="number">04</span>:<span class="number">07.696884</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">5365</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">5365</span> to <span class="string">db:</span> <span class="string">'sysbench'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error reading communication packets).</span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-03</span><span class="string">T11:</span><span class="number">04</span>:<span class="number">07.696959</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">5364</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">5364</span> to <span class="string">db:</span> <span class="string">'sysbench'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error reading communication packets).</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_17.png" alt="image"></p>
<h4 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h4><p>其他常见的错误，可以参考<a href="https://dev.mysql.com/doc/refman/5.7/en/communication-errors.html" target="_blank" rel="noopener">官方文档</a>，有详情的介绍，也可根据实际测试结果来验证。</p>
<h3 id="Lost-connection-to-MySQL-server-during-query"><a href="#Lost-connection-to-MySQL-server-during-query" class="headerlink" title="Lost connection to MySQL server during query"></a>Lost connection to MySQL server during query</h3><h4 id="超时connect-timeout"><a href="#超时connect-timeout" class="headerlink" title="超时connect_timeout"></a>超时connect_timeout</h4><p>使用linux自带的tc命令设置网络延迟，达到测试所需要的效果</p>
<h5 id="准备-4"><a href="#准备-4" class="headerlink" title="准备"></a>准备</h5><ol>
<li>设置tc数据包延迟：命令，由于测试的机器包括多块网卡，这里全部设置：<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc <span class="keyword">add</span><span class="bash"> dev eth1 root netem delay 11000ms</span></span><br><span class="line"><span class="bash">tc qdisc add dev eth0 root netem delay 11000ms</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_18.png" alt="image"></p>
<h5 id="登录连接测试"><a href="#登录连接测试" class="headerlink" title="登录连接测试"></a>登录连接测试</h5><p>通过远程连接其他mysql服务器，查看登录效果，超过了默认connect_timeout的10s，报Lost connection to MySQL server during query错误</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_19.png" alt="image"></p>
<h4 id="客户端异常退出-数据包正常"><a href="#客户端异常退出-数据包正常" class="headerlink" title="客户端异常退出(数据包正常)"></a>客户端异常退出(<font color="FF0000"><b>数据包正常</b></font>)</h4><p>开启2个session窗口，连接同一个mysql实例，第1个session开启查询，第2个session去kill掉第一个session</p>
<h5 id="准备-5"><a href="#准备-5" class="headerlink" title="准备"></a>准备</h5><ol>
<li>Session1开启查询</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_20.png" alt="image"></p>
<h5 id="手动kill"><a href="#手动kill" class="headerlink" title="手动kill"></a>手动kill</h5><ol>
<li>Session2查看processlist</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_21.png" alt="image"></p>
<ol start="2">
<li>session2 手动kill session1连接</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_22.png" alt="image"></p>
<ol start="3">
<li>session1查看查询</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_23.png" alt="image"></p>
<h4 id="其他-2"><a href="#其他-2" class="headerlink" title="其他"></a>其他</h4><p>其他常见的错误，可以参考<a href="https://dev.mysql.com/doc/refman/5.7/en/error-lost-connection.html" target="_blank" rel="noopener">官方文档</a>，有详情的介绍，也可根据实际测试结果来验证。</p>
<h3 id="MySQL-server-has-gone-away"><a href="#MySQL-server-has-gone-away" class="headerlink" title="MySQL server has gone away"></a>MySQL server has gone away</h3><h4 id="MySQL-server-has-gone-away-1"><a href="#MySQL-server-has-gone-away-1" class="headerlink" title="MySQL server has gone away"></a>MySQL server has gone away</h4><p>设置mysql的interactive_timeout，使用mysql客户端开启一个窗口</p>
<h5 id="准备-6"><a href="#准备-6" class="headerlink" title="准备"></a>准备</h5><ol>
<li>设置interactive_timeout的值</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_24.png" alt="image"></p>
<h5 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h5><ol>
<li>在同一窗口内执行查询select sleep(10)</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_25.png" alt="image"></p>
<ol start="2">
<li>等待超过interactive_timeout时间后，再次执行查询</li>
</ol>
<p>已经出现的错误日志：MySQL server has gone away</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_26.png" alt="image"></p>
<h4 id="其他-3"><a href="#其他-3" class="headerlink" title="其他"></a>其他</h4><p>其他常见的错误，可以参考<a href="https://dev.mysql.com/doc/refman/5.7/en/gone-away.html" target="_blank" rel="noopener">官方文档</a>，有详情的介绍，也可根据实际测试结果来验证。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//mysql.taobao.org/monthly/2016/07/04/</span></span><br><span class="line"><span class="symbol">http:</span><span class="comment">//mysql.taobao.org/monthly/2017/05/04/</span></span><br><span class="line"><span class="symbol">http:</span><span class="comment">//www.importnew.com/29055.html</span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//www.cnblogs.com/cchust/p/5025880.html</span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//my.oschina.net/alchemystar/blog/833598</span></span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    

    

    

    
<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

  
</div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/MySQL/" rel="tag"># MySQL</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/MySQL启动配置文件搜索顺序解析.html" rel="next" title="MySQL启动配置文件搜索顺序解析">
                <i class="fa fa-chevron-left"></i> MySQL启动配置文件搜索顺序解析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/jiessie.png"
                alt="Jiessie" />
            
              <p class="site-author-name" itemprop="name">Jiessie</p>
              <p class="site-description motion-element" itemprop="description">最怕一生碌碌无为,还说平凡难能可贵！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">9</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.percona.com/" target="_blank" title="Percona">
                      
                        <i class="fa fa-fw fa-globe"></i>Percona</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://mariadb.com/kb/zh-cn/mariadb/" target="_blank" title="MariaDB">
                      
                        <i class="fa fa-fw fa-globe"></i>MariaDB</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysqlserverteam.com/" target="_blank" title="serverteam">
                      
                        <i class="fa fa-fw fa-globe"></i>serverteam</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysqlhighavailability.com/" target="_blank" title="highavailability">
                      
                        <i class="fa fa-fw fa-globe"></i>highavailability</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysql.taobao.org/monthly/" target="_blank" title="淘宝月报">
                      
                        <i class="fa fa-fw fa-globe"></i>淘宝月报</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://dimitrik.free.fr/blog/" target="_blank" title="dimitrik">
                      
                        <i class="fa fa-fw fa-globe"></i>dimitrik</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#引言"><span class="nav-number">1.</span> <span class="nav-text">引言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL连接参数"><span class="nav-number">2.</span> <span class="nav-text">MySQL连接参数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL连接过程"><span class="nav-number">3.</span> <span class="nav-text">MySQL连接过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#mysql通信协议"><span class="nav-number">3.1.</span> <span class="nav-text">mysql通信协议</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#connect-timeout"><span class="nav-number">3.2.</span> <span class="nav-text">connect_timeout</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#net-read-timeout-amp-amp-net-write-timeout"><span class="nav-number">3.3.</span> <span class="nav-text">net_read_timeout &amp;&amp; net_write_timeout</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#interactive-timeout-amp-amp-wait-timeout"><span class="nav-number">3.4.</span> <span class="nav-text">interactive_timeout &amp;&amp; wait_timeout</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MySQL超时类型"><span class="nav-number">4.</span> <span class="nav-text">MySQL超时类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Got-timeout-reading-communication-packets"><span class="nav-number">4.1.</span> <span class="nav-text">Got timeout reading communication packets</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#连接超时"><span class="nav-number">4.1.1.</span> <span class="nav-text">连接超时</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#准备"><span class="nav-number">4.1.1.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#观察日志"><span class="nav-number">4.1.1.2.</span> <span class="nav-text">观察日志</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他"><span class="nav-number">4.1.2.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Got-an-error-reading-communication-packets"><span class="nav-number">4.2.</span> <span class="nav-text">Got an error reading communication packets</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端异常退出-数据包异常"><span class="nav-number">4.2.1.</span> <span class="nav-text">客户端异常退出(数据包异常)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#准备-1"><span class="nav-number">4.2.1.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#pt-kill测试"><span class="nav-number">4.2.1.2.</span> <span class="nav-text">pt-kill测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#网络错误"><span class="nav-number">4.2.2.</span> <span class="nav-text">网络错误</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#准备-2"><span class="nav-number">4.2.2.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sysbench测试"><span class="nav-number">4.2.2.2.</span> <span class="nav-text">sysbench测试</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#php测试"><span class="nav-number">4.2.2.3.</span> <span class="nav-text">php测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#max-prepared-stmt-count"><span class="nav-number">4.2.3.</span> <span class="nav-text">max_prepared_stmt_count</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#准备-3"><span class="nav-number">4.2.3.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sysbench测试-1"><span class="nav-number">4.2.3.2.</span> <span class="nav-text">sysbench测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他-1"><span class="nav-number">4.2.4.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Lost-connection-to-MySQL-server-during-query"><span class="nav-number">4.3.</span> <span class="nav-text">Lost connection to MySQL server during query</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#超时connect-timeout"><span class="nav-number">4.3.1.</span> <span class="nav-text">超时connect_timeout</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#准备-4"><span class="nav-number">4.3.1.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#登录连接测试"><span class="nav-number">4.3.1.2.</span> <span class="nav-text">登录连接测试</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#客户端异常退出-数据包正常"><span class="nav-number">4.3.2.</span> <span class="nav-text">客户端异常退出(数据包正常)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#准备-5"><span class="nav-number">4.3.2.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#手动kill"><span class="nav-number">4.3.2.2.</span> <span class="nav-text">手动kill</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他-2"><span class="nav-number">4.3.3.</span> <span class="nav-text">其他</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MySQL-server-has-gone-away"><span class="nav-number">4.4.</span> <span class="nav-text">MySQL server has gone away</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#MySQL-server-has-gone-away-1"><span class="nav-number">4.4.1.</span> <span class="nav-text">MySQL server has gone away</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#准备-6"><span class="nav-number">4.4.1.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#执行查询"><span class="nav-number">4.4.1.2.</span> <span class="nav-text">执行查询</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他-3"><span class="nav-number">4.4.2.</span> <span class="nav-text">其他</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiessie</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

</body>
</html>
