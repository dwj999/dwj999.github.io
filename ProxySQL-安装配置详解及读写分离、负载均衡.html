<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="proxysql," />





  <link rel="alternate" href="/atom.xml" title="Jiessie's' Blog" type="application/atom+xml" />






<meta name="description" content="前言在MySQL的高可用集群环境中，中间件是不可缺少的一部分，它提供了读写分离、负载均衡等各种功能，满足集群的横向、纵向的可扩展。由于官方并没有在这方面推出好的产品，更多的是第三方的产品。如：  ProxySQL  #Percona MaxScale  #MariaDB Atlas     #360开源 OneProxy  #平民软件楼方鑫 MyCat     #社区推广 KingShard #原">
<meta name="keywords" content="proxysql">
<meta property="og:type" content="article">
<meta property="og:title" content="ProxySQL 安装配置详解及读写分离、负载均衡">
<meta property="og:url" content="https://dwj999.github.io/ProxySQL-安装配置详解及读写分离、负载均衡.html">
<meta property="og:site_name" content="Jiessie&#39;s&#39; Blog">
<meta property="og:description" content="前言在MySQL的高可用集群环境中，中间件是不可缺少的一部分，它提供了读写分离、负载均衡等各种功能，满足集群的横向、纵向的可扩展。由于官方并没有在这方面推出好的产品，更多的是第三方的产品。如：  ProxySQL  #Percona MaxScale  #MariaDB Atlas     #360开源 OneProxy  #平民软件楼方鑫 MyCat     #社区推广 KingShard #原">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://note.youdao.com/yws/public/resource/eda87c5cc1090ba9cc4be116906c805b/xmlnote/784F7090F01E4C62AE28CA4BB08A82F8/37001">
<meta property="og:updated_time" content="2020-05-20T03:46:48.084Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="ProxySQL 安装配置详解及读写分离、负载均衡">
<meta name="twitter:description" content="前言在MySQL的高可用集群环境中，中间件是不可缺少的一部分，它提供了读写分离、负载均衡等各种功能，满足集群的横向、纵向的可扩展。由于官方并没有在这方面推出好的产品，更多的是第三方的产品。如：  ProxySQL  #Percona MaxScale  #MariaDB Atlas     #360开源 OneProxy  #平民软件楼方鑫 MyCat     #社区推广 KingShard #原">
<meta name="twitter:image" content="http://note.youdao.com/yws/public/resource/eda87c5cc1090ba9cc4be116906c805b/xmlnote/784F7090F01E4C62AE28CA4BB08A82F8/37001">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dwj999.github.io/ProxySQL-安装配置详解及读写分离、负载均衡.html"/>





<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

  <title>ProxySQL 安装配置详解及读写分离、负载均衡 | Jiessie's' Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"><a href="https://github.com/dwj999" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jiessie's' Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">没伞的孩子必须努力奔跑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/ProxySQL-安装配置详解及读写分离、负载均衡.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ProxySQL 安装配置详解及读写分离、负载均衡</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-29T15:58:45+08:00">
                2017-08-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/中间件/" itemprop="url" rel="index">
                    <span itemprop="name">中间件</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在MySQL的高可用集群环境中，中间件是不可缺少的一部分，它提供了读写分离、负载均衡等各种功能，满足集群的横向、纵向的可扩展。由于官方并没有在这方面推出好的产品，更多的是第三方的产品。如：</p>
<ul>
<li>ProxySQL  #Percona</li>
<li>MaxScale  #MariaDB</li>
<li>Atlas     #360开源</li>
<li>OneProxy  #平民软件楼方鑫</li>
<li>MyCat     #社区推广</li>
<li>KingShard #原Atlas作者离职后使用go开发</li>
<li>TDDL      #阿里巴巴开源</li>
<li>Cobar     #阿里巴巴开源</li>
<li>DBProxy   #美团在360Atlas上修改后开源</li>
<li>Fabric    #官方产品</li>
<li>DRDS      #阿里云分库分表产品</li>
</ul>
<p>本次以测试ProxySQL为例，逐步了解ProxySQL的使用方式。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>环境：<br>ProxySQL:   1.4.1<br>Master:     118.190.67.67<br>Slave:      139.196.95.103(192.168.7.50)</p>
<h2 id="安装配置详解"><a href="#安装配置详解" class="headerlink" title="安装配置详解"></a>安装配置详解</h2><p>官网：<a href="http://www.proxysql.com/" target="_blank" rel="noopener">http://www.proxysql.com/</a><br>Percona地址：<a href="https://www.percona.com/downloads/proxysql/" target="_blank" rel="noopener">https://www.percona.com/downloads/proxysql/</a><br>Github地址：<a href="https://github.com/sysown/proxysql/" target="_blank" rel="noopener">https://github.com/sysown/proxysql/</a><br>本文通过作者编译好的rpm安装，也可通过编译安装的方式安装，本文省略  </p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>下载proxysql可以有三种途径,分别为官网、Percona网站和Github网站<br>本文从github上下载最新稳定版本，这里选择centos67对应的rpm包<br>下载：wget -c -O proxysql-1.4.1-1-centos67.x86_64.rpm <a href="https://github.com/sysown/proxysql/releases/download/v1.4.1/proxysql-1.4.1-1-centos67.x86_64.rpm" target="_blank" rel="noopener">https://github.com/sysown/proxysql/releases/download/v1.4.1/proxysql-1.4.1-1-centos67.x86_64.rpm</a><br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ test]# yum localinstall -y proxysql-1.4.1-1-centos67.x86<span class="emphasis">_64.rpm</span></span><br><span class="line"><span class="emphasis">Loaded plugins: security</span></span><br><span class="line"><span class="emphasis">docker-main-repo                                                                                                                                 | 2.9 kB     00:00     </span></span><br><span class="line"><span class="emphasis">Setting up Install Process</span></span><br><span class="line"><span class="emphasis">Resolving Dependencies</span></span><br><span class="line"><span class="emphasis">There are unfinished transactions remaining. You might consider running yum-complete-transaction first to finish them.</span></span><br><span class="line"><span class="emphasis">--&gt; Running transaction check</span></span><br><span class="line"><span class="emphasis">---&gt; Package proxysql.x86_</span>64 0:1.4.1-1 will be installed</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">========================================================================================================================================================================</span><br><span class="line"><span class="code"> Package                           Arch                            Version                             Repository                                                  Size</span></span><br><span class="line">========================================================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"><span class="code"> proxysql                          x86_64                          1.4.1-1                             /proxysql-1.4.1-1-centos67.x86_64                           19 M</span></span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">========================================================================================================================================================================</span><br><span class="line">Install       1 Package(s)</span><br><span class="line"></span><br><span class="line">Total size: 19 M</span><br><span class="line">Installed size: 19 M</span><br><span class="line">Downloading Packages:</span><br><span class="line">Running rpm<span class="emphasis">_check_</span>debug</span><br><span class="line">Running Transaction Test</span><br><span class="line">Transaction Test Succeeded</span><br><span class="line">Running Transaction</span><br><span class="line"><span class="code">  Installing : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></span><br><span class="line"><span class="code">  Verifying  : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line"><span class="code">  proxysql.x86_64 0:1.4.1-1                                                                                                                                             </span></span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure></p>
<p>ProxySQL默认配置文件为/etc/proxysql.cnf,只在第一次启动的时候有用,后续的所有配置都是通过对SQLite数据库的操作,并且不会更新到proxysql中,而是存储在/var/lib/proxysql/proxysql.db中<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie test]<span class="meta">#  proxysql --version    #查看版本</span></span><br><span class="line">ProxySQL version <span class="number">1.4</span><span class="number">.1</span><span class="number">-45</span>-gab4e6ee, codename Truls</span><br><span class="line">[root@jiessie test]<span class="meta"># rpm -ql proxysql   #查看安装的具体内容</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>init.d/proxysql                    <span class="meta">#启动脚本</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>proxysql.cnf                       <span class="meta">#默认配置文件</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>bin/proxysql                       <span class="meta">#执行文件</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/proxysql/</span>tools/proxysql_galera_checker.sh    <span class="meta">#ProxySQL调度程序检查pxc_maint_mode参数状态,持续检测各个节点的状态</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/proxysql/</span>tools/proxysql_galera_writer.pl <span class="meta">#ProxySQL指定一个节点直接将流量写入galera</span></span><br><span class="line">[root@jiessie test]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>启动之后才会生成存储目录/var/lib/proxysql<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie test]<span class="comment"># /etc/init.d/proxysql start</span></span><br><span class="line">Starting ProxySQL: DONE!</span><br><span class="line">[root@jiessie test]<span class="comment"># ll /var/lib/proxysql/</span></span><br><span class="line">总用量 108</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root<span class="number"> 98304 </span>8月 <span class="number"> 29 </span>15:37 proxysql.db</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root <span class="number"> 4306 </span>8月 <span class="number"> 29 </span>16:25 proxysql.log</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root    <span class="number"> 5 </span>8月 <span class="number"> 29 </span>16:25 proxysql.pid</span><br><span class="line">[root@jiessie test]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<h2 id="内置对象介绍"><a href="#内置对象介绍" class="headerlink" title="内置对象介绍"></a>内置对象介绍</h2><h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><p>启动了6032和6033两个端口,默认管理端口是6032,客户端服务端口是6033,默认的用户名密码都是 admin,通过mysql的客户端可以登录<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie test]<span class="comment"># netstat -tunlp|grep proxysql</span></span><br><span class="line">tcp        0      0 0.0.0.0:6032                0.0.0.0:*                   LISTEN      5181/proxysql       </span><br><span class="line">tcp        0      0 0.0.0.0:6033                0.0.0.0:*                   LISTEN      5181/proxysql       </span><br><span class="line">[root@jiessie test]<span class="comment"># mysql -uadmin -padmin -h127.0.0.1 -P6032</span></span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQ<span class="class">L monitor.  Commands end with ;</span><span class="built_in"> or </span>\g.</span><br><span class="line">Your MySQL connection id is 1</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC<span class="built_in"> and/or </span>its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle<span class="built_in"> and/or </span>its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation<span class="built_in"> and/or </span>its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;'<span class="built_in"> or </span>'\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 16:28:32 &gt; show databases;</span><br><span class="line">+-----+---------+-------------------------------+</span><br><span class="line">| seq | name    | file                          |</span><br><span class="line">+-----+---------+-------------------------------+</span><br><span class="line">| 0   | main    |                               |</span><br><span class="line">| 2   | disk    | /var/lib/proxysql/proxysql.db |</span><br><span class="line">| 3   | stats   |                               |</span><br><span class="line">| 4   |<span class="built_in"> monitor </span>|                               |</span><br><span class="line">+-----+---------+-------------------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 16:28:41 &gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="内置库"><a href="#内置库" class="headerlink" title="内置库"></a>内置库</h3><p>main：默认数据库名,用于存放后端db实例、用户认证、路由规则等信息。表名以runtime_开头的表示proxysql当前运行的配置内容，不能通过dml语句修改。只能修改对应的不以runtime_开头的（在内存）里的表，然后LOAD使其生效，SAVE使其存到硬盘以供下次重启加载。<br>disk：是持久化到硬盘的配置，sqlite数据文件。<br>stats：是proxysql运行抓取的统计信息，包括到后端各命令的执行次数、流量、processlist、查询各类汇总、执行时间等。<br>monitor：库存储monitor模块收集的信息，主要是对后端db的健康、延迟检查。  </p>
<h4 id="main库"><a href="#main库" class="headerlink" title="main库"></a>main库</h4><h5 id="runtime-表"><a href="#runtime-表" class="headerlink" title="runtime_表"></a>runtime_表</h5><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 17:19:10 &gt; use main</span><br><span class="line">Database changed</span><br><span class="line">MySQL [main] 17:22:15 &gt; show tables;</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">|<span class="string"> tables                                     </span>|</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">|<span class="string"> global_variables                           </span>|</span><br><span class="line">|<span class="string"> mysql_collations                           </span>|</span><br><span class="line">|<span class="string"> mysql_group_replication_hostgroups         </span>|</span><br><span class="line">|<span class="string"> mysql_query_rules                          </span>|</span><br><span class="line">|<span class="string"> mysql_replication_hostgroups               </span>|</span><br><span class="line">|<span class="string"> mysql_servers                              </span>|</span><br><span class="line">|<span class="string"> mysql_users                                </span>|</span><br><span class="line">|<span class="string"> proxysql_servers                           </span>|</span><br><span class="line">|<span class="string"> runtime_global_variables                   </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_group_replication_hostgroups </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_query_rules                  </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_replication_hostgroups       </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_servers                      </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_users                        </span>|</span><br><span class="line">|<span class="string"> runtime_proxysql_servers                   </span>|</span><br><span class="line">|<span class="string"> runtime_scheduler                          </span>|</span><br><span class="line">|<span class="string"> scheduler                                  </span>|</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">17 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 17:22:16 &gt;</span><br></pre></td></tr></table></figure>
<p>其中，runtime_开关的表如下：  </p>
<ul>
<li>runtime_global_variables：global_variables的运行时版本  </li>
<li>runtime_mysql_group_replication_hostgroups：mysql_group_replication_hostgroups的运行时版本  </li>
<li>runtime_mysql_query_rules：mysql_query_rules的运行时版本  </li>
<li>runtime_mysql_replication_hostgroups：mysql_replication_hostsgroups的运行时版本  </li>
<li>runtime_mysql_servers：mysql_servers的运行时版本  </li>
<li>runtime_mysql_users：mysql_users的运行时版本  </li>
<li><p>runtime_scheduler：scheduler调度程序的运行时版本</p>
<h6 id="global-variables表"><a href="#global-variables表" class="headerlink" title="global_variables表"></a>global_variables表</h6><p>内置参数表，参考下文</p>
<h6 id="mysql-servers表"><a href="#mysql-servers表" class="headerlink" title="mysql_servers表"></a>mysql_servers表</h6><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] <span class="number">17</span>:<span class="number">22</span>:<span class="number">16</span> &gt; show create table mysql_servers\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: mysql_servers</span><br><span class="line">Create Table: CREATE TABLE mysql_servers (</span><br><span class="line">    hostgroup_id <span class="built_in">INT</span> <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    hostname VARCHAR <span class="literal">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    port <span class="built_in">INT</span> <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">3306</span>,</span><br><span class="line">    status VARCHAR CHECK (UPPER(status) <span class="keyword">IN</span> (<span class="string">'ONLINE'</span>,<span class="string">'SHUNNED'</span>,<span class="string">'OFFLINE_SOFT'</span>, <span class="string">'OFFLINE_HARD'</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'ONLINE'</span>,</span><br><span class="line">    weight <span class="built_in">INT</span> CHECK (weight &gt;= <span class="number">0</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    compression <span class="built_in">INT</span> CHECK (compression &gt;=<span class="number">0</span> <span class="literal">AND</span> compression &lt;= <span class="number">102400</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    max_connections <span class="built_in">INT</span> CHECK (max_connections &gt;=<span class="number">0</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1000</span>,</span><br><span class="line">    max_replication_lag <span class="built_in">INT</span> CHECK (max_replication_lag &gt;= <span class="number">0</span> <span class="literal">AND</span> max_replication_lag &lt;= <span class="number">126144000</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    use_ssl <span class="built_in">INT</span> CHECK (use_ssl <span class="keyword">IN</span>(<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    max_latency_ms <span class="built_in">INT</span> UNSIGNED CHECK (max_latency_ms&gt;=<span class="number">0</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    comment VARCHAR <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">    PRIMARY KEY (hostgroup_id, hostname, port) )</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] <span class="number">17</span>:<span class="number">34</span>:<span class="number">05</span> &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>hostgroup_id：ProxySQL通过hostgroup的形式组织后端db实例,一个hostgroup代表同属于一个角色。<br>表的主键是(hostgroup_id, hostname, port),以hostname:port在多个hostgroup中存在。<br>一个hostgroup可以有多个实例，即是多个从库，可能通过weight分配权重。<br>hostgroup_id 0是一个特殊的hostgroup，路由查询的时候，没有匹配到规则则默认选择hostgroup 0。  </p>
</li>
<li>status：<br>ONLINE：当前后端实例状态正常。<br>SHUNNED：临时被剔除，可能因为后端too many connection error，或者超过了max_replication_lag。<br>OFFLINE_SOFT：软离线状态，不再接受新的连接，但已建立的连接会等待活跃事务完成。<br>OFFLINE_HARD：硬离线状态，不再接受新的连接，已建立的连接或被强制中断，当后端实例宕机或网络不可达，会出现。  </li>
<li>max_connections：允许连接到该后端实例的最大连接数，不要大于MySQL的max_connections。<br>如果后端实例hostname:port在多个hostgroup里，以较大者为准，而不是各自独立允许的最大连接数。  </li>
<li>max_replication_lag：允许的最大延迟，主库不受影响，默认为0，如果&gt;0，monitor模块监控主从延迟大于阈值时，会临时把它的状态变更为SHUNNED。  </li>
<li>max_latency_ms：mysql_ping响应时间，大于这个阈值会把它从连接池剔除，即使是ONLINE。  </li>
<li>comment：备注，不建设为空。  </li>
<li><p>其他的字段，可通过字面意思理解。  </p>
<h5 id="mysql-users表"><a href="#mysql-users表" class="headerlink" title="mysql_users表"></a>mysql_users表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 09:13:02 &gt; show create table mysql_users\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_users</span><br><span class="line">Create Table: CREATE TABLE mysql_users (</span><br><span class="line">    username VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    password VARCHAR,</span><br><span class="line">    active INT CHECK (active <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</span><br><span class="line">    use_ssl INT CHECK (use_ssl <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    default_hostgroup INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    default_schema VARCHAR,</span><br><span class="line">    schema_locked INT CHECK (schema_locked <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    transaction_persistent INT CHECK (transaction_persistent <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</span><br><span class="line">    fast_forward INT CHECK (fast_forward <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    backend INT CHECK (backend <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</span><br><span class="line">    frontend INT CHECK (frontend <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</span><br><span class="line">    max_connections INT CHECK (max_connections &gt;=0) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>10000,</span><br><span class="line">    PRIMARY KEY (username, backend),</span><br><span class="line">    UNIQUE (username, frontend))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 09:13:08 &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>username,password：连接到后端MySQL或ProxySQL实例的凭证,参考<a href="https://github.com/sysown/proxysql/wiki/Passwords-management" target="_blank" rel="noopener">密码管理</a>。<br>密码可插入明文，也可通过PASSWORD()插入密文，proxysql以*开头判断插入是否是密文。<br>但是runtime_mysql_users里统一是密文，所以明文插入，再SAVE MYSQL USERS TO MEM，此时看到的也是HASH密文。  </p>
</li>
<li>active：是否生效该用户，active=0的用户将在数据库中被跟踪，但不会加载到内存中的数据结构中。  </li>
<li>default_hostgroup：这个用户的请求没有匹配到规则时，默认发到hostgroup，默认0。  </li>
<li>default_schema：这个用户连接时没有指定schema时，默认使用的schema。<br>默认为NULL，实际上受变量mysql-default_schema的影响，默认为information_schema。  </li>
<li>transaction_persistent： 如果设置为1，连接上ProxySQL的会话后，如果在一个hostgroup上开启了事务，那么后续的sql都继续维持在这个hostgroup上，不论是否会匹配上其它路由规则，直到事务结束。  </li>
<li>frontend：如果设置为1，则用户名、密码对ProxySQL进行身份验证。  </li>
<li><p>backend：如果设置为1，则用户名、密码根据任何主机组向mysqld服务器进行身份验证。<br>注意，目前所有用户都需要将“前端”和“后端“都设置为1，未来版本的ProxySQL将分离前端和后端之间的crendentials。以这种方式，前端将永远不会知道直接连接到后端的凭据，强制所有通过ProxySQL的连接并增加系统的安全性。  </p>
<h5 id="mysql-replication-hostgroups表"><a href="#mysql-replication-hostgroups表" class="headerlink" title="mysql_replication_hostgroups表"></a>mysql_replication_hostgroups表</h5><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 10:<span class="number">18</span>:<span class="number">15</span> &gt; <span class="keyword">show</span> <span class="keyword">create</span> table mysql_replication_hostgroups\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: mysql_replication_hostgroups</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE mysql_replication_hostgroups (</span><br><span class="line">    writer_hostgroup INT CHECK (writer_hostgroup&gt;=<span class="number">0</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,</span><br><span class="line">    reader_hostgroup INT <span class="keyword">NOT</span> <span class="literal">NULL</span> CHECK (reader_hostgroup&lt;&gt;writer_hostgroup <span class="keyword">AND</span> reader_hostgroup&gt;<span class="number">0</span>),</span><br><span class="line">    comment VARCHAR,</span><br><span class="line">    <span class="keyword">UNIQUE</span> (reader_hostgroup))</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] <span class="number">10</span>:<span class="number">18</span>:<span class="number">22</span> &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义hostgroup的主从关系。ProxySQL monitor模块会监控hostgroup后端所有servers的read_only变量，如果发现从库的read_only变为0、主库变为1，则认为角色互换了，自动改写mysql_servers表里面hostgroup关系，达到failover效果。  </p>
<h5 id="mysql-query-rules查询规则表"><a href="#mysql-query-rules查询规则表" class="headerlink" title="mysql_query_rules查询规则表"></a>mysql_query_rules查询规则表</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] <span class="number">10</span>:<span class="number">25</span>:<span class="number">22</span> &gt; show create table mysql_query_rules\G           </span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: mysql_query_rules</span><br><span class="line">Create Table: CREATE TABLE mysql_query_rules (</span><br><span class="line">    rule_id INTEGER PRIMARY KEY AUTOINCREMENT <span class="literal">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    active <span class="built_in">INT</span> CHECK (active <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    username VARCHAR,</span><br><span class="line">    schemaname VARCHAR,</span><br><span class="line">    flagIN <span class="built_in">INT</span> <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    client_addr VARCHAR,</span><br><span class="line">    proxy_addr VARCHAR,</span><br><span class="line">    proxy_port <span class="built_in">INT</span>,</span><br><span class="line">    digest VARCHAR,</span><br><span class="line">    match_digest VARCHAR,</span><br><span class="line">    match_pattern VARCHAR,</span><br><span class="line">    negate_match_pattern <span class="built_in">INT</span> CHECK (negate_match_pattern <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    re_modifiers VARCHAR <span class="keyword">DEFAULT</span> <span class="string">'CASELESS'</span>,</span><br><span class="line">    flagOUT <span class="built_in">INT</span>,</span><br><span class="line">    replace_pattern VARCHAR,</span><br><span class="line">    destination_hostgroup <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cache_ttl <span class="built_in">INT</span> CHECK(cache_ttl &gt; <span class="number">0</span>),</span><br><span class="line">    reconnect <span class="built_in">INT</span> CHECK (reconnect <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">    timeout <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    retries <span class="built_in">INT</span> CHECK (retries&gt;=<span class="number">0</span> <span class="literal">AND</span> retries &lt;=<span class="number">1000</span>),</span><br><span class="line">    delay <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    next_query_flagIN <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    mirror_flagOUT <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    mirror_hostgroup <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    error_msg VARCHAR,</span><br><span class="line">    OK_msg VARCHAR,</span><br><span class="line">    sticky_conn <span class="built_in">INT</span> CHECK (sticky_conn <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)),</span><br><span class="line">    multiplex <span class="built_in">INT</span> CHECK (multiplex <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>)),</span><br><span class="line">    <span class="built_in">log</span> <span class="built_in">INT</span> CHECK (<span class="built_in">log</span> <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)),</span><br><span class="line">    apply <span class="built_in">INT</span> CHECK(apply <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    comment VARCHAR)</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] <span class="number">10</span>:<span class="number">25</span>:<span class="number">34</span> &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>rule_id：表主键，自增，规则处理是以rule_id为顺序进行。  </p>
</li>
<li>active：只有active=1时的规则才会参与匹配。  </li>
<li>username：过滤匹配用户名的条件，如果是非空值，则仅当连接使用正确的用户名时，查询才匹配。  </li>
<li>schemaname：匹配schemaname的过滤条件，如果是非空值，则仅当连接schemaname用作默认模式时，查询才匹配。  </li>
<li>flagIN,flagOUT,apply：用来定义路由链chains of rules<br>首先会检查flagIN=0的规则，以rule_id的顺序；如果没有匹配上，则走这个用户的default_hostgroup。<br>当匹配一条规则后，会检查flagOUT。<br>如果不为NULL，并且flagIN!=flagOUT，则进入以flagIN为上一个flagOUT值的新规则链。<br>如果不为NULL，并且flagIN=flagOUT，则应用这条规则。<br>如果为NULL，或者apply=1，则结束，应用这条规则。<br>如果最终没有匹配到，则找到这个用户的default_hostgroup。  </li>
<li>client_addr：匹配客户端来源IP。  </li>
<li>proxy_addr,proxy_port：匹配本地proxysql的ip、端口。  </li>
<li>digest：精确匹配的查询。  </li>
<li>match_digest：正则匹配查询。query,digest是指对查询去掉具体值后进行”模糊化“后的查询，类似pt-query-digest的效果。  </li>
<li>match_pattern：正则匹配查询。<br>以上都是匹配查询的规则，1.4版本可以通过变量mysql-query_processor_regex设置，支持RE2和PCRE，1.4版本开始默认为PCRE。  </li>
<li>negate_match_pattern：反向匹配，相当于对match_digest/match_pattern的匹配取反。  </li>
<li>re_modifiers：修改正则匹配的参数，比如默认的：忽略大小写CASELESS、禁用GLOBAL。  </li>
<li>下面是匹配后的行为：  </li>
<li>replace_pattern：查询重写，默认为空。  </li>
<li>destination_hostgroup：路由查询到这个hostgroup，当然如果用户显式start transaction且transaction_persistent=1,那么即使匹配到了，也依然按照事务里第一条sql的路由规则去走的。  </li>
<li>cache_ttl：查询结果缓存的毫秒数。  </li>
<li>timeout：这一类查询执行的的最大时间(毫秒),超时则自动kill。<br>这是对后端DB的保护机制，相当于阿里云RDS的loose_max_statement_time变量的功能，但不同的是，阿里云这个变量的时间时不包括DML操作出现InnoDB行锁等待的时间，而ProxySQL的这个timeout是计算从发送sql到等待响应的时间。默认mysql-default_query_timeout是10h。  </li>
<li>retries：语句在执行失败时，重试次数。默认由mysql-query_retries_on_failure变量指定，为1。建议不要重试，有风险。  </li>
<li>delay：查询延迟执行，这是ProxySQL提供的限流机制，会让其它的查询优先执行。<br>默认值mysql-default_query_delay为0。  </li>
<li>mirror_flagOUT,mirror_hostgroup：与镜像相关的设置。  </li>
<li>error_msg：默认为NULL，如果指定了则这个查询直接被block掉，将error_msg返回给客户端。  </li>
<li>multiplex：连接是否利用，请参考<a href="http://seanlook.com/2017/04/17/mysql-proxysql-multiplexing/" target="_blank" rel="noopener">文章</a>。  </li>
<li><p>log：是否记录查询日志，可以看到log是否记录的对象是根据规则。<br>要开启日志记录，需要设置变量mysql-eventslog_filename来指定文件名，然后这个log标记为1。但是目前proxysql记录的日志是二进制格式，需要特定的工具才能读取：eventslog_reader_sample。这个工具在源码目录 tools下面。  </p>
<h5 id="scheduler调度表"><a href="#scheduler调度表" class="headerlink" title="scheduler调度表"></a>scheduler调度表</h5><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 10:<span class="number">27</span>:<span class="number">52</span> &gt; <span class="keyword">show</span> <span class="keyword">create</span> table scheduler\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: scheduler</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE scheduler (</span><br><span class="line">    id INTEGER <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> AUTOINCREMENT <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    active INT CHECK (active <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="number">1</span>,</span><br><span class="line">    interval_ms INTEGER CHECK (interval_ms&gt;=<span class="number">100</span> <span class="keyword">AND</span> interval_ms&lt;=<span class="number">100000000</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    filename VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    arg1 VARCHAR,</span><br><span class="line">    arg2 VARCHAR,</span><br><span class="line">    arg3 VARCHAR,</span><br><span class="line">    arg4 VARCHAR,</span><br><span class="line">    arg5 VARCHAR,</span><br><span class="line">    comment VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>)</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] <span class="number">11</span>:<span class="number">09</span>:<span class="number">59</span> &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>id：调度程序作业的唯一标识符。  </p>
</li>
<li>active：如果设置为1，则作业处于活动状态。</li>
<li>interval_ms：工作的开始频率(以毫秒为单位)，最小interval_ms为100毫秒。  </li>
<li>filename：可执行文件的完整路径。  </li>
<li>arg1-arg5：传递作业的参数。最多5个。  </li>
<li>comment：注释。  </li>
<li>参考<a href="https://github.com/sysown/proxysql/wiki/Scheduler" target="_blank" rel="noopener">文档</a><h4 id="disk库"><a href="#disk库" class="headerlink" title="disk库"></a>disk库</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 15:12:14 &gt; show tables from disk;</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">| tables                             |</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">| global<span class="emphasis">_variables                   |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>collations                   |</span><br><span class="line">| mysql<span class="emphasis">_group_</span>replication<span class="emphasis">_hostgroups |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>query<span class="emphasis">_rules                  |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>replication<span class="emphasis">_hostgroups       |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>servers                      |</span><br><span class="line">| mysql<span class="emphasis">_users                        |</span></span><br><span class="line"><span class="emphasis">| proxysql_</span>servers                   |</span><br><span class="line">| scheduler                          |</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">9 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 15:12:26 &gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>具体的表介绍和main库一致。  </p>
<h4 id="stats库"><a href="#stats库" class="headerlink" title="stats库"></a>stats库</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 15:12:26 &gt; show tables from stats;</span><br><span class="line">+-----------------------------------+</span><br><span class="line">|<span class="string"> tables                            </span>|</span><br><span class="line">+-----------------------------------+</span><br><span class="line">|<span class="string"> global_variables                  </span>|</span><br><span class="line">|<span class="string"> stats_memory_metrics              </span>|</span><br><span class="line">|<span class="string"> stats_mysql_commands_counters     </span>|</span><br><span class="line">|<span class="string"> stats_mysql_connection_pool       </span>|</span><br><span class="line">|<span class="string"> stats_mysql_connection_pool_reset </span>|</span><br><span class="line">|<span class="string"> stats_mysql_global                </span>|</span><br><span class="line">|<span class="string"> stats_mysql_processlist           </span>|</span><br><span class="line">|<span class="string"> stats_mysql_query_digest          </span>|</span><br><span class="line">|<span class="string"> stats_mysql_query_digest_reset    </span>|</span><br><span class="line">|<span class="string"> stats_mysql_query_rules           </span>|</span><br><span class="line">|<span class="string"> stats_mysql_users                 </span>|</span><br><span class="line">|<span class="string"> stats_proxysql_servers_metrics    </span>|</span><br><span class="line">|<span class="string"> stats_proxysql_servers_status     </span>|</span><br><span class="line">+-----------------------------------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 15:13:53 &gt;</span><br></pre></td></tr></table></figure>
<h5 id="stats-mysql-commands-counters表"><a href="#stats-mysql-commands-counters表" class="headerlink" title="stats_mysql_commands_counters表"></a>stats_mysql_commands_counters表</h5><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] <span class="number">15</span>:<span class="number">15</span>:<span class="number">36</span> &gt; show create table stats.stats_mysql_commands_counters\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: stats_mysql_commands_counters</span><br><span class="line">Create Table: CREATE TABLE stats_mysql_commands_counters (</span><br><span class="line">    Command VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY KEY,</span><br><span class="line">    Total_Time_us <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    Total_cnt <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_100us <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_500us <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_1ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_5ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_10ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_50ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_100ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_500ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_1s <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_5s <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_10s <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_INFs)</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] <span class="number">15</span>:<span class="number">15</span>:<span class="number">58</span> &gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>command：已执行的SQL命令的类型，如FLUSH、INSERT、KILL、SELECT FOR UPDATE等。  </li>
<li>Total_Time_us：执行该类型命令的总时间(以毫秒为单位)。  </li>
<li>Total_cnt：执行该类型的命令的总数。  </li>
<li><p>cnt_100us-cnt_INFs：在指定的时间限制内执行的给定类型的命令总数和前一个命令的总数。<br>#####　stats_mysql_connection_pool表</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] <span class="symbol">15:15</span><span class="symbol">:58</span> &gt; show create table stats.stats_mysql_connection_pool \G </span><br><span class="line">*************************** <span class="number">1</span>. <span class="built_in">row</span> ***************************</span><br><span class="line">       tab<span class="symbol">le:</span> stats_mysql_connection_pool</span><br><span class="line">Create Tab<span class="symbol">le:</span> CREATE TABLE stats_mysql_connection_pool (</span><br><span class="line">    hostgroup <span class="built_in">INT</span>,</span><br><span class="line">    srv_host VARCHAR,</span><br><span class="line">    srv_port <span class="built_in">INT</span>,</span><br><span class="line">    status VARCHAR,</span><br><span class="line">    ConnUsed <span class="built_in">INT</span>,</span><br><span class="line">    ConnFree <span class="built_in">INT</span>,</span><br><span class="line">    ConnOK <span class="built_in">INT</span>,</span><br><span class="line">    ConnERR <span class="built_in">INT</span>,</span><br><span class="line">    Queries <span class="built_in">INT</span>,</span><br><span class="line">    Bytes_data_sent <span class="built_in">INT</span>,</span><br><span class="line">    Bytes_data_recv <span class="built_in">INT</span>,</span><br><span class="line">    Latency_us <span class="built_in">INT</span>)</span><br><span class="line"><span class="number">1</span> <span class="built_in">row</span> in set (<span class="number">0.00</span> <span class="built_in">sec</span>)</span><br><span class="line"></span><br><span class="line">MySQL [stats] <span class="symbol">15:20</span><span class="symbol">:08</span> &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>hostgroup：后端服务器所属的主机组，单个后端服务器可以属于多个主机组。  </p>
</li>
<li>srv_host,srv_port：mysqld后端服务器正在侦听连接的TCP端点的IP和Port。  </li>
<li>status：后端服务器的状态。可以有ONLINE，SHUNNED，OFFLINE_SOFT，OFFLINE_HARD。  </li>
<li>ConnUsed：ProxySQL当前使用多少个连接来向后端服务器发送查询。  </li>
<li>ConnFree：目前有多少个连接是空闲。  </li>
<li>ConnOK：成功建立了多少个连接。</li>
<li>ConnERR：没有成功建立多少个连接。</li>
<li>Queries：路由到此特定后端服务器的查询数。</li>
<li>Bytes_data_sent：发送到后端的数据量。</li>
<li>Bytes_data_recv：从后端接收的数据量。</li>
<li><p>Latency_ms：从Monitor报告的当前ping以毫秒为单位的延迟时间。</p>
<h5 id="stats-mysql-global表"><a href="#stats-mysql-global表" class="headerlink" title="stats_mysql_global表"></a>stats_mysql_global表</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:20:08 &gt; show create table stats.stats<span class="emphasis">_mysql_</span>global\G          </span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line"><span class="code">       table: stats_mysql_global</span></span><br><span class="line">Create Table: CREATE TABLE stats<span class="emphasis">_mysql_</span>global (</span><br><span class="line"><span class="code">    Variable_Name VARCHAR NOT NULL PRIMARY KEY,</span></span><br><span class="line"><span class="code">    Variable_Value VARCHAR NOT NULL)</span></span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:22:35 &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Variable_Name：代表与MySQL相关的代理级别的全局统计<br>如Client_Connections_aborted：由于无效凭据或max_connections而导致的前端连接数已达到；<br>如Client_Connections_connected：当前连接的前端连接数。<br>如Client_Connections_created：到目前为止创建的前端连接数。等等。</p>
</li>
<li><p>Variable_Value：统计所对应的值。  </p>
<h5 id="stats-mysql-processlist表"><a href="#stats-mysql-processlist表" class="headerlink" title="stats_mysql_processlist表"></a>stats_mysql_processlist表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:24:11 &gt; show create table stats.stats_mysql_processlist\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: stats_mysql_processlist</span><br><span class="line">Create Table: CREATE TABLE stats_mysql_processlist (</span><br><span class="line">    ThreadID INT <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    SessionID INTEGER PRIMARY KEY,</span><br><span class="line">   <span class="built_in"> user </span>VARCHAR,</span><br><span class="line">    db VARCHAR,</span><br><span class="line">    cli_host VARCHAR,</span><br><span class="line">    cli_port INT,</span><br><span class="line">    hostgroup INT,</span><br><span class="line">    l_srv_host VARCHAR,</span><br><span class="line">    l_srv_port INT,</span><br><span class="line">    srv_host VARCHAR,</span><br><span class="line">    srv_port INT,</span><br><span class="line">    command VARCHAR,</span><br><span class="line">    time_ms INT <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="builtin-name">info</span> VARCHAR)</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:26:43 &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ThreadID：ProxySQL线程的内部ID。  </p>
</li>
<li>SessionID：ProxySQL会话ID，通过这个ID可以进行kill操作。</li>
<li>user：与MySQL客户端连接到ProxySQL的用户。</li>
<li>db：当前选择的数据库。</li>
<li>cli_host,cli_port：连接ProxySQL的IP和TCP端口。</li>
<li>hostgroup：当前主机组。如果正在处理查询，则是查询已被路由或将要路由的主机组，或默认主机组。可以通过这个查看该SQL到底是到哪个HG里。</li>
<li>l_srv_host,l_srv_port：ProxySQL的IP和TCP端口。</li>
<li>srv_host,srv_port：后端MySQL服务器的IP和端口。</li>
<li>command：正在执行的MySQL查询的类型。</li>
<li>time_ms：命令执行的时间(以毫秒为单位)。</li>
<li><p>info：正在执行的SQL。</p>
<h5 id="stats-mysql-query-digest表"><a href="#stats-mysql-query-digest表" class="headerlink" title="stats_mysql_query_digest表"></a>stats_mysql_query_digest表</h5><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:26:43 &gt; show <span class="keyword">create</span> table stats.stats_mysql_query_digest\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: stats_mysql_query_digest</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE stats_mysql_query_digest (</span><br><span class="line">    hostgroup INT,</span><br><span class="line">    schemaname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    username VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    digest VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    digest_text VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    count_star INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    first_seen INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    last_seen INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    sum_time INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    min_time INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    max_time INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>(hostgroup, schemaname, username, digest))</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] <span class="number">15</span>:<span class="number">29</span>:<span class="number">27</span> &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>hostgroup：发送查询的主机组。值-1表示查询查询缓存。</p>
</li>
<li>schemaname：查询的数据库。</li>
<li>user：连接ProxySQL的用户名。</li>
<li>digest：一个十六进制散列，表示其参数剥离的SQL。</li>
<li>digest_text：参数剥离的实际SQL文本</li>
<li>count_star：执行查询的总次数（参数的值不同）。</li>
<li>first_seen：unix时间戳，是通过代理路由查询的第一时刻。</li>
<li>last_seen：unix时间戳，当查询通过代理路由时的最后一刻（到目前为止）。</li>
<li>sum_time：执行此类查询的总时间（以微秒为单位）。<br>这对于确定应用程序工作负载中花费的最多时间在哪里是非常有用的，并为改进的地方提供了一个良好的起点。</li>
<li><p>min_time,max_time - 执行此类查询时期望的持续时间范围。<br>min_time是到目前为止所看到的最小执行时间，而max_time表示最大执行时间，以微秒为单位。</p>
<h5 id="stats-mysql-query-rules表"><a href="#stats-mysql-query-rules表" class="headerlink" title="stats_mysql_query_rules表"></a>stats_mysql_query_rules表</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:29:27 &gt; show create table stats.stats<span class="emphasis">_mysql_</span>query_rules\G </span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line"><span class="code">       table: stats_mysql_query_rules</span></span><br><span class="line">Create Table: CREATE TABLE stats<span class="emphasis">_mysql_</span>query_rules (</span><br><span class="line"><span class="code">    rule_id INTEGER PRIMARY KEY,</span></span><br><span class="line"><span class="code">    hits INT NOT NULL)</span></span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:31:57 &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>rule_id：路由规则的ID与main.mysql_query_rules的id对应。</p>
</li>
<li>hits：此路由规则的匹配总数。 如果当前传入的查询符合规则，则会记录一次命中。<h4 id="monitor库"><a href="#monitor库" class="headerlink" title="monitor库"></a>monitor库</h4>对后端MySQL的健康检查，由变量mysql-monitor_enabled来确定是否开启Monitor模块。  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:35:32 &gt; show tables from monitor;                               </span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">| tables                             |</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">| mysql<span class="emphasis">_server_</span>connect               |</span><br><span class="line">| mysql<span class="emphasis">_server_</span>connect<span class="emphasis">_log           |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>server<span class="emphasis">_group_</span>replication<span class="emphasis">_log |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>server<span class="emphasis">_ping                  |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>server<span class="emphasis">_ping_</span>log              |</span><br><span class="line">| mysql<span class="emphasis">_server_</span>read<span class="emphasis">_only_</span>log         |</span><br><span class="line">| mysql<span class="emphasis">_server_</span>replication<span class="emphasis">_lag_</span>log   |</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:35:52 &gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="mysql-server-connect-mysql-server-connect-log表"><a href="#mysql-server-connect-mysql-server-connect-log表" class="headerlink" title="mysql_server_connect/mysql_server_connect_log表"></a>mysql_server_connect/mysql_server_connect_log表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:37:39 &gt; show create table monitor.mysql_server_connect\G  </span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_connect</span><br><span class="line">Create Table: CREATE TABLE mysql_server_connect (</span><br><span class="line">    hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_since INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    time_until INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_time_min INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_time_max INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_time_total INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_failure_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_failure_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_failure_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    PRIMARY KEY (hostname, port))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:37:46 &gt; show create table monitor.mysql_server_connect_log\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_connect_log</span><br><span class="line">Create Table: CREATE TABLE mysql_server_connect_log (</span><br><span class="line">    hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_start_us INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_time_us INT<span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_error VARCHAR,</span><br><span class="line">    PRIMARY KEY (hostname, port, time_start_us))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:37:51 &gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>连接到所有MySQL服务器以检查它们是否可用，该表用来存放检测连接的日志。由变量mysql-monitor_connect_interval来控制其检测的时间间隔，由参数mysql-monitor_connect_timeout控制连接是否超时（默认200毫秒）。</p>
<h5 id="mysql-server-ping-mysql-server-ping-log表"><a href="#mysql-server-ping-mysql-server-ping-log表" class="headerlink" title="mysql_server_ping/mysql_server_ping_log表"></a>mysql_server_ping/mysql_server_ping_log表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:39:23 &gt; show create table monitor.mysql_server_ping\G       </span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_ping</span><br><span class="line">Create Table: CREATE TABLE mysql_server_ping (</span><br><span class="line">    hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_since INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    time_until INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0, ping_success_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_time_min INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_time_max INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_time_total INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_failure_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_failure_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_failure_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    PRIMARY KEY (hostname, port))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:40:12 &gt; show create table monitor.mysql_server_ping_log\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_ping_log</span><br><span class="line">Create Table: CREATE TABLE mysql_server_ping_log (</span><br><span class="line">     hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_start_us INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_time_us INT<span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_error VARCHAR,</span><br><span class="line">    PRIMARY KEY (hostname, port, time_start_us))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:40:15 &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用mysql_ping API ping后端MySQL服务器检查它们是否可用，该表用来存放ping的日志。由变量mysql-monitor_ping_interval控制ping的时间间隔，默认值：10000（毫秒，相当于10秒）。</p>
<h5 id="mysql-server-replication-lag-log表"><a href="#mysql-server-replication-lag-log表" class="headerlink" title="mysql_server_replication_lag_log表"></a>mysql_server_replication_lag_log表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:40:53 &gt; show create table monitor.mysql_server_replication_lag_log\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_replication_lag_log</span><br><span class="line">Create Table: CREATE TABLE mysql_server_replication_lag_log (</span><br><span class="line">     hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_start_us INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    success_time_us INT<span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    repl_lag INT<span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    <span class="builtin-name">error</span> VARCHAR,</span><br><span class="line">    PRIMARY KEY (hostname, port, time_start_us))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:41:12 &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>后端MySQL服务主从延迟的检测。由参数mysql-monitor_replication_lag_interval控制检测间隔时间， 如果复制滞后太大，可以暂时关闭从。由mysql_servers.max_replication_lag列控制。默认值：10000（毫秒，相当于10秒）。</p>
</li>
</ul>
<h4 id="内置参数"><a href="#内置参数" class="headerlink" title="内置参数"></a>内置参数</h4><p>global_variables 1.4版本中有95个参数，参数较多，解释请参考<a href="https://github.com/sysown/proxysql/wiki/Global-variables" target="_blank" rel="noopener">文档</a>。<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 11:16:22 &gt; show variables;</span><br><span class="line">+-----------------------------------------------------+--------------------+</span><br><span class="line">|<span class="string"> Variable_name                                       </span>|<span class="string"> Value              </span>|</span><br><span class="line">+-----------------------------------------------------+--------------------+</span><br><span class="line">|<span class="string"> admin-admin_credentials                             </span>|<span class="string"> admin:admin        </span>|</span><br><span class="line">|<span class="string"> admin-cluster_check_interval_ms                     </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> admin-cluster_password                              </span>|<span class="string">                    </span>|</span><br><span class="line">|<span class="string"> admin-cluster_username                              </span>|<span class="string">                    </span>|</span><br><span class="line">|<span class="string"> admin-hash_passwords                                </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> admin-mysql_ifaces                                  </span>|<span class="string"> 0.0.0.0:6032       </span>|</span><br><span class="line">|<span class="string"> admin-read_only                                     </span>|<span class="string"> false              </span>|</span><br><span class="line">|<span class="string"> admin-refresh_interval                              </span>|<span class="string"> 2000               </span>|</span><br><span class="line">|<span class="string"> admin-stats_credentials                             </span>|<span class="string"> stats:stats        </span>|</span><br><span class="line">|<span class="string"> admin-telnet_admin_ifaces                           </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> admin-telnet_stats_ifaces                           </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> admin-version                                       </span>|<span class="string"> 1.4.1-45-gab4e6ee  </span>|</span><br><span class="line">|<span class="string"> mysql-client_found_rows                             </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-commands_stats                                </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-connect_retries_delay                         </span>|<span class="string"> 1                  </span>|</span><br><span class="line">|<span class="string"> mysql-connect_retries_on_failure                    </span>|<span class="string"> 10                 </span>|</span><br><span class="line">|<span class="string"> mysql-connect_timeout_server                        </span>|<span class="string"> 3000               </span>|</span><br><span class="line">|<span class="string"> mysql-connect_timeout_server_max                    </span>|<span class="string"> 10000              </span>|</span><br><span class="line">|<span class="string"> mysql-connection_delay_multiplex_ms                 </span>|<span class="string"> 0                  </span>|</span><br><span class="line">|<span class="string"> mysql-connection_max_age_ms                         </span>|<span class="string"> 0                  </span>|</span><br><span class="line">|<span class="string"> mysql-default_charset                               </span>|<span class="string"> utf8               </span>|</span><br><span class="line">|<span class="string"> mysql-default_max_latency_ms                        </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-default_query_delay                           </span>|<span class="string"> 0                  </span>|</span><br><span class="line">|<span class="string"> mysql-default_query_timeout                         </span>|<span class="string"> 36000000           </span>|</span><br><span class="line">|<span class="string"> mysql-default_reconnect                             </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-default_schema                                </span>|<span class="string"> information_schema </span>|</span><br><span class="line">|<span class="string"> mysql-default_sql_mode                              </span>|<span class="string">                    </span>|</span><br><span class="line">|<span class="string"> mysql-default_time_zone                             </span>|<span class="string"> SYSTEM             </span>|</span><br><span class="line">|<span class="string"> mysql-enforce_autocommit_on_reads                   </span>|<span class="string"> false              </span>|</span><br><span class="line">|<span class="string"> mysql-eventslog_filename                            </span>|<span class="string">                    </span>|</span><br><span class="line">|<span class="string"> mysql-eventslog_filesize                            </span>|<span class="string"> 104857600          </span>|</span><br><span class="line">|<span class="string"> mysql-forward_autocommit                            </span>|<span class="string"> false              </span>|</span><br><span class="line">|<span class="string"> mysql-free_connections_pct                          </span>|<span class="string"> 10                 </span>|</span><br><span class="line">|<span class="string"> mysql-have_compress                                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-hostgroup_manager_verbose                     </span>|<span class="string"> 1                  </span>|</span><br><span class="line">|<span class="string"> mysql-init_connect                                  </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-interfaces                                    </span>|<span class="string"> 0.0.0.0:6033       </span>|</span><br><span class="line">|<span class="string"> mysql-long_query_time                               </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-max_allowed_packet                            </span>|<span class="string"> 4194304            </span>|</span><br><span class="line">|<span class="string"> mysql-max_connections                               </span>|<span class="string"> 2048               </span>|</span><br><span class="line">|<span class="string"> mysql-max_stmts_cache                               </span>|<span class="string"> 10000              </span>|</span><br><span class="line">|<span class="string"> mysql-max_stmts_per_connection                      </span>|<span class="string"> 20                 </span>|</span><br><span class="line">|<span class="string"> mysql-max_transaction_time                          </span>|<span class="string"> 14400000           </span>|</span><br><span class="line">|<span class="string"> mysql-mirror_max_concurrency                        </span>|<span class="string"> 16                 </span>|</span><br><span class="line">|<span class="string"> mysql-mirror_max_queue_length                       </span>|<span class="string"> 32000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_connect_interval                      </span>|<span class="string"> 60000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_connect_timeout                       </span>|<span class="string"> 600                </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_enabled                               </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_groupreplication_healthcheck_interval </span>|<span class="string"> 5000               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_groupreplication_healthcheck_timeout  </span>|<span class="string"> 800                </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_history                               </span>|<span class="string"> 600000             </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_password                              </span>|<span class="string"> monitor            </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_ping_interval                         </span>|<span class="string"> 10000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_ping_max_failures                     </span>|<span class="string"> 3                  </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_ping_timeout                          </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_query_interval                        </span>|<span class="string"> 60000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_query_timeout                         </span>|<span class="string"> 100                </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_read_only_interval                    </span>|<span class="string"> 1500               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_read_only_timeout                     </span>|<span class="string"> 500                </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_replication_lag_interval              </span>|<span class="string"> 10000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_replication_lag_timeout               </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_slave_lag_when_null                   </span>|<span class="string"> 60                 </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_username                              </span>|<span class="string"> monitor            </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_wait_timeout                          </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_writer_is_also_reader                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-multiplexing                                  </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-ping_interval_server_msec                     </span>|<span class="string"> 120000             </span>|</span><br><span class="line">|<span class="string"> mysql-ping_timeout_server                           </span>|<span class="string"> 500                </span>|</span><br><span class="line">|<span class="string"> mysql-poll_timeout                                  </span>|<span class="string"> 2000               </span>|</span><br><span class="line">|<span class="string"> mysql-poll_timeout_on_failure                       </span>|<span class="string"> 100                </span>|</span><br><span class="line">|<span class="string"> mysql-query_cache_size_MB                           </span>|<span class="string"> 256                </span>|</span><br><span class="line">|<span class="string"> mysql-query_digests                                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-query_digests_lowercase                       </span>|<span class="string"> false              </span>|</span><br><span class="line">|<span class="string"> mysql-query_digests_max_digest_length               </span>|<span class="string"> 2048               </span>|</span><br><span class="line">|<span class="string"> mysql-query_digests_max_query_length                </span>|<span class="string"> 65000              </span>|</span><br><span class="line">|<span class="string"> mysql-query_processor_iterations                    </span>|<span class="string"> 0                  </span>|</span><br><span class="line">|<span class="string"> mysql-query_processor_regex                         </span>|<span class="string"> 1                  </span>|</span><br><span class="line">|<span class="string"> mysql-query_retries_on_failure                      </span>|<span class="string"> 1                  </span>|</span><br><span class="line">|<span class="string"> mysql-server_capabilities                           </span>|<span class="string"> 45578              </span>|</span><br><span class="line">|<span class="string"> mysql-server_version                                </span>|<span class="string"> 5.5.30             </span>|</span><br><span class="line">|<span class="string"> mysql-servers_stats                                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-session_idle_ms                               </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-session_idle_show_processlist                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-sessions_sort                                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-shun_on_failures                              </span>|<span class="string"> 5                  </span>|</span><br><span class="line">|<span class="string"> mysql-shun_recovery_time_sec                        </span>|<span class="string"> 10                 </span>|</span><br><span class="line">|<span class="string"> mysql-ssl_p2s_ca                                    </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-ssl_p2s_cert                                  </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-ssl_p2s_cipher                                </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-ssl_p2s_key                                   </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-stacksize                                     </span>|<span class="string"> 1048576            </span>|</span><br><span class="line">|<span class="string"> mysql-threads                                       </span>|<span class="string"> 4                  </span>|</span><br><span class="line">|<span class="string"> mysql-threshold_query_length                        </span>|<span class="string"> 524288             </span>|</span><br><span class="line">|<span class="string"> mysql-threshold_resultset_size                      </span>|<span class="string"> 4194304            </span>|</span><br><span class="line">|<span class="string"> mysql-wait_timeout                                  </span>|<span class="string"> 28800000           </span>|</span><br><span class="line">+-----------------------------------------------------+--------------------+</span><br><span class="line">95 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 11:16:33 &gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="ProxySQL多层配置设计"><a href="#ProxySQL多层配置设计" class="headerlink" title="ProxySQL多层配置设计"></a>ProxySQL多层配置设计</h3><h4 id="ProxySQL设计模型介绍"><a href="#ProxySQL设计模型介绍" class="headerlink" title="ProxySQL设计模型介绍"></a>ProxySQL设计模型介绍</h4><p>ProxySQL使用多层配置系统，适合满足以下需求：  </p>
<ul>
<li>允许自动更新配置，与MySQL兼容管理界面；  </li>
<li>允许在线修改配置，不用重启ProxySQL；  </li>
<li><p>允许回滚配置；<br>多层配置系统的实现，如下图：  </p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------+</span><br><span class="line">|<span class="string">         RUNTIME         </span>|</span><br><span class="line">+-------------------------+</span><br><span class="line">       /|<span class="string">\          </span>|</span><br><span class="line">        |<span class="string">           </span>|</span><br><span class="line">    [1] |<span class="string">       [2] </span>|</span><br><span class="line">        |<span class="string">          \</span>|<span class="string">/</span></span><br><span class="line"><span class="string">+-------------------------+</span></span><br><span class="line">|<span class="string">         MEMORY          </span>|</span><br><span class="line">+-------------------------+ _</span><br><span class="line">       /|<span class="string">\          </span>|<span class="string">      </span>|<span class="string">\</span></span><br><span class="line"><span class="string">        </span>|<span class="string">           </span>|<span class="string">        \</span></span><br><span class="line"><span class="string">    [3] </span>|<span class="string">       [4] </span>|<span class="string">         \ [5]</span></span><br><span class="line"><span class="string">        </span>|<span class="string">          \</span>|<span class="string">/         \</span></span><br><span class="line"><span class="string">+-------------------------+  +-------------------------+</span></span><br><span class="line">|<span class="string">          DISK           </span>|<span class="string">  </span>|<span class="string">       CONFIG FILE       </span>|</span><br><span class="line">+-------------------------+  +-------------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>RUNTIME代表ProxySQL当前生效的配置，包括global_variables、mysql_servers、mysql_users、mysql_query_rules。无法直接修改这里的配置，必须要从下一层load过来。  </p>
</li>
<li><p>MEMORY(main)代表平时在mysql命令行修改的main里的配置，可以认为是SQLite数据库在内存的镜像。可修改以下：    </p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mysql_server</span>        后端服务器列表</span><br><span class="line">mysql_users         连接到ProxySQL的用户列表及其凭据 </span><br><span class="line">mysql_query_rules   将流量路由到不同的后端服务器的规则列表</span><br><span class="line">global_variables    全局变量列表</span><br><span class="line">mysql_collat        MySQL排序规则列表</span><br></pre></td></tr></table></figure>
</li>
<li><p>DISK和CONFIG FILE表示磁盘上SQLite数据库，默认位置在$datadir/proxysql.db，在重新启动过程中，内存中未被保存的配置将丢失。/etc/proxysql.cnf文件只在第一次初始化的时候用到。如要修改端口，还是需要在管理命令行里修改，再save到磁盘。  </p>
<h5 id="ProxySQL多层配置修改示例"><a href="#ProxySQL多层配置修改示例" class="headerlink" title="ProxySQL多层配置修改示例"></a>ProxySQL多层配置修改示例</h5></li>
<li><p>mysql users</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> RUNTIME / LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> MEMORY</span><br><span class="line">SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> MEMORY / SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> RUNTIME</span><br><span class="line">LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> MEMORY / LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> DISK</span><br><span class="line">SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> DISK /  SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> MEMORY</span><br><span class="line">LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> CONFIG</span><br></pre></td></tr></table></figure>
</li>
<li><p>mysql servers </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LOAD</span> MYSQL SERVERS <span class="keyword">TO</span> RUNTIME   让修改的配置生效</span><br><span class="line"><span class="keyword">SAVE</span> MYSQL SERVERS <span class="keyword">TO</span> <span class="keyword">MEMORY</span></span><br><span class="line"><span class="keyword">LOAD</span> MYSQL SERVERS <span class="keyword">TO</span> <span class="keyword">MEMORY</span></span><br><span class="line"><span class="keyword">SAVE</span> MYSQL SERVERS <span class="keyword">TO</span> DISK      将修改的配置持久化</span><br><span class="line"><span class="keyword">LOAD</span> MYSQL SERVERS <span class="keyword">FROM</span> CONFIG</span><br></pre></td></tr></table></figure>
</li>
<li><p>mysql query rules</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> run</span><br><span class="line"><span class="keyword">save</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> mem</span><br><span class="line"><span class="keyword">load</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> mem</span><br><span class="line"><span class="keyword">save</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> disk</span><br><span class="line"><span class="keyword">load</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">from</span> config</span><br></pre></td></tr></table></figure>
</li>
<li><p>mysql variables</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> runtime</span><br><span class="line"><span class="keyword">save</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></span><br><span class="line"><span class="keyword">load</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></span><br><span class="line"><span class="keyword">save</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> disk</span><br><span class="line"><span class="keyword">load</span> mysql <span class="keyword">variables</span> <span class="keyword">from</span> config</span><br></pre></td></tr></table></figure>
</li>
<li><p>admin variables</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> runtime</span><br><span class="line"><span class="keyword">save</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></span><br><span class="line"><span class="keyword">load</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></span><br><span class="line"><span class="keyword">save</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> disk</span><br><span class="line"><span class="keyword">load</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">from</span> config</span><br></pre></td></tr></table></figure>
</li>
<li><p>参考</p>
</li>
<li><a href="https://github.com/sysown/proxysql/wiki/Multi-layer-configuration-system" target="_blank" rel="noopener">https://github.com/sysown/proxysql/wiki/Multi-layer-configuration-system</a></li>
<li><a href="https://severalnines.com/blog/mysql-load-balancing-proxysql-overview" target="_blank" rel="noopener">https://severalnines.com/blog/mysql-load-balancing-proxysql-overview</a></li>
<li><a href="http://seanlook.com/2017/04/10/mysql-proxysql-install-config/" target="_blank" rel="noopener">http://seanlook.com/2017/04/10/mysql-proxysql-install-config/</a></li>
</ul>
<h2 id="ProxySQL读写分离示例"><a href="#ProxySQL读写分离示例" class="headerlink" title="ProxySQL读写分离示例"></a>ProxySQL读写分离示例</h2><h3 id="准备-1"><a href="#准备-1" class="headerlink" title="准备"></a>准备</h3><p>Master:118.190.67.67:3306<br>Slave :139.196.95.103:3306(192.168.7.50)<br>ProxySQL：139.196.95.103:3306(192.168.7.50)<br>版本：percona-server 5.7.18  </p>
<h3 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h3><p>主从安装配置省略。  </p>
<h3 id="示例目标"><a href="#示例目标" class="headerlink" title="示例目标"></a>示例目标</h3><p>客户端通过访问ProxySQL的ip，实际访问Master和Slave的效果。  </p>
<h3 id="添加后端DB服务"><a href="#添加后端DB服务" class="headerlink" title="添加后端DB服务"></a>添加后端DB服务</h3><p>100是主库，101是从库，同时主库也处理1/10的读请求，登录ProxySQL管理端设置：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[(none)]</span> <span class="selector-tag">14</span><span class="selector-pseudo">:22</span><span class="selector-pseudo">:06</span> &gt; <span class="selector-tag">insert</span> <span class="selector-tag">into</span> <span class="selector-tag">mysql_servers</span>(hostgroup_id,hostname,port,weight,comment) <span class="selector-tag">values</span>(<span class="number">100</span>, <span class="string">'118.190.67.67'</span>, <span class="number">3306</span>, <span class="number">1</span>, <span class="string">'db0,ReadWrite'</span>),(<span class="number">101</span>, <span class="string">'192.168.7.50'</span>, <span class="number">3306</span>, <span class="number">9</span>, <span class="string">'db0,ReadOnly'</span>);</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">2</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="添加访问用户"><a href="#添加访问用户" class="headerlink" title="添加访问用户"></a>添加访问用户</h3><p>登录Master主库设置监控用户和程序用户(由于是测试使用，权限较大，主机允许所有)：<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 15:51:32 &gt; <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">'monitor'</span>@<span class="string">'%'</span> identified <span class="keyword">by</span> <span class="string">'monitor'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:51:37 &gt; grant <span class="keyword">select</span>,super,process,<span class="keyword">show</span> databases,replication client,replication slave <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'monitor'</span>@<span class="string">'%'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:45:23 &gt; <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">'user0'</span>@<span class="string">'%'</span> identified <span class="keyword">by</span> <span class="string">'password0'</span>;                   </span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:49:42 &gt; GRANT <span class="keyword">SELECT</span>, RELOAD, PROCESS, <span class="keyword">SHOW</span> DATABASES, SUPER, LOCK TABLES, <span class="keyword">EXECUTE</span>, <span class="keyword">SHOW</span> <span class="keyword">VIEW</span>, <span class="keyword">TRIGGER</span>, EVENT <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'read0'</span>@<span class="string">'%'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>登录ProxySQL管理端设置：<br>这里default_hostgroup指定了hostgroup为100的主库，下文会设置SELECT …FOR UPDATE规则到100，SELECT到101，其他所有的SQL到default_hostgroup，也就是主库。<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[(none)]</span> <span class="selector-tag">14</span><span class="selector-pseudo">:22</span><span class="selector-pseudo">:15</span> &gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">mysql_users</span> (username, password, active, default_hostgroup, max_connections) <span class="selector-tag">VALUES</span> (<span class="string">'user0'</span>, <span class="string">'password0'</span>, <span class="number">1</span>, <span class="number">100</span>, <span class="number">1000</span>); </span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">2</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="添加复制关系"><a href="#添加复制关系" class="headerlink" title="添加复制关系"></a>添加复制关系</h3><p>登录ProxySQL管理端设置：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 17:32:46 &gt; INSERT INTO mysql_replication_hostgroups VALUES(100,101,'db0');</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 17:33:30 &gt; load mysql variables to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 17:33:54 &gt; save mysql variables to disk;</span><br><span class="line">Query OK, 83 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 17:35:53 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_read_only_log ORDER BY time_start_us DESC LIMIT 10;</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> success_time_us </span>|<span class="string"> read_only </span>|<span class="string"> error </span>|</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085770195146 </span>|<span class="string"> 630             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085770194710 </span>|<span class="string"> 23722           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085768695087 </span>|<span class="string"> 650             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085768694620 </span>|<span class="string"> 23706           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085767194957 </span>|<span class="string"> 628             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085767194507 </span>|<span class="string"> 23686           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085765694834 </span>|<span class="string"> 634             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085765694387 </span>|<span class="string"> 23669           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085764194744 </span>|<span class="string"> 641             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085764194301 </span>|<span class="string"> 23729           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="修改全局变量"><a href="#修改全局变量" class="headerlink" title="修改全局变量"></a>修改全局变量</h3><p>登录ProxySQL管理端设置：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-query_retries_on_failure</span>=0;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-max_stmts_per_connection</span>=1000;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-eventslog_filename</span>=<span class="string">'queries.log'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_slave_lag_when_null</span>=7200;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-ping_timeout_server</span>=1500;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_connect_timeout</span>=1000;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-default_max_latency_ms</span>=2000;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_username</span>=<span class="string">'monitor'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_password</span>=<span class="string">'monitor'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-server_version</span>=<span class="string">'5.7.18'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>全局变量生效并保存到磁盘：<br>登录ProxySQL管理端设置：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 14:25:07 &gt; load mysql<span class="built_in"> users </span><span class="keyword">to</span> runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:27 &gt; load mysql servers <span class="keyword">to</span> runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:27 &gt; load mysql variables <span class="keyword">to</span> runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:28 &gt; save mysql<span class="built_in"> users </span><span class="keyword">to</span> disk;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:36 &gt; save mysql servers <span class="keyword">to</span> disk;</span><br><span class="line">save mysql variables <span class="keyword">to</span> disk;Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:37 &gt; save mysql variables <span class="keyword">to</span> disk;</span><br><span class="line">Query OK, 83 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:37 &gt; save mysql<span class="built_in"> users </span><span class="keyword">to</span> mem;  -- 可以屏蔽看到的明文密码</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="路由规则"><a href="#路由规则" class="headerlink" title="路由规则"></a>路由规则</h3><ul>
<li>ProxySQL使用查询规则来确定路由，如果没有规则用于查询，默认会访问hostgroup 0主机组，会报以下错误：<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie ~]# mysql -uuser0 -ppassword0 -h 127.0.0.1 -P6033 -e <span class="string">"SELECT 1"</span></span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line"><span class="builtin-name">ERROR</span> 9001 (HY000) at line 1: Max connect timeout reached <span class="keyword">while</span> reaching hostgroup 1 after 2000ms</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>设置路由规则：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[(none)]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:14</span> &gt; <span class="selector-tag">use</span> <span class="selector-tag">main</span>;</span><br><span class="line"><span class="selector-tag">Database</span> <span class="selector-tag">changed</span></span><br><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:15</span> &gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">mysql_query_rules</span> (active, match_pattern, destination_hostgroup, cache_ttl) <span class="selector-tag">VALUES</span> (<span class="number">1</span>, <span class="string">'^SELECT .* FOR UPDATE'</span>, <span class="number">100</span>, NULL);</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">1</span> <span class="selector-tag">row</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:17</span> &gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">mysql_query_rules</span> (active, match_pattern, destination_hostgroup, cache_ttl) <span class="selector-tag">VALUES</span> (<span class="number">1</span>, <span class="string">'^SELECT .*'</span>, <span class="number">101</span>, NULL);</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">1</span> <span class="selector-tag">row</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:18</span> &gt; <span class="selector-tag">load</span> <span class="selector-tag">mysql</span> <span class="selector-tag">query</span> <span class="selector-tag">rules</span> <span class="selector-tag">to</span> <span class="selector-tag">run</span>;</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">0</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:56</span> &gt; <span class="selector-tag">save</span> <span class="selector-tag">mysql</span> <span class="selector-tag">query</span> <span class="selector-tag">rules</span> <span class="selector-tag">to</span> <span class="selector-tag">disk</span>;</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">0</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.03</span> sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="常用查询"><a href="#常用查询" class="headerlink" title="常用查询"></a>常用查询</h3><ul>
<li><p>查询连接日志：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:45:08 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_connect_log ORDER BY time_start_us DESC LIMIT 10;</span><br><span class="line">+---------------+------+------------------+-------------------------+---------------+</span><br><span class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> connect_success_time_us </span>|<span class="string"> connect_error </span>|</span><br><span class="line">+---------------+------+------------------+-------------------------+---------------+</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590343795072 </span>|<span class="string"> 410                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590343780010 </span>|<span class="string"> 69662                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590283795083 </span>|<span class="string"> 521                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590283779977 </span>|<span class="string"> 68310                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590223794987 </span>|<span class="string"> 533                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590223779913 </span>|<span class="string"> 53220                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590163794887 </span>|<span class="string"> 497                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590163779772 </span>|<span class="string"> 71389                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590103794788 </span>|<span class="string"> 487                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590103779728 </span>|<span class="string"> 68372                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">+---------------+------+------------------+-------------------------+---------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询ping日志：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:46:22 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_ping_log ORDER BY time_start_us DESC LIMIT 10;</span><br><span class="line">+---------------+------+------------------+----------------------+------------+</span><br><span class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> ping_success_time_us </span>|<span class="string"> ping_error </span>|</span><br><span class="line">+---------------+------+------------------+----------------------+------------+</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590413773092 </span>|<span class="string"> 100                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590413770521 </span>|<span class="string"> 23105                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590403773088 </span>|<span class="string"> 168                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590403770479 </span>|<span class="string"> 23080                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590393772977 </span>|<span class="string"> 135                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590393770364 </span>|<span class="string"> 23078                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590383772899 </span>|<span class="string"> 138                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590383770309 </span>|<span class="string"> 23205                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590373772885 </span>|<span class="string"> 102                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590373770291 </span>|<span class="string"> 23099                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">+---------------+------+------------------+----------------------+------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询后端DB状态</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] <span class="number">13</span>:<span class="number">46</span>:<span class="number">55</span> &gt; SELECT * FROM mysql_servers;</span><br><span class="line">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+</span><br><span class="line">| <span class="type">hostgroup_id</span> | <span class="type">hostname</span>      | <span class="type">port</span> | <span class="type">status</span> | <span class="type">weight</span> | <span class="type">compression</span> | <span class="type">max_connections</span> | <span class="type">max_replication_lag</span> | <span class="type">use_ssl</span> | <span class="type">max_latency_ms</span> | <span class="type">comment</span>       |<span class="type"></span></span><br><span class="line"><span class="type">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+</span></span><br><span class="line"><span class="type">| 100</span>          | <span class="type">118</span><span class="number">.190</span><span class="number">.67</span><span class="number">.67</span> | <span class="type">3306</span> | <span class="type">ONLINE</span> | <span class="type">1</span>      | <span class="type">0</span>           | <span class="type">1000</span>            | <span class="type">0</span>                   | <span class="type">0</span>       | <span class="type">0</span>              | <span class="type">db0</span>,ReadWrite |<span class="type"></span></span><br><span class="line"><span class="type">| 101</span>          | <span class="type">192</span><span class="number">.168</span><span class="number">.7</span><span class="number">.50</span>  | <span class="type">3306</span> | <span class="type">ONLINE</span> | <span class="type">9</span>      | <span class="type">0</span>           | <span class="type">1000</span>            | <span class="type">0</span>                   | <span class="type">0</span>       | <span class="type">0</span>              | <span class="type">db0</span>,ReadOnly  |<span class="type"></span></span><br><span class="line"><span class="type">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+</span></span><br><span class="line"><span class="type">2</span> rows <span class="built_in">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询监控状态：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:47:56 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_read_only_log ORDER BY time_start_us DESC LIMIT 10;   </span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> success_time_us </span>|<span class="string"> read_only </span>|<span class="string"> error </span>|</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590524103828 </span>|<span class="string"> 577             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590524103406 </span>|<span class="string"> 23499           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590522603717 </span>|<span class="string"> 646             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590522603268 </span>|<span class="string"> 23487           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590521103641 </span>|<span class="string"> 629             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590521103182 </span>|<span class="string"> 23497           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590519603662 </span>|<span class="string"> 639             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590519603201 </span>|<span class="string"> 23525           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590518103492 </span>|<span class="string"> 618             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590518103062 </span>|<span class="string"> 23508           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询用户信息：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MySQL [<span class="params">(none)</span>] 13<span class="function">:49</span><span class="function">:28</span> &gt;  SELECT * FROM mysql_users;   </span><br><span class="line">+<span class="params">----------</span>+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">-------------------</span>+<span class="params">----------------</span>+<span class="params">---------------</span>+<span class="params">------------------------</span>+<span class="params">--------------</span>+<span class="params">---------</span>+<span class="params">----------</span>+<span class="params">-----------------</span>+</span><br><span class="line">| username | password  | active | use_ssl | default_hostgroup | default_schema | schema_locked | transaction_persistent | fast_forward | backend | frontend | max_connections |</span><br><span class="line">+<span class="params">----------</span>+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">-------------------</span>+<span class="params">----------------</span>+<span class="params">---------------</span>+<span class="params">------------------------</span>+<span class="params">--------------</span>+<span class="params">---------</span>+<span class="params">----------</span>+<span class="params">-----------------</span>+</span><br><span class="line">| user0    | password0 | 1      | 0       | 100               | NULL           | 0             | 1                      | 0            | 1       | 1        | 1000            |</span><br><span class="line">+<span class="params">----------</span>+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">-------------------</span>+<span class="params">----------------</span>+<span class="params">---------------</span>+<span class="params">------------------------</span>+<span class="params">--------------</span>+<span class="params">---------</span>+<span class="params">----------</span>+<span class="params">-----------------</span>+</span><br><span class="line">1 row in <span class="keyword">set</span> <span class="params">(0.00 sec)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查询连接池：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] <span class="number">13</span>:<span class="number">51</span>:<span class="number">19</span> &gt; SELECT * FROM stats.stats_mysql_connection_pool;</span><br><span class="line">+-----------+---------------+----------+--------+----------+----------+--------+---------+---------+-----------------+-----------------+------------+</span><br><span class="line">| <span class="type">hostgroup</span> | <span class="type">srv_host</span>      | <span class="type">srv_port</span> | <span class="type">status</span> | <span class="type">ConnUsed</span> | <span class="type">ConnFree</span> | <span class="type">ConnOK</span> | <span class="type">ConnERR</span> | <span class="type">Queries</span> | <span class="type">Bytes_data_sent</span> | <span class="type">Bytes_data_recv</span> | <span class="type">Latency_us</span> |<span class="type"></span></span><br><span class="line"><span class="type">+-----------+---------------+----------+--------+----------+----------+--------+---------+---------+-----------------+-----------------+------------+</span></span><br><span class="line"><span class="type">| 100</span>       | <span class="type">118</span><span class="number">.190</span><span class="number">.67</span><span class="number">.67</span> | <span class="type">3306</span>     | <span class="type">ONLINE</span> | <span class="type">0</span>        | <span class="type">1</span>        | <span class="type">1</span>      | <span class="type">0</span>       | <span class="type">3</span>       | <span class="type">58</span>              | <span class="type">233</span>             | <span class="type">23059</span>      |<span class="type"></span></span><br><span class="line"><span class="type">| 101</span>       | <span class="type">192</span><span class="number">.168</span><span class="number">.7</span><span class="number">.50</span>  | <span class="type">3306</span>     | <span class="type">ONLINE</span> | <span class="type">0</span>        | <span class="type">1</span>        | <span class="type">3</span>      | <span class="type">88</span>      | <span class="type">5</span>       | <span class="type">106</span>             | <span class="type">360</span>             | <span class="type">102</span>        |<span class="type"></span></span><br><span class="line"><span class="type">+-----------+---------------+----------+--------+----------+----------+--------+---------+---------+-----------------+-----------------+------------+</span></span><br><span class="line"><span class="type">2</span> rows <span class="built_in">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询执行命令统计信息：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:51:47 &gt; SELECT <span class="symbol">*</span> FROM stats_mysql_commands_counters WHERE Total_cnt;</span><br><span class="line">+---------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</span><br><span class="line">|<span class="string"> Command </span>|<span class="string"> Total_Time_us </span>|<span class="string"> Total_cnt </span>|<span class="string"> cnt_100us </span>|<span class="string"> cnt_500us </span>|<span class="string"> cnt_1ms </span>|<span class="string"> cnt_5ms </span>|<span class="string"> cnt_10ms </span>|<span class="string"> cnt_50ms </span>|<span class="string"> cnt_100ms </span>|<span class="string"> cnt_500ms </span>|<span class="string"> cnt_1s </span>|<span class="string"> cnt_5s </span>|<span class="string"> cnt_10s </span>|<span class="string"> cnt_INFs </span>|</span><br><span class="line">+---------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</span><br><span class="line">|<span class="string"> SELECT  </span>|<span class="string"> 167664        </span>|<span class="string"> 27        </span>|<span class="string"> 15        </span>|<span class="string"> 4         </span>|<span class="string"> 0       </span>|<span class="string"> 6       </span>|<span class="string"> 0        </span>|<span class="string"> 1        </span>|<span class="string"> 0         </span>|<span class="string"> 1         </span>|<span class="string"> 0      </span>|<span class="string"> 0      </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> SET     </span>|<span class="string"> 0             </span>|<span class="string"> 2         </span>|<span class="string"> 2         </span>|<span class="string"> 0         </span>|<span class="string"> 0       </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0         </span>|<span class="string"> 0         </span>|<span class="string"> 0      </span>|<span class="string"> 0      </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> SHOW    </span>|<span class="string"> 13818         </span>|<span class="string"> 1         </span>|<span class="string"> 0         </span>|<span class="string"> 0         </span>|<span class="string"> 0       </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|<span class="string"> 1        </span>|<span class="string"> 0         </span>|<span class="string"> 0         </span>|<span class="string"> 0      </span>|<span class="string"> 0      </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|</span><br><span class="line">+---------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询路由规则的详情：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:53:05 &gt; SELECT <span class="symbol">*</span> FROM stats_mysql_query_digest ORDER BY sum_time DESC;</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">|<span class="string"> hostgroup </span>|<span class="string"> schemaname         </span>|<span class="string"> username </span>|<span class="string"> digest             </span>|<span class="string"> digest_text                      </span>|<span class="string"> count_star </span>|<span class="string"> first_seen </span>|<span class="string"> last_seen  </span>|<span class="string"> sum_time </span>|<span class="string"> min_time </span>|<span class="string"> max_time </span>|</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0xA322907BCBC120DD </span>|<span class="string"> select * from tables limit ?     </span>|<span class="string"> 1          </span>|<span class="string"> 1504589288 </span>|<span class="string"> 1504589288 </span>|<span class="string"> 133826   </span>|<span class="string"> 133826   </span>|<span class="string"> 133826   </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x02033E45904D3DF0 </span>|<span class="string"> show databases                   </span>|<span class="string"> 1          </span>|<span class="string"> 1504589886 </span>|<span class="string"> 1504589886 </span>|<span class="string"> 13818    </span>|<span class="string"> 13818    </span>|<span class="string"> 13818    </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x3765930C7143F468 </span>|<span class="string"> select * from t1                 </span>|<span class="string"> 1          </span>|<span class="string"> 1504589311 </span>|<span class="string"> 1504589311 </span>|<span class="string"> 13466    </span>|<span class="string"> 13466    </span>|<span class="string"> 13466    </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0xA322907BCBC120DD </span>|<span class="string"> select * from tables limit ?     </span>|<span class="string"> 2          </span>|<span class="string"> 1504582304 </span>|<span class="string"> 1504583327 </span>|<span class="string"> 7325     </span>|<span class="string"> 3564     </span>|<span class="string"> 3761     </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x814EDBB68FBACD5D </span>|<span class="string"> select * from neworders limit ?  </span>|<span class="string"> 2          </span>|<span class="string"> 1504583184 </span>|<span class="string"> 1504583242 </span>|<span class="string"> 5959     </span>|<span class="string"> 2964     </span>|<span class="string"> 2995     </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x3765930C7143F468 </span>|<span class="string"> select * from t1                 </span>|<span class="string"> 3          </span>|<span class="string"> 1504583288 </span>|<span class="string"> 1504589859 </span>|<span class="string"> 3386     </span>|<span class="string"> 64       </span>|<span class="string"> 3056     </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0xA322907BCBC120DD </span>|<span class="string"> select * from tables limit ?     </span>|<span class="string"> 2          </span>|<span class="string"> 1504583168 </span>|<span class="string"> 1504583299 </span>|<span class="string"> 3095     </span>|<span class="string"> 117      </span>|<span class="string"> 2978     </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x620B328FE9D6D71A </span>|<span class="string"> SELECT DATABASE()                </span>|<span class="string"> 2          </span>|<span class="string"> 1504589729 </span>|<span class="string"> 1504589859 </span>|<span class="string"> 607      </span>|<span class="string"> 193      </span>|<span class="string"> 414      </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x226CD90D52A2BA0B </span>|<span class="string"> select @@version_comment limit ? </span>|<span class="string"> 8          </span>|<span class="string"> 1504582304 </span>|<span class="string"> 1504589886 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x52B8B04283B3A18D </span>|<span class="string"> set names utf8                   </span>|<span class="string"> 1          </span>|<span class="string"> 1504583162 </span>|<span class="string"> 1504583162 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x52B8B04283B3A18D </span>|<span class="string"> set names utf8                   </span>|<span class="string"> 1          </span>|<span class="string"> 1504582582 </span>|<span class="string"> 1504582582 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x226CD90D52A2BA0B </span>|<span class="string"> select @@version_comment limit ? </span>|<span class="string"> 6          </span>|<span class="string"> 1504583162 </span>|<span class="string"> 1504583299 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 13:55:46 &gt; SELECT hostgroup hg, sum_time, count_star, digest_text FROM stats_mysql_query_digest ORDER BY sum_time DESC;</span><br><span class="line">+-----+----------+------------+----------------------------------+</span><br><span class="line">|<span class="string"> hg  </span>|<span class="string"> sum_time </span>|<span class="string"> count_star </span>|<span class="string"> digest_text                      </span>|</span><br><span class="line">+-----+----------+------------+----------------------------------+</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 133826   </span>|<span class="string"> 1          </span>|<span class="string"> select * from tables limit ?     </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 13818    </span>|<span class="string"> 1          </span>|<span class="string"> show databases                   </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 13466    </span>|<span class="string"> 1          </span>|<span class="string"> select * from t1                 </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 7325     </span>|<span class="string"> 2          </span>|<span class="string"> select * from tables limit ?     </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 5959     </span>|<span class="string"> 2          </span>|<span class="string"> select * from neworders limit ?  </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 3386     </span>|<span class="string"> 3          </span>|<span class="string"> select * from t1                 </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 3095     </span>|<span class="string"> 2          </span>|<span class="string"> select * from tables limit ?     </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 607      </span>|<span class="string"> 2          </span>|<span class="string"> SELECT DATABASE()                </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 8          </span>|<span class="string"> select @@version_comment limit ? </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 1          </span>|<span class="string"> set names utf8                   </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 1          </span>|<span class="string"> set names utf8                   </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 6          </span>|<span class="string"> select @@version_comment limit ? </span>|</span><br><span class="line">+-----+----------+------------+----------------------------------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询路由规则：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] <span class="number">13</span>:<span class="number">57</span>:<span class="number">12</span> &gt; SELECT rule_id, match_digest, match_pattern, replace_pattern, cache_ttl, <span class="built_in">apply</span> FROM mysql_query_rules ORDER BY rule_id;</span><br><span class="line">+---------+--------------+-----------------------+-----------------+-----------+-------+</span><br><span class="line">| <span class="type">rule_id</span> | <span class="type">match_digest</span> | <span class="type">match_pattern</span>         | <span class="type">replace_pattern</span> | <span class="type">cache_ttl</span> | <span class="type">apply</span> |<span class="type"></span></span><br><span class="line"><span class="type">+---------+--------------+-----------------------+-----------------+-----------+-------+</span></span><br><span class="line"><span class="type">| 10</span>      | <span class="type">NULL</span>         | <span class="type">^SELECT</span> .* FOR UPDATE | <span class="type">NULL</span>            | <span class="type">NULL</span>      | <span class="type">0</span>     |<span class="type"></span></span><br><span class="line"><span class="type">| 11</span>      | <span class="type">NULL</span>         | <span class="type">^SELECT</span> .*            | <span class="type">NULL</span>            | <span class="type">NULL</span>      | <span class="type">0</span>     |<span class="type"></span></span><br><span class="line"><span class="type">+---------+--------------+-----------------------+-----------------+-----------+-------+</span></span><br><span class="line"><span class="type">2</span> rows <span class="built_in">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>参考：</p>
</li>
<li><a href="https://github.com/sysown/proxysql/wiki/ProxySQL-Configuration#p6033" target="_blank" rel="noopener">https://github.com/sysown/proxysql/wiki/ProxySQL-Configuration#p6033</a></li>
<li><a href="http://seanlook.com/2017/04/17/mysql-proxysql-route-rw_split/" target="_blank" rel="noopener">http://seanlook.com/2017/04/17/mysql-proxysql-route-rw_split/</a></li>
<li><a href="http://severalnines.com/blog/how-proxysql-adds-failover-and-query-control-your-mysql-replication-setup" target="_blank" rel="noopener">http://severalnines.com/blog/how-proxysql-adds-failover-and-query-control-your-mysql-replication-setup</a></li>
</ul>
<h2 id="ProxySQL监控"><a href="#ProxySQL监控" class="headerlink" title="ProxySQL监控"></a>ProxySQL监控</h2><p>PMM是Percona推出的一款很好的监控MySQL和MongoDB的开源工具，安装方便，功能丰富，图表美观，同时也支持ProxySQL的监控，故选择PMM作为ProxySQL的监控软件。<br>这里以ProxySQL服务端(192.168.7.50)为例，作为PMM的客户端，PMM服务器为139.196.99.230,仅演示ProxySQL安装PMM客户端，服务器安装配置省略。  </p>
<h3 id="PMM-Client安装"><a href="#PMM-Client安装" class="headerlink" title="PMM Client安装"></a>PMM Client安装</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie ~]# yum localinstall -y /hwdata/duanwenjie/test/proxysql-1.4.1-1-centos67.x86<span class="emphasis">_64.rpm </span></span><br><span class="line"><span class="emphasis">Loaded plugins: security</span></span><br><span class="line"><span class="emphasis">Setting up Local Package Process</span></span><br><span class="line"><span class="emphasis">Examining /hwdata/duanwenjie/test/proxysql-1.4.1-1-centos67.x86_</span>64.rpm: proxysql-1.4.1-1.x86<span class="emphasis">_64</span></span><br><span class="line"><span class="emphasis">Marking /hwdata/duanwenjie/test/proxysql-1.4.1-1-centos67.x86_</span>64.rpm to be installed</span><br><span class="line">Resolving Dependencies</span><br><span class="line">There are unfinished transactions remaining. You might consider running yum-complete-transaction first to finish them.</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package proxysql.x86<span class="emphasis">_64 0:1.4.1-1 will be installed</span></span><br><span class="line"><span class="emphasis">--&gt; Finished Dependency Resolution</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">Dependencies Resolved</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">========================================================================================================================================================================</span></span><br><span class="line"><span class="emphasis"> Package                           Arch                            Version                             Repository                                                  Size</span></span><br><span class="line"><span class="emphasis">========================================================================================================================================================================</span></span><br><span class="line"><span class="emphasis">Installing:</span></span><br><span class="line"><span class="emphasis"> proxysql                          x86_</span>64                          1.4.1-1                             /proxysql-1.4.1-1-centos67.x86<span class="emphasis">_64                           19 M</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">Transaction Summary</span></span><br><span class="line"><span class="emphasis">========================================================================================================================================================================</span></span><br><span class="line"><span class="emphasis">Install       1 Package(s)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">Total size: 19 M</span></span><br><span class="line"><span class="emphasis">Installed size: 19 M</span></span><br><span class="line"><span class="emphasis">Downloading Packages:</span></span><br><span class="line"><span class="emphasis">Running rpm_</span>check<span class="emphasis">_debug</span></span><br><span class="line"><span class="emphasis">Running Transaction Test</span></span><br><span class="line"><span class="emphasis">Transaction Test Succeeded</span></span><br><span class="line"><span class="emphasis">Running Transaction</span></span><br><span class="line"><span class="emphasis">Warning: RPMDB altered outside of yum.</span></span><br><span class="line"><span class="emphasis">** Found 1 pre-existing rpmdb problem(s), 'yum check' output follows:</span></span><br><span class="line"><span class="emphasis">mysql-community-libs-5.7.16-1.el6.x86_</span>64 has missing requires of mysql-community-common(x86-64) &gt;= (<span class="emphasis">'0'</span>, <span class="emphasis">'5.7.9'</span>, None)</span><br><span class="line"><span class="code">  Installing : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></span><br><span class="line"><span class="code">  Verifying  : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line"><span class="code">  proxysql.x86_64 0:1.4.1-1                                                                                                                                             </span></span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">[root@jiessie ~]#</span><br></pre></td></tr></table></figure>
<h3 id="PMM-Client配置"><a href="#PMM-Client配置" class="headerlink" title="PMM Client配置"></a>PMM Client配置</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie ~]# ifconfig  #查看IP地址</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:00:DC:49  </span><br><span class="line">          inet addr:192.168.7.50  Bcast:192.168.15.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:1017660 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:1380639 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:273791594 (261.1 MiB)  TX bytes:116287303 (110.9 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap<span class="keyword">:Local</span> Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:1297762 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:1297762 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:141606631 (135.0 MiB)  TX bytes:141606631 (135.0 MiB)</span><br><span class="line"></span><br><span class="line">[root@jiessie ~]# pmm-admin<span class="built_in"> config </span>--bind-address 192.168.7.50 --client-address 139.196.95.103 --server 139.196.99.230:8080 --client-name ProxySQL_Test   #添加config</span><br><span class="line">OK, PMM<span class="built_in"> server </span>is alive.</span><br><span class="line"></span><br><span class="line">PMM<span class="built_in"> Server </span>     | 139.196.99.230:8080 </span><br><span class="line">Client Name     | ProxySQL_Test</span><br><span class="line">Client<span class="built_in"> Address </span> | 139.196.95.103 (192.168.7.50)</span><br><span class="line">[root@jiessie ~]# pmm-admin <span class="builtin-name">add</span> linux:metrics --force ProxySQL_Test     #添加Linux监控</span><br><span class="line">OK, now monitoring this system.</span><br><span class="line">[root@jiessie ~]# </span><br><span class="line">[root@jiessie ~]# pmm-admin <span class="builtin-name">add</span> proxysql:metrics --dsn <span class="string">"admin:admin@tcp(127.0.0.1:6032)/"</span> proxysql6032 #添加ProxySQL监控</span><br><span class="line">OK, now monitoring ProxySQL metrics using DSN admin:***@tcp(localhost:6032)</span><br><span class="line">[root@jiessie ~]# </span><br><span class="line">[root@jiessie ~]# pmm-admin list    #查看状态</span><br><span class="line">pmm-admin 1.3.0</span><br><span class="line"></span><br><span class="line">PMM<span class="built_in"> Server </span>     | 139.196.99.230:8080 </span><br><span class="line">Client Name     | ProxySQL_Test</span><br><span class="line">Client<span class="built_in"> Address </span> | 139.196.95.103 (192.168.7.50)</span><br><span class="line">Service Manager | unix-systemv</span><br><span class="line"></span><br><span class="line">----------------- -------------- ----------- -------- ------------------------------ --------</span><br><span class="line">SERVICE<span class="built_in"> TYPE </span>     NAME           LOCAL<span class="built_in"> PORT </span> RUNNING  DATA SOURCE                    OPTIONS </span><br><span class="line">----------------- -------------- ----------- -------- ------------------------------ --------</span><br><span class="line">linux:metrics     ProxySQL_Test  42000       <span class="literal">YES</span>      -                                      </span><br><span class="line">mysql:metrics     ProxySQL_Test  42002       <span class="literal">YES</span>      root:***@tcp(127.0.0.1:3306)           </span><br><span class="line">proxysql:metrics  proxysql6032   42004       <span class="literal">YES</span>      admin:***@tcp(127.0.0.1:6032)          </span><br><span class="line"></span><br><span class="line">[root@jiessie ~]#</span><br></pre></td></tr></table></figure>
<h3 id="PMM-Server监控展示"><a href="#PMM-Server监控展示" class="headerlink" title="PMM Server监控展示"></a>PMM Server监控展示</h3><p>PMM Server监控项包括：</p>
<ul>
<li>客户端连接数</li>
<li>客户端总查询</li>
<li>ProxySQL连接池状态</li>
<li>活动连接</li>
<li>失败连接</li>
<li>客户端查询路由详情</li>
<li>客户端延迟状态</li>
<li>网络接口<br><img src="http://note.youdao.com/yws/public/resource/eda87c5cc1090ba9cc4be116906c805b/xmlnote/784F7090F01E4C62AE28CA4BB08A82F8/37001" alt="image"></li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>ProxySQL是一款很出色的MySQL中间件，在稳定性上、易用性、高性能等方面表现很不错。由于发布的时间较短，功能可能还不太完善，需要多做测试，特别是查询路由和规则方面需要详情的了解，测试。可重点关注。</p>

      
    </div>
    
    
    

    

    

    
<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

  
</div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/proxysql/" rel="tag"># proxysql</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/误删除ibdata1-Table-doesn-t-exist-恢复案例.html" rel="next" title="误删除ibdata1(Table doesn,t exist)恢复案例">
                <i class="fa fa-chevron-left"></i> 误删除ibdata1(Table doesn,t exist)恢复案例
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/Aliyun-ECS搭建MHA-Keepalived-VIP-MySQL5-7.html" rel="prev" title="Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7">
                Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/jiessie.png"
                alt="Jiessie" />
            
              <p class="site-author-name" itemprop="name">Jiessie</p>
              <p class="site-description motion-element" itemprop="description">最怕一生碌碌无为,还说平凡难能可贵！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">12</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.percona.com/" target="_blank" title="Percona">
                      
                        <i class="fa fa-fw fa-globe"></i>Percona</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://mariadb.com/kb/zh-cn/mariadb/" target="_blank" title="MariaDB">
                      
                        <i class="fa fa-fw fa-globe"></i>MariaDB</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysqlserverteam.com/" target="_blank" title="serverteam">
                      
                        <i class="fa fa-fw fa-globe"></i>serverteam</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysqlhighavailability.com/" target="_blank" title="highavailability">
                      
                        <i class="fa fa-fw fa-globe"></i>highavailability</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysql.taobao.org/monthly/" target="_blank" title="淘宝月报">
                      
                        <i class="fa fa-fw fa-globe"></i>淘宝月报</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://dimitrik.free.fr/blog/" target="_blank" title="dimitrik">
                      
                        <i class="fa fa-fw fa-globe"></i>dimitrik</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备"><span class="nav-number">2.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装配置详解"><span class="nav-number">3.</span> <span class="nav-text">安装配置详解</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#安装"><span class="nav-number">3.1.</span> <span class="nav-text">安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#启动"><span class="nav-number">3.2.</span> <span class="nav-text">启动</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#内置对象介绍"><span class="nav-number">4.</span> <span class="nav-text">内置对象介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#登录"><span class="nav-number">4.1.</span> <span class="nav-text">登录</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#内置库"><span class="nav-number">4.2.</span> <span class="nav-text">内置库</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#main库"><span class="nav-number">4.2.1.</span> <span class="nav-text">main库</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#runtime-表"><span class="nav-number">4.2.1.1.</span> <span class="nav-text">runtime_表</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#global-variables表"><span class="nav-number">4.2.1.1.1.</span> <span class="nav-text">global_variables表</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#mysql-servers表"><span class="nav-number">4.2.1.1.2.</span> <span class="nav-text">mysql_servers表</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysql-users表"><span class="nav-number">4.2.1.2.</span> <span class="nav-text">mysql_users表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysql-replication-hostgroups表"><span class="nav-number">4.2.1.3.</span> <span class="nav-text">mysql_replication_hostgroups表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysql-query-rules查询规则表"><span class="nav-number">4.2.1.4.</span> <span class="nav-text">mysql_query_rules查询规则表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#scheduler调度表"><span class="nav-number">4.2.1.5.</span> <span class="nav-text">scheduler调度表</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#disk库"><span class="nav-number">4.2.2.</span> <span class="nav-text">disk库</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#stats库"><span class="nav-number">4.2.3.</span> <span class="nav-text">stats库</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#stats-mysql-commands-counters表"><span class="nav-number">4.2.3.1.</span> <span class="nav-text">stats_mysql_commands_counters表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#stats-mysql-global表"><span class="nav-number">4.2.3.2.</span> <span class="nav-text">stats_mysql_global表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#stats-mysql-processlist表"><span class="nav-number">4.2.3.3.</span> <span class="nav-text">stats_mysql_processlist表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#stats-mysql-query-digest表"><span class="nav-number">4.2.3.4.</span> <span class="nav-text">stats_mysql_query_digest表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#stats-mysql-query-rules表"><span class="nav-number">4.2.3.5.</span> <span class="nav-text">stats_mysql_query_rules表</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#monitor库"><span class="nav-number">4.2.4.</span> <span class="nav-text">monitor库</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#mysql-server-connect-mysql-server-connect-log表"><span class="nav-number">4.2.4.1.</span> <span class="nav-text">mysql_server_connect/mysql_server_connect_log表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysql-server-ping-mysql-server-ping-log表"><span class="nav-number">4.2.4.2.</span> <span class="nav-text">mysql_server_ping/mysql_server_ping_log表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#mysql-server-replication-lag-log表"><span class="nav-number">4.2.4.3.</span> <span class="nav-text">mysql_server_replication_lag_log表</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#内置参数"><span class="nav-number">4.2.5.</span> <span class="nav-text">内置参数</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ProxySQL多层配置设计"><span class="nav-number">4.3.</span> <span class="nav-text">ProxySQL多层配置设计</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ProxySQL设计模型介绍"><span class="nav-number">4.3.1.</span> <span class="nav-text">ProxySQL设计模型介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#ProxySQL多层配置修改示例"><span class="nav-number">4.3.1.1.</span> <span class="nav-text">ProxySQL多层配置修改示例</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ProxySQL读写分离示例"><span class="nav-number">5.</span> <span class="nav-text">ProxySQL读写分离示例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#准备-1"><span class="nav-number">5.1.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装配置"><span class="nav-number">5.2.</span> <span class="nav-text">安装配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#示例目标"><span class="nav-number">5.3.</span> <span class="nav-text">示例目标</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加后端DB服务"><span class="nav-number">5.4.</span> <span class="nav-text">添加后端DB服务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加访问用户"><span class="nav-number">5.5.</span> <span class="nav-text">添加访问用户</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加复制关系"><span class="nav-number">5.6.</span> <span class="nav-text">添加复制关系</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改全局变量"><span class="nav-number">5.7.</span> <span class="nav-text">修改全局变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#路由规则"><span class="nav-number">5.8.</span> <span class="nav-text">路由规则</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常用查询"><span class="nav-number">5.9.</span> <span class="nav-text">常用查询</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ProxySQL监控"><span class="nav-number">6.</span> <span class="nav-text">ProxySQL监控</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#PMM-Client安装"><span class="nav-number">6.1.</span> <span class="nav-text">PMM Client安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PMM-Client配置"><span class="nav-number">6.2.</span> <span class="nav-text">PMM Client配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PMM-Server监控展示"><span class="nav-number">6.3.</span> <span class="nav-text">PMM Server监控展示</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">7.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiessie</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

</body>
</html>
