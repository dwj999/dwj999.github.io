<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Jiessie&#39;s&#39; Blog</title>
  
  <subtitle>没伞的孩子必须努力奔跑</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://dwj999.github.io/"/>
  <updated>2020-05-20T07:18:07.514Z</updated>
  <id>https://dwj999.github.io/</id>
  
  <author>
    <name>Jiessie</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>MySQL启动配置文件搜索顺序解析</title>
    <link href="https://dwj999.github.io/MySQL%E5%90%AF%E5%8A%A8%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%90%9C%E7%B4%A2%E9%A1%BA%E5%BA%8F%E8%A7%A3%E6%9E%90.html"/>
    <id>https://dwj999.github.io/MySQL启动配置文件搜索顺序解析.html</id>
    <published>2018-07-20T07:12:47.000Z</published>
    <updated>2020-05-20T07:18:07.514Z</updated>
    
    <content type="html"><![CDATA[<h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>MySQL数据库支持从配置文件中读取启动选项，不用每次启动时在命令行输入，方便管理。很多选项都是以纯文本的形式存在，可以用任何的编辑器打开编辑。.mylogin.cnf文件除外，此文件包含了登录路径的选项，使用mysql_config_editor程序去创建的加密文件。</p><h2 id="搜索顺序"><a href="#搜索顺序" class="headerlink" title="搜索顺序"></a>搜索顺序</h2><p>MySQL默认情况下是按照一定的顺序去搜索具体路径的配置文件，并且在windows和linux的操作顺序不一样。<br>搜索顺序，按照下面表格中文件名从上往下，如果存在相同的选项，最后一个出现的选项有最高的优先级。参考官网的解释：<font color="FF0000"><b>”Options are processed in order, so if an option is specified multiple times, the last occurrence takes precedence.”</b></font></p><h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>在windows上，MySQL按照指定的顺序从下表中显示的文件中读取启动选项</p><table><thead><tr><th>文件名</th><th>描述</th></tr></thead><tbody><tr><td>%WINDIR%\my.ini, %WINDIR%\my.cnf</td><td>全局</td></tr><tr><td>C:\my.ini, C:\my.cnf</td><td>全局</td></tr><tr><td>BASEDIR\my.ini, BASEDIR\my.cnf</td><td>全局</td></tr><tr><td>defaults-extra-file</td><td>如果存在—default-extra-file</td></tr><tr><td>%APPDATA%\MySQL.mylogin.cnf</td><td>Login选项，仅适用于client</td></tr></tbody></table><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">其中，</span><br><span class="line">WINDIR表示Windows目录的位置，例如<span class="string">C:</span>\Windows</span><br><span class="line">APPDIR表示Windows应用程序数据目录</span><br><span class="line">BASEDIR表示MySQL的安装目录</span><br></pre></td></tr></table></figure><h3 id="Linux-or-Unix"><a href="#Linux-or-Unix" class="headerlink" title="Linux or Unix"></a>Linux or Unix</h3><p>在Linux或Unix等类Unix系统上，MySQL按照指定的顺序从下表中显示的文件中读取启动选项</p><table><thead><tr><th>文件名</th><th>描述</th></tr></thead><tbody><tr><td>/etc/my.cnf</td><td>全局</td></tr><tr><td>/etc/mysql/my.cnf</td><td>全局</td></tr><tr><td>SYSCONFDIR/my.cnf</td><td>全局</td></tr><tr><td>$MYSQL_HOME/my.cnf</td><td>仅适用于server</td></tr><tr><td>defaults-extra-file</td><td>如果存在—default-extra-file</td></tr><tr><td>~/.my.cnf</td><td>用户的选项</td></tr><tr><td>~/.mylogin.cnf</td><td>Login选项，仅适用于client</td></tr></tbody></table><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">其中，</span><br><span class="line">~表示当前用户的主目录</span><br><span class="line">SYSCONFIGDIR表示在构建MySQL时使用SYSCONFIGDIR选项CMake的指定目录</span><br><span class="line">MySQL_HOME是一个环境变量，如果没有设置，并使用mysqld_safe启用MySQL，这时MySQL的安装目录就是其BASEDIR</span><br></pre></td></tr></table></figure><h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><p>生产环境一般多使用linux系统，在单实例和多实例启动时，my.cnf加载的顺序也存在不一样的情况，这里分别进行测试，对结果进行说明</p><h3 id="单实例"><a href="#单实例" class="headerlink" title="单实例"></a>单实例</h3><p>在不考虑SYSCONDIR，同时BASEDIR为/usr/local/mysql的情况下，从上面的搜索顺序来看，MySQL会依次加载以下的文件：</p><ul><li>/etc/my.cnf</li><li>/etc/mysql/my.cnf</li><li>/usr/local/mysql/my.cnf</li><li>~/.my.cnf<br>也就是说MySQL会找/etc/my.cnf这个文件，如果此文件不存在，继续找/etc/mysql/my.cnf这个文件，依此类推，最后是读取–defaults-file加载的文件，如果最后的文件也不存在，通过mysqld的帮助可以看出来:</li></ul><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/4790EAB515654EF6BDE79AC7E24DC180/56032" alt="image"></p><h4 id="etc-my-cnf"><a href="#etc-my-cnf" class="headerlink" title="/etc/my.cnf"></a>/etc/my.cnf</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf中只存在/etc/my.cnf时，很明显MySQL是加载的<font color="FF0000"><b>/etc/my.cnf</b></font></p><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/9F08A98F5E304257B81684C84D7F1A4C/56057" alt="image"></p><h4 id="etc-my-cnf-amp-amp-etc-mysql-my-cnf"><a href="#etc-my-cnf-amp-amp-etc-mysql-my-cnf" class="headerlink" title="/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf"></a>/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf中只存在/etc/my.cnf和/etc/mysql/my.cnf时，很明显MySQL是加载的<font color="FF0000"><b>/etc/mysql/my.cnf</b></font></p><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/F98D157B588946A6BE9579B6EA14B677/56069" alt="image"></p><h4 id="etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf"><a href="#etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf" class="headerlink" title="/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; /usr/local/mysql/my.cnf"></a>/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; /usr/local/mysql/my.cnf</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf中存在/etc/my.cnf和/etc/mysql/my.cnf和/usr/local/mysql/my.cnf时，很明显MySQL是加载的<font color="FF0000"><b>/usr/local/mysql/my.cnf</b></font></p><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/A89ED641C57C4F5FA13F56D0FEAB9215/56077" alt="image"></p><h4 id="etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-my-cnf"><a href="#etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-my-cnf" class="headerlink" title="/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; /usr/local/mysql/my.cnf &amp;&amp; ~/.my.cnf"></a>/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; /usr/local/mysql/my.cnf &amp;&amp; ~/.my.cnf</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，很明显MySQL是加载的<font color="FF0000"><b>~/my.cnf</b></font></p><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/6C413D12F7754A71A4755FCE6ABC4530/56084" alt="image"></p><h4 id="defaults-file"><a href="#defaults-file" class="headerlink" title="defaults-file"></a>defaults-file</h4><p>当指定<font color="FF0000"><b>–defaults-file为/tmp/my.cnf</b></font>时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，很明显MySQL是加载的<font color="FF0000"><b>/tmp/my.cnf</b></font></p><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/DC1A2943DDE54CA0B0836BABDC1FA112/56095" alt="image"></p><h3 id="多实例"><a href="#多实例" class="headerlink" title="多实例"></a>多实例</h3><p>多实例的启动通常使用mysqld_multi脚本，此脚本也支持–defaults-file选项。从mysqld_multi的官档上可以看出，mysqld_multi支持[mysqldN]的标签，其中N代表常量数字，此脚本是调用mysqld_safe命令是启动服务，所以支持<font color="FF0000"><b>[mysqld]标签做通用性配置文件</b></font>，适用于多个实例启动时的通用配置，也可以使用<font color="FF0000"><b>[mysqldN]，N代表特定端口做特殊性实例配置。</b></font></p><h4 id="etc-my-cnf-amp-amp-mysqldN"><a href="#etc-my-cnf-amp-amp-mysqldN" class="headerlink" title="/etc/my.cnf &amp;&amp; [mysqldN]"></a>/etc/my.cnf &amp;&amp; [mysqldN]</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在/etc/my.cnf加了一个<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，<font color="FF0000"><b>MySQL是加载的是/etc/my.cnf的[mysqld3306]标签配置文件</b></font></p><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/F9010C7078314524B68ABCCB79075320/56115" alt="image"></p><h4 id="etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-mysqldN"><a href="#etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-mysqldN" class="headerlink" title="/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; [mysqldN]"></a>/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; [mysqldN]</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在/etc/my.cnf和/etc/mysql/my.cnf加了一个<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，<font color="FF0000"><b>MySQL是加载的是/etc/mysql/my.cnf的[mysqld3306]标签配置文件</b></font></p><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/917AB5B37FFD4A8187526979CEEFEF2A/56124" alt="image"></p><h4 id="etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-mysqldN"><a href="#etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-mysqldN" class="headerlink" title="/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf  &amp;&amp;/usr/local/mysql/my.cnf &amp;&amp; [mysqldN]"></a>/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf  &amp;&amp;/usr/local/mysql/my.cnf &amp;&amp; [mysqldN]</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在/etc/my.cnf和/etc/mysql/my.cnf和/usr/local/mysql/my.cnf加了一个<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，<font color="FF0000"><b>MySQL是加载的还是/etc/my.cnf的[mysqld3306]标签配置文件</b></font></p><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/C07D630920334BD682CA1F7F04667F43/56133" alt="image"></p><h4 id="etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-mycf-amp-amp-mysqldN"><a href="#etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-mycf-amp-amp-mysqldN" class="headerlink" title="/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf  &amp;&amp;/usr/local/mysql/my.cnf  &amp;&amp; ~/.mycf &amp;&amp; [mysqldN]"></a>/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf  &amp;&amp;/usr/local/mysql/my.cnf  &amp;&amp; ~/.mycf &amp;&amp; [mysqldN]</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在全部配置了<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，<font color="FF0000"><b>MySQL是加载的是~/my.cnf的[mysqld3306]标签配置文件</b></font></p><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/1617DEDF15AA4734A86C7037814A0C69/56142" alt="image"></p><h4 id="defaults-file-amp-amp-mysqldN"><a href="#defaults-file-amp-amp-mysqldN" class="headerlink" title="defaults-file &amp;&amp; [mysqldN]"></a>defaults-file &amp;&amp; [mysqldN]</h4><p>当<font color="FF0000"><b>指定–defaults-file为/tmp/my.cnf</b></font>时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在了<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在全部配置了了<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，了<font color="FF0000"><b>MySQL是加载的是/tmp/my.cnf的[mysqld3306]标签配置文件</b></font></p><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/833693EF85DB4F809E03E3F14A11373C/56152" alt="image"></p><h4 id="defaults-file-1"><a href="#defaults-file-1" class="headerlink" title="defaults-file"></a>defaults-file</h4><p>当<font color="FF0000"><b>指定–defaults-file为/tmp/my.cnf</b></font>时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，全部<font color="FF0000"><b>未配置</b></font>了[mysqld3306]标签，这时候，<font color="FF0000"><b>MySQL是加载的是~/my.cnf的配置文件而不是加载的/tmp/my.cnf的配置文件，说明mysqld_multi不加载除默认搜索的配置文件外的其他[mysqld]标签</b></font></p><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/390A51668F654EEBACE26FD87CF50C3F/56164" alt="image"></p><h2 id="启动方式"><a href="#启动方式" class="headerlink" title="启动方式"></a>启动方式</h2><p>MySQL的启动包括多种，包括以下几种：</p><ul><li>/usr/local/mysql/bin/mysqld –defaults-file=/etc/my.cnf –basedir=/usr/local/mysql –datadir=/opt/mysql/data –user=mysql</li><li>/usr/local/mysql/bin/mysqld_safe –defaults-file=/etc/my.cnf –basedir=/usr/local/mysql –datadir=/opt/mysql/data –user=mysql</li><li>/etc/init.d/mysqld start &amp;&amp; service mysqld start</li><li>mysqld_multi start<h3 id="service-mysqld-start"><a href="#service-mysqld-start" class="headerlink" title="service mysqld start"></a>service mysqld start</h3>service mysqld start的启动有一个要注意的地方，它不会加载~/.my.cnf，实验如下，很明显，部<font color="FF0000"><b>service mysqld start启动方式不加载~/.my.cnf的参数</b></font></li></ul><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/A284976227264421919972DF05A06BAC/56183" alt="image"></p><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">由于linux的service启动服务的方式是调用的<span class="regexp">/sbin/</span>service脚本来进行管理的，并且<span class="regexp">/sbin/</span>service脚本是shell编写的，可以通过debug的模式来查看具体执行过程</span><br></pre></td></tr></table></figure><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/835F9C7BF570488EA0D2A1099F009BF4/56191" alt="image"><br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">通过上面的执行过程可以了解到，service mysqld start启动mysql的方式，实际最终调用的命令为：</span><br><span class="line">env -i PATH=<span class="string">/sbin</span>:<span class="string">/usr/sbin</span>:<span class="string">/bin</span>:<span class="string">/usr/bin</span> TERM=linux SYSTEMCTL_IGNORE_DEPENDENCIES= SYSTEMCTL_SKIP_REDIRECT= <span class="string">/etc/init.d/mysqld</span> start</span><br><span class="line">此命令没有包含<span class="string">/home/mysql</span>的环境变量，如果修改为以下命令，则可以加载~<span class="string">/.my.cnf</span></span><br><span class="line">命令为：</span><br><span class="line">env -i PATH=<span class="string">/sbin</span>:<span class="string">/usr/sbin</span>:<span class="string">/bin</span>:<span class="string">/usr/bin</span> HOME=<span class="string">/home/mysql</span> TERM=linux SYSTEMCTL_IGNORE_DEPENDENCIES= SYSTEMCTL_SKIP_REDIRECT= <span class="string">/etc/init.d/mysqld</span> start</span><br></pre></td></tr></table></figure></p><h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>从脚本/sbin/service的最下面部分可以看出，具体的启动命令，如果想修改为让service mysqld start的启动方式也能搜索~/.my.cnf的参数，可以修改具体的脚本，添加了一个if else判断条件，如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">将脚本/sbin/service的第81行的原始命令：</span><br><span class="line">env -i <span class="attribute">PATH</span>=<span class="string">"<span class="variable">$PATH</span>"</span> <span class="attribute">TERM</span>=<span class="string">"<span class="variable">$TERM</span>"</span> <span class="attribute">SYSTEMCTL_IGNORE_DEPENDENCIES</span>=<span class="variable">$&#123;SYSTEMCTL_IGNORE_DEPENDENCIES&#125;</span> <span class="attribute">SYSTEMCTL_SKIP_REDIRECT</span>=<span class="variable">$&#123;SYSTEMCTL_SKIP_REDIRECT&#125;</span> <span class="string">"<span class="variable">$&#123;SERVICEDIR&#125;</span>/<span class="variable">$&#123;SERVICE&#125;</span>"</span> <span class="variable">$&#123;ACTION&#125;</span> <span class="variable">$&#123;OPTIONS&#125;</span></span><br><span class="line">修改为</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;SERVICE&#125;</span>"</span> = <span class="string">"mysqld"</span> ]; then</span><br><span class="line">      env -i <span class="attribute">PATH</span>=<span class="string">"<span class="variable">$PATH</span>"</span> <span class="attribute">HOME</span>=/home/mysql <span class="attribute">TERM</span>=<span class="string">"<span class="variable">$TERM</span>"</span> <span class="attribute">SYSTEMCTL_IGNORE_DEPENDENCIES</span>=<span class="variable">$&#123;SYSTEMCTL_IGNORE_DEPENDENCIES&#125;</span> <span class="attribute">SYSTEMCTL_SKIP_REDIRECT</span>=$&#123;SYSTEMCTL_SKIP_REDIREC</span><br><span class="line">T&#125; <span class="string">"<span class="variable">$&#123;SERVICEDIR&#125;</span>/<span class="variable">$&#123;SERVICE&#125;</span>"</span> <span class="variable">$&#123;ACTION&#125;</span> <span class="variable">$&#123;OPTIONS&#125;</span></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">      env -i <span class="attribute">PATH</span>=<span class="string">"<span class="variable">$PATH</span>"</span> <span class="attribute">TERM</span>=<span class="string">"<span class="variable">$TERM</span>"</span> <span class="attribute">SYSTEMCTL_IGNORE_DEPENDENCIES</span>=<span class="variable">$&#123;SYSTEMCTL_IGNORE_DEPENDENCIES&#125;</span> <span class="attribute">SYSTEMCTL_SKIP_REDIRECT</span>=<span class="variable">$&#123;SYSTEMCTL_SKIP_REDIRECT&#125;</span> <span class="string">"<span class="variable">$&#123;SERVICEDIR&#125;</span>/<span class="variable">$&#123;SERVICE&#125;</span>"</span> <span class="variable">$&#123;ACTION&#125;</span> <span class="variable">$&#123;OPTIONS&#125;</span></span><br><span class="line">   fi</span><br></pre></td></tr></table></figure></p><p>如下：</p><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/6EF18BE4F04B4EAC860937772527AFBF/56208" alt="image"></p><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/55AABFB711964631877B3132DFB71DBD/56212" alt="image"></p><p>修改后的脚本启动一下测试，查看已经满足需求</p><p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/DDB2AF9783C44EB290A3F38CEB996C1E/56214" alt="image"></p><h3 id="mysqld-multi-start"><a href="#mysqld-multi-start" class="headerlink" title="mysqld_multi start"></a>mysqld_multi start</h3><p>当mysqld_multi方式指定–defaults-file的参数文件时，不加载除默认搜索顺序以外的[mysqld]标签，也可以做下debug，mysqld_multi是perl脚本，可能通过perl -d script的方式进行调试，这里不再展示。</p><h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>通过以上的的测试，得出以下结论<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>默认情况前三种启动方式下，[mysqld]标签以按照<span class="regexp">/etc/</span>my.cnf，<span class="regexp">/etc/</span>mysql<span class="regexp">/my.cnf，/</span>usr<span class="regexp">/local/</span>mysql<span class="regexp">/my.cnf，~/</span>.my.cnf，--defaults-file搜索顺序加载</span><br><span class="line"><span class="number">2.</span>mysqld_mutli启动方式，[mysqldN]标签也是按照<span class="regexp">/etc/</span>my.cnf，<span class="regexp">/etc/</span>mysql<span class="regexp">/my.cnf，/</span>usr<span class="regexp">/local/</span>mysql<span class="regexp">/my.cnf，~/</span>.my.cnf，--defaults-file搜索顺序加载。但是，[mysqld]标签只按照<span class="regexp">/etc/</span>my.cnf，<span class="regexp">/etc/</span>mysql<span class="regexp">/my.cnf，/</span>usr<span class="regexp">/local/</span>mysql<span class="regexp">/my.cnf，~/</span>.my.cnf搜索顺序加载，不加载--defaults-file的配置</span><br><span class="line"><span class="number">3.</span>service mysqld start启动方式，默认不加载~/.my.cnf文件，需要修改脚本才能让其支持搜索</span><br><span class="line"><span class="number">4.</span>当找不到<span class="regexp">/etc/</span>my.cnf，<span class="regexp">/etc/</span>mysql<span class="regexp">/my.cnf，/</span>usr<span class="regexp">/local/</span>mysql<span class="regexp">/my.cnf，~/</span>.my.cnf，--defaults-file的配置时，默认编译的mysql，参数是全部其默认值，数据目录保存在BASEDIR下的data目录。比如，BASEDIR为<span class="regexp">/usr/</span>local<span class="regexp">/mysql，则DATADIR为/</span>usr<span class="regexp">/local/</span>mysql/data，上面没有实验这一项</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;引言&quot;&gt;&lt;a href=&quot;#引言&quot; class=&quot;headerlink&quot; title=&quot;引言&quot;&gt;&lt;/a&gt;引言&lt;/h2&gt;&lt;p&gt;MySQL数据库支持从配置文件中读取启动选项，不用每次启动时在命令行输入，方便管理。很多选项都是以纯文本的形式存在，可以用任何的编辑器打开编
      
    
    </summary>
    
      <category term="MySQL" scheme="https://dwj999.github.io/categories/MySQL/"/>
    
    
      <category term="MySQL" scheme="https://dwj999.github.io/tags/MySQL/"/>
    
  </entry>
  
  <entry>
    <title>MySQL Group Replication初探</title>
    <link href="https://dwj999.github.io/MySQL-Group-Replication%E5%88%9D%E6%8E%A2.html"/>
    <id>https://dwj999.github.io/MySQL-Group-Replication初探.html</id>
    <published>2017-11-28T06:01:23.000Z</published>
    <updated>2020-05-20T03:20:09.375Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>MySQL Group Replication简称MGR，又称MySQL组复制，是MySQL官方于2016年12月12日推出的一个全新的高可用与高扩展的解决方案，首发集成于MySQL5.7.17版本中。MySQL组复制提供了高可用、高扩展、高可靠的MySQL集群服务。高一致性，基于原生复制及paxos协议的组复制技术，并以插件的方式提供，提供一致数据安全保证；高容错性，只要不是大多数节点坏掉就可以继续工作，有自动检测机制，当不同节点产生资源急用冲突时时，不会出现错误，按照先到者优先进行处理，并且内置了自动化脑裂防护机制；高扩展性，节点的新增和移除都是自动的，新节点加入后，会自动从其他节点上同步状态，直到新节点和其他节点保持一致，如果某节点被移除了，其他节点自动更新组信息，自动维护新的组信息；高灵活性，有单主模式和多主模式，单主模式下，会自动选主，所有更新操作都在主上进行；多主模式下，所有server都可以处理更新操作。</p><h2 id="要求和限制"><a href="#要求和限制" class="headerlink" title="要求和限制"></a>要求和限制</h2><h3 id="基础结构"><a href="#基础结构" class="headerlink" title="基础结构"></a>基础结构</h3><ul><li>数据必须存储在InnoDB存储引擎中</li><li>表必须定义一个显式主键</li><li>通信引擎仅支持IPv4</li><li>需要低延迟，高带宽的网络<h3 id="server实例配置"><a href="#server实例配置" class="headerlink" title="server实例配置"></a>server实例配置</h3></li><li>必须开启binlog</li><li>必须开启log-slave-updates</li><li>binlog格式必须为ROW格式</li><li>必须开启GTID模式</li><li>复制相关信息必须使用表存储（–master-info-repository = TABLE/–relay-log-info-repository = TABLE）</li><li>事务写集合必须打开（Transaction write set extraction）</li><li>root用户必须存在(group replication用于检查组用户是否存在)<h3 id="使用限制"><a href="#使用限制" class="headerlink" title="使用限制"></a>使用限制</h3></li><li>不支持binlog的checksum，需要设置–binlog-checksum = NONE</li><li>不支持savepoint</li><li>不支持可串行serializable事务隔离级别</li><li>不支持gap locks</li><li>不支持lock tables,unlock tables</li><li>多主模式下，不支持多节点同时对一个表进行DDL vs DDL/DML</li><li>多主模式下，不支持多级关联外键</li></ul><h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>MySQL组复制是一个MySQL插件，它建立在现有的MySQL复制基础结构上，利用了二进制日志，基于行的日志记录和全局事务标识符等功能。它集成了当前的MySQL框架，如性能模式、插件和服务基础设施等。<br>组复制（Group Replication）基于分布式一致性算法(Paxos协议的变体)实现，一个组允许部分节点挂掉，只要保证绝大多数节点仍然存活并且之间的通讯是没有问题的，那么这个组对外仍然能够提供服务，它是一种被使用在容错系统中的技术。Group Replication（复制组）是由能够相互通信的多个服务器（节点）组成的。在通信层，Group replication实现了一系列的机制：比如原子消息（atomic message delivery）和全序化消息（total ordering of messages）。这些原子化，抽象化的机制，为实现更先进的数据库复制方案提供了强有力的支持。MySQL Group Replication正是基于这些技术和概念，实现了一种多主全更新的复制协议。简而言之，一个Group Replication就是一组节点，每个节点都可以独立执行事务，而读写事务则会在于group内的其他节点进行协调之后再commit。因此，当一个事务准备提交时，会自动在group内进行原子性的广播，告知其他节点变更了什么内容/执行了什么事务。这种原子广播的方式，使得这个事务在每一个节点上都保持着同样顺序。这意味着每一个节点都以同样的顺序，接收到了同样的事务日志，所以每一个节点以同样的顺序重演了这些事务日志，最终整个group保持了完全一致的状态。然而，不同的节点上执行的事务之间有可能存在资源争用。这种现象容易出现在两个不同的并发事务上。假设在不同的节点上有两个并发事务，更新了同一行数据，那么就会发生资源争用。面对这种情况，Group Replication判定先提交的事务为有效事务，会在整个group里面重放，后提交的事务会直接中断，或者回滚，最后丢弃掉。因此，这也是一个无共享的复制方案，每一个节点都保存了完整的数据副本。</p><h2 id="组织结构"><a href="#组织结构" class="headerlink" title="组织结构"></a>组织结构</h2><p><img src="https://dev.mysql.com/doc/refman/5.7/en/images/gr-plugin-blocks.png" alt="image"></p><ul><li>API层 负责完成和MySQL Server的交互，获取server的状态，截获事务提交，干涉事务提交或者回滚。</li><li>组件层 特定功能的组件，Capture负责收集事务执行相关信息，Applier负责应用集群事务到本地，Recovery负责新节点的数据恢复。</li><li>复制层 负责冲突验证，接收和应用集群事务。</li><li>集群通信层 基于Paxos协议的集群通信引擎以及和上层组件的交互接口。</li></ul><h2 id="容错"><a href="#容错" class="headerlink" title="容错"></a>容错</h2><p>MySQL组复制构建在paxos分布式算法实现的基础上，以提供不同server之间的分布式协调。因此，它需要大多数server处于活动状态以达到仲裁成员数，从而做出决定。这对系统可以容忍的不影响其自身及其整体功能的故障数量有直接影响。容忍f个故障所需的server数量(n)为n=2*f+1。<br>在实践中，这意味着为了容忍一个故障，组必须有三个server。因此，如果一个服务器故障，仍然有两个服务器形成大多数(三分之二)来允许系统自动地继续运行。但是，如果第二个server意外地fail掉，则该组(剩下一个server)锁定，因为没有多数可以达成协议。  </p><h3 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h3><table><thead><tr><th>组大小</th><th style="text-align:left">多数</th><th style="text-align:left">允许的即使故障数</th></tr></thead><tbody><tr><td>1</td><td style="text-align:left">1</td><td style="text-align:left">0</td></tr><tr><td>2</td><td style="text-align:left">2</td><td style="text-align:left">0</td></tr><tr><td>3</td><td style="text-align:left">2</td><td style="text-align:left">1</td></tr><tr><td>4</td><td style="text-align:left">3</td><td style="text-align:left">1</td></tr><tr><td>5</td><td style="text-align:left">3</td><td style="text-align:left">2</td></tr><tr><td>6</td><td style="text-align:left">4</td><td style="text-align:left">2</td></tr><tr><td>7</td><td style="text-align:left">4</td><td style="text-align:left">3</td></tr><tr><td>8</td><td style="text-align:left">5</td><td style="text-align:left">3</td></tr><tr><td>9</td><td style="text-align:left">5</td><td style="text-align:left">4</td></tr></tbody></table><h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="在单主模式下部署组复制"><a href="#在单主模式下部署组复制" class="headerlink" title="在单主模式下部署组复制"></a>在单主模式下部署组复制</h3><h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><p>IP：192.168.7.50<br>system：Centos 6.5<br>hostname：jiessie<br>disk：300G ssd<br>memory：8G<br>cpu：4core<br>节点数：3</p><h4 id="二进制安装包下载"><a href="#二进制安装包下载" class="headerlink" title="二进制安装包下载"></a>二进制安装包下载</h4><p>二进制包安装目录：/hwdata/data/mysql5.7.20/base<br>下载地址：<a href="https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz" target="_blank" rel="noopener">https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz</a><br>目录结构：<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/hwdata/data/mysql5.7.20/base</span><br><span class="line">[root@jiessie base]<span class="comment"># ll</span></span><br><span class="line">total 52</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span>7161<span class="number"> 31415 </span>17987 Sep<span class="number"> 13 </span>23:48 COPYING</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span>7161<span class="number"> 31415 </span><span class="number"> 2478 </span>Sep<span class="number"> 13 </span>23:48 README</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span>root root  <span class="number"> 4096 </span>Nov<span class="number"> 29 </span>11:22 bin</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span>root root  <span class="number"> 4096 </span>Nov<span class="number"> 29 </span>11:22 docs</span><br><span class="line">drwxr-xr-x <span class="number"> 3 </span>root root  <span class="number"> 4096 </span>Nov<span class="number"> 29 </span>11:22 include</span><br><span class="line">drwxr-xr-x <span class="number"> 5 </span>root root  <span class="number"> 4096 </span>Nov<span class="number"> 29 </span>11:22 lib</span><br><span class="line">drwxr-xr-x <span class="number"> 4 </span>root root  <span class="number"> 4096 </span>Nov<span class="number"> 29 </span>11:22 man</span><br><span class="line">drwxr-xr-x<span class="number"> 28 </span>root root  <span class="number"> 4096 </span>Nov<span class="number"> 29 </span>11:22 share</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span>root root  <span class="number"> 4096 </span>Nov<span class="number"> 29 </span>11:22 support-files</span><br><span class="line">[root@jiessie base]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p><h4 id="数据目录"><a href="#数据目录" class="headerlink" title="数据目录"></a>数据目录</h4><p>数据目录：/hwdata/data/mysql5.7.20/data<br>三节点的数据，分别存放于data子目录下的s1,s2,s3目录中<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]<span class="comment"># pwd</span></span><br><span class="line">/hwdata/data/mysql5.7.20</span><br><span class="line">[root@jiessie mysql5.7.20]<span class="comment"># mkdir data/&#123;s1,s2,s3&#125;</span></span><br><span class="line">[root@jiessie mysql5.7.20]<span class="comment"># ll data/</span></span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>Nov<span class="number"> 29 </span>17:23 s1</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>Nov<span class="number"> 29 </span>17:23 s2</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>Nov<span class="number"> 29 </span>17:23 s3</span><br><span class="line">[root@jiessie mysql5.7.20]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p><h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>配置文件：/hwdata/data/mysql5.7.20/conf<br>三节点的配置文件，分别是conf目录下的s1.cnf,s2.cnf,s3.cnf<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# ll conf/</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 root root 948 Nov 29 17:35 s1.cnf</span><br><span class="line">-rw-r--r-- 1 root root 948 Nov 29 17:36 s2.cnf</span><br><span class="line">-rw-r--r-- 1 root root 948 Nov 29 17:37 s3.cnf</span><br><span class="line">[root@jiessie mysql5.7.20]# cat conf/s1.cnf </span><br><span class="line">[mysqld]</span><br><span class="line"><span class="attribute">datadir</span>=/hwdata/data/mysql5.7.20/data/s1</span><br><span class="line"><span class="attribute">basedir</span>=/hwdata/data/mysql5.7.20/base</span><br><span class="line"><span class="attribute">port</span>=9001</span><br><span class="line"><span class="attribute">socket</span>=/hwdata/data/mysql5.7.20/data/s1/s1.sock</span><br><span class="line"></span><br><span class="line"><span class="attribute">server_id</span>=1</span><br><span class="line"><span class="attribute">gtid_mode</span>=ON</span><br><span class="line"><span class="attribute">enforce_gtid_consistency</span>=ON</span><br><span class="line"><span class="attribute">master_info_repository</span>=TABLE</span><br><span class="line"><span class="attribute">relay_log_info_repository</span>=TABLE</span><br><span class="line"><span class="attribute">binlog_checksum</span>=NONE</span><br><span class="line"><span class="attribute">log_slave_updates</span>=ON</span><br><span class="line"><span class="attribute">log_bin</span>=binlog</span><br><span class="line"><span class="attribute">binlog_format</span>=ROW</span><br><span class="line"><span class="attribute">innodb_buffer_pool_instances</span>=4</span><br><span class="line"><span class="attribute">innodb_buffer_pool_size</span>=128M</span><br><span class="line"><span class="attribute">innodb_flush_log_at_trx_commit</span>=2</span><br><span class="line"><span class="attribute">sync_binlog</span>=0</span><br><span class="line"><span class="attribute">slave-parallel-type</span>=LOGICAL_CLOCK</span><br><span class="line"><span class="attribute">slave-parallel-workers</span>=4</span><br><span class="line"><span class="attribute">slave_preserve_commit_order</span>=on</span><br><span class="line"><span class="comment">#group replication</span></span><br><span class="line"><span class="attribute">transaction_write_set_extraction</span>=XXHASH64</span><br><span class="line"><span class="attribute">loose-group_replication_group_name</span>=<span class="string">"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"</span></span><br><span class="line"><span class="attribute">loose-group_replication_start_on_boot</span>=off</span><br><span class="line">loose-group_replication_local_address= <span class="string">"127.0.0.1:10011"</span></span><br><span class="line">loose-group_replication_group_seeds= <span class="string">"127.0.0.1:10011,127.0.0.1:10012,127.0.0.1:10013"</span></span><br><span class="line">loose-group_replication_bootstrap_group= off</span><br><span class="line"><span class="attribute">loose-group_replication_single_primary_mode</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">loose-group_replication_ip_whitelist</span>=<span class="string">"127.0.0.1/20,192.168.7.50/20"</span></span><br><span class="line">[root@jiessie mysql5.7.20]# </span><br><span class="line">[root@jiessie mysql5.7.20]# cat conf/s2.cnf </span><br><span class="line">[mysqld]</span><br><span class="line"><span class="attribute">datadir</span>=/hwdata/data/mysql5.7.20/data/s2</span><br><span class="line"><span class="attribute">basedir</span>=/hwdata/data/mysql5.7.20/base</span><br><span class="line"><span class="attribute">port</span>=9002</span><br><span class="line"><span class="attribute">socket</span>=/hwdata/data/mysql5.7.20/data/s2/s2.sock</span><br><span class="line"></span><br><span class="line"><span class="attribute">server_id</span>=2</span><br><span class="line"><span class="attribute">gtid_mode</span>=ON</span><br><span class="line"><span class="attribute">enforce_gtid_consistency</span>=ON</span><br><span class="line"><span class="attribute">master_info_repository</span>=TABLE</span><br><span class="line"><span class="attribute">relay_log_info_repository</span>=TABLE</span><br><span class="line"><span class="attribute">binlog_checksum</span>=NONE</span><br><span class="line"><span class="attribute">log_slave_updates</span>=ON</span><br><span class="line"><span class="attribute">log_bin</span>=binlog</span><br><span class="line"><span class="attribute">binlog_format</span>=ROW</span><br><span class="line"><span class="attribute">innodb_buffer_pool_instances</span>=4</span><br><span class="line"><span class="attribute">innodb_buffer_pool_size</span>=128M</span><br><span class="line"><span class="attribute">innodb_flush_log_at_trx_commit</span>=2</span><br><span class="line"><span class="attribute">sync_binlog</span>=0</span><br><span class="line"><span class="attribute">slave-parallel-type</span>=LOGICAL_CLOCK</span><br><span class="line"><span class="attribute">slave-parallel-workers</span>=4</span><br><span class="line"><span class="attribute">slave_preserve_commit_order</span>=on</span><br><span class="line"><span class="comment">#group replication</span></span><br><span class="line"><span class="attribute">transaction_write_set_extraction</span>=XXHASH64</span><br><span class="line"><span class="attribute">loose-group_replication_group_name</span>=<span class="string">"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"</span></span><br><span class="line"><span class="attribute">loose-group_replication_start_on_boot</span>=off</span><br><span class="line">loose-group_replication_local_address= <span class="string">"127.0.0.1:10012"</span></span><br><span class="line">loose-group_replication_group_seeds= <span class="string">"127.0.0.1:10011,127.0.0.1:10012,127.0.0.1:10013"</span></span><br><span class="line">loose-group_replication_bootstrap_group= off</span><br><span class="line"><span class="attribute">loose-group_replication_single_primary_mode</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">loose-group_replication_ip_whitelist</span>=<span class="string">"127.0.0.1/20,192.168.7.50/20"</span></span><br><span class="line">[root@jiessie mysql5.7.20]# </span><br><span class="line">[root@jiessie mysql5.7.20]# cat conf/s3.cnf </span><br><span class="line">[mysqld]</span><br><span class="line"><span class="attribute">datadir</span>=/hwdata/data/mysql5.7.20/data/s3</span><br><span class="line"><span class="attribute">basedir</span>=/hwdata/data/mysql5.7.20/base</span><br><span class="line"><span class="attribute">port</span>=9003</span><br><span class="line"><span class="attribute">socket</span>=/hwdata/data/mysql5.7.20/data/s3/s3.sock</span><br><span class="line"></span><br><span class="line"><span class="attribute">server_id</span>=3</span><br><span class="line"><span class="attribute">gtid_mode</span>=ON</span><br><span class="line"><span class="attribute">enforce_gtid_consistency</span>=ON</span><br><span class="line"><span class="attribute">master_info_repository</span>=TABLE</span><br><span class="line"><span class="attribute">relay_log_info_repository</span>=TABLE</span><br><span class="line"><span class="attribute">binlog_checksum</span>=NONE</span><br><span class="line"><span class="attribute">log_slave_updates</span>=ON</span><br><span class="line"><span class="attribute">log_bin</span>=binlog</span><br><span class="line"><span class="attribute">binlog_format</span>=ROW</span><br><span class="line"><span class="attribute">innodb_buffer_pool_instances</span>=4</span><br><span class="line"><span class="attribute">innodb_buffer_pool_size</span>=128M</span><br><span class="line"><span class="attribute">innodb_flush_log_at_trx_commit</span>=2</span><br><span class="line"><span class="attribute">sync_binlog</span>=0</span><br><span class="line"><span class="attribute">slave-parallel-type</span>=LOGICAL_CLOCK</span><br><span class="line"><span class="attribute">slave-parallel-workers</span>=4</span><br><span class="line"><span class="attribute">slave_preserve_commit_order</span>=on</span><br><span class="line"><span class="comment">#group replication</span></span><br><span class="line"><span class="attribute">transaction_write_set_extraction</span>=XXHASH64</span><br><span class="line"><span class="attribute">loose-group_replication_group_name</span>=<span class="string">"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"</span></span><br><span class="line"><span class="attribute">loose-group_replication_start_on_boot</span>=off</span><br><span class="line">loose-group_replication_local_address= <span class="string">"127.0.0.1:10013"</span></span><br><span class="line">loose-group_replication_group_seeds= <span class="string">"127.0.0.1:10011,127.0.0.1:10012,127.0.0.1:10013"</span></span><br><span class="line">loose-group_replication_bootstrap_group= off</span><br><span class="line"><span class="attribute">loose-group_replication_single_primary_mode</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">loose-group_replication_ip_whitelist</span>=<span class="string">"127.0.0.1/20,192.168.7.50/20"</span></span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure></p><ol><li>三节点中配置不一致的参数有以下：  </li></ol><ul><li>datadir     #数据目录  </li><li>port        #服务端口  </li><li>socket      #socket位置  </li><li>server_id   #服务器标识  </li><li>group_replication_local_address #组复制的本地地址</li></ul><ol start="2"><li>组复制相关参数：  </li></ol><ul><li>transaction_write_set_extraction            #指示Server必须为每个事务收集写集合，并使用指定算法将其编码为散列  </li><li>loose-group_replication_group_name          #组复制名称  </li><li>loose-group_replication_start_on_boot       #server启动时是否自动启动组复制  </li><li>loose-group_replication_local_address       #绑定的ip和端口接受其他组成员的连接  </li><li>loose-group_replication_group_seeds         #本行为告诉服务器当服务器加入组时，应当连接到此列表的这些种子服务器进行配置。本设置可以不是全部的组成员地址  </li><li>loose-group_replication_bootstrap_group     #配置是否自动启动引导组</li><li>loose-group_replication_single_primary_mode #配置单主还是多主模式</li><li>loose-group_replication_ip_whitelist        #默认情况下只允许127.0.0.1连接到复制组，如果是其他IP则需要配置  </li></ul><ol start="3"><li>开启并行复制</li></ol><ul><li>set global slave_parallel_type = ‘LOGICAL_CLOCK’;</li><li>set global slave_parallel_workers = N;</li><li>set global slave_preserve_commit_order = ON;<br>这三个参数可以开启并行复制，实践中没有配置，特此提示。<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4>使用mysqld分别对s1,s2,s3进行初始化：  </li><li>base/bin/mysqld –initialize-insecure –basedir=/hwdata/data/mysql5.7.20/base –datadir=/hwdata/data/mysql5.7.20/data/s1</li><li>base/bin/mysqld –initialize-insecure –basedir=/hwdata/data/mysql5.7.20/base –datadir=/hwdata/data/mysql5.7.20/data/s2</li><li>base/bin/mysqld –initialize-insecure –basedir=/hwdata/data/mysql5.7.20/base –datadir=/hwdata/data/mysql5.7.20/data/s3<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# base/bin/mysqld <span class="comment">--initialize-insecure --basedir=/hwdata/data/mysql5.7.20/base --datadir=/hwdata/data/mysql5.7.20/data/s1                   </span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">55</span>:<span class="number">56.436002</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] TIMESTAMP <span class="keyword">with</span> implicit <span class="keyword">DEFAULT</span> value <span class="keyword">is</span> deprecated. Please <span class="keyword">use</span> <span class="comment">--explicit_defaults_for_timestamp server option (see documentation for more details).</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">55</span>:<span class="number">57.095836</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] InnoDB: <span class="keyword">New</span> log files created, LSN=<span class="number">45790</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">55</span>:<span class="number">57.216615</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">55</span>:<span class="number">57.284024</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] No existing UUID has been found, so we <span class="keyword">assume</span> that this <span class="keyword">is</span> the first <span class="built_in">time</span> that this server has been started. Generating a <span class="keyword">new</span> UUID: c0acc2c7-d58a-<span class="number">11e7</span>-b59f-<span class="number">00163e00</span>dc49.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">55</span>:<span class="number">57.287290</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] Gtid table <span class="keyword">is</span> <span class="keyword">not</span> ready <span class="keyword">to</span> be used. Table <span class="symbol">'mysql</span>.gtid_executed' cannot be opened.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">55</span>:<span class="number">57.287678</span>Z <span class="number">1</span> [<span class="literal">Warning</span>] root@localhost <span class="keyword">is</span> created <span class="keyword">with</span> an empty password ! Please consider switching off the <span class="comment">--initialize-insecure option.</span></span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# </span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# base/bin/mysqld <span class="comment">--initialize-insecure --basedir=/hwdata/data/mysql5.7.20/base --datadir=/hwdata/data/mysql5.7.20/data/s2</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">20.520937</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] TIMESTAMP <span class="keyword">with</span> implicit <span class="keyword">DEFAULT</span> value <span class="keyword">is</span> deprecated. Please <span class="keyword">use</span> <span class="comment">--explicit_defaults_for_timestamp server option (see documentation for more details).</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">21.152584</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] InnoDB: <span class="keyword">New</span> log files created, LSN=<span class="number">45790</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">21.278863</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">21.349754</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] No existing UUID has been found, so we <span class="keyword">assume</span> that this <span class="keyword">is</span> the first <span class="built_in">time</span> that this server has been started. Generating a <span class="keyword">new</span> UUID: cf04e66c-d58a-<span class="number">11e7</span>-b97e-<span class="number">00163e00</span>dc49.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">21.352655</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] Gtid table <span class="keyword">is</span> <span class="keyword">not</span> ready <span class="keyword">to</span> be used. Table <span class="symbol">'mysql</span>.gtid_executed' cannot be opened.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">21.353069</span>Z <span class="number">1</span> [<span class="literal">Warning</span>] root@localhost <span class="keyword">is</span> created <span class="keyword">with</span> an empty password ! Please consider switching off the <span class="comment">--initialize-insecure option.</span></span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# </span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# base/bin/mysqld <span class="comment">--initialize-insecure --basedir=/hwdata/data/mysql5.7.20/base --datadir=/hwdata/data/mysql5.7.20/data/s3</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">28.986804</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] TIMESTAMP <span class="keyword">with</span> implicit <span class="keyword">DEFAULT</span> value <span class="keyword">is</span> deprecated. Please <span class="keyword">use</span> <span class="comment">--explicit_defaults_for_timestamp server option (see documentation for more details).</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">29.712932</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] InnoDB: <span class="keyword">New</span> log files created, LSN=<span class="number">45790</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">29.902130</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">29.970877</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] No existing UUID has been found, so we <span class="keyword">assume</span> that this <span class="keyword">is</span> the first <span class="built_in">time</span> that this server has been started. Generating a <span class="keyword">new</span> UUID: d4286108-d58a-<span class="number">11e7</span>-<span class="number">807</span>d-<span class="number">00163e00</span>dc49.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">29.973699</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] Gtid table <span class="keyword">is</span> <span class="keyword">not</span> ready <span class="keyword">to</span> be used. Table <span class="symbol">'mysql</span>.gtid_executed' cannot be opened.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">29.974087</span>Z <span class="number">1</span> [<span class="literal">Warning</span>] root@localhost <span class="keyword">is</span> created <span class="keyword">with</span> an empty password ! Please consider switching off the <span class="comment">--initialize-insecure option.</span></span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# tree -L <span class="number">2</span> data/ </span><br><span class="line">data/</span><br><span class="line">|<span class="comment">-- s1</span></span><br><span class="line">|   |<span class="comment">-- auto.cnf</span></span><br><span class="line">|   |<span class="comment">-- ib_buffer_pool</span></span><br><span class="line">|   |<span class="comment">-- ib_logfile0</span></span><br><span class="line">|   |<span class="comment">-- ib_logfile1</span></span><br><span class="line">|   |<span class="comment">-- ibdata1</span></span><br><span class="line">|   |<span class="comment">-- mysql</span></span><br><span class="line">|   |<span class="comment">-- performance_schema</span></span><br><span class="line">|   `<span class="comment">-- sys</span></span><br><span class="line">|<span class="comment">-- s2</span></span><br><span class="line">|   |<span class="comment">-- auto.cnf</span></span><br><span class="line">|   |<span class="comment">-- ib_buffer_pool</span></span><br><span class="line">|   |<span class="comment">-- ib_logfile0</span></span><br><span class="line">|   |<span class="comment">-- ib_logfile1</span></span><br><span class="line">|   |<span class="comment">-- ibdata1</span></span><br><span class="line">|   |<span class="comment">-- mysql</span></span><br><span class="line">|   |<span class="comment">-- performance_schema</span></span><br><span class="line">|   `<span class="comment">-- sys</span></span><br><span class="line">`<span class="comment">-- s3</span></span><br><span class="line">    |<span class="comment">-- auto.cnf</span></span><br><span class="line">    |<span class="comment">-- ib_buffer_pool</span></span><br><span class="line">    |<span class="comment">-- ib_logfile0</span></span><br><span class="line">    |<span class="comment">-- ib_logfile1</span></span><br><span class="line">    |<span class="comment">-- ibdata1</span></span><br><span class="line">    |<span class="comment">-- mysql</span></span><br><span class="line">    |<span class="comment">-- performance_schema</span></span><br><span class="line">    `<span class="comment">-- sys</span></span><br><span class="line"></span><br><span class="line"><span class="number">12</span> directories, <span class="number">15</span> files</span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]#</span><br></pre></td></tr></table></figure></li></ul><h4 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h4><p>添加权限：chown -R mysql:mysql /hwdata/data/mysql5.7.20/data/<br>分别启动三个节点数据库：</p><ul><li>base/bin/mysqld_safe –defaults-file=/hwdata/data/mysql5.7.20/conf/s1.cnf &amp;</li><li>base/bin/mysqld_safe –defaults-file=/hwdata/data/mysql5.7.20/conf/s2.cnf &amp;</li><li>base/bin/mysqld_safe –defaults-file=/hwdata/data/mysql5.7.20/conf/s3.cnf &amp;<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# base/bin/mysqld_safe --defaults-file=/hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/conf/s1.cnf &amp;</span><br><span class="line">[<span class="number">1</span>] <span class="number">25168</span></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# Logging to <span class="string">'/hwdata/data/mysql5.7.20/data/s1/jiessie.err'</span>.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-30T05:<span class="number">06</span>:<span class="number">34.</span>402042Z mysqld_safe Starting mysqld daemon with databases from /hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/data/s1</span><br><span class="line"></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# base/bin/mysqld_safe --defaults-file=/hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/conf/s2.cnf &amp;   </span><br><span class="line">[<span class="number">2</span>] <span class="number">25681</span></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# Logging to <span class="string">'/hwdata/data/mysql5.7.20/data/s2/jiessie.err'</span>.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-30T05:<span class="number">06</span>:<span class="number">48.</span>204177Z mysqld_safe Starting mysqld daemon with databases from /hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/data/s2</span><br><span class="line"></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# base/bin/mysqld_safe --defaults-file=/hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/conf/s3.cnf &amp; </span><br><span class="line">[<span class="number">3</span>] <span class="number">26193</span></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# Logging to <span class="string">'/hwdata/data/mysql5.7.20/data/s3/jiessie.err'</span>.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-30T05:<span class="number">06</span>:<span class="number">59.</span>779426Z mysqld_safe Starting mysqld daemon with databases from /hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/data/s3</span><br><span class="line"></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]#</span><br></pre></td></tr></table></figure></li></ul><p>查看进程:<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# netstat -tunlp|grep mysql </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">9001</span>                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">25609</span>/mysqld        </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">9002</span>                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">26122</span>/mysqld        </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">9003</span>                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">26634</span>/mysqld        </span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]#</span><br></pre></td></tr></table></figure></p><h4 id="添加复制用户"><a href="#添加复制用户" class="headerlink" title="添加复制用户"></a>添加复制用户</h4><p>创建具有replication slave权限的MySQL用户,此操作不应记录到二进制中,以避免将更改传递到其他slave实例.<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# base/bin/mysql -uroot -S /hwdata/data/mysql5.<span class="number">7.20</span>/data/s1/s1.sock</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">3</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">20</span>-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">SET</span> SQL_LOG_BIN=<span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">CREATE</span> USER rpl_user@<span class="string">'%'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE <span class="keyword">ON</span> *.* <span class="keyword">TO</span> rpl_user@<span class="string">'%'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'rpl_pass'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">SET</span> SQL_LOG_BIN=<span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CHANGE MASTER <span class="keyword">TO</span> MASTER_USER=<span class="string">'rpl_user'</span>, MASTER_PASSWORD=<span class="string">'rpl_pass'</span> <span class="keyword">FOR</span> CHANNEL <span class="string">'group_replication_recovery'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">2</span> warnings (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# base/bin/mysql -uroot -S /hwdata/data/mysql5.<span class="number">7.20</span>/data/s2/s2.sock     </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">3</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">20</span>-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">SET</span> SQL_LOG_BIN=<span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">CREATE</span> USER rpl_user@<span class="string">'%'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE <span class="keyword">ON</span> *.* <span class="keyword">TO</span> rpl_user@<span class="string">'%'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'rpl_pass'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">SET</span> SQL_LOG_BIN=<span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CHANGE MASTER <span class="keyword">TO</span> MASTER_USER=<span class="string">'rpl_user'</span>, MASTER_PASSWORD=<span class="string">'rpl_pass'</span> <span class="keyword">FOR</span> CHANNEL <span class="string">'group_replication_recovery'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">2</span> warnings (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# base/bin/mysql -uroot -S /hwdata/data/mysql5.<span class="number">7.20</span>/data/s3/s3.sock   </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">3</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">20</span>-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">SET</span> SQL_LOG_BIN=<span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">CREATE</span> USER rpl_user@<span class="string">'%'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE <span class="keyword">ON</span> *.* <span class="keyword">TO</span> rpl_user@<span class="string">'%'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'rpl_pass'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">SET</span> SQL_LOG_BIN=<span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CHANGE MASTER <span class="keyword">TO</span> MASTER_USER=<span class="string">'rpl_user'</span>, MASTER_PASSWORD=<span class="string">'rpl_pass'</span> <span class="keyword">FOR</span> CHANNEL <span class="string">'group_replication_recovery'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">2</span> warnings (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]#</span><br></pre></td></tr></table></figure></p><h4 id="启动组复制"><a href="#启动组复制" class="headerlink" title="启动组复制"></a>启动组复制</h4><p>配置并启动s1后,安装组复制插件,然后连接到server并执行以下命令.  </p><p><font color="#FF0000">注意:<br>创建一个Group Replication,需要在一个节点初始化,也只需要在一个节点初始化,不可在多个节点都执行.</font><br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock</span></span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 4</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; INSTALL PLUGIN group_replication SONAME 'group_replication.so';</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show plugins;</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">|<span class="string"> Name                       </span>|<span class="string"> Status   </span>|<span class="string"> Type               </span>|<span class="string"> Library              </span>|<span class="string"> License </span>|</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">|<span class="string"> binlog                     </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> mysql_native_password      </span>|<span class="string"> ACTIVE   </span>|<span class="string"> AUTHENTICATION     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> sha256_password            </span>|<span class="string"> ACTIVE   </span>|<span class="string"> AUTHENTICATION     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> PERFORMANCE_SCHEMA         </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> MRG_MYISAM                 </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> MEMORY                     </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> InnoDB                     </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_TRX                 </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_LOCKS               </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_LOCK_WAITS          </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_CMP                 </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_CMP_RESET           </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_CMPMEM              </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_CMPMEM_RESET        </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_CMP_PER_INDEX       </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_CMP_PER_INDEX_RESET </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_BUFFER_PAGE         </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_BUFFER_PAGE_LRU     </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_BUFFER_POOL_STATS   </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_TEMP_TABLE_INFO     </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_METRICS             </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_FT_DEFAULT_STOPWORD </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_FT_DELETED          </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_FT_BEING_DELETED    </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_FT_CONFIG           </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_FT_INDEX_CACHE      </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_FT_INDEX_TABLE      </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_TABLES          </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_TABLESTATS      </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_INDEXES         </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_COLUMNS         </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_FIELDS          </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_FOREIGN         </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_FOREIGN_COLS    </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_TABLESPACES     </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_DATAFILES       </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_VIRTUAL         </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> CSV                        </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> MyISAM                     </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> ARCHIVE                    </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> partition                  </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> BLACKHOLE                  </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> FEDERATED                  </span>|<span class="string"> DISABLED </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> ngram                      </span>|<span class="string"> ACTIVE   </span>|<span class="string"> FTPARSER           </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> group_replication          </span>|<span class="string"> ACTIVE   </span>|<span class="string"> GROUP REPLICATION  </span>|<span class="string"> group_replication.so </span>|<span class="string"> GPL     </span>|</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">45 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group=ON;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br><span class="line">Query OK, 0 rows affected (3.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group=OFF;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT <span class="symbol">*</span> FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">|<span class="string"> CHANNEL_NAME              </span>|<span class="string"> MEMBER_ID                            </span>|<span class="string"> MEMBER_HOST </span>|<span class="string"> MEMBER_PORT </span>|<span class="string"> MEMBER_STATE </span>|</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">|<span class="string"> group_replication_applier </span>|<span class="string"> c0acc2c7-d58a-11e7-b59f-00163e00dc49 </span>|<span class="string"> jiessie     </span>|<span class="string">        9001 </span>|<span class="string"> ONLINE       </span>|</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p><h4 id="添加其他组复制节点"><a href="#添加其他组复制节点" class="headerlink" title="添加其他组复制节点"></a>添加其他组复制节点</h4><p>在其他2个节点上开启组复制<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5<span class="number">.7</span><span class="number">.20</span>]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock</span></span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">4</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.20</span>-<span class="built_in">log</span> MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; INSTALL PLUGIN group_replication SONAME 'group_replication.so';</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">6.57</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5<span class="number">.7</span><span class="number">.20</span>]<span class="comment">#  base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock</span></span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">4</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.20</span>-<span class="built_in">log</span> MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; INSTALL PLUGIN group_replication SONAME 'group_replication.so';</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">3.27</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5<span class="number">.7</span><span class="number">.20</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p><h4 id="测试数据同步"><a href="#测试数据同步" class="headerlink" title="测试数据同步"></a>测试数据同步</h4><p>在s1节点上插入数据，在其他节点上查看数据是否同步及binlog详情</p><ol><li><p>刷新flush logs</p><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e "flush logs;show binary logs;"                                  <span class="code">+---------------+</span>-----------+</span><br><span class="line">| Log<span class="emphasis">_name      | File_</span>size |</span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">| binlog.000001 |      1101 |</span><br><span class="line">| binlog.000002 |      1162 |</span><br><span class="line">| binlog.000003 |      2329 |</span><br><span class="line">| binlog.000004 |       230 |</span><br><span class="line">| binlog.000005 |      1017 |</span><br><span class="line">| binlog.000006 |       190 |</span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock -e "flush logs;show binary logs;"  </span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">| Log<span class="emphasis">_name      | File_</span>size |</span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">| binlog.000001 |       169 |</span><br><span class="line">| binlog.000002 |      2054 |</span><br><span class="line">| binlog.000003 |      3106 |</span><br><span class="line">| binlog.000004 |       190 |</span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock -e "flush logs;show binary logs;"  </span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">| Log<span class="emphasis">_name      | File_</span>size |</span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">| binlog.000001 |       169 |</span><br><span class="line">| binlog.000002 |       150 |</span><br><span class="line">| binlog.000003 |      4970 |</span><br><span class="line">| binlog.000004 |       190 |</span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure></li><li><p>节点1插入数据</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e "create database if not exists test;create table test.t1(id int unsigned not null auto_increment primary key,name varchar(20))"           </span></span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e "desc test.t1;select * from test.t1"    </span></span><br><span class="line">+-------+------------------+------+-----+---------+----------------+</span><br><span class="line">|<span class="string"> Field </span>|<span class="string"> Type             </span>|<span class="string"> Null </span>|<span class="string"> Key </span>|<span class="string"> Default </span>|<span class="string"> Extra          </span>|</span><br><span class="line">+-------+------------------+------+-----+---------+----------------+</span><br><span class="line">|<span class="string"> id    </span>|<span class="string"> int(10) unsigned </span>|<span class="string"> NO   </span>|<span class="string"> PRI </span>|<span class="string"> NULL    </span>|<span class="string"> auto_increment </span>|</span><br><span class="line">|<span class="string"> name  </span>|<span class="string"> varchar(20)      </span>|<span class="string"> YES  </span>|<span class="string">     </span>|<span class="string"> NULL    </span>|<span class="string">                </span>|</span><br><span class="line">+-------+------------------+------+-----+---------+----------------+</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e "insert into test.t1 values(null,'111')"</span></span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e "select * from test.t1"</span></span><br><span class="line">+----+------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> name </span>|</span><br><span class="line">+----+------+</span><br><span class="line">|<span class="string">  1 </span>|<span class="string"> 111  </span>|</span><br><span class="line">+----+------+</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e "show binlog events in 'binlog.000006'" </span></span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> Log_name      </span>|<span class="string"> Pos </span>|<span class="string"> Event_type     </span>|<span class="string"> Server_id </span>|<span class="string"> End_log_pos </span>|<span class="string"> Info                                                                                       </span>|</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string">   4 </span>|<span class="string"> Format_desc    </span>|<span class="string">         1 </span>|<span class="string">         123 </span>|<span class="string"> Server ver: 5.7.20-log, Binlog ver: 4                                                      </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 123 </span>|<span class="string"> Previous_gtids </span>|<span class="string">         1 </span>|<span class="string">         190 </span>|<span class="string"> aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-19                                                  </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 190 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         251 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:20'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 251 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         360 </span>|<span class="string"> create database if not exists test                                                         </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 360 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         421 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:21'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 421 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         582 </span>|<span class="string"> create table test.t1(id int unsigned not null auto_increment primary key,name varchar(20)) </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 582 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         643 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:22'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 643 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         712 </span>|<span class="string"> BEGIN                                                                                      </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 712 </span>|<span class="string"> Table_map      </span>|<span class="string">         1 </span>|<span class="string">         756 </span>|<span class="string"> table_id: 223 (test.t1)                                                                    </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 756 </span>|<span class="string"> Write_rows     </span>|<span class="string">         1 </span>|<span class="string">         796 </span>|<span class="string"> table_id: 223 flags: STMT_END_F                                                            </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 796 </span>|<span class="string"> Xid            </span>|<span class="string">         1 </span>|<span class="string">         823 </span>|<span class="string"> COMMIT /* xid=151 */                                                                       </span>|</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li><li><p>其他节点查看数据</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock -e "show binlog events in 'binlog.000004'"   </span></span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> Log_name      </span>|<span class="string"> Pos </span>|<span class="string"> Event_type     </span>|<span class="string"> Server_id </span>|<span class="string"> End_log_pos </span>|<span class="string"> Info                                                                                       </span>|</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string">   4 </span>|<span class="string"> Format_desc    </span>|<span class="string">         2 </span>|<span class="string">         123 </span>|<span class="string"> Server ver: 5.7.20-log, Binlog ver: 4                                                      </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 123 </span>|<span class="string"> Previous_gtids </span>|<span class="string">         2 </span>|<span class="string">         190 </span>|<span class="string"> aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-19                                                  </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 190 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         251 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:20'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 251 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         360 </span>|<span class="string"> create database if not exists test                                                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 360 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         421 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:21'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 421 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         582 </span>|<span class="string"> create table test.t1(id int unsigned not null auto_increment primary key,name varchar(20)) </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 582 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         643 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:22'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 643 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         707 </span>|<span class="string"> BEGIN                                                                                      </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 707 </span>|<span class="string"> Table_map      </span>|<span class="string">         1 </span>|<span class="string">         751 </span>|<span class="string"> table_id: 221 (test.t1)                                                                    </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 751 </span>|<span class="string"> Write_rows     </span>|<span class="string">         1 </span>|<span class="string">         791 </span>|<span class="string"> table_id: 221 flags: STMT_END_F                                                            </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 791 </span>|<span class="string"> Xid            </span>|<span class="string">         1 </span>|<span class="string">         818 </span>|<span class="string"> COMMIT /* xid=71 */                                                                        </span>|</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock -e "show binlog events in 'binlog.000004'"  </span></span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> Log_name      </span>|<span class="string"> Pos </span>|<span class="string"> Event_type     </span>|<span class="string"> Server_id </span>|<span class="string"> End_log_pos </span>|<span class="string"> Info                                                                                       </span>|</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string">   4 </span>|<span class="string"> Format_desc    </span>|<span class="string">         3 </span>|<span class="string">         123 </span>|<span class="string"> Server ver: 5.7.20-log, Binlog ver: 4                                                      </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 123 </span>|<span class="string"> Previous_gtids </span>|<span class="string">         3 </span>|<span class="string">         190 </span>|<span class="string"> aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-19                                                  </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 190 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         251 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:20'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 251 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         360 </span>|<span class="string"> create database if not exists test                                                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 360 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         421 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:21'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 421 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         582 </span>|<span class="string"> create table test.t1(id int unsigned not null auto_increment primary key,name varchar(20)) </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 582 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         643 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:22'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 643 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         707 </span>|<span class="string"> BEGIN                                                                                      </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 707 </span>|<span class="string"> Table_map      </span>|<span class="string">         1 </span>|<span class="string">         751 </span>|<span class="string"> table_id: 221 (test.t1)                                                                    </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 751 </span>|<span class="string"> Write_rows     </span>|<span class="string">         1 </span>|<span class="string">         791 </span>|<span class="string"> table_id: 221 flags: STMT_END_F                                                            </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 791 </span>|<span class="string"> Xid            </span>|<span class="string">         1 </span>|<span class="string">         818 </span>|<span class="string"> COMMIT /* xid=58 */                                                                        </span>|</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock -e "select * from test.t1"                  </span></span><br><span class="line">+----+------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> name </span>|</span><br><span class="line">+----+------+</span><br><span class="line">|<span class="string">  1 </span>|<span class="string"> 111  </span>|</span><br><span class="line">+----+------+</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock -e "select * from test.t1"  </span></span><br><span class="line">+----+------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> name </span>|</span><br><span class="line">+----+------+</span><br><span class="line">|<span class="string">  1 </span>|<span class="string"> 111  </span>|</span><br><span class="line">+----+------+</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment">#</span></span><br></pre></td></tr></table></figure></li></ol><h4 id="节点状态查询"><a href="#节点状态查询" class="headerlink" title="节点状态查询"></a>节点状态查询</h4><p><font color="#FF0000">注意：</font><br>主机名和/etc/hosts中的信息要保持一致，否则可能会报<font color="#FF0000">“There was an error when connecting to the donor server. Please check that group_replication_r<br>ecovery channel credentials and all MEMBER_HOST column values of performance_schema.replication_group_members table are correct and DNS resolvable.”</font><br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance<span class="emphasis">_schema.replication_</span>group<span class="emphasis">_members;</span></span><br><span class="line"><span class="emphasis">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span></span><br><span class="line"><span class="emphasis">| CHANNEL_</span>NAME              | MEMBER<span class="emphasis">_ID                            | MEMBER_</span>HOST | MEMBER<span class="emphasis">_PORT | MEMBER_</span>STATE |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure></p><h3 id="监控组复制"><a href="#监控组复制" class="headerlink" title="监控组复制"></a>监控组复制</h3><p>假设MySQL已经在启用了性能模式的情况下编译，使用performance_schema表监控组复制</p><h4 id="replication-group-member-stats"><a href="#replication-group-member-stats" class="headerlink" title="replication_group_member_stats"></a>replication_group_member_stats</h4><p>复制组中的每个成员都会验证并应用该组提交的事务,有关验证和应用程序的统计信息对于了解申请队列增长情况,触发了多少冲突,检查了多少事务,哪些事务已被所有成员提交等非常有用,performance_shcema.replication_group_member_stats提供与认证过程相关的以下信息<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from performance<span class="emphasis">_schema.replication_</span>group<span class="emphasis">_member_</span>stats;</span><br><span class="line"><span class="code">+---------------------------+</span>---------------------<span class="code">+--------------------------------------+</span>-----------------------------<span class="code">+----------------------------+</span>--------------------------<span class="code">+------------------------------------+</span>-------------------------------------------<span class="code">+-----------------------------------------+</span></span><br><span class="line">| CHANNEL<span class="emphasis">_NAME              | VIEW_</span>ID             | MEMBER<span class="emphasis">_ID                            | COUNT_</span>TRANSACTIONS<span class="emphasis">_IN_</span>QUEUE | COUNT<span class="emphasis">_TRANSACTIONS_</span>CHECKED | COUNT<span class="emphasis">_CONFLICTS_</span>DETECTED | COUNT<span class="emphasis">_TRANSACTIONS_</span>ROWS<span class="emphasis">_VALIDATING | TRANSACTIONS_</span>COMMITTED<span class="emphasis">_ALL_</span>MEMBERS        | LAST<span class="emphasis">_CONFLICT_</span>FREE<span class="emphasis">_TRANSACTION          |</span></span><br><span class="line"><span class="emphasis">+---------------------------+---------------------+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+-------------------------------------------+-----------------------------------------+</span></span><br><span class="line"><span class="emphasis">| group_</span>replication<span class="emphasis">_applier | 15120910223421577:3 | c0acc2c7-d58a-11e7-b59f-00163e00dc49 |                           0 |                         13 |                        0 |                                  0 | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-22 | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:22 |</span></span><br><span class="line"><span class="emphasis">+---------------------------+---------------------+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+-------------------------------------------+-----------------------------------------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br></pre></td></tr></table></figure></p><h5 id="参数解释"><a href="#参数解释" class="headerlink" title="参数解释"></a>参数解释</h5><table><thead><tr><th>Field</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td>CHANNEL_NAME</td><td style="text-align:left">组复制通道的名称</td></tr><tr><td>VIEW_ID</td><td style="text-align:left">组复制当前视图标识符</td></tr><tr><td>MEMBER_ID</td><td style="text-align:left">当前连接到server成员的UUID,组中的每个成员具有不同的值</td></tr><tr><td>COUNT_TRANSACTIONS_IN_QUEUE</td><td style="text-align:left">队列中等待冲突检测检查的事务数,冲突检查通过后,他们排队等待应用</td></tr><tr><td>COUNT_TRANSACTIONS_CHECKED</td><td style="text-align:left">已进行过冲突检查的事务数</td></tr><tr><td>COUNT_CONFLICTS_DETECTED</td><td style="text-align:left">未通过冲突检查的事务数</td></tr><tr><td>COUNT_TRANSACTIONS_ROWS_VALIDATING</td><td style="text-align:left">可用于认证的事务行的数量，但没有被垃圾收集</td></tr><tr><td>TRANSACTIONS_COMMITTED_ALL_MEMBERS</td><td style="text-align:left">当前视图的所有成员成功提交的事务,此值为固定的时间间隔更新</td></tr><tr><td>LAST_CONFLICT_FREE_TRANSACTION</td><td style="text-align:left">最后一个经检查无冲突的事务标识符</td></tr></tbody></table><h4 id="replication-group-members"><a href="#replication-group-members" class="headerlink" title="replication_group_members"></a>replication_group_members</h4><p>用于监控在当前视图中的不同server实例的状态<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance<span class="emphasis">_schema.replication_</span>group<span class="emphasis">_members;</span></span><br><span class="line"><span class="emphasis">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span></span><br><span class="line"><span class="emphasis">| CHANNEL_</span>NAME              | MEMBER<span class="emphasis">_ID                            | MEMBER_</span>HOST | MEMBER<span class="emphasis">_PORT | MEMBER_</span>STATE |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><h5 id="参数解释-1"><a href="#参数解释-1" class="headerlink" title="参数解释"></a>参数解释</h5><table><thead><tr><th>Field</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td>CHANNEL_NAME</td><td style="text-align:left">组复制通道的名称</td></tr><tr><td>MEMBER_ID</td><td style="text-align:left">server成员的UUID</td></tr><tr><td>MEMBER_HOST</td><td style="text-align:left">组成员的网络地址</td></tr><tr><td>MEMBER_PORT</td><td style="text-align:left">侦听此成员的MySQL连接端口</td></tr><tr><td>MEMBER_STATE</td><td style="text-align:left">组成员的状态</td></tr></tbody></table><h4 id="replication-connection-status"><a href="#replication-connection-status" class="headerlink" title="replication_connection_status"></a>replication_connection_status</h4><p>此表显示处理从服务器连接主服务器的IO线程的当前状态<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from performance_schema.replication_connection_status;</span><br><span class="line">+<span class="params">---------------------------</span>+<span class="params">--------------------------------------</span>+<span class="params">--------------------------------------</span>+<span class="params">-----------</span>+<span class="params">---------------</span>+<span class="params">---------------------------</span>+<span class="params">--------------------------</span>+<span class="params">-------------------------------------------</span>+<span class="params">-------------------</span>+<span class="params">--------------------</span>+<span class="params">----------------------</span>+</span><br><span class="line">| CHANNEL_NAME              | GROUP_NAME                           | SOURCE_UUID                          | THREAD_ID | SERVICE_STATE | COUNT_RECEIVED_HEARTBEATS | LAST_HEARTBEAT_TIMESTAMP | RECEIVED_TRANSACTION_SET                  | LAST_ERROR_NUMBER | LAST_ERROR_MESSAGE | LAST_ERROR_TIMESTAMP |</span><br><span class="line">+<span class="params">---------------------------</span>+<span class="params">--------------------------------------</span>+<span class="params">--------------------------------------</span>+<span class="params">-----------</span>+<span class="params">---------------</span>+<span class="params">---------------------------</span>+<span class="params">--------------------------</span>+<span class="params">-------------------------------------------</span>+<span class="params">-------------------</span>+<span class="params">--------------------</span>+<span class="params">----------------------</span>+</span><br><span class="line">| group_replication_applier | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa |      NULL | ON            |                         0 | 0000-00-00 00<span class="function">:00</span><span class="function">:00</span>      | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa<span class="function">:1-22</span> |                 0 |                    | 0000-00-00 00<span class="function">:00</span><span class="function">:00</span>  |</span><br><span class="line">+<span class="params">---------------------------</span>+<span class="params">--------------------------------------</span>+<span class="params">--------------------------------------</span>+<span class="params">-----------</span>+<span class="params">---------------</span>+<span class="params">---------------------------</span>+<span class="params">--------------------------</span>+<span class="params">-------------------------------------------</span>+<span class="params">-------------------</span>+<span class="params">--------------------</span>+<span class="params">----------------------</span>+</span><br><span class="line">1 row in <span class="keyword">set</span> <span class="params">(0.00 sec)</span></span><br></pre></td></tr></table></figure></p><h5 id="参数解释-2"><a href="#参数解释-2" class="headerlink" title="参数解释"></a>参数解释</h5><table><thead><tr><th>Field</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td>CHANNEL_NAME</td><td style="text-align:left">组复制通道的名称</td></tr><tr><td>GROUP_NAME</td><td style="text-align:left">如果此服务器是组的成员，则显示服务器所属的组的名称</td></tr><tr><td>SOURCE_UUID</td><td style="text-align:left">组的标识符,类似组名称,被用作组复制期间生成的所有事务的UUID</td></tr><tr><td>THREAD_ID</td><td style="text-align:left">IO线程ID</td></tr><tr><td>SERVICE_STATE</td><td style="text-align:left">IO状态,ON（线程存在并处于活动状态或空闲状态）,OFF（线程不再存在）或CONNECTING（线程存在并连接到主控制器）</td></tr><tr><td>COUNT_RECEIVED_HEARTBEATS</td><td style="text-align:left">从上次重新启动或复位复制从服务器接收到的心跳信号的总数或发出CHANGE MASTER TO语句</td></tr><tr><td>LAST_HEARTBEAT_TIMESTAMP</td><td style="text-align:left">YYMMDD HH:MM:SS格式中 的时间戳，显示复制从站接收到最新的心跳信号的时间</td></tr><tr><td>RECEIVED_TRANSACTION_SET</td><td style="text-align:left">此GTID集合中的事务已由该组的此成员接收</td></tr><tr><td>LAST_ERROR_NUMBER</td><td style="text-align:left">导致IO线程停止的错误号</td></tr><tr><td>LAST_ERROR_MESSAGE</td><td style="text-align:left">导致IO线程停止的错误消息</td></tr><tr><td>LAST_ERROR_TIMESTAMP</td><td style="text-align:left">YYMMDD HH:MM:SS格式 的时间戳,IO发生错误的时间</td></tr></tbody></table><h5 id="与show-slave-status的对应关系"><a href="#与show-slave-status的对应关系" class="headerlink" title="与show slave status的对应关系"></a>与show slave status的对应关系</h5><table><thead><tr><th>replication_connection_status Column</th><th style="text-align:left">SHOW SLAVE STATUS Column</th></tr></thead><tbody><tr><td>SOURCE_UUID</td><td style="text-align:left">Master_UUID</td></tr><tr><td>THREAD_ID</td><td style="text-align:left">None</td></tr><tr><td>SERVICE_STATE</td><td style="text-align:left">Slave_IO_Running</td></tr><tr><td>RECEIVED_TRANSACTION_SET</td><td style="text-align:left">Retrieved_Gtid_Set</td></tr><tr><td>LAST_ERROR_NUMBER</td><td style="text-align:left">Last_IO_Errno</td></tr><tr><td>LAST_ERROR_MESSAGE</td><td style="text-align:left">Last_IO_Error</td></tr><tr><td>LAST_ERROR_TIMESTAMP</td><td style="text-align:left">Last_IO_Error_Timestamp</td></tr></tbody></table><h4 id="replication-applier-status"><a href="#replication-applier-status" class="headerlink" title="replication_applier_status"></a>replication_applier_status</h4><p>此表显示从服务器上当前的一般事务执行状态<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from performance<span class="emphasis">_schema.replication_</span>applier<span class="emphasis">_status;</span></span><br><span class="line"><span class="emphasis">+---------------------------+---------------+-----------------+----------------------------+</span></span><br><span class="line"><span class="emphasis">| CHANNEL_</span>NAME              | SERVICE<span class="emphasis">_STATE | REMAINING_</span>DELAY | COUNT<span class="emphasis">_TRANSACTIONS_</span>RETRIES |</span><br><span class="line"><span class="code">+---------------------------+</span>---------------<span class="code">+-----------------+</span>----------------------------+</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | ON            |            NULL |                          0 |</span><br><span class="line"><span class="code">+---------------------------+</span>---------------<span class="code">+-----------------+</span>----------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><h5 id="参数解释-3"><a href="#参数解释-3" class="headerlink" title="参数解释"></a>参数解释</h5><table><thead><tr><th>Field</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td>CHANNEL_NAME</td><td style="text-align:left">组复制通道的名称</td></tr><tr><td>SERVICE_STATE</td><td style="text-align:left">显示复制通道状态是ON还是OFF</td></tr><tr><td>REMAINING_DELAY</td><td style="text-align:left">如果从站在DESIRED_DELAY主站应用事件之后等待 秒数，则此字段包含剩余的延迟秒数。</td></tr><tr><td>COUNT_TRANSACTIONS_RETRIES</td><td style="text-align:left">显示由于从属SQL线程未能应用事务而发生的重试次数。</td></tr></tbody></table><h5 id="与show-slave-status的对应关系-1"><a href="#与show-slave-status的对应关系-1" class="headerlink" title="与show slave status的对应关系"></a>与show slave status的对应关系</h5><table><thead><tr><th>replication_connection_status Column</th><th style="text-align:left">SHOW SLAVE STATUS Column</th></tr></thead><tbody><tr><td>SERVICE_STATE</td><td style="text-align:left">None</td></tr><tr><td>REMAINING_DELAY</td><td style="text-align:left">SQL_Remaining_Delay</td></tr></tbody></table><h4 id="组复制中的server状态"><a href="#组复制中的server状态" class="headerlink" title="组复制中的server状态"></a>组复制中的server状态</h4><table><thead><tr><th>Field</th><th style="text-align:left">描述</th><th style="text-align:left">Group Synchronized</th></tr></thead><tbody><tr><td>ONLINE</td><td style="text-align:left">该成员可以作为一个具有所有功能的组成员,这意味着客户端可以连接并开始执行事务</td><td style="text-align:left">Yes</td></tr><tr><td>RECOVERING</td><td style="text-align:left">该成员正在成为该组的有效成员,并且正处于恢复过程中,从数据源节点接收状态信息</td><td style="text-align:left">No</td></tr><tr><td>OFFLINE</td><td style="text-align:left">插件已加载,但成员不属于任何组</td><td style="text-align:left">No</td></tr><tr><td>ERROR</td><td style="text-align:left">本地成员的状态,只要恢复阶段或应用更改时出现错误,server就会进入此状态</td><td style="text-align:left">No</td></tr><tr><td>UNREACHABLE</td><td style="text-align:left">每当本地故障检测器怀疑某个给定的server可能由于已经崩溃或被意外地断开而不可访问时,server的状态显示为”UNREACHABLE”</td><td style="text-align:left">No</td></tr></tbody></table><h4 id="threads"><a href="#threads" class="headerlink" title="threads"></a>threads</h4><p>group replication线程的状态信息可以通过performance_schema.threads表进行查询，目前可以查询到group replication的线程如下：  </p><ul><li>thread/group_rpl/THD_applier_module_receiver</li><li>thread/group_rpl/THD_certifier_broadcast</li><li>thread/group_rpl/THD_recovery<h3 id="新成员加入组"><a href="#新成员加入组" class="headerlink" title="新成员加入组"></a>新成员加入组</h3><h4 id="配置group-replication-recovery通道"><a href="#配置group-replication-recovery通道" class="headerlink" title="配置group_replication_recovery通道"></a>配置group_replication_recovery通道</h4>当新成员加入一个group replication组后，首先要从其他节点上把它加入之前的数据复制过来。这些以前的数据不能过group replication的通信协议进行复制，而是使用了异步复制的机制。group replication需要使用一个名叫group_replication_recovery的异步复制通道(Channel)。用户必须要提前配置这个通道，不过只需要为这个通道配置连接需要的用户名和密码，其他参数在group replication插件启动group_replication_recovery通道时会自动进行配置。  </li><li>change master to master_host=’rpl_user’,master_password=’rpl_pass’ fro channel = ‘group_replication_recovery’;</li><li>连接到哪个成员上去复制数据，是由group replication插件随机选择的，因此为group_replication_recovery配置的用户要在每一个成员上存在<br>在启动group_replication_recovery通道之前，group replication会自动为其配置master_host和master_port。当一个成员加入组时，会收到组内其他成员的配置信息。配置信息中包括主机名和MySQL服务端口号。主机名和服务端口号是从全局只读变量hostname和port中获取的。如果hostname无法正常解析成ip地址或网络中使用了网络地址映射，group_replication_recovery通道就无法正常工作。有如下两种办法来解决这个问题：  </li><li>在/etc/hosts中配置所有成员的主机名和ip地址的对应关系</li><li>配置MySQL的report_host和report_port的命令行参数。如果用户配置了report_host或report_port，那么group replication会优先使用这个变量中的地址和端口<h4 id="成员加入组的步骤"><a href="#成员加入组的步骤" class="headerlink" title="成员加入组的步骤"></a>成员加入组的步骤</h4>MySQL的相关配置和创建复制用户的步骤略，group replication加入组的步骤如下：</li><li>INSTALL PLUGIN group_replication SONAME ‘group_replication.so’;</li><li>SET GLOBAL group_replication_group_name = “aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa”;</li><li>SET GLOBAL group_replication_local_address= “127.0.0.1:10014”</li><li>SET GLOBAL group_replication_group_seeds= “127.0.0.1:10011,127.0.0.1:10012,127.0.0.1:10013,127.0.0.1:10014”</li><li>CHANGE MASTER TO MASTER_USER=’rpl_user’,MASTER_PASSWORD=’rpl_pass’ FOR CHANNEL ‘group_replication_recovery’;</li><li>START GROUP_REPLICATION;<br>这里不再做演示，还是保持上文中三节点。<h3 id="强制移除故障成员"><a href="#强制移除故障成员" class="headerlink" title="强制移除故障成员"></a>强制移除故障成员</h3>当故障导致半数以上的成员不可用时，group replication就不能对外提供服务，当这种情况发生时，可以设置指定的成员能够立刻对外提供服务。虽然冗余能力不好，但至少能保障业务不中断。可通过以下设置：  </li><li>SET GLOBAL group_replication_force_members = <a href="ip:port,ip:port" target="_blank" rel="noopener">ip:port,ip:port</a><br>group_replication_force_members中配置的是成员地址的列表，只需要在列表中的任意一个成员上设置即可，这个就是强制group replication用参数中的几个成员来构成组，把其他成员从组中移除出去。<h2 id="故障演练"><a href="#故障演练" class="headerlink" title="故障演练"></a>故障演练</h2>通过模拟其中一个节点故障后,主节点是否会自动迁移,故障节点恢复后,数据是否会自动同步<h3 id="查看当前组复制状态"><a href="#查看当前组复制状态" class="headerlink" title="查看当前组复制状态"></a>查看当前组复制状态</h3>登录节点1,查看组复制状态,确认当前节点1为主节点<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock   </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 30</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM performance<span class="emphasis">_schema.replication_</span>group<span class="emphasis">_members;</span></span><br><span class="line"><span class="emphasis">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span></span><br><span class="line"><span class="emphasis">| CHANNEL_</span>NAME              | MEMBER<span class="emphasis">_ID                            | MEMBER_</span>HOST | MEMBER<span class="emphasis">_PORT | MEMBER_</span>STATE |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from performance<span class="emphasis">_schema.global_</span>status where variable<span class="emphasis">_name = 'group_</span>replication<span class="emphasis">_primary_</span>member';</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| VARIABLE<span class="emphasis">_NAME                    | VARIABLE_</span>VALUE                       |</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| group<span class="emphasis">_replication_</span>primary<span class="emphasis">_member | c0acc2c7-d58a-11e7-b59f-00163e00dc49 |</span></span><br><span class="line"><span class="emphasis">+----------------------------------+--------------------------------------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt;</span></span><br></pre></td></tr></table></figure></li></ul><h3 id="模拟主节点故障"><a href="#模拟主节点故障" class="headerlink" title="模拟主节点故障"></a>模拟主节点故障</h3><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; shutdown;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="built_in">rows</span> affected (<span class="number">0.00</span> <span class="built_in">sec</span>)</span><br></pre></td></tr></table></figure><h3 id="确认当前组复制状态"><a href="#确认当前组复制状态" class="headerlink" title="确认当前组复制状态"></a>确认当前组复制状态</h3><p>节点1的9001服务已经不存在,通过登录9002查看组成员状态,9002节点已经成为新节点<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# netstat -tunlp|grep mysql|grep 900                                         </span><br><span class="line">tcp        0      0 0.0.0.0:9002                0.0.0.0:*                   LISTEN      22034/mysqld        </span><br><span class="line">tcp        0      0 0.0.0.0:9003                0.0.0.0:*                   LISTEN      6059/mysqld         </span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 28</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM performance<span class="emphasis">_schema.replication_</span>group<span class="emphasis">_members;</span></span><br><span class="line"><span class="emphasis">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span></span><br><span class="line"><span class="emphasis">| CHANNEL_</span>NAME              | MEMBER<span class="emphasis">_ID                            | MEMBER_</span>HOST | MEMBER<span class="emphasis">_PORT | MEMBER_</span>STATE |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from performance<span class="emphasis">_schema.global_</span>status where variable<span class="emphasis">_name = 'group_</span>replication<span class="emphasis">_primary_</span>member';</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| VARIABLE<span class="emphasis">_NAME                    | VARIABLE_</span>VALUE                       |</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| group<span class="emphasis">_replication_</span>primary<span class="emphasis">_member | cf04e66c-d58a-11e7-b97e-00163e00dc49 |</span></span><br><span class="line"><span class="emphasis">+----------------------------------+--------------------------------------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="组复制新主节点插入数据"><a href="#组复制新主节点插入数据" class="headerlink" title="组复制新主节点插入数据"></a>组复制新主节点插入数据</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table test.t2(id int unsigned not null auto<span class="emphasis">_increment primary key,age int);</span></span><br><span class="line"><span class="emphasis">Query OK, 0 rows affected (0.02 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; insert into test.t2 values(null,111111);</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; select * from test.t2;</span></span><br><span class="line"><span class="emphasis">+----+--------+</span></span><br><span class="line"><span class="emphasis">| id | age    |</span></span><br><span class="line"><span class="emphasis">+----+--------+</span></span><br><span class="line"><span class="emphasis">|  2 | 111111 |</span></span><br><span class="line"><span class="emphasis">+----+--------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt;</span></span><br></pre></td></tr></table></figure><h3 id="从节点查看数据"><a href="#从节点查看数据" class="headerlink" title="从节点查看数据"></a>从节点查看数据</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock   </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 46</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test.t2;</span><br><span class="line"><span class="code">+----+</span>--------+</span><br><span class="line">| id | age    |</span><br><span class="line"><span class="code">+----+</span>--------+</span><br><span class="line">|  2 | 111111 |</span><br><span class="line"><span class="code">+----+</span>--------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure><h3 id="故障节点恢复"><a href="#故障节点恢复" class="headerlink" title="故障节点恢复"></a>故障节点恢复</h3><p>故障节点恢复后,登录实例,启动组复制<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# base/bin/mysqld_safe --defaults-file=/hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/conf/s1.cnf &amp; </span><br><span class="line">[<span class="number">6</span>] <span class="number">22692</span></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# <span class="number">2017</span>-<span class="number">12</span>-01T07:<span class="number">35</span>:<span class="number">42.</span>377430Z mysqld_safe Logging to <span class="string">'/hwdata/data/mysql5.7.20/data/s1/jiessie.err'</span>.</span><br><span class="line"><span class="number">2017</span>-<span class="number">12</span>-01T07:<span class="number">35</span>:<span class="number">42.</span>396416Z mysqld_safe Starting mysqld daemon with databases from /hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/data/s1</span><br><span class="line"></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# netstat -tunlp|grep mysql|grep <span class="number">900</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">9001</span>                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">23135</span>/mysqld        </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">9002</span>                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">22034</span>/mysqld        </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">9003</span>                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">6059</span>/mysqld         </span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# base/bin/mysql -uroot -S /hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/data/s1/s1.sock -e <span class="string">"START GROUP_REPLICATION;"</span></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]#</span><br></pre></td></tr></table></figure></p><h3 id="再次查看组复制状态及插入数据状态"><a href="#再次查看组复制状态及插入数据状态" class="headerlink" title="再次查看组复制状态及插入数据状态"></a>再次查看组复制状态及插入数据状态</h3><p>故障节点已经加入到组复制中,同时故障期间插入的数也已经同步过来,主节点还是节点2的9002实例<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 48</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM performance<span class="emphasis">_schema.replication_</span>group<span class="emphasis">_members;</span></span><br><span class="line"><span class="emphasis">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span></span><br><span class="line"><span class="emphasis">| CHANNEL_</span>NAME              | MEMBER<span class="emphasis">_ID                            | MEMBER_</span>HOST | MEMBER<span class="emphasis">_PORT | MEMBER_</span>STATE |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from performance<span class="emphasis">_schema.global_</span>status where variable<span class="emphasis">_name = 'group_</span>replication<span class="emphasis">_primary_</span>member';</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| VARIABLE<span class="emphasis">_NAME                    | VARIABLE_</span>VALUE                       |</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| group<span class="emphasis">_replication_</span>primary<span class="emphasis">_member | cf04e66c-d58a-11e7-b97e-00163e00dc49 |</span></span><br><span class="line"><span class="emphasis">+----------------------------------+--------------------------------------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; select * from test.t2;</span></span><br><span class="line"><span class="emphasis">+----+--------+</span></span><br><span class="line"><span class="emphasis">| id | age    |</span></span><br><span class="line"><span class="emphasis">+----+--------+</span></span><br><span class="line"><span class="emphasis">|  2 | 111111 |</span></span><br><span class="line"><span class="emphasis">+----+--------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br></pre></td></tr></table></figure></p><h2 id="组复制系统变量"><a href="#组复制系统变量" class="headerlink" title="组复制系统变量"></a>组复制系统变量</h2><table><thead><tr><th>变量名</th><th style="text-align:left">变量范围</th><th style="text-align:left">动态变量</th><th style="text-align:left">类型</th><th style="text-align:left">默认</th><th style="text-align:left">描述</th></tr></thead><tbody><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_group_name" target="_blank" rel="noopener">group_replication_group_name</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">string</td><td style="text-align:left">NULL</td><td style="text-align:left">此server实例所属组名称,须是UUID格式</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_start_on_boot" target="_blank" rel="noopener">group_replication_start_on_boot</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">boolean</td><td style="text-align:left">ON</td><td style="text-align:left">server是否应在自身启动期间启动组复制</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_local_address" target="_blank" rel="noopener">group_replication_local_address</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">string</td><td style="text-align:left">NULL</td><td style="text-align:left">作为本地地址,格式为主机:端口</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_member_weight" target="_blank" rel="noopener">group_replication_member_weight</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">integer</td><td style="text-align:left">50</td><td style="text-align:left">可以分配成员的百分比权重,影响成员在发生故障转移时作为主要成员选举的机会</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_group_seeds" target="_blank" rel="noopener">group_replication_group_seeds</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">string</td><td style="text-align:left">NULL</td><td style="text-align:left">提供加入成员的成员列表,其中加入成员需要的数据以获得与该组的同步</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_force_members" target="_blank" rel="noopener">group_replication_force_members</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">string</td><td style="text-align:left">NULL</td><td style="text-align:left">以逗号分隔开的组内其他成员的地址列表.此选项用于强制建立新的组成员关系,在此过程中已排除的成员不接收新的视图并且被排除在外.您需要手动移除已排除的server</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_bootstrap_group" target="_blank" rel="noopener">group_replication_bootstrap_group</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">boolean</td><td style="text-align:left">OFF</td><td style="text-align:left">配置此server以引导组,此选项只能在一个server上设置,且只能在首次启动组或重启整个组时设置.组被引导后,将此选项设置为OFF.</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_poll_spin_loops" target="_blank" rel="noopener">group_replication_poll_spin_loops</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">integer</td><td style="text-align:left">0</td><td style="text-align:left">在组通信线程等待传入更多的网络信息之前,等待mutex被释放的次数</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_retry_count" target="_blank" rel="noopener">group_replication_recovery_retry_count</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">integer</td><td style="text-align:left">10</td><td style="text-align:left">要加入的成员尝试连接到可用数据源节点的次数</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_reconnect_interval" target="_blank" rel="noopener">group_replication_recovery_reconnect_interval</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">integer</td><td style="text-align:left">60</td><td style="text-align:left">在组中找不到数据源节点时,重新尝试连接的时间间隔</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_use_ssl" target="_blank" rel="noopener">group_replication_recovery_use_ssl</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">boolean</td><td style="text-align:left">OFF</td><td style="text-align:left">组复制恢复通道是否使用SSL</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_ca" target="_blank" rel="noopener">group_replication_recovery_ssl_ca</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">string</td><td style="text-align:left">NULL</td><td style="text-align:left">包含受信任SSL证书颁发机构列表的文件的路径</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_capath" target="_blank" rel="noopener">group_replication_recovery_ssl_capath</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">string</td><td style="text-align:left">NULL</td><td style="text-align:left">包含受信任SSL证书颁发证书的目录路径</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_cert" target="_blank" rel="noopener">group_replication_recovery_ssl_cert</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">string</td><td style="text-align:left">NULL</td><td style="text-align:left">用于建立安全连接的SSL证书文件的名称</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_key" target="_blank" rel="noopener">group_replication_recovery_ssl_key</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">string</td><td style="text-align:left">NULL</td><td style="text-align:left">用于建立安全连接的SSL密钥文件的名称</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_cipher" target="_blank" rel="noopener">group_replication_recovery_ssl_cipher</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">string</td><td style="text-align:left">NULL</td><td style="text-align:left">用于SSL加密的密码列表</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_crl" target="_blank" rel="noopener">group_replication_recovery_ssl_crl</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">string</td><td style="text-align:left">NULL</td><td style="text-align:left">包含具有证书撤销列表文件的路径</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_crlpath" target="_blank" rel="noopener">group_replication_recovery_ssl_crlpath</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">string</td><td style="text-align:left">NULL</td><td style="text-align:left">包含具有证书撤销列表文件的路径</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_verify_server_cert" target="_blank" rel="noopener">group_replication_recovery_ssl_verify_server_cert</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">boolean</td><td style="text-align:left">OFF</td><td style="text-align:left">在恢复过程中用于检查数据源节点发送证书中的”通用名称”</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_complete_at" target="_blank" rel="noopener">group_replication_recovery_complete_at</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">enumeration</td><td style="text-align:left">TRANSACTIONS_APPLIED</td><td style="text-align:left">状态传输后处理缓存中的事务时的恢复策略.此选项指定成员在”接收到加入群组(TRANSACTIONS_CERTIFIED)之前遗漏的所有事务”或”收到并应用了这些事务(TRANSACTIONS_APPLIED)”之后,是否标记在线</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_components_stop_timeout" target="_blank" rel="noopener">group_replication_components_stop_timeout</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">integer</td><td style="text-align:left">31536000</td><td style="text-align:left">组复制在关闭时等待每个组件的超时时间,以秒为单位</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_allow_local_lower_version_join" target="_blank" rel="noopener">group_replication_allow_local_lower_version_join</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">boolean</td><td style="text-align:left">OFF</td><td style="text-align:left">即使当前server的插件版本比组的插件版本低,也允许它加入组</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_allow_local_disjoint_gtids_join" target="_blank" rel="noopener">group_replication_allow_local_disjoint_gtids_join</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">boolean</td><td style="text-align:left">OFF</td><td style="text-align:left">即使含有组中不存在的事务,也允许当前server加入组,此选项要慎重,可能会破坏组内一致性</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_auto_increment_increment" target="_blank" rel="noopener">group_replication_auto_increment_increment</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">integer</td><td style="text-align:left">7</td><td style="text-align:left">确定在此server实例上执行的连续事务之间的步长</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_compression_threshold" target="_blank" rel="noopener">group_replication_compression_threshold</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">integer</td><td style="text-align:left">1000000</td><td style="text-align:left">以字节为单位,超过该值将强制执行lz4压缩,当设置为0时,压缩设置无效</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_gtid_assignment_block_size" target="_blank" rel="noopener">group_replication_gtid_assignment_block_size</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">integer</td><td style="text-align:left">1000000</td><td style="text-align:left">为每个成员保留的连接GTID数量,每个成员在开始时会消耗掉一些,当需要时在获取更多个</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_ssl_mode" target="_blank" rel="noopener">group_replication_ssl_mode</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">enumeration</td><td style="text-align:left">DISABLED</td><td style="text-align:left">指定组复制成员之间连接的安全状态</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_single_primary_mode" target="_blank" rel="noopener">group_replication_single_primary_mode</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">boolean</td><td style="text-align:left">ON</td><td style="text-align:left">设置组自动选择一个server来处理读写工作,这个server是主(primary),所有其他都是从(secondaries)</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_transaction_size_limit" target="_blank" rel="noopener">group_replication_transaction_size_limit</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">integer</td><td style="text-align:left">0</td><td style="text-align:left">配置组接受最大事务大小,以字节为单位,大于这个事务被回滚.当设置为0时,无限制</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_unreachable_majority_timeout" target="_blank" rel="noopener">group_replication_unreachable_majority_timeout</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">integer</td><td style="text-align:left">0</td><td style="text-align:left">配置在离开组之前遭受网络分区且无法连接到大多数成员的成员需要等待多长时间,默认情况为0,这意味着由于网络分区而成为少数的成员永远等待连接组.</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_enforce_update_everywhere_checks" target="_blank" rel="noopener">group_replication_enforce_update_everywhere_checks</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">boolean</td><td style="text-align:left">OFF</td><td style="text-align:left">多主模式下为多主更新或禁用严格一致性检查</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_flow_control_mode" target="_blank" rel="noopener">group_replication_flow_control_mode</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">enumeration</td><td style="text-align:left">QUOTA</td><td style="text-align:left">指定启用限流模式,不需要重置组复制就可以修改此变量</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_flow_control_certifier_threshold" target="_blank" rel="noopener">group_replication_flow_control_certifier_threshold</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">integer</td><td style="text-align:left">25000</td><td style="text-align:left">触发限流的验证队列的阈值,不需要重置组复制就可以修改此变量</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_flow_control_applier_threshold" target="_blank" rel="noopener">group_replication_flow_control_applier_threshold</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">integer</td><td style="text-align:left">25000</td><td style="text-align:left">触发限流的应用队列的阈值,不需要重置组复制就可以修改此变量</td></tr><tr><td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_ip_whitelist" target="_blank" rel="noopener">group_replication_ip_whitelist</a></td><td style="text-align:left">Global</td><td style="text-align:left">Yes</td><td style="text-align:left">string</td><td style="text-align:left">AUTOMATIC</td><td style="text-align:left">指定允许哪些主机可以访问组,默认为AUTOMATIC,它允许来自主机上的私有子网的连接,多个以逗号分隔</td></tr></tbody></table><h2 id="组复制的多主和单主模式"><a href="#组复制的多主和单主模式" class="headerlink" title="组复制的多主和单主模式"></a>组复制的多主和单主模式</h2><p>默认为单主模式,组中的成员不可能以不同的模式部署,例如一个配置为多主模式,另一个配置为单主模式.要切换模式,组和服务器之间需要不的操作配置重新启动.无论部署模式如何,组复制不处理客户端故障切换,必须由应用程序本身,连接器或中间件框架如代理或路由器来处理.  </p><h3 id="单主模式"><a href="#单主模式" class="headerlink" title="单主模式"></a>单主模式</h3><p>在此模式下,该组具有设置为读写械的单主服务器,组中的所有其他成员都设置为只读模式(超级只读模式super_read_only),所有其他加入的节点自动识别主节点并设置为自己为只读.</p><h4 id="选主过程"><a href="#选主过程" class="headerlink" title="选主过程"></a>选主过程</h4><p>参考官方流程图:<br><img src="https://dev.mysql.com/doc/refman/5.7/en/images/single-primary-election.png" alt="image">在单主机模式下，将禁用在多主机模式下部署的某些检查，因为系统会强制每次只有一个写入节点。例如，允许对具有级联外键的表进行更改，而在多主模式下不允许。在主节点故障时，自动选举机制选择下一个主节点。通过按字典顺序（使用其UUID）并选择列表中的第一个节点来排序剩余的节点来选择下一个主节点,可通过group_replication_member_weight此参数影响选主。如果主节点从组中删除，则执行选择，并从组中的其余节点中选择新的主节点，这个选择按照词典顺序排序节点UUID并选择第一个来执行。一旦选择了新的主节点，其他节点将设置为从节点，从节点为只读。</p><h3 id="多主模式"><a href="#多主模式" class="headerlink" title="多主模式"></a>多主模式</h3><p>在多主模式下，没有单个主模式的概念，也没有选举程序，因为没有节点发挥任何特殊的作用。加入组时，所有服务器都设置为读写模式。<br>在多主模式下部署时,将检查语句以确保他们与模式兼容,以多主模式部署组复制时进行以下检查:  </p><ol><li>如果一个事务在SERIALIZABLE隔离级别下执行，那么当它自己与该组同步时，它的提交失败。</li><li>如果事务针对具有级联约束的外键的表执行，则在与组自身同步时，事务无法提交。<br>这些检查可以通过设置选项来禁用 group_replication_enforce_update_everywhere_checks 到FALSE。在单主模式下部署时，必须将此选项设置为FALSE。<h4 id="客户端故障转移"><a href="#客户端故障转移" class="headerlink" title="客户端故障转移"></a>客户端故障转移</h4>参考官方流程图:<br><img src="https://dev.mysql.com/doc/refman/5.7/en/images/multi-primary.png" alt="image"><h4 id="自增字段的处理"><a href="#自增字段的处理" class="headerlink" title="自增字段的处理"></a>自增字段的处理</h4>当使用多主模式时，需要设置autoincrement相关的参数来保证自增字段在每个成员上产生不同的值。group replication提供了两种配置方式，分别如下：</li><li>直接配置MySQL的系统变量，通过命令来配置时，需要在所有成员上配置下面两个参数</li></ol><ul><li>set global auto_increment_offset = N;</li><li>set global auto_increment_increment = N;</li></ul><ol start="2"><li>通过group replication插件来配置，group replication插件定义了一个新的参数来配置自增字段的大小，上面的参数列表中也有解释</li></ol><ul><li>set global group_replication_auto_increment_increment = N;<br>group_replication_auto_increment_increment的默认值是7。如果自增值的浪费不对业务千万影响，可以不用修改这个值。group replication没有提供新的参数来设置自增值的偏移，而是将MySQL服务器的server-id看作自增值的偏移。如果用户的server-id本来就是按照1、2、3这样的顺序配置的，就不需要再做额外的配置。在启动group replication插件时，它会检测用户是否配置了MySQL的自增变量。如果用户没有配置这两个参数（auto_increment_offset和auto_increment_increment都为1），则会自动将group_replication_auto_increment_increment和server-id的值设置到MySQL的auto_increment_increment和auto_increment_offset全局变量中。<br>自增变量将从1开始的连续自增值划分为固定大小的段，各个MySQL服务器分别使用段内不同偏移量的自增值。auto_increment_increment代表段的大小，每个成员都应该配置相同的段大小。而auto_increment_offset是本成员 的自增值在段内的偏移。每个成员应该设置不同的偏移量。假设段的大小设为5，成员A的偏移量设为1，成员B的偏移量设为2，那么成员A上产生的自增值为：1、6、11、16……，成员B上产生的自增值为：2、7、12、17……。如下图所示：<h5 id="自增ID示例图"><a href="#自增ID示例图" class="headerlink" title="自增ID示例图"></a>自增ID示例图</h5></li><li>| 偏移1 | 偏移2 | 偏移3 | 偏移4 | 偏移5<br>—|—|—|—|—|—<br>第一段 | 1 | 2 | 3 | 4 | 5 |<br>第二段 | 6 | 7 | 8 | 9 | 10 |<br>第三段 | 11 | 12 | 13 | 14 | 15 |<br>第四段 | 16 | 17 | 18 | 19 | 20 |<br>… | … | … | … | … | … |<br>可以看出，自增字段的大小依赖于group replication组中的成员的多少。auto_increment_increment最小要等于group replication组内的数量。如果段的大小等于组内的数量，则所有的自增id都会被使用。如果段的大小大于组内的成员的数量，则有一部自增值永远不会被使用，会千万一定的浪费。比如，组内有3个成员，偏移分别是1、2、3，而段的大小是5，那么偏移4和5上的值就会被浪费掉。考虑到group replication组的扩展，最好将段的大小设置得比现有的组内成员数量大一些。这样虽然会浪费一些自增值，但是扩展会很简单。在使用的过程中变更自增字段的大小，处理起来会比较麻烦，所以要提前规划好。<h5 id="自增字段演示"><a href="#自增字段演示" class="headerlink" title="自增字段演示"></a>自增字段演示</h5><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e "show variables like <span class="emphasis">'server_id'</span>;"</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| server_</span>id     | 1     |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock -e "show variables like <span class="emphasis">'server_id'</span>;"  </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| server_</span>id     | 2     |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock -e "show variables like <span class="emphasis">'server_id'</span>;"   </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| server_</span>id     | 3     |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 37</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like <span class="emphasis">'group_replication_auto_increment_increment'</span>;</span><br><span class="line"><span class="code">+--------------------------------------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name                              | Value |</span></span><br><span class="line"><span class="emphasis">+--------------------------------------------+-------+</span></span><br><span class="line"><span class="emphasis">| group_</span>replication<span class="emphasis">_auto_</span>increment<span class="emphasis">_increment | 5     |</span></span><br><span class="line"><span class="emphasis">+--------------------------------------------+-------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.01 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; select * from performance_</span>schema.global<span class="emphasis">_status where variable_</span>name = <span class="emphasis">'group_replication_primary_member'</span>;</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| VARIABLE<span class="emphasis">_NAME                    | VARIABLE_</span>VALUE                       |</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| group<span class="emphasis">_replication_</span>primary<span class="emphasis">_member | c0acc2c7-d58a-11e7-b59f-00163e00dc49 |</span></span><br><span class="line"><span class="emphasis">+----------------------------------+--------------------------------------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; SELECT * FROM performance_</span>schema.replication<span class="emphasis">_group_</span>members;</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">| CHANNEL<span class="emphasis">_NAME              | MEMBER_</span>ID                            | MEMBER<span class="emphasis">_HOST | MEMBER_</span>PORT | MEMBER<span class="emphasis">_STATE |</span></span><br><span class="line"><span class="emphasis">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span></span><br><span class="line"><span class="emphasis">| group_</span>replication<span class="emphasis">_applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span></span><br><span class="line"><span class="emphasis">| group_</span>replication<span class="emphasis">_applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span></span><br><span class="line"><span class="emphasis">| group_</span>replication<span class="emphasis">_applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span></span><br><span class="line"><span class="emphasis">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span></span><br><span class="line"><span class="emphasis">3 rows in set (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; create table test.t0(id int unsigned not null primary key auto_</span>increment,name varchar(20));            </span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test.t0 values(null,<span class="emphasis">'111'</span>),(null,<span class="emphasis">'222'</span>),(null,<span class="emphasis">'333'</span>);</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test.t0;</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">| id | name |</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">|  1 | 111  |</span><br><span class="line">|  6 | 222  |</span><br><span class="line">| 11 | 333  |</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 27</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test.t0 values(null,<span class="emphasis">'aaa'</span>),(null,<span class="emphasis">'bbb'</span>),(null,<span class="emphasis">'ccc'</span>);</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test.t0;</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">| id | name |</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">|  1 | 111  |</span><br><span class="line">|  2 | aaa  |</span><br><span class="line">|  6 | 222  |</span><br><span class="line">|  7 | bbb  |</span><br><span class="line">| 11 | 333  |</span><br><span class="line">| 12 | ccc  |</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 23</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test.t0 values(null,<span class="emphasis">'123'</span>),(null,<span class="emphasis">'456'</span>),(null,<span class="emphasis">'789'</span>);</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test.t0;</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">| id | name |</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">|  1 | 111  |</span><br><span class="line">|  2 | aaa  |</span><br><span class="line">|  3 | 123  |</span><br><span class="line">|  6 | 222  |</span><br><span class="line">|  7 | bbb  |</span><br><span class="line">|  8 | 456  |</span><br><span class="line">| 11 | 333  |</span><br><span class="line">| 12 | ccc  |</span><br><span class="line">| 13 | 789  |</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie percona]#</span><br></pre></td></tr></table></figure></li></ul><h4 id="DDL语句并发执行的问题"><a href="#DDL语句并发执行的问题" class="headerlink" title="DDL语句并发执行的问题"></a>DDL语句并发执行的问题</h4><p>多主复制时，通过冲突检测来辨别有冲突的事务，有冲突的事务通过回滚操作来处理。MySQL5.7上的DDL不是原子操作无法回滚，因此group replication没有对DDL做冲突检测。换句话说，DDL语句不会和其他任何语句冲突（包括DML和DDL）。如果DDL和有冲突的语句在不同的成员上同时执行，可能导致错误或数据不一致。假设在成员A上执行如下事务：  </p><ul><li>BEGIN;</li><li>INSERT INTO t1 values(1);<br>此时，成员B上执行以下语句：  </li><li>TRUNCATE TABLE t1;<br>成员A上接着执行：  </li><li>COMMIT;<br>成员A上两个事务的执行顺序是：  </li><li>INSERT INTO t1 VALUES(1);</li><li>TRUNCATE TABLE t1;<br>成员B上两个事务的执行顺序是：  </li><li>TRUNCATE TABLE t1;</li><li>INSERT INTO t1 VALUES(1);<br>这就会导致两个成员上数据的不一致。因此多主模式下，执行任何DDL前，要将可能有冲突的事务迁移到同一台MySQL服务器上，再开始执行DDL语句。<h2 id="组复制基本原理"><a href="#组复制基本原理" class="headerlink" title="组复制基本原理"></a>组复制基本原理</h2><h3 id="状态机复制"><a href="#状态机复制" class="headerlink" title="状态机复制"></a>状态机复制</h3>本质上来说，group replication是一个状态机复制的集群。在状态机复制的架构中，数据库被当作一个状态机。每一次写操作都会导致数据库的状态变化。为了创建一个高可用的数据库集群，有一个组件将这些操作按照同样的顺序发送到多个初始状态一致的数据库上，让这些数据库执行同样的操作。因为初始状态相同，每次执行的操作也相同，所以每次状态变化后各个数据库服务器上的数据保持一致。下图是一个非常简单的状态机复制的示意图。<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/1E369A3D807949C1B0B563C5F04A6165/41768" alt="image"><br>假设图中数据库DB1、DB2和DB3的初始状态是相同的，事务T1、T2和T3分别如下：  </li></ul><ol><li>#T1<blockquote><p>DELETE FROM t1 WHERE pk = 1;</p></blockquote></li><li>#T2<blockquote><p>UPDATE t1 SET c1 = 100 WHERE pk = 1;</p></blockquote></li><li>#T3<blockquote><p>UPDATE t1 SET c1 = 50 WHERE pk = 1;<br>3个客户端并发地将这3个事务发送到事务分发器上，事务分发器首先对这3个事务进行排序 ，然后按照同样的顺序（T3、T1、T2）并发地发送到DB1、DB2和DB3这3个数据库上去执行。T3最先在DB1、DB2和DB3上执行，执行完后，DB1、DB2和DB3上的结果相同。接着T1被执行，执行后DB1、DB2和DB3上t1表中pk为1的记录都被删除了。最后T2被执行，由于T1删除了记录，因此T2执行时会失败。T2在DB1、DB2和DB3上都会失败，所以DB1、DB2和DB3的数据仍然是一致的。  </p></blockquote><h3 id="分布式的状态机复制"><a href="#分布式的状态机复制" class="headerlink" title="分布式的状态机复制"></a>分布式的状态机复制</h3>在上图的模型中，事务分发器是一个单点故障点。为了避免单点故障，可以采用分布式的状态机复制。在分布式的状态机复制中，有多个事务分发器，它们彼此相互通信。事务分发器可以同时接收事务请求，就像单个事务分发器同时接收事务请求一样。从应用层面来说并发的事务发到同一个事务分发器和发到不同的事务分发器上效果是一样的。事务分发器之间会相互通信，把所有的事务汇总、排序。最终，每个事务分发器上都有一份完整的排好序的事务请求。每个事务分发器只连接到一台数据库服务器上，并负责把事务请求依次发送到这个相连的数据库上去执行。下图所示的是分布式状态机复制的一个模式。<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/9259ECA7A83F43FCA15A73FFE800D447/41765" alt="image"><br>数据库DB1、DB2和DB3的初始状态是相同的，事务T1、T2和T3分别如下：  </li><li>#T1<blockquote><p>DELETE FROM t1 WHERE pk = 1;</p></blockquote></li><li>#T2<blockquote><p>UPDATE t1 SET c1 = 100 WHERE pk = 1;</p></blockquote></li><li>#T3<blockquote><p>UPDATE t1 SET c1 = 50 WHERE pk = 1;<br>3个客户端并发地将这3个事务发送到各自的事务分发器上。事务分发器彼此之间互相通信，最终每个事务分发器上都会有一份完整的顺序一样的事务请求列表（T3、T1、T2）。3个事务分发器将这些事务请求按照顺序发送到各自的数据库服务器上去执行。T3最先在DB1、DB2和DB3上执行，执行完后DB1、DB2和DB3上的结果相同。接着T1被执行，执行后DB1、DB2和DB3上t1表中pk为1的记录都被删除了。最后T2被执行，由于T1删除了记录，T2在DB1、DB2和DB3上都会失败，所以DB1、DB2和DB3的数据仍然是一致的。<br>不管是单个事务分发器还是多个事务分发协同工作，它们的目标都是一样的：将所有的事务按照同样的顺序发送到数据库服务器上去执行。  </p></blockquote><h3 id="分布式的高可用数据库"><a href="#分布式的高可用数据库" class="headerlink" title="分布式的高可用数据库"></a>分布式的高可用数据库</h3>如果将上图中的事务分发器集成到数据库系统中，就变成了一个分布式的高可用数据库系统，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/BD936C654F294854BC735E45E94327AB/41797" alt="image"><br>用户通过数据库服务器的用户接口执行事务。数据库服务器收到事务请求后，首先交由事务分发模块处理。事务分发模块将事务汇总排序，然后依次交由数据处理模块去执行这些事务。如果去年内部的细节，就会发现这是一个非常简洁的数据库集群方案。通过group replication构建的MySQL集群就是这样一个分布式的高可用MySQL系统。整个集群的架构如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/53E2199DB34F47618272939F924E5820/41808" alt="image">  <h2 id="深入理解组复制中事务的执行过程"><a href="#深入理解组复制中事务的执行过程" class="headerlink" title="深入理解组复制中事务的执行过程"></a>深入理解组复制中事务的执行过程</h2>从上文中的模型可以知道，group replication插件中最重要的功能就是事务分发器的功能。group replication中实现的事务分发器和模型中的略有不同。在模型中，假设事务分发器分发的是事务的SQL语句，也就是说事务分发器的处理是在事务执行前。而在group replication中，事务分发器分发的是Binlog Event，事务分发器的处理是在事务执行即将结束的时候。group replication将这称作乐观的事务执行策略，可以带来更好的性能。但是在这种策略下，多个成员的事务可能发生冲突。group replication需要一个冲突检测机制来发现并处理冲突。由于Binlog Event的执行和SQL语句的执行过程是不一样的，group replication就用到异步复制中Binlog Event的执行模块。为了更好地理解group replication事务执行的过程，这里将group replication处理的事务分为本地事务和异地事务。本地事务指的是用户Session中或异步复制线程中执行的事务。异地事务指的是group replication中传播的由Binlog Event构成的事务。<br>根据事务处理过程中的不同处理步骤，group replication中事务分发器的功能划分为以下四部分。</li></ol><ul><li>本地事务控制模块</li><li>成员间的通信模块</li><li>全局事务认证模块</li><li>异地事务执行模块<h3 id="本地事务控制模块"><a href="#本地事务控制模块" class="headerlink" title="本地事务控制模块"></a>本地事务控制模块</h3>MySQL通过API向插件提供了事务执行过程中几个重要阶段的监控接口，group replication通过这些接口来监控和控制接口的执行。MySQL的事务在提交时，内部会分为三个阶段：准备(prepare)阶段、记录Binlog文件阶段和提交(commit)阶段。group replication对本地事务的控制逻辑在before_commit这个接口中执行。before_commit是在事务的prepare阶段之后，写Binlog文件阶段之前被执行的。对本地事务的控制包括以下三个步骤：<h4 id="发送事务信息"><a href="#发送事务信息" class="headerlink" title="发送事务信息"></a>发送事务信息</h4>group replication首先会将事务执行的相关信息打包，通过通信模块的接口发送给本地的通信模块。本地事务控制模块只发送信息，不接收任何信息。因此，这个通信是异步过程。只要本地的通信模块接收了消息就返回成功。发送到其他成员是通信模块的职责。事务信息包括主键信息、数据库快照版本和事务产生的Binlog Events。</li><li>主键信息是Server层生成Binlog Event的时候一同生成的。是否记录主键信息是通过transaction_write_set_extraction变量来控制的。主键信息中记录的并不是主键字段的值，而是字段值加上库名、表名等哈希值。</li><li>数据库快照版本是当前MySQL的全局变量gtid_executed的值。它包含了当前事务提交时所有已经执行了的事务的GTID，代表了当前事务执行时数据库的状态，因此称为数据库的快照版本。</li><li>当发送事务信息时，Binlog Event还没有写入Binlog文件。因此，Binlog Event是从当前线程的Binlog Cache中获取的，而不是依赖于Binlog文件。</li><li>Transaction_context_log_event，本地成员的UUID、主键信息和数据库快照版本会被封装进Transaction_context_log_event中，和事务产生的Binlog Event一起发送出去。Transaction_context_log_event放在其他Binlog Event前面。<h4 id="等待全局事务认证模块的认证结果"><a href="#等待全局事务认证模块的认证结果" class="headerlink" title="等待全局事务认证模块的认证结果"></a>等待全局事务认证模块的认证结果</h4>在事务信息发送成功后，事务会被阻塞，开始等待全局事务认证模块的认证结果。事务认证完成后，全局事务认证模块会唤醒当前事务的线程，让事务继续执行。<h4 id="认证结果的处理"><a href="#认证结果的处理" class="headerlink" title="认证结果的处理"></a>认证结果的处理</h4>这个过程实际上是由MySQL的代码执行的，而不是由group replication的代码执行的。在哪里执行的并不重要，只要理解这个过程就好。事务继续执行后，会检测 认证结果。如果认证成功，就继续提交事务，如果认证失败就会返回错误。然后由MySQL来执行Rollback的逻辑。<h3 id="成员间的通信模块"><a href="#成员间的通信模块" class="headerlink" title="成员间的通信模块"></a>成员间的通信模块</h3>通信模块分为三部分，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/0E5E7CCE172449C6990D237B25C46493/41896" alt="image">  </li></ul><ol><li>本地数据接收部分负责接收本地成员上其他模块的数据发送请求，接收到的数据包被放入本地数据队列等待处理。</li><li>成员间的通信部分负责和其他成员通信。通信工作包括：从本地数据队列读取数据包发送给其他成员，以及接收其他成员发送过来的数据包。各个成员之间的通信使用了Paxos协议，Paxos协议是一个分布式的一致性协议。</li><li>全局数据包发送部分将所有的数据包顺序返回给本地成员上的全局事务认证模块。<br>当各个成员的通信模块接收到上层模块的数据发送请求时，这些并发的数据请求是无序的，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/69AF4FC0CD2B461FA576430FEE91F002/41910" alt="image"><br>3个成员分别有1个数据包，分别是T1、T2和T3产生的数据包。这些并发、无序的数据包会通过Paxos协议汇聚到每个成员上，并且排序。最终每个成员的通信模块都会拥有同样的数据库包，这些数据包会按照同样的顺序发送到各自成员上的全局事务认证模块，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/E89D346C4CE0480E997A46F6598991D8/41920" alt="image"><br>Paxos协议的工作核心就是对所有数据包进行汇聚和排序。为了完成上面的功能，Paxos协议本身会进行三次TCP通信，如下：</li></ol><ul><li>发送数据包给其他成员的通信模块</li><li>其他成员的通信模块回应收到的数据包</li><li>当超过半数的通信模块(包括它自己)回应后，发送消息告诉所有节点这个数据包同步成功。只有当Paxos协议的三个步骤成功完成后通讯模块才会把这个数据包发送给全局认证模块。这就像是两个公司谈合作经办人多轮协商把所有的条款都谈妥没有异议了，然后才通知老板准备签约。<br>为了保证数据按照同样的顺序发送到全局事务认证模块，Paxos协议还会为每个同步成功的数据包分配一个唯一的ID，当各个成员上的通信模块向上层模块发送这些数据包时，会按照数据包的ID以小到大的顺序发送给全局认证模块。这个ID由两部分组成，分别如下：  </li><li>成员序号：每个成员在加入组后，就会获得一个组内成员的唯一序号，这个成员发出的所有数据包都会使用这个成员序号。</li><li>自增序号：每个成员的通信模块都会维护一个自增的序号，按照发送数据包的顺序，给每个数据包分配一个顺序号。<br>如图所示，假设一个组有三个成员，那么顺序号为1的成员上的数据包ID是1:1,2:1,…,N:1。顺序号为2的成员上的数据包ID是1:2,2:2,…,N:2。顺序号为3的成员上的数据包ID是1:3,2:3,…,N:3。<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/2E3B711A745D4835804B8C73B3828D5C/41969" alt="image"><br>当向全局认证模块发送这些数据包时，必须按照ID连续发送，不能跳过某个ID的数据包。本质上来说，这是一个轮训(Round Robin)的过程。先发送成员1的第一个数据包，接着发送成员2的第一个数据包，然后发送成员3的第一个数据包，如图所示。<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/8C70F6129567449EAAA0402A5BE74797/41980" alt="image"><br>如果在这个过程中，成员2上的数据包还没有同步成功呢？这时候就得等着，直到成员2的第一个数据包同步成功的后，才能返回给全局认证模块，然后继续返回成员3的数据包。假如成员2是空闲的，且本地没有任何事务处理呢？这种情况下，成员2需要发一个空操作指令(NOP)，告诉其他成员跳过ID1:2的数据包。这个指令是当成员2收到ID1:1的数据包同步成功的消息(Paxos的第三个TCP消息)后发出的，如图所示。<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/1E24039CABA940DCB555BFFB16C0FAAC/41995" alt="image"><br>以上介绍的只是Paxos协议很少的一部分，如果想详细了解Paxos协议，还是要查阅更多的资料。总结一下，Paxos在通信上的特别如下：  </li><li>数据包同步成功需要三次TCP传输。</li><li>每个数据包都要发送到所有的成员上，因此需要传输多份，传输的数据量会被放大。</li><li>假设数据包发送到其他所有成员的过程是并发进行的，那么数据包同步成功需要的时间是成员间最慢的那条链路上完成三次TCP通信的时间。<br>这些特点决定了group replication在延迟大、带宽窄的网络中的效率会是比较低的。group replication为了提高Paxos对网络的适用性、做了以下优化：  </li><li>使用了LZ4压缩算法对事务信息进行压缩，当数据包的大小超过一个阈值时会被自动压缩。</li><li>Paxos会将多个事务信息封装到一个数据包内进行通信，大大减少了Paxos通信的次数。<h3 id="全局事务认证模块"><a href="#全局事务认证模块" class="headerlink" title="全局事务认证模块"></a>全局事务认证模块</h3>全局事务认证模块有一个消息队列，用来存放所有收到的消息。这些消息主要是事务的Binlog Event，也有一部分状态和控制信息。状态表replication_group_member_stats中的字段COUNT_TRANSATION_IN_QUEUE指的就是这个队列中事务数据。<br>全局事务认证模块的核心任务是做冲突检测。冲突检测是指识别出那些同时修改了同样数据的事务，并做出相应的处理。冲突检测中需要的信息包括如下三点：  </li><li>主键信息。</li><li>事务执行时的数据快照版本。</li><li>执行事务的MySQL服务器的UUID。<h4 id="冲突检测需要的信息"><a href="#冲突检测需要的信息" class="headerlink" title="冲突检测需要的信息"></a>冲突检测需要的信息</h4>group replication的冲突检测中以数据行为单位，两个事务是不是修改了同样的数据，是通过事务所修改的主键值来判断的。上方中有介绍，Server层在产生Binlog Event时，会同时记录所修改的主键信息(库名、表名主键等信息产生的哈希值)。当发现两个事务修改了同样的数据后，如何来判断这两个事务是不是同时执行的呢？这里用到了数据库快照版本。数据库快照版本是数据库的一个瞬时状态，每个写操作都会导致数据库的状态变化，不同的状态用不同的快照版本来表示。快照版本是用GTID来表示的，每个写事务都会产生一个唯一的GTID，这个GTID由全局事务认证模块产生，且在事务提交时会被添加到全局变量gtid_executed中。因此，gtid_executed的内容就是MySQL的数据库快照版本。<br>如下图所示，为数据库快照版本变化的示例图。图中，事务T1开始执行时所基于的数据库快照版本为空，T1提交后的数据库版本变为”group_name:1”,group_name是group replication组的UUID。事务T2的执行则基于”group_name:1”的快照版本，这个数据库的快照版本，主键信息及其MySQL服务器的UUID一起被封装到Transaction_context_log_event上，和其他事务产生的Binlog Event一起发送到全局事务检测模块。<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/8375C243E6614C17B5B99222154D8891/42081" alt="image">  <h4 id="冲突检测数据库"><a href="#冲突检测数据库" class="headerlink" title="冲突检测数据库"></a>冲突检测数据库</h4>全局事务认证模块中还维护了一个冲突检测数据库，它是主键哈希+快照版本的列表。快照版本存储的是最后一个修改此主键信息的快照版本加上这个事务的GTID。收到事务信息后，全局事务认证模块会根据Transaction_context_log_event中的主键信息，从冲突检测数据库中检索出所有主键的快照版本和该事务的快照版本进行比对。当前事务的快照版本必须要包含检索出的所有主键快照版本中的GTID，否则就是有冲突。  <h4 id="理解冲突检测的过程"><a href="#理解冲突检测的过程" class="headerlink" title="理解冲突检测的过程"></a>理解冲突检测的过程</h4>下面通过一个例子来理解冲突检测的原理，如图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/E14FC995A3274640812B5B858DEEF447/42271" alt="image"><br>假设当前所有成员的数据库状态是一致的，它们的gtid_executed值都为”group_name:1-100”。这时，DB1上执行了事务T1,T1看到数据库快照版本就是”group_name:1-100”。<blockquote><p>UPDATE t1 SET c2 = 5 WHERE pk = 1;<br>同时，DB2执行了事务T2,T2看到数据库快照版本就是”group_name:1-100”。<br>UPDATE t1 SET c2 = 10 WHERE pk = 1;<br>经过通信模块排序后，T2排在了T1前面，如图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/94B9F228E3FD4295BDE411526066DF49/42098" alt="image"><br>因此，在所有成员全局冲突模块中都是先处理T2,再处理T1。在处理T2时，首先根据Transaction_context_log_event中的主键信息从冲突检测数据库中查找该主键上一次被修改后的快照版本。有可能查到，也不可能查不到。查不到就意味没有冲突。假设冲突检测数据库中的内容如下图所示(为了理解方便，图中主键哈希值用主键值代替)<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/2C2984AF9A8E4880A2B9A5EF5AF6926C/42113" alt="image"><br>从冲突检测数据库中查到此主键上一次被修改后的版本快照是”group_name:1-98”。和T2的快照版本比较得知，T2的快照版本中的GTID集合包含了冲突检测数据中查找到的快照版本的GTID集合。也就意味着，T2在B成员上执行时，上一次该主键的更新已经在B成员上执行了，所以T2和上一次该主键的更新之间是不冲突的。接着，全局事务认证模块会为T2分配一个GTID，并更新冲突检测数据库中此主键的快照版本。假设T2分配的GTID是”group_name:101”,更新后的冲突检测数据库如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/8621CA95B2884616BDA1DF5B1E6DFAB9/42129" alt="image"><br>T2处理完成后，开始下一个事务T1的冲突检测。首先，也是从冲突检测数据库中查找该主键的快照版本，查到的结果是”group_name:101”，和T1的快照版本对比发现，T1的快照版本不包含”group_name:101”，这就可以判定T1和之前一次的主键修改(T2的修改)是同时进行的，是冲突的。</p></blockquote><h4 id="冲突处理"><a href="#冲突处理" class="headerlink" title="冲突处理"></a>冲突处理</h4>冲突检测完成后，全局认证模块接下来的处理是有本地事务和异地事务区分的。Transaction_context_log_event中记录了产生这个事务的MySQL服务器的UUID。根据这个UUID，就能判断出这是一个本地事务还是异地事务，对于本地事务的处理如下：</li><li>如果没有冲突，唤醒这个事务的线程，并且告诉它完成提交操作。</li><li>如果有冲突，唤醒这个事务的线程，并且告诉它发生冲突，需要回滚。</li><li>不论是否有冲突，Binlog Event都会被丢弃。<br>对于异地事务的处理如下：</li><li>如果没有冲突，将这个事务的Binlog Event写入Relay log中，让group_relication_appliter通道去执行。</li><li>如果有冲突，则丢弃这个事务的Binlog Event。<h4 id="冲突检测数据库的清理"><a href="#冲突检测数据库的清理" class="headerlink" title="冲突检测数据库的清理"></a>冲突检测数据库的清理</h4>随着使用时间的越来越长，冲突检测数据库中维护的主键信息会越来越多，这些主键信息将占用巨大的内存。为了减小内存的使用并提高查询效率，全局事务认证模块需要定期的清理冲突检测数据库。如果一个事务已经在所有成员上执行了，其他事务的执行肯定不会和它有冲突，因此这个事务的所有主键信息就可以从冲突检测数据库中移除。主键信息的清理是依据各个成员上的全局变量gtid_executed的GTID集合来做的。全局认证模块启动了一个广播线程，每60s将自己的gtid_executed中的GTID集合广播到所有的成员上。全局事务认证模块收到所有成员的GTID后，取它们的交集。这个交集中包含的就是那些已经在所有成员上执行了的事务GTID集合，称作全局完成的GTID集合。全局事务认证模块会将冲突检测数据库所有主键的快照版本和全局完成的GTID集合进行比对，如果快照版本中的GTID集合是全局完成的GTID集合的子集，则这个主键信息就会从冲突检测数据库中清除掉。<br>replication_group_member_stats表中的TRANSACTION_COMMITED_ALL_MEMBERS显示的就是全局完成的GTID集合。  <h4 id="计算基于主键的逻辑时钟"><a href="#计算基于主键的逻辑时钟" class="headerlink" title="计算基于主键的逻辑时钟"></a>计算基于主键的逻辑时钟</h4>在执行Binlog Event时，group replication采用了基于主键的并发机制。在这种机制中通过主键来判断是否修改了相同的数据，各种情况如下：</li><li>修改了不同数据的事务会安排并发执行。</li><li>修改了相同数据的事务会安排顺序执行。</li><li>DDL不能和任何事务并发执行，必须等待它前面的所有事务执行完毕后才能开始执行，后面的事务也必须要等待DDL执行完毕后，才能开始执行。<br>基于主键的并发机制，刚好可以通过逻辑时钟的方式来表达。因此group replication重用了多线程复制中Logical_clock并发复制的功能。基于主键的并发实现起来很简单，只需要根据主键信息计算出事务的逻辑时间，并更新Gtid_log_event中听last_committed和sequence_number的内容即可。group_replication_applier在执行这些事务时，按照Logical_clock方式进行并发就可以了，不需要任何改动。由于需要用到主键信息，因此计算过程是在冲突检测的过程中完成的。全局事务认证模块维护了一个全局事务的顺序号，它会给每个认证成功的事务分配一个顺序号。这个顺序号就是事务的sequence_number，会存储到冲突检测数据库中。当前事务的last_committed的计算和存储在冲突检测数据库中的sequence_number有关。首先，从冲突检测数据库中找出该事务修改的所有主键的sequence_number，即上一次被修改时的sequence_number，取其中的最大值来作为当前事务的last_committed。<br>假设正在处理的事务如下：<blockquote><p>UPDATE t1 SET c2 = 5 WHERE pk=1 OR pk =2;<br>冲突检测数据库中的顺序如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/A20F24C576B4491586110097130E61B0/42216" alt="image"><br>那么该事务的last_committed是120(120和33的最大值)。如果查不到上次记录，则将last_committed设置为上一次DDL的sequence_number，这保证DDL后面的事务不会和DDL并发执行。如果当前事务是DDL，则last_committed会设置成它自己的sequence_number-1，从而保证DDL前面的所有事务都被执行完后它才会被执行。</p></blockquote><h3 id="异地事务执行模块"><a href="#异地事务执行模块" class="headerlink" title="异地事务执行模块"></a>异地事务执行模块</h3>为了执行异地事务的Binlog Event，group replication会自动创建一个名为group_replication_applier的通道。这个通道的Receiver线程是关闭的，不会从其他成员上去复制Binlog Event。所有的Binlog Event都是由全局事务认证模块通过API写入Relay log的。Binlog Event的执行过程和异步复制没有区别，但是在执行过程中group_replication_applier所执行的事务使用了特权行锁。在对数据加行锁的时候，如果group_replication_applier发现有本地事务已经对数据加了行锁，那么group_replication_applier不会等待本地事务执行完毕，而是立刻将本地事务回滚掉，然后继续执行；而本地事务的Session则会返回错误。这其实很好理解，本地事务和group_replication_applier更新了同样的数据，而且是同时执行的，因此才会返回错误。即便本地事务到了全局事务认证模块，也会因此检测出冲突而被回滚掉。相比而言，由前者回滚本地事务效率更高。<h3 id="事务流程的总结"><a href="#事务流程的总结" class="headerlink" title="事务流程的总结"></a>事务流程的总结</h3>事务在group replication中的执行过程可以总结为三个部分：</li><li>网络传输。</li><li>事务在本地的执行过程。</li><li>事务在异地的执行过程。<h4 id="网络传输"><a href="#网络传输" class="headerlink" title="网络传输"></a>网络传输</h4>group replication通过Paxos协议来传播事务信息。Paxos保证所有的事务信息按照同样的顺序传播到所有的成员上，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/F41CB459A2C742A184F38407634D4BFF/42257" alt="image">  <h4 id="事务在本地成员上的执行过程"><a href="#事务在本地成员上的执行过程" class="headerlink" title="事务在本地成员上的执行过程"></a>事务在本地成员上的执行过程</h4>事务在本地提交时(prepare之后，写Binlog之前)，将事务信息发送至通信模块，然后开始等待事务认证结果。通信模块将事务排序后发送到本地成员的全局认证模块。全局认证模块做完冲突检测后，唤醒该事务继续执行(如果认证成功)或回滚(如果认证失败)，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/262EA905BF1049A6BF0747EBED444562/42274" alt="image">  <h4 id="事务在异地的执行过程"><a href="#事务在异地的执行过程" class="headerlink" title="事务在异地的执行过程"></a>事务在异地的执行过程</h4>通讯模块将事务排序后发到全局事务认证模块。全局认证模块认证成功后，将该事务的Binlog Event写入Relay log，由group_replication_applier通道来执行。如果全局事务认证失败，则会丢弃该事务的Binlog Event，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/AF94CE1CF3F646FF87BD1B4049B240AF/42287" alt="image">  <h2 id="深入理解成员加入组的过程"><a href="#深入理解成员加入组的过程" class="headerlink" title="深入理解成员加入组的过程"></a>深入理解成员加入组的过程</h2>group replication的主要逻辑可以划分为两部分：事务的执行逻辑和成员管理逻辑。上面已经介绍了事务的执行逻辑，下面来介绍成员的管理逻辑。<h3 id="组视图"><a href="#组视图" class="headerlink" title="组视图"></a>组视图</h3>成员管理中有一个很重要的概念叫作组视图(Group View)，或者简称为视图(View)。视图是指group replication组在一段时间内的成员状态。在这个时间段内没有成员变化，即没有成员加入也没有成员退出。如果成员发生了变化，成员状态就变化了，于是它就进入了另外一个视图。不同的视图之间通过视图ID(View ID)来进行区分。视图随时间的变化有先后顺序，因此View ID也是有先后顺序的。View ID被定义为两个部分，分别如下：  </li><li>前缀部分(固定部分)：前缀部分是一个随机数。这个值在组初始化时产生。之后，所有View的前缀部分都使用这个随机数，因此也被称为固定部分。</li><li>顺序号部分：顺序号部分是数值。初始化时，第一个视图的顺序号从1开始，以后每次视图变化顺序号递增。<br>用户可以通过replication_group_member_stats表查看当前的View ID。View ID显示格式如下：<blockquote><p>14870305055874300:2</p></blockquote><h3 id="加入组时视图的切换"><a href="#加入组时视图的切换" class="headerlink" title="加入组时视图的切换"></a>加入组时视图的切换</h3>当一个MySQL服务器加入组中，group replication插件首先会根据group_replication_group_seeds的内容和一个成员(种子成员)建立TCP连接。而种子成员会根据自己的IP白名单检查是否允许其接入。连接建立后，新成员会发送一个加入请求给种子成员，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/5AAD32035BD94793924F14F024565AB5/42326" alt="image"><br>收到请求后，种子成员广播视图变化的消息给所有成员(包括申请加入的成员)，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/E364021100CB465FAA23F3ECB4E47A54/42338" alt="image"><br>各个成员收到消息后开始做视图切换。首先，每个成员都会广播一个状态交换消息出去，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/85B1C1CF87564981A5FD4D1213101D55/42341" alt="image"><br>接着，各个成员开始接收状态交换消息。状态交换消息中包含了成员的当前状态和信息。成员收到状态交换信息后，将消息中的成员信息更新到自己的成员列表中。当收到所有成员中的最后一个状态交换消息时，通信模块将完整的新视图以视图数据包的形式返回给全局事务认证模块进行处理。整个视图的切换过程到此结束，视图切换的整个过程不影响在线成员对外提供服务。<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/C8D5BFBFA1DA44B5AE0CB5752220F0F2/42352" alt="image"><br>离开组时的视图切换和加入组的视图切换过程基本一样，略。<h3 id="View-change-log-event"><a href="#View-change-log-event" class="headerlink" title="View_change_log_event"></a>View_change_log_event</h3>状态交换消息和事务数据包一样都是通过Paxos协议发送的，因此它们之间也是有序的。事务数据包以视图数据包为分界线，划分到不同的视图中。它前面的事务数据包属于前一个视图的事务，而后面的数据包都是属于当前视图中的事务。全局事务认证模块会对每一个视图数据包创建一个View_change_log_event，这个Event会被写入Relay log，然后被执行，最终会出现在Binlog中，因此Binlog里的Event也被View_change_log_event划分到不同的视图中。View_change_log_event里面记录了当前的View ID，还有冲突检测数据库的信息。当记录View_change_log_event到Binlog中时，它会被封装到一个事务中，并且有自己的GTID，包括几个Events。  <blockquote><p>Gtid_log_event;<br>Query_log_event(“BEGIN”)<br>View_change_log_event;<br>Query_log_event(“COMMIT”)</p></blockquote><h3 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h3>视图切换完成后，成员就正式加入组内。它可以收到当前视图任何事务的数据包，但是视图切换前的数据包是收不到的。所以，在MySQL服务器加入组后，不能立即对外提供服务，而需要执行一些操作将自己缺失的数据从其他成员上复制过来。这个过程叫作恢复(Recovery)。一个成员加入组后，会立即将自己的状态设置为RECOVERING，开始执行恢复的过程。恢复过程分为本地恢复、全局恢复和缓存事务执行三个步骤。<h3 id="本地恢复-Local-Recovery"><a href="#本地恢复-Local-Recovery" class="headerlink" title="本地恢复(Local Recovery)"></a>本地恢复(Local Recovery)</h3>如果这个成员曾经加入过这个组，它的group_replication_applier通道的Relay log中可能还有一些Event没有被执行到数据库中。因此，group replication插件首先会启动group_replication_applier通道，将本地的Binlog Event执行完毕。<h3 id="全局恢复-Global-Recovery"><a href="#全局恢复-Global-Recovery" class="headerlink" title="全局恢复(Global Recovery)"></a>全局恢复(Global Recovery)</h3>本地恢复执行完毕后，开始进行全局恢复。全局恢复是通过group_replication_recovery进行的。group replication插件会随机选择一个在线成员作为这个通道的Master，这个被选择的成员叫作Donor。group replication插件会自动配置group_replication_recovery通道，并且启动这个通道进行复制，复制时使用的是GTID复制。全局恢复有容错能力，如果group_replication_recovery通道的接收线程(Receiver)无法连接到当前的Donor或当前Donor上的Binlog已经删除，则会选择其他成员作为Donor进行复制。在启动group_replication_recovery通道时，group replication插件会告诉它：当碰到View ID等于当前View ID的View_change_log_event时停止。当执行完到这个View_change_log_event后，group_replication_recovery通道会将空上Event中的冲突检测数据库初始化到group replication插件中，然后停止运行，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/DE962A8B547D446DA2D71CD5BB47D0DE/42409" alt="image">  <h3 id="缓存事务执行"><a href="#缓存事务执行" class="headerlink" title="缓存事务执行"></a>缓存事务执行</h3>在执行全局恢复过程的同时，全局事务认证模块还会收到当前视图中产生的事务数据包。这些数据包会被缓存起来直到全局恢复完毕后，全局事务认证模块才开始处理这些事务。当缓存的事务全部执行完毕后，该成员才能设置为ONLINE状态。当然用户也可以让成员在缓存的事务执行之前上线。group replication提供了参数group_replication_recovery_complete_at来控制上线时间。上线不仅仅是状态的改变，在多主模式时，上线意味着只读模式会被关闭，上线后成员就能够接收用户的写操作了。<h3 id="手动恢复"><a href="#手动恢复" class="headerlink" title="手动恢复"></a>手动恢复</h3>虽然group replication的恢复过程是很自动化的，但是并不完美，在有些情况下还是需要手动进行恢复的。  </li><li>当group replication运行了很长时间后，以前的Binlog可能已经删除了，这时就无法自动通过全局恢复来复制数据。</li><li>当要复制的Binlog很大时，使用异步复制的全局恢复效率比较低，不能短时间内完成。<br>当要加入组内的MySQL服务器符合以上情况时，可以先手动将数据库恢复到一个比较接近的时间点，然后再加入group replication组。<h2 id="运维相关问题"><a href="#运维相关问题" class="headerlink" title="运维相关问题"></a>运维相关问题</h2><h3 id="故障切换"><a href="#故障切换" class="headerlink" title="故障切换"></a>故障切换</h3>目前MySQL官方没有发布连接组复制专用的客户端（如MongoDB连接复制集的客户端），在实际的应用中如果发生故障，需要客户端自己来处理。对于单主模式的话，如果主节点发生故障，客户端需要判断新的主节点是谁，然后把写切换到新的主节点，基本上和当前的异步同步的主从切换一样，并且新的主节点是集群自动产生，不可控；多主模式需要在客户端进行节点可用性检查，当其中的一个写节点不可用时自动使用其他可用节点。<h3 id="大事务支持问题"><a href="#大事务支持问题" class="headerlink" title="大事务支持问题"></a>大事务支持问题</h3>目前版本测试并发进行大数据操作和DDL操作时，kill掉大事务，有几率造成集群不可用；在insert into …….select……limit……这种大事务支持不好，可能造成集群不用；多主模式进行DDL操作需要集群内所有节点都为ONLINE状态才可执行，处于ERROR和RECOVERING状态时有几率导致集群堵塞，严重时集群不可用。<h3 id="备份问题"><a href="#备份问题" class="headerlink" title="备份问题"></a>备份问题</h3>在组复制集群其中的一个节点上执行数据库备份时，不管使用mysqldump（这个不能使用–single-transaction参数，生产中不建议使用mysqldump备份集群数据）或是使用xtrabackup的QPS下降40%，并且备份节点基本停止读写。在测试备份文件导入数据时，多主模式要比单主模式慢。推荐使用组复制+异步复制方式，在异步复制的从节点上进行数据库备份。<h3 id="二进制日志删除问题"><a href="#二进制日志删除问题" class="headerlink" title="二进制日志删除问题"></a>二进制日志删除问题</h3>因为组复制同步还是基于二进制日志来进行同步的，清理某个节点bin-log时，必须判定这个日志文件是否还在使用，如果在使用，则绝对不能删除，如果删除，则整个集群直接ERROR。<h3 id="同步延迟问题"><a href="#同步延迟问题" class="headerlink" title="同步延迟问题"></a>同步延迟问题</h3>目前MySQL5.7.20的版本中无法直观查看节点同步延迟，也无法获取延迟多少，不管是时间或事物数，这个打开MySQL的Debug模式，可以获取到节点的延迟事务情况。<br>组复制的延迟对集群是有影响的，一旦出现延迟（默认延迟25000个事务），则启动流量控制（Flow Control），每个周期性能衰减当前的10%,直到集群不可用（但集群节点状态为online），单个节点慢整个集群全慢。<br>集群中的每个节点都会验证并应用该组提交的事务，有关校验和应用程序过程的统计信息对于了解应用程序队列如何增长，已找到多少冲突，检查了多少事务，在哪里提交了哪些事务等等非常有用。表 performance_schema.replication_group_member_stats 提供与事务认证过程的相关信息，但没有延迟信息。相关字段解释请参考文件<h3 id="数据一致性问题"><a href="#数据一致性问题" class="headerlink" title="数据一致性问题"></a>数据一致性问题</h3>不管是多写还是单写，都并非是强一致性，均允许有延迟，他在校验完事务是否冲突后把当前广播到各个节点并确定各个节点收到事务后即进入下一个事物的冲突检测，此时每个节点只是拿到了所有事务的执行序列，保证了事务最终顺序执行，从而保证数据的最终一致性，但同一时刻并非强一致性的。  <h3 id="节点故障脑裂问题"><a href="#节点故障脑裂问题" class="headerlink" title="节点故障脑裂问题"></a>节点故障脑裂问题</h3>节点越多性能损耗越大，三个节点比较合适。节点故障可能有脑裂等问题：如5个节点分布在两个机房，机房间网络断掉分为两个部分，2个集群的机房不可用，3个节点的可用，而三个节点的机房网络有问题，此时如果想使两个节点的机房可用，需要重新对两个节点做集群重组，三个节点的就无法恢复到两个节点中去；三节点中其中一个节点宕机，其他两个正常节点可用，故障节点重启没有加入到集群时，此时这个节点以单实例存在可读写，此时会发生脑裂。<br>###　弹性扩展问题<br>MySQL官方网站提到了组复制的弹性自动扩展，经过实际测试，这种扩展在生产中是不现实的。可用于生产的弹性扩展要求新加入一个集群，集群中的数据完全由集群来完成自动同步，但由于组复制是基于二进制日志来进行同步的，生产中是不可能完整保留全部的二进制日志，在新加入的节点需要先备份出集群的全量数据，然后根据同步位置去追事务达到数据的一致后节点状态online状态，其实和之前异步同步搭建主从一样。并且官方提示如果恢复时的延迟过大，可能也无法正常达到追到最新数据的位置。<h3 id="客户端连接问题"><a href="#客户端连接问题" class="headerlink" title="客户端连接问题"></a>客户端连接问题</h3>官方说明中关于故障处理的时候有一句话：组复制不处理客户端故障切换，它必须由应用程序本身，连接器或中间件框架（如代理或路由器）处理。<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2>参考<a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-frequently-asked-questions.html" target="_blank" rel="noopener">官方</a>文档<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2>目前MGR还不太成熟,但为MySQL的发展指明了方向,相信在未来的MySQL版本中,MGR能够越来越完善.</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;MySQL Group Replication简称MGR，又称MySQL组复制，是MySQL官方于2016年12月12日推出的一个全新的高可
      
    
    </summary>
    
      <category term="集群高可用" scheme="https://dwj999.github.io/categories/%E9%9B%86%E7%BE%A4%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    
    
      <category term="MGR" scheme="https://dwj999.github.io/tags/MGR/"/>
    
      <category term="Group Replication" scheme="https://dwj999.github.io/tags/Group-Replication/"/>
    
      <category term="MySQL Group Replication" scheme="https://dwj999.github.io/tags/MySQL-Group-Replication/"/>
    
  </entry>
  
  <entry>
    <title>Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7</title>
    <link href="https://dwj999.github.io/Aliyun-ECS%E6%90%AD%E5%BB%BAMHA-Keepalived-VIP-MySQL5-7.html"/>
    <id>https://dwj999.github.io/Aliyun-ECS搭建MHA-Keepalived-VIP-MySQL5-7.html</id>
    <published>2017-10-11T05:53:19.000Z</published>
    <updated>2020-05-20T03:22:11.264Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在Aliyun ECS结合MHA做MySQL的高可用，ECS不支持VIP，但阿里的产品高可用虚拟IP（HaVip）结合keepliaved等第三方软件可间接实现ip的漂移，可满足我们的需求。</p><h2 id="MHA简介"><a href="#MHA简介" class="headerlink" title="MHA简介"></a>MHA简介</h2><p>MHA是由日本MySQL专家youshimaton(现就职于Facebook公司)用Perl写的一套MySQL故障切换方案，以保障数据库的高可用性。在MySQL故障切换过程中，MHA能做到在0~30s之内实现主MySQL故障转移。<br>该软件由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）。MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p><h2 id="高可用虚拟IP限制"><a href="#高可用虚拟IP限制" class="headerlink" title="高可用虚拟IP限制"></a>高可用虚拟IP限制</h2><ul><li>每个VPC中最多只能同时存在5个vip对象</li><li>目前VPC中的网络通信不支持多播和广播，只支持单播；所以，如果用户是使用keepalived之类的第三方软件实现高可用，需要通过配置文件把通信方式改成单播；网上可以找到相应的方法 </li><li>如果是使用keepalived之类的第三方软件，需要把信条消息的源IP改成ECS的私网IP（而不要用HaVip的私网IP进行心跳检查），不然很容易造成脑裂</li><li>当HaVip与EIP绑定后，进行公网通信时，持有HaVip的ECS实例应该通过HaVip的私网ip进行公网通信（而不是ECS自己的私网IP）；因为这时EIP是映射在HaVip的私网IP上，而不是映射在ECS的私网IP上</li><li>类似的，当使用HaVip做自建SNAT网关的高可用时，SNAT实例上配置的SNAT规则中，source IP应该是havip的私网IP而不是自己的private IP</li></ul><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：Linux Centos 6.5<br>master：192.168.16.80<br>slave: 192.168.16.81<br>vip: 192.168.16.82  （<font color="#FF0000">注：需要和HaVip的私网IP一致</font>）<br>其中，使用两台机器，分别部署主库和从库，MHA默认部署在从库上，下方中的VIP通EIP，最终是要把EIP和HaVip绑定在一起  </p><h2 id="系统初始化修改"><a href="#系统初始化修改" class="headerlink" title="系统初始化修改"></a>系统初始化修改</h2><h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><h4 id="主库修改主机名"><a href="#主库修改主机名" class="headerlink" title="主库修改主机名"></a>主库修改主机名</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cat</span> /etc/sysconfig/network|grep HOSTNAME</span><br><span class="line"><span class="attr">HOSTNAME=</span><span class="literal">master</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cat</span> /etc/hosts|grep <span class="literal">master</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">16.80</span> <span class="literal">master</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]#</span></span><br></pre></td></tr></table></figure><h4 id="从库修改主机名"><a href="#从库修改主机名" class="headerlink" title="从库修改主机名"></a>从库修改主机名</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="literal">slave</span> ~]<span class="comment"># cat /etc/sysconfig/network|grep HOSTNAME</span></span><br><span class="line"><span class="attr">HOSTNAME=</span><span class="literal">slave</span></span><br><span class="line">[root@<span class="literal">slave</span> ~]<span class="comment"># cat /etc/hosts|grep slave</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">16.81</span> <span class="literal">slave</span></span><br><span class="line">[root@<span class="literal">slave</span> ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="设置防火墙"><a href="#设置防火墙" class="headerlink" title="设置防火墙"></a>设置防火墙</h3><h4 id="主库设置，允许从库访问"><a href="#主库设置，允许从库访问" class="headerlink" title="主库设置，允许从库访问"></a>主库设置，允许从库访问</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/iptables status|grep <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span></span><br><span class="line"><span class="number">11</span>   ACCEPT     all  --  <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>        <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>           </span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure><p>其中，192.168.16.81是允许从库的访问规则</p><h4 id="从库设置，允许主库访问"><a href="#从库设置，允许主库访问" class="headerlink" title="从库设置，允许主库访问"></a>从库设置，允许主库访问</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# /etc/init.d/iptables status|grep <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span></span><br><span class="line"><span class="number">11</span>   ACCEPT     all  --  <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>        <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>           </span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure><p>其中，192.168.16.80是允许主库的访问规则</p><h3 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h3><h4 id="主库查看"><a href="#主库查看" class="headerlink" title="主库查看"></a>主库查看</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@master</span> ~]<span class="meta"># cat /etc/sysconfig/selinux |grep -v <span class="string">'#'</span> |grep <span class="string">'SELINUX='</span> </span></span><br><span class="line">SELINUX=disabled</span><br><span class="line">[root<span class="symbol">@master</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure><h4 id="从库查看"><a href="#从库查看" class="headerlink" title="从库查看"></a>从库查看</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># cat /etc/sysconfig/selinux |grep -v <span class="string">'#'</span> |grep <span class="string">'SELINUX='</span> </span></span><br><span class="line">SELINUX=disabled</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure><h2 id="建立SSH无密码登录"><a href="#建立SSH无密码登录" class="headerlink" title="建立SSH无密码登录"></a>建立SSH无密码登录</h2><h3 id="主库设置"><a href="#主库设置" class="headerlink" title="主库设置"></a>主库设置</h3><p>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,同时AllowUsers把root也添加上,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# sed</span> '/^<span class="comment">#/d;/^$/d' /etc/ssh/ssh_config |grep GSSAPIAuthentication</span></span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# sed</span> '/^<span class="comment">#/d;/^$/d' /etc/ssh/sshd_config |grep -E 'PasswordAuthentication|PermitRootLogin'</span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# /etc</span>/init.d/sshd restart</span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cat</span> /etc/hosts.allow |grep <span class="number">192.168</span>.<span class="number">16.81</span></span><br><span class="line">sshd: <span class="number">192.168</span>.<span class="number">16.81</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]#</span></span><br></pre></td></tr></table></figure></p><p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="meta"># ssh-keygen </span></span><br><span class="line">Generating <span class="keyword">public</span>/<span class="keyword">private</span> rsa <span class="keyword">key</span> pair.</span><br><span class="line">Enter file <span class="keyword">in</span> which <span class="keyword">to</span> save the <span class="keyword">key</span> (/root/.ssh/id_rsa): </span><br><span class="line">Created directory <span class="comment">'/root/.ssh'.</span></span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your <span class="keyword">public</span> <span class="keyword">key</span> has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The <span class="keyword">key</span> fingerprint <span class="keyword">is</span>:</span><br><span class="line"><span class="number">07</span>:<span class="number">86</span>:<span class="number">76</span>:d6:<span class="number">4</span>a:<span class="number">0</span>f:ea:<span class="number">6</span>e:<span class="number">88</span>:<span class="number">00</span>:eb:<span class="number">3</span>d:<span class="number">5</span>f:<span class="number">7</span>e:<span class="number">08</span>:<span class="number">7</span>a root@master</span><br><span class="line">The <span class="keyword">key</span><span class="comment">'s randomart image is:</span></span><br><span class="line">+--[ RSA <span class="number">2048</span>]----+</span><br><span class="line">|                 |</span><br><span class="line">|       . .       |</span><br><span class="line">|      o B .      |</span><br><span class="line">|.    . * =       |</span><br><span class="line">|..    . S o      |</span><br><span class="line">|o    o   .       |</span><br><span class="line">|......o..        |</span><br><span class="line">| ..+.E+. .       |</span><br><span class="line">|    +o...        |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@master ~]<span class="meta"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.81</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">'192.168.16.81 (192.168.16.81)' can't be established.</span></span><br><span class="line">RSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> <span class="number">9</span>f:<span class="number">1</span>f:<span class="number">41</span>:f6:<span class="number">2</span>d:e9:<span class="number">20</span>:<span class="number">83</span>:<span class="number">30</span>:be:cd:<span class="number">20</span>:<span class="number">01</span>:<span class="number">31</span>:ea:<span class="number">6</span>d.</span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added <span class="comment">'192.168.16.81' (RSA) to the list of known hosts.</span></span><br><span class="line">root@<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span><span class="comment">'s password: </span></span><br><span class="line">Now <span class="keyword">try</span> logging <span class="keyword">into</span> the machine, <span class="keyword">with</span> <span class="string">"ssh 'root@192.168.16.81'"</span>, <span class="keyword">and</span> check <span class="keyword">in</span>:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="keyword">to</span> make sure we haven<span class="comment">'t added extra keys that you weren't expecting.</span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="meta"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.80</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">'192.168.16.80 (192.168.16.80)' can't be established.</span></span><br><span class="line">RSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> f2:f8:<span class="number">7</span>d:<span class="number">7</span>d:<span class="number">59</span>:<span class="number">3</span>f:b9:<span class="number">3</span>c:a0:e6:<span class="number">66</span>:<span class="number">54</span>:<span class="number">1</span>f:<span class="number">79</span>:e2:<span class="number">40.</span></span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">root@<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span><span class="comment">'s password: </span></span><br><span class="line">Now <span class="keyword">try</span> logging <span class="keyword">into</span> the machine, <span class="keyword">with</span> <span class="string">"ssh 'root@192.168.16.80'"</span>, <span class="keyword">and</span> check <span class="keyword">in</span>:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="keyword">to</span> make sure we haven<span class="comment">'t added extra keys that you weren't expecting.</span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p><p>测试登录<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ssh root@192.168.16.81</span><br><span class="line">Last login: Wed Oct 11 14:45:10 2017 <span class="keyword">from</span> 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome <span class="keyword">to</span> aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@slave ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection <span class="keyword">to</span> 192.168.16.81 closed.</span><br><span class="line">[root@master ~]# ssh root@192.168.16.80</span><br><span class="line">Last login: Wed Jan 18 16:25:59 2017</span><br><span class="line"></span><br><span class="line">Welcome <span class="keyword">to</span> aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@master ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection <span class="keyword">to</span> 192.168.16.80 closed.</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p><h3 id="从库设置"><a href="#从库设置" class="headerlink" title="从库设置"></a>从库设置</h3><p>和主库保持一致<br>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,同时AllowUsers把root也添加上,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接  </p><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># sed <span class="string">'/^#/d;/^$/d'</span> /etc/ssh/ssh_config |grep GSSAPIAuthentication</span></span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># sed <span class="string">'/^#/d;/^$/d'</span> /etc/ssh/sshd_config |grep -E <span class="string">'PasswordAuthentication|PermitRootLogin'</span></span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># /etc/init.d/sshd restart</span></span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># cat /etc/hosts.allow |grep 192.168.16.80</span></span><br><span class="line">sshd: <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span></span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure><p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="meta"># ssh-keygen </span></span><br><span class="line">Generating <span class="keyword">public</span>/<span class="keyword">private</span> rsa <span class="keyword">key</span> pair.</span><br><span class="line">Enter file <span class="keyword">in</span> which <span class="keyword">to</span> save the <span class="keyword">key</span> (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your <span class="keyword">public</span> <span class="keyword">key</span> has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The <span class="keyword">key</span> fingerprint <span class="keyword">is</span>:</span><br><span class="line">ae:<span class="number">04</span>:<span class="number">32</span>:<span class="number">4</span>d:<span class="number">3</span>e:d3:b7:<span class="number">5</span>d:<span class="number">4</span>e:d2:<span class="number">50</span>:<span class="number">7</span>a:<span class="number">4</span>c:<span class="number">44</span>:d7:<span class="number">0</span>a root@slave</span><br><span class="line">The <span class="keyword">key</span><span class="comment">'s randomart image is:</span></span><br><span class="line">+--[ RSA <span class="number">2048</span>]----+</span><br><span class="line">|           o= .. |</span><br><span class="line">|           =E.  .|</span><br><span class="line">|    .     o o. . |</span><br><span class="line">|   + .     +  .  |</span><br><span class="line">|  o * . S . +    |</span><br><span class="line">|   o + o o =     |</span><br><span class="line">|      . o . .    |</span><br><span class="line">|     . .         |</span><br><span class="line">|      .          |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@slave ~]<span class="meta"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.80</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">'192.168.16.80 (192.168.16.80)' can't be established.</span></span><br><span class="line">RSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> f2:f8:<span class="number">7</span>d:<span class="number">7</span>d:<span class="number">59</span>:<span class="number">3</span>f:b9:<span class="number">3</span>c:a0:e6:<span class="number">66</span>:<span class="number">54</span>:<span class="number">1</span>f:<span class="number">79</span>:e2:<span class="number">40.</span></span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added <span class="comment">'192.168.16.80' (RSA) to the list of known hosts.</span></span><br><span class="line">root@<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span><span class="comment">'s password: </span></span><br><span class="line">Now <span class="keyword">try</span> logging <span class="keyword">into</span> the machine, <span class="keyword">with</span> <span class="string">"ssh 'root@192.168.16.80'"</span>, <span class="keyword">and</span> check <span class="keyword">in</span>:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="keyword">to</span> make sure we haven<span class="comment">'t added extra keys that you weren't expecting.</span></span><br><span class="line"></span><br><span class="line">[root@slave ~]<span class="meta"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.81</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">'192.168.16.81 (192.168.16.81)' can't be established.</span></span><br><span class="line">RSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> <span class="number">9</span>f:<span class="number">1</span>f:<span class="number">41</span>:f6:<span class="number">2</span>d:e9:<span class="number">20</span>:<span class="number">83</span>:<span class="number">30</span>:be:cd:<span class="number">20</span>:<span class="number">01</span>:<span class="number">31</span>:ea:<span class="number">6</span>d.</span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added <span class="comment">'192.168.16.81' (RSA) to the list of known hosts.</span></span><br><span class="line">root@<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span><span class="comment">'s password: </span></span><br><span class="line">Now <span class="keyword">try</span> logging <span class="keyword">into</span> the machine, <span class="keyword">with</span> <span class="string">"ssh 'root@192.168.16.81'"</span>, <span class="keyword">and</span> check <span class="keyword">in</span>:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="keyword">to</span> make sure we haven<span class="comment">'t added extra keys that you weren't expecting.</span></span><br><span class="line"></span><br><span class="line">[root@slave ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p><p>测试登录<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ssh root@192.168.16.80</span><br><span class="line">Last login: Wed Oct 11 14:48:14 2017 <span class="keyword">from</span> 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome <span class="keyword">to</span> aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@master ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection <span class="keyword">to</span> 192.168.16.80 closed.</span><br><span class="line">[root@slave ~]# ssh root@192.168.16.81</span><br><span class="line">Last login: Wed Oct 11 14:48:10 2017 <span class="keyword">from</span> 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome <span class="keyword">to</span> aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@slave ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection <span class="keyword">to</span> 192.168.16.81 closed.</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p><h2 id="MySQL安装"><a href="#MySQL安装" class="headerlink" title="MySQL安装"></a>MySQL安装</h2><p>使用的是自己打包的RPM包，分别登录主库和从库，直接rpm -ivh percona-server-5.7.18-15.x86_64.rpm 即可，也可使用其他方式安装MySQL<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mv /home/duanwenjie/percona-server<span class="number">-5.7</span><span class="number">.18</span><span class="number">-15.</span>x86_64.rpm /usr/src/</span><br><span class="line">[root@master ~]# rpm -ivh /usr/src/percona-server<span class="number">-5.7</span><span class="number">.18</span><span class="number">-15.</span>x86_64.rpm </span><br><span class="line">Preparing...                ########################################### [<span class="number">100</span>%]</span><br><span class="line">Group <span class="string">'mail'</span> not found. Creating the user mailbox file <span class="keyword">with</span> <span class="number">0600</span> mode.</span><br><span class="line">   <span class="number">1</span>:percona-server         ########################################### [<span class="number">100</span>%]</span><br><span class="line">error reading information on service /etc/rc.d/init.d/mysqld: No such file or directory</span><br><span class="line">MySQL (Percona Server) PID file could not be found![FAILED]</span><br><span class="line">Starting MySQL (Percona Server)...[  OK  ]</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Warning: Since password will be sent to server <span class="keyword">in</span> plain text, use ssl connection to ensure password safety.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p><p>查看是否安装成功,分别登录主库和从库<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">12</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">03</span>:<span class="number">27</span> &gt; select <span class="built_in">version</span>();</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| <span class="built_in">version</span>()     |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">03</span>:<span class="number">31</span> &gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@master ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p><h2 id="MySQL互为主备"><a href="#MySQL互为主备" class="headerlink" title="MySQL互为主备"></a>MySQL互为主备</h2><h3 id="重要参数配置"><a href="#重要参数配置" class="headerlink" title="重要参数配置"></a>重要参数配置</h3><p>主库必须包含以下参数<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># cat /etc/my.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 1</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 1</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br></pre></td></tr></table></figure></p><p>从库必须包含以下参数，注意slave需要动态设置read_only=1<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/my.cnf </span><br><span class="line"><span class="meta">[mysqld]</span></span><br><span class="line">server-id = 2</span><br><span class="line">autocommit = 1</span><br><span class="line">auto<span class="emphasis">_increment_</span>increment = 2</span><br><span class="line">auto<span class="emphasis">_increment_</span>offset = 2</span><br><span class="line">log<span class="emphasis">_bin = mysql-bin</span></span><br><span class="line"><span class="emphasis">gtid_</span>mode = on</span><br><span class="line">enforce<span class="emphasis">_gtid_</span>consistency = 1</span><br><span class="line">log<span class="emphasis">_slave_</span>updates</span><br><span class="line">relay<span class="emphasis">_log_</span>purge=0</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e "show variables like <span class="emphasis">'read_only'</span>"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| read_</span>only     | OFF   |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e "set global read<span class="emphasis">_only=1"</span></span><br><span class="line"><span class="emphasis">Enter password: </span></span><br><span class="line"><span class="emphasis">[root@slave ~]# mysql -uroot -p -e "show variables like 'read_</span>only'"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| read_</span>only     | ON    |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p><h3 id="复制帐号建立"><a href="#复制帐号建立" class="headerlink" title="复制帐号建立"></a>复制帐号建立</h3><p>由于MySQL版本使用的是5.7，创建用户的方法以之前有些不同</p><h4 id="主库创建"><a href="#主库创建" class="headerlink" title="主库创建"></a>主库创建</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands end <span class="keyword">with</span> ; <span class="keyword">or</span> <span class="string">\g.</span></span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">4</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. Type <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">09</span>:<span class="number">37</span> &gt; create user <span class="string">'slave01'</span>@<span class="string">'192.168.16.81'</span> identified <span class="keyword">by</span> <span class="string">'slave123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">10</span>:<span class="number">13</span> &gt; grant replication slave,replication client <span class="literal">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'192.168.16.81'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">10</span>:<span class="number">39</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">10</span>:<span class="number">42</span> &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@master ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h4 id="从库创建"><a href="#从库创建" class="headerlink" title="从库创建"></a>从库创建</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands end <span class="keyword">with</span> ; <span class="keyword">or</span> <span class="string">\g.</span></span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">7</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. Type <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">11</span>:<span class="number">18</span> &gt; create user <span class="string">'slave01'</span>@<span class="string">'192.168.16.80'</span> identified <span class="keyword">by</span> <span class="string">'slave123456'</span>; </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">11</span>:<span class="number">30</span> &gt; grant replication slave,replication client <span class="literal">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'192.168.16.80'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">11</span>:<span class="number">40</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">11</span>:<span class="number">43</span> &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@slave ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="复制帐号验证"><a href="#复制帐号验证" class="headerlink" title="复制帐号验证"></a>复制帐号验证</h3><p>主库登录从库<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uslave01 -pslave123456 -h192.168.16.81 -e "select version()" </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">| version()     |</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">| 5.7.18-15-log |</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p><p>从库登录主库<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uslave01 -pslave123456 -h192.168.16.80 -e "select version()" </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">| version()     |</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">| 5.7.18-15-log |</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p><h3 id="复制关系配置"><a href="#复制关系配置" class="headerlink" title="复制关系配置"></a>复制关系配置</h3><h4 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h4><p>登录主库，设置复制关系，来源于从库的复制<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-p</span></span><br><span class="line"><span class="string">Enter</span> <span class="attr">password:</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">the</span> <span class="string">MySQL</span> <span class="string">monitor.</span>  <span class="string">Commands</span> <span class="string">end</span> <span class="string">with</span> <span class="string">;</span> <span class="string">or</span> <span class="string">\g.</span></span><br><span class="line"><span class="string">Your</span> <span class="string">MySQL</span> <span class="string">connection</span> <span class="string">id</span> <span class="string">is</span> <span class="number">6</span></span><br><span class="line"><span class="string">Server</span> <span class="attr">version:</span> <span class="number">5.7</span><span class="number">.18</span><span class="bullet">-15</span><span class="bullet">-log</span> <span class="string">PLD/Linux</span> <span class="string">Distribution</span> <span class="string">Percona</span> <span class="string">Server</span> <span class="string">RPM</span></span><br><span class="line"></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2009</span><span class="bullet">-2017</span> <span class="string">Percona</span> <span class="string">LLC</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2000</span><span class="string">,</span> <span class="number">2017</span><span class="string">,</span> <span class="string">Oracle</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates.</span> <span class="string">All</span> <span class="string">rights</span> <span class="string">reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Oracle</span> <span class="string">is</span> <span class="string">a</span> <span class="string">registered</span> <span class="string">trademark</span> <span class="string">of</span> <span class="string">Oracle</span> <span class="string">Corporation</span> <span class="string">and/or</span> <span class="string">its</span></span><br><span class="line"><span class="string">affiliates.</span> <span class="string">Other</span> <span class="string">names</span> <span class="string">may</span> <span class="string">be</span> <span class="string">trademarks</span> <span class="string">of</span> <span class="string">their</span> <span class="string">respective</span></span><br><span class="line"><span class="string">owners.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Type</span> <span class="string">'help;'</span> <span class="string">or</span> <span class="string">'\h'</span> <span class="string">for</span> <span class="string">help.</span> <span class="string">Type</span> <span class="string">'\c'</span> <span class="string">to</span> <span class="string">clear</span> <span class="string">the</span> <span class="string">current</span> <span class="string">input</span> <span class="string">statement.</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">15</span><span class="string">:14:07</span> <span class="string">&gt; change master to master_host='192.168.16.81',master_user='slave01',master_password='slave123456',master_auto_position=1;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected, 2 warnings (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 15:14:46 &gt; start slave;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.04 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 15:14:49 &gt; show slave status\G</span></span><br><span class="line"><span class="string">*************************** 1. row ***************************</span></span><br><span class="line"><span class="string"></span><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">slave01</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">812</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">master-relay-bin.000002</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">1025</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">812</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">1233</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="string">e1ec82e8-ae51-11e7-8532-00163e128057</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">mysql.slave_master_info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">more</span> <span class="string">updates</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="attr">e1ec82e8-ae51-11e7-8532-00163e128057:1-3</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="attr">df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3,</span></span><br><span class="line"><span class="attr">e1ec82e8-ae51-11e7-8532-00163e128057:</span><span class="number">1</span><span class="bullet">-3</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </span><br><span class="line"><span class="attr">                 Channel_Name:</span> </span><br><span class="line"><span class="attr">           Master_TLS_Version:</span> </span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">15</span><span class="string">:14:56</span> <span class="string">&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h4><p>登录从库，设置复制关系，来源于主库的复制<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@slave</span> <span class="string">~]#</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-p</span></span><br><span class="line"><span class="string">Enter</span> <span class="attr">password:</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">the</span> <span class="string">MySQL</span> <span class="string">monitor.</span>  <span class="string">Commands</span> <span class="string">end</span> <span class="string">with</span> <span class="string">;</span> <span class="string">or</span> <span class="string">\g.</span></span><br><span class="line"><span class="string">Your</span> <span class="string">MySQL</span> <span class="string">connection</span> <span class="string">id</span> <span class="string">is</span> <span class="number">11</span></span><br><span class="line"><span class="string">Server</span> <span class="attr">version:</span> <span class="number">5.7</span><span class="number">.18</span><span class="bullet">-15</span><span class="bullet">-log</span> <span class="string">PLD/Linux</span> <span class="string">Distribution</span> <span class="string">Percona</span> <span class="string">Server</span> <span class="string">RPM</span></span><br><span class="line"></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2009</span><span class="bullet">-2017</span> <span class="string">Percona</span> <span class="string">LLC</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2000</span><span class="string">,</span> <span class="number">2017</span><span class="string">,</span> <span class="string">Oracle</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates.</span> <span class="string">All</span> <span class="string">rights</span> <span class="string">reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Oracle</span> <span class="string">is</span> <span class="string">a</span> <span class="string">registered</span> <span class="string">trademark</span> <span class="string">of</span> <span class="string">Oracle</span> <span class="string">Corporation</span> <span class="string">and/or</span> <span class="string">its</span></span><br><span class="line"><span class="string">affiliates.</span> <span class="string">Other</span> <span class="string">names</span> <span class="string">may</span> <span class="string">be</span> <span class="string">trademarks</span> <span class="string">of</span> <span class="string">their</span> <span class="string">respective</span></span><br><span class="line"><span class="string">owners.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Type</span> <span class="string">'help;'</span> <span class="string">or</span> <span class="string">'\h'</span> <span class="string">for</span> <span class="string">help.</span> <span class="string">Type</span> <span class="string">'\c'</span> <span class="string">to</span> <span class="string">clear</span> <span class="string">the</span> <span class="string">current</span> <span class="string">input</span> <span class="string">statement.</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">15</span><span class="string">:15:42</span> <span class="string">&gt; change master to master_host='192.168.16.80',master_user='slave01',master_password='slave123456',master_auto_position=1;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected, 2 warnings (0.05 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 15:15:53 &gt; start slave;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.04 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 15:15:55 &gt; show slave status\G</span></span><br><span class="line"><span class="string">*************************** 1. row ***************************</span></span><br><span class="line"><span class="string"></span><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">slave01</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">1470</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">slave-relay-bin.000002</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">1072</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">1470</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">1279</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="string">df5051fc-ae51-11e7-85ee-00163e0f0e4a</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">mysql.slave_master_info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">more</span> <span class="string">updates</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="attr">df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="attr">df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3,</span></span><br><span class="line"><span class="attr">e1ec82e8-ae51-11e7-8532-00163e128057:</span><span class="number">1</span><span class="bullet">-3</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </span><br><span class="line"><span class="attr">                 Channel_Name:</span> </span><br><span class="line"><span class="attr">           Master_TLS_Version:</span> </span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">15</span><span class="string">:16:00</span> <span class="string">&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="复制测试"><a href="#复制测试" class="headerlink" title="复制测试"></a>复制测试</h3><h4 id="主库登录测试"><a href="#主库登录测试" class="headerlink" title="主库登录测试"></a>主库登录测试</h4><p>登录主库，插入测试数据<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MySQL [test11] 15:17:10 &gt; create table if not exists t11(id int unsigned not null auto<span class="emphasis">_increment,name varchar(20),primary key(`id`));</span></span><br><span class="line"><span class="emphasis">Query OK, 0 rows affected (0.04 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">MySQL [test11] 15:17:20 &gt; insert into t11 values(null,'master11');</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">MySQL [test11] 15:17:28 &gt; select * from t11;</span></span><br><span class="line"><span class="emphasis">+----+----------+</span></span><br><span class="line"><span class="emphasis">| id | name     |</span></span><br><span class="line"><span class="emphasis">+----+----------+</span></span><br><span class="line"><span class="emphasis">|  1 | master11 |</span></span><br><span class="line"><span class="emphasis">+----+----------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br></pre></td></tr></table></figure></p><p>登录从库，查看测试数据，此时数据已经复制过来<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p test11 -e "select * from t11"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+----+</span>----------+</span><br><span class="line">| id | name     |</span><br><span class="line"><span class="code">+----+</span>----------+</span><br><span class="line">|  1 | master11 |</span><br><span class="line"><span class="code">+----+</span>----------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p><h4 id="从库登录测试"><a href="#从库登录测试" class="headerlink" title="从库登录测试"></a>从库登录测试</h4><p>登录从库，插入测试数据<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 15:18:56 &gt; <span class="keyword">create</span> <span class="keyword">database</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> test11;use test11;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] 15:19:20 &gt; <span class="keyword">create</span> table <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> t22(id int unsigned <span class="keyword">not</span> <span class="literal">null</span> auto_increment,name varchar(<span class="number">20</span>),<span class="keyword">primary</span> <span class="keyword">key</span>(<span class="symbol">`id`</span>));</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:38 &gt; <span class="keyword">insert</span> <span class="keyword">into</span> t22 <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">'slave11'</span>); </span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:43 &gt; <span class="keyword">select</span> * <span class="keyword">from</span> t22;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  2 | slave11 |</span><br><span class="line">+----+---------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:51 &gt;</span><br></pre></td></tr></table></figure></p><p>登录主库，查看测试数据，此时数据已经复制过来<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p test11 -e "select * from t22"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+----+</span>---------+</span><br><span class="line">| id | name    |</span><br><span class="line"><span class="code">+----+</span>---------+</span><br><span class="line">|  2 | slave11 |</span><br><span class="line"><span class="code">+----+</span>---------+</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p><h3 id="MHA帐号创建"><a href="#MHA帐号创建" class="headerlink" title="MHA帐号创建"></a>MHA帐号创建</h3><h4 id="主库创建-1"><a href="#主库创建-1" class="headerlink" title="主库创建"></a>主库创建</h4><p>登录主库，创建允许主库和从库连接的MHA用户信息，再分别尝试使用MHA用户登录(省略)<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">29</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">23</span>:<span class="number">16</span> &gt; <span class="keyword">create</span> user <span class="string">'mha01'</span>@<span class="string">'192.168.16.81'</span> identified <span class="keyword">by</span> <span class="string">'mha123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">24</span>:<span class="number">02</span> &gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha01'</span>@<span class="string">'192.168.16.81'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">24</span>:<span class="number">27</span> &gt; <span class="keyword">create</span> user <span class="string">'mha01'</span>@<span class="string">'192.168.16.80'</span> identified <span class="keyword">by</span> <span class="string">'mha123456'</span>; </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">24</span>:<span class="number">35</span> &gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha01'</span>@<span class="string">'192.168.16.80'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">24</span>:<span class="number">41</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p><h4 id="从库创建-1"><a href="#从库创建-1" class="headerlink" title="从库创建"></a>从库创建</h4><p>登录从库，由于复制已经把在主库创建的MHA用户信息复制了过来，尝试登录即可(省略)</p><h2 id="MHA安装"><a href="#MHA安装" class="headerlink" title="MHA安装"></a>MHA安装</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>分别在主库和从库上安装，执行命令：<br>yum -y install gcc gcc-c++ make openssl-devel perl perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Config-IniFiles perl-Time-HiRes perl-Module-Install.noarch mailx jwhois cpan  </p><h3 id="主库安装mha4mysql-node"><a href="#主库安装mha4mysql-node" class="headerlink" title="主库安装mha4mysql-node"></a>主库安装mha4mysql-node</h3><p>MHA管理端安装在从库上，主库上只需要mha4mysql-node即可，由于MySQL使用5.7版本，MHA也使用最新的0.57版本，采用编译安装方式。下载地址：<a href="https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw" target="_blank" rel="noopener">https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw</a><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cd</span> /usr/src/</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">src</span>]<span class="comment"># tar -zxf mha4mysql-node-0.57.tar.gz</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># perl Makefile.PL             #编译过程省略</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># make</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># make install</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># ll /usr/local/bin/ -t        #查看安装，有以下文件则mha4mysql-node安装成功</span></span><br><span class="line">total <span class="number">1760</span></span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root  <span class="number">16381</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">8261</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> purge_relay_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">7525</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> save_binary_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">4807</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p><h3 id="从库安装mha4mysql-manager和mha4mysql-node"><a href="#从库安装mha4mysql-manager和mha4mysql-node" class="headerlink" title="从库安装mha4mysql-manager和mha4mysql-node"></a>从库安装mha4mysql-manager和mha4mysql-node</h3><p>MHA管理端安装在从库，从库需要安装manager端和node端<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># cd /usr/src/</span></span><br><span class="line">[root@slave src]<span class="comment"># tar -zxf mha4mysql-manager-0.57.tar.gz </span></span><br><span class="line">[root@slave src]<span class="comment"># cd mha4mysql-manager-0.57</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># perl Makefile.PL           #编译过程省略</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># make</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># make install </span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># ll /usr/local/bin/ -t      #查看安装，有以下文件则mha4mysql-manager安装成功</span></span><br><span class="line">total 40</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 1779 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_ssh</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 2517 </span>Oct<span class="number"> 11 </span>15:45 masterha_manager</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 2373 </span>Oct<span class="number"> 11 </span>15:45 masterha_master_switch</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 5171 </span>Oct<span class="number"> 11 </span>15:45 masterha_secondary_check</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 1995 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_repl</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 1865 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_status</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 3201 </span>Oct<span class="number"> 11 </span>15:45 masterha_conf_host</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 2165 </span>Oct<span class="number"> 11 </span>15:45 masterha_master_monitor</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 1739 </span>Oct<span class="number"> 11 </span>15:45 masterha_stop</span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># cd ..</span></span><br><span class="line">[root@slave src]<span class="comment"># tar -zxf mha4mysql-node-0.57.tar.gz </span></span><br><span class="line">[root@slave src]<span class="comment"># cd mha4mysql-node-0.57</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># perl Makefile.PL              #编译过程省略        </span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># make</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># make install</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># ll /usr/local/bin/ -t         #查看安装，有以下文件则mha4mysql-node安装成功</span></span><br><span class="line">total 84</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 16381 </span>Oct<span class="number"> 11 </span>15:47 apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root <span class="number"> 4807 </span>Oct<span class="number"> 11 </span>15:47 filter_mysqlbinlog</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root <span class="number"> 8261 </span>Oct<span class="number"> 11 </span>15:47 purge_relay_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root <span class="number"> 7525 </span>Oct<span class="number"> 11 </span>15:47 save_binary_logs</span><br></pre></td></tr></table></figure></p><h2 id="MHA目录结构说明"><a href="#MHA目录结构说明" class="headerlink" title="MHA目录结构说明"></a>MHA目录结构说明</h2><h3 id="MHAManager"><a href="#MHAManager" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>mhamanager工具包主要包括以下工具<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@slave  ~]<span class="comment"># ll /usr/local/bin/</span></span><br><span class="line">总用量 40</span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1995 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_repl         <span class="comment">#检查MySQL复制情况</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1779 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_ssh          <span class="comment">#检查MHA的SSH配置情况</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1865 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_status       <span class="comment">#检测当前MHA运行状态</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 3201 </span>Oct<span class="number"> 11 </span>15:45 masterha_conf_host          <span class="comment">#添加或删除配置的server信息</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2517 </span>Oct<span class="number"> 11 </span>15:45 masterha_manager            <span class="comment">#启动MHA</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2165 </span>Oct<span class="number"> 11 </span>15:45 masterha_master_monitor     <span class="comment">#检测Master是否宕机</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2373 </span>Oct<span class="number"> 11 </span>15:45 masterha_master_switch      <span class="comment">#控制故障转移，自动或者手动</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 5172 </span>Oct<span class="number"> 11 </span>15:45 masterha_secondary_check    <span class="comment">#通过其他路由检测Master是否真的宕机</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1739 </span>Oct<span class="number"> 11 </span>15:45 masterha_stop               <span class="comment">#停止MHA</span></span><br></pre></td></tr></table></figure></p><h3 id="MHANode"><a href="#MHANode" class="headerlink" title="MHANode"></a>MHANode</h3><p>mhanode工具包主要包括以下工具<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># ll /usr/local/bin/ -t   </span></span><br><span class="line">total 84</span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root<span class="number"> 16371 </span>Oct<span class="number"> 11 </span>15:47 apply_diff_relay_logs       <span class="comment">#识别差异日志的中继日志，并将其差异事件应用于其他Slave</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 4807 </span>Oct<span class="number"> 11 </span>15:47 filter_mysqlbinlog          <span class="comment">#去除不必要的Rollback事件</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 8263 </span>Oct<span class="number"> 11 </span>15:47 purge_relay_logs            <span class="comment">#删除无用的Relay log，避免延时</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 7525 </span>Oct<span class="number"> 11 </span>15:47 save_binary_logs            <span class="comment">#保存和复制down掉的主服务器二进制日志</span></span><br></pre></td></tr></table></figure></p><h3 id="自定义扩展脚本说明"><a href="#自定义扩展脚本说明" class="headerlink" title="自定义扩展脚本说明"></a>自定义扩展脚本说明</h3><p>secondary_check_script #通过多条网络路由检测master的可用性<br>master_ip_failover_script #自动failover时候的切换脚本，可将vip信息写入此脚本中<br>shutdown_script #强制关闭master节点执行脚本<br>report_script #发送报告<br>init_conf_load_script #加载初始配置参数，如不想在配置中写明文密码<br>master_ip_online_change_script #手动failover时候的切换脚本  </p><h2 id="keepalived安装"><a href="#keepalived安装" class="headerlink" title="keepalived安装"></a>keepalived安装</h2><p>MHA作为MySQL的HA软件,借助脚本或者第三方软件如keepalived,可实现自动的failover<br>本次环境使用yum安装keepalived,主库和从库分别执行安装: yum -y install keepalived<br>keepalived的配置文件,默认在主库上绑定EIP,priority要比备库高,同时为了避免脑裂,两个state同时设置为BACKUP,由于HaVip不支持组播和广播通讯,因此需要将keepalived的心跳方式设置为单播,添加unicast_src_ip和unicast_peer</p><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><h4 id="主库配置-1"><a href="#主库配置-1" class="headerlink" title="主库配置"></a>主库配置</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     duanwenjie@huan.tv</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">   <span class="built_in"> interface </span>eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.16.82 dev eth0 label eth0:havip</span><br><span class="line">    &#125;</span><br><span class="line">        unicast_src_ip 192.168.16.80</span><br><span class="line">        unicast_peer &#123;</span><br><span class="line">                192.168.16.81</span><br><span class="line">                        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="从库配置-1"><a href="#从库配置-1" class="headerlink" title="从库配置"></a>从库配置</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     duanwenjie@huan.tv</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">   <span class="built_in"> interface </span>eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.16.82 dev eth0 label eth0:havip</span><br><span class="line">    &#125;</span><br><span class="line">        unicast_src_ip 192.168.16.81</span><br><span class="line">        unicast_peer &#123;</span><br><span class="line">                192.168.16.80</span><br><span class="line">                        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="EIP漂移测试"><a href="#EIP漂移测试" class="headerlink" title="EIP漂移测试"></a>EIP漂移测试</h3><p>分别启动keepalived服务，查看默认EIP在哪台机器上，同时关闭EIP所在机器的keepalived服务，查看EIP是否漂移，最后恢复原状</p><h4 id="主库启动keepalived服务"><a href="#主库启动keepalived服务" class="headerlink" title="主库启动keepalived服务"></a>主库启动keepalived服务</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">keepalived</span>]<span class="comment"># /etc/init.d/keepalived start</span></span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">keepalived</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h4 id="从库启动keepalived服务"><a href="#从库启动keepalived服务" class="headerlink" title="从库启动keepalived服务"></a>从库启动keepalived服务</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@slave</span> keepalived]<span class="meta"># /etc/init.d/keepalived start</span></span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root<span class="symbol">@slave</span> keepalived]<span class="meta">#</span></span><br></pre></td></tr></table></figure><h4 id="查看默认EIP在主库上"><a href="#查看默认EIP在主库上" class="headerlink" title="查看默认EIP在主库上"></a>查看默认EIP在主库上</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span></span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:172562</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:71674</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:200695958</span> (191<span class="selector-class">.3</span> <span class="selector-tag">MiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:12526649</span> (11<span class="selector-class">.9</span> <span class="selector-tag">MiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7946</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7946</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:510910</span> (498<span class="selector-class">.9</span> <span class="selector-tag">KiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:510910</span> (498<span class="selector-class">.9</span> <span class="selector-tag">KiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure><h4 id="关闭主库的keepalived服务"><a href="#关闭主库的keepalived服务" class="headerlink" title="关闭主库的keepalived服务"></a>关闭主库的keepalived服务</h4><p>关闭主库的keepalived服务后，EIP消失<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">keepalived</span> <span class="selector-tag">stop</span></span><br><span class="line"><span class="selector-tag">Stopping</span> <span class="selector-tag">keepalived</span>:                                       <span class="selector-attr">[  OK  ]</span></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span></span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:172670</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:71803</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:200704346</span> (<span class="number">191.4</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:12569281</span> (<span class="number">11.9</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7976</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7976</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:512770</span> (<span class="number">500.7</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:512770</span> (<span class="number">500.7</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure></p><h4 id="查看EIP是否漂移到从库上"><a href="#查看EIP是否漂移到从库上" class="headerlink" title="查看EIP是否漂移到从库上"></a>查看EIP是否漂移到从库上</h4><p>此时EIP已经漂移到从库上<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@slave ~]</span># <span class="selector-tag">ifconfig</span></span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:80</span><span class="selector-pseudo">:57</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.81</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:164539</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:77532</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:202145589</span> (192<span class="selector-class">.7</span> <span class="selector-tag">MiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:12091265</span> (11<span class="selector-class">.5</span> <span class="selector-tag">MiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:80</span><span class="selector-pseudo">:57</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7961</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7961</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:508050</span> (496<span class="selector-class">.1</span> <span class="selector-tag">KiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:508050</span> (496<span class="selector-class">.1</span> <span class="selector-tag">KiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@slave ~]</span>#</span><br></pre></td></tr></table></figure></p><h4 id="恢复原状"><a href="#恢复原状" class="headerlink" title="恢复原状"></a>恢复原状</h4><p>主库启动keepalived服务，查看EIP已经又漂移回来<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">keepalived</span> <span class="selector-tag">start</span></span><br><span class="line"><span class="selector-tag">Starting</span> <span class="selector-tag">keepalived</span>:                                       <span class="selector-attr">[  OK  ]</span></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span></span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:172863</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:71978</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:200717148</span> (<span class="number">191.4</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:12627987</span> (<span class="number">12.0</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8039</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8039</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:516676</span> (<span class="number">504.5</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:516676</span> (<span class="number">504.5</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure></p><h2 id="MHA配置"><a href="#MHA配置" class="headerlink" title="MHA配置"></a>MHA配置</h2><h3 id="MHAManager-1"><a href="#MHAManager-1" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>创建配置目录/etc/masterha/，同时创建一个项目上的配置文件，仅配置自动FailOver部分，脚本暂时不定义，下文会有MHA引入keepalived。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[server default]</span><br><span class="line"><span class="attribute">manager_workdir</span>=/var/log/masterha/app1   </span><br><span class="line"><span class="attribute">manager_log</span>=/var/log/masterha/app1/manager.log </span><br><span class="line"><span class="attribute">master_binlog_dir</span>=/hwdata/data/percona        </span><br><span class="line"><span class="attribute">password</span>=mha123456                             </span><br><span class="line"><span class="attribute">user</span>=mha01                                     </span><br><span class="line"><span class="attribute">ping_interval</span>=1                                    </span><br><span class="line"><span class="attribute">remote_workdir</span>=/tmp                                                </span><br><span class="line"><span class="attribute">repl_password</span>=slave123456                                          </span><br><span class="line"><span class="attribute">repl_user</span>=slave01                                                 </span><br><span class="line"><span class="attribute">ssh_user</span>=root                                                     </span><br><span class="line"><span class="comment">#master_ip_failover_script=/usr/local/bin/master_ip_failover        </span></span><br><span class="line"><span class="comment">#master_ip_online_change_script= /usr/local/bin/master_ip_online_change  </span></span><br><span class="line"><span class="comment">#report_script=/usr/local/bin/send_report                         </span></span><br><span class="line"><span class="comment">#shutdown_script=                                                 </span></span><br><span class="line">secondary_check_script = masterha_secondary_check -s 192.168.16.80 -s 192.168.16.81 <span class="attribute">--user</span>=root <span class="attribute">hostname</span>=192.168.16.80  <span class="attribute">--master_ip</span>=192.168.16.80 <span class="attribute">--master_port</span>=3306 </span><br><span class="line">[server1]</span><br><span class="line"><span class="attribute">hostname</span>=192.168.16.80                                          </span><br><span class="line"><span class="attribute">port</span>=3306</span><br><span class="line">[server2]</span><br><span class="line"><span class="attribute">hostname</span>=192.168.16.81                                         </span><br><span class="line"><span class="attribute">port</span>=3306</span><br><span class="line"><span class="attribute">candidate_master</span>=1</span><br></pre></td></tr></table></figure></p><h3 id="测试MHAManager-SSH"><a href="#测试MHAManager-SSH" class="headerlink" title="测试MHAManager SSH"></a>测试MHAManager SSH</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_ssh <span class="attribute">--conf</span>=/etc/masterha/app1.cnf </span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">info</span>] Starting SSH<span class="built_in"> connection </span>tests<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.16.80(192.168.16.80:22) <span class="keyword">to</span> root@192.168.16.81(192.168.16.81:22)<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.16.81(192.168.16.81:22) <span class="keyword">to</span> root@192.168.16.80(192.168.16.80:22)<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">info</span>] All SSH<span class="built_in"> connection </span>tests passed successfully.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure><h3 id="测试MHAManager-复制"><a href="#测试MHAManager-复制" class="headerlink" title="测试MHAManager 复制"></a>测试MHAManager 复制</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_repl <span class="attribute">--conf</span>=/etc/masterha/app1.cnf</span><br><span class="line">Wed Oct 11 17:22:47 2017 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Wed Oct 11 17:22:47 2017 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:47 2017 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:47 2017 - [<span class="builtin-name">info</span>] MHA::MasterMonitor version 0.57.</span><br><span class="line">Creating directory /var/log/masterha/app1<span class="built_in">..</span> done.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Multi-master configuration is detected. Current primary(writable) master is 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Master configurations are as below: </span><br><span class="line">Master 192.168.16.81(192.168.16.81:3306), replicating <span class="keyword">from</span> 192.168.16.80(192.168.16.80:3306), read-only</span><br><span class="line">Master 192.168.16.80(192.168.16.80:3306), replicating <span class="keyword">from</span> 192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] GTID failover mode = 1</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Dead Servers:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Alive Servers:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]   192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]   192.168.16.81(192.168.16.81:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Alive Slaves:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]   192.168.16.81(192.168.16.81:3306)  <span class="attribute">Version</span>=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]     GTID ON</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Current Alive Master: 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Checking slave configurations<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Checking replication filtering settings<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]  Replication filtering check ok.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] GTID (with auto-pos) is supported. Skipping all SSH <span class="keyword">and</span> Node package checking.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Checking SSH publickey authentication<span class="built_in"> settings </span>on the current master<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] HealthCheck: SSH <span class="keyword">to</span> 192.168.16.80 is reachable.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] </span><br><span class="line">192.168.16.80(192.168.16.80:3306) (current master)</span><br><span class="line"> +--192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Checking replication<span class="built_in"> health </span>on 192.168.16.81<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">warning</span>] master_ip_failover_script is <span class="keyword">not</span> defined.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">warning</span>] shutdown_script is <span class="keyword">not</span> defined.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Got exit code 0 (<span class="keyword">Not</span> master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication<span class="built_in"> Health </span>is OK.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure><h2 id="MHA引入keepalived"><a href="#MHA引入keepalived" class="headerlink" title="MHA引入keepalived"></a>MHA引入keepalived</h2><p>把keepalived服务引入MHA，需要修改切换是触发的脚本文件master_ip_failover即可，在该脚本中添加在master发生宕机时对keepalived的处理。</p><h3 id="master-ip-failover脚本"><a href="#master-ip-failover脚本" class="headerlink" title="master_ip_failover脚本"></a>master_ip_failover脚本</h3><p>编辑脚本/usr/local/bin/master_ip_failover，修改后如下，这里完整的脚本<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]<span class="comment"># cat /usr/local/bin/master_ip_failover </span></span><br><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> warnings <span class="string">FATAL =&gt;</span> <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> Getopt::Long;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> (</span><br><span class="line">    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,</span><br><span class="line">    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $vip = <span class="string">'192.168.16.82'</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_start_vip = <span class="string">"/etc/init.d/keepalived start"</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_stop_vip = <span class="string">"/etc/init.d/keepalived stop"</span>;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    <span class="string">'command=s'</span>          =&gt; \$command,</span><br><span class="line">    <span class="string">'ssh_user=s'</span>         =&gt; \$ssh_user,</span><br><span class="line">    <span class="string">'orig_master_host=s'</span> =&gt; \$orig_master_host,</span><br><span class="line">    <span class="string">'orig_master_ip=s'</span>   =&gt; \$orig_master_ip,</span><br><span class="line">    <span class="string">'orig_master_port=i'</span> =&gt; \$orig_master_port,</span><br><span class="line">    <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span><br><span class="line">    <span class="string">'new_master_ip=s'</span>    =&gt; \$new_master_ip,</span><br><span class="line">    <span class="string">'new_master_port=i'</span>  =&gt; \$new_master_port,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( $command eq <span class="string">"stop"</span> || $command eq <span class="string">"stopssh"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">eval</span> &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Disabling the VIP on old master: $orig_master_host \n"</span>;</span><br><span class="line">            &amp;stop_vip();</span><br><span class="line">            $exit_code = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">            <span class="keyword">warn</span> <span class="string">"Got Error: $@\n"</span>;</span><br><span class="line">            <span class="keyword">exit</span> $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">"start"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">eval</span> &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Enabling the VIP - $vip on the new master - $new_master_host \n"</span>;</span><br><span class="line">            &amp;start_vip();</span><br><span class="line">            $exit_code = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">            <span class="keyword">warn</span> $@;</span><br><span class="line">            <span class="keyword">exit</span> $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">"status"</span> ) &#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Checking the Status of the script.. OK \n"</span>;</span><br><span class="line">        <span class="comment">#`ssh $ssh_user\@$orig_master_ip \" $ssh_start_vip \"`;</span></span><br><span class="line">        <span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        &amp;usage();</span><br><span class="line">        <span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># A simple system call that enable the VIP on the new master</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">start_vip</span>() </span>&#123;</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># A simple system call that disable the VIP on the old_master</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">stop_vip</span>() </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>  <span class="keyword">unless</span>  ($ssh_user);</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">usage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    <span class="string">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@slave app1]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p><p>添加权限<br>chmod +x /usr/local/bin/master_ip_failover</p><h3 id="send-report脚本"><a href="#send-report脚本" class="headerlink" title="send_report脚本"></a>send_report脚本</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/send_report </span></span><br><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">strict</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">warnings</span> <span class="title">FATAL</span> =&gt; '<span class="title">all</span>';</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mail</span>::<span class="title">Sender</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Getopt</span>::<span class="title">Long</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span></span><br><span class="line">my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );</span><br><span class="line">my $smtp=<span class="string">'smtp.126.com'</span>;</span><br><span class="line">my $mail_from=<span class="string">'xxx@126.com'</span>;</span><br><span class="line">my $mail_user=<span class="string">'xxx@126.com'</span>;</span><br><span class="line">my $mail_pass=<span class="string">'xxx'</span>;</span><br><span class="line"><span class="comment">#my $mail_to=['xxx','xxx'];</span></span><br><span class="line">my $mail_to=<span class="string">'xxx'</span>;</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'orig_master_host=s'</span> =&gt; \$dead_master_host,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span><br><span class="line">  <span class="string">'new_slave_hosts=s'</span>  =&gt; \$new_slave_hosts,</span><br><span class="line">  <span class="string">'subject=s'</span>          =&gt; \$subject,</span><br><span class="line">  <span class="string">'body=s'</span>             =&gt; \$body,</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);</span><br><span class="line"> </span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_;</span><br><span class="line">    open my $DEBUG, <span class="string">"&gt; /var/log/masterha/app1/manager.log"</span></span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Can't open the debug      file:$!\n"</span>;</span><br><span class="line">    my $sender = <span class="keyword">new</span> Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; <span class="string">'text/plain; charset=utf-8'</span>,</span><br><span class="line">        encoding    =&gt; <span class="string">'utf-8'</span>,</span><br><span class="line">        smtp        =&gt; $smtp,</span><br><span class="line">        from        =&gt; $mail_from,</span><br><span class="line">        auth        =&gt; <span class="string">'LOGIN'</span>,</span><br><span class="line">        TLS_allowed =&gt; <span class="string">'0'</span>,</span><br><span class="line">        authid      =&gt; $user,</span><br><span class="line">        authpwd     =&gt; $passwd,</span><br><span class="line">        to          =&gt; $mail_to,</span><br><span class="line">        subject     =&gt; $subject,</span><br><span class="line">        debug       =&gt; $DEBUG</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    $sender-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; $msg,</span><br><span class="line">            debug =&gt; $DEBUG</span><br><span class="line">        &#125;</span><br><span class="line">    ) <span class="keyword">or</span> <span class="keyword">print</span> $Mail::Sender::Error;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Do whatever you want here</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure><p>添加权限<br>chmod +x /usr/local/bin/send_report</p><h3 id="MHAManager修改注释"><a href="#MHAManager修改注释" class="headerlink" title="MHAManager修改注释"></a>MHAManager修改注释</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@slave</span> app1]<span class="comment"># cat /etc/masterha/app1.cnf |grep master_ip_failover_script</span></span><br><span class="line">master_ip_failover_script=<span class="regexp">/usr/local</span><span class="regexp">/bin/master</span>_ip_failover        </span><br><span class="line">[root<span class="variable">@slave</span> app1]<span class="comment"># cat /etc/masterha/app1.cnf |grep report</span></span><br><span class="line">report_script=<span class="regexp">/usr/local</span><span class="regexp">/bin/send</span>_report                         </span><br><span class="line">[root<span class="variable">@slave</span> app1]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h2 id="HaVip绑定EIP"><a href="#HaVip绑定EIP" class="headerlink" title="HaVip绑定EIP"></a>HaVip绑定EIP</h2><p>keepalived服务已经配置完成，VIP也可以自动漂移后，但是其还不能在内网中通讯，需要将EIP映射到HaVip中，创建高可用虚拟IP，把master和slave两个实例的绑定在一起，具体步骤省略，见下图<br><img src="http://note.youdao.com/yws/public/resource/eed85389475569ba15ce22e5a266d5fb/xmlnote/E0CF3D2D9BE747299B2348C6AD4EAD30/37915" alt="image"></p><h2 id="MHA启动"><a href="#MHA启动" class="headerlink" title="MHA启动"></a>MHA启动</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta"># nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;</span></span><br><span class="line">[<span class="meta">1</span>] <span class="number">6706</span></span><br><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta"># nohup: ignoring input and appending output to `nohup.out'</span></span><br></pre></td></tr></table></figure><h3 id="查看启动日志"><a href="#查看启动日志" class="headerlink" title="查看启动日志"></a>查看启动日志</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# cat /var/log/masterha/app1/manager.log</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2017</span> - [info] MHA::MasterMonitor version <span class="number">0.57</span>.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Multi-master configuration is detected. Current primary(writable) master is <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Master configurations are as below: </span><br><span class="line">Master <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>), replicating from <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>), read-only</span><br><span class="line">Master <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>), replicating from <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">1</span></span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Dead Servers:</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Alive Servers:</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Alive Slaves:</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="meta">.18</span>-<span class="number">15</span>-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]     GTID ON</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Current Alive Master: <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Checking slave configurations..</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Checking replication filtering settings..</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  Replication filtering check ok.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] GTID (with auto-pos) is supported. Skipping all SSH <span class="keyword">and</span> Node package checking.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] HealthCheck: SSH to <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> is reachable.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] </span><br><span class="line"><span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>) (current master)</span><br><span class="line"> +--<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Checking master_ip_failover_script status:</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> --orig_master_ip=<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> --orig_master_port=<span class="number">3306</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">IN</span> SCRIPT <span class="keyword">TEST</span>====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  OK.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] shutdown_script is <span class="keyword">not</span> defined.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Set master ping interval <span class="number">1</span> seconds.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Set secondary check script: masterha_secondary_check -s <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> -s <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span> --user=root hostname=<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>  --master_ip=<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> --master_port=<span class="number">3306</span></span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Starting ping health check on <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)..</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Ping(SELECT) succeeded, waiting until MySQL doesn<span class="string">'t respond..</span></span><br><span class="line"><span class="string">[root@slave app1]#</span></span><br></pre></td></tr></table></figure><h2 id="模拟主库故障-自动FailOver"><a href="#模拟主库故障-自动FailOver" class="headerlink" title="模拟主库故障(自动FailOver)"></a>模拟主库故障(自动FailOver)</h2><h3 id="确认MHAManager进程状态"><a href="#确认MHAManager进程状态" class="headerlink" title="确认MHAManager进程状态"></a>确认MHAManager进程状态</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">ps</span> <span class="string">aux|grep</span> <span class="string">master</span></span><br><span class="line"><span class="string">root</span>      <span class="number">1217</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">81520</span>  <span class="number">3440</span> <span class="string">?</span>        <span class="string">Ss</span>   <span class="string">Oct11</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">/usr/libexec/postfix/master</span></span><br><span class="line"><span class="string">root</span>     <span class="number">20887</span>  <span class="number">0.2</span>  <span class="number">0.4</span> <span class="number">194688</span> <span class="number">18736</span> <span class="string">pts/1</span>    <span class="string">S</span>    <span class="number">08</span><span class="string">:57</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">perl</span> <span class="string">/usr/local/bin/masterha_manager</span> <span class="bullet">--conf=/etc/masterha/app1.cnf</span></span><br><span class="line"><span class="string">root</span>     <span class="number">20998</span>  <span class="number">0.0</span>  <span class="number">0.0</span> <span class="number">103252</span>   <span class="number">844</span> <span class="string">pts/1</span>    <span class="string">S+</span>   <span class="number">08</span><span class="string">:59</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">grep</span> <span class="string">master</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">ifconfig</span>     <span class="comment">#VIP不在slave上</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">00</span><span class="string">:16:3E:12:80:57</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:192.168.16.81</span>  <span class="attr">Bcast:192.168.31.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:1500</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:288188</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:129868</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:211584573</span> <span class="string">(201.7</span> <span class="string">MiB)</span>  <span class="string">TX</span> <span class="attr">bytes:50227849</span> <span class="string">(47.9</span> <span class="string">MiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:50346</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:50346</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:0</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:3204922</span> <span class="string">(3.0</span> <span class="string">MiB)</span>  <span class="string">TX</span> <span class="attr">bytes:3204922</span> <span class="string">(3.0</span> <span class="string">MiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span></span><br></pre></td></tr></table></figure><h3 id="停止主库MySQL服务"><a href="#停止主库MySQL服务" class="headerlink" title="停止主库MySQL服务"></a>停止主库MySQL服务</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>   #停止前<span class="selector-tag">VIP</span>存在于主库上</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:278061</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:223278</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:210643899</span> (<span class="number">200.8</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:57552395</span> (<span class="number">54.8</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:50158</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:50158</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3130070</span> (<span class="number">2.9</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3130070</span> (<span class="number">2.9</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">mysqld</span> <span class="selector-tag">stop</span></span><br><span class="line"><span class="selector-tag">Shutting</span> <span class="selector-tag">down</span> <span class="selector-tag">MySQL</span> (Percona Server)............           <span class="selector-attr">[  OK  ]</span></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>   #停止后<span class="selector-tag">VIP</span>已经漂移走</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:278240</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:223445</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:210664827</span> (<span class="number">200.9</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:57596785</span> (<span class="number">54.9</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:50175</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:50175</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3131100</span> (<span class="number">2.9</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3131100</span> (<span class="number">2.9</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure><h3 id="查看FailOver日志"><a href="#查看FailOver日志" class="headerlink" title="查看FailOver日志"></a>查看FailOver日志</h3><p>登录从库，查看MHAManager日志<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# tail -f /var/<span class="built_in">log</span>/masterha/app1/manager.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">IN</span> SCRIPT TEST====/etc/init.d/keepalived <span class="keyword">stop</span>==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  OK.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] <span class="keyword">Set</span> master ping interval <span class="number">1</span> seconds.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] <span class="keyword">Set</span> secondary check script: masterha_secondary_check -s <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> -s <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> --user=root hostname=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>  --master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --master_port=<span class="number">3306</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Starting ping health check <span class="keyword">on</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Ping(<span class="keyword">SELECT</span>) succeeded, waiting until MySQL doesn<span class="comment">'t respond..     #开始监听服务状态</span></span><br><span class="line">#监控到master故障后，MHA开始做自动FailOver</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">select</span> ping: <span class="number">2006</span> (MySQL <span class="built_in">server</span> has gone away)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Executing secondary network check script: masterha_secondary_check -s <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> -s <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> --user=root hostname=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>  --master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --master_port=<span class="number">3306</span>  --user=root  --master_host=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>  --master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>  --master_port=<span class="number">3306</span> --master_user=mha01 --master_password=mha123456 --ping_type=<span class="keyword">SELECT</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Executing SSH check script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Monitoring <span class="built_in">server</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> <span class="keyword">is</span> reachable, Master <span class="keyword">is</span> <span class="keyword">not</span> reachable from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>. OK.</span><br><span class="line">Monitoring <span class="built_in">server</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> <span class="keyword">is</span> reachable, Master <span class="keyword">is</span> <span class="keyword">not</span> reachable from <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>. OK.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Master <span class="keyword">is</span> <span class="keyword">not</span> reachable from all other monitoring servers. Failover should start.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">55</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL connect: <span class="number">2013</span> (Lost connection <span class="keyword">to</span> MySQL <span class="built_in">server</span> at <span class="comment">'reading initial communication packet', system error: 111)</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">55</span> <span class="number">2017</span> - [warning] Connection failed <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">56</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL connect: <span class="number">2013</span> (Lost connection <span class="keyword">to</span> MySQL <span class="built_in">server</span> at <span class="comment">'reading initial communication packet', system error: 111)</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">56</span> <span class="number">2017</span> - [warning] Connection failed <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL connect: <span class="number">2013</span> (Lost connection <span class="keyword">to</span> MySQL <span class="built_in">server</span> at <span class="comment">'reading initial communication packet', system error: 111)</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Connection failed <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Master <span class="keyword">is</span> <span class="keyword">not</span> reachable from health checker!</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Master <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>) <span class="keyword">is</span> <span class="keyword">not</span> reachable!</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] SSH <span class="keyword">is</span> reachable.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> a master <span class="built_in">server</span> failed. Reading configuration file /etc/masterha_default.cnf <span class="keyword">and</span> /etc/masterha/app1.cnf again, <span class="keyword">and</span> trying <span class="keyword">to</span> connect <span class="keyword">to</span> all servers <span class="keyword">to</span> check <span class="built_in">server</span> status..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Reading application <span class="keyword">default</span> configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Reading <span class="built_in">server</span> configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">1</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Dead Servers:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Alive Servers:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Alive Slaves:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Checking slave configurations..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Checking replication filtering settings..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]  Replication filtering check ok.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Master <span class="keyword">is</span> down!</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Terminating monitoring script.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Got <span class="keyword">exit</span> code <span class="number">20</span> (Master dead).</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] MHA::MasterFailover version <span class="number">0.57</span>.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Starting master failover.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">1</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Dead Servers:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Checking master reachability via MySQL(double check)...</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  ok.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Alive Servers:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Alive Slaves:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Starting GTID based failover.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Forcing shutdown so that applications never connect <span class="keyword">to</span> the current master..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Executing master IP deactivation script:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   /usr/local/bin/master_ip_failover --orig_master_host=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --orig_master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --orig_master_port=<span class="number">3306</span> --command=stopssh --ssh_user=root  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">IN</span> SCRIPT TEST====/etc/init.d/keepalived <span class="keyword">stop</span>==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Disabling the VIP <span class="keyword">on</span> old master: <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  done.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping <span class="keyword">explicit</span> shutting down of the dead master.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] The latest binary <span class="built_in">log</span> file/position <span class="keyword">on</span> all slaves <span class="keyword">is</span> mysql-bin<span class="number">.000005</span>:<span class="number">234</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Latest slaves (Slaves that received relay <span class="built_in">log</span> files <span class="keyword">to</span> the latest):</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] The oldest binary <span class="built_in">log</span> file/position <span class="keyword">on</span> all slaves <span class="keyword">is</span> mysql-bin<span class="number">.000005</span>:<span class="number">234</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Oldest slaves:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining <span class="keyword">New</span> Master Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Searching <span class="keyword">new</span> master from slaves..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Candidate masters from the configuration file:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Non-candidate masters:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Searching from candidate_master slaves which have received the latest relay <span class="built_in">log</span> events..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] <span class="keyword">New</span> master <span class="keyword">is</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Starting master failover..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">From:</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>) (current master)</span><br><span class="line"> +-<span class="number">-192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span>:</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) (<span class="keyword">new</span> master)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: <span class="keyword">New</span> Master Recovery Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Waiting all logs <span class="keyword">to</span> be applied.. </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   done.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Getting <span class="keyword">new</span> master<span class="comment">'s binlog name and position..</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  mysql-bin<span class="number">.000002</span>:<span class="number">4876</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER <span class="keyword">TO</span> MASTER_HOST=<span class="comment">'192.168.16.81', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='slave01', MASTER_PASSWORD='xxx';</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin<span class="number">.000002</span>, <span class="number">4876</span>, df5051fc-ae51<span class="number">-11e7</span><span class="number">-85</span>ee<span class="number">-00163e0</span>f0e4a:<span class="number">1</span><span class="number">-15</span>,</span><br><span class="line">e1ec82e8-ae51<span class="number">-11e7</span><span class="number">-8532</span><span class="number">-00163e128057</span>:<span class="number">1</span><span class="number">-6</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Executing master IP activate script:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   /usr/local/bin/master_ip_failover --command=start --ssh_user=root --orig_master_host=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --orig_master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --orig_master_port=<span class="number">3306</span> --new_master_host=<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> --new_master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> --new_master_port=<span class="number">3306</span> --new_master_user=<span class="comment">'mha01'   --new_master_password=xxx</span></span><br><span class="line">Unknown <span class="keyword">option</span>: new_master_user</span><br><span class="line">Unknown <span class="keyword">option</span>: new_master_password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">IN</span> SCRIPT TEST====/etc/init.d/keepalived <span class="keyword">stop</span>==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Enabling the VIP - <span class="number">192.168</span><span class="number">.16</span><span class="number">.200</span> <span class="keyword">on</span> the <span class="keyword">new</span> master - <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  OK.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Setting read_only=<span class="number">0</span> <span class="keyword">on</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  ok.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] ** Finished master recovery successfully.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.1</span>: Starting Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] All <span class="keyword">new</span> slave servers recovered successfully.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> master cleanup phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Resetting slave info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>: Resetting slave info succeeded.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Master failover <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) completed successfully.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line"></span><br><span class="line">----- Failover Report -----</span><br><span class="line"></span><br><span class="line">app1: MySQL Master failover <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>) <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) succeeded</span><br><span class="line"></span><br><span class="line">Master <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line">Check MHA Manager logs at slave:/var/<span class="built_in">log</span>/masterha/app1/manager.<span class="built_in">log</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated master IP address <span class="keyword">on</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Selected <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) as a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>): OK: Applying all logs succeeded.</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>): OK: Activated master IP address.</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>): Resetting slave info succeeded.</span><br><span class="line">Master failover <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) completed successfully.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Sending mail..</span><br><span class="line"><span class="keyword">Option</span> new_slave_hosts requires an argument</span><br><span class="line">Unknown <span class="keyword">option</span>: conf</span><br><span class="line">tail: /var/<span class="built_in">log</span>/masterha/app1/manager.<span class="built_in">log</span>: file truncated</span><br><span class="line">^C</span><br><span class="line">[<span class="number">1</span>]+  Done                    nohup masterha_manager --conf=/etc/masterha/app1.cnf  (wd: /etc/masterha)</span><br><span class="line">(wd <span class="built_in">now</span>: /var/<span class="built_in">log</span>/masterha/app1)</span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure></p><p><font color="#FF0000">注意：<br>由于阿里云的ECS默认不允许发送邮件，它们把25端口已经封掉，如果需要开通25端口，主联系阿里云技术支持。本次切换日志在最后没有发送邮件，是由于这个原因导致的。</font></p><h3 id="日志解析过程"><a href="#日志解析过程" class="headerlink" title="日志解析过程"></a>日志解析过程</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">启动前的准备工作</span><br><span class="line">检查数据库服务器状态,获取相关参数设置</span><br><span class="line">检查GTID、candidate_master、过滤DB是否设置</span><br><span class="line">测试ssh连接是否成功</span><br><span class="line">测试MHA <span class="keyword">node</span><span class="title">是否可用</span></span><br><span class="line"><span class="title">创建MHA</span>日志目录</span><br><span class="line">开始检查<span class="literal">slave</span>的差异日志应用权限</span><br><span class="line">确定当前的复制架构</span><br><span class="line">调试master_ip_failover_script</span><br><span class="line">调试shutdown_script</span><br><span class="line">设置二次检查的主机masterha_secondary_check</span><br><span class="line">MHA启动完毕,进入监测状态</span><br><span class="line">监测<span class="literal">master</span>服务器挂了</span><br><span class="line">通过定义的二次监测,确认<span class="literal">master</span>是否挂了</span><br><span class="line">确认<span class="literal">master</span>挂了,开始进入failover流程</span><br><span class="line">再试尝试连接<span class="literal">master</span>和<span class="literal">master</span>的ssh</span><br><span class="line">通过MHA配置文件,监测其他<span class="literal">slave</span>的状态</span><br><span class="line">再次监测<span class="literal">slave</span>的配置是否有变化,是否符合failover条件</span><br><span class="line">正式开始failover</span><br><span class="line">再次对<span class="literal">slave</span>配置做检查</span><br><span class="line">对原<span class="literal">Master</span>做master_ip_failover_script和shutdown_script的操作</span><br><span class="line">开始差异日志的恢复，获取<span class="literal">slave</span>最后得到的binlog位置</span><br><span class="line">获取原<span class="literal">master</span>的binlog日志</span><br><span class="line">确定新的<span class="literal">master</span></span><br><span class="line">在new <span class="literal">master</span>上应用差异的binlog日志</span><br><span class="line">获取new <span class="literal">master</span>的binlog位置。</span><br><span class="line">执行master_ip_failover_script,调用aws_vip_change.sh，执行VIP漂移</span><br><span class="line">开始恢复其他<span class="literal">slave</span>的差异日志</span><br><span class="line">差异日志应用完成以后,切换所有<span class="literal">slave</span>到new <span class="literal">master</span>。</span><br><span class="line">failover操作完成,生成failover报告</span><br><span class="line">最后发送邮件通知</span><br></pre></td></tr></table></figure><h3 id="确认FailOver状态"><a href="#确认FailOver状态" class="headerlink" title="确认FailOver状态"></a>确认FailOver状态</h3><p>登录从库，查看VIP是否漂移过程<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@slave app1]</span># <span class="selector-tag">ifconfig</span>     <span class="selector-id">#VIP</span>已经漂移过程</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:80</span><span class="selector-pseudo">:57</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.81</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:295022</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:135929</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:212253710</span> (202<span class="selector-class">.4</span> <span class="selector-tag">MiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:52246361</span> (49<span class="selector-class">.8</span> <span class="selector-tag">MiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:80</span><span class="selector-pseudo">:57</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:52973</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:52973</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3597938</span> (3<span class="selector-class">.4</span> <span class="selector-tag">MiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3597938</span> (3<span class="selector-class">.4</span> <span class="selector-tag">MiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@slave app1]</span>#</span><br></pre></td></tr></table></figure></p><p>登录主库，查看VIP是否存在，keepalived服务状态<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>   <span class="selector-id">#VIP</span>已经不存在</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:284277</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:229786</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:211190989</span> (<span class="number">201.4</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:60010868</span> (<span class="number">57.2</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:51564</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:51564</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3217146</span> (<span class="number">3.0</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3217146</span> (<span class="number">3.0</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">keepalived</span> <span class="selector-tag">status</span>  <span class="selector-id">#keepalived</span>服务已经停止</span><br><span class="line"><span class="selector-tag">keepalived</span> <span class="selector-tag">is</span> <span class="selector-tag">stopped</span></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure></p><h3 id="手动FailOver"><a href="#手动FailOver" class="headerlink" title="手动FailOver"></a>手动FailOver</h3><p>MHA的手动FailOver不在本文范围，详情理论可参考官方文档。</p><h3 id="参数列表"><a href="#参数列表" class="headerlink" title="参数列表"></a>参数列表</h3><p>请参考之前<a href="https://dwj999.github.io/AWS-EC2%E6%90%AD%E5%BB%BAmha-vip-MySQL5-7.html#参数列表">文章</a>。</p><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://dwj999.github.io/AWS-EC2搭建mha-vip-MySQL5-7.htm">https://dwj999.github.io/AWS-EC2搭建mha-vip-MySQL5-7.htm</a></p><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>云服务器上MySQL高可用，也可通过云负载均衡产品+MySQL复制来实现，但在数据安全性上，没有MHA+VIP+MySQL相对安全。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了
      
    
    </summary>
    
      <category term="集群高可用" scheme="https://dwj999.github.io/categories/%E9%9B%86%E7%BE%A4%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    
    
      <category term="MySQL" scheme="https://dwj999.github.io/tags/MySQL/"/>
    
      <category term="VIP" scheme="https://dwj999.github.io/tags/VIP/"/>
    
      <category term="MHA" scheme="https://dwj999.github.io/tags/MHA/"/>
    
      <category term="Aliyun" scheme="https://dwj999.github.io/tags/Aliyun/"/>
    
      <category term="ECS" scheme="https://dwj999.github.io/tags/ECS/"/>
    
      <category term="Keepalived" scheme="https://dwj999.github.io/tags/Keepalived/"/>
    
  </entry>
  
  <entry>
    <title>ProxySQL 安装配置详解及读写分离、负载均衡</title>
    <link href="https://dwj999.github.io/ProxySQL-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE%E8%AF%A6%E8%A7%A3%E5%8F%8A%E8%AF%BB%E5%86%99%E5%88%86%E7%A6%BB%E3%80%81%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1.html"/>
    <id>https://dwj999.github.io/ProxySQL-安装配置详解及读写分离、负载均衡.html</id>
    <published>2017-08-29T07:58:45.000Z</published>
    <updated>2020-05-20T03:46:48.084Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在MySQL的高可用集群环境中，中间件是不可缺少的一部分，它提供了读写分离、负载均衡等各种功能，满足集群的横向、纵向的可扩展。由于官方并没有在这方面推出好的产品，更多的是第三方的产品。如：</p><ul><li>ProxySQL  #Percona</li><li>MaxScale  #MariaDB</li><li>Atlas     #360开源</li><li>OneProxy  #平民软件楼方鑫</li><li>MyCat     #社区推广</li><li>KingShard #原Atlas作者离职后使用go开发</li><li>TDDL      #阿里巴巴开源</li><li>Cobar     #阿里巴巴开源</li><li>DBProxy   #美团在360Atlas上修改后开源</li><li>Fabric    #官方产品</li><li>DRDS      #阿里云分库分表产品</li></ul><p>本次以测试ProxySQL为例，逐步了解ProxySQL的使用方式。</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>环境：<br>ProxySQL:   1.4.1<br>Master:     118.190.67.67<br>Slave:      139.196.95.103(192.168.7.50)</p><h2 id="安装配置详解"><a href="#安装配置详解" class="headerlink" title="安装配置详解"></a>安装配置详解</h2><p>官网：<a href="http://www.proxysql.com/" target="_blank" rel="noopener">http://www.proxysql.com/</a><br>Percona地址：<a href="https://www.percona.com/downloads/proxysql/" target="_blank" rel="noopener">https://www.percona.com/downloads/proxysql/</a><br>Github地址：<a href="https://github.com/sysown/proxysql/" target="_blank" rel="noopener">https://github.com/sysown/proxysql/</a><br>本文通过作者编译好的rpm安装，也可通过编译安装的方式安装，本文省略  </p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>下载proxysql可以有三种途径,分别为官网、Percona网站和Github网站<br>本文从github上下载最新稳定版本，这里选择centos67对应的rpm包<br>下载：wget -c -O proxysql-1.4.1-1-centos67.x86_64.rpm <a href="https://github.com/sysown/proxysql/releases/download/v1.4.1/proxysql-1.4.1-1-centos67.x86_64.rpm" target="_blank" rel="noopener">https://github.com/sysown/proxysql/releases/download/v1.4.1/proxysql-1.4.1-1-centos67.x86_64.rpm</a><br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ test]# yum localinstall -y proxysql-1.4.1-1-centos67.x86<span class="emphasis">_64.rpm</span></span><br><span class="line"><span class="emphasis">Loaded plugins: security</span></span><br><span class="line"><span class="emphasis">docker-main-repo                                                                                                                                 | 2.9 kB     00:00     </span></span><br><span class="line"><span class="emphasis">Setting up Install Process</span></span><br><span class="line"><span class="emphasis">Resolving Dependencies</span></span><br><span class="line"><span class="emphasis">There are unfinished transactions remaining. You might consider running yum-complete-transaction first to finish them.</span></span><br><span class="line"><span class="emphasis">--&gt; Running transaction check</span></span><br><span class="line"><span class="emphasis">---&gt; Package proxysql.x86_</span>64 0:1.4.1-1 will be installed</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">========================================================================================================================================================================</span><br><span class="line"><span class="code"> Package                           Arch                            Version                             Repository                                                  Size</span></span><br><span class="line">========================================================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"><span class="code"> proxysql                          x86_64                          1.4.1-1                             /proxysql-1.4.1-1-centos67.x86_64                           19 M</span></span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">========================================================================================================================================================================</span><br><span class="line">Install       1 Package(s)</span><br><span class="line"></span><br><span class="line">Total size: 19 M</span><br><span class="line">Installed size: 19 M</span><br><span class="line">Downloading Packages:</span><br><span class="line">Running rpm<span class="emphasis">_check_</span>debug</span><br><span class="line">Running Transaction Test</span><br><span class="line">Transaction Test Succeeded</span><br><span class="line">Running Transaction</span><br><span class="line"><span class="code">  Installing : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></span><br><span class="line"><span class="code">  Verifying  : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line"><span class="code">  proxysql.x86_64 0:1.4.1-1                                                                                                                                             </span></span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure></p><p>ProxySQL默认配置文件为/etc/proxysql.cnf,只在第一次启动的时候有用,后续的所有配置都是通过对SQLite数据库的操作,并且不会更新到proxysql中,而是存储在/var/lib/proxysql/proxysql.db中<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie test]<span class="meta">#  proxysql --version    #查看版本</span></span><br><span class="line">ProxySQL version <span class="number">1.4</span><span class="number">.1</span><span class="number">-45</span>-gab4e6ee, codename Truls</span><br><span class="line">[root@jiessie test]<span class="meta"># rpm -ql proxysql   #查看安装的具体内容</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>init.d/proxysql                    <span class="meta">#启动脚本</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>proxysql.cnf                       <span class="meta">#默认配置文件</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>bin/proxysql                       <span class="meta">#执行文件</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/proxysql/</span>tools/proxysql_galera_checker.sh    <span class="meta">#ProxySQL调度程序检查pxc_maint_mode参数状态,持续检测各个节点的状态</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/proxysql/</span>tools/proxysql_galera_writer.pl <span class="meta">#ProxySQL指定一个节点直接将流量写入galera</span></span><br><span class="line">[root@jiessie test]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p><h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>启动之后才会生成存储目录/var/lib/proxysql<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie test]<span class="comment"># /etc/init.d/proxysql start</span></span><br><span class="line">Starting ProxySQL: DONE!</span><br><span class="line">[root@jiessie test]<span class="comment"># ll /var/lib/proxysql/</span></span><br><span class="line">总用量 108</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root<span class="number"> 98304 </span>8月 <span class="number"> 29 </span>15:37 proxysql.db</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root <span class="number"> 4306 </span>8月 <span class="number"> 29 </span>16:25 proxysql.log</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root    <span class="number"> 5 </span>8月 <span class="number"> 29 </span>16:25 proxysql.pid</span><br><span class="line">[root@jiessie test]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p><h2 id="内置对象介绍"><a href="#内置对象介绍" class="headerlink" title="内置对象介绍"></a>内置对象介绍</h2><h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><p>启动了6032和6033两个端口,默认管理端口是6032,客户端服务端口是6033,默认的用户名密码都是 admin,通过mysql的客户端可以登录<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie test]<span class="comment"># netstat -tunlp|grep proxysql</span></span><br><span class="line">tcp        0      0 0.0.0.0:6032                0.0.0.0:*                   LISTEN      5181/proxysql       </span><br><span class="line">tcp        0      0 0.0.0.0:6033                0.0.0.0:*                   LISTEN      5181/proxysql       </span><br><span class="line">[root@jiessie test]<span class="comment"># mysql -uadmin -padmin -h127.0.0.1 -P6032</span></span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQ<span class="class">L monitor.  Commands end with ;</span><span class="built_in"> or </span>\g.</span><br><span class="line">Your MySQL connection id is 1</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC<span class="built_in"> and/or </span>its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle<span class="built_in"> and/or </span>its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation<span class="built_in"> and/or </span>its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;'<span class="built_in"> or </span>'\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 16:28:32 &gt; show databases;</span><br><span class="line">+-----+---------+-------------------------------+</span><br><span class="line">| seq | name    | file                          |</span><br><span class="line">+-----+---------+-------------------------------+</span><br><span class="line">| 0   | main    |                               |</span><br><span class="line">| 2   | disk    | /var/lib/proxysql/proxysql.db |</span><br><span class="line">| 3   | stats   |                               |</span><br><span class="line">| 4   |<span class="built_in"> monitor </span>|                               |</span><br><span class="line">+-----+---------+-------------------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 16:28:41 &gt;</span><br></pre></td></tr></table></figure></p><h3 id="内置库"><a href="#内置库" class="headerlink" title="内置库"></a>内置库</h3><p>main：默认数据库名,用于存放后端db实例、用户认证、路由规则等信息。表名以runtime_开头的表示proxysql当前运行的配置内容，不能通过dml语句修改。只能修改对应的不以runtime_开头的（在内存）里的表，然后LOAD使其生效，SAVE使其存到硬盘以供下次重启加载。<br>disk：是持久化到硬盘的配置，sqlite数据文件。<br>stats：是proxysql运行抓取的统计信息，包括到后端各命令的执行次数、流量、processlist、查询各类汇总、执行时间等。<br>monitor：库存储monitor模块收集的信息，主要是对后端db的健康、延迟检查。  </p><h4 id="main库"><a href="#main库" class="headerlink" title="main库"></a>main库</h4><h5 id="runtime-表"><a href="#runtime-表" class="headerlink" title="runtime_表"></a>runtime_表</h5><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 17:19:10 &gt; use main</span><br><span class="line">Database changed</span><br><span class="line">MySQL [main] 17:22:15 &gt; show tables;</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">|<span class="string"> tables                                     </span>|</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">|<span class="string"> global_variables                           </span>|</span><br><span class="line">|<span class="string"> mysql_collations                           </span>|</span><br><span class="line">|<span class="string"> mysql_group_replication_hostgroups         </span>|</span><br><span class="line">|<span class="string"> mysql_query_rules                          </span>|</span><br><span class="line">|<span class="string"> mysql_replication_hostgroups               </span>|</span><br><span class="line">|<span class="string"> mysql_servers                              </span>|</span><br><span class="line">|<span class="string"> mysql_users                                </span>|</span><br><span class="line">|<span class="string"> proxysql_servers                           </span>|</span><br><span class="line">|<span class="string"> runtime_global_variables                   </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_group_replication_hostgroups </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_query_rules                  </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_replication_hostgroups       </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_servers                      </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_users                        </span>|</span><br><span class="line">|<span class="string"> runtime_proxysql_servers                   </span>|</span><br><span class="line">|<span class="string"> runtime_scheduler                          </span>|</span><br><span class="line">|<span class="string"> scheduler                                  </span>|</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">17 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 17:22:16 &gt;</span><br></pre></td></tr></table></figure><p>其中，runtime_开关的表如下：  </p><ul><li>runtime_global_variables：global_variables的运行时版本  </li><li>runtime_mysql_group_replication_hostgroups：mysql_group_replication_hostgroups的运行时版本  </li><li>runtime_mysql_query_rules：mysql_query_rules的运行时版本  </li><li>runtime_mysql_replication_hostgroups：mysql_replication_hostsgroups的运行时版本  </li><li>runtime_mysql_servers：mysql_servers的运行时版本  </li><li>runtime_mysql_users：mysql_users的运行时版本  </li><li><p>runtime_scheduler：scheduler调度程序的运行时版本</p><h6 id="global-variables表"><a href="#global-variables表" class="headerlink" title="global_variables表"></a>global_variables表</h6><p>内置参数表，参考下文</p><h6 id="mysql-servers表"><a href="#mysql-servers表" class="headerlink" title="mysql_servers表"></a>mysql_servers表</h6><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] <span class="number">17</span>:<span class="number">22</span>:<span class="number">16</span> &gt; show create table mysql_servers\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: mysql_servers</span><br><span class="line">Create Table: CREATE TABLE mysql_servers (</span><br><span class="line">    hostgroup_id <span class="built_in">INT</span> <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    hostname VARCHAR <span class="literal">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    port <span class="built_in">INT</span> <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">3306</span>,</span><br><span class="line">    status VARCHAR CHECK (UPPER(status) <span class="keyword">IN</span> (<span class="string">'ONLINE'</span>,<span class="string">'SHUNNED'</span>,<span class="string">'OFFLINE_SOFT'</span>, <span class="string">'OFFLINE_HARD'</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'ONLINE'</span>,</span><br><span class="line">    weight <span class="built_in">INT</span> CHECK (weight &gt;= <span class="number">0</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    compression <span class="built_in">INT</span> CHECK (compression &gt;=<span class="number">0</span> <span class="literal">AND</span> compression &lt;= <span class="number">102400</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    max_connections <span class="built_in">INT</span> CHECK (max_connections &gt;=<span class="number">0</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1000</span>,</span><br><span class="line">    max_replication_lag <span class="built_in">INT</span> CHECK (max_replication_lag &gt;= <span class="number">0</span> <span class="literal">AND</span> max_replication_lag &lt;= <span class="number">126144000</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    use_ssl <span class="built_in">INT</span> CHECK (use_ssl <span class="keyword">IN</span>(<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    max_latency_ms <span class="built_in">INT</span> UNSIGNED CHECK (max_latency_ms&gt;=<span class="number">0</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    comment VARCHAR <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">    PRIMARY KEY (hostgroup_id, hostname, port) )</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] <span class="number">17</span>:<span class="number">34</span>:<span class="number">05</span> &gt;</span><br></pre></td></tr></table></figure></li><li><p>hostgroup_id：ProxySQL通过hostgroup的形式组织后端db实例,一个hostgroup代表同属于一个角色。<br>表的主键是(hostgroup_id, hostname, port),以hostname:port在多个hostgroup中存在。<br>一个hostgroup可以有多个实例，即是多个从库，可能通过weight分配权重。<br>hostgroup_id 0是一个特殊的hostgroup，路由查询的时候，没有匹配到规则则默认选择hostgroup 0。  </p></li><li>status：<br>ONLINE：当前后端实例状态正常。<br>SHUNNED：临时被剔除，可能因为后端too many connection error，或者超过了max_replication_lag。<br>OFFLINE_SOFT：软离线状态，不再接受新的连接，但已建立的连接会等待活跃事务完成。<br>OFFLINE_HARD：硬离线状态，不再接受新的连接，已建立的连接或被强制中断，当后端实例宕机或网络不可达，会出现。  </li><li>max_connections：允许连接到该后端实例的最大连接数，不要大于MySQL的max_connections。<br>如果后端实例hostname:port在多个hostgroup里，以较大者为准，而不是各自独立允许的最大连接数。  </li><li>max_replication_lag：允许的最大延迟，主库不受影响，默认为0，如果&gt;0，monitor模块监控主从延迟大于阈值时，会临时把它的状态变更为SHUNNED。  </li><li>max_latency_ms：mysql_ping响应时间，大于这个阈值会把它从连接池剔除，即使是ONLINE。  </li><li>comment：备注，不建设为空。  </li><li><p>其他的字段，可通过字面意思理解。  </p><h5 id="mysql-users表"><a href="#mysql-users表" class="headerlink" title="mysql_users表"></a>mysql_users表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 09:13:02 &gt; show create table mysql_users\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_users</span><br><span class="line">Create Table: CREATE TABLE mysql_users (</span><br><span class="line">    username VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    password VARCHAR,</span><br><span class="line">    active INT CHECK (active <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</span><br><span class="line">    use_ssl INT CHECK (use_ssl <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    default_hostgroup INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    default_schema VARCHAR,</span><br><span class="line">    schema_locked INT CHECK (schema_locked <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    transaction_persistent INT CHECK (transaction_persistent <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</span><br><span class="line">    fast_forward INT CHECK (fast_forward <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    backend INT CHECK (backend <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</span><br><span class="line">    frontend INT CHECK (frontend <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</span><br><span class="line">    max_connections INT CHECK (max_connections &gt;=0) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>10000,</span><br><span class="line">    PRIMARY KEY (username, backend),</span><br><span class="line">    UNIQUE (username, frontend))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 09:13:08 &gt;</span><br></pre></td></tr></table></figure></li><li><p>username,password：连接到后端MySQL或ProxySQL实例的凭证,参考<a href="https://github.com/sysown/proxysql/wiki/Passwords-management" target="_blank" rel="noopener">密码管理</a>。<br>密码可插入明文，也可通过PASSWORD()插入密文，proxysql以*开头判断插入是否是密文。<br>但是runtime_mysql_users里统一是密文，所以明文插入，再SAVE MYSQL USERS TO MEM，此时看到的也是HASH密文。  </p></li><li>active：是否生效该用户，active=0的用户将在数据库中被跟踪，但不会加载到内存中的数据结构中。  </li><li>default_hostgroup：这个用户的请求没有匹配到规则时，默认发到hostgroup，默认0。  </li><li>default_schema：这个用户连接时没有指定schema时，默认使用的schema。<br>默认为NULL，实际上受变量mysql-default_schema的影响，默认为information_schema。  </li><li>transaction_persistent： 如果设置为1，连接上ProxySQL的会话后，如果在一个hostgroup上开启了事务，那么后续的sql都继续维持在这个hostgroup上，不论是否会匹配上其它路由规则，直到事务结束。  </li><li>frontend：如果设置为1，则用户名、密码对ProxySQL进行身份验证。  </li><li><p>backend：如果设置为1，则用户名、密码根据任何主机组向mysqld服务器进行身份验证。<br>注意，目前所有用户都需要将“前端”和“后端“都设置为1，未来版本的ProxySQL将分离前端和后端之间的crendentials。以这种方式，前端将永远不会知道直接连接到后端的凭据，强制所有通过ProxySQL的连接并增加系统的安全性。  </p><h5 id="mysql-replication-hostgroups表"><a href="#mysql-replication-hostgroups表" class="headerlink" title="mysql_replication_hostgroups表"></a>mysql_replication_hostgroups表</h5><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 10:<span class="number">18</span>:<span class="number">15</span> &gt; <span class="keyword">show</span> <span class="keyword">create</span> table mysql_replication_hostgroups\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: mysql_replication_hostgroups</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE mysql_replication_hostgroups (</span><br><span class="line">    writer_hostgroup INT CHECK (writer_hostgroup&gt;=<span class="number">0</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,</span><br><span class="line">    reader_hostgroup INT <span class="keyword">NOT</span> <span class="literal">NULL</span> CHECK (reader_hostgroup&lt;&gt;writer_hostgroup <span class="keyword">AND</span> reader_hostgroup&gt;<span class="number">0</span>),</span><br><span class="line">    comment VARCHAR,</span><br><span class="line">    <span class="keyword">UNIQUE</span> (reader_hostgroup))</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] <span class="number">10</span>:<span class="number">18</span>:<span class="number">22</span> &gt;</span><br></pre></td></tr></table></figure></li><li><p>定义hostgroup的主从关系。ProxySQL monitor模块会监控hostgroup后端所有servers的read_only变量，如果发现从库的read_only变为0、主库变为1，则认为角色互换了，自动改写mysql_servers表里面hostgroup关系，达到failover效果。  </p><h5 id="mysql-query-rules查询规则表"><a href="#mysql-query-rules查询规则表" class="headerlink" title="mysql_query_rules查询规则表"></a>mysql_query_rules查询规则表</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] <span class="number">10</span>:<span class="number">25</span>:<span class="number">22</span> &gt; show create table mysql_query_rules\G           </span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: mysql_query_rules</span><br><span class="line">Create Table: CREATE TABLE mysql_query_rules (</span><br><span class="line">    rule_id INTEGER PRIMARY KEY AUTOINCREMENT <span class="literal">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    active <span class="built_in">INT</span> CHECK (active <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    username VARCHAR,</span><br><span class="line">    schemaname VARCHAR,</span><br><span class="line">    flagIN <span class="built_in">INT</span> <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    client_addr VARCHAR,</span><br><span class="line">    proxy_addr VARCHAR,</span><br><span class="line">    proxy_port <span class="built_in">INT</span>,</span><br><span class="line">    digest VARCHAR,</span><br><span class="line">    match_digest VARCHAR,</span><br><span class="line">    match_pattern VARCHAR,</span><br><span class="line">    negate_match_pattern <span class="built_in">INT</span> CHECK (negate_match_pattern <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    re_modifiers VARCHAR <span class="keyword">DEFAULT</span> <span class="string">'CASELESS'</span>,</span><br><span class="line">    flagOUT <span class="built_in">INT</span>,</span><br><span class="line">    replace_pattern VARCHAR,</span><br><span class="line">    destination_hostgroup <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cache_ttl <span class="built_in">INT</span> CHECK(cache_ttl &gt; <span class="number">0</span>),</span><br><span class="line">    reconnect <span class="built_in">INT</span> CHECK (reconnect <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">    timeout <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    retries <span class="built_in">INT</span> CHECK (retries&gt;=<span class="number">0</span> <span class="literal">AND</span> retries &lt;=<span class="number">1000</span>),</span><br><span class="line">    delay <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    next_query_flagIN <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    mirror_flagOUT <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    mirror_hostgroup <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    error_msg VARCHAR,</span><br><span class="line">    OK_msg VARCHAR,</span><br><span class="line">    sticky_conn <span class="built_in">INT</span> CHECK (sticky_conn <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)),</span><br><span class="line">    multiplex <span class="built_in">INT</span> CHECK (multiplex <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>)),</span><br><span class="line">    <span class="built_in">log</span> <span class="built_in">INT</span> CHECK (<span class="built_in">log</span> <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)),</span><br><span class="line">    apply <span class="built_in">INT</span> CHECK(apply <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    comment VARCHAR)</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] <span class="number">10</span>:<span class="number">25</span>:<span class="number">34</span> &gt;</span><br></pre></td></tr></table></figure></li><li><p>rule_id：表主键，自增，规则处理是以rule_id为顺序进行。  </p></li><li>active：只有active=1时的规则才会参与匹配。  </li><li>username：过滤匹配用户名的条件，如果是非空值，则仅当连接使用正确的用户名时，查询才匹配。  </li><li>schemaname：匹配schemaname的过滤条件，如果是非空值，则仅当连接schemaname用作默认模式时，查询才匹配。  </li><li>flagIN,flagOUT,apply：用来定义路由链chains of rules<br>首先会检查flagIN=0的规则，以rule_id的顺序；如果没有匹配上，则走这个用户的default_hostgroup。<br>当匹配一条规则后，会检查flagOUT。<br>如果不为NULL，并且flagIN!=flagOUT，则进入以flagIN为上一个flagOUT值的新规则链。<br>如果不为NULL，并且flagIN=flagOUT，则应用这条规则。<br>如果为NULL，或者apply=1，则结束，应用这条规则。<br>如果最终没有匹配到，则找到这个用户的default_hostgroup。  </li><li>client_addr：匹配客户端来源IP。  </li><li>proxy_addr,proxy_port：匹配本地proxysql的ip、端口。  </li><li>digest：精确匹配的查询。  </li><li>match_digest：正则匹配查询。query,digest是指对查询去掉具体值后进行”模糊化“后的查询，类似pt-query-digest的效果。  </li><li>match_pattern：正则匹配查询。<br>以上都是匹配查询的规则，1.4版本可以通过变量mysql-query_processor_regex设置，支持RE2和PCRE，1.4版本开始默认为PCRE。  </li><li>negate_match_pattern：反向匹配，相当于对match_digest/match_pattern的匹配取反。  </li><li>re_modifiers：修改正则匹配的参数，比如默认的：忽略大小写CASELESS、禁用GLOBAL。  </li><li>下面是匹配后的行为：  </li><li>replace_pattern：查询重写，默认为空。  </li><li>destination_hostgroup：路由查询到这个hostgroup，当然如果用户显式start transaction且transaction_persistent=1,那么即使匹配到了，也依然按照事务里第一条sql的路由规则去走的。  </li><li>cache_ttl：查询结果缓存的毫秒数。  </li><li>timeout：这一类查询执行的的最大时间(毫秒),超时则自动kill。<br>这是对后端DB的保护机制，相当于阿里云RDS的loose_max_statement_time变量的功能，但不同的是，阿里云这个变量的时间时不包括DML操作出现InnoDB行锁等待的时间，而ProxySQL的这个timeout是计算从发送sql到等待响应的时间。默认mysql-default_query_timeout是10h。  </li><li>retries：语句在执行失败时，重试次数。默认由mysql-query_retries_on_failure变量指定，为1。建议不要重试，有风险。  </li><li>delay：查询延迟执行，这是ProxySQL提供的限流机制，会让其它的查询优先执行。<br>默认值mysql-default_query_delay为0。  </li><li>mirror_flagOUT,mirror_hostgroup：与镜像相关的设置。  </li><li>error_msg：默认为NULL，如果指定了则这个查询直接被block掉，将error_msg返回给客户端。  </li><li>multiplex：连接是否利用，请参考<a href="http://seanlook.com/2017/04/17/mysql-proxysql-multiplexing/" target="_blank" rel="noopener">文章</a>。  </li><li><p>log：是否记录查询日志，可以看到log是否记录的对象是根据规则。<br>要开启日志记录，需要设置变量mysql-eventslog_filename来指定文件名，然后这个log标记为1。但是目前proxysql记录的日志是二进制格式，需要特定的工具才能读取：eventslog_reader_sample。这个工具在源码目录 tools下面。  </p><h5 id="scheduler调度表"><a href="#scheduler调度表" class="headerlink" title="scheduler调度表"></a>scheduler调度表</h5><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 10:<span class="number">27</span>:<span class="number">52</span> &gt; <span class="keyword">show</span> <span class="keyword">create</span> table scheduler\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: scheduler</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE scheduler (</span><br><span class="line">    id INTEGER <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> AUTOINCREMENT <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    active INT CHECK (active <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="number">1</span>,</span><br><span class="line">    interval_ms INTEGER CHECK (interval_ms&gt;=<span class="number">100</span> <span class="keyword">AND</span> interval_ms&lt;=<span class="number">100000000</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    filename VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    arg1 VARCHAR,</span><br><span class="line">    arg2 VARCHAR,</span><br><span class="line">    arg3 VARCHAR,</span><br><span class="line">    arg4 VARCHAR,</span><br><span class="line">    arg5 VARCHAR,</span><br><span class="line">    comment VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>)</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] <span class="number">11</span>:<span class="number">09</span>:<span class="number">59</span> &gt;</span><br></pre></td></tr></table></figure></li><li><p>id：调度程序作业的唯一标识符。  </p></li><li>active：如果设置为1，则作业处于活动状态。</li><li>interval_ms：工作的开始频率(以毫秒为单位)，最小interval_ms为100毫秒。  </li><li>filename：可执行文件的完整路径。  </li><li>arg1-arg5：传递作业的参数。最多5个。  </li><li>comment：注释。  </li><li>参考<a href="https://github.com/sysown/proxysql/wiki/Scheduler" target="_blank" rel="noopener">文档</a><h4 id="disk库"><a href="#disk库" class="headerlink" title="disk库"></a>disk库</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 15:12:14 &gt; show tables from disk;</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">| tables                             |</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">| global<span class="emphasis">_variables                   |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>collations                   |</span><br><span class="line">| mysql<span class="emphasis">_group_</span>replication<span class="emphasis">_hostgroups |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>query<span class="emphasis">_rules                  |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>replication<span class="emphasis">_hostgroups       |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>servers                      |</span><br><span class="line">| mysql<span class="emphasis">_users                        |</span></span><br><span class="line"><span class="emphasis">| proxysql_</span>servers                   |</span><br><span class="line">| scheduler                          |</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">9 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 15:12:26 &gt;</span><br></pre></td></tr></table></figure></li></ul><p>具体的表介绍和main库一致。  </p><h4 id="stats库"><a href="#stats库" class="headerlink" title="stats库"></a>stats库</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 15:12:26 &gt; show tables from stats;</span><br><span class="line">+-----------------------------------+</span><br><span class="line">|<span class="string"> tables                            </span>|</span><br><span class="line">+-----------------------------------+</span><br><span class="line">|<span class="string"> global_variables                  </span>|</span><br><span class="line">|<span class="string"> stats_memory_metrics              </span>|</span><br><span class="line">|<span class="string"> stats_mysql_commands_counters     </span>|</span><br><span class="line">|<span class="string"> stats_mysql_connection_pool       </span>|</span><br><span class="line">|<span class="string"> stats_mysql_connection_pool_reset </span>|</span><br><span class="line">|<span class="string"> stats_mysql_global                </span>|</span><br><span class="line">|<span class="string"> stats_mysql_processlist           </span>|</span><br><span class="line">|<span class="string"> stats_mysql_query_digest          </span>|</span><br><span class="line">|<span class="string"> stats_mysql_query_digest_reset    </span>|</span><br><span class="line">|<span class="string"> stats_mysql_query_rules           </span>|</span><br><span class="line">|<span class="string"> stats_mysql_users                 </span>|</span><br><span class="line">|<span class="string"> stats_proxysql_servers_metrics    </span>|</span><br><span class="line">|<span class="string"> stats_proxysql_servers_status     </span>|</span><br><span class="line">+-----------------------------------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 15:13:53 &gt;</span><br></pre></td></tr></table></figure><h5 id="stats-mysql-commands-counters表"><a href="#stats-mysql-commands-counters表" class="headerlink" title="stats_mysql_commands_counters表"></a>stats_mysql_commands_counters表</h5><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] <span class="number">15</span>:<span class="number">15</span>:<span class="number">36</span> &gt; show create table stats.stats_mysql_commands_counters\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: stats_mysql_commands_counters</span><br><span class="line">Create Table: CREATE TABLE stats_mysql_commands_counters (</span><br><span class="line">    Command VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY KEY,</span><br><span class="line">    Total_Time_us <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    Total_cnt <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_100us <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_500us <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_1ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_5ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_10ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_50ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_100ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_500ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_1s <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_5s <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_10s <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_INFs)</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] <span class="number">15</span>:<span class="number">15</span>:<span class="number">58</span> &gt;</span><br></pre></td></tr></table></figure><ul><li>command：已执行的SQL命令的类型，如FLUSH、INSERT、KILL、SELECT FOR UPDATE等。  </li><li>Total_Time_us：执行该类型命令的总时间(以毫秒为单位)。  </li><li>Total_cnt：执行该类型的命令的总数。  </li><li><p>cnt_100us-cnt_INFs：在指定的时间限制内执行的给定类型的命令总数和前一个命令的总数。<br>#####　stats_mysql_connection_pool表</p><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] <span class="symbol">15:15</span><span class="symbol">:58</span> &gt; show create table stats.stats_mysql_connection_pool \G </span><br><span class="line">*************************** <span class="number">1</span>. <span class="built_in">row</span> ***************************</span><br><span class="line">       tab<span class="symbol">le:</span> stats_mysql_connection_pool</span><br><span class="line">Create Tab<span class="symbol">le:</span> CREATE TABLE stats_mysql_connection_pool (</span><br><span class="line">    hostgroup <span class="built_in">INT</span>,</span><br><span class="line">    srv_host VARCHAR,</span><br><span class="line">    srv_port <span class="built_in">INT</span>,</span><br><span class="line">    status VARCHAR,</span><br><span class="line">    ConnUsed <span class="built_in">INT</span>,</span><br><span class="line">    ConnFree <span class="built_in">INT</span>,</span><br><span class="line">    ConnOK <span class="built_in">INT</span>,</span><br><span class="line">    ConnERR <span class="built_in">INT</span>,</span><br><span class="line">    Queries <span class="built_in">INT</span>,</span><br><span class="line">    Bytes_data_sent <span class="built_in">INT</span>,</span><br><span class="line">    Bytes_data_recv <span class="built_in">INT</span>,</span><br><span class="line">    Latency_us <span class="built_in">INT</span>)</span><br><span class="line"><span class="number">1</span> <span class="built_in">row</span> in set (<span class="number">0.00</span> <span class="built_in">sec</span>)</span><br><span class="line"></span><br><span class="line">MySQL [stats] <span class="symbol">15:20</span><span class="symbol">:08</span> &gt;</span><br></pre></td></tr></table></figure></li><li><p>hostgroup：后端服务器所属的主机组，单个后端服务器可以属于多个主机组。  </p></li><li>srv_host,srv_port：mysqld后端服务器正在侦听连接的TCP端点的IP和Port。  </li><li>status：后端服务器的状态。可以有ONLINE，SHUNNED，OFFLINE_SOFT，OFFLINE_HARD。  </li><li>ConnUsed：ProxySQL当前使用多少个连接来向后端服务器发送查询。  </li><li>ConnFree：目前有多少个连接是空闲。  </li><li>ConnOK：成功建立了多少个连接。</li><li>ConnERR：没有成功建立多少个连接。</li><li>Queries：路由到此特定后端服务器的查询数。</li><li>Bytes_data_sent：发送到后端的数据量。</li><li>Bytes_data_recv：从后端接收的数据量。</li><li><p>Latency_ms：从Monitor报告的当前ping以毫秒为单位的延迟时间。</p><h5 id="stats-mysql-global表"><a href="#stats-mysql-global表" class="headerlink" title="stats_mysql_global表"></a>stats_mysql_global表</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:20:08 &gt; show create table stats.stats<span class="emphasis">_mysql_</span>global\G          </span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line"><span class="code">       table: stats_mysql_global</span></span><br><span class="line">Create Table: CREATE TABLE stats<span class="emphasis">_mysql_</span>global (</span><br><span class="line"><span class="code">    Variable_Name VARCHAR NOT NULL PRIMARY KEY,</span></span><br><span class="line"><span class="code">    Variable_Value VARCHAR NOT NULL)</span></span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:22:35 &gt;</span><br></pre></td></tr></table></figure></li><li><p>Variable_Name：代表与MySQL相关的代理级别的全局统计<br>如Client_Connections_aborted：由于无效凭据或max_connections而导致的前端连接数已达到；<br>如Client_Connections_connected：当前连接的前端连接数。<br>如Client_Connections_created：到目前为止创建的前端连接数。等等。</p></li><li><p>Variable_Value：统计所对应的值。  </p><h5 id="stats-mysql-processlist表"><a href="#stats-mysql-processlist表" class="headerlink" title="stats_mysql_processlist表"></a>stats_mysql_processlist表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:24:11 &gt; show create table stats.stats_mysql_processlist\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: stats_mysql_processlist</span><br><span class="line">Create Table: CREATE TABLE stats_mysql_processlist (</span><br><span class="line">    ThreadID INT <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    SessionID INTEGER PRIMARY KEY,</span><br><span class="line">   <span class="built_in"> user </span>VARCHAR,</span><br><span class="line">    db VARCHAR,</span><br><span class="line">    cli_host VARCHAR,</span><br><span class="line">    cli_port INT,</span><br><span class="line">    hostgroup INT,</span><br><span class="line">    l_srv_host VARCHAR,</span><br><span class="line">    l_srv_port INT,</span><br><span class="line">    srv_host VARCHAR,</span><br><span class="line">    srv_port INT,</span><br><span class="line">    command VARCHAR,</span><br><span class="line">    time_ms INT <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="builtin-name">info</span> VARCHAR)</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:26:43 &gt;</span><br></pre></td></tr></table></figure></li><li><p>ThreadID：ProxySQL线程的内部ID。  </p></li><li>SessionID：ProxySQL会话ID，通过这个ID可以进行kill操作。</li><li>user：与MySQL客户端连接到ProxySQL的用户。</li><li>db：当前选择的数据库。</li><li>cli_host,cli_port：连接ProxySQL的IP和TCP端口。</li><li>hostgroup：当前主机组。如果正在处理查询，则是查询已被路由或将要路由的主机组，或默认主机组。可以通过这个查看该SQL到底是到哪个HG里。</li><li>l_srv_host,l_srv_port：ProxySQL的IP和TCP端口。</li><li>srv_host,srv_port：后端MySQL服务器的IP和端口。</li><li>command：正在执行的MySQL查询的类型。</li><li>time_ms：命令执行的时间(以毫秒为单位)。</li><li><p>info：正在执行的SQL。</p><h5 id="stats-mysql-query-digest表"><a href="#stats-mysql-query-digest表" class="headerlink" title="stats_mysql_query_digest表"></a>stats_mysql_query_digest表</h5><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:26:43 &gt; show <span class="keyword">create</span> table stats.stats_mysql_query_digest\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: stats_mysql_query_digest</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE stats_mysql_query_digest (</span><br><span class="line">    hostgroup INT,</span><br><span class="line">    schemaname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    username VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    digest VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    digest_text VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    count_star INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    first_seen INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    last_seen INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    sum_time INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    min_time INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    max_time INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>(hostgroup, schemaname, username, digest))</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] <span class="number">15</span>:<span class="number">29</span>:<span class="number">27</span> &gt;</span><br></pre></td></tr></table></figure></li><li><p>hostgroup：发送查询的主机组。值-1表示查询查询缓存。</p></li><li>schemaname：查询的数据库。</li><li>user：连接ProxySQL的用户名。</li><li>digest：一个十六进制散列，表示其参数剥离的SQL。</li><li>digest_text：参数剥离的实际SQL文本</li><li>count_star：执行查询的总次数（参数的值不同）。</li><li>first_seen：unix时间戳，是通过代理路由查询的第一时刻。</li><li>last_seen：unix时间戳，当查询通过代理路由时的最后一刻（到目前为止）。</li><li>sum_time：执行此类查询的总时间（以微秒为单位）。<br>这对于确定应用程序工作负载中花费的最多时间在哪里是非常有用的，并为改进的地方提供了一个良好的起点。</li><li><p>min_time,max_time - 执行此类查询时期望的持续时间范围。<br>min_time是到目前为止所看到的最小执行时间，而max_time表示最大执行时间，以微秒为单位。</p><h5 id="stats-mysql-query-rules表"><a href="#stats-mysql-query-rules表" class="headerlink" title="stats_mysql_query_rules表"></a>stats_mysql_query_rules表</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:29:27 &gt; show create table stats.stats<span class="emphasis">_mysql_</span>query_rules\G </span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line"><span class="code">       table: stats_mysql_query_rules</span></span><br><span class="line">Create Table: CREATE TABLE stats<span class="emphasis">_mysql_</span>query_rules (</span><br><span class="line"><span class="code">    rule_id INTEGER PRIMARY KEY,</span></span><br><span class="line"><span class="code">    hits INT NOT NULL)</span></span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:31:57 &gt;</span><br></pre></td></tr></table></figure></li><li><p>rule_id：路由规则的ID与main.mysql_query_rules的id对应。</p></li><li>hits：此路由规则的匹配总数。 如果当前传入的查询符合规则，则会记录一次命中。<h4 id="monitor库"><a href="#monitor库" class="headerlink" title="monitor库"></a>monitor库</h4>对后端MySQL的健康检查，由变量mysql-monitor_enabled来确定是否开启Monitor模块。  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:35:32 &gt; show tables from monitor;                               </span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">| tables                             |</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">| mysql<span class="emphasis">_server_</span>connect               |</span><br><span class="line">| mysql<span class="emphasis">_server_</span>connect<span class="emphasis">_log           |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>server<span class="emphasis">_group_</span>replication<span class="emphasis">_log |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>server<span class="emphasis">_ping                  |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>server<span class="emphasis">_ping_</span>log              |</span><br><span class="line">| mysql<span class="emphasis">_server_</span>read<span class="emphasis">_only_</span>log         |</span><br><span class="line">| mysql<span class="emphasis">_server_</span>replication<span class="emphasis">_lag_</span>log   |</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:35:52 &gt;</span><br></pre></td></tr></table></figure></li></ul><h5 id="mysql-server-connect-mysql-server-connect-log表"><a href="#mysql-server-connect-mysql-server-connect-log表" class="headerlink" title="mysql_server_connect/mysql_server_connect_log表"></a>mysql_server_connect/mysql_server_connect_log表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:37:39 &gt; show create table monitor.mysql_server_connect\G  </span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_connect</span><br><span class="line">Create Table: CREATE TABLE mysql_server_connect (</span><br><span class="line">    hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_since INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    time_until INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_time_min INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_time_max INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_time_total INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_failure_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_failure_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_failure_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    PRIMARY KEY (hostname, port))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:37:46 &gt; show create table monitor.mysql_server_connect_log\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_connect_log</span><br><span class="line">Create Table: CREATE TABLE mysql_server_connect_log (</span><br><span class="line">    hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_start_us INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_time_us INT<span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_error VARCHAR,</span><br><span class="line">    PRIMARY KEY (hostname, port, time_start_us))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:37:51 &gt;</span><br></pre></td></tr></table></figure><ul><li><p>连接到所有MySQL服务器以检查它们是否可用，该表用来存放检测连接的日志。由变量mysql-monitor_connect_interval来控制其检测的时间间隔，由参数mysql-monitor_connect_timeout控制连接是否超时（默认200毫秒）。</p><h5 id="mysql-server-ping-mysql-server-ping-log表"><a href="#mysql-server-ping-mysql-server-ping-log表" class="headerlink" title="mysql_server_ping/mysql_server_ping_log表"></a>mysql_server_ping/mysql_server_ping_log表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:39:23 &gt; show create table monitor.mysql_server_ping\G       </span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_ping</span><br><span class="line">Create Table: CREATE TABLE mysql_server_ping (</span><br><span class="line">    hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_since INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    time_until INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0, ping_success_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_time_min INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_time_max INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_time_total INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_failure_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_failure_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_failure_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    PRIMARY KEY (hostname, port))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:40:12 &gt; show create table monitor.mysql_server_ping_log\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_ping_log</span><br><span class="line">Create Table: CREATE TABLE mysql_server_ping_log (</span><br><span class="line">     hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_start_us INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_time_us INT<span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_error VARCHAR,</span><br><span class="line">    PRIMARY KEY (hostname, port, time_start_us))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:40:15 &gt;</span><br></pre></td></tr></table></figure></li><li><p>使用mysql_ping API ping后端MySQL服务器检查它们是否可用，该表用来存放ping的日志。由变量mysql-monitor_ping_interval控制ping的时间间隔，默认值：10000（毫秒，相当于10秒）。</p><h5 id="mysql-server-replication-lag-log表"><a href="#mysql-server-replication-lag-log表" class="headerlink" title="mysql_server_replication_lag_log表"></a>mysql_server_replication_lag_log表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:40:53 &gt; show create table monitor.mysql_server_replication_lag_log\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_replication_lag_log</span><br><span class="line">Create Table: CREATE TABLE mysql_server_replication_lag_log (</span><br><span class="line">     hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_start_us INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    success_time_us INT<span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    repl_lag INT<span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    <span class="builtin-name">error</span> VARCHAR,</span><br><span class="line">    PRIMARY KEY (hostname, port, time_start_us))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:41:12 &gt;</span><br></pre></td></tr></table></figure></li><li><p>后端MySQL服务主从延迟的检测。由参数mysql-monitor_replication_lag_interval控制检测间隔时间， 如果复制滞后太大，可以暂时关闭从。由mysql_servers.max_replication_lag列控制。默认值：10000（毫秒，相当于10秒）。</p></li></ul><h4 id="内置参数"><a href="#内置参数" class="headerlink" title="内置参数"></a>内置参数</h4><p>global_variables 1.4版本中有95个参数，参数较多，解释请参考<a href="https://github.com/sysown/proxysql/wiki/Global-variables" target="_blank" rel="noopener">文档</a>。<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 11:16:22 &gt; show variables;</span><br><span class="line">+-----------------------------------------------------+--------------------+</span><br><span class="line">|<span class="string"> Variable_name                                       </span>|<span class="string"> Value              </span>|</span><br><span class="line">+-----------------------------------------------------+--------------------+</span><br><span class="line">|<span class="string"> admin-admin_credentials                             </span>|<span class="string"> admin:admin        </span>|</span><br><span class="line">|<span class="string"> admin-cluster_check_interval_ms                     </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> admin-cluster_password                              </span>|<span class="string">                    </span>|</span><br><span class="line">|<span class="string"> admin-cluster_username                              </span>|<span class="string">                    </span>|</span><br><span class="line">|<span class="string"> admin-hash_passwords                                </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> admin-mysql_ifaces                                  </span>|<span class="string"> 0.0.0.0:6032       </span>|</span><br><span class="line">|<span class="string"> admin-read_only                                     </span>|<span class="string"> false              </span>|</span><br><span class="line">|<span class="string"> admin-refresh_interval                              </span>|<span class="string"> 2000               </span>|</span><br><span class="line">|<span class="string"> admin-stats_credentials                             </span>|<span class="string"> stats:stats        </span>|</span><br><span class="line">|<span class="string"> admin-telnet_admin_ifaces                           </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> admin-telnet_stats_ifaces                           </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> admin-version                                       </span>|<span class="string"> 1.4.1-45-gab4e6ee  </span>|</span><br><span class="line">|<span class="string"> mysql-client_found_rows                             </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-commands_stats                                </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-connect_retries_delay                         </span>|<span class="string"> 1                  </span>|</span><br><span class="line">|<span class="string"> mysql-connect_retries_on_failure                    </span>|<span class="string"> 10                 </span>|</span><br><span class="line">|<span class="string"> mysql-connect_timeout_server                        </span>|<span class="string"> 3000               </span>|</span><br><span class="line">|<span class="string"> mysql-connect_timeout_server_max                    </span>|<span class="string"> 10000              </span>|</span><br><span class="line">|<span class="string"> mysql-connection_delay_multiplex_ms                 </span>|<span class="string"> 0                  </span>|</span><br><span class="line">|<span class="string"> mysql-connection_max_age_ms                         </span>|<span class="string"> 0                  </span>|</span><br><span class="line">|<span class="string"> mysql-default_charset                               </span>|<span class="string"> utf8               </span>|</span><br><span class="line">|<span class="string"> mysql-default_max_latency_ms                        </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-default_query_delay                           </span>|<span class="string"> 0                  </span>|</span><br><span class="line">|<span class="string"> mysql-default_query_timeout                         </span>|<span class="string"> 36000000           </span>|</span><br><span class="line">|<span class="string"> mysql-default_reconnect                             </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-default_schema                                </span>|<span class="string"> information_schema </span>|</span><br><span class="line">|<span class="string"> mysql-default_sql_mode                              </span>|<span class="string">                    </span>|</span><br><span class="line">|<span class="string"> mysql-default_time_zone                             </span>|<span class="string"> SYSTEM             </span>|</span><br><span class="line">|<span class="string"> mysql-enforce_autocommit_on_reads                   </span>|<span class="string"> false              </span>|</span><br><span class="line">|<span class="string"> mysql-eventslog_filename                            </span>|<span class="string">                    </span>|</span><br><span class="line">|<span class="string"> mysql-eventslog_filesize                            </span>|<span class="string"> 104857600          </span>|</span><br><span class="line">|<span class="string"> mysql-forward_autocommit                            </span>|<span class="string"> false              </span>|</span><br><span class="line">|<span class="string"> mysql-free_connections_pct                          </span>|<span class="string"> 10                 </span>|</span><br><span class="line">|<span class="string"> mysql-have_compress                                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-hostgroup_manager_verbose                     </span>|<span class="string"> 1                  </span>|</span><br><span class="line">|<span class="string"> mysql-init_connect                                  </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-interfaces                                    </span>|<span class="string"> 0.0.0.0:6033       </span>|</span><br><span class="line">|<span class="string"> mysql-long_query_time                               </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-max_allowed_packet                            </span>|<span class="string"> 4194304            </span>|</span><br><span class="line">|<span class="string"> mysql-max_connections                               </span>|<span class="string"> 2048               </span>|</span><br><span class="line">|<span class="string"> mysql-max_stmts_cache                               </span>|<span class="string"> 10000              </span>|</span><br><span class="line">|<span class="string"> mysql-max_stmts_per_connection                      </span>|<span class="string"> 20                 </span>|</span><br><span class="line">|<span class="string"> mysql-max_transaction_time                          </span>|<span class="string"> 14400000           </span>|</span><br><span class="line">|<span class="string"> mysql-mirror_max_concurrency                        </span>|<span class="string"> 16                 </span>|</span><br><span class="line">|<span class="string"> mysql-mirror_max_queue_length                       </span>|<span class="string"> 32000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_connect_interval                      </span>|<span class="string"> 60000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_connect_timeout                       </span>|<span class="string"> 600                </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_enabled                               </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_groupreplication_healthcheck_interval </span>|<span class="string"> 5000               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_groupreplication_healthcheck_timeout  </span>|<span class="string"> 800                </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_history                               </span>|<span class="string"> 600000             </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_password                              </span>|<span class="string"> monitor            </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_ping_interval                         </span>|<span class="string"> 10000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_ping_max_failures                     </span>|<span class="string"> 3                  </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_ping_timeout                          </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_query_interval                        </span>|<span class="string"> 60000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_query_timeout                         </span>|<span class="string"> 100                </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_read_only_interval                    </span>|<span class="string"> 1500               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_read_only_timeout                     </span>|<span class="string"> 500                </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_replication_lag_interval              </span>|<span class="string"> 10000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_replication_lag_timeout               </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_slave_lag_when_null                   </span>|<span class="string"> 60                 </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_username                              </span>|<span class="string"> monitor            </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_wait_timeout                          </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_writer_is_also_reader                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-multiplexing                                  </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-ping_interval_server_msec                     </span>|<span class="string"> 120000             </span>|</span><br><span class="line">|<span class="string"> mysql-ping_timeout_server                           </span>|<span class="string"> 500                </span>|</span><br><span class="line">|<span class="string"> mysql-poll_timeout                                  </span>|<span class="string"> 2000               </span>|</span><br><span class="line">|<span class="string"> mysql-poll_timeout_on_failure                       </span>|<span class="string"> 100                </span>|</span><br><span class="line">|<span class="string"> mysql-query_cache_size_MB                           </span>|<span class="string"> 256                </span>|</span><br><span class="line">|<span class="string"> mysql-query_digests                                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-query_digests_lowercase                       </span>|<span class="string"> false              </span>|</span><br><span class="line">|<span class="string"> mysql-query_digests_max_digest_length               </span>|<span class="string"> 2048               </span>|</span><br><span class="line">|<span class="string"> mysql-query_digests_max_query_length                </span>|<span class="string"> 65000              </span>|</span><br><span class="line">|<span class="string"> mysql-query_processor_iterations                    </span>|<span class="string"> 0                  </span>|</span><br><span class="line">|<span class="string"> mysql-query_processor_regex                         </span>|<span class="string"> 1                  </span>|</span><br><span class="line">|<span class="string"> mysql-query_retries_on_failure                      </span>|<span class="string"> 1                  </span>|</span><br><span class="line">|<span class="string"> mysql-server_capabilities                           </span>|<span class="string"> 45578              </span>|</span><br><span class="line">|<span class="string"> mysql-server_version                                </span>|<span class="string"> 5.5.30             </span>|</span><br><span class="line">|<span class="string"> mysql-servers_stats                                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-session_idle_ms                               </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-session_idle_show_processlist                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-sessions_sort                                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-shun_on_failures                              </span>|<span class="string"> 5                  </span>|</span><br><span class="line">|<span class="string"> mysql-shun_recovery_time_sec                        </span>|<span class="string"> 10                 </span>|</span><br><span class="line">|<span class="string"> mysql-ssl_p2s_ca                                    </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-ssl_p2s_cert                                  </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-ssl_p2s_cipher                                </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-ssl_p2s_key                                   </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-stacksize                                     </span>|<span class="string"> 1048576            </span>|</span><br><span class="line">|<span class="string"> mysql-threads                                       </span>|<span class="string"> 4                  </span>|</span><br><span class="line">|<span class="string"> mysql-threshold_query_length                        </span>|<span class="string"> 524288             </span>|</span><br><span class="line">|<span class="string"> mysql-threshold_resultset_size                      </span>|<span class="string"> 4194304            </span>|</span><br><span class="line">|<span class="string"> mysql-wait_timeout                                  </span>|<span class="string"> 28800000           </span>|</span><br><span class="line">+-----------------------------------------------------+--------------------+</span><br><span class="line">95 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 11:16:33 &gt;</span><br></pre></td></tr></table></figure></p><h3 id="ProxySQL多层配置设计"><a href="#ProxySQL多层配置设计" class="headerlink" title="ProxySQL多层配置设计"></a>ProxySQL多层配置设计</h3><h4 id="ProxySQL设计模型介绍"><a href="#ProxySQL设计模型介绍" class="headerlink" title="ProxySQL设计模型介绍"></a>ProxySQL设计模型介绍</h4><p>ProxySQL使用多层配置系统，适合满足以下需求：  </p><ul><li>允许自动更新配置，与MySQL兼容管理界面；  </li><li>允许在线修改配置，不用重启ProxySQL；  </li><li><p>允许回滚配置；<br>多层配置系统的实现，如下图：  </p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------+</span><br><span class="line">|<span class="string">         RUNTIME         </span>|</span><br><span class="line">+-------------------------+</span><br><span class="line">       /|<span class="string">\          </span>|</span><br><span class="line">        |<span class="string">           </span>|</span><br><span class="line">    [1] |<span class="string">       [2] </span>|</span><br><span class="line">        |<span class="string">          \</span>|<span class="string">/</span></span><br><span class="line"><span class="string">+-------------------------+</span></span><br><span class="line">|<span class="string">         MEMORY          </span>|</span><br><span class="line">+-------------------------+ _</span><br><span class="line">       /|<span class="string">\          </span>|<span class="string">      </span>|<span class="string">\</span></span><br><span class="line"><span class="string">        </span>|<span class="string">           </span>|<span class="string">        \</span></span><br><span class="line"><span class="string">    [3] </span>|<span class="string">       [4] </span>|<span class="string">         \ [5]</span></span><br><span class="line"><span class="string">        </span>|<span class="string">          \</span>|<span class="string">/         \</span></span><br><span class="line"><span class="string">+-------------------------+  +-------------------------+</span></span><br><span class="line">|<span class="string">          DISK           </span>|<span class="string">  </span>|<span class="string">       CONFIG FILE       </span>|</span><br><span class="line">+-------------------------+  +-------------------------+</span><br></pre></td></tr></table></figure></li><li><p>RUNTIME代表ProxySQL当前生效的配置，包括global_variables、mysql_servers、mysql_users、mysql_query_rules。无法直接修改这里的配置，必须要从下一层load过来。  </p></li><li><p>MEMORY(main)代表平时在mysql命令行修改的main里的配置，可以认为是SQLite数据库在内存的镜像。可修改以下：    </p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mysql_server</span>        后端服务器列表</span><br><span class="line">mysql_users         连接到ProxySQL的用户列表及其凭据 </span><br><span class="line">mysql_query_rules   将流量路由到不同的后端服务器的规则列表</span><br><span class="line">global_variables    全局变量列表</span><br><span class="line">mysql_collat        MySQL排序规则列表</span><br></pre></td></tr></table></figure></li><li><p>DISK和CONFIG FILE表示磁盘上SQLite数据库，默认位置在$datadir/proxysql.db，在重新启动过程中，内存中未被保存的配置将丢失。/etc/proxysql.cnf文件只在第一次初始化的时候用到。如要修改端口，还是需要在管理命令行里修改，再save到磁盘。  </p><h5 id="ProxySQL多层配置修改示例"><a href="#ProxySQL多层配置修改示例" class="headerlink" title="ProxySQL多层配置修改示例"></a>ProxySQL多层配置修改示例</h5></li><li><p>mysql users</p><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> RUNTIME / LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> MEMORY</span><br><span class="line">SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> MEMORY / SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> RUNTIME</span><br><span class="line">LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> MEMORY / LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> DISK</span><br><span class="line">SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> DISK /  SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> MEMORY</span><br><span class="line">LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> CONFIG</span><br></pre></td></tr></table></figure></li><li><p>mysql servers </p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LOAD</span> MYSQL SERVERS <span class="keyword">TO</span> RUNTIME   让修改的配置生效</span><br><span class="line"><span class="keyword">SAVE</span> MYSQL SERVERS <span class="keyword">TO</span> <span class="keyword">MEMORY</span></span><br><span class="line"><span class="keyword">LOAD</span> MYSQL SERVERS <span class="keyword">TO</span> <span class="keyword">MEMORY</span></span><br><span class="line"><span class="keyword">SAVE</span> MYSQL SERVERS <span class="keyword">TO</span> DISK      将修改的配置持久化</span><br><span class="line"><span class="keyword">LOAD</span> MYSQL SERVERS <span class="keyword">FROM</span> CONFIG</span><br></pre></td></tr></table></figure></li><li><p>mysql query rules</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> run</span><br><span class="line"><span class="keyword">save</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> mem</span><br><span class="line"><span class="keyword">load</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> mem</span><br><span class="line"><span class="keyword">save</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> disk</span><br><span class="line"><span class="keyword">load</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">from</span> config</span><br></pre></td></tr></table></figure></li><li><p>mysql variables</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> runtime</span><br><span class="line"><span class="keyword">save</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></span><br><span class="line"><span class="keyword">load</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></span><br><span class="line"><span class="keyword">save</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> disk</span><br><span class="line"><span class="keyword">load</span> mysql <span class="keyword">variables</span> <span class="keyword">from</span> config</span><br></pre></td></tr></table></figure></li><li><p>admin variables</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> runtime</span><br><span class="line"><span class="keyword">save</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></span><br><span class="line"><span class="keyword">load</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></span><br><span class="line"><span class="keyword">save</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> disk</span><br><span class="line"><span class="keyword">load</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">from</span> config</span><br></pre></td></tr></table></figure></li><li><p>参考</p></li><li><a href="https://github.com/sysown/proxysql/wiki/Multi-layer-configuration-system" target="_blank" rel="noopener">https://github.com/sysown/proxysql/wiki/Multi-layer-configuration-system</a></li><li><a href="https://severalnines.com/blog/mysql-load-balancing-proxysql-overview" target="_blank" rel="noopener">https://severalnines.com/blog/mysql-load-balancing-proxysql-overview</a></li><li><a href="http://seanlook.com/2017/04/10/mysql-proxysql-install-config/" target="_blank" rel="noopener">http://seanlook.com/2017/04/10/mysql-proxysql-install-config/</a></li></ul><h2 id="ProxySQL读写分离示例"><a href="#ProxySQL读写分离示例" class="headerlink" title="ProxySQL读写分离示例"></a>ProxySQL读写分离示例</h2><h3 id="准备-1"><a href="#准备-1" class="headerlink" title="准备"></a>准备</h3><p>Master:118.190.67.67:3306<br>Slave :139.196.95.103:3306(192.168.7.50)<br>ProxySQL：139.196.95.103:3306(192.168.7.50)<br>版本：percona-server 5.7.18  </p><h3 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h3><p>主从安装配置省略。  </p><h3 id="示例目标"><a href="#示例目标" class="headerlink" title="示例目标"></a>示例目标</h3><p>客户端通过访问ProxySQL的ip，实际访问Master和Slave的效果。  </p><h3 id="添加后端DB服务"><a href="#添加后端DB服务" class="headerlink" title="添加后端DB服务"></a>添加后端DB服务</h3><p>100是主库，101是从库，同时主库也处理1/10的读请求，登录ProxySQL管理端设置：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[(none)]</span> <span class="selector-tag">14</span><span class="selector-pseudo">:22</span><span class="selector-pseudo">:06</span> &gt; <span class="selector-tag">insert</span> <span class="selector-tag">into</span> <span class="selector-tag">mysql_servers</span>(hostgroup_id,hostname,port,weight,comment) <span class="selector-tag">values</span>(<span class="number">100</span>, <span class="string">'118.190.67.67'</span>, <span class="number">3306</span>, <span class="number">1</span>, <span class="string">'db0,ReadWrite'</span>),(<span class="number">101</span>, <span class="string">'192.168.7.50'</span>, <span class="number">3306</span>, <span class="number">9</span>, <span class="string">'db0,ReadOnly'</span>);</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">2</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p><h3 id="添加访问用户"><a href="#添加访问用户" class="headerlink" title="添加访问用户"></a>添加访问用户</h3><p>登录Master主库设置监控用户和程序用户(由于是测试使用，权限较大，主机允许所有)：<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 15:51:32 &gt; <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">'monitor'</span>@<span class="string">'%'</span> identified <span class="keyword">by</span> <span class="string">'monitor'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:51:37 &gt; grant <span class="keyword">select</span>,super,process,<span class="keyword">show</span> databases,replication client,replication slave <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'monitor'</span>@<span class="string">'%'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:45:23 &gt; <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">'user0'</span>@<span class="string">'%'</span> identified <span class="keyword">by</span> <span class="string">'password0'</span>;                   </span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:49:42 &gt; GRANT <span class="keyword">SELECT</span>, RELOAD, PROCESS, <span class="keyword">SHOW</span> DATABASES, SUPER, LOCK TABLES, <span class="keyword">EXECUTE</span>, <span class="keyword">SHOW</span> <span class="keyword">VIEW</span>, <span class="keyword">TRIGGER</span>, EVENT <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'read0'</span>@<span class="string">'%'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>登录ProxySQL管理端设置：<br>这里default_hostgroup指定了hostgroup为100的主库，下文会设置SELECT …FOR UPDATE规则到100，SELECT到101，其他所有的SQL到default_hostgroup，也就是主库。<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[(none)]</span> <span class="selector-tag">14</span><span class="selector-pseudo">:22</span><span class="selector-pseudo">:15</span> &gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">mysql_users</span> (username, password, active, default_hostgroup, max_connections) <span class="selector-tag">VALUES</span> (<span class="string">'user0'</span>, <span class="string">'password0'</span>, <span class="number">1</span>, <span class="number">100</span>, <span class="number">1000</span>); </span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">2</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p><h3 id="添加复制关系"><a href="#添加复制关系" class="headerlink" title="添加复制关系"></a>添加复制关系</h3><p>登录ProxySQL管理端设置：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 17:32:46 &gt; INSERT INTO mysql_replication_hostgroups VALUES(100,101,'db0');</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 17:33:30 &gt; load mysql variables to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 17:33:54 &gt; save mysql variables to disk;</span><br><span class="line">Query OK, 83 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 17:35:53 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_read_only_log ORDER BY time_start_us DESC LIMIT 10;</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> success_time_us </span>|<span class="string"> read_only </span>|<span class="string"> error </span>|</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085770195146 </span>|<span class="string"> 630             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085770194710 </span>|<span class="string"> 23722           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085768695087 </span>|<span class="string"> 650             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085768694620 </span>|<span class="string"> 23706           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085767194957 </span>|<span class="string"> 628             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085767194507 </span>|<span class="string"> 23686           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085765694834 </span>|<span class="string"> 634             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085765694387 </span>|<span class="string"> 23669           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085764194744 </span>|<span class="string"> 641             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085764194301 </span>|<span class="string"> 23729           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p><h3 id="修改全局变量"><a href="#修改全局变量" class="headerlink" title="修改全局变量"></a>修改全局变量</h3><p>登录ProxySQL管理端设置：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-query_retries_on_failure</span>=0;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-max_stmts_per_connection</span>=1000;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-eventslog_filename</span>=<span class="string">'queries.log'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_slave_lag_when_null</span>=7200;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-ping_timeout_server</span>=1500;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_connect_timeout</span>=1000;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-default_max_latency_ms</span>=2000;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_username</span>=<span class="string">'monitor'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_password</span>=<span class="string">'monitor'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-server_version</span>=<span class="string">'5.7.18'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>全局变量生效并保存到磁盘：<br>登录ProxySQL管理端设置：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 14:25:07 &gt; load mysql<span class="built_in"> users </span><span class="keyword">to</span> runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:27 &gt; load mysql servers <span class="keyword">to</span> runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:27 &gt; load mysql variables <span class="keyword">to</span> runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:28 &gt; save mysql<span class="built_in"> users </span><span class="keyword">to</span> disk;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:36 &gt; save mysql servers <span class="keyword">to</span> disk;</span><br><span class="line">save mysql variables <span class="keyword">to</span> disk;Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:37 &gt; save mysql variables <span class="keyword">to</span> disk;</span><br><span class="line">Query OK, 83 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:37 &gt; save mysql<span class="built_in"> users </span><span class="keyword">to</span> mem;  -- 可以屏蔽看到的明文密码</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p><h3 id="路由规则"><a href="#路由规则" class="headerlink" title="路由规则"></a>路由规则</h3><ul><li>ProxySQL使用查询规则来确定路由，如果没有规则用于查询，默认会访问hostgroup 0主机组，会报以下错误：<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie ~]# mysql -uuser0 -ppassword0 -h 127.0.0.1 -P6033 -e <span class="string">"SELECT 1"</span></span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line"><span class="builtin-name">ERROR</span> 9001 (HY000) at line 1: Max connect timeout reached <span class="keyword">while</span> reaching hostgroup 1 after 2000ms</span><br></pre></td></tr></table></figure></li></ul><p>设置路由规则：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[(none)]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:14</span> &gt; <span class="selector-tag">use</span> <span class="selector-tag">main</span>;</span><br><span class="line"><span class="selector-tag">Database</span> <span class="selector-tag">changed</span></span><br><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:15</span> &gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">mysql_query_rules</span> (active, match_pattern, destination_hostgroup, cache_ttl) <span class="selector-tag">VALUES</span> (<span class="number">1</span>, <span class="string">'^SELECT .* FOR UPDATE'</span>, <span class="number">100</span>, NULL);</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">1</span> <span class="selector-tag">row</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:17</span> &gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">mysql_query_rules</span> (active, match_pattern, destination_hostgroup, cache_ttl) <span class="selector-tag">VALUES</span> (<span class="number">1</span>, <span class="string">'^SELECT .*'</span>, <span class="number">101</span>, NULL);</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">1</span> <span class="selector-tag">row</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:18</span> &gt; <span class="selector-tag">load</span> <span class="selector-tag">mysql</span> <span class="selector-tag">query</span> <span class="selector-tag">rules</span> <span class="selector-tag">to</span> <span class="selector-tag">run</span>;</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">0</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:56</span> &gt; <span class="selector-tag">save</span> <span class="selector-tag">mysql</span> <span class="selector-tag">query</span> <span class="selector-tag">rules</span> <span class="selector-tag">to</span> <span class="selector-tag">disk</span>;</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">0</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.03</span> sec)</span><br></pre></td></tr></table></figure></p><h3 id="常用查询"><a href="#常用查询" class="headerlink" title="常用查询"></a>常用查询</h3><ul><li><p>查询连接日志：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:45:08 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_connect_log ORDER BY time_start_us DESC LIMIT 10;</span><br><span class="line">+---------------+------+------------------+-------------------------+---------------+</span><br><span class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> connect_success_time_us </span>|<span class="string"> connect_error </span>|</span><br><span class="line">+---------------+------+------------------+-------------------------+---------------+</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590343795072 </span>|<span class="string"> 410                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590343780010 </span>|<span class="string"> 69662                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590283795083 </span>|<span class="string"> 521                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590283779977 </span>|<span class="string"> 68310                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590223794987 </span>|<span class="string"> 533                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590223779913 </span>|<span class="string"> 53220                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590163794887 </span>|<span class="string"> 497                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590163779772 </span>|<span class="string"> 71389                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590103794788 </span>|<span class="string"> 487                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590103779728 </span>|<span class="string"> 68372                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">+---------------+------+------------------+-------------------------+---------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>查询ping日志：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:46:22 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_ping_log ORDER BY time_start_us DESC LIMIT 10;</span><br><span class="line">+---------------+------+------------------+----------------------+------------+</span><br><span class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> ping_success_time_us </span>|<span class="string"> ping_error </span>|</span><br><span class="line">+---------------+------+------------------+----------------------+------------+</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590413773092 </span>|<span class="string"> 100                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590413770521 </span>|<span class="string"> 23105                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590403773088 </span>|<span class="string"> 168                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590403770479 </span>|<span class="string"> 23080                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590393772977 </span>|<span class="string"> 135                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590393770364 </span>|<span class="string"> 23078                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590383772899 </span>|<span class="string"> 138                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590383770309 </span>|<span class="string"> 23205                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590373772885 </span>|<span class="string"> 102                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590373770291 </span>|<span class="string"> 23099                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">+---------------+------+------------------+----------------------+------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>查询后端DB状态</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] <span class="number">13</span>:<span class="number">46</span>:<span class="number">55</span> &gt; SELECT * FROM mysql_servers;</span><br><span class="line">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+</span><br><span class="line">| <span class="type">hostgroup_id</span> | <span class="type">hostname</span>      | <span class="type">port</span> | <span class="type">status</span> | <span class="type">weight</span> | <span class="type">compression</span> | <span class="type">max_connections</span> | <span class="type">max_replication_lag</span> | <span class="type">use_ssl</span> | <span class="type">max_latency_ms</span> | <span class="type">comment</span>       |<span class="type"></span></span><br><span class="line"><span class="type">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+</span></span><br><span class="line"><span class="type">| 100</span>          | <span class="type">118</span><span class="number">.190</span><span class="number">.67</span><span class="number">.67</span> | <span class="type">3306</span> | <span class="type">ONLINE</span> | <span class="type">1</span>      | <span class="type">0</span>           | <span class="type">1000</span>            | <span class="type">0</span>                   | <span class="type">0</span>       | <span class="type">0</span>              | <span class="type">db0</span>,ReadWrite |<span class="type"></span></span><br><span class="line"><span class="type">| 101</span>          | <span class="type">192</span><span class="number">.168</span><span class="number">.7</span><span class="number">.50</span>  | <span class="type">3306</span> | <span class="type">ONLINE</span> | <span class="type">9</span>      | <span class="type">0</span>           | <span class="type">1000</span>            | <span class="type">0</span>                   | <span class="type">0</span>       | <span class="type">0</span>              | <span class="type">db0</span>,ReadOnly  |<span class="type"></span></span><br><span class="line"><span class="type">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+</span></span><br><span class="line"><span class="type">2</span> rows <span class="built_in">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li><li><p>查询监控状态：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:47:56 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_read_only_log ORDER BY time_start_us DESC LIMIT 10;   </span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> success_time_us </span>|<span class="string"> read_only </span>|<span class="string"> error </span>|</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590524103828 </span>|<span class="string"> 577             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590524103406 </span>|<span class="string"> 23499           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590522603717 </span>|<span class="string"> 646             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590522603268 </span>|<span class="string"> 23487           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590521103641 </span>|<span class="string"> 629             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590521103182 </span>|<span class="string"> 23497           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590519603662 </span>|<span class="string"> 639             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590519603201 </span>|<span class="string"> 23525           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590518103492 </span>|<span class="string"> 618             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590518103062 </span>|<span class="string"> 23508           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>查询用户信息：</p><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MySQL [<span class="params">(none)</span>] 13<span class="function">:49</span><span class="function">:28</span> &gt;  SELECT * FROM mysql_users;   </span><br><span class="line">+<span class="params">----------</span>+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">-------------------</span>+<span class="params">----------------</span>+<span class="params">---------------</span>+<span class="params">------------------------</span>+<span class="params">--------------</span>+<span class="params">---------</span>+<span class="params">----------</span>+<span class="params">-----------------</span>+</span><br><span class="line">| username | password  | active | use_ssl | default_hostgroup | default_schema | schema_locked | transaction_persistent | fast_forward | backend | frontend | max_connections |</span><br><span class="line">+<span class="params">----------</span>+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">-------------------</span>+<span class="params">----------------</span>+<span class="params">---------------</span>+<span class="params">------------------------</span>+<span class="params">--------------</span>+<span class="params">---------</span>+<span class="params">----------</span>+<span class="params">-----------------</span>+</span><br><span class="line">| user0    | password0 | 1      | 0       | 100               | NULL           | 0             | 1                      | 0            | 1       | 1        | 1000            |</span><br><span class="line">+<span class="params">----------</span>+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">-------------------</span>+<span class="params">----------------</span>+<span class="params">---------------</span>+<span class="params">------------------------</span>+<span class="params">--------------</span>+<span class="params">---------</span>+<span class="params">----------</span>+<span class="params">-----------------</span>+</span><br><span class="line">1 row in <span class="keyword">set</span> <span class="params">(0.00 sec)</span></span><br></pre></td></tr></table></figure></li><li><p>查询连接池：</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] <span class="number">13</span>:<span class="number">51</span>:<span class="number">19</span> &gt; SELECT * FROM stats.stats_mysql_connection_pool;</span><br><span class="line">+-----------+---------------+----------+--------+----------+----------+--------+---------+---------+-----------------+-----------------+------------+</span><br><span class="line">| <span class="type">hostgroup</span> | <span class="type">srv_host</span>      | <span class="type">srv_port</span> | <span class="type">status</span> | <span class="type">ConnUsed</span> | <span class="type">ConnFree</span> | <span class="type">ConnOK</span> | <span class="type">ConnERR</span> | <span class="type">Queries</span> | <span class="type">Bytes_data_sent</span> | <span class="type">Bytes_data_recv</span> | <span class="type">Latency_us</span> |<span class="type"></span></span><br><span class="line"><span class="type">+-----------+---------------+----------+--------+----------+----------+--------+---------+---------+-----------------+-----------------+------------+</span></span><br><span class="line"><span class="type">| 100</span>       | <span class="type">118</span><span class="number">.190</span><span class="number">.67</span><span class="number">.67</span> | <span class="type">3306</span>     | <span class="type">ONLINE</span> | <span class="type">0</span>        | <span class="type">1</span>        | <span class="type">1</span>      | <span class="type">0</span>       | <span class="type">3</span>       | <span class="type">58</span>              | <span class="type">233</span>             | <span class="type">23059</span>      |<span class="type"></span></span><br><span class="line"><span class="type">| 101</span>       | <span class="type">192</span><span class="number">.168</span><span class="number">.7</span><span class="number">.50</span>  | <span class="type">3306</span>     | <span class="type">ONLINE</span> | <span class="type">0</span>        | <span class="type">1</span>        | <span class="type">3</span>      | <span class="type">88</span>      | <span class="type">5</span>       | <span class="type">106</span>             | <span class="type">360</span>             | <span class="type">102</span>        |<span class="type"></span></span><br><span class="line"><span class="type">+-----------+---------------+----------+--------+----------+----------+--------+---------+---------+-----------------+-----------------+------------+</span></span><br><span class="line"><span class="type">2</span> rows <span class="built_in">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li><li><p>查询执行命令统计信息：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:51:47 &gt; SELECT <span class="symbol">*</span> FROM stats_mysql_commands_counters WHERE Total_cnt;</span><br><span class="line">+---------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</span><br><span class="line">|<span class="string"> Command </span>|<span class="string"> Total_Time_us </span>|<span class="string"> Total_cnt </span>|<span class="string"> cnt_100us </span>|<span class="string"> cnt_500us </span>|<span class="string"> cnt_1ms </span>|<span class="string"> cnt_5ms </span>|<span class="string"> cnt_10ms </span>|<span class="string"> cnt_50ms </span>|<span class="string"> cnt_100ms </span>|<span class="string"> cnt_500ms </span>|<span class="string"> cnt_1s </span>|<span class="string"> cnt_5s </span>|<span class="string"> cnt_10s </span>|<span class="string"> cnt_INFs </span>|</span><br><span class="line">+---------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</span><br><span class="line">|<span class="string"> SELECT  </span>|<span class="string"> 167664        </span>|<span class="string"> 27        </span>|<span class="string"> 15        </span>|<span class="string"> 4         </span>|<span class="string"> 0       </span>|<span class="string"> 6       </span>|<span class="string"> 0        </span>|<span class="string"> 1        </span>|<span class="string"> 0         </span>|<span class="string"> 1         </span>|<span class="string"> 0      </span>|<span class="string"> 0      </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> SET     </span>|<span class="string"> 0             </span>|<span class="string"> 2         </span>|<span class="string"> 2         </span>|<span class="string"> 0         </span>|<span class="string"> 0       </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0         </span>|<span class="string"> 0         </span>|<span class="string"> 0      </span>|<span class="string"> 0      </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> SHOW    </span>|<span class="string"> 13818         </span>|<span class="string"> 1         </span>|<span class="string"> 0         </span>|<span class="string"> 0         </span>|<span class="string"> 0       </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|<span class="string"> 1        </span>|<span class="string"> 0         </span>|<span class="string"> 0         </span>|<span class="string"> 0      </span>|<span class="string"> 0      </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|</span><br><span class="line">+---------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>查询路由规则的详情：</p><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:53:05 &gt; SELECT <span class="symbol">*</span> FROM stats_mysql_query_digest ORDER BY sum_time DESC;</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">|<span class="string"> hostgroup </span>|<span class="string"> schemaname         </span>|<span class="string"> username </span>|<span class="string"> digest             </span>|<span class="string"> digest_text                      </span>|<span class="string"> count_star </span>|<span class="string"> first_seen </span>|<span class="string"> last_seen  </span>|<span class="string"> sum_time </span>|<span class="string"> min_time </span>|<span class="string"> max_time </span>|</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0xA322907BCBC120DD </span>|<span class="string"> select * from tables limit ?     </span>|<span class="string"> 1          </span>|<span class="string"> 1504589288 </span>|<span class="string"> 1504589288 </span>|<span class="string"> 133826   </span>|<span class="string"> 133826   </span>|<span class="string"> 133826   </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x02033E45904D3DF0 </span>|<span class="string"> show databases                   </span>|<span class="string"> 1          </span>|<span class="string"> 1504589886 </span>|<span class="string"> 1504589886 </span>|<span class="string"> 13818    </span>|<span class="string"> 13818    </span>|<span class="string"> 13818    </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x3765930C7143F468 </span>|<span class="string"> select * from t1                 </span>|<span class="string"> 1          </span>|<span class="string"> 1504589311 </span>|<span class="string"> 1504589311 </span>|<span class="string"> 13466    </span>|<span class="string"> 13466    </span>|<span class="string"> 13466    </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0xA322907BCBC120DD </span>|<span class="string"> select * from tables limit ?     </span>|<span class="string"> 2          </span>|<span class="string"> 1504582304 </span>|<span class="string"> 1504583327 </span>|<span class="string"> 7325     </span>|<span class="string"> 3564     </span>|<span class="string"> 3761     </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x814EDBB68FBACD5D </span>|<span class="string"> select * from neworders limit ?  </span>|<span class="string"> 2          </span>|<span class="string"> 1504583184 </span>|<span class="string"> 1504583242 </span>|<span class="string"> 5959     </span>|<span class="string"> 2964     </span>|<span class="string"> 2995     </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x3765930C7143F468 </span>|<span class="string"> select * from t1                 </span>|<span class="string"> 3          </span>|<span class="string"> 1504583288 </span>|<span class="string"> 1504589859 </span>|<span class="string"> 3386     </span>|<span class="string"> 64       </span>|<span class="string"> 3056     </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0xA322907BCBC120DD </span>|<span class="string"> select * from tables limit ?     </span>|<span class="string"> 2          </span>|<span class="string"> 1504583168 </span>|<span class="string"> 1504583299 </span>|<span class="string"> 3095     </span>|<span class="string"> 117      </span>|<span class="string"> 2978     </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x620B328FE9D6D71A </span>|<span class="string"> SELECT DATABASE()                </span>|<span class="string"> 2          </span>|<span class="string"> 1504589729 </span>|<span class="string"> 1504589859 </span>|<span class="string"> 607      </span>|<span class="string"> 193      </span>|<span class="string"> 414      </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x226CD90D52A2BA0B </span>|<span class="string"> select @@version_comment limit ? </span>|<span class="string"> 8          </span>|<span class="string"> 1504582304 </span>|<span class="string"> 1504589886 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x52B8B04283B3A18D </span>|<span class="string"> set names utf8                   </span>|<span class="string"> 1          </span>|<span class="string"> 1504583162 </span>|<span class="string"> 1504583162 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x52B8B04283B3A18D </span>|<span class="string"> set names utf8                   </span>|<span class="string"> 1          </span>|<span class="string"> 1504582582 </span>|<span class="string"> 1504582582 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x226CD90D52A2BA0B </span>|<span class="string"> select @@version_comment limit ? </span>|<span class="string"> 6          </span>|<span class="string"> 1504583162 </span>|<span class="string"> 1504583299 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 13:55:46 &gt; SELECT hostgroup hg, sum_time, count_star, digest_text FROM stats_mysql_query_digest ORDER BY sum_time DESC;</span><br><span class="line">+-----+----------+------------+----------------------------------+</span><br><span class="line">|<span class="string"> hg  </span>|<span class="string"> sum_time </span>|<span class="string"> count_star </span>|<span class="string"> digest_text                      </span>|</span><br><span class="line">+-----+----------+------------+----------------------------------+</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 133826   </span>|<span class="string"> 1          </span>|<span class="string"> select * from tables limit ?     </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 13818    </span>|<span class="string"> 1          </span>|<span class="string"> show databases                   </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 13466    </span>|<span class="string"> 1          </span>|<span class="string"> select * from t1                 </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 7325     </span>|<span class="string"> 2          </span>|<span class="string"> select * from tables limit ?     </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 5959     </span>|<span class="string"> 2          </span>|<span class="string"> select * from neworders limit ?  </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 3386     </span>|<span class="string"> 3          </span>|<span class="string"> select * from t1                 </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 3095     </span>|<span class="string"> 2          </span>|<span class="string"> select * from tables limit ?     </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 607      </span>|<span class="string"> 2          </span>|<span class="string"> SELECT DATABASE()                </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 8          </span>|<span class="string"> select @@version_comment limit ? </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 1          </span>|<span class="string"> set names utf8                   </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 1          </span>|<span class="string"> set names utf8                   </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 6          </span>|<span class="string"> select @@version_comment limit ? </span>|</span><br><span class="line">+-----+----------+------------+----------------------------------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></li><li><p>查询路由规则：</p><figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] <span class="number">13</span>:<span class="number">57</span>:<span class="number">12</span> &gt; SELECT rule_id, match_digest, match_pattern, replace_pattern, cache_ttl, <span class="built_in">apply</span> FROM mysql_query_rules ORDER BY rule_id;</span><br><span class="line">+---------+--------------+-----------------------+-----------------+-----------+-------+</span><br><span class="line">| <span class="type">rule_id</span> | <span class="type">match_digest</span> | <span class="type">match_pattern</span>         | <span class="type">replace_pattern</span> | <span class="type">cache_ttl</span> | <span class="type">apply</span> |<span class="type"></span></span><br><span class="line"><span class="type">+---------+--------------+-----------------------+-----------------+-----------+-------+</span></span><br><span class="line"><span class="type">| 10</span>      | <span class="type">NULL</span>         | <span class="type">^SELECT</span> .* FOR UPDATE | <span class="type">NULL</span>            | <span class="type">NULL</span>      | <span class="type">0</span>     |<span class="type"></span></span><br><span class="line"><span class="type">| 11</span>      | <span class="type">NULL</span>         | <span class="type">^SELECT</span> .*            | <span class="type">NULL</span>            | <span class="type">NULL</span>      | <span class="type">0</span>     |<span class="type"></span></span><br><span class="line"><span class="type">+---------+--------------+-----------------------+-----------------+-----------+-------+</span></span><br><span class="line"><span class="type">2</span> rows <span class="built_in">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></li><li><p>参考：</p></li><li><a href="https://github.com/sysown/proxysql/wiki/ProxySQL-Configuration#p6033" target="_blank" rel="noopener">https://github.com/sysown/proxysql/wiki/ProxySQL-Configuration#p6033</a></li><li><a href="http://seanlook.com/2017/04/17/mysql-proxysql-route-rw_split/" target="_blank" rel="noopener">http://seanlook.com/2017/04/17/mysql-proxysql-route-rw_split/</a></li><li><a href="http://severalnines.com/blog/how-proxysql-adds-failover-and-query-control-your-mysql-replication-setup" target="_blank" rel="noopener">http://severalnines.com/blog/how-proxysql-adds-failover-and-query-control-your-mysql-replication-setup</a></li></ul><h2 id="ProxySQL监控"><a href="#ProxySQL监控" class="headerlink" title="ProxySQL监控"></a>ProxySQL监控</h2><p>PMM是Percona推出的一款很好的监控MySQL和MongoDB的开源工具，安装方便，功能丰富，图表美观，同时也支持ProxySQL的监控，故选择PMM作为ProxySQL的监控软件。<br>这里以ProxySQL服务端(192.168.7.50)为例，作为PMM的客户端，PMM服务器为139.196.99.230,仅演示ProxySQL安装PMM客户端，服务器安装配置省略。  </p><h3 id="PMM-Client安装"><a href="#PMM-Client安装" class="headerlink" title="PMM Client安装"></a>PMM Client安装</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie ~]# yum localinstall -y /hwdata/duanwenjie/test/proxysql-1.4.1-1-centos67.x86<span class="emphasis">_64.rpm </span></span><br><span class="line"><span class="emphasis">Loaded plugins: security</span></span><br><span class="line"><span class="emphasis">Setting up Local Package Process</span></span><br><span class="line"><span class="emphasis">Examining /hwdata/duanwenjie/test/proxysql-1.4.1-1-centos67.x86_</span>64.rpm: proxysql-1.4.1-1.x86<span class="emphasis">_64</span></span><br><span class="line"><span class="emphasis">Marking /hwdata/duanwenjie/test/proxysql-1.4.1-1-centos67.x86_</span>64.rpm to be installed</span><br><span class="line">Resolving Dependencies</span><br><span class="line">There are unfinished transactions remaining. You might consider running yum-complete-transaction first to finish them.</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package proxysql.x86<span class="emphasis">_64 0:1.4.1-1 will be installed</span></span><br><span class="line"><span class="emphasis">--&gt; Finished Dependency Resolution</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">Dependencies Resolved</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">========================================================================================================================================================================</span></span><br><span class="line"><span class="emphasis"> Package                           Arch                            Version                             Repository                                                  Size</span></span><br><span class="line"><span class="emphasis">========================================================================================================================================================================</span></span><br><span class="line"><span class="emphasis">Installing:</span></span><br><span class="line"><span class="emphasis"> proxysql                          x86_</span>64                          1.4.1-1                             /proxysql-1.4.1-1-centos67.x86<span class="emphasis">_64                           19 M</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">Transaction Summary</span></span><br><span class="line"><span class="emphasis">========================================================================================================================================================================</span></span><br><span class="line"><span class="emphasis">Install       1 Package(s)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">Total size: 19 M</span></span><br><span class="line"><span class="emphasis">Installed size: 19 M</span></span><br><span class="line"><span class="emphasis">Downloading Packages:</span></span><br><span class="line"><span class="emphasis">Running rpm_</span>check<span class="emphasis">_debug</span></span><br><span class="line"><span class="emphasis">Running Transaction Test</span></span><br><span class="line"><span class="emphasis">Transaction Test Succeeded</span></span><br><span class="line"><span class="emphasis">Running Transaction</span></span><br><span class="line"><span class="emphasis">Warning: RPMDB altered outside of yum.</span></span><br><span class="line"><span class="emphasis">** Found 1 pre-existing rpmdb problem(s), 'yum check' output follows:</span></span><br><span class="line"><span class="emphasis">mysql-community-libs-5.7.16-1.el6.x86_</span>64 has missing requires of mysql-community-common(x86-64) &gt;= (<span class="emphasis">'0'</span>, <span class="emphasis">'5.7.9'</span>, None)</span><br><span class="line"><span class="code">  Installing : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></span><br><span class="line"><span class="code">  Verifying  : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line"><span class="code">  proxysql.x86_64 0:1.4.1-1                                                                                                                                             </span></span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">[root@jiessie ~]#</span><br></pre></td></tr></table></figure><h3 id="PMM-Client配置"><a href="#PMM-Client配置" class="headerlink" title="PMM Client配置"></a>PMM Client配置</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie ~]# ifconfig  #查看IP地址</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:00:DC:49  </span><br><span class="line">          inet addr:192.168.7.50  Bcast:192.168.15.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:1017660 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:1380639 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:273791594 (261.1 MiB)  TX bytes:116287303 (110.9 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap<span class="keyword">:Local</span> Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:1297762 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:1297762 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:141606631 (135.0 MiB)  TX bytes:141606631 (135.0 MiB)</span><br><span class="line"></span><br><span class="line">[root@jiessie ~]# pmm-admin<span class="built_in"> config </span>--bind-address 192.168.7.50 --client-address 139.196.95.103 --server 139.196.99.230:8080 --client-name ProxySQL_Test   #添加config</span><br><span class="line">OK, PMM<span class="built_in"> server </span>is alive.</span><br><span class="line"></span><br><span class="line">PMM<span class="built_in"> Server </span>     | 139.196.99.230:8080 </span><br><span class="line">Client Name     | ProxySQL_Test</span><br><span class="line">Client<span class="built_in"> Address </span> | 139.196.95.103 (192.168.7.50)</span><br><span class="line">[root@jiessie ~]# pmm-admin <span class="builtin-name">add</span> linux:metrics --force ProxySQL_Test     #添加Linux监控</span><br><span class="line">OK, now monitoring this system.</span><br><span class="line">[root@jiessie ~]# </span><br><span class="line">[root@jiessie ~]# pmm-admin <span class="builtin-name">add</span> proxysql:metrics --dsn <span class="string">"admin:admin@tcp(127.0.0.1:6032)/"</span> proxysql6032 #添加ProxySQL监控</span><br><span class="line">OK, now monitoring ProxySQL metrics using DSN admin:***@tcp(localhost:6032)</span><br><span class="line">[root@jiessie ~]# </span><br><span class="line">[root@jiessie ~]# pmm-admin list    #查看状态</span><br><span class="line">pmm-admin 1.3.0</span><br><span class="line"></span><br><span class="line">PMM<span class="built_in"> Server </span>     | 139.196.99.230:8080 </span><br><span class="line">Client Name     | ProxySQL_Test</span><br><span class="line">Client<span class="built_in"> Address </span> | 139.196.95.103 (192.168.7.50)</span><br><span class="line">Service Manager | unix-systemv</span><br><span class="line"></span><br><span class="line">----------------- -------------- ----------- -------- ------------------------------ --------</span><br><span class="line">SERVICE<span class="built_in"> TYPE </span>     NAME           LOCAL<span class="built_in"> PORT </span> RUNNING  DATA SOURCE                    OPTIONS </span><br><span class="line">----------------- -------------- ----------- -------- ------------------------------ --------</span><br><span class="line">linux:metrics     ProxySQL_Test  42000       <span class="literal">YES</span>      -                                      </span><br><span class="line">mysql:metrics     ProxySQL_Test  42002       <span class="literal">YES</span>      root:***@tcp(127.0.0.1:3306)           </span><br><span class="line">proxysql:metrics  proxysql6032   42004       <span class="literal">YES</span>      admin:***@tcp(127.0.0.1:6032)          </span><br><span class="line"></span><br><span class="line">[root@jiessie ~]#</span><br></pre></td></tr></table></figure><h3 id="PMM-Server监控展示"><a href="#PMM-Server监控展示" class="headerlink" title="PMM Server监控展示"></a>PMM Server监控展示</h3><p>PMM Server监控项包括：</p><ul><li>客户端连接数</li><li>客户端总查询</li><li>ProxySQL连接池状态</li><li>活动连接</li><li>失败连接</li><li>客户端查询路由详情</li><li>客户端延迟状态</li><li>网络接口<br><img src="http://note.youdao.com/yws/public/resource/eda87c5cc1090ba9cc4be116906c805b/xmlnote/784F7090F01E4C62AE28CA4BB08A82F8/37001" alt="image"></li></ul><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>ProxySQL是一款很出色的MySQL中间件，在稳定性上、易用性、高性能等方面表现很不错。由于发布的时间较短，功能可能还不太完善，需要多做测试，特别是查询路由和规则方面需要详情的了解，测试。可重点关注。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;在MySQL的高可用集群环境中，中间件是不可缺少的一部分，它提供了读写分离、负载均衡等各种功能，满足集群的横向、纵向的可扩展。由于官方并没有
      
    
    </summary>
    
      <category term="中间件" scheme="https://dwj999.github.io/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
      <category term="proxysql" scheme="https://dwj999.github.io/tags/proxysql/"/>
    
  </entry>
  
  <entry>
    <title>误删除frm、ibd文件恢复案例</title>
    <link href="https://dwj999.github.io/%E8%AF%AF%E5%88%A0%E9%99%A4frm%E3%80%81ibd%E6%96%87%E4%BB%B6%E6%81%A2%E5%A4%8D%E6%A1%88%E4%BE%8B.html"/>
    <id>https://dwj999.github.io/误删除frm、ibd文件恢复案例.html</id>
    <published>2017-07-28T07:51:07.000Z</published>
    <updated>2020-05-20T03:21:47.058Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>MySQL从5.5版本开始，InnoDB存储引擎已经成为默认存储引擎。通过参数innodb_file_per_table控制设置是否开启独立表空间，当开启独立表空间时数据和索引会存在于ibd文件中,数据目录中会存在frm和ibd文件;当未开启独立表空间时，此时使用的是共享表空间，数据和索引会存储在ibdata1文件中，数据目录只会存在frm文件。如果不小心删除了数据目录下的frm或者ibd文件时，当然是开启独立表空间时，除了xtrabackup、mysqldump恢复之外，介绍一下从物理备份通过拷贝文件的方式恢复。</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>MySQL版本：percona server 5.6.36</p><h2 id="误删除ibd文件"><a href="#误删除ibd文件" class="headerlink" title="误删除ibd文件"></a>误删除ibd文件</h2><p>当识删除ibd文件时，由于frm表结构文件还存在，ibdata1元数据中的表信息也存在，可通过物理备份的ibd文件拷贝至数据目录，不需要修改tablespace ID即可完成恢复。</p><h3 id="创建测试表并插入数据"><a href="#创建测试表并插入数据" class="headerlink" title="创建测试表并插入数据"></a>创建测试表并插入数据</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># mysql -uroot -p123456 -e "create database test11"</span></span><br><span class="line">Warning: Using a password <span class="keyword">on</span> <span class="keyword">the</span> command line interface can be insecure.</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># ll test11/</span></span><br><span class="line">总用量 <span class="number">4</span></span><br><span class="line">-rw-rw<span class="comment">---- 1 mysql mysql 61 7月  28 16:12 db.opt</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># mysql -uroot -p123456 test11</span></span><br><span class="line">Warning: Using a password <span class="keyword">on</span> <span class="keyword">the</span> command line interface can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">117</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.6</span><span class="number">.36</span><span class="number">-82.0</span>-<span class="built_in">log</span> Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">16</span>:<span class="number">12</span>:<span class="number">29</span> &gt; create table t11(<span class="built_in">id</span> int unsigned <span class="keyword">not</span> null auto_increment,<span class="built_in">name</span> varchar(<span class="number">20</span>),primary key(<span class="built_in">id</span>));</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">16</span>:<span class="number">13</span>:<span class="number">26</span> &gt; insert <span class="keyword">into</span> t11 values(null,'aaa11');</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">16</span>:<span class="number">13</span>:<span class="number">45</span> &gt; insert <span class="keyword">into</span> t11 values(null,'bbb22');</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">16</span>:<span class="number">13</span>:<span class="number">53</span> &gt; insert <span class="keyword">into</span> t11 values(null,'ccc33');</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">16</span>:<span class="number">13</span>:<span class="number">59</span> &gt; insert <span class="keyword">into</span> t11 values(null,'ddd44');</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">16</span>:<span class="number">14</span>:<span class="number">04</span> &gt; insert <span class="keyword">into</span> t11 values(null,'eee55');</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">16</span>:<span class="number">14</span>:<span class="number">10</span> &gt; select * <span class="keyword">from</span> t11;</span><br><span class="line">+<span class="comment">----+-------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>  |</span><br><span class="line">+<span class="comment">----+-------+</span></span><br><span class="line">|  <span class="number">1</span> | aaa11 |</span><br><span class="line">|  <span class="number">2</span> | bbb22 |</span><br><span class="line">|  <span class="number">3</span> | ccc33 |</span><br><span class="line">|  <span class="number">4</span> | ddd44 |</span><br><span class="line">|  <span class="number">5</span> | eee55 |</span><br><span class="line">+<span class="comment">----+-------+</span></span><br><span class="line"><span class="number">5</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">16</span>:<span class="number">14</span>:<span class="number">13</span> &gt;</span><br></pre></td></tr></table></figure><h3 id="查看数据目录"><a href="#查看数据目录" class="headerlink" title="查看数据目录"></a>查看数据目录</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># ll test11/</span></span><br><span class="line">总用量 112</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql   <span class="number"> 61 </span>7月 <span class="number"> 28 </span>16:12 db.opt</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql <span class="number"> 8586 </span>7月 <span class="number"> 28 </span>16:13 t11.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 98304 </span>7月 <span class="number"> 28 </span>16:14 t11.ibd</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="保存一份数据文件"><a href="#保存一份数据文件" class="headerlink" title="保存一份数据文件"></a>保存一份数据文件</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># /etc/init.d/mysqld stop</span></span><br><span class="line">Shutting down MySQL (Percona Server)...                    [确定]</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># cp -a test11/ /usr/src/ &amp;&amp; ll /usr/src/test11</span></span><br><span class="line">总用量 112</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql   <span class="number"> 61 </span>7月 <span class="number"> 28 </span>16:12 db.opt</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql <span class="number"> 8586 </span>7月 <span class="number"> 28 </span>16:13 t11.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 98304 </span>7月 <span class="number"> 28 </span>16:14 t11.ibd</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="模拟删除ibd文件"><a href="#模拟删除ibd文件" class="headerlink" title="模拟删除ibd文件"></a>模拟删除ibd文件</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># ll test11/</span></span><br><span class="line">总用量 112</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql   <span class="number"> 61 </span>7月 <span class="number"> 28 </span>16:12 db.opt</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql <span class="number"> 8586 </span>7月 <span class="number"> 28 </span>16:13 t11.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 98304 </span>7月 <span class="number"> 28 </span>16:14 t11.ibd</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># rm -rf test11/t11.ibd </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># /etc/init.d/mysqld start</span></span><br><span class="line">Starting MySQL (Percona Server)..                          [确定]</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># mysql -uroot -p123456 test11 -e "desc t11"</span></span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">ERROR<span class="number"> 1146 </span>(42S02) at line 1: Table 'test11.t11' doesn't exist</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="通过备份恢复数据"><a href="#通过备份恢复数据" class="headerlink" title="通过备份恢复数据"></a>通过备份恢复数据</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# cp /usr/src/test11/t11.ibd test11/</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# chown -R mysql:mysql test11/</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# /etc/init.d/mysqld restart</span><br><span class="line">Shutting down MySQL (Percona Server)..                     [确定]</span><br><span class="line">Starting MySQL (Percona Server)..                          [确定]</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# mysql -uroot -p123456 test11 -e "select * from t11"</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line"><span class="code">+----+</span>-------+</span><br><span class="line">| id | name  |</span><br><span class="line"><span class="code">+----+</span>-------+</span><br><span class="line">|  1 | aaa11 |</span><br><span class="line">|  2 | bbb22 |</span><br><span class="line">|  3 | ccc33 |</span><br><span class="line">|  4 | ddd44 |</span><br><span class="line"><span class="code">+----+</span>-------+</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]#</span><br></pre></td></tr></table></figure><h2 id="误删除frm文件"><a href="#误删除frm文件" class="headerlink" title="误删除frm文件"></a>误删除frm文件</h2><h2 id="误执行drop操作"><a href="#误执行drop操作" class="headerlink" title="误执行drop操作"></a>误执行drop操作</h2><p>参考 ：<br><a href="http://dbaplus.cn/news-11-1199-1.html" target="_blank" rel="noopener">http://dbaplus.cn/news-11-1199-1.html</a><br><a href="http://cenalulu.github.io/mysql/innodb-single-tablespace-recovery/" target="_blank" rel="noopener">http://cenalulu.github.io/mysql/innodb-single-tablespace-recovery/</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;MySQL从5.5版本开始，InnoDB存储引擎已经成为默认存储引擎。通过参数innodb_file_per_table控制设置是否开启独立
      
    
    </summary>
    
      <category term="备份恢复" scheme="https://dwj999.github.io/categories/%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"/>
    
    
      <category term="percona" scheme="https://dwj999.github.io/tags/percona/"/>
    
      <category term="mysql" scheme="https://dwj999.github.io/tags/mysql/"/>
    
      <category term="innodb" scheme="https://dwj999.github.io/tags/innodb/"/>
    
      <category term="frm" scheme="https://dwj999.github.io/tags/frm/"/>
    
      <category term="ibd" scheme="https://dwj999.github.io/tags/ibd/"/>
    
  </entry>
  
  <entry>
    <title>AWS EC2搭建MHA+VIP+MySQL5.7</title>
    <link href="https://dwj999.github.io/AWS-EC2%E6%90%AD%E5%BB%BAMHA-VIP-MySQL5-7.html"/>
    <id>https://dwj999.github.io/AWS-EC2搭建MHA-VIP-MySQL5-7.html</id>
    <published>2017-07-24T08:51:22.000Z</published>
    <updated>2020-05-20T03:46:16.745Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在AWS EC2结合MHA做MySQL的高可用，EC2不支持VIP，可通过绑定私有IP的方式来实现。</p><h2 id="MHA简介"><a href="#MHA简介" class="headerlink" title="MHA简介"></a>MHA简介</h2><p>MHA是由日本MySQL专家youshimaton(现就职于Facebook公司)用Perl写的一套MySQL故障切换方案，以保障数据库的高可用性。在MySQL故障切换过程中，MHA能做到在0~30s之内实现主MySQL故障转移。<br>该软件由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）。MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：Amazon Linux<br>master:172.31.13.126<br>slave:172.31.9.182<br>vip:172.31.0.200<br>其中，使用两台机器，分别部署主库和从库，MHA默认部署在从库上，下方中的VIP通指私有IP。  </p><h2 id="系统初始化修改"><a href="#系统初始化修改" class="headerlink" title="系统初始化修改"></a>系统初始化修改</h2><h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><h4 id="主库修改主机名"><a href="#主库修改主机名" class="headerlink" title="主库修改主机名"></a>主库修改主机名</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/sysconfig/network</span><br><span class="line"><span class="attribute">NETWORKING</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">HOSTNAME</span>=master</span><br></pre></td></tr></table></figure><h4 id="从库修改主机名"><a href="#从库修改主机名" class="headerlink" title="从库修改主机名"></a>从库修改主机名</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/sysconfig/network</span><br><span class="line"><span class="attribute">NETWORKING</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">HOSTNAME</span>=slave</span><br></pre></td></tr></table></figure><h3 id="修改时区"><a href="#修改时区" class="headerlink" title="修改时区"></a>修改时区</h3><p>Amazon Linux默认安装好后英国时间，需要在主库和从库修改时区<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# ln</span> -sf /usr/share/zone<span class="literal">inf</span>o/Asia/Shanghai /etc/localtime</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# /usr</span>/sbin/ntpdate <span class="number">0</span>.centos.pool.ntp.org &amp;&amp; /sbin/hwclock -w &amp;&gt;/dev/null</span><br></pre></td></tr></table></figure></p><h3 id="设置防火墙"><a href="#设置防火墙" class="headerlink" title="设置防火墙"></a>设置防火墙</h3><h4 id="主库设置，允许从库访问"><a href="#主库设置，允许从库访问" class="headerlink" title="主库设置，允许从库访问"></a>主库设置，允许从库访问</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/iptables status|grep <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span></span><br><span class="line"><span class="number">15</span>   ACCEPT     all  --  <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span>         <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>           </span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure><p>其中，172.31.9.182是允许从库的访问规则</p><h4 id="从库设置，允许主库访问"><a href="#从库设置，允许主库访问" class="headerlink" title="从库设置，允许主库访问"></a>从库设置，允许主库访问</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# /etc/init.d/iptables status|grep <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span> </span><br><span class="line"><span class="number">15</span>   ACCEPT     all  --  <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span>        <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>           </span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure><p>其中，172.31.13.126是允许主库的访问规则</p><h3 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h3><p>由于使用的操作系统为Amazon Linux，通过查看无selinux设置。</p><h2 id="建立SSH无密码登录"><a href="#建立SSH无密码登录" class="headerlink" title="建立SSH无密码登录"></a>建立SSH无密码登录</h2><h3 id="主库设置"><a href="#主库设置" class="headerlink" title="主库设置"></a>主库设置</h3><p>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no。<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# sed</span> '/^<span class="comment">#/d;/^$/d' /etc/ssh/ssh_config |grep GSSAPIAuthentication</span></span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# sed</span> '/^<span class="comment">#/d;/^$/d' /etc/ssh/sshd_config |grep -E 'PasswordAuthentication|PermitRootLogin'</span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PermitRootLogin forced-commands-only</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# /etc</span>/init.d/sshd restart</span><br><span class="line">停止 sshd：                                                [确定]</span><br><span class="line">正在启动 sshd：                                            [确定]</span><br></pre></td></tr></table></figure></p><p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">43:a3:80:f1:8c:d4:5e:8d:3c:99:e5:39:39:e3:89:9a root<span class="meta">@master</span></span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|<span class="string">  o. . *.        </span>|</span><br><span class="line">|<span class="string"> . *. B..o       </span>|</span><br><span class="line">|<span class="string">  o.+. .X        </span>|</span><br><span class="line">|<span class="string">    .. = *       </span>|</span><br><span class="line">|<span class="string">      o S        </span>|</span><br><span class="line">|<span class="string">     o   .       </span>|</span><br><span class="line">|<span class="string">    E            </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">+-----------------+</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.9.182</span></span><br><span class="line">The authenticity of host '172.31.9.182 (172.31.9.182)' can't be established.</span><br><span class="line">ECDSA key fingerprint is 72:71:66:dc:6c:b0:31:e7:6c:77:4c:8d:32:69:e0:88.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.9.182's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.9.182'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.13.126</span></span><br><span class="line">The authenticity of host '172.31.13.126 (172.31.13.126)' can't be established.</span><br><span class="line">ECDSA key fingerprint is b6:ef:9f:f0:5e:fd:8f:49:ef:be:79:fb:44:ea:63:08.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.13.126's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.13.126'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh 'root@172.31.9.182'</span></span><br><span class="line">Last login: Thu Jul 20 04:51:07 2017</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.9.182 closed.</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh 'root@172.31.13.126'</span></span><br><span class="line">Last login: Thu Jul 20 04:37:13 2017</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br></pre></td></tr></table></figure></p><h3 id="从库设置"><a href="#从库设置" class="headerlink" title="从库设置"></a>从库设置</h3><p>和主库的配置相同<br>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no。<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># sed <span class="string">'/^#/d;/^$/d'</span> /etc/ssh/ssh_config |grep GSSAPIAuthentication</span></span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># sed <span class="string">'/^#/d;/^$/d'</span> /etc/ssh/sshd_config |grep -E <span class="string">'PasswordAuthentication|PermitRootLogin'</span></span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PermitRootLogin forced-commands-only</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># /etc/init.d/sshd restart</span></span><br><span class="line">停止 sshd：                                                [确定]</span><br><span class="line">正在启动 sshd：                                            [确定]</span><br></pre></td></tr></table></figure></p><p>使用命令ssh-keygen生成公钥，发送到主库，同时尝试在从库无密码形式登录主库，而且也要保证本机无密码登录本机<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">7d:57:15:e0:20:6f:6f:45:00:76:c4:ba:66:32:fd:b3 root<span class="meta">@slave</span></span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|<span class="string">         . ++=ooo</span>|</span><br><span class="line">|<span class="string">          + +.. .</span>|</span><br><span class="line">|<span class="string">           o.. ..</span>|</span><br><span class="line">|<span class="string">         .... .. </span>|</span><br><span class="line">|<span class="string">        S o oo.  </span>|</span><br><span class="line">|<span class="string">         o *..   </span>|</span><br><span class="line">|<span class="string">          = .    </span>|</span><br><span class="line">|<span class="string">             o   </span>|</span><br><span class="line">|<span class="string">             Eo  </span>|</span><br><span class="line">+-----------------+</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">da:ea:e3:1c:fb:4b:f5:84:da:a3:47:ea:2c:fa:3c:a6 root<span class="meta">@slave</span></span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">           .     </span>|</span><br><span class="line">|<span class="string">        S o .    </span>|</span><br><span class="line">|<span class="string">       o +.o     </span>|</span><br><span class="line">|<span class="string">      o +oo .    </span>|</span><br><span class="line">|<span class="string">     o=*....     </span>|</span><br><span class="line">|<span class="string">    EBO**o       </span>|</span><br><span class="line">+-----------------+</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.13.126</span></span><br><span class="line">The authenticity of host '172.31.13.126 (172.31.13.126)' can't be established.</span><br><span class="line">ECDSA key fingerprint is b6:ef:9f:f0:5e:fd:8f:49:ef:be:79:fb:44:ea:63:08.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.13.126's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.13.126'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.9.182</span></span><br><span class="line">The authenticity of host '172.31.9.182 (172.31.9.182)' can't be established.</span><br><span class="line">ECDSA key fingerprint is 72:71:66:dc:6c:b0:31:e7:6c:77:4c:8d:32:69:e0:88.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.9.182's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.9.182'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh 'root@172.31.13.126'</span></span><br><span class="line">Last login: Thu Jul 20 05:36:57 2017 from 172.31.13.126</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh 'root@172.31.9.182' </span></span><br><span class="line">Last login: Thu Jul 20 05:36:46 2017 from 172.31.13.126</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.9.182 closed.</span><br></pre></td></tr></table></figure></p><h2 id="MySQL安装"><a href="#MySQL安装" class="headerlink" title="MySQL安装"></a>MySQL安装</h2><p>使用的是自己打包的RPM包，分别登录主库和从库，直接rpm -ivh percona-server-5.7.18-15.x86_64.rpm 即可，也可使用其他方式安装MySQL<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mv /home/zhouting/percona-server-5.7.18-15.x86_64.rpm  /usr/src/</span><br><span class="line">[root@master ~]# rpm -ivh /usr/src/percona-server-5.7.18-15.x86_64.rpm </span><br><span class="line">Preparing<span class="built_in">..</span>.                          ################################# [100%]</span><br><span class="line">Updating / installing<span class="built_in">..</span>.</span><br><span class="line">   1:percona-server-5.7.18-15         ################################# [100%]</span><br><span class="line"><span class="builtin-name">error</span> reading information on<span class="built_in"> service </span>/etc/rc.d/init.d/mysqld: <span class="literal">No</span> such file <span class="keyword">or</span> directory</span><br><span class="line"> ERROR! MySQL (Percona Server) PID file could <span class="keyword">not</span> be found!</span><br><span class="line">Starting MySQL (Percona Server)<span class="built_in">..</span> SUCCESS! </span><br><span class="line">mysqladmin: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">Warning: Since password will be sent <span class="keyword">to</span><span class="built_in"> server </span><span class="keyword">in</span> plain text, use ssl<span class="built_in"> connection </span><span class="keyword">to</span> ensure password safety.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br></pre></td></tr></table></figure></p><p>查看是否安装成功，分别登录主库和从库查看<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">11</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">16</span>:<span class="number">57</span>:<span class="number">43</span> &gt; select <span class="built_in">version</span>();</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| <span class="built_in">version</span>()     |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">16</span>:<span class="number">57</span>:<span class="number">47</span> &gt;</span><br></pre></td></tr></table></figure></p><h2 id="MySQL互为主备"><a href="#MySQL互为主备" class="headerlink" title="MySQL互为主备"></a>MySQL互为主备</h2><h3 id="重要参数配置"><a href="#重要参数配置" class="headerlink" title="重要参数配置"></a>重要参数配置</h3><p>主库必须包含以下参数<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># cat /etc/my.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 1</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 1</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br></pre></td></tr></table></figure></p><p>从库必须包含以下参数，注意slave需要动态设置read_only=1，<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/my.cnf </span><br><span class="line"><span class="meta">[mysqld]</span></span><br><span class="line">server-id = 2</span><br><span class="line">autocommit = 1</span><br><span class="line">auto<span class="emphasis">_increment_</span>increment = 2</span><br><span class="line">auto<span class="emphasis">_increment_</span>offset = 2</span><br><span class="line">log<span class="emphasis">_bin = mysql-bin</span></span><br><span class="line"><span class="emphasis">gtid_</span>mode = on</span><br><span class="line">enforce<span class="emphasis">_gtid_</span>consistency = 1</span><br><span class="line">log<span class="emphasis">_slave_</span>updates</span><br><span class="line">relay<span class="emphasis">_log_</span>purge=0</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e "show variables like <span class="emphasis">'read_only'</span>"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| read_</span>only     | OFF   |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e "set global read<span class="emphasis">_only=1"</span></span><br><span class="line"><span class="emphasis">Enter password: </span></span><br><span class="line"><span class="emphasis">[root@slave ~]# mysql -uroot -p -e "show variables like 'read_</span>only'"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| read_</span>only     | ON    |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p><h3 id="复制帐号建立"><a href="#复制帐号建立" class="headerlink" title="复制帐号建立"></a>复制帐号建立</h3><p>由于MySQL版本使用的是5.7，创建用户的方法以之前有些不同  </p><h4 id="主库创建"><a href="#主库创建" class="headerlink" title="主库创建"></a>主库创建</h4><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">6</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">16</span>:<span class="number">52</span> &gt; <span class="keyword">create</span> user <span class="string">'slave01'</span>@<span class="string">'172.31.9.182'</span> identified <span class="keyword">by</span> <span class="string">'slave123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">17</span>:<span class="number">21</span> &gt; grant replication slave,replication client <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'172.31.9.182'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">17</span>:<span class="number">34</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">17</span>:<span class="number">38</span> &gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure><h4 id="从库创建"><a href="#从库创建" class="headerlink" title="从库创建"></a>从库创建</h4><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">6</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">19</span>:<span class="number">24</span> &gt; <span class="keyword">create</span> user <span class="string">'slave01'</span>@<span class="string">'172.31.13.126'</span> identified <span class="keyword">by</span> <span class="string">'slave123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">19</span>:<span class="number">49</span> &gt; grant replication slave,replication client <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'172.31.13.126'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">20</span>:<span class="number">02</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">20</span>:<span class="number">05</span> &gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure><h4 id="复制帐号验证"><a href="#复制帐号验证" class="headerlink" title="复制帐号验证"></a>复制帐号验证</h4><p>主库登录从库<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -h172.31.9.182 -uslave01 -pslave123456</span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQ<span class="class">L monitor.  Commands end with ;</span><span class="built_in"> or </span>\g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC<span class="built_in"> and/or </span>its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle<span class="built_in"> and/or </span>its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation<span class="built_in"> and/or </span>its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;'<span class="built_in"> or </span>'\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:22:15 &gt; exit</span><br></pre></td></tr></table></figure></p><p>从库登录主库<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -h172.31.13.126 -uslave01 -pslave123456             </span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQ<span class="class">L monitor.  Commands end with ;</span><span class="built_in"> or </span>\g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC<span class="built_in"> and/or </span>its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle<span class="built_in"> and/or </span>its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation<span class="built_in"> and/or </span>its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;'<span class="built_in"> or </span>'\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:22:57 &gt; exit</span><br></pre></td></tr></table></figure></p><h3 id="复制关系配置"><a href="#复制关系配置" class="headerlink" title="复制关系配置"></a>复制关系配置</h3><h4 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h4><p>登录主库，设置复制关系，来源于从库的复制<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-p</span></span><br><span class="line"><span class="string">Enter</span> <span class="attr">password:</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">the</span> <span class="string">MySQL</span> <span class="string">monitor.</span>  <span class="string">Commands</span> <span class="string">end</span> <span class="string">with</span> <span class="string">;</span> <span class="string">or</span> <span class="string">\g.</span></span><br><span class="line"><span class="string">Your</span> <span class="string">MySQL</span> <span class="string">connection</span> <span class="string">id</span> <span class="string">is</span> <span class="number">17</span></span><br><span class="line"><span class="string">Server</span> <span class="attr">version:</span> <span class="number">5.7</span><span class="number">.18</span><span class="bullet">-15</span><span class="bullet">-log</span> <span class="string">PLD/Linux</span> <span class="string">Distribution</span> <span class="string">Percona</span> <span class="string">Server</span> <span class="string">RPM</span></span><br><span class="line"></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2009</span><span class="bullet">-2017</span> <span class="string">Percona</span> <span class="string">LLC</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2000</span><span class="string">,</span> <span class="number">2017</span><span class="string">,</span> <span class="string">Oracle</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates.</span> <span class="string">All</span> <span class="string">rights</span> <span class="string">reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Oracle</span> <span class="string">is</span> <span class="string">a</span> <span class="string">registered</span> <span class="string">trademark</span> <span class="string">of</span> <span class="string">Oracle</span> <span class="string">Corporation</span> <span class="string">and/or</span> <span class="string">its</span></span><br><span class="line"><span class="string">affiliates.</span> <span class="string">Other</span> <span class="string">names</span> <span class="string">may</span> <span class="string">be</span> <span class="string">trademarks</span> <span class="string">of</span> <span class="string">their</span> <span class="string">respective</span></span><br><span class="line"><span class="string">owners.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Type</span> <span class="string">'help;'</span> <span class="string">or</span> <span class="string">'\h'</span> <span class="string">for</span> <span class="string">help.</span> <span class="string">Type</span> <span class="string">'\c'</span> <span class="string">to</span> <span class="string">clear</span> <span class="string">the</span> <span class="string">current</span> <span class="string">input</span> <span class="string">statement.</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:32:19</span> <span class="string">&gt; change master to master_host='172.31.9.182',master_user='slave01',master_password='slave123456',master_auto_position=1;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected, 2 warnings (0.04 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:33:03 &gt; start slave;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:33:47 &gt; show slave status\G;</span></span><br><span class="line"><span class="string">*************************** 1. row ***************************</span></span><br><span class="line"><span class="string"></span><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">slave01</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">mysql-bin.000003</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">810</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">master-relay-bin.000002</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">1023</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">mysql-bin.000003</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">810</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">1231</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="string">a1c1d189-6b96-11e7-9825-02a13635a5ca</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">mysql.slave_master_info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">more</span> <span class="string">updates</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="attr">a1c1d189-6b96-11e7-9825-02a13635a5ca:1-3</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="number">9</span><span class="attr">a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17,</span></span><br><span class="line"><span class="attr">a1c1d189-6b96-11e7-9825-02a13635a5ca:</span><span class="number">1</span><span class="bullet">-3</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </span><br><span class="line"><span class="attr">                 Channel_Name:</span> </span><br><span class="line"><span class="attr">           Master_TLS_Version:</span> </span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ERROR:</span> </span><br><span class="line"><span class="literal">No</span> <span class="string">query</span> <span class="string">specified</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:33:54</span> <span class="string">&gt;</span></span><br></pre></td></tr></table></figure></p><h4 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h4><p>登录从库，设置复制关系，来源于主库的复制<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@slave</span> <span class="string">~]#</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-p</span></span><br><span class="line"><span class="string">Enter</span> <span class="attr">password:</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">the</span> <span class="string">MySQL</span> <span class="string">monitor.</span>  <span class="string">Commands</span> <span class="string">end</span> <span class="string">with</span> <span class="string">;</span> <span class="string">or</span> <span class="string">\g.</span></span><br><span class="line"><span class="string">Your</span> <span class="string">MySQL</span> <span class="string">connection</span> <span class="string">id</span> <span class="string">is</span> <span class="number">10</span></span><br><span class="line"><span class="string">Server</span> <span class="attr">version:</span> <span class="number">5.7</span><span class="number">.18</span><span class="bullet">-15</span><span class="bullet">-log</span> <span class="string">PLD/Linux</span> <span class="string">Distribution</span> <span class="string">Percona</span> <span class="string">Server</span> <span class="string">RPM</span></span><br><span class="line"></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2009</span><span class="bullet">-2017</span> <span class="string">Percona</span> <span class="string">LLC</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2000</span><span class="string">,</span> <span class="number">2017</span><span class="string">,</span> <span class="string">Oracle</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates.</span> <span class="string">All</span> <span class="string">rights</span> <span class="string">reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Oracle</span> <span class="string">is</span> <span class="string">a</span> <span class="string">registered</span> <span class="string">trademark</span> <span class="string">of</span> <span class="string">Oracle</span> <span class="string">Corporation</span> <span class="string">and/or</span> <span class="string">its</span></span><br><span class="line"><span class="string">affiliates.</span> <span class="string">Other</span> <span class="string">names</span> <span class="string">may</span> <span class="string">be</span> <span class="string">trademarks</span> <span class="string">of</span> <span class="string">their</span> <span class="string">respective</span></span><br><span class="line"><span class="string">owners.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Type</span> <span class="string">'help;'</span> <span class="string">or</span> <span class="string">'\h'</span> <span class="string">for</span> <span class="string">help.</span> <span class="string">Type</span> <span class="string">'\c'</span> <span class="string">to</span> <span class="string">clear</span> <span class="string">the</span> <span class="string">current</span> <span class="string">input</span> <span class="string">statement.</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:34:41</span> <span class="string">&gt; change master to master_host='172.31.13.126',master_user='slave01',master_password='slave123456',master_auto_position=1;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected, 2 warnings (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:35:14 &gt; start slave;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:35:15 &gt; show slave status\G;</span></span><br><span class="line"><span class="string">*************************** 1. row ***************************</span></span><br><span class="line"><span class="string"></span><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.139</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">slave01</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">4455</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">slave-relay-bin.000002</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">4059</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">4455</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">4266</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="number">9</span><span class="string">a7b78fc-6b96-11e7-9856-0232d9c5deea</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">mysql.slave_master_info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">more</span> <span class="string">updates</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="number">9</span><span class="attr">a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="number">9</span><span class="attr">a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17,</span></span><br><span class="line"><span class="attr">a1c1d189-6b96-11e7-9825-02a13635a5ca:</span><span class="number">1</span><span class="bullet">-3</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </span><br><span class="line"><span class="attr">                 Channel_Name:</span> </span><br><span class="line"><span class="attr">           Master_TLS_Version:</span> </span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ERROR:</span> </span><br><span class="line"><span class="literal">No</span> <span class="string">query</span> <span class="string">specified</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:35:18</span> <span class="string">&gt;</span></span><br></pre></td></tr></table></figure></p><h3 id="复制测试"><a href="#复制测试" class="headerlink" title="复制测试"></a>复制测试</h3><h4 id="主库登录测试"><a href="#主库登录测试" class="headerlink" title="主库登录测试"></a>主库登录测试</h4><p>登录主库，插入测试数据<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">37</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">35</span>:<span class="number">48</span> &gt; create database <span class="keyword">if</span> <span class="keyword">not</span> exists test11;use test11;                                                           </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">35</span>:<span class="number">52</span> &gt; create table <span class="keyword">if</span> <span class="keyword">not</span> exists t11(<span class="built_in">id</span> int unsigned <span class="keyword">not</span> null auto_increment,<span class="built_in">name</span> varchar(<span class="number">20</span>),primary key(`<span class="built_in">id</span>`));</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">35</span>:<span class="number">55</span> &gt; insert <span class="keyword">into</span> t11 values(null,'master11');</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">35</span>:<span class="number">58</span> &gt; select * <span class="keyword">from</span> t11;</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>     |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">|  <span class="number">1</span> | master11 |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">36</span>:<span class="number">02</span> &gt;</span><br></pre></td></tr></table></figure></p><p>登录从库，查看测试数据，此时数据已经复制过来<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -uroot -p </span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">29</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">36</span>:<span class="number">25</span> &gt; select * <span class="keyword">from</span> test11.t11;</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>     |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">|  <span class="number">1</span> | master11 |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">36</span>:<span class="number">30</span> &gt;</span><br></pre></td></tr></table></figure></p><h4 id="从库登录测试"><a href="#从库登录测试" class="headerlink" title="从库登录测试"></a>从库登录测试</h4><p>登录从库，插入测试数据<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -uroot -p </span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">32</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">37</span>:<span class="number">59</span> &gt; create database <span class="keyword">if</span> <span class="keyword">not</span> exists test11;use test11;</span><br><span class="line">Query OK, <span class="number">1</span> row affected, <span class="number">1</span> warning (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">03</span> &gt; create table <span class="keyword">if</span> <span class="keyword">not</span> exists t22(<span class="built_in">id</span> int unsigned <span class="keyword">not</span> null auto_increment,<span class="built_in">name</span> varchar(<span class="number">20</span>),primary key(`<span class="built_in">id</span>`));     </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">18</span> &gt; insert <span class="keyword">into</span> t22 values(null,'slave11'); </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">30</span> &gt; select * <span class="keyword">from</span> t22;</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>    |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">|  <span class="number">2</span> | slave11 |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">35</span> &gt;</span><br></pre></td></tr></table></figure></p><p>登录主库，查看测试数据，此时数据已经复制过来<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">38</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">39</span>:<span class="number">09</span> &gt; select * <span class="keyword">from</span> test11.t22;</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>    |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">|  <span class="number">2</span> | slave11 |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">39</span>:<span class="number">15</span> &gt;</span><br></pre></td></tr></table></figure></p><h3 id="MHA帐号建立"><a href="#MHA帐号建立" class="headerlink" title="MHA帐号建立"></a>MHA帐号建立</h3><h4 id="主库创建-1"><a href="#主库创建-1" class="headerlink" title="主库创建"></a>主库创建</h4><p>登录主库，创建允许主库和从库连接的MHA用户信息，再分别尝试使用MHA用户登录(省略)<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">41</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">36</span>:<span class="number">55</span> &gt; <span class="keyword">create</span> user <span class="string">'mha01'</span>@<span class="string">'172.31.9.182'</span> identified <span class="keyword">by</span> <span class="string">'mha123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">37</span>:<span class="number">14</span> &gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha01'</span>@<span class="string">'172.31.9.182'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">38</span>:<span class="number">02</span> &gt; <span class="keyword">create</span> user <span class="string">'mha01'</span>@<span class="string">'172.31.13.126'</span> identified <span class="keyword">by</span> <span class="string">'mha123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">38</span>:<span class="number">14</span> &gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha01'</span>@<span class="string">'172.31.13.126'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">38</span>:<span class="number">18</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p><h4 id="从库创建-1"><a href="#从库创建-1" class="headerlink" title="从库创建"></a>从库创建</h4><p>登录从库，由于复制已经把在主库创建的MHA用户信息复制了过来，尝试登录即可(省略)</p><h2 id="MHA安装"><a href="#MHA安装" class="headerlink" title="MHA安装"></a>MHA安装</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>分别在主库和从库上安装，执行命令：<br>yum -y install gcc gcc-c++ make openssl-devel perl perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Config-IniFiles perl-Time-HiRes perl-Module-Install.noarch mailx jwhois</p><h3 id="主库安装mha4mysql-node"><a href="#主库安装mha4mysql-node" class="headerlink" title="主库安装mha4mysql-node"></a>主库安装mha4mysql-node</h3><p>MHA管理端安装在从库上，主库上只需要mha4mysql-node即可，由于MySQL使用5.7版本，MHA也使用最新的0.57版本，采用编译安装方式。下载地址：<a href="https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw" target="_blank" rel="noopener">https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw</a><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cd</span> /usr/src/</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">src</span>]<span class="comment"># tar -zxf mha4mysql-node-0.57.tar.gz</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># perl Makefile.PL             #编译过程省略</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># make</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># make install</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># ll /usr/local/bin/ -t        #查看安装，有以下文件则mha4mysql-node安装成功</span></span><br><span class="line">total <span class="number">1760</span></span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root  <span class="number">16381</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">8261</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> purge_relay_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">7525</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> save_binary_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">4807</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p><h3 id="从库安装mha4mysql-manager和mha4mysql-node"><a href="#从库安装mha4mysql-manager和mha4mysql-node" class="headerlink" title="从库安装mha4mysql-manager和mha4mysql-node"></a>从库安装mha4mysql-manager和mha4mysql-node</h3><p>MHA管理端安装在从库，从库需要安装manager端和node端<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># cd /usr/src/</span></span><br><span class="line">[root@slave src]<span class="comment"># tar -zxf mha4mysql-manager-0.57.tar.gz </span></span><br><span class="line">[root@slave src]<span class="comment"># cd mha4mysql-manager-0.57</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># perl Makefile.PL           #编译过程省略</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># make</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># make install </span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># ll /usr/local/bin/ -t      #查看安装，有以下文件则mha4mysql-manager安装成功</span></span><br><span class="line">total 1756</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1779 </span>Jul<span class="number"> 21 </span>09:48 masterha_check_ssh</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 2517 </span>Jul<span class="number"> 21 </span>09:48 masterha_manager</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 2373 </span>Jul<span class="number"> 21 </span>09:48 masterha_master_switch</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 5171 </span>Jul<span class="number"> 21 </span>09:48 masterha_secondary_check</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1995 </span>Jul<span class="number"> 21 </span>09:48 masterha_check_repl</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1865 </span>Jul<span class="number"> 21 </span>09:48 masterha_check_status</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 3201 </span>Jul<span class="number"> 21 </span>09:48 masterha_conf_host</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 2165 </span>Jul<span class="number"> 21 </span>09:48 masterha_master_monitor</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1739 </span>Jul<span class="number"> 21 </span>09:48 masterha_stop</span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># cd ..</span></span><br><span class="line">[root@slave src]<span class="comment"># tar -zxf mha4mysql-node-0.57.tar.gz </span></span><br><span class="line">[root@slave src]<span class="comment"># cd mha4mysql-node-0.57</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># perl Makefile.PL              #编译过程省略        </span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># make</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># make install</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># ll /usr/local/bin/ -t         #查看安装，有以下文件则mha4mysql-node安装成功</span></span><br><span class="line">total 1800</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root <span class="number"> 16381 </span>Jul<span class="number"> 21 </span>09:54 apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 8261 </span>Jul<span class="number"> 21 </span>09:54 purge_relay_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 7525 </span>Jul<span class="number"> 21 </span>09:54 save_binary_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 4807 </span>Jul<span class="number"> 21 </span>09:54 filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p><h2 id="MHA目录结构说明"><a href="#MHA目录结构说明" class="headerlink" title="MHA目录结构说明"></a>MHA目录结构说明</h2><h3 id="MHAManager"><a href="#MHAManager" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>mhamanager工具包主要包括以下工具<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@slave  ~]<span class="comment"># ll /usr/local/bin/</span></span><br><span class="line">总用量 84</span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1995 </span>7月 <span class="number"> 19 </span>11:49 masterha_check_repl         <span class="comment">#检查MySQL复制情况</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1779 </span>7月 <span class="number"> 19 </span>11:49 masterha_check_ssh          <span class="comment">#检查MHA的SSH配置情况</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1865 </span>7月 <span class="number"> 19 </span>11:49 masterha_check_status       <span class="comment">#检测当前MHA运行状态</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 3201 </span>7月 <span class="number"> 19 </span>11:49 masterha_conf_host          <span class="comment">#添加或删除配置的server信息</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2517 </span>7月 <span class="number"> 19 </span>11:49 masterha_manager            <span class="comment">#启动MHA</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2165 </span>7月 <span class="number"> 19 </span>11:49 masterha_master_monitor     <span class="comment">#检测Master是否宕机</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2373 </span>7月 <span class="number"> 19 </span>11:49 masterha_master_switch      <span class="comment">#控制故障转移，自动或者手动</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 5172 </span>7月 <span class="number"> 19 </span>11:49 masterha_secondary_check    <span class="comment">#通过其他路由检测Master是否真的宕机</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1739 </span>7月 <span class="number"> 19 </span>11:49 masterha_stop               <span class="comment">#停止MHA</span></span><br></pre></td></tr></table></figure></p><h3 id="MHANode"><a href="#MHANode" class="headerlink" title="MHANode"></a>MHANode</h3><p>mhanode工具包主要包括以下工具<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master  ~]<span class="comment"># ll /usr/local/bin/</span></span><br><span class="line">总用量 44</span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root<span class="number"> 16371 </span>7月 <span class="number"> 19 </span>11:41 apply_diff_relay_logs       <span class="comment">#识别差异日志的中继日志，并将其差异事件应用于其他Slave</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 4807 </span>7月 <span class="number"> 19 </span>11:41 filter_mysqlbinlog          <span class="comment">#去除不必要的Rollback事件</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 8263 </span>7月 <span class="number"> 19 </span>11:41 purge_relay_logs            <span class="comment">#删除无用的Relay log，避免延时</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 7525 </span>7月 <span class="number"> 19 </span>11:41 save_binary_logs            <span class="comment">#保存和复制down掉的主服务器二进制日志</span></span><br></pre></td></tr></table></figure></p><h3 id="自定义扩展脚本说明"><a href="#自定义扩展脚本说明" class="headerlink" title="自定义扩展脚本说明"></a>自定义扩展脚本说明</h3><p>secondary_check_script          #通过多条网络路由检测master的可用性<br>master_ip_failover_script       #自动failover时候的切换脚本，可将vip信息写入此脚本中<br>shutdown_script                 #强制关闭master节点执行脚本<br>report_script                   #发送报告<br>init_conf_load_script           #加载初始配置参数，如不想在配置中写明文密码<br>master_ip_online_change_script  #手动failover时候的切换脚本  </p><h2 id="MHA扩展脚本"><a href="#MHA扩展脚本" class="headerlink" title="MHA扩展脚本"></a>MHA扩展脚本</h2><p>由于使用的AWS EC2，不支持VIP，可通过辅助IP的形式实现，这里使用脚本来辅助实现HA。</p><h3 id="aws-vip-change-sh"><a href="#aws-vip-change-sh" class="headerlink" title="aws_vip_change.sh"></a>aws_vip_change.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/aws_vip_change.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -lt 2 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Illegal param count.count = <span class="variable">$#</span>"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># High Availability IP variables</span></span><br><span class="line"><span class="comment"># Other node's IP to ping and VIP to swap if other node goes down</span></span><br><span class="line">VIP_ENI_ID=eni-7a5c7722</span><br><span class="line"></span><br><span class="line">NEW_MASTER_IP=<span class="variable">$1</span></span><br><span class="line">OLD_MASTER_IP=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"NEW_MASTER_IP=<span class="variable">$&#123;NEW_MASTER_IP&#125;</span>,OLD_MASTER_IP=<span class="variable">$&#123;OLD_MASTER_IP&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify the EC2 region that this will be running in   #以下为当前用户能够执行aws cli命令的key信息</span></span><br><span class="line">REGION=cn-north-1</span><br><span class="line">AWSAccessKeyId=AKIAPUXGZV6F6EKCOK7Q</span><br><span class="line">AWSSecretKey=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       </span><br><span class="line"></span><br><span class="line"><span class="comment"># Run aws-apitools-common.sh to set up default environment variables and to</span></span><br><span class="line"><span class="comment"># leverage AWS security credentials provided by EC2 roles</span></span><br><span class="line">. /etc/profile.d/aws-apitools-common.sh</span><br><span class="line"></span><br><span class="line">ACCESS_USER_OPTION=<span class="string">"--aws-access-key <span class="variable">$&#123;AWSAccessKeyId&#125;</span> --aws-secret-key <span class="variable">$&#123;AWSSecretKey&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">ssh -t -t root@<span class="variable">$&#123;OLD_MASTER_IP&#125;</span> /sbin/ifconfig eth4 down    <span class="comment">#其中eth4网卡名要与下文中，新申请ENI并绑定实例ID对应的网卡名相同</span></span><br><span class="line"></span><br><span class="line">VIP_ATTACHMENT_ID=`ec2-describe-network-interface-attribute <span class="variable">$&#123;VIP_ENI_ID&#125;</span> <span class="variable">$&#123;ACCESS_USER_OPTION&#125;</span> --region <span class="variable">$&#123;REGION&#125;</span> -a | grep ATTACHMENT -m 1 | awk <span class="string">'&#123;print $3;&#125;'</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"VIP_ATTACHMENT_ID=<span class="variable">$&#123;VIP_ATTACHMENT_ID&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">/opt/aws/bin/ec2-detach-network-interface <span class="variable">$&#123;VIP_ATTACHMENT_ID&#125;</span> <span class="variable">$&#123;ACCESS_USER_OPTION&#125;</span> --force --region <span class="variable">$&#123;REGION&#125;</span></span><br><span class="line">sleep 10</span><br><span class="line"></span><br><span class="line">INSTANCE_ID=`ssh root@<span class="variable">$&#123;NEW_MASTER_IP&#125;</span> /usr/bin/curl --silent http://169.254.169.254/latest/meta-data/instance-id`  <span class="comment">#其中169.254.169.254从本地链路中获取实例ID</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"INSTANCE_ID=<span class="variable">$&#123;INSTANCE_ID&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">/opt/aws/bin/ec2-attach-network-interface <span class="variable">$&#123;VIP_ENI_ID&#125;</span> -i <span class="variable">$&#123;INSTANCE_ID&#125;</span> -d 1 <span class="variable">$&#123;ACCESS_USER_OPTION&#125;</span> --region <span class="variable">$&#123;REGION&#125;</span></span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="master-ip-failover"><a href="#master-ip-failover" class="headerlink" title="master_ip_failover"></a>master_ip_failover</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/master_ip_failover </span></span><br><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">#  it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">#  GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment">#   along with this program; if not, write to the Free Software</span></span><br><span class="line"><span class="comment">#  Foundation, Inc.,</span></span><br><span class="line"><span class="comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## <span class="doctag">Note:</span> This is a sample script and is not complete. Modify the script based on your environment.</span></span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line">use Getopt::Long;</span><br><span class="line">use MHA::DBHelper;</span><br><span class="line"></span><br><span class="line">my (</span><br><span class="line">  <span class="variable">$command</span>,        <span class="variable">$ssh_user</span>,         <span class="variable">$orig_master_host</span>,</span><br><span class="line">  <span class="variable">$orig_master_ip</span>, <span class="variable">$orig_master_port</span>, <span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="variable">$new_master_ip</span>,  <span class="variable">$new_master_port</span>,  <span class="variable">$new_master_user</span>,</span><br><span class="line">  <span class="variable">$new_master_password</span></span><br><span class="line">);</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'command=s'</span>             =&gt; \<span class="variable">$command</span>,</span><br><span class="line">  <span class="string">'ssh_user=s'</span>            =&gt; \<span class="variable">$ssh_user</span>,</span><br><span class="line">  <span class="string">'orig_master_host=s'</span>    =&gt; \<span class="variable">$orig_master_host</span>,</span><br><span class="line">  <span class="string">'orig_master_ip=s'</span>      =&gt; \<span class="variable">$orig_master_ip</span>,</span><br><span class="line">  <span class="string">'orig_master_port=i'</span>    =&gt; \<span class="variable">$orig_master_port</span>,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>     =&gt; \<span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="string">'new_master_ip=s'</span>       =&gt; \<span class="variable">$new_master_ip</span>,</span><br><span class="line">  <span class="string">'new_master_port=i'</span>     =&gt; \<span class="variable">$new_master_port</span>,</span><br><span class="line">  <span class="string">'new_master_user=s'</span>     =&gt; \<span class="variable">$new_master_user</span>,</span><br><span class="line">  <span class="string">'new_master_password=s'</span> =&gt; \<span class="variable">$new_master_password</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line">sub main &#123;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="variable">$command</span> eq <span class="string">"stop"</span> || <span class="variable">$command</span> eq <span class="string">"stopssh"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># $orig_master_host, $orig_master_ip, $orig_master_port are passed.</span></span><br><span class="line">    <span class="comment"># If you manage master ip address at global catalog database,</span></span><br><span class="line">    <span class="comment"># invalidate orig_master_ip here.</span></span><br><span class="line">    my <span class="variable">$exit_code</span> = <span class="number">1</span>;</span><br><span class="line">    eval &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment"># updating global catalog, etc</span></span><br><span class="line">      <span class="variable">$exit_code</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">      warn <span class="string">"Got Error: $@\n"</span>;</span><br><span class="line">      <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  elsif ( <span class="variable">$command</span> eq <span class="string">"start"</span> ) &#123;</span><br><span class="line">    my <span class="variable">$exit_code</span> = <span class="number">10</span>;</span><br><span class="line">    my @vip_change_cmd = (<span class="string">"/usr/local/bin/aws_vip_change.sh"</span>,<span class="variable">$new_master_host</span>,<span class="variable">$orig_master_host</span>);</span><br><span class="line">    system @vip_change_cmd;</span><br><span class="line">    <span class="variable">$exit_code</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">      warn <span class="variable">$@</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment"># If you want to continue failover, exit 10.</span></span><br><span class="line">      <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  elsif ( <span class="variable">$command</span> eq <span class="string">"status"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># do nothing</span></span><br><span class="line">    <span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    &amp;usage();</span><br><span class="line">    <span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub usage &#123;</span><br><span class="line">  print</span><br><span class="line"><span class="string">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h3 id="send-report"><a href="#send-report" class="headerlink" title="send_report"></a>send_report</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/send_report </span></span><br><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">strict</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">warnings</span> <span class="title">FATAL</span> =&gt; '<span class="title">all</span>';</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mail</span>::<span class="title">Sender</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Getopt</span>::<span class="title">Long</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span></span><br><span class="line">my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );</span><br><span class="line">my $smtp=<span class="string">'smtp.126.com'</span>;</span><br><span class="line">my $mail_from=<span class="string">'xxx@126.com'</span>;</span><br><span class="line">my $mail_user=<span class="string">'xxx@126.com'</span>;</span><br><span class="line">my $mail_pass=<span class="string">'xxx'</span>;</span><br><span class="line"><span class="comment">#my $mail_to=['xxx','xxx'];</span></span><br><span class="line">my $mail_to=<span class="string">'xxx'</span>;</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'orig_master_host=s'</span> =&gt; \$dead_master_host,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span><br><span class="line">  <span class="string">'new_slave_hosts=s'</span>  =&gt; \$new_slave_hosts,</span><br><span class="line">  <span class="string">'subject=s'</span>          =&gt; \$subject,</span><br><span class="line">  <span class="string">'body=s'</span>             =&gt; \$body,</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);</span><br><span class="line"> </span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_;</span><br><span class="line">    open my $DEBUG, <span class="string">"&gt; /var/log/masterha/app1/manager.log"</span></span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Can't open the debug      file:$!\n"</span>;</span><br><span class="line">    my $sender = <span class="keyword">new</span> Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; <span class="string">'text/plain; charset=utf-8'</span>,</span><br><span class="line">        encoding    =&gt; <span class="string">'utf-8'</span>,</span><br><span class="line">        smtp        =&gt; $smtp,</span><br><span class="line">        from        =&gt; $mail_from,</span><br><span class="line">        auth        =&gt; <span class="string">'LOGIN'</span>,</span><br><span class="line">        TLS_allowed =&gt; <span class="string">'0'</span>,</span><br><span class="line">        authid      =&gt; $user,</span><br><span class="line">        authpwd     =&gt; $passwd,</span><br><span class="line">        to          =&gt; $mail_to,</span><br><span class="line">        subject     =&gt; $subject,</span><br><span class="line">        debug       =&gt; $DEBUG</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    $sender-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; $msg,</span><br><span class="line">            debug =&gt; $DEBUG</span><br><span class="line">        &#125;</span><br><span class="line">    ) <span class="keyword">or</span> <span class="keyword">print</span> $Mail::Sender::Error;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Do whatever you want here</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">exit</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure><h2 id="主库手动绑定ENI和实例关系"><a href="#主库手动绑定ENI和实例关系" class="headerlink" title="主库手动绑定ENI和实例关系"></a>主库手动绑定ENI和实例关系</h2><p>在主库上先申请新的ENI，注意申请时先绑定的group，以满足其他EC2能够连接些ENI。<br>申请成功后，根据新的ENI和当前主实例的实例ID绑定，最终确认新的VIP是否绑定上。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">ifconfig</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:E6:0B:68:5C:1C</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.13.126</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::e6:bff:fe68:5c1c/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:4063</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:3292</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:691839</span> <span class="string">(675.6</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:390499</span> <span class="string">(381.3</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="string">::1/128</span> <span class="attr">Scope:Host</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">aws</span> <span class="string">ec2</span> <span class="string">create-network-interface</span> <span class="bullet">--subnet-id</span> <span class="string">subnet-33859151</span> <span class="bullet">--private-ip-address</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.200</span> <span class="bullet">--groups</span> <span class="string">sg-e50a1c87</span> <span class="string">sg-6b1f0809</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "NetworkInterface":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">        "Status":</span> <span class="string">"pending"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "MacAddress":</span> <span class="string">"02:12:25:83:a0:22"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "SourceDestCheck":</span> <span class="literal">true</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "VpcId":</span> <span class="string">"vpc-b18195d3"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "Description":</span> <span class="string">""</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "NetworkInterfaceId":</span> <span class="string">"eni-7a5c7722"</span><span class="string">,</span>   <span class="comment">#新申请的ENI名字</span></span><br><span class="line"><span class="attr">        "PrivateIpAddresses":</span> <span class="string">[</span></span><br><span class="line">            <span class="string">&#123;</span></span><br><span class="line"><span class="attr">                "PrivateDnsName":</span> <span class="string">"ip-172-31-0-200.cn-north-1.compute.internal"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "Primary":</span> <span class="literal">true</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "PrivateIpAddress":</span> <span class="string">"172.31.0.200"</span>  <span class="comment">#新ENI绑定的私有IP</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">],</span> </span><br><span class="line"><span class="attr">        "RequesterManaged":</span> <span class="literal">false</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "Groups":</span> <span class="string">[</span></span><br><span class="line">            <span class="string">&#123;</span></span><br><span class="line"><span class="attr">                "GroupName":</span> <span class="string">"For Mysql"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "GroupId":</span> <span class="string">"sg-e50a1c87"</span></span><br><span class="line">            <span class="string">&#125;,</span> </span><br><span class="line">            <span class="string">&#123;</span></span><br><span class="line"><span class="attr">                "GroupName":</span> <span class="string">"OnlySSH-Allow"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "GroupId":</span> <span class="string">"sg-6b1f0809"</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">],</span> </span><br><span class="line"><span class="attr">        "PrivateDnsName":</span> <span class="string">"ip-172-31-0-200.cn-north-1.compute.internal"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "AvailabilityZone":</span> <span class="string">"cn-north-1a"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "RequesterId":</span> <span class="string">"AIDAPVDKK6NLF6SZ553KS"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "SubnetId":</span> <span class="string">"subnet-33859151"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "OwnerId":</span> <span class="string">"981100955930"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "TagSet":</span> <span class="string">[],</span> </span><br><span class="line"><span class="attr">        "PrivateIpAddress":</span> <span class="string">"172.31.0.200"</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">aws</span> <span class="string">ec2</span> <span class="string">attach-network-interface</span> <span class="bullet">--network-interface-id</span> <span class="string">eni-7a5c7722</span> <span class="bullet">--instance-id</span> <span class="string">i-0a259e4950b0b3cf9</span> <span class="bullet">--device-index</span> <span class="number">1</span>    <span class="comment">#将ENI和实例绑定</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "AttachmentId":</span> <span class="string">"eni-attach-2b2c9345"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">ifconfig</span>   <span class="comment">#查看ip：172.31.0.200已绑定成功，同时要在其他EC2确定此安全组是否能够满足需求，否则还需要重新调整。</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:E6:0B:68:5C:1C</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.13.126</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::e6:bff:fe68:5c1c/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:5435</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:4190</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:810999</span> <span class="string">(791.9</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:501986</span> <span class="string">(490.2</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">eth4</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:12:25:83:A0:22</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.0.200</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::12:25ff:fe83:a022/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:11</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:26</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:1218</span> <span class="string">(1.1</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:2664</span> <span class="string">(2.6</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="string">::1/128</span> <span class="attr">Scope:Host</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span></span><br></pre></td></tr></table></figure></p><h2 id="从库配置MHAManager"><a href="#从库配置MHAManager" class="headerlink" title="从库配置MHAManager"></a>从库配置MHAManager</h2><p>创建配置目录/etc/masterha/，同时创建一个项目上的配置文件，仅配置自动FailOver部分，只需要master_ip_failover和report_script脚本，其他脚本暂时不定义。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mkdir -p /etc/masterha/</span></span><br><span class="line">[root@slave ~]<span class="comment"># cd /etc/masterha/</span></span><br><span class="line">[root@slave masterha]<span class="comment"># </span></span><br><span class="line">[root@slave masterha]<span class="comment"># cat app1.cnf </span></span><br><span class="line">[server default]</span><br><span class="line">manager_workdir=/var/log/masterha/app1                              <span class="comment">#manager工作目录</span></span><br><span class="line">manager_log=/var/log/masterha/app1/manager.log                      <span class="comment">#manager日志</span></span><br><span class="line">master_binlog_dir=/hwdata/data/percona                              <span class="comment">#mysql数据目录</span></span><br><span class="line">password=mha123456                                                  <span class="comment">#mha连接密码</span></span><br><span class="line">user=mha01                                                          <span class="comment">#mha连接用户</span></span><br><span class="line">ping_interval=1                                                     <span class="comment">#监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行failover</span></span><br><span class="line">remote_workdir=/tmp                                                 <span class="comment">#远端mysql在发生切换时binlog的保存位置</span></span><br><span class="line">repl_password=slave123456                                           <span class="comment">#复制密码</span></span><br><span class="line">repl_user=slave01                                                   <span class="comment">#复制用户</span></span><br><span class="line">ssh_user=root                                                       <span class="comment">#ssh用户</span></span><br><span class="line">master_ip_failover_script=/usr/local/bin/master_ip_failover         <span class="comment">#自动failover切换脚本</span></span><br><span class="line"><span class="comment">#master_ip_online_change_script= /usr/local/bin/master_ip_online_change      #手动failover切换脚本</span></span><br><span class="line">report_script=/usr/local/bin/send_report                            <span class="comment">#报告发送脚本(不是必须)</span></span><br><span class="line"><span class="comment">#shutdown_script=                                                   #故障发生后关闭主机的脚本(不是必须)</span></span><br><span class="line">secondary_check_script = masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306 <span class="comment">#通过第三方机器确认目标主库是否存活，这里的ip可换成其他机器，用于检测</span></span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname=172.31.13.126                                              <span class="comment">#主库地址</span></span><br><span class="line">port=3306</span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">hostname=172.31.9.182                                               <span class="comment">#从库地址</span></span><br><span class="line">port=3306</span><br><span class="line">candidate_master=1                                                  <span class="comment">#候选master</span></span><br></pre></td></tr></table></figure></p><h2 id="测试MHAManager-SSH"><a href="#测试MHAManager-SSH" class="headerlink" title="测试MHAManager SSH"></a>测试MHAManager SSH</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_ssh <span class="attribute">--conf</span>=/etc/masterha/app1.cnf </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">info</span>] Starting SSH<span class="built_in"> connection </span>tests<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@172.31.13.126(172.31.13.126:22) <span class="keyword">to</span> root@172.31.9.182(172.31.9.182:22)<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Mon Jul 24 13:58:05 2017 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@172.31.9.182(172.31.9.182:22) <span class="keyword">to</span> root@172.31.13.126(172.31.13.126:22)<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Mon Jul 24 13:58:05 2017 - [<span class="builtin-name">info</span>] All SSH<span class="built_in"> connection </span>tests passed successfully.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure><h2 id="测试MHAManager-复制"><a href="#测试MHAManager-复制" class="headerlink" title="测试MHAManager 复制"></a>测试MHAManager 复制</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_repl <span class="attribute">--conf</span>=/etc/masterha/app1.cnf </span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">info</span>] MHA::MasterMonitor version 0.57.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Master configurations are as below: </span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating <span class="keyword">from</span> 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating <span class="keyword">from</span> 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] GTID failover mode = 1</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Dead Servers:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Alive Servers:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Alive Slaves:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   172.31.9.182(172.31.9.182:3306)  <span class="attribute">Version</span>=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]     GTID ON</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Current Alive Master: 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking slave configurations<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking replication filtering settings<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  Replication filtering check ok.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] GTID (with auto-pos) is supported. Skipping all SSH <span class="keyword">and</span> Node package checking.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking SSH publickey authentication<span class="built_in"> settings </span>on the current master<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] HealthCheck: SSH <span class="keyword">to</span> 172.31.13.126 is reachable.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking replication<span class="built_in"> health </span>on 172.31.9.182<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   /usr/local/bin/master_ip_failover <span class="attribute">--command</span>=status <span class="attribute">--ssh_user</span>=root <span class="attribute">--orig_master_host</span>=172.31.13.126 <span class="attribute">--orig_master_ip</span>=172.31.13.126 <span class="attribute">--orig_master_port</span>=3306 </span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  OK.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">warning</span>] shutdown_script is <span class="keyword">not</span> defined.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Got exit code 0 (<span class="keyword">Not</span> master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication<span class="built_in"> Health </span>is OK.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure><h2 id="启动MHAManager"><a href="#启动MHAManager" class="headerlink" title="启动MHAManager"></a>启动MHAManager</h2><h3 id="启动进程"><a href="#启动进程" class="headerlink" title="启动进程"></a>启动进程</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta"># nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;</span></span><br><span class="line">[<span class="meta">1</span>] <span class="number">4439</span></span><br><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta"># nohup: ignoring input and appending output to ‘nohup.out’</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta">#</span></span><br></pre></td></tr></table></figure><h3 id="查看启动日志"><a href="#查看启动日志" class="headerlink" title="查看启动日志"></a>查看启动日志</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># cat /var/log/masterha/app1/manager.log </span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:10<span class="number"> 2017 </span>- [info] MHA::MasterMonitor version 0.57.  <span class="comment">#检查版本</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306) <span class="comment">#获取当前主节点ip</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Master configurations are as below:   <span class="comment">#获取复制结构</span></span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating from 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating from 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] GTID failover mode =<span class="number"> 1 </span>   <span class="comment">#GTID模式</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Alive Servers:            <span class="comment">#当前在线实例列表</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Alive Slaves:             <span class="comment">#当前在线slave列表及版本信息</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Current Alive Master: 172.31.13.126(172.31.13.126:3306)   <span class="comment">#当前主实例信息</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking slave configurations..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]  binlog_do_db= , binlog_ignore_db=                        <span class="comment">#复制过滤</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] HealthCheck: SSH to 172.31.13.126 is reachable.           <span class="comment">#ssh可用</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)                                          <span class="comment">#再次确认当前复制架构</span></span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 </span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]  OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [warning] shutdown_script is not defined.                        <span class="comment">#shutdown_script脚本未定义    </span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Set master ping interval<span class="number"> 1 </span>seconds.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Set secondary check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306                                                <span class="comment">#第三方检查登录</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Starting ping health check on 172.31.13.126(172.31.13.126:3306)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Ping(SELECT) succeeded, waiting until MySQL doesn't respond.. <span class="comment">#启动成功，等待failover</span></span><br><span class="line">[root@slave masterha]<span class="comment"># ps aux|grep master</span></span><br><span class="line">root     <span class="number"> 4439 </span> 0.0  0.2<span class="number"> 287004 </span>23636 pts/0    S    14:04   0:00 perl /usr/local/bin/masterha_manager --conf=/etc/masterha/app1.cnf <span class="comment">#进程存在</span></span><br><span class="line">root     <span class="number"> 5008 </span> 0.0  0.0<span class="number"> 110456 </span><span class="number"> 2092 </span>pts/0    S+   14:13   0:00 grep --color=auto master</span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure><h2 id="模拟主库故障"><a href="#模拟主库故障" class="headerlink" title="模拟主库故障"></a>模拟主库故障</h2><h3 id="确认当前VIP状态"><a href="#确认当前VIP状态" class="headerlink" title="确认当前VIP状态"></a>确认当前VIP状态</h3><p>在主库上执行停止服务，观察MHAManager日志，并确认VIP是否切换到从库上<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>       #确认当前<span class="selector-tag">VIP</span>：<span class="selector-tag">172</span><span class="selector-class">.31</span><span class="selector-class">.0</span><span class="selector-class">.200</span>在主库上</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:E6</span><span class="selector-pseudo">:0B</span><span class="selector-pseudo">:68</span><span class="selector-pseudo">:5C</span><span class="selector-pseudo">:1C</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.13.126</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::e6</span><span class="selector-pseudo">:bff</span><span class="selector-pseudo">:fe68</span><span class="selector-pseudo">:5c1c</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:9629</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8119</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1202679</span> (<span class="number">1.1</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1113439</span> (<span class="number">1.0</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth4</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:25</span><span class="selector-pseudo">:83</span><span class="selector-pseudo">:A0</span><span class="selector-pseudo">:22</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.0.200</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::12</span><span class="selector-pseudo">:25ff</span><span class="selector-pseudo">:fe83</span><span class="selector-pseudo">:a022</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:4</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:4</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:562</span> (<span class="number">562.0</span> b)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:600</span> (<span class="number">600.0</span> b)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-pseudo">::1</span>/<span class="selector-tag">128</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Host</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:90</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:90</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17324</span> (<span class="number">16.9</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17324</span> (<span class="number">16.9</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure></p><h3 id="确认MHAManger进程状态"><a href="#确认MHAManger进程状态" class="headerlink" title="确认MHAManger进程状态"></a>确认MHAManger进程状态</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@slave</span> <span class="string">masterha]#</span> <span class="string">ps</span> <span class="string">aux|grep</span> <span class="string">master</span></span><br><span class="line"><span class="string">root</span>     <span class="number">11333</span>  <span class="number">0.4</span>  <span class="number">0.2</span> <span class="number">287004</span> <span class="number">23604</span> <span class="string">pts/0</span>    <span class="string">S</span>    <span class="number">15</span><span class="string">:36</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">perl</span> <span class="string">/usr/local/bin/masterha_manager</span> <span class="bullet">--conf=/etc/masterha/app1.cnf</span></span><br><span class="line"><span class="string">root</span>     <span class="number">11377</span>  <span class="number">0.0</span>  <span class="number">0.0</span> <span class="number">110456</span>  <span class="number">2252</span> <span class="string">pts/0</span>    <span class="string">S+</span>   <span class="number">15</span><span class="string">:37</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">grep</span> <span class="bullet">--color=auto</span> <span class="string">master</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">masterha]#</span> <span class="string">cd</span> <span class="string">/var/log/masterha/app1/</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">ll</span></span><br><span class="line"><span class="string">total</span> <span class="number">8</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>   <span class="number">36</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:37</span> <span class="string">app1.master_status.health</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">2833</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:36</span> <span class="string">manager.log</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">cat</span> <span class="string">manager.log</span> <span class="string">|tail</span> <span class="bullet">-2</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:36:54</span> <span class="number">2017</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Starting</span> <span class="string">ping</span> <span class="string">health</span> <span class="string">check</span> <span class="string">on</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:36:54</span> <span class="number">2017</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Ping(SELECT)</span> <span class="string">succeeded,</span> <span class="string">waiting</span> <span class="string">until</span> <span class="string">MySQL</span> <span class="string">doesn't</span> <span class="string">respond..</span>     <span class="comment">#正在等待主库FailOver</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">ifconfig</span>     <span class="comment">#当前从库没有存在VIP：172.31.0.200</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:0E:FB:F1:E9:4E</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.9.182</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::e:fbff:fef1:e94e/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:16565</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:17269</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:2084631</span> <span class="string">(1.9</span> <span class="string">MiB)</span>  <span class="string">TX</span> <span class="attr">bytes:2304176</span> <span class="string">(2.1</span> <span class="string">MiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="string">::1/128</span> <span class="attr">Scope:Host</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:2556</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:2556</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:605471</span> <span class="string">(591.2</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:605471</span> <span class="string">(591.2</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span></span><br></pre></td></tr></table></figure><h3 id="停止主库服务，触发主库FailOver"><a href="#停止主库服务，触发主库FailOver" class="headerlink" title="停止主库服务，触发主库FailOver"></a>停止主库服务，触发主库FailOver</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">mysqld</span> <span class="selector-tag">stop</span>                    #服务停止</span><br><span class="line"><span class="selector-tag">Shutting</span> <span class="selector-tag">down</span> <span class="selector-tag">MySQL</span> (Percona Server)............ <span class="selector-tag">SUCCESS</span>! </span><br><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>                                   <span class="selector-id">#VIP</span>已经不存在</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:E6</span><span class="selector-pseudo">:0B</span><span class="selector-pseudo">:68</span><span class="selector-pseudo">:5C</span><span class="selector-pseudo">:1C</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.13.126</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::e6</span><span class="selector-pseudo">:bff</span><span class="selector-pseudo">:fe68</span><span class="selector-pseudo">:5c1c</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:10242</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8535</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1256340</span> (<span class="number">1.1</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1175340</span> (<span class="number">1.1</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-pseudo">::1</span>/<span class="selector-tag">128</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Host</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:92</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:92</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17424</span> (<span class="number">17.0</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17424</span> (<span class="number">17.0</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure><h3 id="观察FailOver日志"><a href="#观察FailOver日志" class="headerlink" title="观察FailOver日志"></a>观察FailOver日志</h3><p>登录从库，查看MHAManager日志<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]<span class="comment"># cat manager.log </span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:52<span class="number"> 2017 </span>- [info] MHA::MasterMonitor version 0.57.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Master configurations are as below: </span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating from 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating from 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] GTID failover mode = 1</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Alive Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Alive Slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Current Alive Master: 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking slave configurations..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] HealthCheck: SSH to 172.31.13.126 is reachable.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]  OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [warning] shutdown_script is not defined.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Set master ping interval<span class="number"> 1 </span>seconds.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Set secondary check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Starting ping health check on 172.31.13.126(172.31.13.126:3306)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Ping(SELECT) succeeded, waiting until MySQL doesn't respond..         <span class="comment">#等待主库FailOver</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [warning] Got error on MySQL select ping:<span class="number"> 2006 </span>(MySQL server has gone away)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] Executing secondary network check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306  --user=root  --master_host=172.31.13.126  --master_ip=172.31.13.126  --master_port=3306 --master_user=mha01 --master_password=mha123456 --ping_type=SELECT</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] Executing SSH check script: exit 0</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] HealthCheck: SSH to 172.31.13.126 is reachable.</span><br><span class="line">Monitoring server 172.31.13.126 is reachable, Master is not reachable from 172.31.13.126. OK.</span><br><span class="line">Monitoring server 172.31.9.182 is reachable, Master is not reachable from 172.31.9.182. OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] Master is not reachable from all other monitoring servers. Failover should start.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:02<span class="number"> 2017 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '172.31.13.126' (111))</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:02<span class="number"> 2017 </span>- [warning] Connection failed<span class="number"> 2 </span>time(s)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:03<span class="number"> 2017 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '172.31.13.126' (111))</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:03<span class="number"> 2017 </span>- [warning] Connection failed<span class="number"> 3 </span>time(s)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '172.31.13.126' (111))</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Connection failed<span class="number"> 4 </span>time(s)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Master is not reachable from health checker!</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Master 172.31.13.126(172.31.13.126:3306) is not reachable!</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] SSH is reachable.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [info] Connecting to a master server failed. Reading configuration file /etc/masterha_default.cnf and /etc/masterha/app1.cnf again, and trying to connect to all servers to check server status..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] GTID failover mode = 1</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Alive Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Alive Slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Checking slave configurations..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Master is down!</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Terminating monitoring script.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Got exit code<span class="number"> 20 </span>(Master dead).</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] MHA::MasterFailover version 0.57.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Starting master failover.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] * Phase 1: Configuration Check Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] GTID failover mode = 1</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Checking master reachability via MySQL(double check)...</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Alive Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Alive Slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Starting GTID based failover.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] ** Phase 1: Configuration Check Phase completed.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 2: Dead Master Shutdown Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Forcing shutdown so that applications never connect to the current master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Executing master IP deactivation script:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 --command=stopssh --ssh_user=root  </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  done.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 2: Dead Master Shutdown Phase completed.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3: Master Recovery Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3.1: Getting Latest Slaves Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] The latest binary log file/position on all slaves is mysql-bin.000011:234</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Latest slaves (Slaves that received relay log files to the latest):</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] The oldest binary log file/position on all slaves is mysql-bin.000011:234</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Oldest slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3.3: Determining New Master Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Searching new master from slaves..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Candidate masters from the configuration file:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Non-candidate masters:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Searching from candidate_master slaves which have received the latest relay log events..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] New master is 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Starting master failover..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">From:</span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">To:</span><br><span class="line">172.31.9.182(172.31.9.182:3306) (new master)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3.3: New Master Recovery Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Waiting all logs to be applied.. </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   done.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Getting new master's binlog name and position..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  mysql-bin.000008:234</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='172.31.9.182', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='slave01', MASTER_PASSWORD='xxx';</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000008, 234, 28a037e5-6d0f-11e7-b43a-02e60b685c1c:1-15,</span><br><span class="line">39292a50-6d0f-11e7-999e-020efbf1e94e:1-4</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Executing master IP activate script:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --command=start --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 --new_master_host=172.31.9.182 --new_master_ip=172.31.9.182 --new_master_port=3306 --new_master_user='mha01'   --new_master_password=xxx</span><br><span class="line">NEW_MASTER_IP=172.31.9.182,OLD_MASTER_IP=172.31.13.126</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br><span class="line">VIP_ATTACHMENT_ID=eni-attach-5b219e35</span><br><span class="line">ATTACHMENT              eni-attach-5b219e35     detaching</span><br><span class="line">INSTANCE_ID=i-03135a59c242e9bad</span><br><span class="line">eni-attach-0f209f61</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info]  OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] Setting read_only=0 on 172.31.9.182(172.31.9.182:3306)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info]  ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] ** Finished master recovery successfully.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 3: Master Recovery Phase completed.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 4: Slaves Recovery Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 4.1: Starting Slaves in parallel..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] All new slave servers recovered successfully.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 5: New master cleanup phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] Resetting slave info on the new master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info]  172.31.9.182: Resetting slave info succeeded.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] Master failover to 172.31.9.182(172.31.9.182:3306) completed successfully.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line"></span><br><span class="line">----- Failover Report --<span class="yaml"><span class="meta">---</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="attr">app1:</span> <span class="string">MySQL</span> <span class="string">Master</span> <span class="string">failover</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">succeeded</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Master</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">is</span> <span class="string">down!</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Check</span> <span class="string">MHA</span> <span class="string">Manager</span> <span class="string">logs</span> <span class="string">at</span> <span class="attr">slave:/var/log/masterha/app1/manager.log</span> <span class="string">for</span> <span class="string">details.</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Started</span> <span class="string">automated(non-interactive)</span> <span class="string">failover.</span></span></span><br><span class="line"><span class="yaml"><span class="string">Invalidated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address</span> <span class="string">on</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span></span></span><br><span class="line"><span class="yaml"><span class="string">Selected</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">as</span> <span class="string">a</span> <span class="string">new</span> <span class="string">master.</span></span></span><br><span class="line"><span class="yaml"><span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Applying</span> <span class="string">all</span> <span class="string">logs</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Activated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address.</span></span></span><br><span class="line"><span class="yaml"><span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="string">Resetting</span> <span class="string">slave</span> <span class="string">info</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="string">Master</span> <span class="string">failover</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">completed</span> <span class="string">successfully.</span></span></span><br><span class="line"><span class="yaml"><span class="string">Mon</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">16</span><span class="string">:27:13</span> <span class="number">2017</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Sending</span> <span class="string">mail..</span></span></span><br><span class="line"><span class="yaml"><span class="string">defined(@array)</span> <span class="string">is</span> <span class="string">deprecated</span> <span class="string">at</span> <span class="string">/usr/share/perl5/vendor_perl/Mail/Sender.pm</span> <span class="string">line</span> <span class="number">318.</span></span></span><br><span class="line"><span class="yaml">        <span class="string">(Maybe</span> <span class="string">you</span> <span class="string">should</span> <span class="string">just</span> <span class="string">omit</span> <span class="string">the</span> <span class="string">defined()?)</span></span></span><br><span class="line"><span class="yaml"><span class="string">defined(@array)</span> <span class="string">is</span> <span class="string">deprecated</span> <span class="string">at</span> <span class="string">/usr/share/perl5/vendor_perl/Mail/Sender.pm</span> <span class="string">line</span> <span class="number">2693.</span></span></span><br><span class="line"><span class="yaml">        <span class="string">(Maybe</span> <span class="string">you</span> <span class="string">should</span> <span class="string">just</span> <span class="string">omit</span> <span class="string">the</span> <span class="string">defined()?)</span></span></span><br><span class="line"><span class="yaml"><span class="string">Option</span> <span class="string">new_slave_hosts</span> <span class="string">requires</span> <span class="string">an</span> <span class="string">argument</span></span></span><br><span class="line"><span class="yaml"><span class="string">Unknown</span> <span class="attr">option:</span> <span class="string">conf</span></span></span><br><span class="line"><span class="yaml"><span class="attr">tail:</span> <span class="string">manager.log:</span> <span class="string">file</span> <span class="string">truncated</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">220</span> <span class="number">126.</span><span class="string">com</span> <span class="string">Anti-spam</span> <span class="string">GT</span> <span class="string">for</span> <span class="string">Coremail</span> <span class="string">System</span> <span class="string">(126com[20140526])</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">EHLO</span> <span class="string">slave</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-mail</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-PIPELINING</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-AUTH</span> <span class="string">LOGIN</span> <span class="string">PLAIN</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-AUTH=LOGIN</span> <span class="string">PLAIN</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-coremail</span> <span class="number">1</span><span class="string">Uxr2xKj7kG0xkI17xGrU7I0s8FY2U3Uj8Cz28x1UUUUU7Ic2I0Y2Ur0Vl_3UCa0xDrUUUUj</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-STARTTLS</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="number">8</span><span class="string">BITMIME</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">AUTH</span> <span class="string">LOGIN</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">334</span> <span class="string">dXNlcm5hbWU6</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">ZHdqNTY4NTg4QDEyNi5jb20=</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">334</span> <span class="string">UGFzc3dvcmQ6</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">RHdqMTIzNDU=</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">235</span> <span class="string">Authentication</span> <span class="string">successful</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">MAIL</span> <span class="attr">FROM:&lt;dwj568588@126.com&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="string">Mail</span> <span class="string">OK</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">RCPT</span> <span class="attr">TO:&lt;duanwenjie@huan.tv&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="string">Mail</span> <span class="string">OK</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">DATA</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">354</span> <span class="string">End</span> <span class="string">data</span> <span class="string">with</span> <span class="string">&lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">To:</span> <span class="string">duanwenjie@huan.tv</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">From:</span> <span class="string">dwj568588@126.com</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Subject:</span> <span class="attr">app1:</span> <span class="string">MySQL</span> <span class="string">Master</span> <span class="string">failover</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">succeeded</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Date:</span> <span class="string">Mon,</span> <span class="number">24</span> <span class="string">Jul</span> <span class="number">2017</span> <span class="number">16</span><span class="string">:27:15</span> <span class="string">+0800</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">X-Mailer:</span> <span class="string">Perl</span> <span class="string">script</span> <span class="string">"send_report"</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span>      <span class="string">using</span> <span class="attr">Mail::Sender</span> <span class="number">0.8</span><span class="number">.16</span> <span class="string">by</span> <span class="string">Jenda</span> <span class="string">Krynicky,</span> <span class="string">Czechlands</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span>      <span class="string">running</span> <span class="string">on</span> <span class="string">slave</span> <span class="string">()</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span>      <span class="string">under</span> <span class="string">account</span> <span class="string">"zhouting"</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Message-ID:</span> <span class="string">&lt;20170724_082715_056339.dwj568588@126.com&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">MIME-Version:</span> <span class="number">1.0</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Content-type:</span> <span class="string">text/plain;</span> <span class="string">charset=utf-8</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Master</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">is</span> <span class="string">down!</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Check</span> <span class="string">MHA</span> <span class="string">Manager</span> <span class="string">logs</span> <span class="string">at</span> <span class="attr">slave:/var/log/masterha/app1/manager.log</span> <span class="string">for</span> <span class="string">details.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Started</span> <span class="string">automated(non-interactive)</span> <span class="string">failover.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Invalidated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address</span> <span class="string">on</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Selected</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">as</span> <span class="string">a</span> <span class="string">new</span> <span class="string">master.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Applying</span> <span class="string">all</span> <span class="string">logs</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Activated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="string">Resetting</span> <span class="string">slave</span> <span class="string">info</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Master</span> <span class="string">failover</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">completed</span> <span class="string">successfully.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="string">Mail</span> <span class="string">OK</span> <span class="string">queued</span> <span class="string">as</span> <span class="string">smtp1,C8mowAAH7yZhr3VZFR+JCA--.54250S2</span> <span class="number">1500884834</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">QUIT</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">221</span> <span class="string">Bye</span></span></span><br><span class="line"><span class="yaml"><span class="string">[root@slave</span> <span class="string">app1]#</span></span></span><br></pre></td></tr></table></figure></p><h3 id="日志过程解析"><a href="#日志过程解析" class="headerlink" title="日志过程解析"></a>日志过程解析</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">启动前的准备工作</span><br><span class="line">检查数据库服务器状态,获取相关参数设置</span><br><span class="line">检查GTID、candidate_master、过滤DB是否设置</span><br><span class="line">测试ssh连接是否成功</span><br><span class="line">测试MHA <span class="keyword">node</span><span class="title">是否可用</span></span><br><span class="line"><span class="title">创建MHA</span>日志目录</span><br><span class="line">开始检查<span class="literal">slave</span>的差异日志应用权限</span><br><span class="line">确定当前的复制架构</span><br><span class="line">调试master_ip_failover_script</span><br><span class="line">调试shutdown_script</span><br><span class="line">设置二次检查的主机masterha_secondary_check</span><br><span class="line">MHA启动完毕,进入监测状态</span><br><span class="line">监测<span class="literal">master</span>服务器挂了</span><br><span class="line">通过定义的二次监测,确认<span class="literal">master</span>是否挂了</span><br><span class="line">确认<span class="literal">master</span>挂了,开始进入failover流程</span><br><span class="line">再试尝试连接<span class="literal">master</span>和<span class="literal">master</span>的ssh</span><br><span class="line">通过MHA配置文件,监测其他<span class="literal">slave</span>的状态</span><br><span class="line">再次监测<span class="literal">slave</span>的配置是否有变化,是否符合failover条件</span><br><span class="line">正式开始failover</span><br><span class="line">再次对<span class="literal">slave</span>配置做检查</span><br><span class="line">对原<span class="literal">Master</span>做master_ip_failover_script和shutdown_script的操作</span><br><span class="line">开始差异日志的恢复，获取<span class="literal">slave</span>最后得到的binlog位置</span><br><span class="line">获取原<span class="literal">master</span>的binlog日志</span><br><span class="line">确定新的<span class="literal">master</span></span><br><span class="line">在new <span class="literal">master</span>上应用差异的binlog日志</span><br><span class="line">获取new <span class="literal">master</span>的binlog位置。</span><br><span class="line">执行master_ip_failover_script,调用aws_vip_change.sh，执行VIP漂移</span><br><span class="line">开始恢复其他<span class="literal">slave</span>的差异日志</span><br><span class="line">差异日志应用完成以后,切换所有<span class="literal">slave</span>到new <span class="literal">master</span>。</span><br><span class="line">failover操作完成,生成failover报告</span><br><span class="line">最后发送邮件通知</span><br></pre></td></tr></table></figure><h3 id="确认FailOver状态"><a href="#确认FailOver状态" class="headerlink" title="确认FailOver状态"></a>确认FailOver状态</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@slave app1]</span># <span class="selector-tag">ifconfig</span>             <span class="selector-id">#vip</span>已经添加到从库上</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:FB</span><span class="selector-pseudo">:F1</span><span class="selector-pseudo">:E9</span><span class="selector-pseudo">:4E</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.9.182</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::e</span><span class="selector-pseudo">:fbff</span><span class="selector-pseudo">:fef1</span><span class="selector-pseudo">:e94e</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:17060</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:17883</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:2142676</span> (<span class="number">2.0</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:2390595</span> (<span class="number">2.2</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth1</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:25</span><span class="selector-pseudo">:83</span><span class="selector-pseudo">:A0</span><span class="selector-pseudo">:22</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.0.200</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::12</span><span class="selector-pseudo">:25ff</span><span class="selector-pseudo">:fe83</span><span class="selector-pseudo">:a022</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:18</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:798</span> (<span class="number">798.0</span> b)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1828</span> (<span class="number">1.7</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-pseudo">::1</span>/<span class="selector-tag">128</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Host</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:2789</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:2789</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:669913</span> (<span class="number">654.2</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:669913</span> (<span class="number">654.2</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@slave app1]</span>#</span><br></pre></td></tr></table></figure><h3 id="查看邮件发送状态"><a href="#查看邮件发送状态" class="headerlink" title="查看邮件发送状态"></a>查看邮件发送状态</h3><p>登录邮件，查看是否收到报警邮件。<br><img src="http://note.youdao.com/yws/public/resource/bba80193f9c2d29f073784f4e498b134/xmlnote/0A43FC640BD84154ADCD175F765F82E1/33468" alt="image">  </p><h3 id="手动FailOver"><a href="#手动FailOver" class="headerlink" title="手动FailOver"></a>手动FailOver</h3><p>MHA的手动FailOver不在本文范围，详情理论可参考官方文档。  </p><h3 id="参数列表"><a href="#参数列表" class="headerlink" title="参数列表"></a>参数列表</h3><table><thead><tr><th>参数名</th><th>是否必须</th><th>参数使用域</th><th>默认值</th><th>例子</th></tr></thead><tbody><tr><td>hostname</td><td>Yes</td><td>Local Only</td><td>-</td><td>hostname=master,hostname=slave</td></tr><tr><td>ip</td><td>No</td><td>Local Only</td><td>gethostbyname($hostname)</td><td>ip=192.168.1.100</td></tr><tr><td>port</td><td>No</td><td>Local/App/Global</td><td>3306</td><td>port=3306</td></tr><tr><td>ssh_host</td><td>No</td><td>Local Only</td><td>same as hostname</td><td>ssh_host=master,ssh_host=slave</td></tr><tr><td>ssh_ip</td><td>No</td><td>Local Only</td><td>gethostbyname($ssh_host)</td><td>ssh_ip=192.168.1.101</td></tr><tr><td>ssh_port</td><td>No</td><td>Local/App/Global</td><td>22</td><td>ssh_port=22</td></tr><tr><td>ssh_connection_timeout</td><td>No</td><td>Local/App/Global</td><td>5</td><td>ssh_connection_timeout=20</td></tr><tr><td>ssh_options</td><td>No</td><td>Local/App/Global</td><td>“”(empty string)</td><td>ssh_options=”-i /root/.ssh/id_dsa2”</td></tr><tr><td>candidate_master</td><td>No</td><td>Local Only</td><td>0</td><td>candidate_master=1</td></tr><tr><td>no_master</td><td>No</td><td>Local Only</td><td>0</td><td>no_master=1</td></tr><tr><td>ignore_fail</td><td>No</td><td>Local Only</td><td>0</td><td>ignore_fail=1</td></tr><tr><td>skip_init_ssh_check</td><td>No</td><td>Local Only</td><td>0</td><td>skip_init_ssh_check=1</td></tr><tr><td>skip_reset_slave</td><td>No</td><td>Local/App/Global</td><td>0</td><td>skip_reset_slave=1</td></tr><tr><td>user</td><td>No</td><td>Local/App/Global</td><td>root</td><td>user=root</td></tr><tr><td>password</td><td>No</td><td>Local/App/Global</td><td>“”(empty string)</td><td>password=rootpass</td></tr><tr><td>repl_user</td><td>No</td><td>Local/App/Global</td><td>Master_User value from SHOW SLAVE STATUS</td><td>repl_user=repl</td></tr><tr><td>repl_password</td><td>No</td><td>Local/App/Global</td><td>(current replication password)</td><td>repl_user=replpass</td></tr><tr><td>disable_log_bin</td><td>No</td><td>Local/App/Global</td><td>0</td><td>disable_log_bin=1</td></tr><tr><td>master_pid_file</td><td>No</td><td>Local/App/Global</td><td>“”(empty string)</td><td>master_pid_file=/var/lib/mysql/master1.pid</td></tr><tr><td>ssh_user</td><td>No</td><td>Local/App/Global</td><td>current OS user</td><td>ssh_user=root</td></tr><tr><td>remote_workdir</td><td>No</td><td>Local/App/Global</td><td>/var/tmp</td><td>remote_workdir=/var/log/masterha/app1</td></tr><tr><td>master_binlog_dir</td><td>No</td><td>Local/App/Global</td><td>/var/lib/mysql</td><td>master_binlog_dir=/data/mysql1</td></tr><tr><td>log_level</td><td>No</td><td>App/Global</td><td>info</td><td>log_level=debug</td></tr><tr><td>manager_workdir</td><td>No</td><td>App</td><td>/var/tmp</td><td>manager_workdir=/var/log/masterha</td></tr><tr><td>client_bindir</td><td>No</td><td>App</td><td>-</td><td>client_bindir=/usr/mysql/bin</td></tr><tr><td>client_libdir</td><td>No</td><td>App</td><td>-</td><td>client_libdir=/usr/lib/mysql</td></tr><tr><td>manager_log</td><td>No</td><td>App</td><td>STDERR</td><td>manager_log=/var/log/masterha/app1.log</td></tr><tr><td>check_repl_delay</td><td>No</td><td>App/Global</td><td>1</td><td>check_repl_delay=0</td></tr><tr><td>check_repl_filter</td><td>No</td><td>App/Global</td><td>1</td><td>check_repl_filter=0</td></tr><tr><td>latest_priority</td><td>No</td><td>App/Global</td><td>1</td><td>latest_priority=0</td></tr><tr><td>multi_tier_slave</td><td>No</td><td>App/Global</td><td>0</td><td>multi_tier_slave=1</td></tr><tr><td>ping_interval</td><td>No</td><td>App/Global</td><td>3</td><td>ping_interval=5</td></tr><tr><td>ping_type</td><td>No</td><td>App/Global</td><td>SELECT</td><td>ping_type=CONNECT</td></tr><tr><td>secondary_check_script</td><td>No</td><td>App/Global</td><td>null</td><td>secondary_check_script= masterha_secondary_check -s remote_dc1 -s remote_dc2</td></tr><tr><td>master_ip_failover_script</td><td>No</td><td>App/Global</td><td>null</td><td>master_ip_failover_script=/usr/local/bin/master_ip_failover</td></tr><tr><td>master_ip_online_change_script</td><td>No</td><td>App/Global</td><td>null</td><td>master_ip_online_change_script= /usr/local/bin/master_ip_online_change</td></tr><tr><td>shutdown_script</td><td>No</td><td>App/Global</td><td>null</td><td>shutdown_script= /usr/local/bin/master_shutdown</td></tr><tr><td>report_script</td><td>No</td><td>App/Global</td><td>null</td><td>report_script= /usr/local/bin/report</td></tr></tbody></table><h4 id="详情解释"><a href="#详情解释" class="headerlink" title="详情解释"></a>详情解释</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">Local Scope:        针对每个server级别有效的选项.local scope级别的参数需要在配置文件的 [server_xxx]段落配置  </span><br><span class="line">App Scope:          这个参数可以理解为针对一组master-slave集群. 这些参数需要在 [server_default]段落配置  </span><br><span class="line">Global Scope:       这个参数针对所有的MHA管理的实例. global scope级别的配置只有你在使用一个manager server管理多组master-slave时使用 </span><br><span class="line">hostname：          目标Mysql服务器的主机名或者IP地址,这个参数是强制的,并且必须配置在[server_xxx]段落</span><br><span class="line">ip：                目标Mysql服务器的IP地址,默认是通过$hostname变量获取.MHA manager和MHA Node</span><br><span class="line">                    内部使用这个IP地址链接到Mysql和SSH.通常你不需要配置这个参数,因为它可以通过$hostname解析获得</span><br><span class="line">port：              mysql服务器使用的端口号,默认是3306,MHA链接到mysql通过IP地址和端口</span><br><span class="line">ssh_host：          从0.53版本开始支持此参数,此参数的主要目的在于你mysql复制使用的IP地址由于安全策略,不能直接连接,</span><br><span class="line">                    所以需要通过其他IP和端口连接到mysql server或者ssh,默认这个参数和hostname的值相同</span><br><span class="line">ssh_ip：            从0.53版本开始支持此参数,连接到目标mysql server的ssh ip地址,默认从$ssh_host获取</span><br><span class="line">ssh_port：          从0.53版本开始支持此参数,连接到目标mysql server的ssh端口,默认是22</span><br><span class="line">ssh_connection_timeout：从0.54开始支持此参数,默认是5秒,添加此参数的原因是以前我们在程序里面写死了</span><br><span class="line">ssh_options：       从0.53开始支持此参数,可以添加SSH命令行的参数</span><br><span class="line">candidate_master：  </span><br><span class="line">你的slave的硬件配置或者用途可能不太一样,你想要提升更加可靠的slave作为新的master</span><br><span class="line">如果设置candidate_master的值为1,那么这个server会优先成为master,只要它满足成为master的条件(binlog开启的,没有严重的复制延时等)</span><br><span class="line">所以意味着配置了candiate_master=1的服务器并不是肯定可以成为new master,但是这个参数能够帮助提高优先级</span><br><span class="line">如果你在多个服务器上设置了candidate_master=1,那么在配置文件中[server_xxx]的配置顺序,会成为第二排序规则,排在上面的越优先</span><br><span class="line">no_master：         no_master=1是默认值,意思是这个server从来不会成为新的master,这个参数用来标记某些从来不用成为new master的服务器</span><br><span class="line">ignore_fail：       </span><br><span class="line">默认是0,当某个slave的ssh或者mysql当掉或者复制失败的时候,MHA manager不启动failover。</span><br><span class="line">但是有些环境下,你想要在某个特定的slave失败的时候继续执行failover,把么就设置这个ignore_fail=1,即时这个slave失败的时候,failover依然继续执行</span><br><span class="line">skip_init_ssh_check：启动的时候跳过ssh连接测试</span><br><span class="line">skip_reset_slave：  从0.56版本开始支持此参数,在master执行failover以后跳过执行<span class="keyword">reset</span> <span class="keyword">slave</span> all(译者感觉应该是方便MM复制的后期恢复)</span><br><span class="line"><span class="keyword">user</span>：              mysql管理员命令,建议赋予all <span class="keyword">privileges</span>权限</span><br><span class="line"><span class="keyword">password</span>：          上面mysql <span class="keyword">user</span>的密码</span><br><span class="line">repl_user：         mysql复制使用的用户名,需要执行<span class="keyword">change</span> <span class="keyword">master</span> <span class="keyword">to</span>命令和<span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>命令等.一般赋予<span class="keyword">replication</span> <span class="keyword">slave</span>,<span class="keyword">replication</span> <span class="keyword">client</span>权限</span><br><span class="line">repl_password：     上面用户对应的密码.默认情况下,使用的是当前复制的密码</span><br><span class="line">disable_log_bin：   当这个参数设置以后,当应用差异日志到<span class="keyword">slave</span>的时候,<span class="keyword">slave</span>不会生成binlog. Internally MHA passes <span class="comment">--disable-log-bin to mysqlbinlog command</span></span><br><span class="line">master_pid_file：   设置<span class="keyword">master</span>的pid文件位置,当你的服务器上运行了多个mysql的时候使用</span><br><span class="line">ssh_user：          </span><br><span class="line">MHA manager和MHA node通过这个用户连接到mysql <span class="keyword">server</span>的OS上,在对应的OS上执行相关命令和拷贝差异日志等等</span><br><span class="line">这个用户必须有读取mysql <span class="built_in">binary</span>/relay 相关日志文件的权限,还有日志目录的写入权限.(remote_workdir目录)</span><br><span class="line">这个用户必须可以直接连接到服务器上,不用任何交互的操作.通过使用ssh <span class="keyword">public</span> <span class="keyword">key</span>作为认证方式.默认使用的用户是manager当前的用户</span><br><span class="line">remote_workdir：    </span><br><span class="line">每个MHA node上,MHA工作使用的目录的绝对路径.如果目录不存在,MHA会自动创建,如果权限不够,那么MHA node会意外终止,</span><br><span class="line">注意MHA manager和MHA node都不会检查这个目录的磁盘可用空间,你需要自己保证有足够的可用空间.默认的remote_workdir是<span class="string">'/var/tmp'</span></span><br><span class="line">master_binlog_dir： </span><br><span class="line"><span class="keyword">master</span> mysql保存<span class="keyword">binlog</span>的目录的绝对路径.如果参数的主要目的是在<span class="keyword">master</span> mysql宕机以后,为了通过ssh拷贝需要的<span class="keyword">binlog</span> <span class="keyword">event</span></span><br><span class="line">这个参数是需要的,因为当mysql宕机以后,没法自动获取<span class="built_in">binary</span> <span class="keyword">log</span>的目录</span><br><span class="line">默认情况下,master_binlog_dir的值是<span class="string">"/var/lib/mysql/,/var/log/mysql/"</span>,/<span class="keyword">var</span>/lib/mysql/是大部分mysql发布版本的默认mysql输出目录,</span><br><span class="line">你可以设置多个目录,使用逗号分隔.比如(/data1,/data2,/data3)</span><br><span class="line">log_level：         MHA manager 的日志级别,默认是info级别,在大多数环境下没有问题.可用的级别有.debug/info/<span class="keyword">warning</span>/<span class="keyword">error</span></span><br><span class="line">manager_workdir：   MHA manager使用的工作目录,如果没有设置,默认使用/<span class="keyword">var</span>/tmp</span><br><span class="line">client_bindir：     如果mysql命令行工具没有安装在默认目录,可以使用这个选项配置</span><br><span class="line">client_libdir：     如果mysql lib没有安装在默认目录,可以使用这个选项配置</span><br><span class="line">manager_log：       MHA manager日志文件的绝对目录和文件名,如果没有设置,那么将直接打印到标准输出和标准错误输出</span><br><span class="line">当执行交互式的<span class="keyword">failover</span>时,MHA manager将会忽略manager_log设置,直接答应到标准输出和标准错误输出</span><br><span class="line">check_repl_delay：  </span><br><span class="line">默认情况下如果一个<span class="keyword">slave</span>比<span class="keyword">master</span>延时了<span class="number">100</span>M的relay logs.MHA不会选择这个<span class="keyword">slave</span>作为新的master.因为他需要更多的时间来<span class="keyword">recovery</span></span><br><span class="line">设置check_repl_delay=<span class="number">0</span>,MHA在选择<span class="keyword">new</span> <span class="keyword">master</span>时将会忽略复制的延时.这个参数通常和candidate_master=<span class="number">1</span>同时使用</span><br><span class="line">check_repl_filter： </span><br><span class="line">默认情况下如果<span class="keyword">master</span>和<span class="keyword">slave</span>有不同的<span class="built_in">binary</span> <span class="keyword">log</span>/<span class="keyword">replication</span> 过滤规则的话,MHA打印错误,不进行<span class="keyword">start</span> <span class="keyword">monitoring</span>或者<span class="keyword">failover</span></span><br><span class="line">这么做的目的是为了避免<span class="keyword">recover</span>的时候出现意外的错误,例如<span class="string">"Table not exists"</span>,如果你<span class="number">100</span>%确定你不同的过滤规则不会导致<span class="keyword">recover</span>时候报错,</span><br><span class="line">那么你可以设置check_repl_fiter=<span class="number">0</span>,这样的话,MHA在应用差异日志的时候将不会在检查过滤规则.使用这个参数的时候需要非常小心</span><br><span class="line">latest_priority：   默认情况下,接收到了最新的<span class="keyword">binlog</span>的<span class="keyword">slave</span>优先被选为<span class="keyword">new</span> <span class="keyword">master</span>,如果你想要控制优先级的顺序,比如(host2&gt;host3&gt;host4),那么设置latest_priority=<span class="number">0</span>会有所帮助</span><br><span class="line">multi_tier_slave：  </span><br><span class="line">MHA manager从<span class="number">0.5</span><span class="number">.2</span>开始支持多主复制.默认情况下,它不支持三层以上的复制架构.例如,host2是host1的<span class="keyword">slave</span>,host3是host2的<span class="keyword">slave</span>,</span><br><span class="line">默认不允许把这个三个主机写到同一个配置文件中因为这是一个三层的复制架构,并且MHA会因此报错,并停止工作.如果设置了multi_tier_slave,</span><br><span class="line">MHA manager不会因为多层架构而终止,它会忽略三层及以上的主机,例如<span class="keyword">master</span>(host1)挂掉以后,host2会被选为新的<span class="keyword">master</span>,host3将继续从host2复制</span><br><span class="line">ping_interval：     </span><br><span class="line">这个参数声明MHA manager pings(通过执行<span class="keyword">sql</span>来ping) <span class="keyword">master</span>的间隔.当连续三次ping失败,MHA manager认为这个Mysql <span class="keyword">master</span>宕机,从宕机到检测到宕机,</span><br><span class="line">最大的消耗时间是这个参数的四倍,这个参数默认值是<span class="number">3</span>(<span class="number">3</span>秒),如果MHA manager因为权限问题多次连接失败,这不认为<span class="keyword">master</span> dead</span><br><span class="line">ping_type：</span><br><span class="line">从MHA manager <span class="number">0.53</span>开始支持这个参数, MHA建立一个长连接到<span class="keyword">master</span>,然后通过执行<span class="string">"SELECT 1"</span> (ping_type=<span class="keyword">SELECT</span>)来判断<span class="keyword">master</span>是否可用</span><br><span class="line">但是在一些环境下,最好使用短连接的方式,因为这样的方式更严格,也能检测TCP连接级别的失败.设置ping_type=<span class="keyword">CONNECT</span>可以实现.从<span class="number">0.56</span>版本开始,支持ping_type=<span class="keyword">INSERT</span></span><br><span class="line">secondary_check_script：</span><br><span class="line">通常情况,强力推荐使用两个或者多个路由检测Mysql <span class="keyword">master</span>默认MHA通过一个路由检测:从manager到master.这是不推荐的</span><br><span class="line">MHA manager可以通过secondary_check_script参数调用一个内部脚本来实现两个或者多个路由的检测.下面是一个配置实例</span><br><span class="line">secondary_check_script = masterha_secondary_check -s remote_host1 -s remote_host2</span><br><span class="line">MHA manager包含masterha_secondary_check 脚本.内置的masterha_secondary_check脚本可以满足大多是环境,当然你也可以调用你自定义的脚本.</span><br><span class="line">在上面的实例中,MHA manager通过这两个路由检测<span class="keyword">master</span>主机</span><br><span class="line">Manager-(A)-&gt;remote_host1-(B)-&gt;master_host</span><br><span class="line">Manager-(A)-&gt;remote_host2-(B)-&gt;master_host</span><br><span class="line">如果两条路径中,A都是成功的,B都是不成功的,那么masterha_secondary_check将会退出,返回状态<span class="number">0.</span>MHA manager将会认为Mysql <span class="keyword">master</span>宕机,开始<span class="keyword">failover</span></span><br><span class="line">如果A失败,那么masterha_secondary_check将退出,返回状态<span class="number">2</span>,MHA manager网络出现问题,不会开始<span class="keyword">failover</span></span><br><span class="line">如果B检测成功,masterha_secondary_check退出并返回状态<span class="number">3</span>,MHA manager明确的知道mysql <span class="keyword">master</span>是活跃的,不开始<span class="keyword">failover</span></span><br><span class="line">通常来讲,remote_host1和remote_host2必须和 MHA manager及Mysql <span class="keyword">server</span>不在同一个网段,这样才更有意义</span><br><span class="line">MHA调用secondary_check_script参数对应的脚本会自动传递以下参数(所以你不需要在配置文件中设置),</span><br><span class="line">masterha_secondary_check适用于大多数环境,如果你需要其他的功能可以自己写一个网络检查的脚本.</span><br><span class="line"><span class="comment">--user=(SSH username of the remote hosts. ssh_user parameter value will be passed)</span></span><br><span class="line"><span class="comment">--master_host=(master's hostname)</span></span><br><span class="line"><span class="comment">--master_ip=(master's ip address)</span></span><br><span class="line"><span class="comment">--master_port=(master's port number)</span></span><br><span class="line">注意:</span><br><span class="line">masterha_secondary_check脚本依赖于IO::Socket::INET perl包,在perl v5<span class="number">.6</span><span class="number">.0</span>中默认包含,masterha_secondary_check脚本会通过</span><br><span class="line">ssh连接到所有的remote servers.所以SSH <span class="keyword">public</span> <span class="keyword">key</span> 认证需要设置.另外masterha_secondary_check脚本尝试使用TCP连接从remote <span class="keyword">server</span>到mysql master.这意味着服务器设置的max_connections参数对此连接无效,并且如果TCP连接成功,Aborted_connects状态将会加<span class="number">1</span></span><br><span class="line">master_ip_failover_script：</span><br><span class="line">常见的HA环境下,大多是情况会给<span class="keyword">master</span>分配一个虚拟IP,如果<span class="keyword">master</span>宕机,HA软件像一个Pacemaker将虚拟IP转移到备用的<span class="keyword">master</span>上</span><br><span class="line">另外一种常见的方法就是创建一个全局目录数据库,包含所有应用和writer/reader ip地址.例如&#123;app_master1,<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>&#125;,&#123;app_master2,<span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span>&#125;...,代替使用虚拟IP,</span><br><span class="line">这种情况,你需要在<span class="keyword">master</span>宕机的时候更新目录数据库</span><br><span class="line">两种方法都有好的或者不好的地方,MHA不强制要求使用哪一种,但是提供了master_ip_failover_script参数来完成此目的</span><br><span class="line">换句话说,你需要写一个脚本来调整应用服务连接到新的<span class="keyword">master</span>,然后定义master_ip_failover_script的参数,下面是一个实例</span><br><span class="line">master_ip_failover_script= /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/master_ip_failover</span><br><span class="line">你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/master_ip_failover找到一个简单的脚本.这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">MHA manager会调用master_ip_failover_script三次,</span><br><span class="line">第一次,在开始<span class="keyword">master</span> monitor之前调用(目的是检查脚本是否可用),</span><br><span class="line">第二次是在调用shutdown_script脚本前调用,</span><br><span class="line">第三次是在<span class="keyword">new</span> <span class="keyword">master</span>应用完所有的差异日志以后,MHA manager会传递给脚本如下参数.(你不用在配置文件中指明这些参数)</span><br><span class="line">Checking phase</span><br><span class="line"><span class="comment">--command=status</span></span><br><span class="line"><span class="comment">--ssh_user=(current master's ssh username)</span></span><br><span class="line"><span class="comment">--orig_master_host=(current master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(current master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(current master's port number)</span></span><br><span class="line"><span class="keyword">Current</span> <span class="keyword">master</span> <span class="keyword">shutdown</span> phase</span><br><span class="line"><span class="comment">--command=stop or stopssh</span></span><br><span class="line"><span class="comment">--ssh_user=(dead master's ssh username, if reachable via ssh)</span></span><br><span class="line"><span class="comment">--orig_master_host=(current(dead) master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(current(dead) master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(current(dead) master's port number)</span></span><br><span class="line"><span class="keyword">New</span> <span class="keyword">master</span> activation phase</span><br><span class="line"><span class="comment">--command=start</span></span><br><span class="line"><span class="comment">--ssh_user=(new master's ssh username)</span></span><br><span class="line"><span class="comment">--orig_master_host=(dead master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(dead master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(dead master's port number)</span></span><br><span class="line"><span class="comment">--new_master_host=(new master's hostname)</span></span><br><span class="line"><span class="comment">--new_master_ip=(new master's ip address)</span></span><br><span class="line"><span class="comment">--new_master_port(new master's port number)</span></span><br><span class="line"><span class="comment">--new_master_user=(new master's user)</span></span><br><span class="line"><span class="comment">--new_master_password(new master's password)</span></span><br><span class="line">如果你使用共享虚拟IP的方法,你不需要在<span class="keyword">master</span> <span class="keyword">shutdown</span>阶段做任何事情,只要通过shutdown_script脚本关掉原来<span class="keyword">master</span>的电源,在激活<span class="keyword">new</span> <span class="keyword">master</span>阶段,</span><br><span class="line">你需要分配虚拟IP给<span class="keyword">new</span> master.如果你使用目录数据库的方法,你需要在宕机的<span class="keyword">master</span> <span class="keyword">shutdown</span>阶段删除或者更新失效<span class="keyword">master</span>的记录</span><br><span class="line">在<span class="keyword">new</span> <span class="keyword">master</span>生效阶段需要插入或者更新<span class="keyword">new</span> <span class="keyword">master</span>的记录.另外你可以做任何事情来保证应用程序可以成功的写入<span class="keyword">new</span> <span class="keyword">master</span></span><br><span class="line">比如<span class="keyword">SET</span> <span class="keyword">GLOBAL</span> read_only=<span class="number">0</span>，创建有写入权限的数据库用户等等</span><br><span class="line">MHA manager检查脚本的退出状态,如果脚本退出状态是<span class="number">0</span>或者<span class="number">10</span>,MHA manager继续操作,如果脚本退出状态不是<span class="number">0</span>或者<span class="number">10</span>,MHA manager将会意外终止,并不继续continue failover.默认这个参数是空的</span><br><span class="line">master_ip_online_change_script：</span><br><span class="line">这是几个简单版本的master_ip_failover_script参数,但是<span class="keyword">master</span> <span class="keyword">failover</span>命令并不调用它.master <span class="keyword">online</span> <span class="keyword">change</span>命令会调用它.(masterha_master_switch <span class="comment">--master_state=alive),传递以下参数</span></span><br><span class="line"><span class="keyword">Current</span> <span class="keyword">master</span> write freezing phase</span><br><span class="line"><span class="comment">--command=stop or stopssh</span></span><br><span class="line"><span class="comment">--orig_master_host=(current master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(current master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(current master's port number)</span></span><br><span class="line"><span class="comment">--orig_master_user=(current master's user)</span></span><br><span class="line"><span class="comment">--orig_master_password=(current master's password)</span></span><br><span class="line"><span class="comment">--orig_master_ssh_user=(from 0.56, current master's ssh user)</span></span><br><span class="line"><span class="comment">--orig_master_is_new_slave=(from 0.56, notifying whether the orig master will be new slave or not)</span></span><br><span class="line"><span class="keyword">New</span> <span class="keyword">master</span> granting write phase</span><br><span class="line"><span class="comment">--command=start</span></span><br><span class="line"><span class="comment">--orig_master_host=(orig master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(orig master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(orig master's port number)</span></span><br><span class="line"><span class="comment">--new_master_host=(new master's hostname)</span></span><br><span class="line"><span class="comment">--new_master_ip=(new master's ip address)</span></span><br><span class="line"><span class="comment">--new_master_port(new master's port number)</span></span><br><span class="line"><span class="comment">--new_master_user=(new master's user)</span></span><br><span class="line"><span class="comment">--new_master_password=(new master's password)</span></span><br><span class="line"><span class="comment">--new_master_ssh_user=(from 0.56, new master's ssh user)</span></span><br><span class="line">MHA在当前的<span class="keyword">master</span> write freezing阶段后执行FLUASH <span class="keyword">TABLES</span> <span class="keyword">WITH</span> <span class="keyword">READ</span> <span class="keyword">LOCK</span>, 在<span class="keyword">new</span> mastergranting write阶段你可以执行一些类似master_ip_failover_script的操作</span><br><span class="line">比如创建一个有写入权限的用户,执行<span class="keyword">SET</span> <span class="keyword">GLOBAL</span> read_only=<span class="number">0</span>,更新目录数据库等.如果你的脚本退出返回状态不是<span class="number">1</span>或者<span class="number">10</span>,那么MHA manager将会意外终止,</span><br><span class="line">停止<span class="keyword">master</span> <span class="keyword">switch</span>这个参数默认为空,所以MHA manager不做任何调用你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/master_ip_online_change找到一个简单的脚本</span><br><span class="line">这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">shutdown_script：</span><br><span class="line">你可能需要强制关闭<span class="keyword">master</span>服务器,避免他再次提供服务,这对于避免脑裂很重要.下面是一个实例</span><br><span class="line">shutdown_script= /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/power_manager</span><br><span class="line">你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/power_manager找到一个简单的脚本.这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">在调用shutdown_script脚本之前,MHA manager内部会通过ssh尝试连接到mysql <span class="keyword">master</span>,如果ssh可以连接(意思就是OS是存活的,但是Mysqld没有运行),MHAmanager就会传递下面的参数</span><br><span class="line"><span class="comment">--command=stopssh (这个意思就是指停止服务,不会关机)</span></span><br><span class="line"><span class="comment">--ssh_user=(ssh username so that you can connect to the master)</span></span><br><span class="line"><span class="comment">--host=(master's hostname)</span></span><br><span class="line"><span class="comment">--ip=(master's ip address)</span></span><br><span class="line"><span class="comment">--port=(master's port number)</span></span><br><span class="line"><span class="comment">--pid_file=(master's pid file)</span></span><br><span class="line">如果<span class="keyword">master</span>主机的ssh不能连接,那么MHA会使用如下参数</span><br><span class="line"><span class="comment">--command=stop (这个会通过fence设备关掉电源)</span></span><br><span class="line"><span class="comment">--host=(master's hostname)</span></span><br><span class="line"><span class="comment">--ip=(master's ip address)</span></span><br><span class="line">这个脚本的大概功能如下,如果<span class="comment">--command=stopssh被调用,脚本会使用killall -9 杀掉目标服务器上所有的mysqld_safe服务</span></span><br><span class="line">如果<span class="comment">--pid_file被设置,脚本尝试kill指定的进程.如果脚本执行成功,那么脚本会退出返回状态10.如果退出状态为10,</span></span><br><span class="line">MHA manager后面会通过ssh连接到<span class="keyword">master</span>,获取需要的<span class="built_in">binary</span> log.如果脚本通过ssh连接到服务器失败,那么就会传递<span class="comment">--command=stop参数,这个参数尝试关闭机器的电源,</span></span><br><span class="line">关闭电源依赖于H/W.HP(ILO),DELL(DRAC).如果<span class="keyword">power</span> <span class="keyword">off</span>成功,脚本会然会状态<span class="number">0</span>,其他情况会返回状态<span class="number">1.</span>当返回状态是<span class="number">0</span>的时候MHA manager </span><br><span class="line">开始failover.如果返回状态不是<span class="number">0</span>或者<span class="number">10</span>,那么MHA manager会意外终止.这个参数默认是空,所以MHA manager不会调用任何脚本</span><br><span class="line">另外,MHA manager在启动<span class="keyword">monitoring</span>之前调用shutdown_script.这时候会传递下面的参数.目的是检测脚本是否可用,如果发现错误,你可以提前知道</span><br><span class="line"><span class="comment">--command=status</span></span><br><span class="line"><span class="comment">--host=(master's hostname)</span></span><br><span class="line"><span class="comment">--ip=(master's ip address)</span></span><br><span class="line">report_script：</span><br><span class="line">你希望当<span class="keyword">failover</span>发生以后可以发送一个报告(例如email),report_script可以达到这个目的,MHA manager传递下面的参数</span><br><span class="line"><span class="comment">--orig_master_host=(dead master's hostname)</span></span><br><span class="line"><span class="comment">--new_master_host=(new master's hostname)</span></span><br><span class="line"><span class="comment">--new_slave_hosts=(new slaves' hostnames, delimited by commas)</span></span><br><span class="line"><span class="comment">--subject=(mail subject)</span></span><br><span class="line"><span class="comment">--body=(body)</span></span><br><span class="line">默认这个参数是空的,所以MHA manager不调用任何脚本，你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/send_report找到一个简单的脚本</span><br><span class="line">这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">init_conf_load_script：</span><br><span class="line">这个脚本可以在你不想在配置文件中写明文密码的时候使用.你可以覆盖全局配置参数.实例脚本如下</span><br><span class="line">#!/usr/<span class="keyword">bin</span>/perl</span><br><span class="line">print <span class="string">"password=$ROOT_PASS\n"</span>;</span><br><span class="line">print "repl_password=$REPL_PASS\n";</span><br><span class="line">这个参数默认为空,所以MHA manager默认不调用任何脚本</span><br></pre></td></tr></table></figure><h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>MySQL Master High Available 理论篇：<br><a href="https://yq.aliyun.com/articles/58004?spm=5176.100239.blogcont57855.9.jUuCt0" target="_blank" rel="noopener">https://yq.aliyun.com/articles/58004?spm=5176.100239.blogcont57855.9.jUuCt0</a></p><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>云服务器上MySQL高可用，也可通过云负载均衡产品+MySQL复制来实现，但在数据安全性上，没有MHA+VIP+MySQL相对安全。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了
      
    
    </summary>
    
      <category term="集群高可用" scheme="https://dwj999.github.io/categories/%E9%9B%86%E7%BE%A4%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    
    
      <category term="MySQL" scheme="https://dwj999.github.io/tags/MySQL/"/>
    
      <category term="AWS" scheme="https://dwj999.github.io/tags/AWS/"/>
    
      <category term="EC2" scheme="https://dwj999.github.io/tags/EC2/"/>
    
      <category term="VIP" scheme="https://dwj999.github.io/tags/VIP/"/>
    
      <category term="MHA" scheme="https://dwj999.github.io/tags/MHA/"/>
    
  </entry>
  
  <entry>
    <title>MongoDB从MMAPv1在线迁移至WiredTiger引擎</title>
    <link href="https://dwj999.github.io/MongoDB%E4%BB%8EMMAPv1%E5%9C%A8%E7%BA%BF%E8%BF%81%E7%A7%BB%E8%87%B3WiredTiger%E5%BC%95%E6%93%8E.html"/>
    <id>https://dwj999.github.io/MongoDB从MMAPv1在线迁移至WiredTiger引擎.html</id>
    <published>2017-07-21T08:33:46.000Z</published>
    <updated>2020-05-20T03:47:15.493Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>MongoDB是一个开源的文档型数据库，介于关系数据库和非关系数据库之间，是非关系数据库中功能最丰富，最像关系数据库的。它支持的数据结构非常松散，是类似json的bson格式，因此可以存储比较复杂的数据类型。Mongo最大的特点是它支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。</p><h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><p>存储引擎是MongoDB的核心组件，负责管理数据如何存储在硬盘和内存上。从MongoDB3.0版本开始，MongoDB支持多数据存储引擎，如WiredTiger，MMAPv1，In-Memory等，每个存储引擎都有自己的优势，percona版本还支持RocksDB引擎。从3.2版本开始，WiredTiger成为了默认的存储引擎，在之前版本MMAPv1为默认存储引擎。这两种引擎在目前的使用量占比最大。</p><h3 id="WiredTiger、MMAPv1对比"><a href="#WiredTiger、MMAPv1对比" class="headerlink" title="WiredTiger、MMAPv1对比"></a>WiredTiger、MMAPv1对比</h3><h4 id="性能、性能"><a href="#性能、性能" class="headerlink" title="性能、性能"></a>性能、性能</h4><p>MMAPv1引擎使用的是表级锁，当单个集合上有并发操作时，吞吐会受限制。<br>Wiredtiger引擎使用文档级锁，通过多版本并发控制，带来并发和吞吐的提高。  </p><h4 id="压缩、加密"><a href="#压缩、加密" class="headerlink" title="压缩、加密"></a>压缩、加密</h4><p>MMAPv1引擎要求数据在内存和在磁盘的形式一致(map磁盘内存映射)，因此不支持压缩和加密。<br>Wiredtiger引擎支持对所有集合和索引进行Block压缩和前缀压缩，可以大大节省存储空间。但是消耗额外的CPU执行数据压缩和解压缩的操作。  </p><h4 id="存储方式"><a href="#存储方式" class="headerlink" title="存储方式"></a>存储方式</h4><p>MMAPv1引擎在数据库级别配置文件，数据库中的所有集合和索引都混合存储在数据库文件中，即使删掉了某个集合或者索引，占用的磁盘空间也很难回收。<br>WiredTiger引擎在集合和索引级别分配文件，数据库中的所有集合和索引都存储在单独的文件中，集合或者索引删除后，磁盘空间方便回收。  </p><h4 id="内存使用"><a href="#内存使用" class="headerlink" title="内存使用"></a>内存使用</h4><p>MMAPv1引擎消耗内存大，无有效控制手段。<br>WiredTiger引擎支持内存使用空间配置，可通过storage.wiredTiger.engineConfig.cacheSizeGB参控制MongoDB所能使用的最大内存。</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：centos 6.5 x86_64</p><h2 id="迁移"><a href="#迁移" class="headerlink" title="迁移"></a>迁移</h2><p>变更存储引擎的常见方式有2种，分别是停机和不停机。本文只介绍在不停机的情况下从MMAPv1引擎副本集迁移至WiredTiger引擎副本集。</p><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>注意：  </p><p><font color="#dd0000">迁移的成功取决于oplog的大小是否能够满足从库完全初始化数据。  </font><br><br>首先安装好mongodb，并依次启动，实例以3.4.4版本为例，端口分别是27017/28017/29017，部署在一台服务器，具体安装步骤省略。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# /usr/local/mongodb1/bin/mongod -f /hwdata/data/mongodb1/conf/mongodb.conf </span><br><span class="line">note: noprealloc may hurt performance <span class="keyword">in</span> many applications</span><br><span class="line">about <span class="keyword">to</span> fork child process, waiting until<span class="built_in"> server </span>is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 14873</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# /usr/local/mongodb2/bin/mongod -f /hwdata/data/mongodb2/conf/mongodb.conf   </span><br><span class="line">note: noprealloc may hurt performance <span class="keyword">in</span> many applications</span><br><span class="line">about <span class="keyword">to</span> fork child process, waiting until<span class="built_in"> server </span>is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 14894</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# /usr/local/mongodb3/bin/mongod -f /hwdata/data/mongodb3/conf/mongodb.conf   </span><br><span class="line">note: noprealloc may hurt performance <span class="keyword">in</span> many applications</span><br><span class="line">about <span class="keyword">to</span> fork child process, waiting until<span class="built_in"> server </span>is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 14919</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# netstat -tunlp|grep mongo</span><br><span class="line">tcp        0      0 0.0.0.0:27017               0.0.0.0:*                   LISTEN      14873/mongod        </span><br><span class="line">tcp        0      0 0.0.0.0:28017               0.0.0.0:*                   LISTEN      14894/mongod        </span><br><span class="line">tcp        0      0 0.0.0.0:29017               0.0.0.0:*                   LISTEN      14919/mongod</span><br></pre></td></tr></table></figure></p><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>详情的配置文件如下：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@iZuf6c08fdv8duubho2b0rZ ~]</span><span class="comment"># cat /hwdata/data/mongodb1/conf/mongodb.conf </span></span><br><span class="line"><span class="attr">dbpath</span>=/hwdata/data/mongodb1/data</span><br><span class="line"><span class="attr">logpath</span>=/hwdata/data/mongodb1/logs/mongodb.log</span><br><span class="line"><span class="attr">pidfilepath</span>=/hwdata/data/mongodb1/logs/mongodb.pid</span><br><span class="line"><span class="attr">directoryperdb</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">logappend</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">27017</span></span><br><span class="line"><span class="attr">fork</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">noprealloc</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">maxConns</span>=<span class="number">10000</span></span><br><span class="line"><span class="attr">profile</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">slowms</span>=<span class="number">100</span></span><br><span class="line"><span class="attr">journal</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">replSet</span>=jiessie</span><br><span class="line"><span class="attr">storageEngine</span>=mmapv1</span><br><span class="line"><span class="section">[root@iZuf6c08fdv8duubho2b0rZ ~]</span><span class="comment"># cat /hwdata/data/mongodb2/conf/mongodb.conf  </span></span><br><span class="line"><span class="attr">dbpath</span>=/hwdata/data/mongodb2/data</span><br><span class="line"><span class="attr">logpath</span>=/hwdata/data/mongodb2/logs/mongodb.log</span><br><span class="line"><span class="attr">pidfilepath</span>=/hwdata/data/mongodb2/logs/mongodb.pid</span><br><span class="line"><span class="attr">directoryperdb</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">logappend</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">28017</span></span><br><span class="line"><span class="attr">fork</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">noprealloc</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">maxConns</span>=<span class="number">10000</span></span><br><span class="line"><span class="attr">profile</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">slowms</span>=<span class="number">100</span></span><br><span class="line"><span class="attr">journal</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">replSet</span>=jiessie</span><br><span class="line"><span class="attr">storageEngine</span>=mmapv1</span><br><span class="line"><span class="section">[root@iZuf6c08fdv8duubho2b0rZ ~]</span><span class="comment"># cat /hwdata/data/mongodb3/conf/mongodb.conf  </span></span><br><span class="line"><span class="attr">dbpath</span>=/hwdata/data/mongodb3/data</span><br><span class="line"><span class="attr">logpath</span>=/hwdata/data/mongodb3/logs/mongodb.log</span><br><span class="line"><span class="attr">pidfilepath</span>=/hwdata/data/mongodb3/logs/mongodb.pid</span><br><span class="line"><span class="attr">directoryperdb</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">logappend</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">29017</span></span><br><span class="line"><span class="attr">fork</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">noprealloc</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">maxConns</span>=<span class="number">10000</span></span><br><span class="line"><span class="attr">profile</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">slowms</span>=<span class="number">100</span></span><br><span class="line"><span class="attr">journal</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">replSet</span>=jiessie</span><br><span class="line"><span class="attr">storageEngine</span>=mmapv1</span><br></pre></td></tr></table></figure></p><h3 id="搭建副本集"><a href="#搭建副本集" class="headerlink" title="搭建副本集"></a>搭建副本集</h3><p>登录其中一个实例，这里以27017为例子，搭建副本<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="meta"># /usr/local/mongodb1/bin/mongo</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting to: mongodb:<span class="comment">//127.0.0.1:27017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">&gt; cfg = &#123;_<span class="keyword">id</span>: <span class="string">"jiessie"</span>, members: [&#123;_<span class="keyword">id</span>: <span class="number">0</span>, host: <span class="string">"192.168.7.50:27017"</span>,priority:<span class="number">3</span>&#125;,&#123;_<span class="keyword">id</span>: <span class="number">1</span>, host: <span class="string">"192.168.7.50:28017"</span>,priority:<span class="number">2</span>&#125;,&#123;_<span class="keyword">id</span>: <span class="number">2</span>, host: <span class="string">"192.168.7.50:29017"</span>,priority:<span class="number">3</span>&#125;]&#125;;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : <span class="number">3</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : <span class="number">2</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : <span class="number">3</span></span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br><span class="line">&gt; rs.initiate(cfg);</span><br><span class="line">&#123; <span class="string">"ok"</span> : <span class="number">1</span> &#125;</span><br><span class="line">jiessie:SECONDARY&gt; </span><br><span class="line">jiessie:PRIMARY&gt; rs.status();</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"set"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"date"</span> : ISODate(<span class="string">"2017-07-21T09:47:24.215Z"</span>),</span><br><span class="line">        <span class="string">"myState"</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">"term"</span> : NumberLong(<span class="number">1</span>),</span><br><span class="line">        <span class="string">"heartbeatIntervalMillis"</span> : NumberLong(<span class="number">2000</span>),</span><br><span class="line">        <span class="string">"optimes"</span> : &#123;</span><br><span class="line">                <span class="string">"lastCommittedOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"appliedOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"durableOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"PRIMARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : <span class="number">1056</span>,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-07-21T09:47:16Z"</span>),</span><br><span class="line">                        <span class="string">"infoMessage"</span> : <span class="string">"could not find member to sync from"</span>,</span><br><span class="line">                        <span class="string">"electionTime"</span> : Timestamp(<span class="number">1500630354</span>, <span class="number">1</span>),</span><br><span class="line">                        <span class="string">"electionDate"</span> : ISODate(<span class="string">"2017-07-21T09:45:54Z"</span>),</span><br><span class="line">                        <span class="string">"configVersion"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"self"</span> : <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : <span class="number">99</span>,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDurable"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-07-21T09:47:16Z"</span>),</span><br><span class="line">                        <span class="string">"optimeDurableDate"</span> : ISODate(<span class="string">"2017-07-21T09:47:16Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2017-07-21T09:47:22.597Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2017-07-21T09:47:23.554Z"</span>),</span><br><span class="line">                        <span class="string">"pingMs"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"configVersion"</span> : <span class="number">1</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : <span class="number">99</span>,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDurable"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-07-21T09:47:16Z"</span>),</span><br><span class="line">                        <span class="string">"optimeDurableDate"</span> : ISODate(<span class="string">"2017-07-21T09:47:16Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2017-07-21T09:47:22.597Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2017-07-21T09:47:23.527Z"</span>),</span><br><span class="line">                        <span class="string">"pingMs"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"configVersion"</span> : <span class="number">1</span></span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"ok"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">jiessie:PRIMARY&gt;</span><br></pre></td></tr></table></figure></p><h4 id="查看存储引擎"><a href="#查看存储引擎" class="headerlink" title="查看存储引擎"></a>查看存储引擎</h4><p>登录其中一个实例，这里以27017为例子，当出现mmapv1时，代表当前使用存储引擎为mmapv1<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo --eval <span class="string">"db.serverStatus()"</span>|grep name</span></span><br><span class="line">                <span class="string">"name"</span> : <span class="string">"mmapv1"</span>,</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p><h4 id="测试副本集"><a href="#测试副本集" class="headerlink" title="测试副本集"></a>测试副本集</h4><p>登录27017的主库，插入数据，在其他节点上查看<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo </span></span><br><span class="line">MongoDB shell version v3.<span class="number">4.4</span></span><br><span class="line">connecting to: mongodb:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">27017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span>.<span class="number">4</span></span><br><span class="line">jiessie:PRIMARY&gt; show dbs;</span><br><span class="line">admin   <span class="number">0.078</span>GB</span><br><span class="line">local  <span class="number">12.072</span>GB</span><br><span class="line">jiessie:PRIMARY&gt; use test11;</span><br><span class="line">switched to db test11</span><br><span class="line">jiessie:PRIMARY&gt; db.tmp11.insert(&#123;<span class="string">"id"</span>:<span class="string">"11"</span>&#125;);</span><br><span class="line">WriteResult(&#123; <span class="string">"nInserted"</span> : <span class="number">1</span> &#125;)</span><br><span class="line">jiessie:PRIMARY&gt; db.tmp11.find();</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5971ced335d36a3364107ac7"</span>), <span class="string">"id"</span> : <span class="string">"11"</span> &#125;</span><br><span class="line">jiessie:PRIMARY&gt; <span class="keyword">exit</span></span><br><span class="line">bye</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo localhost:28017</span></span><br><span class="line">MongoDB shell version v3.<span class="number">4.4</span></span><br><span class="line">connecting to: localhost:<span class="number">28017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span>.<span class="number">4</span></span><br><span class="line">jiessie:SECONDARY&gt; rs.slaveOk();</span><br><span class="line">jiessie:SECONDARY&gt; use test11;</span><br><span class="line">switched to db test11</span><br><span class="line">jiessie:SECONDARY&gt; db.tmp11.find();</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5971ced335d36a3364107ac7"</span>), <span class="string">"id"</span> : <span class="string">"11"</span> &#125;</span><br><span class="line">jiessie:SECONDARY&gt; <span class="keyword">exit</span></span><br><span class="line">bye</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo localhost:29017</span></span><br><span class="line">MongoDB shell version v3.<span class="number">4.4</span></span><br><span class="line">connecting to: localhost:<span class="number">29017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span>.<span class="number">4</span></span><br><span class="line">jiessie:SECONDARY&gt; use test11;</span><br><span class="line">switched to db test11</span><br><span class="line">jiessie:SECONDARY&gt; rs.slaveOk();</span><br><span class="line">jiessie:SECONDARY&gt; db.tmp11.find();</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5971ced335d36a3364107ac7"</span>), <span class="string">"id"</span> : <span class="string">"11"</span> &#125;</span><br><span class="line">jiessie:SECONDARY&gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure></p><h3 id="迁移步骤"><a href="#迁移步骤" class="headerlink" title="迁移步骤"></a>迁移步骤</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">将<span class="number">29017</span>的从节点设置为隐藏节点，不再成为主，对应用不可见</span><br><span class="line">把<span class="number">29017</span>的节点存储引擎从MMAPv1设置为WiredTiger，删除原MMAPv1数据，重新加入副本集中</span><br><span class="line">当<span class="number">29017</span>的WiredTiger节点从主节点初始化数据成功后，依次将其他从节点的引擎修改为的WiredTiger</span><br><span class="line">当所有从节点的引擎修改为WiredTiger后，在主节点执行rs.stepdown()将主降级，触发在其他从节点选举新主</span><br><span class="line">再将原主库按照以上的方式将引擎从MMAPv1设置为WiredTiger</span><br></pre></td></tr></table></figure><p>详情请参考：<a href="http://docs.mongoing.com/manual-zh/tutorial/configure-a-hidden-replica-set-member.html" target="_blank" rel="noopener">http://docs.mongoing.com/manual-zh/tutorial/configure-a-hidden-replica-set-member.html</a></p><h3 id="开始迁移"><a href="#开始迁移" class="headerlink" title="开始迁移"></a>开始迁移</h3><p>副本集的架构下，所有节点之间都是同步的，即使存储引擎不同也不受影响。<br>实验中的副本集端口分别为27017/28017/29017，其中主节点为27017，28017和29017为从节点。<br>27017权重为3，28017权重为2，29017权重为1。</p><p><font color="#dd0000">步骤最后一项，将原主库引擎从MMAPv1设置为WiredTiger，可在原主库上执行rs.stepDown()触发选举，也可提高其他从节点的权重，需要高于主节点。</font><br></p><h4 id="29017实例"><a href="#29017实例" class="headerlink" title="29017实例"></a>29017实例</h4><h5 id="设置节点隐藏"><a href="#设置节点隐藏" class="headerlink" title="设置节点隐藏"></a>设置节点隐藏</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo</span></span><br><span class="line">MongoDB shell <span class="keyword">version</span> v3.4.4</span><br><span class="line">connecting to: mongodb:<span class="string">//127.0.0.1</span><span class="function">:27017</span></span><br><span class="line">MongoDB server <span class="keyword">version</span>: 3.4.4</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg = rs.config<span class="params">()</span>;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"version"</span> : 1,</span><br><span class="line">        <span class="string">"protocolVersion"</span> : NumberLong<span class="params">(1)</span>,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 0,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 3,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 1,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 2,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 2,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 3,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"settings"</span> : &#123;</span><br><span class="line">                <span class="string">"chainingAllowed"</span> : <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"heartbeatIntervalMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"heartbeatTimeoutSecs"</span> : 10,</span><br><span class="line">                <span class="string">"electionTimeoutMillis"</span> : 10000,</span><br><span class="line">                <span class="string">"catchUpTimeoutMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"getLastErrorModes"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"getLastErrorDefaults"</span> : &#123;</span><br><span class="line">                        <span class="string">"w"</span> : 1,</span><br><span class="line">                        <span class="string">"wtimeout"</span> : 0</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"replicaSetId"</span> : ObjectId<span class="params">("5971cd4835e57f0331e944c8")</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[2]<span class="string">.host</span>;</span><br><span class="line">192.168.7.50<span class="function">:29017</span></span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[2]<span class="string">.priority</span> = 0;       <span class="comment">#优化级降为0，不再参数选主</span></span><br><span class="line">0</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[2]<span class="string">.hidden</span> = <span class="literal">true</span>;      <span class="comment">#对应用隐藏</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; rs.reconfig<span class="params">(cfg)</span>;</span><br><span class="line">&#123; <span class="string">"ok"</span> : 1 &#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt;</span><br></pre></td></tr></table></figure><h5 id="修改引擎，删除原数据"><a href="#修改引擎，删除原数据" class="headerlink" title="修改引擎，删除原数据"></a>修改引擎，删除原数据</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo localhost:29017</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: localhost:<span class="number">29017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:SECONDARY&gt; rs.slaveOk()<span class="comment">;</span></span><br><span class="line">jiessie:SECONDARY&gt; use admin<span class="comment">;</span></span><br><span class="line">switched <span class="keyword">to</span> db admin</span><br><span class="line">jiessie:SECONDARY&gt; db.shutdownServer()<span class="comment">;                                                      #关闭服务</span></span><br><span class="line">server should be down...</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># rm -rf /hwdata/data/mongodb3/data/*                        #删除原引擎数据</span></span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># cat /hwdata/data/mongodb3/conf/mongodb.conf |grep sto      #查看原配置</span></span><br><span class="line">storageEngine=mmapv1</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># sed -i <span class="string">'s@storageEngine=mmapv1@storageEngine=wiredTiger@g'</span> /hwdata/data/mongodb3/conf/mongodb.conf    #修改配置文件的引擎部分</span></span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># cat /hwdata/data/mongodb3/conf/mongodb.conf |grep sto      #查看新配置</span></span><br><span class="line">storageEngine=wiredTiger</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb3/bin/mongod -f /hwdata/data/mongodb3/conf/mongodb.conf     #启动服务</span></span><br><span class="line">note: noprealloc may hurt performance <span class="keyword">in</span> many applications</span><br><span class="line">about <span class="keyword">to</span> fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: <span class="number">613</span></span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb3/bin/mongo localhost:29017 --eval <span class="string">"db.serverStatus()"</span>|grep <span class="string">'"name"'</span>    #验证是否修改成功</span></span><br><span class="line">                <span class="string">"name"</span> : <span class="string">"wiredTiger"</span>,</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb3/bin/mongo localhost:29017</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: localhost:<span class="number">29017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:SECONDARY&gt; <span class="keyword">exit</span>                     <span class="meta">#验证初始化同步是否成功，SECONDARY状态表示已经是从节点</span></span><br></pre></td></tr></table></figure><h5 id="加入副本集"><a href="#加入副本集" class="headerlink" title="加入副本集"></a>加入副本集</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo</span></span><br><span class="line">MongoDB shell <span class="keyword">version</span> v3.4.4</span><br><span class="line">connecting to: mongodb:<span class="string">//127.0.0.1</span><span class="function">:27017</span></span><br><span class="line">MongoDB server <span class="keyword">version</span>: 3.4.4</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg = rs.config<span class="params">()</span>;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"version"</span> : 2,</span><br><span class="line">        <span class="string">"protocolVersion"</span> : NumberLong<span class="params">(1)</span>,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 0,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 3,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 1,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 2,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 2,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 0,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"settings"</span> : &#123;</span><br><span class="line">                <span class="string">"chainingAllowed"</span> : <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"heartbeatIntervalMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"heartbeatTimeoutSecs"</span> : 10,</span><br><span class="line">                <span class="string">"electionTimeoutMillis"</span> : 10000,</span><br><span class="line">                <span class="string">"catchUpTimeoutMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"getLastErrorModes"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"getLastErrorDefaults"</span> : &#123;</span><br><span class="line">                        <span class="string">"w"</span> : 1,</span><br><span class="line">                        <span class="string">"wtimeout"</span> : 0</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"replicaSetId"</span> : ObjectId<span class="params">("5971cd4835e57f0331e944c8")</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[2]<span class="string">.hidden=false</span>;       <span class="comment">#加入副本集，对应用可见，其中[2]表示29017端口</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[2]<span class="string">.priority</span> = 1;       <span class="comment">#修改为之前的优先级</span></span><br><span class="line">1</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; rs.reconfig<span class="params">(cfg)</span>;</span><br><span class="line">&#123; <span class="string">"ok"</span> : 1 &#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt;</span><br></pre></td></tr></table></figure><h4 id="28017实例"><a href="#28017实例" class="headerlink" title="28017实例"></a>28017实例</h4><h5 id="设置节点隐藏-1"><a href="#设置节点隐藏-1" class="headerlink" title="设置节点隐藏"></a>设置节点隐藏</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo</span></span><br><span class="line">MongoDB shell <span class="keyword">version</span> v3.4.4</span><br><span class="line">connecting to: mongodb:<span class="string">//127.0.0.1</span><span class="function">:27017</span></span><br><span class="line">MongoDB server <span class="keyword">version</span>: 3.4.4</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg = rs.config<span class="params">()</span>;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"version"</span> : 4,</span><br><span class="line">        <span class="string">"protocolVersion"</span> : NumberLong<span class="params">(1)</span>,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 0,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 3,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 1,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 2,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 2,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 1,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"settings"</span> : &#123;</span><br><span class="line">                <span class="string">"chainingAllowed"</span> : <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"heartbeatIntervalMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"heartbeatTimeoutSecs"</span> : 10,</span><br><span class="line">                <span class="string">"electionTimeoutMillis"</span> : 10000,</span><br><span class="line">                <span class="string">"catchUpTimeoutMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"getLastErrorModes"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"getLastErrorDefaults"</span> : &#123;</span><br><span class="line">                        <span class="string">"w"</span> : 1,</span><br><span class="line">                        <span class="string">"wtimeout"</span> : 0</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"replicaSetId"</span> : ObjectId<span class="params">("5971cd4835e57f0331e944c8")</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[1]<span class="string">.host</span></span><br><span class="line">192.168.7.50<span class="function">:28017</span></span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[1]<span class="string">.priority</span> = 0;</span><br><span class="line">0</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[1]<span class="string">.hidden</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="literal">true</span></span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; rs.reconfig<span class="params">(cfg)</span>;</span><br><span class="line">&#123; <span class="string">"ok"</span> : 1 &#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt;</span><br></pre></td></tr></table></figure><h5 id="修改引擎，删除原数据-1"><a href="#修改引擎，删除原数据-1" class="headerlink" title="修改引擎，删除原数据"></a>修改引擎，删除原数据</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo localhost:28017</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: localhost:<span class="number">28017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:SECONDARY&gt; rs.slaveOk()<span class="comment">;</span></span><br><span class="line">jiessie:SECONDARY&gt; use admin<span class="comment">;</span></span><br><span class="line">switched <span class="keyword">to</span> db admin</span><br><span class="line">jiessie:SECONDARY&gt; db.shutdownServer()<span class="comment">;                                                      #关闭服务</span></span><br><span class="line">server should be down...</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># rm -rf /hwdata/data/mongodb2/data/*                        #删除原引擎数据</span></span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># cat /hwdata/data/mongodb2/conf/mongodb.conf |grep sto      #查看原配置</span></span><br><span class="line">storageEngine=mmapv1</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># sed -i <span class="string">'s@storageEngine=mmapv1@storageEngine=wiredTiger@g'</span> /hwdata/data/mongodb2/conf/mongodb.conf    #修改配置文件的引擎部分</span></span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># cat /hwdata/data/mongodb2/conf/mongodb.conf |grep sto      #查看新配置</span></span><br><span class="line">storageEngine=wiredTiger</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb2/bin/mongod -f /hwdata/data/mongodb2/conf/mongodb.conf     #启动服务</span></span><br><span class="line">note: noprealloc may hurt performance <span class="keyword">in</span> many applications</span><br><span class="line">about <span class="keyword">to</span> fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: <span class="number">1275</span></span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb2/bin/mongo localhost:28017 --eval <span class="string">"db.serverStatus()"</span>|grep <span class="string">'"name"'</span>    #验证是否修改成功</span></span><br><span class="line">                <span class="string">"name"</span> : <span class="string">"wiredTiger"</span>,</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb2/bin/mongo localhost:28017</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: localhost:<span class="number">28017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:SECONDARY&gt; <span class="keyword">exit</span>                     <span class="meta">#验证初始化同步是否成功，SECONDARY状态表示已经是从节点</span></span><br></pre></td></tr></table></figure><h5 id="加入副本集-1"><a href="#加入副本集-1" class="headerlink" title="加入副本集"></a>加入副本集</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo </span></span><br><span class="line">MongoDB shell <span class="keyword">version</span> v3.4.4</span><br><span class="line">connecting to: mongodb:<span class="string">//127.0.0.1</span><span class="function">:27017</span></span><br><span class="line">MongoDB server <span class="keyword">version</span>: 3.4.4</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg = rs.config<span class="params">()</span>;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"version"</span> : 5,</span><br><span class="line">        <span class="string">"protocolVersion"</span> : NumberLong<span class="params">(1)</span>,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 0,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 3,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 1,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 0,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 2,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 1,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"settings"</span> : &#123;</span><br><span class="line">                <span class="string">"chainingAllowed"</span> : <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"heartbeatIntervalMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"heartbeatTimeoutSecs"</span> : 10,</span><br><span class="line">                <span class="string">"electionTimeoutMillis"</span> : 10000,</span><br><span class="line">                <span class="string">"catchUpTimeoutMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"getLastErrorModes"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"getLastErrorDefaults"</span> : &#123;</span><br><span class="line">                        <span class="string">"w"</span> : 1,</span><br><span class="line">                        <span class="string">"wtimeout"</span> : 0</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"replicaSetId"</span> : ObjectId<span class="params">("5971cd4835e57f0331e944c8")</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[1]<span class="string">.hidden</span> = <span class="literal">false</span>;     <span class="comment">#加入副本集，对应用可见，其中[1]表示28017端口</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[1]<span class="string">.priority</span> = 2;       <span class="comment">#修改为之前的优先级</span></span><br><span class="line">2</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; rs.reconfig<span class="params">(cfg)</span>;</span><br><span class="line">&#123; <span class="string">"ok"</span> : 1 &#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt;</span><br></pre></td></tr></table></figure><h4 id="27017实例"><a href="#27017实例" class="headerlink" title="27017实例"></a>27017实例</h4><h5 id="设置节点隐藏-2"><a href="#设置节点隐藏-2" class="headerlink" title="设置节点隐藏"></a>设置节点隐藏</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: mongodb://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">27017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:PRIMARY&gt; </span><br><span class="line">jiessie:PRIMARY&gt; rs.stepDown()<span class="comment">;</span></span><br><span class="line"><span class="number">2017</span><span class="number">-07</span><span class="number">-22</span>T21:<span class="number">51</span>:<span class="number">26.392</span>+<span class="number">0800</span> E QUERY    [thread1] Error: error doing query: failed: network error <span class="keyword">while</span> attempting <span class="keyword">to</span> <span class="built_in">run</span> command <span class="string">'replSetStepDown'</span> on host <span class="string">'127.0.0.1:27017'</span>  :</span><br><span class="line">DB.prototype.runCommand<span class="symbol">@src</span>/mongo/shell/db.js:<span class="number">132</span>:<span class="number">1</span></span><br><span class="line">DB.prototype.adminCommand<span class="symbol">@src</span>/mongo/shell/db.js:<span class="number">150</span>:<span class="number">16</span></span><br><span class="line">rs.stepDown<span class="symbol">@src</span>/mongo/shell/utils.js:<span class="number">1261</span>:<span class="number">12</span></span><br><span class="line">@(shell):<span class="number">1</span>:<span class="number">1</span></span><br><span class="line"><span class="number">2017</span><span class="number">-07</span><span class="number">-22</span>T21:<span class="number">51</span>:<span class="number">26.394</span>+<span class="number">0800</span> I NETWORK  [thread1] trying reconnect <span class="keyword">to</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">27017</span> (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>) failed</span><br><span class="line"><span class="number">2017</span><span class="number">-07</span><span class="number">-22</span>T21:<span class="number">51</span>:<span class="number">26.394</span>+<span class="number">0800</span> I NETWORK  [thread1] reconnect <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">27017</span> (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>) ok</span><br><span class="line">jiessie:SECONDARY&gt; rs.slaveOk()<span class="comment">;</span></span><br><span class="line">jiessie:SECONDARY&gt; rs.status()<span class="comment">;                     #等待几秒，查看状态，此时28017实例是已经提升为新主库</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"set"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"date"</span> : ISODate(<span class="string">"2017-07-22T13:51:34.336Z"</span>),</span><br><span class="line">        <span class="string">"myState"</span> : <span class="number">2</span>,</span><br><span class="line">        <span class="string">"term"</span> : NumberLong(<span class="number">12</span>),</span><br><span class="line">        <span class="string">"heartbeatIntervalMillis"</span> : NumberLong(<span class="number">2000</span>),</span><br><span class="line">        <span class="string">"optimes"</span> : &#123;</span><br><span class="line">                <span class="string">"lastCommittedOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"appliedOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"durableOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : <span class="number">102106</span>,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-07-22T13:51:20Z"</span>),</span><br><span class="line">                        <span class="string">"infoMessage"</span> : <span class="string">"could not find member to sync from"</span>,</span><br><span class="line">                        <span class="string">"configVersion"</span> : <span class="number">6</span>,</span><br><span class="line">                        <span class="string">"self"</span> : <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : <span class="number">2403</span>,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDurable"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-07-22T13:51:20Z"</span>),</span><br><span class="line">                        <span class="string">"optimeDurableDate"</span> : ISODate(<span class="string">"2017-07-22T13:51:20Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2017-07-22T13:51:31.557Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2017-07-22T13:51:33.176Z"</span>),</span><br><span class="line">                        <span class="string">"pingMs"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"configVersion"</span> : <span class="number">6</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : <span class="number">4846</span>,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDurable"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-07-22T13:51:20Z"</span>),</span><br><span class="line">                        <span class="string">"optimeDurableDate"</span> : ISODate(<span class="string">"2017-07-22T13:51:20Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2017-07-22T13:51:31.557Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2017-07-22T13:51:30.019Z"</span>),</span><br><span class="line">                        <span class="string">"pingMs"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                        <span class="string">"configVersion"</span> : <span class="number">6</span></span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"ok"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">jiessie:SECONDARY&gt; <span class="keyword">exit</span></span><br><span class="line">bye</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo localhost:28017     #登录新主库，原27017实例修改实例引擎</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: localhost:<span class="number">28017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:PRIMARY&gt; cfg = rs.config()<span class="comment">;</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"version"</span> : <span class="number">6</span>,</span><br><span class="line">        <span class="string">"protocolVersion"</span> : NumberLong(<span class="number">1</span>),</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : <span class="number">3</span>,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                        <span class="string">"votes"</span> : <span class="number">1</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                        <span class="string">"votes"</span> : <span class="number">1</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                        <span class="string">"votes"</span> : <span class="number">1</span></span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"settings"</span> : &#123;</span><br><span class="line">                <span class="string">"chainingAllowed"</span> : <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"heartbeatIntervalMillis"</span> : <span class="number">2000</span>,</span><br><span class="line">                <span class="string">"heartbeatTimeoutSecs"</span> : <span class="number">10</span>,</span><br><span class="line">                <span class="string">"electionTimeoutMillis"</span> : <span class="number">10000</span>,</span><br><span class="line">                <span class="string">"catchUpTimeoutMillis"</span> : <span class="number">2000</span>,</span><br><span class="line">                <span class="string">"getLastErrorModes"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"getLastErrorDefaults"</span> : &#123;</span><br><span class="line">                        <span class="string">"w"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"wtimeout"</span> : <span class="number">0</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"replicaSetId"</span> : ObjectId(<span class="string">"5971cd4835e57f0331e944c8"</span>)</span><br><span class="line">    essie:PRIMARY&gt; cfg.members[<span class="number">0</span>].priority = <span class="number">0</span><span class="comment">;</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line">jiessie:PRIMARY&gt; cfg.members[<span class="number">0</span>].hidden = <span class="literal">true</span><span class="comment">;</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line">jiessie:PRIMARY&gt; rs.reconfig(cfg)<span class="comment">;</span></span><br><span class="line">&#123; <span class="string">"ok"</span> : <span class="number">1</span> &#125;</span><br><span class="line">jiessie:PRIMARY&gt;</span><br></pre></td></tr></table></figure><h5 id="修改引擎，删除原数据-2"><a href="#修改引擎，删除原数据-2" class="headerlink" title="修改引擎，删除原数据"></a>修改引擎，删除原数据</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo localhost:27017</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: localhost:<span class="number">27017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:SECONDARY&gt; rs.slaveOk()<span class="comment">;</span></span><br><span class="line">jiessie:SECONDARY&gt; use admin<span class="comment">;</span></span><br><span class="line">switched <span class="keyword">to</span> db admin</span><br><span class="line">jiessie:SECONDARY&gt; db.shutdownServer()<span class="comment">;                                                      #关闭服务</span></span><br><span class="line">server should be down...</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># rm -rf /hwdata/data/mongodb1/data/*                        #删除原引擎数据</span></span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># cat /hwdata/data/mongodb1/conf/mongodb.conf |grep sto      #查看原配置</span></span><br><span class="line">storageEngine=mmapv1</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># sed -i <span class="string">'s@storageEngine=mmapv1@storageEngine=wiredTiger@g'</span> /hwdata/data/mongodb1/conf/mongodb.conf    #修改配置文件的引擎部分</span></span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># cat /hwdata/data/mongodb2/conf/mongodb.conf |grep sto      #查看新配置</span></span><br><span class="line">storageEngine=wiredTiger</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongod -f /hwdata/data/mongodb1/conf/mongodb.conf     #启动服务</span></span><br><span class="line">note: noprealloc may hurt performance <span class="keyword">in</span> many applications</span><br><span class="line">about <span class="keyword">to</span> fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: <span class="number">2157</span></span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo localhost:27017 --eval <span class="string">"db.serverStatus()"</span>|grep <span class="string">'"name"'</span>    #验证是否修改成功</span></span><br><span class="line">                <span class="string">"name"</span> : <span class="string">"wiredTiger"</span>,</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo localhost:27017</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: localhost:<span class="number">27017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:SECONDARY&gt; <span class="keyword">exit</span>                     <span class="meta">#验证初始化同步是否成功，SECONDARY状态表示已经是从节点</span></span><br></pre></td></tr></table></figure><h5 id="加入副本集-2"><a href="#加入副本集-2" class="headerlink" title="加入副本集"></a>加入副本集</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo localhost:28017</span></span><br><span class="line">MongoDB shell <span class="keyword">version</span> v3.4.4</span><br><span class="line">connecting to: mongodb:<span class="string">//127.0.0.1</span><span class="function">:27017</span></span><br><span class="line">MongoDB server <span class="keyword">version</span>: 3.4.4</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg = rs.config<span class="params">()</span>;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"version"</span> : 7,</span><br><span class="line">        <span class="string">"protocolVersion"</span> : NumberLong<span class="params">(1)</span>,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 0,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 0,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 1,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 2,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 2,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 1,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"settings"</span> : &#123;</span><br><span class="line">                <span class="string">"chainingAllowed"</span> : <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"heartbeatIntervalMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"heartbeatTimeoutSecs"</span> : 10,</span><br><span class="line">                <span class="string">"electionTimeoutMillis"</span> : 10000,</span><br><span class="line">                <span class="string">"catchUpTimeoutMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"getLastErrorModes"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"getLastErrorDefaults"</span> : &#123;</span><br><span class="line">                        <span class="string">"w"</span> : 1,</span><br><span class="line">                        <span class="string">"wtimeout"</span> : 0</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"replicaSetId"</span> : ObjectId<span class="params">("5971cd4835e57f0331e944c8")</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[0]<span class="string">.hidden</span> = <span class="literal">false</span>;     <span class="comment">#加入副本集，对应用可见，其中[0]表示27017端口</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[0]<span class="string">.priority</span> = 3;       <span class="comment">#修改为之前的优先级</span></span><br><span class="line">3</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; rs.reconfig<span class="params">(cfg)</span>;</span><br><span class="line">&#123; <span class="string">"ok"</span> : 1 &#125;</span><br><span class="line">jiessie<span class="function">:SECONDARY</span>&gt;                                  <span class="comment">#等待几秒后，PRIMARY会变成SECONDARY</span></span><br></pre></td></tr></table></figure><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>mongodb作为发展迅速的开源数据库一员，版本迭代升级很快，目前使用旧引擎的公司不在小数，新引擎的优点足以促使其升级引擎。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;MongoDB是一个开源的文档型数据库，介于关系数据库和非关系数据库之间，是非关系数据库中功能最丰富，最像关系数据库的。它支持的数据结构非常
      
    
    </summary>
    
      <category term="mongodb" scheme="https://dwj999.github.io/categories/mongodb/"/>
    
    
      <category term="mongo" scheme="https://dwj999.github.io/tags/mongo/"/>
    
      <category term="mongodb" scheme="https://dwj999.github.io/tags/mongodb/"/>
    
      <category term="MMAPv1" scheme="https://dwj999.github.io/tags/MMAPv1/"/>
    
      <category term="WiredTiger" scheme="https://dwj999.github.io/tags/WiredTiger/"/>
    
  </entry>
  
  <entry>
    <title>hexo next 使用Percona Data Recovery Tool for InnoDB恢复数据</title>
    <link href="https://dwj999.github.io/%E4%BD%BF%E7%94%A8Percona-Data-Recovery-Tool-for-InnoDB%E6%81%A2%E5%A4%8D%E6%95%B0%E6%8D%AE.html"/>
    <id>https://dwj999.github.io/使用Percona-Data-Recovery-Tool-for-InnoDB恢复数据.html</id>
    <published>2017-07-14T06:28:11.000Z</published>
    <updated>2020-05-20T03:47:55.682Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>数据是一个企业最重要的资产，备份的重要性不言而喻，有效的备份能够减少意外情况下的公司损失。当使用MySQL数据库时，mysqldump、mysqlpump、mydumper、xtrabackup等都是不错的备份工具，极端情况下，当开启了binlog，也可以成为恢复的救命稻草。但是，还有存在无备份，没有开启binlog的情况，如果是InnoDB表，这时percona推出的Percona Data Recovery Tool工具可以派上用场。</p><h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">此工具仅支持InnoDB/XtraDB表，不支持MyISAM表</span><br><span class="line">此工具可恢复数据文件的副本，并不要求是正在运行的MySQL服务器</span><br><span class="line">此工具并不保证数据一定可恢复，如数据被覆盖</span><br><span class="line">支持的误操作类型：<span class="keyword">DELETE</span>、<span class="keyword">TRUNCATE</span>，表格式为<span class="keyword">Compact</span></span><br><span class="line">在文件系统级别删除的文件</span><br><span class="line">如数据文件损失，此工具也无法恢复</span><br></pre></td></tr></table></figure><h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>通过尝试在页面中找到有效的行来工作，InnoDB的数据都是索引的方式组织的，所有的数据都是存储在16KB的数据块中，每个页面都有属于特定表的特定索引。恢复时分解所有的数据文件为单个16kb大小的页面，根据每个页面的标记的数据起点开始尝试匹配，如果与给定表定义的属于匹配，则输出匹配记录。</p><h2 id="表空间"><a href="#表空间" class="headerlink" title="表空间"></a>表空间</h2><p>当服务器设置了innodb_file_per_table=1时，工具不需要再额外的从ibdata1中拆分数据，所有的数据都保存在ibd文件中。<br>当服务器设置了innodb_file_per_table=0时，工具需要先使用page_parser，把数据文件从ibdata1中拆分出来，再按照规则匹配记录。</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：centos 6.5 x86_64</p><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> gcc gcc-c++ glibc glibc-<span class="keyword">static</span>  perl-DBI perl-DBD-MySQL</span><br></pre></td></tr></table></figure><h2 id="安装Percona-Data-Recovery-Tool"><a href="#安装Percona-Data-Recovery-Tool" class="headerlink" title="安装Percona Data Recovery Tool"></a>安装Percona Data Recovery Tool</h2><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># cd /usr/src/</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ src]<span class="comment"># wget https://launchpad.net/percona-data-recovery-tool-for-innodb/trunk/release-0.5/+download/percona-data-recovery-tool-for-innodb-0.5.tar.gz --no-check-certificate </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ src]<span class="comment"># tar -zxf percona-data-recovery-tool-for-innodb-0.5.tar.gz </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ src]<span class="comment"># cd percona-data-recovery-tool-for-innodb-0.5/mysql-source/</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ mysql-source]<span class="comment"># ./configure </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ mysql-source]<span class="comment"># cd ..</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># make</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># ll</span></span><br><span class="line">总用量 3168</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 6269 </span>8月 <span class="number"> 28 </span>2011 check_data.c</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root  <span class="number"> 748761 </span>7月 <span class="number"> 17 </span>09:06 constraints_parser</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 22172 </span>8月 <span class="number"> 28 </span>2011 constraints_parser.c</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 12051 </span>8月 <span class="number"> 28 </span>2011 create_defs.pl</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span><span class="number"> 510 </span>wheel   <span class="number"> 4096 </span>8月 <span class="number"> 28 </span>2011 docs</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 1978 </span>8月 <span class="number"> 28 </span>2011 fetch_data.sh</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root  <span class="number"> 979051 </span>7月 <span class="number"> 17 </span>09:06 ibdconnect</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 12200 </span>8月 <span class="number"> 28 </span>2011 ibdconnect.c</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span><span class="number"> 510 </span>wheel   <span class="number"> 4096 </span>8月 <span class="number"> 28 </span>2011 include</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 8262 </span>8月 <span class="number"> 28 </span>2011 incrementalupdate.c</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root   <span class="number"> 14873 </span>7月 <span class="number"> 17 </span>09:06 innochecksum</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 9117 </span>8月 <span class="number"> 28 </span>2011 innochecksum.c</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel     <span class="number"> 74 </span>8月 <span class="number"> 28 </span>2011 INSTALL</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span>root root    <span class="number"> 4096 </span>7月 <span class="number"> 17 </span>09:06 lib</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 2676 </span>8月 <span class="number"> 28 </span>2011 Makefile</span><br><span class="line">drwxr-xr-x<span class="number"> 40 </span><span class="number"> 510 </span>wheel   <span class="number"> 4096 </span>7月 <span class="number"> 17 </span>09:06 mysql-source</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1346155 </span>7月 <span class="number"> 17 </span>09:06 page_parser</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 15239 </span>8月 <span class="number"> 28 </span>2011 page_parser.c</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 10608 </span>8月 <span class="number"> 28 </span>2011 print_data.c</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span><span class="number"> 510 </span>wheel    <span class="number"> 302 </span>8月 <span class="number"> 28 </span>2011 split_dump.pl</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 2046 </span>8月 <span class="number"> 28 </span>2011 tables_dict.c</span><br></pre></td></tr></table></figure><h2 id="恢复实战-delete误操作"><a href="#恢复实战-delete误操作" class="headerlink" title="恢复实战(delete误操作)"></a>恢复实战(delete误操作)</h2><h3 id="innodb-file-per-table-1"><a href="#innodb-file-per-table-1" class="headerlink" title="innodb_file_per_table=1"></a>innodb_file_per_table=1</h3><h4 id="模拟数据被误删除"><a href="#模拟数据被误删除" class="headerlink" title="模拟数据被误删除"></a>模拟数据被误删除</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># mysql -uroot -p123456</span></span><br><span class="line">Warning: Using a password <span class="keyword">on</span> <span class="keyword">the</span> command line interface can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">35514</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.6</span><span class="number">.36</span><span class="number">-82.0</span>-<span class="built_in">log</span> Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">25</span>:<span class="number">34</span> &gt; create database test111;</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">25</span>:<span class="number">40</span> &gt; use test111;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">25</span>:<span class="number">43</span> &gt; create table t222(<span class="built_in">id</span> int unsigned <span class="keyword">not</span> null auto_increment,<span class="built_in">name</span> varchar(<span class="number">20</span>),age int,primary key(`<span class="built_in">id</span>`),key idx_age(`age`));   </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">25</span>:<span class="number">51</span> &gt; insert <span class="keyword">into</span> t222 values(null,'jiessie',<span class="number">18</span>);           </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">00</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;     </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">1</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">10</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">2</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">2</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">11</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">4</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">4</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">11</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">8</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">8</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">12</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">16</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">16</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">12</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">32</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">32</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">12</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">64</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">64</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">13</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">128</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">128</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">13</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">256</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">256</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">14</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">512</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">512</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">14</span> &gt; select <span class="built_in">count</span><span class="comment">(*) from t222;</span></span><br><span class="line"><span class="comment">+<span class="comment">----------+</span></span></span><br><span class="line"><span class="comment">| count<span class="comment">(*) |</span></span></span><br><span class="line"><span class="comment"><span class="comment">+<span class="comment">----------+</span></span></span></span><br><span class="line"><span class="comment"><span class="comment">|     1024 |</span></span></span><br><span class="line"><span class="comment"><span class="comment">+<span class="comment">----------+</span></span></span></span><br><span class="line"><span class="comment"><span class="comment">1 row in set (0.00 sec)</span></span></span><br><span class="line"><span class="comment"><span class="comment"></span></span></span><br><span class="line"><span class="comment"><span class="comment">MySQL [test111] 09:26:21 &gt; exit</span></span></span><br><span class="line"><span class="comment"><span class="comment">Bye</span></span></span><br><span class="line"><span class="comment"><span class="comment">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# mysql -uroot -p123456 test111 -e "delete from t222;select count<span class="comment">(*) from t222;" &amp;&amp; cp /hwdata/data/percona/test111/t222.* /tmp/</span></span></span></span><br><span class="line"><span class="comment"><span class="comment"><span class="comment">Warning: Using a password on the command line interface can be insecure.</span></span></span></span><br><span class="line"><span class="comment"><span class="comment"><span class="comment">+<span class="comment">----------+</span></span></span></span></span><br><span class="line"><span class="comment"><span class="comment"><span class="comment">| count<span class="comment">(*) |</span></span></span></span></span><br><span class="line"><span class="comment"><span class="comment"><span class="comment"><span class="comment">+<span class="comment">----------+</span></span></span></span></span></span><br><span class="line"><span class="comment"><span class="comment"><span class="comment"><span class="comment">|        0 |</span></span></span></span></span><br><span class="line"><span class="comment"><span class="comment"><span class="comment"><span class="comment">+<span class="comment">----------+</span></span></span></span></span></span><br></pre></td></tr></table></figure><h4 id="解析ibd文件"><a href="#解析ibd文件" class="headerlink" title="解析ibd文件"></a>解析ibd文件</h4><p>实战mysql安装在/usr/local/percona，数据目录在/hwdata/data/percona，注意保存数据文件。<br>此过程会将表的idb文件解析为很多的page，innodb的page分为两大部分，一部分一级索引部分（primary key），另一部分为二级索引部分（secondary key），所以解析出来的ibd包括了主键数据和索引数据两大部分（如果该表有多个二级索引，则会生成多个文件<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># ll -t /tmp/t222*</span></span><br><span class="line">-rw-r-----<span class="number"> 1 </span>root root<span class="number"> 163840 </span>7月 <span class="number"> 17 </span>09:26 /tmp/t222.ibd</span><br><span class="line">-rw-r-----<span class="number"> 1 </span>root root  <span class="number"> 8614 </span>7月 <span class="number"> 17 </span>09:26 /tmp/t222.frm</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># ./page_parser -5 -f /tmp/t222.ibd </span></span><br><span class="line">Opening file: /tmp/t222.ibd:</span><br><span class="line">64513           ID of device containing file</span><br><span class="line">1597422         inode number</span><br><span class="line">33184           protection</span><br><span class="line">1               number of hard links</span><br><span class="line">0               user ID of owner</span><br><span class="line">0               group ID of owner</span><br><span class="line">0               device ID (if special file)</span><br><span class="line">163840          total size, in bytes</span><br><span class="line">4096            blocksize for filesystem I/O</span><br><span class="line">320             number of blocks allocated</span><br><span class="line">1500254806      time of last access</span><br><span class="line">1500254806      time of last modification</span><br><span class="line">1500254806      time of last status change</span><br><span class="line">163840  Size to process in bytes</span><br><span class="line">104857600       Disk cache size in bytes</span><br><span class="line">19.97% done. 2017-07-17 09:27:37 ETA(in 00:00 hours). Processing speed:<span class="number"> 32723 </span>B/sec</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># ll -t</span></span><br><span class="line">总用量 3172</span><br><span class="line">drwxr-xr-x <span class="number"> 3 </span>root root    <span class="number"> 4096 </span>7月 <span class="number"> 17 </span>09:27 pages-1500254852</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1346155 </span>7月 <span class="number"> 17 </span>09:21 page_parser</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root  <span class="number"> 748729 </span>7月 <span class="number"> 17 </span>09:21 constraints_parser</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span>root root    <span class="number"> 4096 </span>7月 <span class="number"> 17 </span>09:21 lib</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root  <span class="number"> 979051 </span>7月 <span class="number"> 17 </span>09:06 ibdconnect</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root   <span class="number"> 14873 </span>7月 <span class="number"> 17 </span>09:06 innochecksum</span><br><span class="line">drwxr-xr-x<span class="number"> 40 </span><span class="number"> 510 </span>wheel   <span class="number"> 4096 </span>7月 <span class="number"> 17 </span>09:06 mysql-source</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span><span class="number"> 510 </span>wheel   <span class="number"> 4096 </span>8月 <span class="number"> 28 </span>2011 docs</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span><span class="number"> 510 </span>wheel   <span class="number"> 4096 </span>8月 <span class="number"> 28 </span>2011 include</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 6269 </span>8月 <span class="number"> 28 </span>2011 check_data.c</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 22172 </span>8月 <span class="number"> 28 </span>2011 constraints_parser.c</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 12051 </span>8月 <span class="number"> 28 </span>2011 create_defs.pl</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 1978 </span>8月 <span class="number"> 28 </span>2011 fetch_data.sh</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 12200 </span>8月 <span class="number"> 28 </span>2011 ibdconnect.c</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 8262 </span>8月 <span class="number"> 28 </span>2011 incrementalupdate.c</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 9117 </span>8月 <span class="number"> 28 </span>2011 innochecksum.c</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel     <span class="number"> 74 </span>8月 <span class="number"> 28 </span>2011 INSTALL</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 2676 </span>8月 <span class="number"> 28 </span>2011 Makefile</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 15239 </span>8月 <span class="number"> 28 </span>2011 page_parser.c</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 10608 </span>8月 <span class="number"> 28 </span>2011 print_data.c</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span><span class="number"> 510 </span>wheel    <span class="number"> 302 </span>8月 <span class="number"> 28 </span>2011 split_dump.pl</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 2046 </span>8月 <span class="number"> 28 </span>2011 tables_dict.c</span><br></pre></td></tr></table></figure></p><p>参数解释：<br>-5：代表 row format为Compact mysql5.0后的版本，-4 代表mysql5.0前版本<br>-f：代表要解析的文件 </p><h4 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h4><p>从下面的解析后的结果看到，当前目录多了pages-1500254852，其中39为主键索引的index_id,40为二级索引的index_id,该id可以通过开启innodb_table_monitor查看<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-<span class="number">0</span>.<span class="number">5</span>]# ll pages-<span class="number">1500254852</span>/FIL_PAGE_INDEX/<span class="number">0</span>-*</span><br><span class="line">pages-<span class="number">1500254852</span>/FIL_PAGE_INDEX/<span class="number">0</span>-<span class="number">39</span>:</span><br><span class="line">总用量 <span class="number">64</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 09:27 0</span>-<span class="number">00000003</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 09:27 2</span>-<span class="number">00000005</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 09:27 3</span>-<span class="number">00000006</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 09:27 4</span>-<span class="number">00000007</span>.page</span><br><span class="line"></span><br><span class="line">pages-<span class="number">1500254852</span>/FIL_PAGE_INDEX/<span class="number">0</span>-<span class="number">40</span>:</span><br><span class="line">总用量 <span class="number">16</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 09:27 1</span>-<span class="number">00000004</span>.page</span><br></pre></td></tr></table></figure></p><h4 id="生成表定义"><a href="#生成表定义" class="headerlink" title="生成表定义"></a>生成表定义</h4><p>由于该工具在解析数据pages的时候，需要获得该table的表结构定义，所以需要执行如下命令。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]<span class="comment"># ./create_defs.pl --host localhost --user root --password 123456 --db test111 --table t222 &gt; include/table_defs.h</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]<span class="comment"># cat include/table_defs.h</span></span><br><span class="line"><span class="comment">#ifndef table_defs_h</span></span><br><span class="line"><span class="comment">#define table_defs_h</span></span><br><span class="line"></span><br><span class="line">/<span class="regexp">/ Table definitions</span></span><br><span class="line"><span class="regexp">table_def_t table_definitions[] = &#123;</span></span><br><span class="line"><span class="regexp">        &#123;</span></span><br><span class="line"><span class="regexp">                name: "t222",</span></span><br><span class="line"><span class="regexp">                &#123;</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>* int(<span class="number">10</span>) unsigned *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "id",</span></span><br><span class="line"><span class="regexp">                                type: FT_UINT,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 4,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                has_limits: FALSE,</span></span><br><span class="line"><span class="regexp">                                limits: &#123;</span></span><br><span class="line"><span class="regexp">                                        can_be_null: FALSE,</span></span><br><span class="line"><span class="regexp">                                        uint_min_val: 0,</span></span><br><span class="line"><span class="regexp">                                        uint_max_val: 4294967295ULL</span></span><br><span class="line"><span class="regexp">                                &#125;,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: FALSE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>*  *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "DB_TRX_ID",</span></span><br><span class="line"><span class="regexp">                                type: FT_INTERNAL,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 6,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: FALSE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>*  *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "DB_ROLL_PTR",</span></span><br><span class="line"><span class="regexp">                                type: FT_INTERNAL,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 7,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: FALSE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>* varchar(<span class="number">20</span>) *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "name",</span></span><br><span class="line"><span class="regexp">                                type: FT_CHAR,</span></span><br><span class="line"><span class="regexp">                                min_length: 0,</span></span><br><span class="line"><span class="regexp">                                max_length: 60,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                has_limits: FALSE,</span></span><br><span class="line"><span class="regexp">                                limits: &#123;</span></span><br><span class="line"><span class="regexp">                                        can_be_null: TRUE,</span></span><br><span class="line"><span class="regexp">                                        char_min_len: 0,</span></span><br><span class="line"><span class="regexp">                                        char_max_len: 60,</span></span><br><span class="line"><span class="regexp">                                        char_ascii_only: TRUE</span></span><br><span class="line"><span class="regexp">                                &#125;,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: TRUE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>* int(<span class="number">11</span>) *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "age",</span></span><br><span class="line"><span class="regexp">                                type: FT_INT,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 4,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                has_limits: FALSE,</span></span><br><span class="line"><span class="regexp">                                limits: &#123;</span></span><br><span class="line"><span class="regexp">                                        can_be_null: TRUE,</span></span><br><span class="line"><span class="regexp">                                        int_min_val: -2147483648LL,</span></span><br><span class="line"><span class="regexp">                                        int_max_val: 2147483647LL</span></span><br><span class="line"><span class="regexp">                                &#125;,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: TRUE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; type: FT_NONE &#125;</span></span><br><span class="line"><span class="regexp">                &#125;</span></span><br><span class="line"><span class="regexp">        &#125;,</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">#endif</span></span><br><span class="line"><span class="regexp">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# </span></span><br><span class="line"><span class="regexp">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# make</span></span><br><span class="line"><span class="regexp">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c tables_dict.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c check_data.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">check_data</span>.<span class="title">o</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -o constraints_parser constraints_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">print_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">check_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span> <span class="title">lib</span>/<span class="title">libmystrings</span>.<span class="title">a</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -static -lrt -o page_parser page_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span> </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]<span class="comment"># make</span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c tables_dict.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c print_data.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">print_data</span>.<span class="title">o</span> </span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -o constraints_parser constraints_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">print_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">check_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span> <span class="title">lib</span>/<span class="title">libmystrings</span>.<span class="title">a</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -static -lrt -o page_parser page_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span></span></span><br></pre></td></tr></table></figure></p><p>上面的命令会将t222表的表定义传入到table_defs.h中，在生成了表结构定义后，重新make该恢复工具  </p><p><font color="#dd0000">注意：需要make 2次</font><br> </p><h4 id="开始提取page中删除的数据"><a href="#开始提取page中删除的数据" class="headerlink" title="开始提取page中删除的数据"></a>开始提取page中删除的数据</h4><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># ./constraints_parser -5 -f pages-1500254852/FIL_PAGE_INDEX/0-39/ &gt; /tmp/t222.sql</span></span><br><span class="line">LOAD DATA INFILE <span class="string">'/usr/src/percona-data-recovery-tool-for-innodb-0.5/dumps/default/t222'</span> REPLACE INTO TABLE `<span class="javascript">t222</span>` FIELDS TERMINATED BY <span class="string">'\t'</span> OPTIONALLY ENCLOSED BY <span class="string">'"'</span> LINES STARTING BY <span class="string">'t222\t'</span> (id, name, age);</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># cat /tmp/t222.sql |wc -l</span></span><br><span class="line"><span class="number">1024</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># head -10 /tmp/t222.sql </span></span><br><span class="line">t222    <span class="number">1</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">2</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">3</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">4</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">6</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">7</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">8</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">9</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">13</span>      <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">14</span>      <span class="string">"jiessie"</span>       <span class="number">18</span></span><br></pre></td></tr></table></figure><p>参数解释：<br>-5 -f的参数和page_parser相同，代表 row format为Compact ；<br>-D:该参数的含义为代表恢复删除的数据页； </p><h4 id="恢复数据"><a href="#恢复数据" class="headerlink" title="恢复数据"></a>恢复数据</h4><p>使用上面constraints_parser执行后的load data导入数据，需要注意目录<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]# mysql -uroot -p123456 </span><br><span class="line">Warning: <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line <span class="keyword">interface</span> can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">35598</span></span><br><span class="line">Server version: <span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">32</span>:<span class="number">33</span> &gt; use test111;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">32</span>:<span class="number">35</span> &gt; LOAD DATA INFILE <span class="string">'/tmp/t222.sql'</span> REPLACE <span class="keyword">INTO</span> TABLE `t222` FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">'\t'</span> OPTIONALLY ENCLOSED <span class="keyword">BY</span> <span class="string">'"'</span> LINES STARTING <span class="keyword">BY</span> <span class="string">'t222\t'</span> (id, name, age);</span><br><span class="line">Query OK, <span class="number">1024</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">1024</span>  Deleted: <span class="number">0</span>  Skipped: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">32</span>:<span class="number">53</span> &gt; <span class="keyword">select</span> count<span class="comment">(*) from t222;</span></span><br><span class="line"><span class="comment">+----------+</span></span><br><span class="line"><span class="comment">| count(*)</span> |</span><br><span class="line">+----------+</span><br><span class="line">|     <span class="number">1024</span> |</span><br><span class="line">+----------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">32</span>:<span class="number">59</span> &gt; <span class="keyword">select</span> * <span class="keyword">from</span> t222 limit <span class="number">10</span>;</span><br><span class="line">+----+---------+------+</span><br><span class="line">| id | name    | age  |</span><br><span class="line">+----+---------+------+</span><br><span class="line">|  <span class="number">1</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">2</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">3</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">4</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">6</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">7</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">8</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">9</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">| <span class="number">13</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">| <span class="number">14</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">+----+---------+------+</span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p><p>查看数据，数据恢复成功。从实验来看，当delete误操作，第一时间要保护好ibd数据，拷贝到其他目录。</p><h4 id="恢复脚本"><a href="#恢复脚本" class="headerlink" title="恢复脚本"></a>恢复脚本</h4><p>当误操作的数据量大时，constraints_parser恢复是单线程，速度较慢，此处引用了2个恢复脚本<br>详情请参考：<a href="http://www.orczhou.com/index.php/2013/07/how-to-recover-data-from-mysql-innodb-data-file-ibd-file/" target="_blank" rel="noopener">http://www.orczhou.com/index.php/2013/07/how-to-recover-data-from-mysql-innodb-data-file-ibd-file/</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># pwd</span></span><br><span class="line">/usr/src/percona-data-recovery-tool-for-innodb-0.5</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># cat parallel_exec.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">ws=/usr/src/percona-data-recovery-tool-for-innodb-0.5/</span><br><span class="line">pagedir=/usr/src/percona-data-recovery-tool-for-innodb-0.5/pages-1500255306/FIL_PAGE_INDEX</span><br><span class="line">logdir=/usr/src/percona-data-recovery-tool-for-innodb-0.5/<span class="built_in">log</span></span><br><span class="line">rectool=/usr/src/percona-data-recovery-tool-for-innodb-0.5/constraints_parser</span><br><span class="line"><span class="built_in">cd</span> `dirname <span class="variable">$rectool</span>`</span><br><span class="line">count=0</span><br><span class="line">page_count=353894</span><br><span class="line">page_done=0</span><br><span class="line">startdate=`date +%s`</span><br><span class="line"><span class="keyword">for</span> d1 <span class="keyword">in</span> `ls <span class="variable">$pagedir</span>`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  count=$((<span class="variable">$count</span>+1))</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"in page <span class="variable">$d2</span> at dir <span class="variable">$d1</span>"</span> &gt; <span class="variable">$logdir</span>/<span class="variable">$count</span>.<span class="built_in">log</span></span><br><span class="line">  thedate=`date +%s`</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$page_done</span> / <span class="variable">$page_count</span> at <span class="variable">$thedate</span> from <span class="variable">$startdate</span>"</span></span><br><span class="line">  total=`ls -l <span class="variable">$pagedir</span>/<span class="variable">$d1</span>/|wc -l`</span><br><span class="line">  page_done=$((<span class="variable">$page_done</span>+<span class="variable">$total</span>))</span><br><span class="line">  threads=`ps axu|grep parser_jobs|grep -v grep|wc -l`</span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$threads</span></span><br><span class="line">  <span class="keyword">while</span> [ <span class="variable">$threads</span> -gt 48 ];</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    sleep 1</span><br><span class="line">    threads=`ps axu|grep parser_jobs|grep -v grep|wc -l`</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="variable">$ws</span>/parser_jobs.sh <span class="variable">$pagedir</span>/<span class="variable">$d1</span> &gt; <span class="variable">$ws</span>/job.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># cat parser_jobs.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">pagedir=/usr/src/percona-data-recovery-tool-for-innodb-0.5/pages-1500255306/FIL_PAGE_INDEX</span><br><span class="line">logdir=/usr/src/percona-data-recovery-tool-for-innodb-0.5/<span class="built_in">log</span></span><br><span class="line">rectool=/usr/src/percona-data-recovery-tool-for-innodb-0.5/constraints_parser</span><br><span class="line">logfile=<span class="string">"<span class="variable">$logdir</span>/`basename <span class="variable">$1</span>`.log"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$1</span>"</span> &gt; <span class="variable">$logfile</span></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="variable">$1</span> ];<span class="keyword">then</span></span><br><span class="line">  <span class="keyword">for</span> d2 <span class="keyword">in</span> `ls <span class="variable">$1</span>`</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="variable">$rectool</span> -5 -f <span class="variable">$1</span>/<span class="variable">$d2</span> &gt;&gt; <span class="variable">$logfile</span> 2&gt;/dev/null</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># ./parallel_exec.sh </span></span><br><span class="line">0 / 353894 at 1500255771 from 1500255771</span><br><span class="line">0</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># ll log/</span></span><br><span class="line">总用量 296</span><br><span class="line">-rw-r--r-- 1 root root 296770 7月  17 09:42 0-41.log</span><br><span class="line">-rw-r--r-- 1 root root     21 7月  17 09:42 1.log</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># cat log/0-41.log |wc -l</span></span><br><span class="line">10001</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># head -10 log/0-41.log </span></span><br><span class="line">/usr/src/percona-data-recovery-tool-for-innodb-0.5/pages-1500255306/FIL_PAGE_INDEX/0-41</span><br><span class="line">employee        3670    3670    <span class="string">"test3670"</span></span><br><span class="line">employee        3671    3671    <span class="string">"test3671"</span></span><br><span class="line">employee        3672    3672    <span class="string">"test3672"</span></span><br><span class="line">employee        3673    3673    <span class="string">"test3673"</span></span><br><span class="line">employee        3674    3674    <span class="string">"test3674"</span></span><br><span class="line">employee        3675    3675    <span class="string">"test3675"</span></span><br><span class="line">employee        3676    3676    <span class="string">"test3676"</span></span><br><span class="line">employee        3677    3677    <span class="string">"test3677"</span></span><br><span class="line">employee        3678    3678    <span class="string">"test3678"</span></span><br></pre></td></tr></table></figure></p><p>用法：<br>1.修改脚本路<br>2.修改page_parser后的pages目录<br>3.创建log目录<br>4.执行parallel_exec脚本<br>5.注意，上面演示的示例，0-41.log中在第一行多了一句待恢复innodb页的路径，实际恢复中应删除  </p><h3 id="innodb-file-per-table-0"><a href="#innodb-file-per-table-0" class="headerlink" title="innodb_file_per_table=0"></a>innodb_file_per_table=0</h3><h4 id="模拟数据被误删除-1"><a href="#模拟数据被误删除-1" class="headerlink" title="模拟数据被误删除"></a>模拟数据被误删除</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># mysql -uroot -p123456 -e "show variables like 'innodb_file_per_table'"</span></span><br><span class="line">Warning: Using a password <span class="keyword">on</span> <span class="keyword">the</span> command line interface can be insecure.</span><br><span class="line">+<span class="comment">-----------------------+-------+</span></span><br><span class="line">| Variable_name         | Value |</span><br><span class="line">+<span class="comment">-----------------------+-------+</span></span><br><span class="line">| innodb_file_per_table | OFF   |</span><br><span class="line">+<span class="comment">-----------------------+-------+</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># mysql -uroot -p123456</span></span><br><span class="line">Warning: Using a password <span class="keyword">on</span> <span class="keyword">the</span> command line interface can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">9</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.6</span><span class="number">.36</span><span class="number">-82.0</span>-<span class="built_in">log</span> Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">58</span>:<span class="number">22</span> &gt; create database test111;</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">58</span>:<span class="number">31</span> &gt; use test111;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">58</span>:<span class="number">34</span> &gt; create table t222(<span class="built_in">id</span> int unsigned <span class="keyword">not</span> null auto_increment,<span class="built_in">name</span> varchar(<span class="number">20</span>),age int,primary key(`<span class="built_in">id</span>`),key idx_age(`age`)); </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">58</span>:<span class="number">52</span> &gt; insert <span class="keyword">into</span> t222 values(null,'jiessie',<span class="number">18</span>);   </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">58</span>:<span class="number">57</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">1</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">02</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">2</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">2</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">03</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">4</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">4</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">04</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">8</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">8</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">04</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;                                                                                       </span><br><span class="line">Query OK, <span class="number">16</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">16</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">06</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">32</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">32</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">07</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">64</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">64</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">07</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">128</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">128</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">08</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">256</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">256</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">08</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">512</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">512</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">09</span> &gt; select <span class="built_in">count</span><span class="comment">(*) from t222;</span></span><br><span class="line"><span class="comment">+<span class="comment">----------+</span></span></span><br><span class="line"><span class="comment">| count<span class="comment">(*) |</span></span></span><br><span class="line"><span class="comment"><span class="comment">+<span class="comment">----------+</span></span></span></span><br><span class="line"><span class="comment"><span class="comment">|     1024 |</span></span></span><br><span class="line"><span class="comment"><span class="comment">+<span class="comment">----------+</span></span></span></span><br><span class="line"><span class="comment"><span class="comment">1 row in set (0.00 sec)</span></span></span><br></pre></td></tr></table></figure><h4 id="解析ibd文件-1"><a href="#解析ibd文件-1" class="headerlink" title="解析ibd文件"></a>解析ibd文件</h4><p>实战mysql安装在/usr/local/percona，数据目录在/hwdata/data/percona，注意保存数据文件。<br>当设置了使用共享表空间(innodb_file_per_table=0)时，所有数据文件存在在ibdata1文件里面，不再是存在在单独表中，此时需要从ibdata1提取出需要被恢复的表<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]</span># ./<span class="selector-tag">page_parser</span> <span class="selector-tag">-5</span> <span class="selector-tag">-f</span> /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibdata1</span> </span><br><span class="line"><span class="selector-tag">Opening</span> <span class="selector-tag">file</span>: /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibdata1</span>:</span><br><span class="line"><span class="selector-tag">64513</span>           <span class="selector-tag">ID</span> <span class="selector-tag">of</span> <span class="selector-tag">device</span> <span class="selector-tag">containing</span> <span class="selector-tag">file</span></span><br><span class="line"><span class="selector-tag">1597426</span>         <span class="selector-tag">inode</span> <span class="selector-tag">number</span></span><br><span class="line"><span class="selector-tag">33184</span>           <span class="selector-tag">protection</span></span><br><span class="line"><span class="selector-tag">1</span>               <span class="selector-tag">number</span> <span class="selector-tag">of</span> <span class="selector-tag">hard</span> <span class="selector-tag">links</span></span><br><span class="line"><span class="selector-tag">0</span>               <span class="selector-tag">user</span> <span class="selector-tag">ID</span> <span class="selector-tag">of</span> <span class="selector-tag">owner</span></span><br><span class="line"><span class="selector-tag">0</span>               <span class="selector-tag">group</span> <span class="selector-tag">ID</span> <span class="selector-tag">of</span> <span class="selector-tag">owner</span></span><br><span class="line"><span class="selector-tag">0</span>               <span class="selector-tag">device</span> <span class="selector-tag">ID</span> (if special file)</span><br><span class="line"><span class="selector-tag">1073741824</span>              <span class="selector-tag">total</span> <span class="selector-tag">size</span>, <span class="selector-tag">in</span> <span class="selector-tag">bytes</span></span><br><span class="line"><span class="selector-tag">4096</span>            <span class="selector-tag">blocksize</span> <span class="selector-tag">for</span> <span class="selector-tag">filesystem</span> <span class="selector-tag">I</span>/<span class="selector-tag">O</span></span><br><span class="line"><span class="selector-tag">2097160</span>         <span class="selector-tag">number</span> <span class="selector-tag">of</span> <span class="selector-tag">blocks</span> <span class="selector-tag">allocated</span></span><br><span class="line"><span class="selector-tag">1500256783</span>      <span class="selector-tag">time</span> <span class="selector-tag">of</span> <span class="selector-tag">last</span> <span class="selector-tag">access</span></span><br><span class="line"><span class="selector-tag">1500256790</span>      <span class="selector-tag">time</span> <span class="selector-tag">of</span> <span class="selector-tag">last</span> <span class="selector-tag">modification</span></span><br><span class="line"><span class="selector-tag">1500256790</span>      <span class="selector-tag">time</span> <span class="selector-tag">of</span> <span class="selector-tag">last</span> <span class="selector-tag">status</span> <span class="selector-tag">change</span></span><br><span class="line"><span class="selector-tag">1073741824</span>      <span class="selector-tag">Size</span> <span class="selector-tag">to</span> <span class="selector-tag">process</span> <span class="selector-tag">in</span> <span class="selector-tag">bytes</span></span><br><span class="line"><span class="selector-tag">104857600</span>       <span class="selector-tag">Disk</span> <span class="selector-tag">cache</span> <span class="selector-tag">size</span> <span class="selector-tag">in</span> <span class="selector-tag">bytes</span></span><br><span class="line"><span class="selector-tag">1</span><span class="selector-class">.65</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:48</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">17666552</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">3</span><span class="selector-class">.41</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19000304</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">5</span><span class="selector-class">.18</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19005354</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">6</span><span class="selector-class">.96</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19008049</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">8</span><span class="selector-class">.73</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19015298</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">10</span><span class="selector-class">.47</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:45</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18719062</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">12</span><span class="selector-class">.24</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19008805</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">14</span><span class="selector-class">.01</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19009523</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">15</span><span class="selector-class">.78</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19007004</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">17</span><span class="selector-class">.55</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19008533</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">19</span><span class="selector-class">.32</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19008676</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">21</span><span class="selector-class">.06</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:45</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18715203</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">22</span><span class="selector-class">.83</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19007750</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">24</span><span class="selector-class">.60</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19002802</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">26</span><span class="selector-class">.37</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18998409</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">28</span><span class="selector-class">.14</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18991699</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">29</span><span class="selector-class">.88</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:45</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18708371</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">31</span><span class="selector-class">.65</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18999365</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">33</span><span class="selector-class">.42</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18997104</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">35</span><span class="selector-class">.19</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19001358</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">36</span><span class="selector-class">.96</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18999823</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">38</span><span class="selector-class">.73</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18997814</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">40</span><span class="selector-class">.47</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:45</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18706585</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">42</span><span class="selector-class">.24</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18996668</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">44</span><span class="selector-class">.01</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18998094</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">45</span><span class="selector-class">.78</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18998427</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">47</span><span class="selector-class">.55</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19002403</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">49</span><span class="selector-class">.30</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:45</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18724158</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">51</span><span class="selector-class">.06</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18997507</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">52</span><span class="selector-class">.83</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18999524</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">54</span><span class="selector-class">.60</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18998796</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">56</span><span class="selector-class">.37</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19000200</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">58</span><span class="selector-class">.14</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18998670</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">59</span><span class="selector-class">.88</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:45</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18699601</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">61</span><span class="selector-class">.65</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19000413</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">63</span><span class="selector-class">.42</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18997737</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">65</span><span class="selector-class">.19</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18996538</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">66</span><span class="selector-class">.96</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18999244</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">68</span><span class="selector-class">.70</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18704824</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">70</span><span class="selector-class">.47</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19002702</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">72</span><span class="selector-class">.24</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19002732</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">74</span><span class="selector-class">.01</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18999341</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">75</span><span class="selector-class">.78</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19001510</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">77</span><span class="selector-class">.55</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18998098</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">79</span><span class="selector-class">.29</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18706109</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">81</span><span class="selector-class">.06</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19007616</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">82</span><span class="selector-class">.83</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19007630</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">84</span><span class="selector-class">.60</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19004630</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">86</span><span class="selector-class">.37</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19004716</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">88</span><span class="selector-class">.12</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18717386</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">89</span><span class="selector-class">.89</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19005803</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">91</span><span class="selector-class">.66</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19007785</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">93</span><span class="selector-class">.43</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19006419</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">95</span><span class="selector-class">.20</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19004360</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">96</span><span class="selector-class">.97</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19008201</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">98</span><span class="selector-class">.73</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18940047</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-attr">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]</span># <span class="selector-tag">ll</span> <span class="selector-tag">-t</span></span><br><span class="line">总用量 <span class="selector-tag">3172</span></span><br><span class="line"><span class="selector-tag">drwxr-xr-x</span>  <span class="selector-tag">4</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>     <span class="selector-tag">4096</span> <span class="selector-tag">7</span>月  <span class="selector-tag">17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:18</span> <span class="selector-tag">pages-1500257904</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>  <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>   <span class="selector-tag">979051</span> <span class="selector-tag">7</span>月  <span class="selector-tag">17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:18</span> <span class="selector-tag">ibdconnect</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>  <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>    <span class="selector-tag">14873</span> <span class="selector-tag">7</span>月  <span class="selector-tag">17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:18</span> <span class="selector-tag">innochecksum</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>  <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>  <span class="selector-tag">1346155</span> <span class="selector-tag">7</span>月  <span class="selector-tag">17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:18</span> <span class="selector-tag">page_parser</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>  <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>   <span class="selector-tag">748761</span> <span class="selector-tag">7</span>月  <span class="selector-tag">17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:18</span> <span class="selector-tag">constraints_parser</span></span><br><span class="line"><span class="selector-tag">drwxr-xr-x</span>  <span class="selector-tag">2</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>     <span class="selector-tag">4096</span> <span class="selector-tag">7</span>月  <span class="selector-tag">17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:18</span> <span class="selector-tag">lib</span></span><br><span class="line"><span class="selector-tag">drwxr-xr-x</span> <span class="selector-tag">40</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">4096</span> <span class="selector-tag">7</span>月  <span class="selector-tag">17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:18</span> <span class="selector-tag">mysql-source</span></span><br><span class="line"><span class="selector-tag">drwxr-xr-x</span>  <span class="selector-tag">2</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">4096</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">docs</span></span><br><span class="line"><span class="selector-tag">drwxr-xr-x</span>  <span class="selector-tag">2</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">4096</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">include</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">6269</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">check_data</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>   <span class="selector-tag">22172</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">constraints_parser</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>   <span class="selector-tag">12051</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">create_defs</span><span class="selector-class">.pl</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">1978</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">fetch_data</span><span class="selector-class">.sh</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>   <span class="selector-tag">12200</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">ibdconnect</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">8262</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">incrementalupdate</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">9117</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">innochecksum</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>      <span class="selector-tag">74</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">INSTALL</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">2676</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">Makefile</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>   <span class="selector-tag">15239</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">page_parser</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>   <span class="selector-tag">10608</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">print_data</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>     <span class="selector-tag">302</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">split_dump</span><span class="selector-class">.pl</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">2046</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">tables_dict</span><span class="selector-class">.c</span></span><br></pre></td></tr></table></figure></p><h4 id="从ibdata1提取待恢复数据"><a href="#从ibdata1提取待恢复数据" class="headerlink" title="从ibdata1提取待恢复数据"></a>从ibdata1提取待恢复数据</h4><p>由于ibdata1恢复的是所有数据，需要从这些数据找到误操作的表，通过查询元数据，得到表空间的id和name<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># mysql -uroot -p123456 </span></span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 39</span><br><span class="line">Server version: 5.6.36-82.0-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 10:06:55 &gt; use information_schema;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [information_schema] 10:06:58 &gt; select i.INDEX_ID, i.NAME FROM INNODB_SYS_INDEXES as i INNER JOIN INNODB_SYS_TABLES as t USING(TABLE_ID) WHERE t.NAME='test111/t222';</span><br><span class="line">+----------+---------+</span><br><span class="line">| INDEX_ID | NAME    |</span><br><span class="line">+----------+---------+</span><br><span class="line">|      <span class="number"> 20 </span>| PRIMARY |</span><br><span class="line">|      <span class="number"> 21 </span>| idx_age |</span><br><span class="line">+----------+---------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [information_schema] 10:06:59 &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># ll pages-1500256968/FIL_PAGE_INDEX/</span></span><br><span class="line">总用量 68</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-1</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-11</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-12</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-13</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-14</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-15</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-16</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-17</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-18</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-19</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-2</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-20</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-21</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-3</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-4</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-5</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 4294967295-0</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p><h4 id="结果分析-1"><a href="#结果分析-1" class="headerlink" title="结果分析"></a>结果分析</h4><p>从下面的解析后的结果看到，当前目录pages-1500257904，其中20为主键索引的index_id,21为二级索引的index_id,该id可以通过开启innodb_table_monitor查看<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-<span class="number">0</span>.<span class="number">5</span>]# ll pages-<span class="number">1500256968</span>/FIL_PAGE_INDEX/<span class="number">0</span>-<span class="number">20</span>/</span><br><span class="line">总用量 <span class="number">128</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 15</span>-<span class="number">00000054</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 17</span>-<span class="number">00000056</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 18</span>-<span class="number">00000057</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 19</span>-<span class="number">00000058</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 20</span>-<span class="number">00000054</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 22</span>-<span class="number">00000057</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 23</span>-<span class="number">00000056</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 24</span>-<span class="number">00000058</span>.page</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-<span class="number">0</span>.<span class="number">5</span>]# ll pages-<span class="number">1500256968</span>/FIL_PAGE_INDEX/<span class="number">0</span>-<span class="number">21</span></span><br><span class="line">总用量 <span class="number">32</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 16</span>-<span class="number">00000055</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 21</span>-<span class="number">00000055</span>.page</span><br></pre></td></tr></table></figure></p><h4 id="生成表定义-1"><a href="#生成表定义-1" class="headerlink" title="生成表定义"></a>生成表定义</h4><p>由于该工具在解析数据pages的时候，需要获得该table的表结构定义，所以需要执行如下命令。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]<span class="comment"># ./create_defs.pl --host localhost --user root --password 123456 --db test111 --table t222 &gt; include/table_defs.h</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]<span class="comment"># cat include/table_defs.h</span></span><br><span class="line"><span class="comment">#ifndef table_defs_h</span></span><br><span class="line"><span class="comment">#define table_defs_h</span></span><br><span class="line"></span><br><span class="line">/<span class="regexp">/ Table definitions</span></span><br><span class="line"><span class="regexp">table_def_t table_definitions[] = &#123;</span></span><br><span class="line"><span class="regexp">        &#123;</span></span><br><span class="line"><span class="regexp">                name: "t222",</span></span><br><span class="line"><span class="regexp">                &#123;</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>* int(<span class="number">10</span>) unsigned *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "id",</span></span><br><span class="line"><span class="regexp">                                type: FT_UINT,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 4,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                has_limits: FALSE,</span></span><br><span class="line"><span class="regexp">                                limits: &#123;</span></span><br><span class="line"><span class="regexp">                                        can_be_null: FALSE,</span></span><br><span class="line"><span class="regexp">                                        uint_min_val: 0,</span></span><br><span class="line"><span class="regexp">                                        uint_max_val: 4294967295ULL</span></span><br><span class="line"><span class="regexp">                                &#125;,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: FALSE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>*  *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "DB_TRX_ID",</span></span><br><span class="line"><span class="regexp">                                type: FT_INTERNAL,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 6,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: FALSE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>*  *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "DB_ROLL_PTR",</span></span><br><span class="line"><span class="regexp">                                type: FT_INTERNAL,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 7,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: FALSE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>* varchar(<span class="number">20</span>) *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "name",</span></span><br><span class="line"><span class="regexp">                                type: FT_CHAR,</span></span><br><span class="line"><span class="regexp">                                min_length: 0,</span></span><br><span class="line"><span class="regexp">                                max_length: 60,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                has_limits: FALSE,</span></span><br><span class="line"><span class="regexp">                                limits: &#123;</span></span><br><span class="line"><span class="regexp">                                        can_be_null: TRUE,</span></span><br><span class="line"><span class="regexp">                                        char_min_len: 0,</span></span><br><span class="line"><span class="regexp">                                        char_max_len: 60,</span></span><br><span class="line"><span class="regexp">                                        char_ascii_only: TRUE</span></span><br><span class="line"><span class="regexp">                                &#125;,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: TRUE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>* int(<span class="number">11</span>) *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "age",</span></span><br><span class="line"><span class="regexp">                                type: FT_INT,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 4,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                has_limits: FALSE,</span></span><br><span class="line"><span class="regexp">                                limits: &#123;</span></span><br><span class="line"><span class="regexp">                                        can_be_null: TRUE,</span></span><br><span class="line"><span class="regexp">                                        int_min_val: -2147483648LL,</span></span><br><span class="line"><span class="regexp">                                        int_max_val: 2147483647LL</span></span><br><span class="line"><span class="regexp">                                &#125;,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: TRUE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; type: FT_NONE &#125;</span></span><br><span class="line"><span class="regexp">                &#125;</span></span><br><span class="line"><span class="regexp">        &#125;,</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">#endif</span></span><br><span class="line"><span class="regexp">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# </span></span><br><span class="line"><span class="regexp">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# make</span></span><br><span class="line"><span class="regexp">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c tables_dict.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c check_data.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">check_data</span>.<span class="title">o</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -o constraints_parser constraints_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">print_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">check_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span> <span class="title">lib</span>/<span class="title">libmystrings</span>.<span class="title">a</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -static -lrt -o page_parser page_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span> </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]<span class="comment"># make</span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c tables_dict.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c print_data.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">print_data</span>.<span class="title">o</span> </span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -o constraints_parser constraints_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">print_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">check_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span> <span class="title">lib</span>/<span class="title">libmystrings</span>.<span class="title">a</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -static -lrt -o page_parser page_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span></span></span><br></pre></td></tr></table></figure></p><p>上面的命令会将t222表的表定义传入到table_defs.h中，在生成了表结构定义后，重新make该恢复工具  </p><p><font color="#dd0000">注意：需要make 2次</font><br> </p><h4 id="开始提取page中删除的数据-1"><a href="#开始提取page中删除的数据-1" class="headerlink" title="开始提取page中删除的数据"></a>开始提取page中删除的数据</h4><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># ./constraints_parser -5 -f pages-1500258331/FIL_PAGE_INDEX/0-20/ &gt; /tmp/0_t222.sql            </span></span><br><span class="line">LOAD DATA INFILE <span class="string">'/usr/src/percona-data-recovery-tool-for-innodb-0.5/dumps/default/t222'</span> REPLACE INTO TABLE `<span class="javascript">t222</span>` FIELDS TERMINATED BY <span class="string">'\t'</span> OPTIONALLY ENCLOSED BY <span class="string">'"'</span> LINES STARTING BY <span class="string">'t222\t'</span> (id, name, age);</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># cat /tmp/0_t222.sql |wc -l</span></span><br><span class="line"><span class="number">2048</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># head -10 /tmp/0_t222.sql </span></span><br><span class="line">t222    <span class="number">1145</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1146</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1147</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1148</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1149</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1150</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1151</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1152</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1153</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1154</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br></pre></td></tr></table></figure><p>从结果上来看，数据重复了一份，通过load data导入只导入一份正常的数据<br>参数解释：<br>-5 -f的参数和page_parser相同，代表 row format为Compact ；<br>-D:该参数的含义为代表恢复删除的数据页； </p><h4 id="恢复数据-1"><a href="#恢复数据-1" class="headerlink" title="恢复数据"></a>恢复数据</h4><p>使用上面constraints_parser执行后的load data导入数据，需要注意目录<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]# mysql -uroot -p123456</span><br><span class="line">Warning: <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line <span class="keyword">interface</span> can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">108</span></span><br><span class="line">Server version: <span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">10</span>:<span class="number">28</span>:<span class="number">16</span> &gt; use test111;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [test111] <span class="number">10</span>:<span class="number">28</span>:<span class="number">20</span> &gt; LOAD DATA INFILE <span class="string">'/tmp/0_t222.sql'</span> REPLACE <span class="keyword">INTO</span> TABLE `t222` FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">'\t'</span> OPTIONALLY ENCLOSED <span class="keyword">BY</span> <span class="string">'"'</span> LINES STARTING <span class="keyword">BY</span> <span class="string">'t222\t'</span> (id, name, age);</span><br><span class="line">Query OK, <span class="number">2048</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">2048</span>  Deleted: <span class="number">0</span>  Skipped: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">10</span>:<span class="number">28</span>:<span class="number">39</span> &gt; <span class="keyword">select</span> count<span class="comment">(*) from t222;</span></span><br><span class="line"><span class="comment">+----------+</span></span><br><span class="line"><span class="comment">| count(*)</span> |</span><br><span class="line">+----------+</span><br><span class="line">|     <span class="number">1024</span> |</span><br><span class="line">+----------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">10</span>:<span class="number">28</span>:<span class="number">44</span> &gt; <span class="keyword">select</span> * <span class="keyword">from</span> t222 limit <span class="number">10</span>;</span><br><span class="line">+----+---------+------+</span><br><span class="line">| id | name    | age  |</span><br><span class="line">+----+---------+------+</span><br><span class="line">|  <span class="number">1</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">2</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">3</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">4</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">6</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">7</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">8</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">9</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">| <span class="number">13</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">| <span class="number">14</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">+----+---------+------+</span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p><p>从结果看，数据恢复完成   </p><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>Percona Data Recovery Tool for InnoDB工具并不保证100%能够恢复数据，而且会存在丢失数据的现象，特别是当发生误删除后，数据文件并没有第一时间保存起来，而导致了被重写。truncate操作在此不做演示，建议还是做好备份恢复工作，并做日常的演练。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;数据是一个企业最重要的资产，备份的重要性不言而喻，有效的备份能够减少意外情况下的公司损失。当使用MySQL数据库时，mysqldump、my
      
    
    </summary>
    
      <category term="备份恢复" scheme="https://dwj999.github.io/categories/%E5%A4%87%E4%BB%BD%E6%81%A2%E5%A4%8D/"/>
    
    
      <category term="percona" scheme="https://dwj999.github.io/tags/percona/"/>
    
      <category term="innodb" scheme="https://dwj999.github.io/tags/innodb/"/>
    
      <category term="recovery" scheme="https://dwj999.github.io/tags/recovery/"/>
    
  </entry>
  
  <entry>
    <title>percona server 5.6 自制rpm包</title>
    <link href="https://dwj999.github.io/percona-server-5-6-%E8%87%AA%E5%88%B6rpm%E5%8C%85.html"/>
    <id>https://dwj999.github.io/percona-server-5-6-自制rpm包.html</id>
    <published>2017-07-13T08:55:24.000Z</published>
    <updated>2020-05-20T03:48:36.922Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>RPM是Red-hat系统的软件管理工具，目前，RPM已发展成为业界认可的Linux系统软件工具。RPM制作灵活方便，在安装、升级、卸载等方面有着显著的优点。mysql通过自制RPM包方式，可以缩短编译安装时间，简化安装过程，自定义数据库配置，非常灵活方便，可以极大的提升效率。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">优点：</span><br><span class="line">RPM内含已编译过的程序与设置文件等数据，可以让用户免除重新编译的困扰。</span><br><span class="line">RPM在被安装之前，会先检查系统的硬盘容量、操作系统版本等，可避免文件被错误安装。</span><br><span class="line">RPM文件本身提供软件版本信息、依赖属性软件名称、软件用途说明、软件所含文件信息，便于了解软件。</span><br><span class="line">RPM管理的方式使用数据库记录RPM文件的相关参数，便于升级、删除、查询与验证。</span><br><span class="line">详情请参考：<span class="string">http:</span><span class="comment">//rpm.org/documentation.html</span></span><br></pre></td></tr></table></figure></p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：centos 6.5 x86_64<br>构建工具：rpmbuild</p><h2 id="RPM常用命令"><a href="#RPM常用命令" class="headerlink" title="RPM常用命令"></a>RPM常用命令</h2><h3 id="列出已安装的RPM包"><a href="#列出已安装的RPM包" class="headerlink" title="列出已安装的RPM包"></a>列出已安装的RPM包</h3><h4 id="列出系统中已安装的全部RPM包"><a href="#列出系统中已安装的全部RPM包" class="headerlink" title="列出系统中已安装的全部RPM包"></a>列出系统中已安装的全部RPM包</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -qa|head <span class="number">-10</span>  #由于包太多，用head过滤了前<span class="number">10</span>条</span><br><span class="line">glib2<span class="number">-2.28</span><span class="number">.8</span><span class="number">-5.</span>el6.x86_64</span><br><span class="line">gnome-icon-theme<span class="number">-2.28</span><span class="number">.0</span><span class="number">-8.</span>el6.noarch</span><br><span class="line">bind-libs<span class="number">-9.8</span><span class="number">.2</span><span class="number">-0.23</span>.rc1.el6_5<span class="number">.1</span>.x86_64</span><br><span class="line">mhash<span class="number">-0.9</span><span class="number">.9</span><span class="number">.9</span><span class="number">-3.</span>el6.x86_64</span><br><span class="line">libreport<span class="number">-2.0</span><span class="number">.9</span><span class="number">-19.</span>el6.centos.x86_64</span><br><span class="line">libcroco<span class="number">-0.6</span><span class="number">.2</span><span class="number">-5.</span>el6.x86_64</span><br><span class="line">libcap<span class="number">-2.16</span><span class="number">-5.5</span>.el6.x86_64</span><br><span class="line">libxml2-python<span class="number">-2.7</span><span class="number">.6</span><span class="number">-21.</span>el6_8<span class="number">.1</span>.x86_64</span><br><span class="line">abrt-addon-kerneloops<span class="number">-2.0</span><span class="number">.8</span><span class="number">-21.</span>el6.centos.x86_64</span><br><span class="line">libasyncns<span class="number">-0.8</span><span class="number">-1.1</span>.el6.x86_64</span><br></pre></td></tr></table></figure><h4 id="列出系统中以mysql开头的RPM包"><a href="#列出系统中以mysql开头的RPM包" class="headerlink" title="列出系统中以mysql开头的RPM包"></a>列出系统中以mysql开头的RPM包</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@iZuf6c08fdv8duubho2b0rZ ~]</span># <span class="selector-tag">rpm</span> <span class="selector-tag">-qa</span> "<span class="selector-tag">mysql</span>*"</span><br><span class="line"><span class="selector-tag">mysql-community-libs-5</span><span class="selector-class">.7</span><span class="selector-class">.16-1</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span></span><br><span class="line"><span class="selector-tag">mysql-libs-5</span><span class="selector-class">.1</span><span class="selector-class">.73-3</span><span class="selector-class">.el6_5</span><span class="selector-class">.x86_64</span></span><br><span class="line"><span class="selector-tag">mysql-devel-5</span><span class="selector-class">.1</span><span class="selector-class">.73-8</span><span class="selector-class">.el6_8</span><span class="selector-class">.x86_64</span></span><br><span class="line"><span class="selector-tag">mysql-5</span><span class="selector-class">.7</span><span class="selector-class">.17-1</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span></span><br></pre></td></tr></table></figure><h4 id="列出系统中包括mysql关键字的RPM包"><a href="#列出系统中包括mysql关键字的RPM包" class="headerlink" title="列出系统中包括mysql关键字的RPM包"></a>列出系统中包括mysql关键字的RPM包</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -qa|grep <span class="string">"mysql"</span>  </span><br><span class="line">php56w-mysql<span class="number">-5.6</span><span class="number">.30</span><span class="number">-1.</span>w6.x86_64</span><br><span class="line">mysql-community-libs<span class="number">-5.7</span><span class="number">.16</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">zabbix-server-mysql<span class="number">-3.0</span><span class="number">.9</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">mysql-libs<span class="number">-5.1</span><span class="number">.73</span><span class="number">-3.</span>el6_5.x86_64</span><br><span class="line">mysql-devel<span class="number">-5.1</span><span class="number">.73</span><span class="number">-8.</span>el6_8.x86_64</span><br><span class="line">mysql<span class="number">-5.7</span><span class="number">.17</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">zabbix-web-mysql<span class="number">-3.0</span><span class="number">.9</span><span class="number">-1.</span>el6.noarch</span><br></pre></td></tr></table></figure><h4 id="列出系统中近期安装的RPM包"><a href="#列出系统中近期安装的RPM包" class="headerlink" title="列出系统中近期安装的RPM包"></a>列出系统中近期安装的RPM包</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -qa --last | head </span><br><span class="line">tree<span class="number">-1.5</span><span class="number">.3</span><span class="number">-3.</span>el6.x86_64                       <span class="number">2017</span>年<span class="number">07</span>月<span class="number">13</span>日 星期四 <span class="number">09</span>时<span class="number">35</span>分<span class="number">13</span>秒</span><br><span class="line">git<span class="number">-1.7</span><span class="number">.1</span><span class="number">-8.</span>el6.x86_64                        <span class="number">2017</span>年<span class="number">07</span>月<span class="number">12</span>日 星期三 <span class="number">10</span>时<span class="number">29</span>分<span class="number">20</span>秒</span><br><span class="line">perl-Git<span class="number">-1.7</span><span class="number">.1</span><span class="number">-8.</span>el6.noarch                   <span class="number">2017</span>年<span class="number">07</span>月<span class="number">12</span>日 星期三 <span class="number">10</span>时<span class="number">29</span>分<span class="number">19</span>秒</span><br><span class="line">elfutils<span class="number">-0.164</span><span class="number">-2.</span>el6.x86_64                   <span class="number">2017</span>年<span class="number">07</span>月<span class="number">11</span>日 星期二 <span class="number">10</span>时<span class="number">30</span>分<span class="number">26</span>秒</span><br><span class="line">perf<span class="number">-2.6</span><span class="number">.32</span><span class="number">-696.3</span><span class="number">.2</span>.el6.x86_64                <span class="number">2017</span>年<span class="number">07</span>月<span class="number">11</span>日 星期二 <span class="number">10</span>时<span class="number">30</span>分<span class="number">25</span>秒</span><br><span class="line">elfutils-libs<span class="number">-0.164</span><span class="number">-2.</span>el6.x86_64              <span class="number">2017</span>年<span class="number">07</span>月<span class="number">11</span>日 星期二 <span class="number">10</span>时<span class="number">30</span>分<span class="number">25</span>秒</span><br><span class="line">elfutils-libelf<span class="number">-0.164</span><span class="number">-2.</span>el6.x86_64            <span class="number">2017</span>年<span class="number">07</span>月<span class="number">11</span>日 星期二 <span class="number">10</span>时<span class="number">30</span>分<span class="number">25</span>秒</span><br><span class="line">pmm-client<span class="number">-1.1</span><span class="number">.6</span><span class="number">-1.</span>x86_64                     <span class="number">2017</span>年<span class="number">07</span>月<span class="number">10</span>日 星期一 <span class="number">16</span>时<span class="number">58</span>分<span class="number">04</span>秒</span><br><span class="line">gcc-gfortran<span class="number">-4.4</span><span class="number">.7</span><span class="number">-18.</span>el6.x86_64              <span class="number">2017</span>年<span class="number">07</span>月<span class="number">06</span>日 星期四 <span class="number">15</span>时<span class="number">40</span>分<span class="number">43</span>秒</span><br><span class="line">gcc-c++<span class="number">-4.4</span><span class="number">.7</span><span class="number">-18.</span>el6.x86_64                   <span class="number">2017</span>年<span class="number">07</span>月<span class="number">06</span>日 星期四 <span class="number">15</span>时<span class="number">40</span>分<span class="number">43</span>秒</span><br></pre></td></tr></table></figure><h3 id="查找特定RPM包"><a href="#查找特定RPM包" class="headerlink" title="查找特定RPM包"></a>查找特定RPM包</h3><h4 id="查找某RPM包是否安装"><a href="#查找某RPM包是否安装" class="headerlink" title="查找某RPM包是否安装"></a>查找某RPM包是否安装</h4><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># rpm -q mysql-server</span></span><br><span class="line">package mysql-server <span class="keyword">is</span> <span class="keyword">not</span> installed</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># rpm -q zabbix</span></span><br><span class="line">package zabbix <span class="keyword">is</span> <span class="keyword">not</span> installed</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># rpm -q gcc</span></span><br><span class="line">gcc<span class="number">-4.4</span><span class="number">.7</span><span class="number">-18.</span>el6.x86_64</span><br></pre></td></tr></table></figure><h4 id="查找某RPM包的基本信息"><a href="#查找某RPM包的基本信息" class="headerlink" title="查找某RPM包的基本信息"></a>查找某RPM包的基本信息</h4><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -q percona-server</span><br><span class="line">percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.x86_64</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# </span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -qi percona-server</span><br><span class="line">Name        : <span class="type">percona</span>-server               Relocations: /usr/local/percona </span><br><span class="line">Version     : 5.6.36                            <span class="type">Vendor</span>: Jiessie</span><br><span class="line">Release     : 82.0                          <span class="type">Build</span> Date: <span class="number">2017</span>年<span class="number">06</span>月<span class="number">20</span>日 星期二 <span class="number">13</span>时<span class="number">08</span>分<span class="number">20</span>秒</span><br><span class="line">Install Date: <span class="number">2017</span>年<span class="number">06</span>月<span class="number">20</span>日 星期二 <span class="number">13</span>时<span class="number">42</span>分<span class="number">36</span>秒      Build Host: iZuf6c08fdv8duubho2b0rZ</span><br><span class="line">Group       : <span class="type">applications</span>/database         Source RPM: percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.src.rpm</span><br><span class="line">Size        : 460543421                        <span class="type">License</span>: GPL</span><br><span class="line">Signature   : (<span class="type">none</span>)</span><br><span class="line">Packager    : <span class="type">dwj999</span>@<span class="number">163</span>.com</span><br><span class="line">URL         : <span class="type">https</span>://www.percona.com/downloads/Percona-Server-<span class="number">5.6</span>/Percona-Server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>/source/tarball/percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.tar.gz</span><br><span class="line">Summary     : <span class="type">percona</span>-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span></span><br><span class="line">Description :</span><br><span class="line">Percona Server <span class="keyword">is</span> an enhanced, drop-<span class="keyword">in</span> MySQL® replacement which has been downloaded more than <span class="number">1</span>,<span class="number">000</span>,<span class="number">000</span> times.</span><br><span class="line">A free open source solution, Percona Server <span class="keyword">is</span> a MySQL alternative which offers breakthrough performance, scalability, features, <span class="keyword">and</span> instrumentation. Self-tuning algorithms <span class="keyword">and</span> support <span class="keyword">for</span> extremely high-performance hardware make it the clear choice <span class="keyword">for</span> organizations that demand excellent performance <span class="keyword">and</span> reliability from their MySQL database server.</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]#</span><br></pre></td></tr></table></figure><h4 id="查找某RPM包的配置信息"><a href="#查找某RPM包的配置信息" class="headerlink" title="查找某RPM包的配置信息"></a>查找某RPM包的配置信息</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -qc httpd</span><br><span class="line">/etc/httpd/<span class="keyword">conf</span>.<span class="keyword">d</span>/welcome.<span class="keyword">conf</span></span><br><span class="line">/etc/httpd/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span></span><br><span class="line">/etc/httpd/<span class="keyword">conf</span>/magic</span><br><span class="line">/etc/logrotate.<span class="keyword">d</span>/httpd</span><br><span class="line">/etc/sysconfig/htcacheclean</span><br><span class="line">/etc/sysconfig/httpd</span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_BAD_GATEWAY.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_BAD_REQUEST.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_FORBIDDEN.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_GONE.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_INTERNAL_SERVER_ERROR.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_LENGTH_REQUIRED.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_METHOD_NOT_ALLOWED.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_NOT_FOUND.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_NOT_IMPLEMENTED.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_PRECONDITION_FAILED.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_REQUEST_ENTITY_TOO_LARGE.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_REQUEST_TIME_OUT.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_REQUEST_URI_TOO_LARGE.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_SERVICE_UNAVAILABLE.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_UNAUTHORIZED.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_UNSUPPORTED_MEDIA_TYPE.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_VARIANT_ALSO_VARIES.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/contact.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/<span class="keyword">include</span>/bottom.html</span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/<span class="keyword">include</span>/spacer.html</span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/<span class="keyword">include</span>/top.html</span><br></pre></td></tr></table></figure><h4 id="查找某RPM包的文档信息"><a href="#查找某RPM包的文档信息" class="headerlink" title="查找某RPM包的文档信息"></a>查找某RPM包的文档信息</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="meta"># rpm -qd httpd</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>httpd<span class="number">-2.2</span><span class="number">.15</span>/ABOUT_APACHE</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>httpd<span class="number">-2.2</span><span class="number">.15</span>/CHANGES</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>httpd<span class="number">-2.2</span><span class="number">.15</span>/LICENSE</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>httpd<span class="number">-2.2</span><span class="number">.15</span>/NOTICE</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>httpd<span class="number">-2.2</span><span class="number">.15</span>/README</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>httpd<span class="number">-2.2</span><span class="number">.15</span>/VERSIONING</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man8/apachectl<span class="number">.8</span>.gz</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man8/htcacheclean<span class="number">.8</span>.gz</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man8/httpd<span class="number">.8</span>.gz</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man8/rotatelogs<span class="number">.8</span>.gz</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man8/suexec<span class="number">.8</span>.gz</span><br></pre></td></tr></table></figure><h4 id="查找某RPM包的状态"><a href="#查找某RPM包的状态" class="headerlink" title="查找某RPM包的状态"></a>查找某RPM包的状态</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="meta"># rpm -qs rsync</span></span><br><span class="line">normal        <span class="meta-keyword">/etc/</span>xinetd.d/rsync</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>bin/rsync</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span></span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/COPYING</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/NEWS</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/OLDNEWS</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/README</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/support</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>Makefile</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>atomic-rsync</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>cvs2includes</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>deny-rsync</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>file-attr-restore</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>files-to-excludes</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>git-set-file-times</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>logfilter</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>lsh</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>mnt-excl</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>munge-symlinks</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>rrsync</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>rsyncstats</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>savetransfer.c</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/tech_report.tex</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man1/rsync<span class="number">.1</span>.gz</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man5/rsyncd.conf<span class="number">.5</span>.gz</span><br></pre></td></tr></table></figure><p>RPM包的状态</p><table><thead><tr><th>状态</th><th>说明 </th></tr></thead><tbody><tr><td>Normal</td><td>正常，表明文件未被其他软件包修改过</td></tr><tr><td>not installed</td><td>未安装，表明文件未安装</td></tr><tr><td>Replaced</td><td>已替换，表明文件已被其他软件包修改替换过，不再是原先的文件</td></tr><tr><td>net shared</td><td>网络共享，表明文件处于网络共享状态</td></tr></tbody></table><h4 id="查找某RPM包的所有文件"><a href="#查找某RPM包的所有文件" class="headerlink" title="查找某RPM包的所有文件"></a>查找某RPM包的所有文件</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="meta"># rpm -ql rsync</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>xinetd.d/rsync</span><br><span class="line"><span class="meta-keyword">/usr/</span>bin/rsync</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/COPYING</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/NEWS</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/OLDNEWS</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/README</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/support</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>Makefile</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>atomic-rsync</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>cvs2includes</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>deny-rsync</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>file-attr-restore</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>files-to-excludes</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>git-set-file-times</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>logfilter</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>lsh</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>mnt-excl</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>munge-symlinks</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>rrsync</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>rsyncstats</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>savetransfer.c</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/tech_report.tex</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man1/rsync<span class="number">.1</span>.gz</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man5/rsyncd.conf<span class="number">.5</span>.gz</span><br></pre></td></tr></table></figure><h4 id="查找某RPM包的安装、卸载前后的脚本"><a href="#查找某RPM包的安装、卸载前后的脚本" class="headerlink" title="查找某RPM包的安装、卸载前后的脚本"></a>查找某RPM包的安装、卸载前后的脚本</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -q --scripts httpd         </span><br><span class="line">preinstall scriptlet (using /bin/sh):</span><br><span class="line"><span class="comment"># Add the "apache" user</span></span><br><span class="line">getent<span class="built_in"> group </span>apache &gt;/dev/<span class="literal">null</span> || groupadd -g 48 -r apache</span><br><span class="line">getent passwd apache &gt;/dev/<span class="literal">null</span> || \</span><br><span class="line">  useradd -r -u 48 -g apache -s /sbin/nologin \</span><br><span class="line">    -d /var/www -c <span class="string">"Apache"</span> apache</span><br><span class="line">exit 0</span><br><span class="line">postinstall scriptlet (using /bin/sh):</span><br><span class="line"><span class="comment"># Register the httpd service</span></span><br><span class="line">/sbin/chkconfig --<span class="builtin-name">add</span> httpd</span><br><span class="line">/sbin/chkconfig --<span class="builtin-name">add</span> htcacheclean</span><br><span class="line">preuninstall scriptlet (using /bin/sh):</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> = 0 ]; then</span><br><span class="line">        /sbin<span class="built_in">/service </span>httpd stop &gt; /dev/<span class="literal">null</span> 2&gt;&amp;1</span><br><span class="line">        /sbin/chkconfig --del httpd</span><br><span class="line">        /sbin<span class="built_in">/service </span>htcacheclean stop &gt; /dev/<span class="literal">null</span> 2&gt;&amp;1</span><br><span class="line">        /sbin/chkconfig --del htcacheclean</span><br><span class="line">fi</span><br><span class="line">posttrans scriptlet (using /bin/sh):</span><br><span class="line">test -f /etc/sysconfig/httpd-disable-posttrans || \</span><br><span class="line"> /sbin<span class="built_in">/service </span>httpd condrestart &gt;/dev/<span class="literal">null</span> 2&gt;&amp;1 || :</span><br></pre></td></tr></table></figure><h4 id="查找某RPM包的修改历史"><a href="#查找某RPM包的修改历史" class="headerlink" title="查找某RPM包的修改历史"></a>查找某RPM包的修改历史</h4><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># rpm -q --changelog python |head -10</span></span><br><span class="line">* 二 <span class="number">8</span>月 <span class="number">09</span> <span class="number">2016</span> Charalampos Stratakis &lt;cstratak@redhat.com&gt; - <span class="number">2.6</span><span class="number">.6</span><span class="number">-66</span></span><br><span class="line">- Fix <span class="keyword">for</span> CVE<span class="number">-2016</span><span class="number">-1000110</span> HTTPoxy attack</span><br><span class="line">Resolves: rhbz<span class="comment">#1359161</span></span><br><span class="line"></span><br><span class="line">* 二 <span class="number">6</span>月 <span class="number">21</span> <span class="number">2016</span> Tomas Orsava &lt;torsava@redhat.com&gt; - <span class="number">2.6</span><span class="number">.6</span><span class="number">-65</span></span><br><span class="line">- Fix <span class="keyword">for</span> CVE<span class="number">-2016</span><span class="number">-0772</span> python: smtplib StartTLS stripping attack (rhbz<span class="comment">#1303647)</span></span><br><span class="line">  Raise an error <span class="keyword">when</span> STARTTLS fails (upstream patch)</span><br><span class="line">- Fix <span class="keyword">for</span> CVE<span class="number">-2016</span><span class="number">-5699</span> python: http protocol steam injection attack (rhbz<span class="comment">#1303699)</span></span><br><span class="line">  Disabled HTTP header injections <span class="keyword">in</span> httplib (upstream patch)</span><br><span class="line">Resolves: rhbz<span class="comment">#1346354</span></span><br></pre></td></tr></table></figure><h4 id="查找某个组群里的RPM包"><a href="#查找某个组群里的RPM包" class="headerlink" title="查找某个组群里的RPM包"></a>查找某个组群里的RPM包</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -qg Applications/Databases </span><br><span class="line">db4-utils<span class="number">-4.7</span><span class="number">.25</span><span class="number">-18.</span>el6_4.x86_64</span><br><span class="line">mysql-libs<span class="number">-5.1</span><span class="number">.73</span><span class="number">-3.</span>el6_5.x86_64</span><br><span class="line">percona-xtrabackup<span class="number">-2.3</span><span class="number">.6</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">Percona-Server-client<span class="number">-51</span><span class="number">-5.1</span><span class="number">.73</span>-rel14<span class="number">.12</span><span class="number">.624</span>.rhel6.x86_64</span><br><span class="line">rh-postgresql95-postgresql-libs<span class="number">-9.5</span><span class="number">.4</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">postgresql95-libs<span class="number">-9.5</span><span class="number">.5</span><span class="number">-1</span>PGDG.rhel6.x86_64</span><br><span class="line">postgresql95<span class="number">-9.5</span><span class="number">.5</span><span class="number">-1</span>PGDG.rhel6.x86_64</span><br><span class="line">postgresql95-contrib<span class="number">-9.5</span><span class="number">.5</span><span class="number">-1</span>PGDG.rhel6.x86_64</span><br><span class="line">postgresql95-server<span class="number">-9.5</span><span class="number">.5</span><span class="number">-1</span>PGDG.rhel6.x86_64</span><br><span class="line">sqlite<span class="number">-3.6</span><span class="number">.20</span><span class="number">-1.</span>el6_7<span class="number">.2</span>.x86_64</span><br><span class="line">mongodb<span class="number">-2.4</span><span class="number">.14</span><span class="number">-4.</span>el6.x86_64</span><br><span class="line">mongodb-server<span class="number">-2.4</span><span class="number">.14</span><span class="number">-4.</span>el6.x86_64</span><br><span class="line">mysql-devel<span class="number">-5.1</span><span class="number">.73</span><span class="number">-8.</span>el6_8.x86_64</span><br><span class="line">innotop<span class="number">-1.11</span><span class="number">.4</span><span class="number">-1.</span>el6.noarch</span><br><span class="line">Percona-Server-shared<span class="number">-56</span><span class="number">-5.6</span><span class="number">.35</span>-rel80<span class="number">.0</span>.el6.x86_64</span><br><span class="line">mysql-community-libs<span class="number">-5.7</span><span class="number">.16</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">redis<span class="number">-2.4</span><span class="number">.10</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">percona-toolkit<span class="number">-3.0</span><span class="number">.3</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">percona-zabbix-templates<span class="number">-1.1</span><span class="number">.7</span><span class="number">-2.</span>noarch</span><br><span class="line">pmm-client<span class="number">-1.1</span><span class="number">.6</span><span class="number">-1.</span>x86_64</span><br></pre></td></tr></table></figure><p>通常，RPM 可以分为这几大类：娱乐（Amusement）、开发（Development）、文档（Document）、硬件（Hardware）、综合包（Metapackages）、多媒体（Multimedia）、生产力（Productivity）和系统（System）。</p><h3 id="查询特定RPM包依赖"><a href="#查询特定RPM包依赖" class="headerlink" title="查询特定RPM包依赖"></a>查询特定RPM包依赖</h3><h4 id="查询RPM包依赖"><a href="#查询RPM包依赖" class="headerlink" title="查询RPM包依赖"></a>查询RPM包依赖</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -q --requires percona-server</span><br><span class="line">coreutils  </span><br><span class="line">shadow-utils  </span><br><span class="line">/bin/sh  </span><br><span class="line">/bin/sh  </span><br><span class="line">/bin/sh  </span><br><span class="line">/bin/sh  </span><br><span class="line">rpmlib(FileDigests) &lt;= <span class="number">4.6</span><span class="number">.0</span><span class="number">-1</span></span><br><span class="line">rpmlib(PayloadFilesHavePrefix) &lt;= <span class="number">4.0</span><span class="number">-1</span></span><br><span class="line">rpmlib(CompressedFileNames) &lt;= <span class="number">3.0</span><span class="number">.4</span><span class="number">-1</span></span><br><span class="line">rpmlib(PayloadIsXz) &lt;= <span class="number">5.2</span><span class="number">-1</span></span><br></pre></td></tr></table></figure><h4 id="查询RPM包提供"><a href="#查询RPM包提供" class="headerlink" title="查询RPM包提供"></a>查询RPM包提供</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -q --provides percona-server</span><br><span class="line">adt_null.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">audit_log.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">auth.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">auth_socket.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">auth_test_plugin.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">connection_control.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">ha_tokudb.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">handlersocket.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">innodb_engine.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libHotBackup.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libdaemon_example.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libfnv1a_udf.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libfnv_udf.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libmemcached.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libmurmur_udf.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libperconaserverclient.<span class="keyword">so</span>.<span class="number">18</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libperconaserverclient.<span class="keyword">so</span>.<span class="number">18</span>(libperconaserverclient_18)(<span class="number">64</span>bit)  </span><br><span class="line">mypluglib.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">mysql_no_login.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line"><span class="keyword">perl</span>(My::Config)  </span><br><span class="line"><span class="keyword">perl</span>(My::Confi<span class="variable">g:</span>:Group)  </span><br><span class="line"><span class="keyword">perl</span>(My::Confi<span class="variable">g:</span>:Option)  </span><br><span class="line"><span class="keyword">perl</span>(My::ConfigFactory)  </span><br><span class="line"><span class="keyword">perl</span>(My::CoreDump)  </span><br><span class="line"><span class="keyword">perl</span>(My::Exec)  </span><br><span class="line"><span class="keyword">perl</span>(My::File::Path)  </span><br><span class="line"><span class="keyword">perl</span>(My::Find)  </span><br><span class="line"><span class="keyword">perl</span>(My::Handles)  </span><br><span class="line"><span class="keyword">perl</span>(My::Memcache)  </span><br><span class="line"><span class="keyword">perl</span>(My::Memcache::Binary)  </span><br><span class="line"><span class="keyword">perl</span>(My::Options)  </span><br><span class="line"><span class="keyword">perl</span>(My::Platform)  </span><br><span class="line"><span class="keyword">perl</span>(My::SafeProcess)  </span><br><span class="line"><span class="keyword">perl</span>(My::SafeProces<span class="variable">s:</span>:Base)  </span><br><span class="line"><span class="keyword">perl</span>(My::Suite::Query_response_time)  </span><br><span class="line"><span class="keyword">perl</span>(My::SysInfo)  </span><br><span class="line"><span class="keyword">perl</span>(My::Test)  </span><br><span class="line"><span class="keyword">perl</span>(Subunit) = <span class="number">0.0</span>.<span class="number">2</span></span><br><span class="line"><span class="keyword">perl</span>(mtr_cases)  </span><br><span class="line"><span class="keyword">perl</span>(mtr_match)  </span><br><span class="line"><span class="keyword">perl</span>(mtr_report)  </span><br><span class="line"><span class="keyword">perl</span>(mtr_results)  </span><br><span class="line"><span class="keyword">perl</span>(mtr_unique)  </span><br><span class="line">qa_auth_client.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">qa_auth_interface.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">qa_auth_server.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">query_response_time.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">semisync_master.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">semisync_slave.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">test_udf_services.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">tokudb_backup.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">validate_password.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">percona-server = <span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span></span><br><span class="line">percona-server(x86-<span class="number">64</span>) = <span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span></span><br></pre></td></tr></table></figure><h4 id="查询某依赖的RPM包"><a href="#查询某依赖的RPM包" class="headerlink" title="查询某依赖的RPM包"></a>查询某依赖的RPM包</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@iZuf6c08fdv8duubho2b0rZ ~]</span># <span class="selector-tag">rpm</span> <span class="selector-tag">-q</span> <span class="selector-tag">--whatrequires</span> <span class="selector-tag">openssl</span> </span><br><span class="line"><span class="selector-tag">postfix-2</span><span class="selector-class">.6</span><span class="selector-class">.6-6</span><span class="selector-class">.el6_5</span><span class="selector-class">.x86_64</span></span><br><span class="line"><span class="selector-tag">openssl-devel-1</span><span class="selector-class">.0</span><span class="selector-class">.1e-48</span><span class="selector-class">.el6_8</span><span class="selector-class">.4</span><span class="selector-class">.x86_64</span></span><br></pre></td></tr></table></figure><h2 id="RPM包的验证"><a href="#RPM包的验证" class="headerlink" title="RPM包的验证"></a>RPM包的验证</h2><h3 id="验证某个RPM包状态"><a href="#验证某个RPM包状态" class="headerlink" title="验证某个RPM包状态"></a>验证某个RPM包状态</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="meta"># rpm -V percona-server</span></span><br><span class="line">missing     <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/percona/</span>data</span><br><span class="line">missing     <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/percona/</span>data/test</span><br><span class="line">missing     <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/percona/</span>data<span class="meta-keyword">/test/</span>db.opt</span><br><span class="line">missing     <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/percona/</span>my.cnf</span><br><span class="line">此处由于自定义了RPM包，配置文件和数据目录转移了，显示missing</span><br></pre></td></tr></table></figure><h2 id="RPM包的备份与恢复"><a href="#RPM包的备份与恢复" class="headerlink" title="RPM包的备份与恢复"></a>RPM包的备份与恢复</h2><p>RPM的Database文件存放在/var/lib/rpm目录。除了 __db.00* 是数据文件外，其他文件都属于 Berkeley DB 格式,所以要注意备份此目录。</p><h2 id="RPM延伸"><a href="#RPM延伸" class="headerlink" title="RPM延伸"></a>RPM延伸</h2><p>其他高级用法，请参考：<a href="https://docs.fedoraproject.org/en-US/Fedora_Draft_Documentation/0.1/html/RPM_Guide/index.html" target="_blank" rel="noopener">https://docs.fedoraproject.org/en-US/Fedora_Draft_Documentation/0.1/html/RPM_Guide/index.html</a></p><h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install </span>rpm-<span class="keyword">build </span>readline-devel redhat-rpm-<span class="built_in">config</span> gcc gcc-c++ cmake make zlib-devel openssl-devel perl libtool automake autoconf time ccache <span class="keyword">bison </span>libaio-devel gperf</span><br></pre></td></tr></table></figure><h2 id="创建用户及配置"><a href="#创建用户及配置" class="headerlink" title="创建用户及配置"></a>创建用户及配置</h2><h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">useradd jiessie</span> </span><br><span class="line"><span class="attribute">su - jiessie</span></span><br></pre></td></tr></table></figure><h3 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~<span class="string">/rpmbuild/</span>&#123;BUILD,RPMS,SOURCES,SPECS,SRPMS&#125; </span><br><span class="line"><span class="keyword">echo</span> '%_topdir <span class="string">/home/jiessie/rpmbuild</span>' &gt; ~<span class="string">/.rpmmacros</span></span><br></pre></td></tr></table></figure><h2 id="RPMBUILD"><a href="#RPMBUILD" class="headerlink" title="RPMBUILD"></a>RPMBUILD</h2><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> jiessie]<span class="meta"># tree rpmbuild/</span></span><br><span class="line">rpmbuild/</span><br><span class="line">├── BUILD   <span class="meta">#编译生成的临时文件</span></span><br><span class="line">├── RPMS    <span class="meta">#RPM包存放目录</span></span><br><span class="line">├── SOURCES <span class="meta">#源码存放目录</span></span><br><span class="line">├── SPECS   <span class="meta">#SPEC文件目录</span></span><br><span class="line">└── SRPMS   <span class="meta">#SRC RPM包存放目录</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> directories, <span class="number">0</span> files</span><br></pre></td></tr></table></figure><h3 id="编写SPEC文件"><a href="#编写SPEC文件" class="headerlink" title="编写SPEC文件"></a>编写SPEC文件</h3><p>详情，请参考：<a href="https://fedoraproject.org/wiki/How_to_create_an_RPM_package/zh-cn#.25prep_.E9.83.A8.E5.88.86" target="_blank" rel="noopener">https://fedoraproject.org/wiki/How_to_create_an_RPM_package/zh-cn#.25prep_.E9.83.A8.E5.88.86</a><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">-bash-<span class="number">4.1</span>$ cat percona.<span class="number">5.6</span>.<span class="number">36</span>.spec </span><br><span class="line"><span class="symbol">Name:</span> percona-server    <span class="comment">#软件包名</span></span><br><span class="line"><span class="symbol">Version:</span><span class="number">5.6</span>.<span class="number">36</span>          <span class="comment">#版本号</span></span><br><span class="line"><span class="symbol">Release:</span> <span class="number">82.0</span>           <span class="comment">#发布序列号</span></span><br><span class="line"><span class="symbol">License:</span> GPL            <span class="comment">#软件授权方式      </span></span><br><span class="line"><span class="symbol">Vendor:</span> Jiessie         <span class="comment">#作者信息 </span></span><br><span class="line"></span><br><span class="line"><span class="symbol">Group:</span> applications/database        <span class="comment">#软件包所属类别</span></span><br><span class="line"><span class="symbol">URL:</span> <span class="symbol">https:</span>/<span class="regexp">/www.percona.com/downloads</span><span class="regexp">/Percona-Server-5.6/</span>Percona-Server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>/source/tarball/percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.tar.gz    <span class="comment">#软件的项目主页</span></span><br><span class="line"><span class="symbol">BuildRoot:</span> <span class="string">%&#123;_tmppath&#125;</span>/<span class="string">%&#123;name&#125;</span>-<span class="string">%&#123;version&#125;</span>-<span class="string">%&#123;release&#125;</span>-root   <span class="comment">#安装或编译时使用的虚拟目录，在生成rpm的过程中，执行make install时就会把软件安装到该路径中，默认构建根目录为%&#123;_topdir&#125;/BUILDROOT，可以用$RPM_BUILD_ROOT方式引用</span></span><br><span class="line"><span class="symbol">BuildRequires:</span> cmake                        <span class="comment">#编译过程中需要的包列表</span></span><br><span class="line"><span class="symbol">Requires:</span> coreutils,shadow-utils            <span class="comment">#程序安装时需要的包列表</span></span><br><span class="line"><span class="symbol">Packager:</span> dwj999@163.com                    <span class="comment">#打包者信息</span></span><br><span class="line"><span class="symbol">Autoreq:</span> no</span><br><span class="line"><span class="symbol">Source:</span> percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.tar.gz   <span class="comment">#源代码包</span></span><br><span class="line"><span class="symbol">prefix:</span> /usr/local/percona                  <span class="comment">#rpm包安装的路径</span></span><br><span class="line"><span class="symbol">Summary:</span> percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>         <span class="comment">#一行简短的软件包介绍</span></span><br><span class="line"></span><br><span class="line">%description                                <span class="comment">#软件包详细说明，可写在多个行上</span></span><br><span class="line">Percona Server is an enhanced, drop-<span class="keyword">in</span> MySQL® replacement which has been downloaded more than <span class="number">1</span>,<span class="number">000</span>,<span class="number">000</span> times.</span><br><span class="line">A free open source solution, Percona Server is a MySQL alternative which offers breakthrough performance, scalability, features, <span class="keyword">and</span> instrumentation. Self-tuning algorithms <span class="keyword">and</span> support <span class="keyword">for</span> extremely high-performance hardware make it the clear choice <span class="keyword">for</span> organizations that demand excellent performance <span class="keyword">and</span> reliability from their MySQL database server.</span><br><span class="line"></span><br><span class="line">%define MYSQL_USER mysql                    <span class="comment">#定义的MYSQL_USER变量</span></span><br><span class="line">%define MYSQL_GROUP mysql                   <span class="comment">#定义的MYSQL_GROUP变量</span></span><br><span class="line">%define __os_install_post <span class="string">%&#123;nil&#125;</span></span><br><span class="line"></span><br><span class="line">%prep                                       <span class="comment">#这个段是预处理段，通常用来执行一些解开源程序包的命令，为下一步的编译安装作准备。读取位于%_sourcedir(~/rpmbuild/SOURCES)目录的源代码和patch，随后会解压源代码至%_builddir(~/rpmbuild/BUILD)下的子目录并应用所有patch，描述解压源代码的方法，包含%setup和%patch命令</span></span><br><span class="line">%setup -q -n <span class="string">%&#123;name&#125;</span>-<span class="string">%&#123;version&#125;</span>-<span class="string">%&#123;release&#125;</span>  <span class="comment">#-q不输出信息，-n解压到指定目录中</span></span><br><span class="line"></span><br><span class="line">%build  <span class="comment">#包含构建阶段执行的命令，构建完成后便开始后续安装</span></span><br><span class="line">CFLAGS=<span class="string">"-O3 -g -static-libgcc -fno-omit-frame-pointer -fno-strict-aliasing"</span></span><br><span class="line">CXX=g++</span><br><span class="line">CXXFLAGS=<span class="string">"-O3 -g -fno-rtti -static-libgcc -fno-omit-frame-pointer -fno-strict-aliasing"</span></span><br><span class="line">export CFLAGS CXX CXXFLAGS</span><br><span class="line"></span><br><span class="line">cmake .                                                  \</span><br><span class="line">  -<span class="symbol">DSYSCONFDIR:</span>PATH=<span class="string">%&#123;prefix&#125;</span>                            \</span><br><span class="line">  -<span class="symbol">DCMAKE_INSTALL_PREFIX:</span>PATH=<span class="string">%&#123;prefix&#125;</span>                  \</span><br><span class="line">  -<span class="symbol">DCMAKE_BUILD_TYPE:</span>STRING=Release                      \</span><br><span class="line">  -<span class="symbol">DENABLE_PROFILING:</span>BOOL=ON                             \</span><br><span class="line">  -<span class="symbol">DWITH_DEBUG:</span>BOOL=OFF                                  \</span><br><span class="line">  -<span class="symbol">DWITH_VALGRIND:</span>BOOL=OFF                               \</span><br><span class="line">  -<span class="symbol">DENABLE_DEBUG_SYNC:</span>BOOL=OFF                           \</span><br><span class="line">  -<span class="symbol">DWITH_EXTRA_CHARSETS:</span>STRING=all                       \</span><br><span class="line">  -<span class="symbol">DWITH_SSL:</span>STRING=bundled                              \</span><br><span class="line">  -<span class="symbol">DWITH_UNIT_TESTS:</span>BOOL=OFF                             \</span><br><span class="line">  -<span class="symbol">DWITH_ZLIB:</span>STRING=bundled                             \</span><br><span class="line">  -<span class="symbol">DWITH_PARTITION_STORAGE_ENGINE:</span>BOOL=ON                \</span><br><span class="line">  -<span class="symbol">DWITH_INNOBASE_STORAGE_ENGINE:</span>BOOL=ON                 \</span><br><span class="line">  -<span class="symbol">DWITH_TOKUDB_STORAGE_ENGINE:</span>BOOL=ON                   \</span><br><span class="line">  -<span class="symbol">DWITH_ARCHIVE_STORAGE_ENGINE:</span>BOOL=ON                  \</span><br><span class="line">  -<span class="symbol">DWITH_BLACKHOLE_STORAGE_ENGINE:</span>BOOL=ON                \</span><br><span class="line">  -<span class="symbol">DWITH_PERFSCHEMA_STORAGE_ENGINE:</span>BOOL=ON               \</span><br><span class="line">  -DDEFAULT_CHARSET=utf8mb4                              \</span><br><span class="line">  -DDEFAULT_COLLATION=utf8mb4_general_ci                 \</span><br><span class="line">  -<span class="symbol">DENABLED_LOCAL_INFILE:</span>BOOL=ON                         \</span><br><span class="line">  -DWITH_EMBEDDED_SERVER=<span class="number">0</span>                               \</span><br><span class="line">  -<span class="symbol">DINSTALL_LAYOUT:</span>STRING=STANDALONE                     \</span><br><span class="line">  -<span class="symbol">DCOMMUNITY_BUILD:</span>BOOL=ON                              \</span><br><span class="line">  -DWITHOUT_EXAMPLE_STORAGE_ENGINE=<span class="number">1</span>                     \</span><br><span class="line">  -DWITHOUT_NDBCLUSTER_STORAGE_ENGINE=<span class="number">1</span>                  \</span><br><span class="line">  -DENABLED_PROFILING=<span class="number">1</span>                                  \</span><br><span class="line">  -DINNODB_PAGE_ATOMIC_REF_COUNT=<span class="number">1</span>                       \</span><br><span class="line">  -DWITH_INNODB_MEMCACHED=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">make -j <span class="string">`cat /proc/cpuinfo | grep processor| wc -l`</span></span><br><span class="line"></span><br><span class="line">%install    <span class="comment">#包含安装阶段执行的命令。命令将文件从 %&#123;_builddir&#125; 目录安装至 %&#123;buildroot&#125; 目录</span></span><br><span class="line">make DESTDIR=$RPM_BUILD_ROOT install</span><br><span class="line">cp <span class="string">%&#123;_sourcedir&#125;</span>/my.cnf $RPM_BUILD_ROOT<span class="string">%&#123;prefix&#125;</span>/   <span class="comment">#拷贝模板配置文件,下文会介绍配置文件</span></span><br><span class="line"></span><br><span class="line">%clean      <span class="comment">#清理安装目录的命令</span></span><br><span class="line">rm -rf $RPM_BUILD_ROOT</span><br><span class="line">rm -rf $RPM_BUILD_DIR/*</span><br><span class="line"></span><br><span class="line">%files      <span class="comment">#需要被打包/安装的文件列表</span></span><br><span class="line">%defattr(-, <span class="string">%&#123;MYSQL_USER&#125;</span>, <span class="string">%&#123;MYSQL_GROUP&#125;</span>)              <span class="comment">#设置默认文件权限格式%defattr(&lt;file permissions&gt;, &lt;user&gt;, &lt;group&gt;, &lt;directory permissions&gt;)，-使用默认的权限，文本文件是0644，可执行文件是0755</span></span><br><span class="line">%attr(<span class="number">755</span>, <span class="string">%&#123;MYSQL_USER&#125;</span>, <span class="string">%&#123;MYSQL_GROUP&#125;</span>) <span class="string">%&#123;prefix&#125;</span>/*   </span><br><span class="line"></span><br><span class="line">%pre        <span class="comment">#软件安装之前执行的脚本</span></span><br><span class="line"><span class="keyword">if</span> ! id <span class="string">%&#123;MYSQL_USER&#125;</span> &gt; <span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span>;<span class="keyword">then</span></span><br><span class="line">useradd -M -s /sbin/nologin <span class="string">%&#123;MYSQL_USER&#125;</span>               <span class="comment">#创建MySQL用户</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">%post       <span class="comment">#软件安装之后执行的脚本</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">%&#123;prefix&#125;</span>/support-files/mysql.server &gt; <span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> ]  &amp;&amp; [ ! -f <span class="string">%&#123;_initddir&#125;</span>/mysql &gt; <span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> ];<span class="keyword">then</span></span><br><span class="line">cp <span class="string">%&#123;prefix&#125;</span>/support-files/mysql.server <span class="string">%&#123;_initddir&#125;</span>/mysqld <span class="comment">#拷贝启动脚本</span></span><br><span class="line">chmod +x <span class="string">%&#123;_initddir&#125;</span>/mysqld                                <span class="comment">#添加启动脚本执行权限</span></span><br><span class="line">chkconfig --level <span class="number">2345</span> <span class="string">%&#123;_initddir&#125;</span>/mysqld on               <span class="comment">#添加到系统启动服务中</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">%&#123;_sysconfdir&#125;</span>/my.cnf ];<span class="keyword">then</span></span><br><span class="line">cp <span class="string">%&#123;prefix&#125;</span>/my.cnf <span class="string">%&#123;_sysconfdir&#125;</span>/my.cnf                   <span class="comment">#拷贝配置文件</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">cp <span class="string">%&#123;prefix&#125;</span>/my.cnf <span class="string">%&#123;_sysconfdir&#125;</span>/my.cnf.rpmnew            <span class="comment">#如存在文件，则重命名</span></span><br><span class="line">fi</span><br><span class="line">mkdir -p /hwdata/data/percona                               <span class="comment">#创建数据目录</span></span><br><span class="line">chown -R <span class="symbol">mysql:</span>mysql /hwdata/data/percona                   <span class="comment">#授权数据目录</span></span><br><span class="line">rm -rf <span class="string">%&#123;prefix&#125;</span>/my.cnf                                     <span class="comment">#删除prefix目录的my.cnf</span></span><br><span class="line">rm -rf <span class="string">%&#123;prefix&#125;</span>/data                                       <span class="comment">#删除prefix目录的data目录</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/scripts/mysql_install_db --rpm --user=mysql --basedir=<span class="string">%&#123;prefix&#125;</span>   <span class="comment">#初始化安装 --datadir=/hwdata/data/percona</span></span><br><span class="line">/etc/init.d/mysqld start                                    <span class="comment">#开启MySQL服务</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysqladmin -uroot password <span class="string">'123456'</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysql -uroot -p123456 -e <span class="string">"grant all privileges on *.* to root@'127.0.0.1' identified by '123456' with grant option;"</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysql -uroot -p123456 -e <span class="string">"grant all privileges on *.* to root@'localhost' identified by '123456' with grant option;"</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysql -uroot -p123456 -e <span class="string">"delete from mysql.user where Password='';"</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysql -uroot -p123456 -e <span class="string">"delete from mysql.db where User='';"</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysql -uroot -p123456 -e <span class="string">"delete from mysql.proxies_priv where Host!='localhost';"</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysql -uroot -p123456 -e <span class="string">"drop database test;"</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysql -uroot -p123456 -e <span class="string">"reset master;"</span></span><br><span class="line"></span><br><span class="line">echo <span class="string">"PATH=/usr/local/percona/bin/:$PATH:$HOME/bin"</span> <span class="meta">&gt;&gt; </span>/etc/profile <span class="comment">#添加环境变量</span></span><br><span class="line">echo <span class="string">"export PATH"</span> <span class="meta">&gt;&gt; </span>/etc/profile  </span><br><span class="line">source /etc/profile     <span class="comment">#环境变量生效</span></span><br><span class="line"></span><br><span class="line">%preun      <span class="comment">#rpm卸载前执行的脚本，在升级的时候会执行</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">%&#123;_sysconfdir&#125;</span>/my.cnf ];<span class="keyword">then</span></span><br><span class="line">mv <span class="string">%&#123;_sysconfdir&#125;</span>/my.cnf <span class="string">%&#123;_sysconfdir&#125;</span>/my.cnf.rpmold</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">%&#123;_initddir&#125;</span>/mysql ];<span class="keyword">then</span></span><br><span class="line">mv <span class="string">%&#123;_initddir&#125;</span>/mysql <span class="string">%&#123;_initddir&#125;</span>/mysql.rpmold</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">%postun     <span class="comment">#rpm卸载后执行的脚本，在升级rpm包的时候不会执行</span></span><br><span class="line">rm -rf <span class="string">%&#123;prefix&#125;</span></span><br><span class="line">rm -rf /hwdata/data/percona </span><br><span class="line">userdel -r <span class="string">%&#123;MYSQL_USER&#125;</span> &gt;<span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"></span><br><span class="line">%changelog  <span class="comment">#RPM 包变更日志</span></span><br></pre></td></tr></table></figure></p><h3 id="MySQL模板文件-my-cnf"><a href="#MySQL模板文件-my-cnf" class="headerlink" title="MySQL模板文件(my.cnf)"></a>MySQL模板文件(my.cnf)</h3><p>以下为my.cnf配置模板文件，不做过多解释，请参考：<a href="https://dev.mysql.com/doc/refman/5.6/en/option-files.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.6/en/option-files.html</a><br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">-bash-4.1$ cat my.cnf </span><br><span class="line">[client]</span><br><span class="line">port = 3306</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">default-character-set = utf8</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line"><span class="comment">#prompt="MySQL [\d]&gt; "</span></span><br><span class="line">prompt=<span class="string">"MySQL [\d] \R:\m:\\s &gt; "</span></span><br><span class="line">no-auto-rehash</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment"># basic setting #</span></span><br><span class="line">port = 3306</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">basedir = /usr/local/percona</span><br><span class="line">datadir = /hwdata/data/percona</span><br><span class="line">pid-file = /hwdata/data/percona/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">bind-address = 0.0.0.0</span><br><span class="line">server-id = 1</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 1</span><br><span class="line">auto_increment_offset = 1</span><br><span class="line">event_scheduler = 1     <span class="comment">#slave need off</span></span><br><span class="line"><span class="comment">#read_only=ON           #slave need on</span></span><br><span class="line">skip-name-resolve</span><br><span class="line">skip-external-locking</span><br><span class="line">transaction_isolation = READ-COMMITTED</span><br><span class="line">init-connect = 'SET NAMES utf8'</span><br><span class="line">character-set-server = utf8</span><br><span class="line">query_cache_size = 0</span><br><span class="line">query_cache_type = 0</span><br><span class="line"></span><br><span class="line">max_connections = 2000</span><br><span class="line">max_connect_errors = 100000</span><br><span class="line">max_length_for_sort_data = 8192</span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line">max_heap_table_size = 128M</span><br><span class="line">tmp_table_size = 128M</span><br><span class="line">open_files_limit = 65535</span><br><span class="line">table_open_cache = 1024</span><br><span class="line">table_definition_cache = 2048</span><br><span class="line">table_open_cache = 1024</span><br><span class="line"></span><br><span class="line">read_buffer_size = 4M</span><br><span class="line">read_rnd_buffer_size = 8M</span><br><span class="line">sort_buffer_size = 4M</span><br><span class="line">join_buffer_size = 16M</span><br><span class="line">key_buffer_size = 256M</span><br><span class="line"></span><br><span class="line">back_log = 300</span><br><span class="line">expire_logs_days = 7</span><br><span class="line">log_error = /hwdata/data/percona/mysql-error.log</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">log_warnings = 2</span><br><span class="line">log_queries_not_using_indexes = 1</span><br><span class="line">binlog_format = ROW</span><br><span class="line">slow_query_log = 1</span><br><span class="line">slow_query_log_file = /hwdata/data/percona/mysql-slow.log</span><br><span class="line">long_query_time = 1</span><br><span class="line">log_slow_rate_limit=100</span><br><span class="line">log_slow_rate_type=query</span><br><span class="line">log_slow_verbosity=full</span><br><span class="line">slow_query_log_always_write_time=1</span><br><span class="line">slow_query_log_use_global_control=all</span><br><span class="line">log_slow_admin_statements = 1</span><br><span class="line">log_slow_slave_statements = 1</span><br><span class="line">log_throttle_queries_not_using_indexes = 10</span><br><span class="line">min_examined_row_limit = 100</span><br><span class="line">binlog-rows-query-log-events = 1</span><br><span class="line">log-bin-trust-function-creators = 1</span><br><span class="line">binlog_cache_size = 1M</span><br><span class="line">userstat=1</span><br><span class="line">performance_schema = 0</span><br><span class="line"><span class="comment">#lower_case_table_names = 1</span></span><br><span class="line">default_storage_engine = InnoDB</span><br><span class="line">innodb_page_size = 16384</span><br><span class="line">innodb_data_file_path = ibdata1:1024M:autoextend</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">innodb_open_files = 1024</span><br><span class="line">innodb_buffer_pool_size = 4096M</span><br><span class="line">innodb_buffer_pool_instances = 8</span><br><span class="line">innodb_buffer_pool_load_at_startup = 1</span><br><span class="line">innodb_buffer_pool_dump_at_shutdown = 1</span><br><span class="line">innodb_write_io_threads = 8</span><br><span class="line">innodb_read_io_threads = 8</span><br><span class="line">innodb_io_capacity = 4000</span><br><span class="line">innodb_io_capacity_max = 8000</span><br><span class="line">innodb_lru_scan_depth = 4000</span><br><span class="line">innodb_thread_concurrency = 0</span><br><span class="line">innodb_purge_threads = 1</span><br><span class="line">innodb_flush_log_at_trx_commit = 2</span><br><span class="line">innodb_flush_method=O_DIRECT</span><br><span class="line">innodb_file_format = Barracuda</span><br><span class="line">innodb_file_format_max = Barracuda</span><br><span class="line">innodb_undo_logs = 128</span><br><span class="line">innodb_undo_tablespaces = 3</span><br><span class="line">innodb_log_buffer_size = 16M</span><br><span class="line">innodb_log_file_size = 1536M</span><br><span class="line">innodb_log_files_in_group = 3</span><br><span class="line">innodb_max_dirty_pages_pct = 75</span><br><span class="line">innodb_lock_wait_timeout = 120</span><br><span class="line">innodb_large_prefix = 1</span><br><span class="line">innodb_print_all_deadlocks = 1</span><br><span class="line">innodb_autoinc_lock_mode = 2</span><br><span class="line">innodb_online_alter_log_max_size=1G</span><br><span class="line">innodb_sync_spin_loops = 100</span><br><span class="line">innodb_spin_wait_delay = 30</span><br><span class="line">metadata_locks_hash_instances = 8</span><br><span class="line"></span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br><span class="line"></span><br><span class="line">slave_skip_errors = ddl_exist_errors</span><br><span class="line">slave-rows-search-algorithms = 'INDEX_SCAN,HASH_SCAN'</span><br><span class="line">slave_net_timeout = 60</span><br><span class="line">master_info_repository = TABLE</span><br><span class="line">relay_log_info_repository = TABLE</span><br><span class="line"></span><br><span class="line">thread_cache_size = 64</span><br><span class="line">thread_handling = pool-of-threads</span><br><span class="line">thread_pool_oversubscribe = 10</span><br><span class="line"></span><br><span class="line">bulk_insert_buffer_size = 8M</span><br><span class="line">myisam_sort_buffer_size = 64M</span><br><span class="line">myisam_max_sort_file_size = 10G</span><br><span class="line">myisam_repair_threads = 1</span><br><span class="line"></span><br><span class="line">interactive_timeout = 1800</span><br><span class="line">wait_timeout = 1800</span><br><span class="line">lock_wait_timeout = 1800</span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = 16M</span><br><span class="line"></span><br><span class="line">[myisamchk]</span><br><span class="line">key_buffer_size = 256M</span><br><span class="line">sort_buffer_size = 8M</span><br><span class="line">read_buffer = 4M</span><br><span class="line">write_buffer = 4M</span><br><span class="line">-bash-4.1$</span><br></pre></td></tr></table></figure></p><h3 id="上传源码文件及模板文件"><a href="#上传源码文件及模板文件" class="headerlink" title="上传源码文件及模板文件"></a>上传源码文件及模板文件</h3><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">bash-<span class="number">4.1</span>$ ls -l rpmbuild/SOURCES/</span></span><br><span class="line"><span class="ruby">总用量 <span class="number">54808</span></span></span><br><span class="line"><span class="ruby">-rw-r--r-- <span class="number">1</span> jiessie jiessie     <span class="number">3629</span> <span class="number">7</span>月  <span class="number">14</span> <span class="number">10</span><span class="symbol">:</span><span class="number">22</span> my.cnf</span></span><br><span class="line"><span class="ruby">-rw-r--r-- <span class="number">1</span> jiessie jiessie <span class="number">56116691</span> <span class="number">7</span>月  <span class="number">14</span> <span class="number">10</span><span class="symbol">:</span><span class="number">22</span> percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.tar.gz</span></span><br><span class="line"><span class="ruby">-bash-<span class="number">4.1</span>$</span></span><br></pre></td></tr></table></figure><h3 id="执行编译过程"><a href="#执行编译过程" class="headerlink" title="执行编译过程"></a>执行编译过程</h3><p>rpmbuild -bb percona.5.6.36.spec<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">-bash<span class="number">-4.1</span>$ pwd</span><br><span class="line"><span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>SPECS</span><br><span class="line">-bash<span class="number">-4.1</span>$ rpmbuild -bb percona<span class="number">.5</span><span class="number">.6</span><span class="number">.36</span>.spec </span><br><span class="line">Executing(%prep): <span class="regexp">/bin/</span>sh -e <span class="regexp">/var/</span>tmp/rpm-tmp.YmJTDn</span><br><span class="line">+ umask <span class="number">022</span></span><br><span class="line">+ cd <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILD</span><br><span class="line">+ LANG=C</span><br><span class="line">+ export LANG</span><br><span class="line">+ unset DISPLAY</span><br><span class="line">+ cd <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILD</span><br><span class="line">+ rm -rf percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span></span><br><span class="line">+ <span class="regexp">/usr/</span>bin<span class="regexp">/gzip -dc /</span>home<span class="regexp">/jiessie/</span>rpmbuild<span class="regexp">/SOURCES/</span>percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.tar.gz</span><br><span class="line">+ <span class="regexp">/bin/</span>tar -xf -</span><br><span class="line">+ STATUS=<span class="number">0</span></span><br><span class="line">+ <span class="string">'['</span> <span class="number">0</span> -ne <span class="number">0</span> <span class="string">']'</span></span><br><span class="line">+ cd percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span></span><br><span class="line">+ <span class="regexp">/bin/</span>chmod -Rf a+rX,u+w,g-w,o-w .</span><br><span class="line">+ exit <span class="number">0</span></span><br><span class="line">Executing(%build): <span class="regexp">/bin/</span>sh -e <span class="regexp">/var/</span>tmp/rpm-tmp.vvnRcl</span><br><span class="line">+ umask <span class="number">022</span></span><br><span class="line">+ cd <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILD</span><br><span class="line">+ cd percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span></span><br><span class="line">+ LANG=C</span><br><span class="line">+ export LANG</span><br><span class="line">+ unset DISPLAY</span><br><span class="line">+ CFLAGS=<span class="string">'-O3 -g -static-libgcc -fno-omit-frame-pointer -fno-strict-aliasing'</span></span><br><span class="line">+ CXX=g++</span><br><span class="line">+ CXXFLAGS=<span class="string">'-O3 -g -fno-rtti -static-libgcc -fno-omit-frame-pointer -fno-strict-aliasing'</span></span><br><span class="line">+ export CFLAGS CXX CXXFLAGS</span><br><span class="line">+ cmake . -<span class="string">DSYSCONFDIR:</span>PATH=<span class="regexp">/usr/</span>local<span class="regexp">/percona -DCMAKE_INSTALL_PREFIX:PATH=/</span>usr<span class="regexp">/local/</span>percona -<span class="string">DCMAKE_BUILD_TYPE:</span>STRING=Release -<span class="string">DENABLE_PROFILING:</span>BOOL=ON -<span class="string">DWITH_DEBUG:</span>BOOL=OFF -<span class="string">DWITH_VALGRIND:</span>BOOL=OFF -<span class="string">DENABLE_DEBUG_SYNC:</span>BOOL=OFF -<span class="string">DWITH_EXTRA_CHARSETS:</span>STRING=all -<span class="string">DWITH_SSL:</span>STRING=bundled -<span class="string">DWITH_UNIT_TESTS:</span>BOOL=OFF -<span class="string">DWITH_ZLIB:</span>STRING=bundled -<span class="string">DWITH_PARTITION_STORAGE_ENGINE:</span>BOOL=ON -<span class="string">DWITH_INNOBASE_STORAGE_ENGINE:</span>BOOL=ON -<span class="string">DWITH_TOKUDB_STORAGE_ENGINE:</span>BOOL=ON -<span class="string">DWITH_ARCHIVE_STORAGE_ENGINE:</span>BOOL=ON -<span class="string">DWITH_BLACKHOLE_STORAGE_ENGINE:</span>BOOL=ON -<span class="string">DWITH_PERFSCHEMA_STORAGE_ENGINE:</span>BOOL=ON -DDEFAULT_CHARSET=utf8mb4 -DDEFAULT_COLLATION=utf8mb4_general_ci -<span class="string">DENABLED_LOCAL_INFILE:</span>BOOL=ON -DWITH_EMBEDDED_SERVER=<span class="number">0</span> -<span class="string">DINSTALL_LAYOUT:</span>STRING=STANDALONE -<span class="string">DCOMMUNITY_BUILD:</span>BOOL=ON -DWITHOUT_EXAMPLE_STORAGE_ENGINE=<span class="number">1</span> -DWITHOUT_NDBCLUSTER_STORAGE_ENGINE=<span class="number">1</span> -DENABLED_PROFILING=<span class="number">1</span> -DINNODB_PAGE_ATOMIC_REF_COUNT=<span class="number">1</span> -DWITH_INNODB_MEMCACHED=<span class="number">1</span></span><br><span class="line">-- Running cmake version <span class="number">2.8</span><span class="number">.12</span><span class="number">.2</span></span><br><span class="line">-- Found <span class="string">Git:</span> <span class="regexp">/usr/</span>bin/git (found version <span class="string">"1.7.1"</span>) </span><br><span class="line">-- The C compiler identification is GNU <span class="number">4.4</span><span class="number">.7</span></span><br><span class="line">-- The CXX compiler identification is GNU <span class="number">4.4</span><span class="number">.7</span></span><br><span class="line">-- Check <span class="keyword">for</span> working C <span class="string">compiler:</span> <span class="regexp">/usr/</span>bin/cc</span><br><span class="line">-- Check <span class="keyword">for</span> working C <span class="string">compiler:</span> <span class="regexp">/usr/</span>bin/cc -- works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - done</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX <span class="string">compiler:</span> <span class="regexp">/usr/</span>bin/g++</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX <span class="string">compiler:</span> <span class="regexp">/usr/</span>bin/g++ -- works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - done</span><br><span class="line">-- ...省略部分...</span><br><span class="line">-- Not building tokudb-backup-plugin</span><br><span class="line">-- Library perconaserverclient depends on OSLIBS -lpthread;m;rt;dl</span><br><span class="line">-- Skipping deb packaging on unsupported platform Final.</span><br><span class="line">-- <span class="string">CMAKE_BUILD_TYPE:</span> Release</span><br><span class="line">-- <span class="string">COMPILE_DEFINITIONS:</span> HAVE_CONFIG_H</span><br><span class="line">-- <span class="string">CMAKE_C_FLAGS:</span> -O3 -g -<span class="keyword">static</span>-libgcc -fno-omit-frame-pointer -fno-strict-aliasing  -Wall -Wextra -Wformat-security -Wvla -Wwrite-strings -Wdeclaration-after-statement</span><br><span class="line">-- <span class="string">CMAKE_CXX_FLAGS:</span> -O3 -g -fno-rtti -<span class="keyword">static</span>-libgcc -fno-omit-frame-pointer -fno-strict-aliasing  -Wall -Wextra -Wformat-security -Wvla -Woverloaded-virtual -Wno-unused-parameter</span><br><span class="line">-- <span class="string">CMAKE_C_FLAGS_RELEASE:</span> -O3 -DNDEBUG -DDBUG_OFF</span><br><span class="line">-- <span class="string">CMAKE_CXX_FLAGS_RELEASE:</span> -O3 -DNDEBUG -DDBUG_OFF</span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">CMake <span class="string">Warning:</span></span><br><span class="line">  Manually-specified variables were not used by the <span class="string">project:</span></span><br><span class="line"></span><br><span class="line">    COMMUNITY_BUILD</span><br><span class="line">    ENABLE_DEBUG_SYNC</span><br><span class="line">    ENABLE_PROFILING</span><br><span class="line">    WITH_TOKUDB_STORAGE_ENGINE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Build files have been written <span class="string">to:</span> <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILD/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span></span><br><span class="line">++ cat <span class="regexp">/proc/</span>cpuinfo</span><br><span class="line">++ grep processor</span><br><span class="line">++ wc -l</span><br><span class="line">+ make -j <span class="number">4</span></span><br><span class="line">Scanning dependencies of target abi_check</span><br><span class="line">Scanning dependencies of target INFO_BIN</span><br><span class="line">Scanning dependencies of target INFO_SRC</span><br><span class="line">Scanning dependencies of target zlib</span><br><span class="line">[  <span class="number">0</span>%] [  <span class="number">0</span>%] Building C object zlib<span class="regexp">/CMakeFiles/</span>zlib.dir/adler32.c.o</span><br><span class="line">[<span class="number">100</span>%] ...省略部分...</span><br><span class="line">[<span class="number">100</span>%] Built target udf_example</span><br><span class="line">+ exit <span class="number">0</span></span><br><span class="line">Executing(%install): <span class="regexp">/bin/</span>sh -e <span class="regexp">/var/</span>tmp/rpm-tmp.MNmU8M</span><br><span class="line">+ umask <span class="number">022</span></span><br><span class="line">+ cd <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILD</span><br><span class="line">+ <span class="string">'['</span> <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT<span class="regexp">/percona-server-5.6.36-82.0.x86_64 '!=' /</span> <span class="string">']'</span></span><br><span class="line">+ rm -rf <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64</span><br><span class="line">++ dirname <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64</span><br><span class="line">+ mkdir -p <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT</span><br><span class="line">+ mkdir <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64</span><br><span class="line">+ cd percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span></span><br><span class="line">+ LANG=C</span><br><span class="line">+ export LANG</span><br><span class="line">+ unset DISPLAY</span><br><span class="line">+ make DESTDIR=<span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64 install</span><br><span class="line">[  <span class="number">0</span>%] Built target INFO_BIN</span><br><span class="line">[<span class="number">100</span>%] ...省略部分...</span><br><span class="line">[<span class="number">100</span>%] Built target my_safe_process</span><br><span class="line">Install the project...</span><br><span class="line">-- Install <span class="string">configuration:</span> <span class="string">"Release"</span></span><br><span class="line">-- <span class="string">Installing:</span> <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT<span class="regexp">/percona-server-5.6.36-82.0.x86_64/</span>usr<span class="regexp">/local/</span>percona<span class="regexp">/docs/</span>mysql.info</span><br><span class="line">-- ...省略部分...</span><br><span class="line"><span class="string">cpio:</span> percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span><span class="regexp">/storage/</span>innobase/pars0lex.<span class="string">l:</span> Cannot <span class="string">stat:</span> No such file or directory</span><br><span class="line"><span class="number">97189</span> blocks</span><br><span class="line">+ <span class="regexp">/usr/</span>lib<span class="regexp">/rpm/</span>check-buildroot</span><br><span class="line">Processing <span class="string">files:</span> percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64</span><br><span class="line"><span class="string">Provides:</span> adt_null.so()(<span class="number">64</span>bit) audit_log.so()(<span class="number">64</span>bit) auth.so()(<span class="number">64</span>bit) auth_socket.so()(<span class="number">64</span>bit) auth_test_plugin.so()(<span class="number">64</span>bit) connection_control.so()(<span class="number">64</span>bit) handlersocket.so()(<span class="number">64</span>bit) innodb_engine.so()(<span class="number">64</span>bit) libdaemon_example.so()(<span class="number">64</span>bit) libfnv1a_udf.so()(<span class="number">64</span>bit) libfnv_udf.so()(<span class="number">64</span>bit) libmemcached.so()(<span class="number">64</span>bit) libmurmur_udf.so()(<span class="number">64</span>bit) libperconaserverclient.so<span class="number">.18</span>()(<span class="number">64</span>bit) libperconaserverclient.so<span class="number">.18</span>(libperconaserverclient_18)(<span class="number">64</span>bit) mypluglib.so()(<span class="number">64</span>bit) mysql_no_login.so()(<span class="number">64</span>bit) perl(<span class="string">My:</span>:Config) perl(<span class="string">My:</span>:<span class="string">Config:</span>:Group) perl(<span class="string">My:</span>:<span class="string">Config:</span>:Option) perl(<span class="string">My:</span>:ConfigFactory) perl(<span class="string">My:</span>:CoreDump) perl(<span class="string">My:</span>:Exec) perl(<span class="string">My:</span>:<span class="string">File:</span>:Path) perl(<span class="string">My:</span>:Find) perl(<span class="string">My:</span>:Handles) perl(<span class="string">My:</span>:Memcache) perl(<span class="string">My:</span>:<span class="string">Memcache:</span>:Binary) perl(<span class="string">My:</span>:Options) perl(<span class="string">My:</span>:Platform) perl(<span class="string">My:</span>:SafeProcess) perl(<span class="string">My:</span>:<span class="string">SafeProcess:</span>:Base) perl(<span class="string">My:</span>:<span class="string">Suite:</span>:Query_response_time) perl(<span class="string">My:</span>:SysInfo) perl(<span class="string">My:</span>:Test) perl(Subunit) = <span class="number">0.0</span><span class="number">.2</span> perl(mtr_cases) perl(mtr_match) perl(mtr_report) perl(mtr_results) perl(mtr_unique) qa_auth_client.so()(<span class="number">64</span>bit) qa_auth_interface.so()(<span class="number">64</span>bit) qa_auth_server.so()(<span class="number">64</span>bit) query_response_time.so()(<span class="number">64</span>bit) semisync_master.so()(<span class="number">64</span>bit) semisync_slave.so()(<span class="number">64</span>bit) test_udf_services.so()(<span class="number">64</span>bit) validate_password.so()(<span class="number">64</span>bit)</span><br><span class="line">Requires(interp): <span class="regexp">/bin/</span>sh <span class="regexp">/bin/</span>sh <span class="regexp">/bin/</span>sh <span class="regexp">/bin/</span>sh</span><br><span class="line">Requires(rpmlib): rpmlib(FileDigests) &lt;= <span class="number">4.6</span><span class="number">.0</span><span class="number">-1</span> rpmlib(PayloadFilesHavePrefix) &lt;= <span class="number">4.0</span><span class="number">-1</span> rpmlib(CompressedFileNames) &lt;= <span class="number">3.0</span><span class="number">.4</span><span class="number">-1</span></span><br><span class="line">Requires(pre): <span class="regexp">/bin/</span>sh</span><br><span class="line">Requires(post): <span class="regexp">/bin/</span>sh</span><br><span class="line">Requires(preun): <span class="regexp">/bin/</span>sh</span><br><span class="line">Requires(postun): <span class="regexp">/bin/</span>sh</span><br><span class="line">Processing <span class="string">files:</span> percona-server-debuginfo<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64</span><br><span class="line">Checking <span class="keyword">for</span> unpackaged file(s): <span class="regexp">/usr/</span>lib<span class="regexp">/rpm/</span>check-files <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64</span><br><span class="line"><span class="string">Wrote:</span> <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>RPMS<span class="regexp">/x86_64/</span>percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64.rpm</span><br><span class="line"><span class="string">Wrote:</span> <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>RPMS<span class="regexp">/x86_64/</span>percona-server-debuginfo<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64.rpm</span><br><span class="line">Executing(%clean): <span class="regexp">/bin/</span>sh -e <span class="regexp">/var/</span>tmp/rpm-tmp.FOVDND</span><br><span class="line">+ umask <span class="number">022</span></span><br><span class="line">+ cd <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILD</span><br><span class="line">+ cd percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span></span><br><span class="line">+ rm -rf <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64</span><br><span class="line">+ rm -rf <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILD/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span></span><br><span class="line">+ exit <span class="number">0</span></span><br><span class="line">-bash<span class="number">-4.1</span>$</span><br></pre></td></tr></table></figure></p><h3 id="查看生成的RPM文件"><a href="#查看生成的RPM文件" class="headerlink" title="查看生成的RPM文件"></a>查看生成的RPM文件</h3><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">bash-<span class="number">4.1</span>$ ls -l rpmbuild/RPMS/x86_64/</span></span><br><span class="line"><span class="ruby">总用量 <span class="number">99528</span></span></span><br><span class="line"><span class="ruby">-rw-rw-r-- <span class="number">1</span> jiessie jiessie <span class="number">53752860</span> <span class="number">7</span>月  <span class="number">14</span> <span class="number">10</span><span class="symbol">:</span><span class="number">34</span> percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.x86_64.rpm</span></span><br><span class="line"><span class="ruby">-rw-rw-r-- <span class="number">1</span> jiessie jiessie <span class="number">48158544</span> <span class="number">7</span>月  <span class="number">14</span> <span class="number">10</span><span class="symbol">:</span><span class="number">35</span> percona-server-debuginfo-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.x86_64.rpm</span></span><br><span class="line"><span class="ruby">-bash-<span class="number">4.1</span>$</span></span><br></pre></td></tr></table></figure><p>percona-server-5.6.36-82.0.x86_64.rpm 此文件即是编译后生成的RPM安装文件</p><h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>随着云计算时代的到来，docker被越来越多的应用的实际生产中，但对于公司规模较小，自动化平台还不够完善的企业，自制RPM包安装MySQL也是一种不错的选择。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;RPM是Red-hat系统的软件管理工具，目前，RPM已发展成为业界认可的Linux系统软件工具。RPM制作灵活方便，在安装、升级、卸载等方
      
    
    </summary>
    
      <category term="安装" scheme="https://dwj999.github.io/categories/%E5%AE%89%E8%A3%85/"/>
    
    
      <category term="percona" scheme="https://dwj999.github.io/tags/percona/"/>
    
      <category term="mysql" scheme="https://dwj999.github.io/tags/mysql/"/>
    
      <category term="rpm" scheme="https://dwj999.github.io/tags/rpm/"/>
    
  </entry>
  
  <entry>
    <title>hexo next 在github上搭建个人博客</title>
    <link href="https://dwj999.github.io/hexo-next-%E5%9C%A8github%E4%B8%8A%E6%90%AD%E5%BB%BA%E4%B8%AA%E4%BA%BA%E5%8D%9A%E5%AE%A2.html"/>
    <id>https://dwj999.github.io/hexo-next-在github上搭建个人博客.html</id>
    <published>2013-07-12T07:56:07.000Z</published>
    <updated>2020-05-20T03:48:16.076Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前网上的很多平台都提供了博客功能，如csdn，51cto，cnblog，iteye等等，只要你想写博客，这些平台都可以选择。只需注册个帐号，就可以写博客，实现比较简单，但是局限性也很大，风格千篇一律，没有个性化，扩展也稍麻烦。并且，广告很多，这点很受不了。在此选择了hexo+next+github建立个人的博客平台。</p><h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>github：<a href="https://github.com/dwj999" target="_blank" rel="noopener">https://github.com/dwj999</a><br>发布平台：centos6.5 x86_64<br>发布工具：git<br>编写平台：windows7 x86_64<br>编写工具：有道云笔记<br>框架：hexo<br>主题：next </p><h2 id="安装Node-js"><a href="#安装Node-js" class="headerlink" title="安装Node.js"></a>安装Node.js</h2><p>操作系统为centos6.5，首先删除旧版本<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="builtin-name">remove</span> nodejs</span><br></pre></td></tr></table></figure></p><p>node使用最新版本，下载源码包<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://nodejs.org/dist/v8.<span class="number">1.4</span>/<span class="keyword">node</span><span class="title">-v8</span>.<span class="number">1.4</span>-linux-x64.tar.xz  </span><br><span class="line">tar -xvJf <span class="keyword">node</span><span class="title">-v8</span>.<span class="number">1.4</span>-linux-x64.tar.xz  </span><br><span class="line">mv <span class="keyword">node</span><span class="title">-v8</span>.<span class="number">1.4</span>-linux-x64 /usr/local/<span class="keyword">node</span><span class="title"></span></span><br></pre></td></tr></table></figure></p><p>配置系统环境变量<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc<span class="built_in">/profile </span> </span><br><span class="line">在底部添加 PATH 变量  </span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:/usr/local/node/bin  </span><br><span class="line">最后保存并使其生效即可  </span><br><span class="line">source /etc<span class="built_in">/profile </span> </span><br><span class="line">查看版本：node -v</span><br></pre></td></tr></table></figure></p><p><img src="http://note.youdao.com/yws/public/resource/07bf646071b1146a82f5002fd9e53bcd/xmlnote/B1ED873C2C8143B2877B0AB88A07BC62/30674" alt="image">  </p><h2 id="安装Git-已安装可跳过"><a href="#安装Git-已安装可跳过" class="headerlink" title="安装Git(已安装可跳过)"></a>安装Git(已安装可跳过)</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> git-core</span><br></pre></td></tr></table></figure><h2 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h2><p>这里以我的github为例，地址为：<a href="https://github.com/dwj999" target="_blank" rel="noopener">https://github.com/dwj999</a><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">创建目录  </span><br><span class="line">mkdir /hwdata/dwj999  </span><br><span class="line">切换目录  </span><br><span class="line">cd /hwdata/dwj999  </span><br><span class="line">安装 Hexo  </span><br><span class="line">npm<span class="built_in"> config </span><span class="builtin-name">set</span><span class="built_in"> user </span>0  </span><br><span class="line">npm<span class="built_in"> config </span><span class="builtin-name">set</span> unsafe-perm <span class="literal">true</span>  </span><br><span class="line">npm install -g hexo-cli  </span><br><span class="line">初始化 Hexo(如果报Error: ENOENT: <span class="literal">no</span> such file <span class="keyword">or</span> directory, uv_cwd,可能是删除的旧版本nodejs导致,重启服务器再试) </span><br><span class="line">hexo init  </span><br><span class="line">生成静态网页</span><br><span class="line">hexo generate</span><br></pre></td></tr></table></figure></p><h2 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> hexo-generator-<span class="keyword">index</span> <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-generator-<span class="keyword">archive</span> <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-generator-<span class="keyword">category</span> <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-generator-tag <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-<span class="keyword">server</span> <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-deployer-git <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-deployer-heroku <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-deployer-rsync <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-deployer-openshift <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-renderer-marked <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-renderer-stylus <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-generator-feed <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-generator-sitemap <span class="comment">--save</span></span><br></pre></td></tr></table></figure><p>目录结构<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">|-- _config.yml  </span></span><br><span class="line"><span class="string">|-- db.json  </span></span><br><span class="line"><span class="string">|-- node_modules  </span></span><br><span class="line"><span class="string">|-- package.json  </span></span><br><span class="line"><span class="string">|-- package-lock.json  </span></span><br><span class="line"><span class="string">|-- public  </span></span><br><span class="line"><span class="string">|-- scaffolds  </span></span><br><span class="line"><span class="string">|-- source  </span></span><br><span class="line">    <span class="string">|-- _posts  </span></span><br><span class="line"><span class="string">|-- themes</span></span><br></pre></td></tr></table></figure></p><p>目录结构说明<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_config.yml <span class="meta">#全局配置文件，网站的很多信息都在这里配置，诸如网站名称，副标题，描述，作者，语言，主题，部署等等参数。请参考：https:<span class="comment">//hexo.io/zh-cn/docs/configuration.html</span></span></span><br><span class="line">db.json <span class="meta">#缓存文件</span></span><br><span class="line">node_modules <span class="meta">#hexo插件</span></span><br><span class="line">package.json <span class="meta">#hexo框架的参数</span></span><br><span class="line">package-lock.json <span class="meta">#根据package.json自动创建锁定依赖版本，删掉会重新创建</span></span><br><span class="line">public  <span class="meta">#生成的静态网页文件</span></span><br><span class="line">scaffolds   <span class="meta">#模板文件夹，请参考：https:<span class="comment">//hexo.io/zh-cn/docs/writing.html</span></span></span><br><span class="line">source  <span class="meta">#资源文件夹，用于存放用户资源。旧版本有两个文件夹，_drafts和_posts。新版本只有_posts，用于存放博客的正文。</span></span><br><span class="line">themes  <span class="meta">#网站主题目录，请参考：https:<span class="comment">//hexo.io/zh-cn/docs/themes.html</span></span></span><br><span class="line">详情请参考：请参考：https:<span class="comment">//hexo.io/zh-cn/docs/setup.html</span></span><br></pre></td></tr></table></figure></p><h2 id="部署到GitHub"><a href="#部署到GitHub" class="headerlink" title="部署到GitHub"></a>部署到GitHub</h2><h3 id="站点配置"><a href="#站点配置" class="headerlink" title="站点配置"></a>站点配置</h3><p>修改Hexo站点配置文件/hwdata/dwj999/_config.yml,以下为例<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Site  </span></span><br><span class="line"><span class="attr">title:</span> <span class="string">Jiessie's'</span> <span class="string">Blog</span> <span class="comment">#标题  </span></span><br><span class="line"><span class="attr">subtitle:</span> <span class="string">没伞的孩子必须努力奔跑</span>  <span class="comment">#副标题</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">最怕一生碌碌无为,还说平凡难能可贵！</span>  </span><br><span class="line"><span class="attr">author:</span> <span class="string">Jiessie</span>  </span><br><span class="line"><span class="attr">language:</span> <span class="string">zh-Hans</span>  </span><br><span class="line"></span><br><span class="line"><span class="attr">url:</span> <span class="attr">http://dwj999.github.io</span>  </span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span>  </span><br><span class="line"><span class="attr">  type:</span> <span class="string">git</span>  </span><br><span class="line"><span class="attr">  repo:</span> <span class="string">git@github.com:dwj999/dwj999.github.io.git</span>  </span><br><span class="line"><span class="attr">  branch:</span> <span class="string">master</span>  </span><br><span class="line"><span class="attr">  message:</span> <span class="string">'站点更新:<span class="template-variable">&#123;&#123;now("YYYY-MM-DD HH/mm/ss")&#125;&#125;</span>'</span></span><br></pre></td></tr></table></figure></p><h3 id="github创建项目"><a href="#github创建项目" class="headerlink" title="github创建项目"></a>github创建项目</h3><p>仓库的名字必须和你的帐号对应，比如我的github地址：<a href="https://github.com/dwj999" target="_blank" rel="noopener">https://github.com/dwj999</a> 新建仓库名为dwj999.github.io,因我的项目已创建，此为演示，故有提醒，可忽略<br><img src="http://note.youdao.com/yws/public/resource/07bf646071b1146a82f5002fd9e53bcd/xmlnote/4D97A1CDD66544C88937FF1635C584CB/30910" alt="image"></p><h3 id="git配置"><a href="#git配置" class="headerlink" title="git配置"></a>git配置</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git<span class="built_in"> config </span>--global user.email <span class="string">"dwj999@163.com"</span> </span><br><span class="line">git<span class="built_in"> config </span>--global user.name <span class="string">"dwj999"</span></span><br><span class="line">ssh-keygen -t rsa -C <span class="string">"dwj999@163.com"</span>   #一路回车，如已生成过，可覆盖成功后会~/.ssh目录生成key，复制id_rsa.pub内容</span><br></pre></td></tr></table></figure><h3 id="添加key"><a href="#添加key" class="headerlink" title="添加key"></a>添加key</h3><p><img src="http://note.youdao.com/yws/public/resource/07bf646071b1146a82f5002fd9e53bcd/xmlnote/A9D5315CE0594ADE8E715BC14F63E122/30886" alt="image"></p><p>打开github地址：<a href="https://github.com/settings/ssh，打开ssh" target="_blank" rel="noopener">https://github.com/settings/ssh，打开ssh</a> keys，添加key<br><img src="http://note.youdao.com/yws/public/resource/07bf646071b1146a82f5002fd9e53bcd/xmlnote/1B4451F32C0642FEBD6868200D58DD70/30896" alt="image"></p><h3 id="代码上传"><a href="#代码上传" class="headerlink" title="代码上传"></a>代码上传</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># linux编译</span><br><span class="line">hexo <span class="keyword">generate</span></span><br><span class="line"># 在主机的hexo目录下 执行以下命令将自动更新到Github</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure><h3 id="站点访问，左面菜单和主题已经配置过"><a href="#站点访问，左面菜单和主题已经配置过" class="headerlink" title="站点访问，左面菜单和主题已经配置过"></a>站点访问，左面菜单和主题已经配置过</h3><p><img src="http://note.youdao.com/yws/public/resource/07bf646071b1146a82f5002fd9e53bcd/xmlnote/82160EF561E54B88B6428812E6822255/30925" alt="image"></p><h2 id="主题和配置文件"><a href="#主题和配置文件" class="headerlink" title="主题和配置文件"></a>主题和配置文件</h2><p>切换到站点目录，下载主题代码<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/hwdata/</span>dwj999</span><br><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/iissnan/</span>hexo-theme-<span class="keyword">next</span> themes<span class="regexp">/next    #主题的配置文件，位于 hexo/</span>theme<span class="regexp">/next/</span>_config.yml</span><br></pre></td></tr></table></figure></p><p>配置主题<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim _config.yml</span><br><span class="line"><span class="meta"># 找到theme:修改后面的参数，默认是landscape</span></span><br><span class="line">theme: <span class="keyword">next</span></span><br><span class="line">hexo d -g <span class="meta">#重新编译，上传</span></span><br></pre></td></tr></table></figure></p><p>主题和第三方服务说明<br>官方文档很详情<br>请参考：<br><a href="http://theme-next.iissnan.com/getting-started.html" target="_blank" rel="noopener">http://theme-next.iissnan.com/getting-started.html</a><br><a href="http://theme-next.iissnan.com/theme-settings.html" target="_blank" rel="noopener">http://theme-next.iissnan.com/theme-settings.html</a><br><a href="http://theme-next.iissnan.com/third-party-services.html" target="_blank" rel="noopener">http://theme-next.iissnan.com/third-party-services.html</a>   </p><h2 id="发布文章"><a href="#发布文章" class="headerlink" title="发布文章"></a>发布文章</h2><p>由于hexo支持markdown写文章，并且我使用的是windows机器，代码发布在linux机器上，所以选择了有道云笔记的markdown笔记来写文章，虽然语法支持有缺陷，但是以前习惯了使用有道云，没有使用其他工具，像Cmd Markdown的在线编辑器也不错。<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo <span class="keyword">new</span> <span class="string">"hexo next 在github上搭建个人博客"</span> <span class="meta">#创建了一个博客文章</span></span><br></pre></td></tr></table></figure></p><p><img src="http://note.youdao.com/yws/public/resource/07bf646071b1146a82f5002fd9e53bcd/xmlnote/86071474F1B14AAFAC852DF6D36FC8FB/30979" alt="image"><br>再使用有道云的markdown进行写文章，写好后，导出，上传到github。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;目前网上的很多平台都提供了博客功能，如csdn，51cto，cnblog，iteye等等，只要你想写博客，这些平台都可以选择。只需注册个帐号
      
    
    </summary>
    
      <category term="工具" scheme="https://dwj999.github.io/categories/%E5%B7%A5%E5%85%B7/"/>
    
    
      <category term="hexo" scheme="https://dwj999.github.io/tags/hexo/"/>
    
      <category term="next" scheme="https://dwj999.github.io/tags/next/"/>
    
      <category term="github" scheme="https://dwj999.github.io/tags/github/"/>
    
  </entry>
  
</feed>
