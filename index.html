<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Jiessie's' Blog" type="application/atom+xml" />






<meta name="description" content="最怕一生碌碌无为,还说平凡难能可贵！">
<meta property="og:type" content="website">
<meta property="og:title" content="Jiessie&#39;s&#39; Blog">
<meta property="og:url" content="https://dwj999.github.io/index.html">
<meta property="og:site_name" content="Jiessie&#39;s&#39; Blog">
<meta property="og:description" content="最怕一生碌碌无为,还说平凡难能可贵！">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jiessie&#39;s&#39; Blog">
<meta name="twitter:description" content="最怕一生碌碌无为,还说平凡难能可贵！">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dwj999.github.io/"/>





<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

  <title>Jiessie's' Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"><a href="https://github.com/dwj999" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jiessie's' Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">没伞的孩子必须努力奔跑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/gh-ost-使用教程.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/gh-ost-使用教程.html" itemprop="url">gh-ost 使用教程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-11T14:02:16+08:00">
                2018-10-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工具/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>gh-ost 是github开源的在线DDL工具，从发布之后就受到了同行的广泛关注，由于其采用的伪装从库的方式同步增量DML，比pt-online-schema-change采用的触发器更友好，且生产开销较小，是一款很优秀的在线DDL工具。</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><h3 id="gh-ost-介绍"><a href="#gh-ost-介绍" class="headerlink" title="gh-ost 介绍"></a>gh-ost 介绍</h3><p>gh-ost 作为一个伪装的备库，可以从主库/备库上拉取 binlog，过滤之后重新应用到主库上去，相当于主库上的增量操作通过 binlog 又应用回主库本身，不过是应用在幽灵表上。<br><br><img src="http://qanp7f2om.bkt.clouddn.com/gh-ost01.png" alt="image"></p>
<p>大致工作过程：<br><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1.gh-ost 首先连接到主库上，根据 <span class="keyword">alter</span> 语句创建幽灵表</span><br><span class="line"><span class="number">2.</span>然后作为一个备库连接到其中一个真正的备库或者主库上(根据具体的参数来定)，一边在主库上拷贝已有的数据到幽灵表，一边从备库上拉取增量数据的 <span class="keyword">binlog</span>，然后不断的把 <span class="keyword">binlog</span> 应用回主库</span><br><span class="line"><span class="number">3.</span>等待全部数据同步完成，进行 cut-<span class="keyword">over</span> 幽灵表和原表切换</span><br></pre></td></tr></table></figure></p>
<h3 id="general-log"><a href="#general-log" class="headerlink" title="general_log"></a>general_log</h3><p>通过打开mysql的general_log，查看gh-ost的具体执行过程：<br><br>mysql: 5.7.22<br><br>gh-ost：1.0.48<br><br>此案例使用了–allow-on-master 参数，DDL在主库上操作<br><br>执行语句：<br><br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">./gh-ost \</span><br><span class="line">-<span class="ruby">-max-load=Threads_running=<span class="number">25</span> \</span></span><br><span class="line"><span class="ruby">--critical-load=Threads_running=<span class="number">512</span> \</span></span><br><span class="line"><span class="ruby">--chunk-size=<span class="number">1000</span> \</span></span><br><span class="line"><span class="ruby">--initially-drop-old-table \</span></span><br><span class="line"><span class="ruby">--initially-drop-ghost-table \</span></span><br><span class="line"><span class="ruby">--initially-drop-socket-file \</span></span><br><span class="line"><span class="ruby">--ok-to-drop-table \</span></span><br><span class="line"><span class="ruby">--conf=<span class="string">"/etc/my.cnf"</span> \</span></span><br><span class="line"><span class="ruby">--host=<span class="string">"localhost"</span> \</span></span><br><span class="line"><span class="ruby">--port=<span class="number">3306</span> \</span></span><br><span class="line"><span class="ruby">--user=<span class="string">"root"</span> \</span></span><br><span class="line"><span class="ruby">--password=<span class="string">"xxx"</span> \</span></span><br><span class="line"><span class="ruby">--database=<span class="string">"test"</span> \</span></span><br><span class="line"><span class="ruby">--table=<span class="string">"employee1"</span> \</span></span><br><span class="line"><span class="ruby">--verbose \</span></span><br><span class="line"><span class="ruby">--alter=<span class="string">"engine=innodb"</span> \</span></span><br><span class="line"><span class="ruby">--switch-to-rbr \</span></span><br><span class="line"><span class="ruby">--allow-on-master \</span></span><br><span class="line"><span class="ruby">--allow-master-master \</span></span><br><span class="line"><span class="ruby">--cut-over=default \</span></span><br><span class="line"><span class="ruby">--default-retries=<span class="number">120</span> \</span></span><br><span class="line"><span class="ruby">--panic-flag-file=<span class="regexp">/tmp/ghost</span>.panic.flag \</span></span><br><span class="line"><span class="ruby">--execute</span></span><br></pre></td></tr></table></figure></p>
<p>执行过程：<br><br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">2018-10<span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">27</span> INFO starting gh-ost <span class="number">1.0</span><span class="number">.48</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">27</span> INFO Migrating <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">27</span> INFO connection validated <span class="keyword">on</span> localhost:<span class="number">3306</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">27</span> INFO <span class="keyword">User</span> has <span class="keyword">ALL</span> privileges</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">27</span> INFO <span class="keyword">binary</span> logs validated <span class="keyword">on</span> localhost:<span class="number">3306</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">27</span> INFO Restarting replication <span class="keyword">on</span> localhost:<span class="number">3306</span> <span class="keyword">to</span> make sure binlog settings apply <span class="keyword">to</span> replication thread</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">27</span> INFO Inspector initiated <span class="keyword">on</span> VM_24_101_centos:<span class="number">3306</span>, version <span class="number">5.7</span><span class="number">.22</span>-<span class="built_in">log</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">27</span> INFO Table found. Engine=InnoDB</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Estimated <span class="keyword">number</span> of rows <span class="keyword">via</span> <span class="keyword">EXPLAIN</span>: <span class="number">10028</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Recursively searching <span class="keyword">for</span> replication master</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Master found <span class="keyword">to</span> be VM_24_101_centos:<span class="number">3306</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO log_slave_updates validated <span class="keyword">on</span> localhost:<span class="number">3306</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO connection validated <span class="keyword">on</span> localhost:<span class="number">3306</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Connecting binlog streamer at bin<span class="number">.000070</span>:<span class="number">320607755</span></span><br><span class="line">[<span class="number">2020</span>/<span class="number">05</span>/<span class="number">29</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span>] [info] binlogsyncer.go:<span class="number">133</span> <span class="keyword">create</span> BinlogSyncer <span class="keyword">with</span> config &#123;<span class="number">99999</span> mysql localhost <span class="number">3306</span> root    <span class="literal">false</span> <span class="literal">false</span> &lt;nil&gt; <span class="literal">false</span> UTC <span class="literal">true</span> <span class="number">0</span> <span class="number">0</span>s <span class="number">0</span>s <span class="number">0</span> <span class="literal">false</span>&#125;</span><br><span class="line">[<span class="number">2020</span>/<span class="number">05</span>/<span class="number">29</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span>] [info] binlogsyncer.go:<span class="number">354</span> <span class="keyword">begin</span> <span class="keyword">to</span> sync binlog <span class="keyword">from</span> <span class="built_in">position</span> (bin<span class="number">.000070</span>, <span class="number">320607755</span>)</span><br><span class="line">[<span class="number">2020</span>/<span class="number">05</span>/<span class="number">29</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span>] [info] binlogsyncer.go:<span class="number">203</span> register slave <span class="keyword">for</span> master server localhost:<span class="number">3306</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO rotate <span class="keyword">to</span> next <span class="built_in">log</span> <span class="keyword">from</span> bin<span class="number">.000070</span>:<span class="number">0</span> <span class="keyword">to</span> bin<span class="number">.000070</span></span><br><span class="line">[<span class="number">2020</span>/<span class="number">05</span>/<span class="number">29</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span>] [info] binlogsyncer.go:<span class="number">723</span> rotate <span class="keyword">to</span> (bin<span class="number">.000070</span>, <span class="number">320607755</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO connection validated <span class="keyword">on</span> localhost:<span class="number">3306</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO connection validated <span class="keyword">on</span> localhost:<span class="number">3306</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO will <span class="keyword">use</span> time_zone=<span class="string">'SYSTEM'</span> <span class="keyword">on</span> applier</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Examining table structure <span class="keyword">on</span> applier</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Applier initiated <span class="keyword">on</span> VM_24_101_centos:<span class="number">3306</span>, version <span class="number">5.7</span><span class="number">.22</span>-<span class="built_in">log</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Dropping table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_gho`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Table dropped</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Dropping table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_del`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Table dropped</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Dropping table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_ghc`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Table dropped</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Creating changelog table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_ghc`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Changelog table created</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Creating ghost table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_gho`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Ghost table created</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Altering ghost table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_gho`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Ghost table altered</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Intercepted changelog state GhostTableMigrated</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Waiting <span class="keyword">for</span> ghost table <span class="keyword">to</span> be migrated. Current lag <span class="keyword">is</span> <span class="number">0</span>s</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Handled changelog state GhostTableMigrated</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Chosen shared <span class="keyword">unique</span> <span class="keyword">key</span> <span class="keyword">is</span> <span class="keyword">PRIMARY</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Shared columns are id,employeeid,employeename</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Listening <span class="keyword">on</span> unix socket file: /tmp/gh-ost.test.employee1.sock</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Migration <span class="built_in">min</span> <span class="keyword">values</span>: [<span class="number">1</span>]</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Migration <span class="built_in">max</span> <span class="keyword">values</span>: [<span class="number">10000</span>]</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO Waiting <span class="keyword">for</span> <span class="keyword">first</span> throttle metrics <span class="keyword">to</span> be collected</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">28</span> INFO <span class="keyword">First</span> throttle metrics collected</span><br><span class="line"># Migrating <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>; Ghost table is `test`.`_employee1_gho`</span><br><span class="line"># Migrating VM_24_101_centos:3306; inspecting VM_24_101_centos:3306; executing on VM_24_101_centos</span><br><span class="line"># Migration started at Fri May 29 15:38:27 +0800 2020</span><br><span class="line"># chunk-size: 1000; max-lag-millis: 1500ms; dml-batch-size: 10; max-load: Threads_running=25; critical-load: Threads_running=512; nice-ratio: 0.000000</span><br><span class="line"># throttle-additional-flag-file: /tmp/gh-ost.throttle </span><br><span class="line"># panic-flag-file: /tmp/ghost.panic.flag</span><br><span class="line"># Serving on unix socket: /tmp/gh-ost.test.employee1.sock</span><br><span class="line">Copy: 0/10028 0.0%; Applied: 0; Backlog: 0/1000; Time: 0s(total), 0s(copy); streamer: bin.000070:320610958; State: migrating; ETA: N/A</span><br><span class="line">Copy: 0/10028 0.0%; Applied: 0; Backlog: 0/1000; Time: 1s(total), 1s(copy); streamer: bin.000070:320618234; State: migrating; ETA: N/A</span><br><span class="line">2018-10<span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">29</span> INFO Row copy complete</span><br><span class="line">Copy: <span class="number">10000</span>/<span class="number">10000</span> <span class="number">100.0</span>%; Applied: 0; Backlog: 0/1000; Time: 1s(total), 1s(copy); streamer: bin.000070:320813452; State: migrating; ETA: due</span><br><span class="line">2018-10<span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">29</span> INFO Grabbing voluntary lock: gh-ost<span class="number">.40312</span>.lock</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">29</span> INFO Setting LOCK timeout <span class="keyword">as</span> <span class="number">6</span> seconds</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">29</span> INFO Looking <span class="keyword">for</span> magic cut-<span class="keyword">over</span> table</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">29</span> INFO Creating magic cut-<span class="keyword">over</span> table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_del`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">29</span> INFO Magic cut-<span class="keyword">over</span> table created</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">29</span> INFO Locking <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>, <span class="symbol">`test`</span>.<span class="symbol">`_employee1_del`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">29</span> INFO Tables locked</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">29</span> INFO Session locking original &amp; magic tables <span class="keyword">is</span> <span class="number">40312</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">29</span> INFO Writing changelog state: AllEventsUpToLockProcessed:<span class="number">1590737909807671836</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">29</span> INFO Intercepted changelog state AllEventsUpToLockProcessed</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">29</span> INFO Handled changelog state AllEventsUpToLockProcessed</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">29</span> INFO Waiting <span class="keyword">for</span> events up <span class="keyword">to</span> lock</span><br><span class="line">Copy: <span class="number">10000</span>/<span class="number">10000</span> <span class="number">100.0</span>%; Applied: 0; Backlog: 1/1000; Time: 2s(total), 1s(copy); streamer: bin.000070:320823747; State: migrating; ETA: due</span><br><span class="line">2018-10<span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">30</span> INFO Waiting <span class="keyword">for</span> events up <span class="keyword">to</span> lock: got AllEventsUpToLockProcessed:<span class="number">1590737909807671836</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">30</span> INFO Done waiting <span class="keyword">for</span> events up <span class="keyword">to</span> lock; duration=974.564957ms</span><br><span class="line"># Migrating `test`.`employee1`; Ghost table is `test`.`_employee1_gho`</span><br><span class="line"># Migrating VM_24_101_centos:3306; inspecting VM_24_101_centos:3306; executing on VM_24_101_centos</span><br><span class="line"># Migration started at Fri May 29 15:38:27 +0800 2020</span><br><span class="line"># chunk-size: 1000; max-lag-millis: 1500ms; dml-batch-size: 10; max-load: Threads_running=25; critical-load: Threads_running=512; nice-ratio: 0.000000</span><br><span class="line"># throttle-additional-flag-file: /tmp/gh-ost.throttle </span><br><span class="line"># panic-flag-file: /tmp/ghost.panic.flag</span><br><span class="line"># Serving on unix socket: /tmp/gh-ost.test.employee1.sock</span><br><span class="line">Copy: 10000/10000 100.0%; Applied: 0; Backlog: 0/1000; Time: 2s(total), 1s(copy); streamer: bin.000070:320825878; State: migrating; ETA: due</span><br><span class="line">2018-10<span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">30</span> INFO Setting <span class="keyword">RENAME</span> timeout <span class="keyword">as</span> <span class="number">3</span> seconds</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">30</span> INFO Session renaming tables <span class="keyword">is</span> <span class="number">40314</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">30</span> INFO Issuing <span class="keyword">and</span> expecting this <span class="keyword">to</span> block: <span class="keyword">rename</span> <span class="comment">/* gh-ost */</span> table <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">to</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_del`</span>, <span class="symbol">`test`</span>.<span class="symbol">`_employee1_gho`</span> <span class="keyword">to</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span></span><br><span class="line">Copy: <span class="number">10000</span>/<span class="number">10000</span> <span class="number">100.0</span>%; Applied: 0; Backlog: 0/1000; Time: 3s(total), 1s(copy); streamer: bin.000070:320832073; State: migrating; ETA: due</span><br><span class="line">2018-10<span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Found atomic <span class="keyword">RENAME</span> <span class="keyword">to</span> be blocking, <span class="keyword">as</span> expected. Double checking the lock <span class="keyword">is</span> still <span class="keyword">in</span> place (though I don t strictly have <span class="keyword">to</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Checking session lock: gh-ost<span class="number">.40312</span>.lock</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Connection holding lock <span class="keyword">on</span> original table still <span class="keyword">exists</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Will now proceed <span class="keyword">to</span> <span class="keyword">drop</span> magic table <span class="keyword">and</span> unlock tables</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Dropping magic cut-<span class="keyword">over</span> table</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Releasing lock <span class="keyword">from</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>, <span class="symbol">`test`</span>.<span class="symbol">`_employee1_del`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Tables unlocked</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Tables renamed</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Lock &amp; <span class="keyword">rename</span> duration: <span class="number">2.021372845</span>s. During this time, queries <span class="keyword">on</span> <span class="symbol">`employee1`</span> were blocked</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Looking <span class="keyword">for</span> magic cut-<span class="keyword">over</span> table</span><br><span class="line">[<span class="number">2020</span>/<span class="number">05</span>/<span class="number">29</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span>] [info] binlogsyncer.go:<span class="number">164</span> syncer <span class="keyword">is</span> closing...</span><br><span class="line">[<span class="number">2020</span>/<span class="number">05</span>/<span class="number">29</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span>] [error] binlogstreamer.go:<span class="number">77</span> close sync <span class="keyword">with</span> err: sync <span class="keyword">is</span> been closing...</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Closed streamer connection. err=&lt;nil&gt;</span><br><span class="line">[<span class="number">2020</span>/<span class="number">05</span>/<span class="number">29</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span>] [info] binlogsyncer.go:<span class="number">179</span> syncer <span class="keyword">is</span> closed</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Dropping table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_ghc`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Table dropped</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Dropping table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_del`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Table dropped</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Done migrating <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Removing socket file: /tmp/gh-ost.test.employee1.sock</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Tearing down inspector</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Tearing down applier</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Tearing down streamer</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span> <span class="number">15</span>:<span class="number">38</span>:<span class="number">31</span> INFO Tearing down throttler</span><br><span class="line"># Done</span><br><span class="line">[mysql@VM_24_101_centos ~]$</span><br></pre></td></tr></table></figure></p>
<p>打印的general_log：<br><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br></pre></td><td class="code"><pre><span class="line">2018-10-11T15:38:27.796759+08:00	40303 Connect	root@127.0.0.1 on test using TCP/IP</span><br><span class="line">2018-10-11T15:38:27.796967+08:00	40303 Query	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.797151</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.797283</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.797446</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> @@global.version</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.797751</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> @@global.port</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.797976</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> @@global.hostname, @@global.port</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.798176</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="comment">/* gh-ost */</span> <span class="keyword">grants</span> <span class="keyword">for</span> <span class="keyword">current_user</span>()</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.798307</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> @@global.log_bin, @@global.binlog_format</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.798396</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> @@global.binlog_row_image</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.799003</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40304</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> information_schema <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.799177</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40304</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.799343</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40304</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.799460</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40304</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.799571</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40304</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.799829</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40304</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.799880</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">status</span> <span class="keyword">from</span> <span class="string">`test`</span> <span class="keyword">like</span> <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">27.800450</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span></span><br><span class="line">			<span class="keyword">SUM</span>(REFERENCED_TABLE_NAME <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">AND</span> TABLE_SCHEMA=<span class="string">'test'</span> <span class="keyword">AND</span> TABLE_NAME=<span class="string">'employee1'</span>) <span class="keyword">as</span> num_child_side_fk,</span><br><span class="line">			<span class="keyword">SUM</span>(REFERENCED_TABLE_NAME <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">AND</span> REFERENCED_TABLE_SCHEMA=<span class="string">'test'</span> <span class="keyword">AND</span> REFERENCED_TABLE_NAME=<span class="string">'employee1'</span>) <span class="keyword">as</span> num_parent_side_fk</span><br><span class="line">		<span class="keyword">FROM</span> INFORMATION_SCHEMA.KEY_COLUMN_USAGE</span><br><span class="line">		<span class="keyword">WHERE</span></span><br><span class="line">				REFERENCED_TABLE_NAME <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span></span><br><span class="line">				<span class="keyword">AND</span> ((TABLE_SCHEMA=<span class="string">'test'</span> <span class="keyword">AND</span> TABLE_NAME=<span class="string">'employee1'</span>)</span><br><span class="line">					<span class="keyword">OR</span> (REFERENCED_TABLE_SCHEMA=<span class="string">'test'</span> <span class="keyword">AND</span> REFERENCED_TABLE_NAME=<span class="string">'employee1'</span>)</span><br><span class="line">				)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.328510</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> num_triggers</span><br><span class="line">			<span class="keyword">FROM</span> INFORMATION_SCHEMA.TRIGGERS</span><br><span class="line">			<span class="keyword">WHERE</span></span><br><span class="line">				TRIGGER_SCHEMA=<span class="string">'test'</span></span><br><span class="line">				<span class="keyword">AND</span> EVENT_OBJECT_TABLE=<span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.334174</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">explain</span> <span class="keyword">select</span> <span class="comment">/* gh-ost */</span> * <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">where</span> <span class="number">1</span>=<span class="number">1</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.359593</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span></span><br><span class="line">      COLUMNS.TABLE_SCHEMA,</span><br><span class="line">      COLUMNS.TABLE_NAME,</span><br><span class="line">      COLUMNS.COLUMN_NAME,</span><br><span class="line">      UNIQUES.INDEX_NAME,</span><br><span class="line">      UNIQUES.COLUMN_NAMES,</span><br><span class="line">      UNIQUES.COUNT_COLUMN_IN_INDEX,</span><br><span class="line">      COLUMNS.DATA_TYPE,</span><br><span class="line">      COLUMNS.CHARACTER_SET_NAME,</span><br><span class="line">			<span class="keyword">LOCATE</span>(<span class="string">'auto_increment'</span>, EXTRA) &gt; <span class="number">0</span> <span class="keyword">as</span> is_auto_increment,</span><br><span class="line">      has_nullable</span><br><span class="line">    <span class="keyword">FROM</span> INFORMATION_SCHEMA.COLUMNS <span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">      <span class="keyword">SELECT</span></span><br><span class="line">        TABLE_SCHEMA,</span><br><span class="line">        TABLE_NAME,</span><br><span class="line">        INDEX_NAME,</span><br><span class="line">        <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> COUNT_COLUMN_IN_INDEX,</span><br><span class="line">        <span class="keyword">GROUP_CONCAT</span>(COLUMN_NAME <span class="keyword">ORDER</span> <span class="keyword">BY</span> SEQ_IN_INDEX <span class="keyword">ASC</span>) <span class="keyword">AS</span> COLUMN_NAMES,</span><br><span class="line">        SUBSTRING_INDEX(<span class="keyword">GROUP_CONCAT</span>(COLUMN_NAME <span class="keyword">ORDER</span> <span class="keyword">BY</span> SEQ_IN_INDEX <span class="keyword">ASC</span>), <span class="string">','</span>, <span class="number">1</span>) <span class="keyword">AS</span> FIRST_COLUMN_NAME,</span><br><span class="line">        <span class="keyword">SUM</span>(NULLABLE=<span class="string">'YES'</span>) &gt; <span class="number">0</span> <span class="keyword">AS</span> has_nullable</span><br><span class="line">      <span class="keyword">FROM</span> INFORMATION_SCHEMA.STATISTICS</span><br><span class="line">      <span class="keyword">WHERE</span></span><br><span class="line">				NON_UNIQUE=<span class="number">0</span></span><br><span class="line">				<span class="keyword">AND</span> TABLE_SCHEMA = <span class="string">'test'</span></span><br><span class="line">      	<span class="keyword">AND</span> TABLE_NAME = <span class="string">'employee1'</span></span><br><span class="line">      <span class="keyword">GROUP</span> <span class="keyword">BY</span> TABLE_SCHEMA, TABLE_NAME, INDEX_NAME</span><br><span class="line">    ) <span class="keyword">AS</span> UNIQUES</span><br><span class="line">    <span class="keyword">ON</span> (</span><br><span class="line">      COLUMNS.COLUMN_NAME = UNIQUES.FIRST_COLUMN_NAME</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">WHERE</span></span><br><span class="line">      COLUMNS.TABLE_SCHEMA = <span class="string">'test'</span></span><br><span class="line">      <span class="keyword">AND</span> COLUMNS.TABLE_NAME = <span class="string">'employee1'</span></span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">      COLUMNS.TABLE_SCHEMA, COLUMNS.TABLE_NAME,</span><br><span class="line">      <span class="keyword">CASE</span> UNIQUES.INDEX_NAME</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="string">'PRIMARY'</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">END</span>,</span><br><span class="line">      <span class="keyword">CASE</span> has_nullable</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">0</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">END</span>,</span><br><span class="line">      <span class="keyword">CASE</span> <span class="keyword">IFNULL</span>(CHARACTER_SET_NAME, <span class="string">''</span>)</span><br><span class="line">          <span class="keyword">WHEN</span> <span class="string">''</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">          <span class="keyword">ELSE</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">END</span>,</span><br><span class="line">      <span class="keyword">CASE</span> DATA_TYPE</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="string">'tinyint'</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="string">'smallint'</span> <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="string">'int'</span> <span class="keyword">THEN</span> <span class="number">2</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="string">'bigint'</span> <span class="keyword">THEN</span> <span class="number">3</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="number">100</span></span><br><span class="line">      <span class="keyword">END</span>,</span><br><span class="line">      COUNT_COLUMN_IN_INDEX</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.361667</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.362720</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40305</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> information_schema <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.362951</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40305</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.363171</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40305</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.363300</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40305</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.363417</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40305</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.363647</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40305</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.363739</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> @@global.log_slave_updates</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.364010</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> @@global.version</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.364218</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> @@global.port</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.364408</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="comment">/* gh-ost readCurrentBinlogCoordinates */</span> <span class="keyword">master</span> <span class="keyword">status</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.365328</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40306</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span>  <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.365632</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40306</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'BINLOG_CHECKSUM'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.366882</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40306</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> @master_binlog_checksum=<span class="string">'NONE'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.367450</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40306</span> <span class="keyword">Binlog</span> Dump	<span class="keyword">Log</span>: <span class="string">'bin.000070'</span>  Pos: <span class="number">320607755</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.367748</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> @@global.version</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.368343</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> @@global.port</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.368961</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40307</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.369102</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40307</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.369202</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40307</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.369283</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40307</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.369362</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40307</span> <span class="keyword">Query</span>	<span class="keyword">select</span> @@global.version</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.369513</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40307</span> <span class="keyword">Query</span>	<span class="keyword">select</span> @@global.port</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.369636</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> @@global.time_zone</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.369918</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> @@global.hostname, @@global.port</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.370060</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.370612</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">drop</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.377122</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">status</span> <span class="keyword">from</span> <span class="string">`test`</span> <span class="keyword">like</span> <span class="string">'_employee1_gho'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.377393</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">drop</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="string">`test`</span>.<span class="string">`_employee1_del`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.378699</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">status</span> <span class="keyword">from</span> <span class="string">`test`</span> <span class="keyword">like</span> <span class="string">'_employee1_del'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.378938</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">drop</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.385496</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">create</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> (</span><br><span class="line">			<span class="keyword">id</span> <span class="built_in">bigint</span> auto_increment,</span><br><span class="line">			last_update <span class="keyword">timestamp</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">			hint <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">charset</span> <span class="keyword">ascii</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">			<span class="keyword">value</span> <span class="built_in">varchar</span>(<span class="number">4096</span>) <span class="keyword">charset</span> <span class="keyword">ascii</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">			primary <span class="keyword">key</span>(<span class="keyword">id</span>),</span><br><span class="line">			<span class="keyword">unique</span> <span class="keyword">key</span> hint_uidx(hint)</span><br><span class="line">		) auto_increment=<span class="number">256</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.419446</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">create</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> <span class="keyword">like</span> <span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.445917</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">alter</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> <span class="keyword">engine</span>=<span class="keyword">innodb</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.480994</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">2</span>, <span class="number">0</span>), <span class="string">'state'</span>, <span class="string">'GhostTableMigrated'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.483727</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="string">'state at 1590737908483609931'</span>, <span class="string">'GhostTableMigrated'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.487362</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:28.487157014+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.487438</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40308</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> information_schema <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.487582</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40308</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.487684</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40308</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.487744</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40308</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.487897</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40308</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.488401</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.488525</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.488614</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.488679</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.488893</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span></span><br><span class="line">      COLUMNS.TABLE_SCHEMA,</span><br><span class="line">      COLUMNS.TABLE_NAME,</span><br><span class="line">      COLUMNS.COLUMN_NAME,</span><br><span class="line">      UNIQUES.INDEX_NAME,</span><br><span class="line">      UNIQUES.COLUMN_NAMES,</span><br><span class="line">      UNIQUES.COUNT_COLUMN_IN_INDEX,</span><br><span class="line">      COLUMNS.DATA_TYPE,</span><br><span class="line">      COLUMNS.CHARACTER_SET_NAME,</span><br><span class="line">			<span class="keyword">LOCATE</span>(<span class="string">'auto_increment'</span>, EXTRA) &gt; <span class="number">0</span> <span class="keyword">as</span> is_auto_increment,</span><br><span class="line">      has_nullable</span><br><span class="line">    <span class="keyword">FROM</span> INFORMATION_SCHEMA.COLUMNS <span class="keyword">INNER</span> <span class="keyword">JOIN</span> (</span><br><span class="line">      <span class="keyword">SELECT</span></span><br><span class="line">        TABLE_SCHEMA,</span><br><span class="line">        TABLE_NAME,</span><br><span class="line">        INDEX_NAME,</span><br><span class="line">        <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> COUNT_COLUMN_IN_INDEX,</span><br><span class="line">        <span class="keyword">GROUP_CONCAT</span>(COLUMN_NAME <span class="keyword">ORDER</span> <span class="keyword">BY</span> SEQ_IN_INDEX <span class="keyword">ASC</span>) <span class="keyword">AS</span> COLUMN_NAMES,</span><br><span class="line">        SUBSTRING_INDEX(<span class="keyword">GROUP_CONCAT</span>(COLUMN_NAME <span class="keyword">ORDER</span> <span class="keyword">BY</span> SEQ_IN_INDEX <span class="keyword">ASC</span>), <span class="string">','</span>, <span class="number">1</span>) <span class="keyword">AS</span> FIRST_COLUMN_NAME,</span><br><span class="line">        <span class="keyword">SUM</span>(NULLABLE=<span class="string">'YES'</span>) &gt; <span class="number">0</span> <span class="keyword">AS</span> has_nullable</span><br><span class="line">      <span class="keyword">FROM</span> INFORMATION_SCHEMA.STATISTICS</span><br><span class="line">      <span class="keyword">WHERE</span></span><br><span class="line">				NON_UNIQUE=<span class="number">0</span></span><br><span class="line">				<span class="keyword">AND</span> TABLE_SCHEMA = <span class="string">'test'</span></span><br><span class="line">      	<span class="keyword">AND</span> TABLE_NAME = <span class="string">'_employee1_gho'</span></span><br><span class="line">      <span class="keyword">GROUP</span> <span class="keyword">BY</span> TABLE_SCHEMA, TABLE_NAME, INDEX_NAME</span><br><span class="line">    ) <span class="keyword">AS</span> UNIQUES</span><br><span class="line">    <span class="keyword">ON</span> (</span><br><span class="line">      COLUMNS.COLUMN_NAME = UNIQUES.FIRST_COLUMN_NAME</span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">WHERE</span></span><br><span class="line">      COLUMNS.TABLE_SCHEMA = <span class="string">'test'</span></span><br><span class="line">      <span class="keyword">AND</span> COLUMNS.TABLE_NAME = <span class="string">'_employee1_gho'</span></span><br><span class="line">    <span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line">      COLUMNS.TABLE_SCHEMA, COLUMNS.TABLE_NAME,</span><br><span class="line">      <span class="keyword">CASE</span> UNIQUES.INDEX_NAME</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="string">'PRIMARY'</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">END</span>,</span><br><span class="line">      <span class="keyword">CASE</span> has_nullable</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="number">0</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">END</span>,</span><br><span class="line">      <span class="keyword">CASE</span> <span class="keyword">IFNULL</span>(CHARACTER_SET_NAME, <span class="string">''</span>)</span><br><span class="line">          <span class="keyword">WHEN</span> <span class="string">''</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">          <span class="keyword">ELSE</span> <span class="number">1</span></span><br><span class="line">      <span class="keyword">END</span>,</span><br><span class="line">      <span class="keyword">CASE</span> DATA_TYPE</span><br><span class="line">        <span class="keyword">WHEN</span> <span class="string">'tinyint'</span> <span class="keyword">THEN</span> <span class="number">0</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="string">'smallint'</span> <span class="keyword">THEN</span> <span class="number">1</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="string">'int'</span> <span class="keyword">THEN</span> <span class="number">2</span></span><br><span class="line">        <span class="keyword">WHEN</span> <span class="string">'bigint'</span> <span class="keyword">THEN</span> <span class="number">3</span></span><br><span class="line">        <span class="keyword">ELSE</span> <span class="number">100</span></span><br><span class="line">      <span class="keyword">END</span>,</span><br><span class="line">      COUNT_COLUMN_IN_INDEX</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.490030</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">columns</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.490435</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">select</span></span><br><span class="line">				*</span><br><span class="line">			<span class="keyword">from</span></span><br><span class="line">				information_schema.columns</span><br><span class="line">			<span class="keyword">where</span></span><br><span class="line">				table_schema=<span class="string">'test'</span></span><br><span class="line">				<span class="keyword">and</span> table_name=<span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.491220</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">select</span></span><br><span class="line">				*</span><br><span class="line">			<span class="keyword">from</span></span><br><span class="line">				information_schema.columns</span><br><span class="line">			<span class="keyword">where</span></span><br><span class="line">				table_schema=<span class="string">'test'</span></span><br><span class="line">				<span class="keyword">and</span> table_name=<span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.491648</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">select</span></span><br><span class="line">				*</span><br><span class="line">			<span class="keyword">from</span></span><br><span class="line">				information_schema.columns</span><br><span class="line">			<span class="keyword">where</span></span><br><span class="line">				table_schema=<span class="string">'test'</span></span><br><span class="line">				<span class="keyword">and</span> table_name=<span class="string">'_employee1_gho'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.492166</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> <span class="comment">/* gh-ost `test`.`employee1` */</span> <span class="string">`id`</span></span><br><span class="line">				<span class="keyword">from</span></span><br><span class="line">					<span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line">				<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">					<span class="string">`id`</span> <span class="keyword">asc</span></span><br><span class="line">				<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.492369</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">select</span> <span class="comment">/* gh-ost `test`.`employee1` */</span> <span class="string">`id`</span></span><br><span class="line">				<span class="keyword">from</span></span><br><span class="line">					<span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line">				<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">					<span class="string">`id`</span> <span class="keyword">desc</span></span><br><span class="line">				<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.492686</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.492707</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.493066</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.493758</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="string">'copy iteration 0 at 1590737908'</span>, <span class="string">'Copy: 0/10028 0.0%; Applied: 0; Backlog: 0/1000; Time: 0s(total), 0s(copy); streamer: bin.000070:320610958; State: migrating; ETA: N/A'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.592131</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:28.591944857+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.593200</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.692156</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:28.691988298+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.693217</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.792164</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:28.791963767+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.793212</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.892118</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:28.891946977+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.893150</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.992167</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:28.991978+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.993216</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.105879</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:29.105683131+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.105878</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.192162</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:29.191915709+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.193158</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.292151</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:29.291919747+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.293179</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.392095</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:29.391930285+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.393205</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.492159</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:29.491902668+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.493237</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.494187</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.494198</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40311</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.494760</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.494868</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40311</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.495139</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40311</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.495258</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40311</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.495265</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.495466</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.495702</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.496312</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40311</span> <span class="keyword">Query</span>	<span class="keyword">select</span>  <span class="comment">/* gh-ost `test`.`employee1` iteration:0 */</span></span><br><span class="line">						<span class="string">`id`</span></span><br><span class="line">					<span class="keyword">from</span></span><br><span class="line">						<span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line">					<span class="keyword">where</span> ((<span class="string">`id`</span> &gt; _binary<span class="string">'1'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'1'</span>))) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'10000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'10000'</span>)))</span><br><span class="line">					<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">						<span class="string">`id`</span> <span class="keyword">asc</span></span><br><span class="line">					<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">					<span class="keyword">offset</span> <span class="number">999</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.496521</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="string">'copy iteration 0 at 1590737909'</span>, <span class="string">'Copy: 0/10028 0.0%; Applied: 0; Backlog: 0/1000; Time: 1s(total), 1s(copy); streamer: bin.000070:320618234; State: migrating; ETA: N/A'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.496554</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.506595</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.507086</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40311</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.507153</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.507400</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">SET</span></span><br><span class="line">			<span class="keyword">SESSION</span> <span class="keyword">time_zone</span> = <span class="string">'SYSTEM'</span>,</span><br><span class="line">			sql_mode = <span class="keyword">CONCAT</span>(@@session.sql_mode, <span class="string">',STRICT_ALL_TABLES'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.507853</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost `test`.`employee1` */</span> <span class="keyword">ignore</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>)</span><br><span class="line">      (<span class="keyword">select</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">force</span> <span class="keyword">index</span> (<span class="string">`PRIMARY`</span>)</span><br><span class="line">        <span class="keyword">where</span> (((<span class="string">`id`</span> &gt; _binary<span class="string">'1'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'1'</span>))) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'1000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'1000'</span>)))) <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span></span><br><span class="line">      )</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.523454</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">COMMIT</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.533501</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">select</span>  <span class="comment">/* gh-ost `test`.`employee1` iteration:1 */</span></span><br><span class="line">						<span class="string">`id`</span></span><br><span class="line">					<span class="keyword">from</span></span><br><span class="line">						<span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line">					<span class="keyword">where</span> ((<span class="string">`id`</span> &gt; _binary<span class="string">'1000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'10000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'10000'</span>)))</span><br><span class="line">					<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">						<span class="string">`id`</span> <span class="keyword">asc</span></span><br><span class="line">					<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">					<span class="keyword">offset</span> <span class="number">999</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.534075</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.534227</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">SET</span></span><br><span class="line">			<span class="keyword">SESSION</span> <span class="keyword">time_zone</span> = <span class="string">'SYSTEM'</span>,</span><br><span class="line">			sql_mode = <span class="keyword">CONCAT</span>(@@session.sql_mode, <span class="string">',STRICT_ALL_TABLES'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.534369</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost `test`.`employee1` */</span> <span class="keyword">ignore</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>)</span><br><span class="line">      (<span class="keyword">select</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">force</span> <span class="keyword">index</span> (<span class="string">`PRIMARY`</span>)</span><br><span class="line">        <span class="keyword">where</span> (((<span class="string">`id`</span> &gt; _binary<span class="string">'1000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'2000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'2000'</span>)))) <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span></span><br><span class="line">      )</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.543074</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">COMMIT</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.586554</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">select</span>  <span class="comment">/* gh-ost `test`.`employee1` iteration:2 */</span></span><br><span class="line">						<span class="string">`id`</span></span><br><span class="line">					<span class="keyword">from</span></span><br><span class="line">						<span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line">					<span class="keyword">where</span> ((<span class="string">`id`</span> &gt; _binary<span class="string">'2000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'10000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'10000'</span>)))</span><br><span class="line">					<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">						<span class="string">`id`</span> <span class="keyword">asc</span></span><br><span class="line">					<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">					<span class="keyword">offset</span> <span class="number">999</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.587919</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.588183</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">SET</span></span><br><span class="line">			<span class="keyword">SESSION</span> <span class="keyword">time_zone</span> = <span class="string">'SYSTEM'</span>,</span><br><span class="line">			sql_mode = <span class="keyword">CONCAT</span>(@@session.sql_mode, <span class="string">',STRICT_ALL_TABLES'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.588485</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost `test`.`employee1` */</span> <span class="keyword">ignore</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>)</span><br><span class="line">      (<span class="keyword">select</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">force</span> <span class="keyword">index</span> (<span class="string">`PRIMARY`</span>)</span><br><span class="line">        <span class="keyword">where</span> (((<span class="string">`id`</span> &gt; _binary<span class="string">'2000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'3000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'3000'</span>)))) <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span></span><br><span class="line">      )</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.591994</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:29.591866842+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.593465</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.593671</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.593802</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.593936</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.594077</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.602754</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> <span class="keyword">Query</span>	<span class="keyword">COMMIT</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.611800</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.612020</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">select</span>  <span class="comment">/* gh-ost `test`.`employee1` iteration:3 */</span></span><br><span class="line">						<span class="string">`id`</span></span><br><span class="line">					<span class="keyword">from</span></span><br><span class="line">						<span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line">					<span class="keyword">where</span> ((<span class="string">`id`</span> &gt; _binary<span class="string">'3000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'10000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'10000'</span>)))</span><br><span class="line">					<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">						<span class="string">`id`</span> <span class="keyword">asc</span></span><br><span class="line">					<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">					<span class="keyword">offset</span> <span class="number">999</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.612725</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.612883</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">SET</span></span><br><span class="line">			<span class="keyword">SESSION</span> <span class="keyword">time_zone</span> = <span class="string">'SYSTEM'</span>,</span><br><span class="line">			sql_mode = <span class="keyword">CONCAT</span>(@@session.sql_mode, <span class="string">',STRICT_ALL_TABLES'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.613169</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost `test`.`employee1` */</span> <span class="keyword">ignore</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>)</span><br><span class="line">      (<span class="keyword">select</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">force</span> <span class="keyword">index</span> (<span class="string">`PRIMARY`</span>)</span><br><span class="line">        <span class="keyword">where</span> (((<span class="string">`id`</span> &gt; _binary<span class="string">'3000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'4000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'4000'</span>)))) <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span></span><br><span class="line">      )</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.629626</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">COMMIT</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.672734</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">select</span>  <span class="comment">/* gh-ost `test`.`employee1` iteration:4 */</span></span><br><span class="line">						<span class="string">`id`</span></span><br><span class="line">					<span class="keyword">from</span></span><br><span class="line">						<span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line">					<span class="keyword">where</span> ((<span class="string">`id`</span> &gt; _binary<span class="string">'4000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'10000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'10000'</span>)))</span><br><span class="line">					<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">						<span class="string">`id`</span> <span class="keyword">asc</span></span><br><span class="line">					<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">					<span class="keyword">offset</span> <span class="number">999</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.674106</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.674348</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">SET</span></span><br><span class="line">			<span class="keyword">SESSION</span> <span class="keyword">time_zone</span> = <span class="string">'SYSTEM'</span>,</span><br><span class="line">			sql_mode = <span class="keyword">CONCAT</span>(@@session.sql_mode, <span class="string">',STRICT_ALL_TABLES'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.674589</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost `test`.`employee1` */</span> <span class="keyword">ignore</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>)</span><br><span class="line">      (<span class="keyword">select</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">force</span> <span class="keyword">index</span> (<span class="string">`PRIMARY`</span>)</span><br><span class="line">        <span class="keyword">where</span> (((<span class="string">`id`</span> &gt; _binary<span class="string">'4000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'5000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'5000'</span>)))) <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span></span><br><span class="line">      )</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.683215</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">COMMIT</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.688292</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">select</span>  <span class="comment">/* gh-ost `test`.`employee1` iteration:5 */</span></span><br><span class="line">						<span class="string">`id`</span></span><br><span class="line">					<span class="keyword">from</span></span><br><span class="line">						<span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line">					<span class="keyword">where</span> ((<span class="string">`id`</span> &gt; _binary<span class="string">'5000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'10000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'10000'</span>)))</span><br><span class="line">					<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">						<span class="string">`id`</span> <span class="keyword">asc</span></span><br><span class="line">					<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">					<span class="keyword">offset</span> <span class="number">999</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.688930</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.689193</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">SET</span></span><br><span class="line">			<span class="keyword">SESSION</span> <span class="keyword">time_zone</span> = <span class="string">'SYSTEM'</span>,</span><br><span class="line">			sql_mode = <span class="keyword">CONCAT</span>(@@session.sql_mode, <span class="string">',STRICT_ALL_TABLES'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.689449</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost `test`.`employee1` */</span> <span class="keyword">ignore</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>)</span><br><span class="line">      (<span class="keyword">select</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">force</span> <span class="keyword">index</span> (<span class="string">`PRIMARY`</span>)</span><br><span class="line">        <span class="keyword">where</span> (((<span class="string">`id`</span> &gt; _binary<span class="string">'5000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'6000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'6000'</span>)))) <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span></span><br><span class="line">      )</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.692033</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:29.691873562+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.693417</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.693606</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.693715</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.693881</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.694047</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.706414</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> <span class="keyword">Query</span>	<span class="keyword">COMMIT</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.710002</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40309</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.710036</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> <span class="keyword">Query</span>	<span class="keyword">select</span>  <span class="comment">/* gh-ost `test`.`employee1` iteration:6 */</span></span><br><span class="line">						<span class="string">`id`</span></span><br><span class="line">					<span class="keyword">from</span></span><br><span class="line">						<span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line">					<span class="keyword">where</span> ((<span class="string">`id`</span> &gt; _binary<span class="string">'6000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'10000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'10000'</span>)))</span><br><span class="line">					<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">						<span class="string">`id`</span> <span class="keyword">asc</span></span><br><span class="line">					<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">					<span class="keyword">offset</span> <span class="number">999</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.710568</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.710719</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">SET</span></span><br><span class="line">			<span class="keyword">SESSION</span> <span class="keyword">time_zone</span> = <span class="string">'SYSTEM'</span>,</span><br><span class="line">			sql_mode = <span class="keyword">CONCAT</span>(@@session.sql_mode, <span class="string">',STRICT_ALL_TABLES'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.710962</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost `test`.`employee1` */</span> <span class="keyword">ignore</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>)</span><br><span class="line">      (<span class="keyword">select</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">force</span> <span class="keyword">index</span> (<span class="string">`PRIMARY`</span>)</span><br><span class="line">        <span class="keyword">where</span> (((<span class="string">`id`</span> &gt; _binary<span class="string">'6000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'7000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'7000'</span>)))) <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span></span><br><span class="line">      )</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.720031</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">COMMIT</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.724876</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> <span class="keyword">Query</span>	<span class="keyword">select</span>  <span class="comment">/* gh-ost `test`.`employee1` iteration:7 */</span></span><br><span class="line">						<span class="string">`id`</span></span><br><span class="line">					<span class="keyword">from</span></span><br><span class="line">						<span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line">					<span class="keyword">where</span> ((<span class="string">`id`</span> &gt; _binary<span class="string">'7000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'10000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'10000'</span>)))</span><br><span class="line">					<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">						<span class="string">`id`</span> <span class="keyword">asc</span></span><br><span class="line">					<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">					<span class="keyword">offset</span> <span class="number">999</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.725421</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.725689</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">SET</span></span><br><span class="line">			<span class="keyword">SESSION</span> <span class="keyword">time_zone</span> = <span class="string">'SYSTEM'</span>,</span><br><span class="line">			sql_mode = <span class="keyword">CONCAT</span>(@@session.sql_mode, <span class="string">',STRICT_ALL_TABLES'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.725942</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost `test`.`employee1` */</span> <span class="keyword">ignore</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>)</span><br><span class="line">      (<span class="keyword">select</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">force</span> <span class="keyword">index</span> (<span class="string">`PRIMARY`</span>)</span><br><span class="line">        <span class="keyword">where</span> (((<span class="string">`id`</span> &gt; _binary<span class="string">'7000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'8000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'8000'</span>)))) <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span></span><br><span class="line">      )</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.748448</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">COMMIT</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.754426</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> <span class="keyword">Query</span>	<span class="keyword">select</span>  <span class="comment">/* gh-ost `test`.`employee1` iteration:8 */</span></span><br><span class="line">						<span class="string">`id`</span></span><br><span class="line">					<span class="keyword">from</span></span><br><span class="line">						<span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line">					<span class="keyword">where</span> ((<span class="string">`id`</span> &gt; _binary<span class="string">'8000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'10000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'10000'</span>)))</span><br><span class="line">					<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">						<span class="string">`id`</span> <span class="keyword">asc</span></span><br><span class="line">					<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">					<span class="keyword">offset</span> <span class="number">999</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.755265</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.755448</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">SET</span></span><br><span class="line">			<span class="keyword">SESSION</span> <span class="keyword">time_zone</span> = <span class="string">'SYSTEM'</span>,</span><br><span class="line">			sql_mode = <span class="keyword">CONCAT</span>(@@session.sql_mode, <span class="string">',STRICT_ALL_TABLES'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.755605</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost `test`.`employee1` */</span> <span class="keyword">ignore</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>)</span><br><span class="line">      (<span class="keyword">select</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">force</span> <span class="keyword">index</span> (<span class="string">`PRIMARY`</span>)</span><br><span class="line">        <span class="keyword">where</span> (((<span class="string">`id`</span> &gt; _binary<span class="string">'8000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'9000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'9000'</span>)))) <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span></span><br><span class="line">      )</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.766785</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">COMMIT</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.770199</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> <span class="keyword">Query</span>	<span class="keyword">select</span>  <span class="comment">/* gh-ost `test`.`employee1` iteration:9 */</span></span><br><span class="line">						<span class="string">`id`</span></span><br><span class="line">					<span class="keyword">from</span></span><br><span class="line">						<span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line">					<span class="keyword">where</span> ((<span class="string">`id`</span> &gt; _binary<span class="string">'9000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'10000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'10000'</span>)))</span><br><span class="line">					<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">						<span class="string">`id`</span> <span class="keyword">asc</span></span><br><span class="line">					<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">					<span class="keyword">offset</span> <span class="number">999</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.770741</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.770860</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">SET</span></span><br><span class="line">			<span class="keyword">SESSION</span> <span class="keyword">time_zone</span> = <span class="string">'SYSTEM'</span>,</span><br><span class="line">			sql_mode = <span class="keyword">CONCAT</span>(@@session.sql_mode, <span class="string">',STRICT_ALL_TABLES'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.771014</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost `test`.`employee1` */</span> <span class="keyword">ignore</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>)</span><br><span class="line">      (<span class="keyword">select</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">force</span> <span class="keyword">index</span> (<span class="string">`PRIMARY`</span>)</span><br><span class="line">        <span class="keyword">where</span> (((<span class="string">`id`</span> &gt; _binary<span class="string">'9000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'10000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'10000'</span>)))) <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span></span><br><span class="line">      )</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.778317</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">COMMIT</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.781554</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> <span class="keyword">Query</span>	<span class="keyword">select</span>  <span class="comment">/* gh-ost `test`.`employee1` iteration:10 */</span></span><br><span class="line">						<span class="string">`id`</span></span><br><span class="line">					<span class="keyword">from</span></span><br><span class="line">						<span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line">					<span class="keyword">where</span> ((<span class="string">`id`</span> &gt; _binary<span class="string">'10000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'10000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'10000'</span>)))</span><br><span class="line">					<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">						<span class="string">`id`</span> <span class="keyword">asc</span></span><br><span class="line">					<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">					<span class="keyword">offset</span> <span class="number">999</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.781810</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">select</span> <span class="comment">/* gh-ost `test`.`employee1` iteration:10 */</span> <span class="string">`id`</span></span><br><span class="line">				<span class="keyword">from</span> (</span><br><span class="line">					<span class="keyword">select</span></span><br><span class="line">							<span class="string">`id`</span></span><br><span class="line">						<span class="keyword">from</span></span><br><span class="line">							<span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line">						<span class="keyword">where</span> ((<span class="string">`id`</span> &gt; _binary<span class="string">'10000'</span>)) <span class="keyword">and</span> ((<span class="string">`id`</span> &lt; _binary<span class="string">'10000'</span>) <span class="keyword">or</span> ((<span class="string">`id`</span> = _binary<span class="string">'10000'</span>)))</span><br><span class="line">						<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">							<span class="string">`id`</span> <span class="keyword">asc</span></span><br><span class="line">						<span class="keyword">limit</span> <span class="number">1000</span></span><br><span class="line">				) select_osc_chunk</span><br><span class="line">			<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">				<span class="string">`id`</span> <span class="keyword">desc</span></span><br><span class="line">			<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.782135</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="string">'copy iteration 10 at 1590737909'</span>, <span class="string">'Copy: 10000/10000 100.0%; Applied: 0; Backlog: 0/1000; Time: 1s(total), 1s(copy); streamer: bin.000070:320813452; State: migrating; ETA: due'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.784806</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.785567</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">select</span> connection_id()</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.785720</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">select</span> <span class="keyword">get_lock</span>(<span class="string">'gh-ost.40312.lock'</span>, <span class="number">0</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.785846</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">set</span> <span class="keyword">session</span> lock_wait_timeout:=<span class="number">6</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.791062</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">status</span> <span class="keyword">from</span> <span class="string">`test`</span> <span class="keyword">like</span> <span class="string">'_employee1_del'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.791374</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> <span class="keyword">Query</span>	<span class="keyword">create</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="string">`test`</span>.<span class="string">`_employee1_del`</span> (</span><br><span class="line">			<span class="keyword">id</span> <span class="built_in">int</span> auto_increment primary <span class="keyword">key</span></span><br><span class="line">		) <span class="keyword">engine</span>=<span class="keyword">InnoDB</span> <span class="keyword">comment</span>=<span class="string">'ghost-cut-over-sentry'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.792202</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.793355</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.793370</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40315</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.793452</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.793460</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40315</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.793515</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.793610</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40315</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.793646</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:29.791855122+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.793942</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40315</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.794103</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40315</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.807138</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.807226</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">lock</span> <span class="comment">/* gh-ost */</span> <span class="keyword">tables</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> write, <span class="string">`test`</span>.<span class="string">`_employee1_del`</span> write</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.807813</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40315</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">2</span>, <span class="number">0</span>), <span class="string">'state'</span>, <span class="string">'AllEventsUpToLockProcessed:1590737909807671836'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.810430</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="string">'state at 1590737909810266435'</span>, <span class="string">'AllEventsUpToLockProcessed:1590737909807671836'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.892168</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40315</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:29.891967268+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.893179</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.992165</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:29.991965407+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.993199</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40315</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.092194</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40315</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:30.091928438+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.093227</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.192141</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:30.191949581+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.193143</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40315</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.292137</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40315</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:30.291941416+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.293149</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.392240</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:30.392035339+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.393275</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40315</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.492165</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40315</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:30.491972791+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.493176</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.493939</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.494139</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.494249</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.494318</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.494385</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.494988</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.495802</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40315</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.496482</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="string">'copy iteration 10 at 1590737910'</span>, <span class="string">'Copy: 10000/10000 100.0%; Applied: 0; Backlog: 1/1000; Time: 2s(total), 1s(copy); streamer: bin.000070:320823747; State: migrating; ETA: due'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.592238</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:30.591999354+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.593255</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.692187</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:30.691992755+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.693206</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.782521</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="string">'copy iteration 10 at 1590737910'</span>, <span class="string">'Copy: 10000/10000 100.0%; Applied: 0; Backlog: 0/1000; Time: 2s(total), 1s(copy); streamer: bin.000070:320825878; State: migrating; ETA: due'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.792059</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:30.791873789+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.792295</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.792439</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">select</span> connection_id()</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.792794</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">set</span> <span class="keyword">session</span> lock_wait_timeout:=<span class="number">3</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.793033</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.793157</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.793316</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.793423</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.793585</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">select</span> <span class="keyword">id</span></span><br><span class="line">			<span class="keyword">from</span> information_schema.processlist</span><br><span class="line">			<span class="keyword">where</span></span><br><span class="line">				<span class="keyword">id</span> != connection_id()</span><br><span class="line">				<span class="keyword">and</span> <span class="number">40314</span> <span class="keyword">in</span> (<span class="number">0</span>, <span class="keyword">id</span>)</span><br><span class="line">				<span class="keyword">and</span> state <span class="keyword">like</span> <span class="keyword">concat</span>(<span class="string">'%'</span>, <span class="string">'metadata lock'</span>, <span class="string">'%'</span>)</span><br><span class="line">				<span class="keyword">and</span> info  <span class="keyword">like</span> <span class="keyword">concat</span>(<span class="string">'%'</span>, <span class="string">'rename'</span>, <span class="string">'%'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.793827</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">rename</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">to</span> <span class="string">`test`</span>.<span class="string">`_employee1_del`</span>, <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> <span class="keyword">to</span> <span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.794321</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.794490</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.794641</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.795166</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.795347</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.796006</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.892133</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:30.891962913+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.893297</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.992155</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:30.991958953+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.993278</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.092115</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:31.091945166+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.093206</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.192121</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:31.191943104+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.193195</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.292113</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:31.291920755+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.293131</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.392166</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:31.391927846+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.393211</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.492258</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:31.491963265+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.493225</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.493639</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.494432</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.496602</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="string">'copy iteration 10 at 1590737911'</span>, <span class="string">'Copy: 10000/10000 100.0%; Applied: 0; Backlog: 0/1000; Time: 3s(total), 1s(copy); streamer: bin.000070:320832073; State: migrating; ETA: due'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.592213</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:31.592016295+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.593217</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.692115</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:31.691941596+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.693157</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.792078</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:31.791911518+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.793129</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">select</span> hint, <span class="keyword">value</span> <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> <span class="keyword">where</span> hint = <span class="string">'heartbeat'</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;= <span class="number">255</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.794412</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">select</span> <span class="keyword">id</span></span><br><span class="line">			<span class="keyword">from</span> information_schema.processlist</span><br><span class="line">			<span class="keyword">where</span></span><br><span class="line">				<span class="keyword">id</span> != connection_id()</span><br><span class="line">				<span class="keyword">and</span> <span class="number">40314</span> <span class="keyword">in</span> (<span class="number">0</span>, <span class="keyword">id</span>)</span><br><span class="line">				<span class="keyword">and</span> state <span class="keyword">like</span> <span class="keyword">concat</span>(<span class="string">'%'</span>, <span class="string">'metadata lock'</span>, <span class="string">'%'</span>)</span><br><span class="line">				<span class="keyword">and</span> info  <span class="keyword">like</span> <span class="keyword">concat</span>(<span class="string">'%'</span>, <span class="string">'rename'</span>, <span class="string">'%'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.794952</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">select</span> <span class="keyword">is_used_lock</span>(<span class="string">'gh-ost.40312.lock'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.795148</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">drop</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="string">`test`</span>.<span class="string">`_employee1_del`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.804223</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">unlock</span> <span class="keyword">tables</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.804366</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">ROLLBACK</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.804450</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.828578</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">ROLLBACK</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.828661</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">status</span> <span class="keyword">from</span> <span class="string">`test`</span> <span class="keyword">like</span> <span class="string">'_employee1_del'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.829299</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.892061</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:31.891916935+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.895474</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">drop</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.903826</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">drop</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="string">`test`</span>.<span class="string">`_employee1_del`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.927905</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.927992</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40307</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.928011</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40308</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.928082</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> Quit</span><br></pre></td></tr></table></figure></p>
<h3 id="执行过程解析"><a href="#执行过程解析" class="headerlink" title="执行过程解析"></a>执行过程解析</h3><h4 id="检查"><a href="#检查" class="headerlink" title="检查"></a>检查</h4><p>检查用户、权限、binlog信息、字符集、复制状态、表状态等<br><br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.796759</span>+<span class="number">08:00	40303</span> Connect	root@<span class="number">127.0.0.1</span> on test using TCP/IP</span><br><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.796967</span>+<span class="number">08:00	40303</span> Query	SELECT @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.797151+08</span>:<span class="number">00	40303</span> Query	SET autocommit=true</span><br><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.797283</span>+<span class="number">08:00	40303</span> Query	SET NAMES utf8mb4</span><br><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.797446</span>+<span class="number">08:00	40303</span> Query	select @@global.version</span><br><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.797751</span>+<span class="number">08:00	40303</span> Query	select @@global.port</span><br><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.797976</span>+<span class="number">08:00	40303</span> Query	select @@global.hostname, @@global.port</span><br><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.798176+08</span>:<span class="number">00	40303</span> Query	show /* gh-ost */ grants for current_user()</span><br><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.798307</span>+<span class="number">08:00	40303</span> Query	select @@global.log_bin, @@global.binlog_format</span><br><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.798396</span>+<span class="number">08:00	40303</span> Query	select @@global.binlog_row_image</span><br><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.799003</span>+<span class="number">08:00	40304</span> Connect	root@<span class="number">127.0.0.1</span> on information_schema using TCP/IP</span><br><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.799177+08</span>:<span class="number">00	40304</span> Query	SELECT @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.799343</span>+<span class="number">08:00	40304</span> Query	SET autocommit=true</span><br><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.799460</span>+<span class="number">08:00	40304</span> Query	SET NAMES utf8mb4</span><br><span class="line"><span class="number">2018</span>-<span class="number">10-11T15:38</span>:<span class="number">27.799571</span>+<span class="number">08:00	40304</span> Query	show slave status</span><br></pre></td></tr></table></figure></p>
<p>检查外键、触发器、行数预估、索引、字段等信息<br><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">2018-10-11T15:38:27.800450+08:00	40303 Query	<span class="keyword">SELECT</span></span><br><span class="line">			<span class="keyword">SUM</span>(REFERENCED_TABLE_NAME <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">AND</span> TABLE_SCHEMA=<span class="string">'test'</span> <span class="keyword">AND</span> TABLE_NAME=<span class="string">'employee1'</span>) <span class="keyword">as</span> num_child_side_fk,......</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.328510</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="keyword">COUNT</span>(*) <span class="keyword">AS</span> num_triggers......</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.334174</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">explain</span> <span class="keyword">select</span> <span class="comment">/* gh-ost */</span> * <span class="keyword">from</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">where</span> <span class="number">1</span>=<span class="number">1.</span>.....</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.359593</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span></span><br><span class="line">      COLUMNS.TABLE_SCHEMA,......</span><br></pre></td></tr></table></figure></p>
<h4 id="伪装slave"><a href="#伪装slave" class="headerlink" title="伪装slave"></a>伪装slave</h4><p>模拟 slave，获取当前的位点信息，创建 binlog streamer 监听 binlog<br><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2018-10-11T15:38:28.364408+08:00	40303 Query	<span class="keyword">show</span> <span class="comment">/* gh-ost readCurrentBinlogCoordinates */</span> <span class="keyword">master</span> <span class="keyword">status</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.365328</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40306</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span>  <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.365632</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40306</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'BINLOG_CHECKSUM'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.366882</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40306</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> @master_binlog_checksum=<span class="string">'NONE'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.367450</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40306</span> <span class="keyword">Binlog</span> Dump	<span class="keyword">Log</span>: <span class="string">'bin.000070'</span>  Pos: <span class="number">320607755</span></span><br></pre></td></tr></table></figure></p>
<h4 id="创建日志记录表-xx-ghc-和影子表-xx-gho-并且执行-alter-语句将影子表变更为目标表结构"><a href="#创建日志记录表-xx-ghc-和影子表-xx-gho-并且执行-alter-语句将影子表变更为目标表结构" class="headerlink" title="创建日志记录表 xx_ghc 和影子表 xx_gho 并且执行 alter 语句将影子表变更为目标表结构"></a>创建日志记录表 xx_ghc 和影子表 xx_gho 并且执行 alter 语句将影子表变更为目标表结构</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">2018-10-11T15:38:28.385496+08:00	40303 Query	<span class="keyword">create</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span> (</span><br><span class="line">			<span class="keyword">id</span> <span class="built_in">bigint</span> auto_increment,</span><br><span class="line">			last_update <span class="keyword">timestamp</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">			hint <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">charset</span> <span class="keyword">ascii</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">			<span class="keyword">value</span> <span class="built_in">varchar</span>(<span class="number">4096</span>) <span class="keyword">charset</span> <span class="keyword">ascii</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">			primary <span class="keyword">key</span>(<span class="keyword">id</span>),</span><br><span class="line">			<span class="keyword">unique</span> <span class="keyword">key</span> hint_uidx(hint)</span><br><span class="line">		) auto_increment=<span class="number">256</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.419446</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">create</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> <span class="keyword">like</span> <span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.445917</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">alter</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> <span class="keyword">engine</span>=<span class="keyword">innodb</span></span><br></pre></td></tr></table></figure>
<h4 id="insert-into-xx-gho-select-from-xx-拷贝数据"><a href="#insert-into-xx-gho-select-from-xx-拷贝数据" class="headerlink" title="insert into xx_gho select * from xx 拷贝数据"></a>insert into xx_gho select * from xx 拷贝数据</h4><p>同时从general_log中可以相关的步骤会记录到xx_ghc表中，其中包括GhostTableMigrated，heartbeat等信息，并且此类信息会贯穿DDL整个周期内<br><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">2018-10-11T15:38:28.480994+08:00	40303 Query	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">2</span>, <span class="number">0</span>), <span class="string">'state'</span>, <span class="string">'GhostTableMigrated'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.483727</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">0</span>, <span class="number">0</span>), <span class="string">'state at 1590737908483609931'</span>, <span class="string">'GhostTableMigrated'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">28.487362</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40303</span> <span class="keyword">Query</span>	<span class="keyword">insert</span> <span class="comment">/* gh-ost */</span> <span class="keyword">into</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line">				(<span class="keyword">id</span>, hint, <span class="keyword">value</span>)</span><br><span class="line">			<span class="keyword">values</span></span><br><span class="line">				(<span class="keyword">NULLIF</span>(<span class="number">1</span>, <span class="number">0</span>), <span class="string">'heartbeat'</span>, <span class="string">'2018-10-11T15:38:28.487157014+08:00'</span>)</span><br><span class="line">			<span class="keyword">on</span> <span class="keyword">duplicate</span> <span class="keyword">key</span> <span class="keyword">update</span></span><br><span class="line">				last_update=<span class="keyword">NOW</span>(),</span><br><span class="line">				<span class="keyword">value</span>=<span class="keyword">VALUES</span>(<span class="keyword">value</span>)</span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<p>紧接着获取获取当前的最大主键和最小主键，然后根据命令行传参 chunk 获取数据 ，开启事务，insert 到影子表里面，循环此步骤，直到数据copy完成<br><br>rowcopy 过程中是对原表加上 lock in share mode,防止数据在 copy 的过程中被修改<br><br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">2018-10<span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.496312</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40311</span> Query	<span class="keyword">select</span>  <span class="comment">/* gh-ost `test`.`employee1` iteration:0 */</span></span><br><span class="line">						<span class="symbol">`id`</span></span><br><span class="line">					<span class="keyword">from</span></span><br><span class="line">						<span class="symbol">`test`</span>.<span class="symbol">`employee1`</span></span><br><span class="line">					<span class="keyword">where</span> ((<span class="symbol">`id`</span> &gt; _binary<span class="string">'1'</span>) <span class="keyword">or</span> ((<span class="symbol">`id`</span> = _binary<span class="string">'1'</span>))) <span class="keyword">and</span> ((<span class="symbol">`id`</span> &lt; _binary<span class="string">'10000'</span>) <span class="keyword">or</span> ((<span class="symbol">`id`</span> = _binary<span class="string">'10000'</span>)))</span><br><span class="line">					<span class="keyword">order</span> <span class="keyword">by</span></span><br><span class="line">						<span class="symbol">`id`</span> <span class="keyword">asc</span></span><br><span class="line">					<span class="keyword">limit</span> <span class="number">1</span></span><br><span class="line">					<span class="keyword">offset</span> <span class="number">999</span></span><br><span class="line">......</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.507153</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> Query	<span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.507400</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> Query	<span class="keyword">SET</span></span><br><span class="line">			SESSION time_zone = <span class="string">'SYSTEM'</span>,</span><br><span class="line">			sql_mode = CONCAT(@@session.sql_mode, <span class="string">',STRICT_ALL_TABLES'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.507853</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> Query	<span class="keyword">insert</span> <span class="comment">/* gh-ost `test`.`employee1` */</span> <span class="keyword">ignore</span> <span class="keyword">into</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_gho`</span> (<span class="symbol">`id`</span>, <span class="symbol">`employeeid`</span>, <span class="symbol">`employeename`</span>)</span><br><span class="line">      (<span class="keyword">select</span> <span class="symbol">`id`</span>, <span class="symbol">`employeeid`</span>, <span class="symbol">`employeename`</span> <span class="keyword">from</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">force</span> <span class="keyword">index</span> (<span class="symbol">`PRIMARY`</span>)</span><br><span class="line">        <span class="keyword">where</span> (((<span class="symbol">`id`</span> &gt; _binary<span class="string">'1'</span>) <span class="keyword">or</span> ((<span class="symbol">`id`</span> = _binary<span class="string">'1'</span>))) <span class="keyword">and</span> ((<span class="symbol">`id`</span> &lt; _binary<span class="string">'1000'</span>) <span class="keyword">or</span> ((<span class="symbol">`id`</span> = _binary<span class="string">'1000'</span>)))) lock <span class="keyword">in</span> share mode</span><br><span class="line">      )</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.523454</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40310</span> Query	<span class="keyword">COMMIT</span></span><br><span class="line">......</span><br></pre></td></tr></table></figure></p>
<h4 id="应用增量数据"><a href="#应用增量数据" class="headerlink" title="应用增量数据"></a>应用增量数据</h4><p>由于测试环境在做DDL期间，没有增量数据写入，general_log并没有读取binlog相关的信息<br></p>
<ul>
<li>row copy 转化为insert ignore into 到影子表</li>
<li>apply binlog 转化为replace into 应用到影子表</li>
</ul>
<h4 id="创建xx-del表"><a href="#创建xx-del表" class="headerlink" title="创建xx_del表"></a>创建xx_del表</h4><p>防止 cut-over 提前执行，导致数据丢失。最后做影子表和原表的交换及收尾工作<br><br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.791374</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40313</span> Query	create <span class="comment">/* gh-ost */</span> table `test`.`_employee1_del` (</span><br><span class="line">			id int auto_increment primary key</span><br><span class="line">		) engine=InnoDB comment=<span class="string">'ghost-cut-over-sentry'</span>......</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.807226</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> Query	lock <span class="comment">/* gh-ost */</span> tables `test`.`employee1` write, `test`.`_employee1_del` write......</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.793827</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> Query	rename <span class="comment">/* gh-ost */</span> table `test`.`employee1` to `test`.`_employee1_del`, `test`.`_employee1_gho` to `test`.`employee1`......</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.795148</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> Query	drop <span class="comment">/* gh-ost */</span> table <span class="keyword">if</span> exists `test`.`_employee1_del`</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.804223</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> Query	unlock tables......</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.895474</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> Query	drop <span class="comment">/* gh-ost */</span> table <span class="keyword">if</span> exists `test`.`_employee1_ghc`</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.903826</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> Query	drop <span class="comment">/* gh-ost */</span> table <span class="keyword">if</span> exists `test`.`_employee1_del`</span><br></pre></td></tr></table></figure></p>
<h3 id="执行过程总结"><a href="#执行过程总结" class="headerlink" title="执行过程总结"></a>执行过程总结</h3><ul>
<li>① 检查有没有外键和触发器</li>
<li>② 检查表的主键信息</li>
<li>③ 检查是否主库或从库，是否开启log_slave_updates，以及binlog信息  </li>
<li>④ 检查gho和del结尾的临时表是否存在</li>
<li>⑤ 创建ghc结尾的表，存数据迁移的信息，以及binlog信息等    </li>
<li>⑥ 初始化stream的连接,添加binlog的监听</li>
<li>⑥ 创建gho结尾的临时表，执行DDL在gho结尾的临时表上</li>
<li>⑦ 开启事务，按照主键id把源表数据写入到gho结尾的表上，再提交，以及binlog apply</li>
<li>⑧ lock源表，rename 表：rename 源表 to 源_del表，gho表 to 源表</li>
<li>⑨ 清理ghc表</li>
</ul>
<h2 id="gh-ost-操作模式"><a href="#gh-ost-操作模式" class="headerlink" title="gh-ost 操作模式"></a>gh-ost 操作模式</h2><p>gh-ost 可以同时连接多个服务器，为了获取二进制的数据流，它会作为一个从库，将数据从一个库复制到另外一个。它有各种不同的操作模式，这取决于你的设置，配置，和要运行迁移环境。<br><br><img src="http://qanp7f2om.bkt.clouddn.com/gh-ost02.png" alt="image"></p>
<h3 id="连接到从库，在主库做迁移"><a href="#连接到从库，在主库做迁移" class="headerlink" title="连接到从库，在主库做迁移"></a>连接到从库，在主库做迁移</h3><p>这是 gh-ost 默认的工作方式。gh-ost 将会检查从库状态，找到集群结构中的主库并连接，接下来进行迁移操作：<br></p>
<ul>
<li>行数据在主库上读写</li>
<li>读取从库的二进制日志，将变更应用到主库</li>
<li>在从库收集表格式，字段&amp;索引，行数等信息</li>
<li>在从库上读取内部的变更事件（如心跳事件）</li>
<li>在主库切换表</li>
</ul>
<p>如果你的主库的日志格式是 SBR，工具也可以正常工作。但从库必须启用二级制日志(log_bin, log_slave_updates) 并且设置 binlog_format=ROW ( gh-ost 是读取从库的二级制文件)。</p>
<p>如果直接在主库上操作，当然也需要二进制日志格式是RBR。</p>
<h3 id="连接到主库"><a href="#连接到主库" class="headerlink" title="连接到主库"></a>连接到主库</h3><p>如果你没有从库，或者不想使用从库，你可以直接在主库上操作。gh-ost 将会直接在主库上进行所有操作。你需要持续关注<font color="FF0000">复制延迟</font>问题。<br></p>
<ul>
<li>主库的二进制日志必须是 RBR 格式</li>
<li>必须指定 –allow-on-master 参数</li>
</ul>
<h3 id="在从库迁移-测试"><a href="#在从库迁移-测试" class="headerlink" title="在从库迁移/测试"></a>在从库迁移/测试</h3><p>该模式会在从库执行迁移操作。gh-ost 会简单的连接到主库，此后所有的操作都在从库执行，不会对主库进行任何的改动。整个操作过程中，gh-ost 将控制速度保证从库可以及时的进行数据同步<br></p>
<ul>
<li>–migrate-on-replica 表示 gh-ost 会直接在从库上进行迁移操作。即使在复制运行阶段也可以进行表的切换操作</li>
<li>–test-on-replica 表示 迁移操作只是为了测试在切换之前复制会停止，然后会进行切换操作，然后在切换回来，你的原始表最终还是原始表。两个表都会保存下来，复制操作是停止的。你可以对这两个表进行一致性检查等测试操作</li>
</ul>
<h2 id="时序问题"><a href="#时序问题" class="headerlink" title="时序问题"></a>时序问题</h2><p>gh-ost 做 DDL 变更期间对原表和影子表的操作有三种:<br><br>对原表的 row copy (我们用 A 操作代替),业务对原表的 DML 操作(B),对影子表的 apply binlog(C)。而且 binlog 是基于 DML 操作产生的，因此对影子表的 apply binlog 一定在 对原表的 DML 之后，共有ABC/BCA/BAC/三种<br></p>
<table>
<thead>
<tr>
<th>类别</th>
<th>row copy(A)</th>
<th>DML(B)</th>
<th>apply binlog(C)</th>
</tr>
</thead>
<tbody>
<tr>
<td>A-B-C，数据先被复制到影子表</td>
<td>insert ignore into b select id&gt;0 and id&lt;3;<br>将数据从原表同步到影子表</td>
<td>insert into b(id,val) values(2,’b’);<br>update b set val=’b’ where id = 1;<br>delete from b where id = 1;</td>
<td>replace into b(id,val) values(2,’b’);<br>update b set val=’b’ where id = 1;<br>delete from b where id = 1;</td>
</tr>
<tr>
<td>B-C-A，先应用dml的binlog，数据后被复制到影子表</td>
<td>insert into b(id,val) values(2,’a’);<br>update b set val=’b’ where id = 1;<br>delete from b where id = 1;</td>
<td>replace into b(id,val) values(2,’a’);<br>update b set val=’b’ where id = 1;影子表不存在此记录，update空;<br>delete from b where id = 1;影子表不存在此记录，delete空;</td>
<td>因为id=2的记录binlog比row copy先到达，row copy执行insert ignore忽略插入;<br>row copy时新记录已经在原表，直接复制到影子表即可;<br>row copy时原表已无此记录，不会同步到影子表</td>
</tr>
<tr>
<td>B-A-C，先插入dml，数据再被复制到影子表，最后应用dml</td>
<td>insert into b(id,val) values(2,’a’);<br>update b set val=’b’ where id =1;<br>delete from b where id = 1;</td>
<td>insert ignore into b(id,val) values(2,’a’);<br>insert ignore into b(id,val) values(1,’b’);<br>因为id=1的记录已经被删除，row copy空行;</td>
<td>因为id=2的记录row copy比binlog先到达，影子表已经有id=2记录，apply binlog会使用replace into;<br>因为id=2的记录row copy比binlog先到达，binlog apply执行update…<br>binlog apply空操作</td>
</tr>
</tbody>
</table>
<p>通过上面的几种组合操作的分析，我们可以看到 数据最终是一致的。尤其是当copy 结束之后，只剩下apply binlog，情况更简单。</p>
<h2 id="cut-over原理"><a href="#cut-over原理" class="headerlink" title="cut-over原理"></a>cut-over原理</h2><h3 id="general-log-1"><a href="#general-log-1" class="headerlink" title="general_log"></a>general_log</h3><p>从上面的general_log，截取后面的cut-over：<br><br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">2018-10-11T15:38:29.791374+08:00	40313 Query	<span class="keyword">create</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="string">`test`</span>.<span class="string">`_employee1_del`</span> (</span><br><span class="line">			<span class="keyword">id</span> <span class="built_in">int</span> auto_increment primary <span class="keyword">key</span></span><br><span class="line">		) <span class="keyword">engine</span>=<span class="keyword">InnoDB</span> <span class="keyword">comment</span>=<span class="string">'ghost-cut-over-sentry'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">29.807226</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">lock</span> <span class="comment">/* gh-ost */</span> <span class="keyword">tables</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> write, <span class="string">`test`</span>.<span class="string">`_employee1_del`</span> write</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.493939</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.494139</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.494249</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.494318</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.494385</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40316</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.494988</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.792295</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">START</span> <span class="keyword">TRANSACTION</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.792439</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">select</span> connection_id()</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.792794</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">set</span> <span class="keyword">session</span> lock_wait_timeout:=<span class="number">3</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.793033</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Connect</span>	root@<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> TCP/IP</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.793157</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@max_allowed_packet</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.793316</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> autocommit=<span class="literal">true</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.793423</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">NAMES</span> utf8mb4</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.793585</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">select</span> <span class="keyword">id</span></span><br><span class="line">			<span class="keyword">from</span> information_schema.processlist</span><br><span class="line">			<span class="keyword">where</span></span><br><span class="line">				<span class="keyword">id</span> != connection_id()</span><br><span class="line">				<span class="keyword">and</span> <span class="number">40314</span> <span class="keyword">in</span> (<span class="number">0</span>, <span class="keyword">id</span>)</span><br><span class="line">				<span class="keyword">and</span> state <span class="keyword">like</span> <span class="keyword">concat</span>(<span class="string">'%'</span>, <span class="string">'metadata lock'</span>, <span class="string">'%'</span>)</span><br><span class="line">				<span class="keyword">and</span> info  <span class="keyword">like</span> <span class="keyword">concat</span>(<span class="string">'%'</span>, <span class="string">'rename'</span>, <span class="string">'%'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">30.793827</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">rename</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">to</span> <span class="string">`test`</span>.<span class="string">`_employee1_del`</span>, <span class="string">`test`</span>.<span class="string">`_employee1_gho`</span> <span class="keyword">to</span> <span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.493639</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.494432</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="keyword">global</span> <span class="keyword">status</span> <span class="keyword">like</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.794412</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">select</span> <span class="keyword">id</span></span><br><span class="line">			<span class="keyword">from</span> information_schema.processlist</span><br><span class="line">			<span class="keyword">where</span></span><br><span class="line">				<span class="keyword">id</span> != connection_id()</span><br><span class="line">				<span class="keyword">and</span> <span class="number">40314</span> <span class="keyword">in</span> (<span class="number">0</span>, <span class="keyword">id</span>)</span><br><span class="line">				<span class="keyword">and</span> state <span class="keyword">like</span> <span class="keyword">concat</span>(<span class="string">'%'</span>, <span class="string">'metadata lock'</span>, <span class="string">'%'</span>)</span><br><span class="line">				<span class="keyword">and</span> info  <span class="keyword">like</span> <span class="keyword">concat</span>(<span class="string">'%'</span>, <span class="string">'rename'</span>, <span class="string">'%'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.794952</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">select</span> <span class="keyword">is_used_lock</span>(<span class="string">'gh-ost.40312.lock'</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.795148</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">drop</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="string">`test`</span>.<span class="string">`_employee1_del`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.804223</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">unlock</span> <span class="keyword">tables</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.804366</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> <span class="keyword">Query</span>	<span class="keyword">ROLLBACK</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.804450</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40312</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.828578</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">ROLLBACK</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.828661</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> <span class="keyword">Query</span>	<span class="keyword">show</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">status</span> <span class="keyword">from</span> <span class="string">`test`</span> <span class="keyword">like</span> <span class="string">'_employee1_del'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.829299</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40318</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.895474</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> <span class="keyword">Query</span>	<span class="keyword">drop</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="string">`test`</span>.<span class="string">`_employee1_ghc`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.903826</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> <span class="keyword">Query</span>	<span class="keyword">drop</span> <span class="comment">/* gh-ost */</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> <span class="string">`test`</span>.<span class="string">`_employee1_del`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.927905</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40314</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.927992</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40307</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.928011</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40308</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-10</span><span class="number">-11</span>T15:<span class="number">38</span>:<span class="number">31.928082</span>+<span class="number">08</span>:<span class="number">00</span>	<span class="number">40317</span> Quit</span><br></pre></td></tr></table></figure></p>
<h3 id="日志说明"><a href="#日志说明" class="headerlink" title="日志说明"></a>日志说明</h3><p>其中，包括session:<br></p>
<ul>
<li>T1-40313:create table _employee1_del</li>
<li>T2-40312:lock tables employee1 write, _employee1_del write</li>
<li>T3-40316:show global status like ‘Threads_running’</li>
<li>T4-40317:select id from information_schema.processlist where id != connection_id() and 40314 in (0, id) and state like concat(‘%’, ‘metadata lock’, ‘%’) and info  like concat(‘%’, ‘rename’, ‘%’)</li>
<li>T5-40314:rename table employee1 to _employee1_del, _employee1_gho to employee1</li>
<li>T6-40318:select id from information_schema.processlist where id != connection_id() and 40314 in (0, id) and state like concat(‘%’, ‘metadata lock’, ‘%’) and info  like concat(‘%’, ‘rename’, ‘%’)</li>
<li>T7-40318:select is_used_lock(‘gh-ost.40312.lock’)</li>
<li>T8-40312:drop table if exists _employee1_del</li>
<li>T9-40312:unlock tables</li>
<li>T10-40314:drop table if exists _employee1_ghc</li>
<li>T11-40317:drop table if exists _employee1_del</li>
</ul>
<h3 id="日志解析"><a href="#日志解析" class="headerlink" title="日志解析"></a>日志解析</h3><ul>
<li>T1 创建临时表_employee1_del，防止提前rename表，导致数据丢失。(如果创建失败，则gh-ost程序退出，此时创建语句并非create table if exists)</li>
<li>T2 原表，影子表加写锁，此时原表的DML会阻塞。(如果加锁失败，则gh-ost程序退出)</li>
<li>T3 获取实例状态，确定是否进行下一步。(查询状态,不影响上下文)</li>
<li>T4 查看当前是否有进程有rename在运行，查询不到的话，可以进行rename操作。(如果查询到rename，下文确定是否获取T2时刻的锁)</li>
<li>T5 进行rename交换表，由于在T2时刻表上有写锁，rename会阻塞。(如果此时T2意外中止，rename会退出，因为临时表_employee1_del已经存在)</li>
<li>T6 再次查询是否有进程有rename在运行。(如果gh-ost捕捉不到rename，则T2会继续进行下一步T9，所有请求恢复正常)</li>
<li>T7 查询到rename操作，确定T2的上锁生效。(如果T2,T5全部失败,T2会释放锁,T5会被清除)</li>
<li>T8 删除临时表_employee1_del。(由于T2对_employee1_del加锁,在未unlock tables前,同一session是可以drop操作的。如果drop失败，rename也会失败，因为表对_employee1_del已存在，会继续T9，所有请求恢复正常)</li>
<li>T9 释放unlock tables</li>
<li>T10-T11 释放其他临时表</li>
</ul>
<h3 id="官方参考"><a href="#官方参考" class="headerlink" title="官方参考"></a>官方参考</h3><p>作者写了三篇文章解释cut-over操作的思路和切换算法，<a href="http://code.openark.org/blog/mysql/solving-the-facebook-osc-non-atomic-table-swap-problem" target="_blank" rel="noopener">链接1</a>，<a href="http://code.openark.org/blog/mysql/solving-the-non-atomic-table-swap-take-ii" target="_blank" rel="noopener">链接2</a>，<a href="http://code.openark.org/blog/mysql/solving-the-non-atomic-table-swap-take-iii-making-it-atomic" target="_blank" rel="noopener">链接3</a>，可参考，这里仅列出官方示例说明:<br></p>
<p>The solution we offer is now based on two connections only (as opposed to three, in the optimistic approach). “Our” connections will be C10, C20. The “normal” app connections are C1..C9, C11..C19, C21..C29.<br></p>
<ul>
<li>Connections C1..C9 operate on tbl with normal DML: INSERT, UPDATE, DELETE</li>
<li>Connection C10: CREATE TABLE tbl_old (id int primary key) COMMENT=’magic-be-here’</li>
<li>Connection C10: LOCK TABLES tbl WRITE, tbl_old WRITE</li>
<li>Connections C11..C19, newly incoming, issue queries on tbl but are blocked due to the LOCK</li>
<li>Connection C20: RENAME TABLE tbl TO tbl_old, ghost TO tbl. This is blocked due to the LOCK, but gets prioritized on top connections C11..C19 and on top C1..C9 or any other connection that attempts DML on tbl</li>
<li>Connections C21..C29, newly incoming, issue queries on tbl but are blocked due to the LOCK and due to the RENAME, waiting in queue</li>
<li>Connection C10: checks that C20’s RENAME is applied (looks for the blocked RENAME in processlist)</li>
<li>Connection 10: DROP TABLE tbl_old. Nothing happens yet; tbl is still locked. All other connections still blocked.</li>
<li>Connection 10: UNLOCK TABLES. BAM! The RENAME is first to execute, ghost table is swapped in place of tbl, then C1..C9, C11..C19, C21..C29 all get to operate on the new and shiny tbl</li>
</ul>
<p>Some notes<br></p>
<ul>
<li>We create tbl_old as a blocker for a premature swap</li>
<li>It is allowed for a connection to DROP a table it has under a WRITE LOCK</li>
<li>A blocked RENAME is always prioritized over a blocked INSERT/UPDATE/DELETE, no matter who came first</li>
</ul>
<p>What happens on failures?<br><br>Much fun. Just works; no rollback required.<br></p>
<ul>
<li>If C10 errors on the CREATE we do not proceed.</li>
<li>If C10 errors on the LOCK statement, we do not proceed. The table is not locked. App continues to operate as normal.</li>
<li><p>If C10 dies just as C20 is about to issue the RENAME:</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">The lock <span class="keyword">is</span> released, <span class="keyword">the</span> queries C1..C9, C11..C19 immediately operate <span class="keyword">on</span> tbl.</span><br><span class="line">C20’s RENAME immediately fails because tbl_old exists.</span><br><span class="line">The entire operation <span class="keyword">is</span> failed, <span class="keyword">but</span> nothing terrible happens; <span class="keyword">some</span> queries were blocked <span class="keyword">for</span> <span class="keyword">some</span> <span class="built_in">time</span> <span class="keyword">is</span> all. We will need <span class="keyword">to</span> retry everything</span><br></pre></td></tr></table></figure>
</li>
<li><p>If C10 dies while C20 is blocked on RENAME: Mostly similar to the above. Lock released, then C20 fails the RENAME (because tbl_old exists), then all queries resume normal operation</p>
</li>
<li>If C20 dies before C10 drops the table, we catch the error and let C10 proceed as planned: DROP, UNLOCK. Nothing terrible happens, some queries were blocked for some time. We will need to retry</li>
<li>If C20 dies just after C10 DROPs the table but before the unlock, same as above.</li>
<li>If both C10 and C20 die, no problem: LOCK is cleared; RENAME lock is cleared. C1..C9, C11..C19, C21..C29 are free to operate on tbl.</li>
</ul>
<p>No matter what happens, at the end of operation we look for the ghost table. Is it still there? Then we know the operation failed, “atomically”. Is it not there? Then it has been renamed to tbl, and the operation worked atomically.</p>
<p>A side note on failure is the matter of cleaning up the magic tbl_old. Here this is a matter of taste. Maybe just let it live and avoid recreating it, or you can drop it if you like.</p>
<h3 id="对应用的影响"><a href="#对应用的影响" class="headerlink" title="对应用的影响"></a>对应用的影响</h3><p>应用程序连接保证被阻止，直到交换 ghost 表或直到操作失败。在前者中，他们继续在新表上进行操作。在后者中，他们继续在原表上进行操作。</p>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>以gh-ost 1.0.48版本为准<br></p>
<table>
<thead>
<tr>
<th><div style="width:50px">参数</div></th>
<th><div style="width:800px">描述</div></th>
</tr>
</thead>
<tbody>
<tr>
<td>-aliyun-rds</td>
<td>set ‘true’,允许在阿里云数据库上执行</td>
</tr>
<tr>
<td>-allow-master-master</td>
<td>是否允许gh-ost运行在双主复制架构中，一般与-assume-master-host参数一起使用</td>
</tr>
<tr>
<td>-allow-nullable-unique-key</td>
<td>允许gh-ost在数据迁移依赖的唯一键可以为NULL，默认为不允许为NULL的唯一键。如果数据迁移(migrate)依赖的唯一键允许NULL值，则可能造成数据不正确，请谨慎使用。</td>
</tr>
<tr>
<td>-allow-on-master</td>
<td>允许gh-ost直接运行在主库上，默认gh-ost连接的从库。</td>
</tr>
<tr>
<td>-alter string</td>
<td>string:DDL语句</td>
</tr>
<tr>
<td>-approve-renamed-columns</td>
<td>ALTER:如果你修改一个列的名字，gh-ost将会识别到并且需要提供重命名列名的原因，默认情况下gh-ost是不继续执行的，除非提供-approve-renamed-columns ALTER。</td>
</tr>
<tr>
<td>-ask-pass</td>
<td>MySQL密码</td>
</tr>
<tr>
<td>-assume-master-host</td>
<td>string:为gh-ost指定一个主库，格式为”ip:port”或者”hostname:port”。在这主主架构里比较有用，或则在gh-ost发现不到主的时候有用。</td>
</tr>
<tr>
<td>-assume-rbr</td>
<td>确认gh-ost连接的数据库实例的binlog_format=ROW的情况下，可以指定-assume-rbr，这样可以禁止从库上运行stop slave,start slave,执行gh-ost用户也不需要SUPER权限。</td>
</tr>
<tr>
<td>-check-flag</td>
<td>检查是否存在/支持另一个标志。 这允许跨版本脚本编写。 当所有其他提供的标志都存在时，以0退出，否则返回非零。 您必须为需要值的标志提供（虚拟）值。 示例：gh-ost –check-flag –cut-over-lock-timeout-seconds –nice-ratio 0</td>
</tr>
<tr>
<td>-chunk-size</td>
<td>int:在每次迭代中处理的行数量(允许范围：100-100000)，默认值为1000。</td>
</tr>
<tr>
<td>-concurrent-rowcount</td>
<td>该参数如果为True(默认值)，则进行row-copy之后，估算统计行数(使用explain select count(*)方式)，并调整ETA时间，否则，gh-ost首先预估统计行数，然后开始row-copy。</td>
</tr>
<tr>
<td>-conf</td>
<td>gh-ost的配置文件路径。</td>
</tr>
<tr>
<td>-critical-load</td>
<td>string:一系列逗号分隔的status-name=values组成，当MySQL中status超过对应的values，gh-ost将会退出。-critical-load Threads_connected=20,Connections=1500，指的是当MySQL中的状态值Threads_connected&gt;20,Connections&gt;1500的时候，gh-ost将会由于该数据库严重负载而停止并退出。</td>
</tr>
<tr>
<td>-critical-load-hibernate-seconds</td>
<td>int:负载达到critical-load时，gh-ost在指定的时间内进入休眠状态。 它不会读/写任何来自任何服务器的任何内容。</td>
</tr>
<tr>
<td>-critical-load-interval-millis</td>
<td>int:当值为0时，当达到-critical-load，gh-ost立即退出。当值不为0时，当达到-critical-load，gh-ost会在-critical-load-interval-millis秒数后，再次进行检查，再次检查依旧达到-critical-load，gh-ost将会退出。</td>
</tr>
<tr>
<td>-cut-over</td>
<td>string:选择cut-over类型:atomic/two-step，atomic(默认)类型的cut-over是github的算法，two-step采用的是facebook-OSC的算法。</td>
</tr>
<tr>
<td>-cut-over-exponential-backoff</td>
<td>两次失败的切换尝试之间的等待时间间隔成指数增长。 等待间隔服从”exponential-backoff-max-interval”可配置的最大值。</td>
</tr>
<tr>
<td>-cut-over-lock-timeout-seconds</td>
<td>int:gh-ost在cut-over阶段最大的锁等待时间，当锁超时时，gh-ost的cut-over将重试。(默认值：3)</td>
</tr>
<tr>
<td>-database</td>
<td>string:数据库名称。</td>
</tr>
<tr>
<td>-debug</td>
<td>debug模式。</td>
</tr>
<tr>
<td>-default-retries</td>
<td>int:各种操作在panick前重试次数。(默认为60)</td>
</tr>
<tr>
<td>-discard-foreign-keys</td>
<td>该参数针对一个有外键的表，在gh-ost创建ghost表时，并不会为ghost表创建外键。该参数很适合用于删除外键，除此之外，请谨慎使用。</td>
</tr>
<tr>
<td>-dml-batch-size</td>
<td>int:在单个事务中应用DML事件的批量大小（范围1-100）（默认值为10）</td>
</tr>
<tr>
<td>-exact-rowcount</td>
<td>准确统计表行数(使用select count(*)的方式)，得到更准确的预估时间。</td>
</tr>
<tr>
<td>-execute</td>
<td>实际执行alter&amp;migrate表，默认为noop，不执行，仅仅做测试并退出，如果想要ALTER TABLE语句真正落实到数据库中去，需要明确指定-execute</td>
</tr>
<tr>
<td>-exponential-backoff-max-interval</td>
<td>在执行具有指数补偿的各种操作时，两次尝试之间等待的最大秒数。 （默认为64）</td>
</tr>
<tr>
<td>-force-named-cut-over</td>
<td>如果为true，则’unpostpone cut-over’交互式命令必须命名迁移的表</td>
</tr>
<tr>
<td>-force-table-names</td>
<td>string:在临时表上使用的表名前缀</td>
</tr>
<tr>
<td>-gcp</td>
<td>在第一代Google Cloud Platform（GCP）上执行时，请将其设置为”true”。</td>
</tr>
<tr>
<td>-heartbeat-interval-millis</td>
<td>gh-ost心跳频率值，默认为500</td>
</tr>
<tr>
<td>-help</td>
<td>帮助</td>
</tr>
<tr>
<td>-hooks-hint</td>
<td>string:任意消息通过GH_OST_HOOKS_HINT注入到钩子</td>
</tr>
<tr>
<td>-hooks-hint-owner</td>
<td>通过GH_OST_HOOKS_HINT_OWNER将所有者的任意名称注入到钩子中</td>
</tr>
<tr>
<td>-hooks-hint-token</td>
<td>通过GH_OST_HOOKS_HINT_TOKEN将任意令牌注入到挂钩中</td>
</tr>
<tr>
<td>-hooks-path</td>
<td>string:hook文件存放目录(默认为empty，即禁用hook)。hook会在这个目录下寻找符合约定命名的hook文件来执行。</td>
</tr>
<tr>
<td>-host</td>
<td>string :MySQL IP/hostname</td>
</tr>
<tr>
<td>-initially-drop-ghost-table</td>
<td>gh-ost操作之前，检查并删除已经存在的ghost表。该参数不建议使用，请手动处理原来存在的ghost表。默认不启用该参数，gh-ost直接退出操作。</td>
</tr>
<tr>
<td>-initially-drop-old-table</td>
<td>gh-ost操作之前，检查并删除已经存在的旧表。该参数不建议使用，请手动处理原来存在的ghost表。默认不启用该参数，gh-ost直接退出操作。</td>
</tr>
<tr>
<td>-initially-drop-socket-file</td>
<td>gh-ost强制删除已经存在的socket文件。该参数不建议使用，可能会删除一个正在运行的gh-ost程序，导致DDL失败。</td>
</tr>
<tr>
<td>-master-password</td>
<td>string:MySQL主密码</td>
</tr>
<tr>
<td>-master-user</td>
<td>string:MysQL主账号</td>
</tr>
<tr>
<td>-max-lag-millis</td>
<td>主从复制最大延迟时间，当主从复制延迟时间超过该值后，gh-ost将采取节流(throttle)措施，默认值：1500s。</td>
</tr>
<tr>
<td>-max-load</td>
<td>string:逗号分隔状态名称=阈值，如：’Threads_running=100,Threads_connected=500’. When status exceeds threshold, app throttles writes</td>
</tr>
<tr>
<td>-migrate-on-replica</td>
<td>gh-ost的数据迁移(migrate)运行在从库上，而不是主库上。 </td>
</tr>
<tr>
<td>-nice-ratio</td>
<td>float:每次chunk时间段的休眠时间，范围[0.0…100.0]。0：每个chunk时间段不休眠，即一个chunk接着一个chunk执行；1：每row-copy 1毫秒，则另外休眠1毫秒；0.7：每row-copy 10毫秒，则另外休眠7毫秒。</td>
</tr>
<tr>
<td>-ok-to-drop-table</td>
<td>gh-ost操作结束后，删除旧表，默认状态是不删除旧表，会存在_tablename_del表。</td>
</tr>
<tr>
<td>-panic-flag-file</td>
<td>string:当这个文件被创建，gh-ost将会立即退出。</td>
</tr>
<tr>
<td>-password</td>
<td>string:MySQL密码</td>
</tr>
<tr>
<td>-port</td>
<td>int:MySQL端口</td>
</tr>
<tr>
<td>-postpone-cut-over-flag-file</td>
<td>string：当这个文件存在的时候，gh-ost的cut-over阶段将会被推迟，数据仍然在复制，直到该文件被删除。</td>
</tr>
<tr>
<td>-quiet</td>
<td>静默模式</td>
</tr>
<tr>
<td>-replica-server-id</td>
<td>uint:gh-ost的server_id</td>
</tr>
<tr>
<td>-replication-lag-query</td>
<td>string:弃用</td>
</tr>
<tr>
<td>-serve-socket-file</td>
<td>string：gh-ost的socket文件绝对路径。</td>
</tr>
<tr>
<td>-serve-tcp-port</td>
<td>int:gh-ost使用端口，默认为关闭端口。</td>
</tr>
<tr>
<td>-skip-foreign-key-checks</td>
<td>确定你的表上没有外键时，设置为’true’，并且希望跳过gh-ost验证的时间-skip-renamed-columns ALTER</td>
</tr>
<tr>
<td>-skip-renamed-columns</td>
<td>ALTER：如果你修改一个列的名字(如change column)，gh-ost将会识别到并且需要提供重命名列名的原因，默认情况下gh-ost是不继续执行的。该参数告诉gh-ost跳该列的数据迁移，让gh-ost把重命名列作为无关紧要的列。该操作很危险，你会损失该列的所有值。</td>
</tr>
<tr>
<td>-ssl</td>
<td>ssl连接MySQL</td>
</tr>
<tr>
<td>-ssl-allow-insecure</td>
<td>Skips verification of MySQL hosts’ certificate chain and host name. Requires –ssl</td>
</tr>
<tr>
<td>-ssl-ca</td>
<td>CA certificate in PEM format for TLS connections to MySQL hosts. Requires –ssl</td>
</tr>
<tr>
<td>-stack</td>
<td>添加错误堆栈追踪。</td>
</tr>
<tr>
<td>-switch-to-rbr</td>
<td>让gh-ost自动将从库的binlog_format转换为ROW格式。</td>
</tr>
<tr>
<td>-table</td>
<td>string:表名</td>
</tr>
<tr>
<td>-test-on-replica</td>
<td>在从库上测试gh-ost，包括在从库上数据迁移(migration)，数据迁移完成后stop slave，原表和ghost表立刻交换而后立刻交换回来。继续保持stop slave，使你可以对比两张表。</td>
</tr>
<tr>
<td>-test-on-replica-skip-replica-stop</td>
<td>当-test-on-replica执行时，该参数表示该过程中不用stop slave。</td>
</tr>
<tr>
<td>-throttle-additional-flag-file</td>
<td>string:当该文件被创建后，gh-ost操作立即停止。该参数可以用在多个gh-ost同时操作的时候，创建一个文件，让所有的gh-ost操作停止，或者删除这个文件，让所有的gh-ost操作恢复。</td>
</tr>
<tr>
<td>-throttle-control-replicas</td>
<td>string:列出所有需要被检查主从复制延迟的从库。</td>
</tr>
<tr>
<td>-throttle-flag-file</td>
<td>string:当该文件被创建后，gh-ost操作立即停止。该参数适合控制单个gh-ost操作。-throttle-additional-flag-file string适合控制多个gh-ost操作。</td>
</tr>
<tr>
<td>-throttle-http</td>
<td>when given, gh-ost checks given URL via HEAD request; any response code other than 200 (OK) causes throttling; make sure it has low latency response  -throttle-query string</td>
</tr>
<tr>
<td>-throttle-query</td>
<td>string:节流查询。每秒钟执行一次。当返回值=0时不需要节流，当返回值&gt;0时，需要执行节流操作。该查询会在数据迁移(migrated)服务器上操作，所以请确保该查询是轻量级的。</td>
</tr>
<tr>
<td>-timestamp-old-table</td>
<td>在旧表名中使用时间戳。 这会使旧表名称具有唯一且无冲突的交叉迁移</td>
</tr>
<tr>
<td>-tungsten</td>
<td>告诉gh-ost你正在运行的是一个tungsten-replication拓扑结构。</td>
</tr>
<tr>
<td>-user</td>
<td>string:MYSQL用户</td>
</tr>
<tr>
<td>-verbose</td>
<td>verbose</td>
</tr>
<tr>
<td>-version</td>
<td>版本</td>
</tr>
</tbody>
</table>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="单实例DDL"><a href="#单实例DDL" class="headerlink" title="单实例DDL"></a>单实例DDL</h3><p>相当于主库，需要开启–allow-on-master参数和ROW模式<br><br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">./gh-ost \</span><br><span class="line">-<span class="ruby">-max-load=Threads_running=<span class="number">25</span> \</span></span><br><span class="line"><span class="ruby">--critical-load=Threads_running=<span class="number">512</span> \</span></span><br><span class="line"><span class="ruby">--chunk-size=<span class="number">1000</span> \</span></span><br><span class="line"><span class="ruby">--initially-drop-old-table \</span></span><br><span class="line"><span class="ruby">--initially-drop-ghost-table \</span></span><br><span class="line"><span class="ruby">--initially-drop-socket-file \</span></span><br><span class="line"><span class="ruby">--ok-to-drop-table \</span></span><br><span class="line"><span class="ruby">--conf=<span class="string">"/etc/my.cnf"</span> \</span></span><br><span class="line"><span class="ruby">--host=<span class="string">"master:ip"</span> \</span></span><br><span class="line"><span class="ruby">--port=<span class="number">3306</span> \</span></span><br><span class="line"><span class="ruby">--user=<span class="string">"root"</span> \</span></span><br><span class="line"><span class="ruby">--password=<span class="string">"xxx"</span> \</span></span><br><span class="line"><span class="ruby">--database=<span class="string">"sysbench"</span> \</span></span><br><span class="line"><span class="ruby">--table=<span class="string">"sbtest1"</span> \</span></span><br><span class="line"><span class="ruby">--verbose \</span></span><br><span class="line"><span class="ruby">--alter=<span class="string">"engine=innodb"</span> \</span></span><br><span class="line"><span class="ruby">--switch-to-rbr \</span></span><br><span class="line"><span class="ruby">--allow-on-master \</span></span><br><span class="line"><span class="ruby">--allow-master-master \</span></span><br><span class="line"><span class="ruby">--cut-over=default \</span></span><br><span class="line"><span class="ruby">--default-retries=<span class="number">120</span> \</span></span><br><span class="line"><span class="ruby">--panic-flag-file=<span class="regexp">/tmp/ghost</span>.panic.flag \</span></span><br><span class="line"><span class="ruby">--serve-socket-file=<span class="regexp">/tmp/gh</span>-ost.socket.sock  \</span></span><br><span class="line"><span class="ruby">--execute</span></span><br></pre></td></tr></table></figure></p>
<h3 id="主从上DDL"><a href="#主从上DDL" class="headerlink" title="主从上DDL"></a>主从上DDL</h3><p>有2个选择，一是按照单实例DDL直接在主上执行同步到从上，另一个连接到从库，在主库做迁移（只要保证从库的binlog为ROW即可，主库不需要保证）,以下去除了参数–allow-on-master<br><br><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">./gh-ost \</span><br><span class="line">-<span class="ruby">-max-load=Threads_running=<span class="number">25</span> \</span></span><br><span class="line"><span class="ruby">--critical-load=Threads_running=<span class="number">512</span> \</span></span><br><span class="line"><span class="ruby">--chunk-size=<span class="number">1000</span> \</span></span><br><span class="line"><span class="ruby">--initially-drop-old-table \</span></span><br><span class="line"><span class="ruby">--initially-drop-ghost-table \</span></span><br><span class="line"><span class="ruby">--initially-drop-socket-file \</span></span><br><span class="line"><span class="ruby">--ok-to-drop-table \</span></span><br><span class="line"><span class="ruby">--conf=<span class="string">"/etc/my.cnf"</span> \</span></span><br><span class="line"><span class="ruby">--host=<span class="string">"slave:ip"</span> \</span></span><br><span class="line"><span class="ruby">--port=<span class="number">3306</span> \</span></span><br><span class="line"><span class="ruby">--user=<span class="string">"root"</span> \</span></span><br><span class="line"><span class="ruby">--password=<span class="string">"xxx"</span> \</span></span><br><span class="line"><span class="ruby">--database=<span class="string">"sysbench"</span> \</span></span><br><span class="line"><span class="ruby">--table=<span class="string">"sbtest1"</span> \</span></span><br><span class="line"><span class="ruby">--verbose \</span></span><br><span class="line"><span class="ruby">--alter=<span class="string">"engine=innodb"</span> \</span></span><br><span class="line"><span class="ruby">--switch-to-rbr \</span></span><br><span class="line"><span class="ruby">--allow-master-master \</span></span><br><span class="line"><span class="ruby">--cut-over=default \</span></span><br><span class="line"><span class="ruby">--default-retries=<span class="number">120</span> \</span></span><br><span class="line"><span class="ruby">--panic-flag-file=<span class="regexp">/tmp/ghost</span>.panic.flag \</span></span><br><span class="line"><span class="ruby">--serve-socket-file=<span class="regexp">/tmp/gh</span>-ost.socket.sock  \</span></span><br><span class="line"><span class="ruby">--execute</span></span><br></pre></td></tr></table></figure></p>
<p>注意：<br></p>
<ul>
<li>在执行DDL中，从库会执行一次stop/start slave，要是确定从的binlog是ROW的话可以添加参数：–assume-rbr。如果从库的binlog不是ROW，可以用参数–switch-to-rbr来转换成ROW，此时需要注意的是执行完毕之后，binlog模式不会被转换成原来的值。–assume-rbr和–switch-to-rbr参数不能一起使用。</li>
<li>–host需要连接从库的ip</li>
</ul>
<h3 id="终止、暂停、限速"><a href="#终止、暂停、限速" class="headerlink" title="终止、暂停、限速"></a>终止、暂停、限速</h3><ul>
<li>① 表示文件终止运行：–panic-flag-file。</li>
<li>创建文件终止运行，例子中创建/tmp/ghost.panic.flag文件，终止正在运行的gh-ost，临时文件清理需要手动进行。</li>
<li>② 表示文件禁止cut-over进行，即禁止表名切换，数据复制正常进行。–postpone-cut-over-flag-file</li>
<li>创建文件延迟cut-over进行，即推迟切换操作。例子中创建/tmp/ghost.postpone.flag文件，gh-ost 会完成行复制，但并不会切换表，它会持续的将原表的数据更新操作同步到临时表中。(适用于夜里变更时间较长,担心自动cut-over失败,延迟cut-over,早上上班后再做切换)</li>
<li>③ 使用socket监听请求，操作者可以在命令运行后更改相应的参数。–serve-socket-file，–serve-tcp-port（默认关闭）</li>
<li>创建socket文件进行监听，通过接口进行参数调整，当执行操作的过程中发现负载、延迟上升了，不得不终止操作，重新配置参数，如 chunk-size，然后重新执行操作命令，可以通过scoket接口进行动态调整。如：<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">暂停操作：</span><br><span class="line"><span class="comment">#暂停</span></span><br><span class="line"><span class="keyword">echo</span> throttle | socat - <span class="string">/tmp/gh-ost.socket.sock</span></span><br><span class="line"><span class="comment">#恢复</span></span><br><span class="line"><span class="keyword">echo</span> no-throttle | socat - <span class="string">/tmp/gh-ost.socket.sock</span></span><br><span class="line"></span><br><span class="line">修改限速参数：</span><br><span class="line"><span class="keyword">echo</span> chunk-size=100 | socat - <span class="string">/tmp/gh-ost.socket.sock</span></span><br><span class="line"><span class="keyword">echo</span> max-lag-millis=200 | socat - <span class="string">/tmp/gh-ost.socket.sock</span></span><br><span class="line"><span class="keyword">echo</span> max-load=Thread_running=3 | socat - <span class="string">/tmp/gh-ost.socket.sock</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>注意：<br><br><figure class="highlight q"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--postpone-<span class="built_in">cut</span>-<span class="built_in">over</span>-flag-file=/tmp/ghost.postpone.flag  #如果指定该参数，此文件执行时就会创建，默认也就延迟做<span class="built_in">cut</span>-<span class="built_in">over</span>，直到文件删除，执行<span class="built_in">cut</span>-<span class="built_in">over</span></span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>gh-ost问世之后，由于其创建的设计模式，对生产的影响较小，已经成为了DDL的标准工具，广泛应用于生产。特别是公司内部有自建的运维平台，gh-ost多数会集成进平台，成为标配工具。即使在MySQL 8.0.12后官方的MySQL Online DDL支持秒级加字段，加索引，但是因为其限制，仅支持部分的场景可以做到秒级。并且，多数公司使用的MySQL版本还停留在5.7版本，目前来看，gh-ost是最优秀的MySQL DDL工具。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://segmentfault.com/a/1190000006158503" target="_blank" rel="noopener">https://segmentfault.com/a/1190000006158503</a><br><a href="https://segmentfault.com/a/1190000020409138" target="_blank" rel="noopener">https://segmentfault.com/a/1190000020409138</a><br><a href="https://segmentfault.com/a/1190000020417715" target="_blank" rel="noopener">https://segmentfault.com/a/1190000020417715</a></p>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/pt-online-schema-change-使用教程.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/pt-online-schema-change-使用教程.html" itemprop="url">pt-online-schema-change 使用教程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-20T14:12:57+08:00">
                2018-09-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工具/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>MySQL生产更改表结构的方式有很多，MySQL官方的Online DDL，github开源的gh-ost，此文仅介绍percona的工具包其中的pt-online-schema-change</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><h3 id="general-log"><a href="#general-log" class="headerlink" title="general_log"></a>general_log</h3><p>在mysql实例中开启general_log参数，观察pt-online-schema-change的执行过程。</p>
<p>执行pt-online-schema-change的语句如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-online-schema-change <span class="attribute">--user</span>=root  <span class="attribute">--password</span>=xxx <span class="attribute">--socket</span>=/opt/mysql3306/data/mysql.sock  <span class="attribute">D</span>=test,t=employee1 --alter <span class="string">"engine=innodb"</span>  <span class="attribute">--recursion-method</span>=none --no-check-replication-filters --alter-foreign-keys-method auto --<span class="builtin-name">print</span> --execute <span class="attribute">--critical-load</span>=<span class="string">"Threads_running:200"</span> <span class="attribute">--charset</span>=utf8mb4</span><br></pre></td></tr></table></figure></p>
<p>以下为执行DDL过程中产生的general_log:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">2018-09-20T14:22:32.070723+08:00	   52 Connect	root@localhost on test using Socket</span><br><span class="line">2018-09-20T14:22:32.071066+08:00	   52 Query	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'innodb\_lock_wait_timeout'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.073617</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">SESSION</span> innodb_lock_wait_timeout=<span class="number">1</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.073760</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'lock\_wait_timeout'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.074808</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">SESSION</span> lock_wait_timeout=<span class="number">60</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.074930</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'wait\_timeout'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.075913</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">SESSION</span> wait_timeout=<span class="number">10000</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.076034</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@SQL_MODE</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.076153</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> @@SQL_QUOTE_SHOW_CREATE = <span class="number">1</span><span class="comment">/*!40101, @@SQL_MODE='NO_AUTO_VALUE_ON_ZERO,ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.076290</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@server_id <span class="comment">/*!50038 , @@hostname*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.077001</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Connect</span>	root@localhost <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> Socket</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.077212</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'innodb\_lock_wait_timeout'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.078706</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">SESSION</span> innodb_lock_wait_timeout=<span class="number">1</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.078829</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'lock\_wait_timeout'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.079847</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">SESSION</span> lock_wait_timeout=<span class="number">60</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.079964</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'wait\_timeout'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.080952</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">SESSION</span> wait_timeout=<span class="number">10000</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.081068</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@SQL_MODE</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.081183</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> @@SQL_QUOTE_SHOW_CREATE = <span class="number">1</span><span class="comment">/*!40101, @@SQL_MODE='NO_AUTO_VALUE_ON_ZERO,ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.081314</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@server_id <span class="comment">/*!50038 , @@hostname*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.081664</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'wsrep_on'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.083211</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'version%'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.084429</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">ENGINES</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.084774</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'innodb_version'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.086177</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'innodb_stats_persistent'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.087447</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.088579</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.089437</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(@@hostname, @@port)</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.089777</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">TABLES</span> <span class="keyword">FROM</span> <span class="string">`test`</span> <span class="keyword">LIKE</span> <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.131978</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="keyword">VERSION</span>()</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.132209</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">TRIGGERS</span> <span class="keyword">FROM</span> <span class="string">`test`</span> <span class="keyword">LIKE</span> <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.141352</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="comment">/*!40101 SET @OLD_SQL_MODE := @@SQL_MODE, @@SQL_MODE := '', @OLD_QUOTE := @@SQL_QUOTE_SHOW_CREATE, @@SQL_QUOTE_SHOW_CREATE := 1 */</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.141549</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">USE</span> <span class="string">`test`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.141731</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.142086</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="comment">/*!40101 SET @@SQL_MODE := @OLD_SQL_MODE, @@SQL_QUOTE_SHOW_CREATE := @OLD_QUOTE */</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.142497</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">WHERE</span> <span class="number">1</span>=<span class="number">1</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.142931</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> table_schema, table_name <span class="keyword">FROM</span> information_schema.key_column_usage <span class="keyword">WHERE</span> referenced_table_schema=<span class="string">'test'</span> <span class="keyword">AND</span> referenced_table_name=<span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.216829</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'wsrep_on'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.219654</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="comment">/*!40101 SET @OLD_SQL_MODE := @@SQL_MODE, @@SQL_MODE := '', @OLD_QUOTE := @@SQL_QUOTE_SHOW_CREATE, @@SQL_QUOTE_SHOW_CREATE := 1 */</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.219802</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">USE</span> <span class="string">`test`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.220004</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.220231</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="comment">/*!40101 SET @@SQL_MODE := @OLD_SQL_MODE, @@SQL_QUOTE_SHOW_CREATE := @OLD_QUOTE */</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.220455</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`employeeid`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'0'</span>,</span><br><span class="line">  <span class="string">`employeename`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">10001</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.336287</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> <span class="keyword">engine</span>=<span class="keyword">innodb</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.499232</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="comment">/*!40101 SET @OLD_SQL_MODE := @@SQL_MODE, @@SQL_MODE := '', @OLD_QUOTE := @@SQL_QUOTE_SHOW_CREATE, @@SQL_QUOTE_SHOW_CREATE := 1 */</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.499400</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">USE</span> <span class="string">`test`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.499611</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.499866</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="comment">/*!40101 SET @@SQL_MODE := @OLD_SQL_MODE, @@SQL_QUOTE_SHOW_CREATE := @OLD_QUOTE */</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.500737</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> TRIGGER_SCHEMA, TRIGGER_NAME, DEFINER, ACTION_STATEMENT, SQL_MODE,        CHARACTER_SET_CLIENT, COLLATION_CONNECTION, EVENT_MANIPULATION, ACTION_TIMING   <span class="keyword">FROM</span> INFORMATION_SCHEMA.TRIGGERS  <span class="keyword">WHERE</span> EVENT_MANIPULATION = <span class="string">'DELETE'</span>    <span class="keyword">AND</span> ACTION_TIMING = <span class="string">'AFTER'</span>    <span class="keyword">AND</span> TRIGGER_SCHEMA = <span class="string">'test'</span>    <span class="keyword">AND</span> EVENT_OBJECT_TABLE = <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.502027</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> TRIGGER_SCHEMA, TRIGGER_NAME, DEFINER, ACTION_STATEMENT, SQL_MODE,        CHARACTER_SET_CLIENT, COLLATION_CONNECTION, EVENT_MANIPULATION, ACTION_TIMING   <span class="keyword">FROM</span> INFORMATION_SCHEMA.TRIGGERS  <span class="keyword">WHERE</span> EVENT_MANIPULATION = <span class="string">'UPDATE'</span>    <span class="keyword">AND</span> ACTION_TIMING = <span class="string">'AFTER'</span>    <span class="keyword">AND</span> TRIGGER_SCHEMA = <span class="string">'test'</span>    <span class="keyword">AND</span> EVENT_OBJECT_TABLE = <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.502989</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> TRIGGER_SCHEMA, TRIGGER_NAME, DEFINER, ACTION_STATEMENT, SQL_MODE,        CHARACTER_SET_CLIENT, COLLATION_CONNECTION, EVENT_MANIPULATION, ACTION_TIMING   <span class="keyword">FROM</span> INFORMATION_SCHEMA.TRIGGERS  <span class="keyword">WHERE</span> EVENT_MANIPULATION = <span class="string">'INSERT'</span>    <span class="keyword">AND</span> ACTION_TIMING = <span class="string">'AFTER'</span>    <span class="keyword">AND</span> TRIGGER_SCHEMA = <span class="string">'test'</span>    <span class="keyword">AND</span> EVENT_OBJECT_TABLE = <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.503974</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> TRIGGER_SCHEMA, TRIGGER_NAME, DEFINER, ACTION_STATEMENT, SQL_MODE,        CHARACTER_SET_CLIENT, COLLATION_CONNECTION, EVENT_MANIPULATION, ACTION_TIMING   <span class="keyword">FROM</span> INFORMATION_SCHEMA.TRIGGERS  <span class="keyword">WHERE</span> EVENT_MANIPULATION = <span class="string">'DELETE'</span>    <span class="keyword">AND</span> ACTION_TIMING = <span class="string">'BEFORE'</span>    <span class="keyword">AND</span> TRIGGER_SCHEMA = <span class="string">'test'</span>    <span class="keyword">AND</span> EVENT_OBJECT_TABLE = <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.504875</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> TRIGGER_SCHEMA, TRIGGER_NAME, DEFINER, ACTION_STATEMENT, SQL_MODE,        CHARACTER_SET_CLIENT, COLLATION_CONNECTION, EVENT_MANIPULATION, ACTION_TIMING   <span class="keyword">FROM</span> INFORMATION_SCHEMA.TRIGGERS  <span class="keyword">WHERE</span> EVENT_MANIPULATION = <span class="string">'UPDATE'</span>    <span class="keyword">AND</span> ACTION_TIMING = <span class="string">'BEFORE'</span>    <span class="keyword">AND</span> TRIGGER_SCHEMA = <span class="string">'test'</span>    <span class="keyword">AND</span> EVENT_OBJECT_TABLE = <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.505829</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> TRIGGER_SCHEMA, TRIGGER_NAME, DEFINER, ACTION_STATEMENT, SQL_MODE,        CHARACTER_SET_CLIENT, COLLATION_CONNECTION, EVENT_MANIPULATION, ACTION_TIMING   <span class="keyword">FROM</span> INFORMATION_SCHEMA.TRIGGERS  <span class="keyword">WHERE</span> EVENT_MANIPULATION = <span class="string">'INSERT'</span>    <span class="keyword">AND</span> ACTION_TIMING = <span class="string">'BEFORE'</span>    <span class="keyword">AND</span> TRIGGER_SCHEMA = <span class="string">'test'</span>    <span class="keyword">AND</span> EVENT_OBJECT_TABLE = <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.513721</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> <span class="string">`pt_osc_test_employee1_del`</span> <span class="keyword">AFTER</span> <span class="keyword">DELETE</span> <span class="keyword">ON</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">DELETE</span> <span class="keyword">IGNORE</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> <span class="keyword">WHERE</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span>.<span class="string">`id`</span> &lt;=&gt; OLD.<span class="string">`id`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.552672</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> <span class="string">`pt_osc_test_employee1_upd`</span> <span class="keyword">AFTER</span> <span class="keyword">UPDATE</span> <span class="keyword">ON</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">BEGIN</span> <span class="keyword">DELETE</span> <span class="keyword">IGNORE</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> <span class="keyword">WHERE</span> !(OLD.<span class="string">`id`</span> &lt;=&gt; NEW.<span class="string">`id`</span>) <span class="keyword">AND</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span>.<span class="string">`id`</span> &lt;=&gt; OLD.<span class="string">`id`</span>;<span class="keyword">REPLACE</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>) <span class="keyword">VALUES</span> (NEW.<span class="string">`id`</span>, NEW.<span class="string">`employeeid`</span>, NEW.<span class="string">`employeename`</span>);<span class="keyword">END</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.583800</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> <span class="string">`pt_osc_test_employee1_ins`</span> <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">REPLACE</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>) <span class="keyword">VALUES</span> (NEW.<span class="string">`id`</span>, NEW.<span class="string">`employeeid`</span>, NEW.<span class="string">`employeename`</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.611701</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">WHERE</span> <span class="number">1</span>=<span class="number">1</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.613770</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="string">`id`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">LIMIT</span> <span class="number">1</span> <span class="comment">/*first lower boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.614250</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="string">`id`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span> (<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> <span class="string">`id`</span> <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">LIMIT</span> <span class="number">1</span> <span class="comment">/*key_len*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.614536</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> * <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span> (<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> <span class="string">`id`</span> &gt;= <span class="string">'1'</span> <span class="comment">/*key_len*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.614982</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="string">`id`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1'</span>)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">LIMIT</span> <span class="number">999</span>, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.615319</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="string">`id`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1'</span>)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">LIMIT</span> <span class="number">999</span>, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.615860</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1'</span>)) <span class="keyword">AND</span> ((<span class="string">`id`</span> &lt;= <span class="string">'1000'</span>)) <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span> <span class="comment">/*explain pt-online-schema-change 17673 copy nibble*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.616300</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">INSERT</span> <span class="keyword">LOW_PRIORITY</span> <span class="keyword">IGNORE</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>) <span class="keyword">SELECT</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1'</span>)) <span class="keyword">AND</span> ((<span class="string">`id`</span> &lt;= <span class="string">'1000'</span>)) <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span> <span class="comment">/*pt-online-schema-change 17673 copy nibble*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.652804</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">WARNINGS</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.653297</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.654684</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="string">`id`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1001'</span>)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">LIMIT</span> <span class="number">13729</span>, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.655061</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="string">`id`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1001'</span>)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">LIMIT</span> <span class="number">13729</span>, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.657464</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="string">`id`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> <span class="number">1</span> <span class="comment">/*last upper boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.657712</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1001'</span>)) <span class="keyword">AND</span> ((<span class="string">`id`</span> &lt;= <span class="string">'10000'</span>)) <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span> <span class="comment">/*explain pt-online-schema-change 17673 copy nibble*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.658105</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">INSERT</span> <span class="keyword">LOW_PRIORITY</span> <span class="keyword">IGNORE</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>) <span class="keyword">SELECT</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1001'</span>)) <span class="keyword">AND</span> ((<span class="string">`id`</span> &lt;= <span class="string">'10000'</span>)) <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span> <span class="comment">/*pt-online-schema-change 17673 copy nibble*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.890346</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">WARNINGS</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.890850</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.892398</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'version%'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.895063</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">ENGINES</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.895463</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'innodb_version'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.897284</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">ANALYZE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> <span class="comment">/* pt-online-schema-change */</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.935080</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">RENAME</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">TO</span> <span class="string">`test`</span>.<span class="string">`_employee1_old`</span>, <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> <span class="keyword">TO</span> <span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">33.051130</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`test`</span>.<span class="string">`_employee1_old`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">33.147460</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`test`</span>.<span class="string">`pt_osc_test_employee1_del`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">33.153099</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`test`</span>.<span class="string">`pt_osc_test_employee1_upd`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">33.160364</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`test`</span>.<span class="string">`pt_osc_test_employee1_ins`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">33.170939</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">TABLES</span> <span class="keyword">FROM</span> <span class="string">`test`</span> <span class="keyword">LIKE</span> <span class="string">'\_employee1\_new'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">33.227570</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">33.230437</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> Quit</span><br></pre></td></tr></table></figure></p>
<h3 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h3><ol>
<li>创建一个和要执行alter操作的表一样的新的空表，前缀为_开头，后缀以_new结尾。</li>
<li>在新表执行alter table 语句，因为是空表，执行速度很快。</li>
<li>在原表中创建3个触发器，分别对应insert,update,delete操作，<font color="FF000">在5.6版本中不允许存在其他触发器</font>，会报错，5.7版本中无此限制。</li>
<li>以一定块大小从原表拷贝数据到临时表，拷贝过程中通过原表上的触发器在原表进行的写操作都会更新到新建的临时表，注意这里INSERT和UPDATE采用INSERT LOW_PRIORITY IGNORE INTO操作，DELETE和UPDATE采用REPLACE INTO操作。</li>
<li>以原子重命名的方式，将原表名table修改为 _table_old, 将_table_new 表明修改为原表名。</li>
<li>如果有参考该表的外键，根据alter-foreign-keys-method参数的值，检测外键相关的表，做相应设置的处理。</li>
<li>默认最后将旧原表删除，触发器删除。</li>
</ol>
<h3 id="时序问题"><a href="#时序问题" class="headerlink" title="时序问题"></a>时序问题</h3><p>这里说明一下复制原表数据和触发器的执行顺序是否会产生数据不一致的问题</p>
<h4 id="UPDATE"><a href="#UPDATE" class="headerlink" title="UPDATE"></a>UPDATE</h4><p>1.假设pt-online-schema-change在T(10:00:00)执行<br><br>2.假设id=2000050这行数据，在T2(10:01:00)时间进行了update，生产的数据通过触发器同步到了临时表，update方式为先DELETE IGNORE，然后REPLCAE INTO，会有2种情况：<br><br>1)如果id=2000050这行数据还没从原表复制到临时表，此时DELETE IGNORE不会匹配到数据，REPLCAE INTO会插入新数据；后面执行到分批从原表复制数据到临时表时，包括将id=2000050这行，由于采用的用INSERT LOW_PRIORITY IGNORE INTO，也就不会插入；<br><br>2)如果id=2000050这行数据已经从原表复制到临时表，此时DELETE IGNORE会匹配到数据并删除，REPLCAE INTO重新插入新数据；<br><br>3.继续往后执行</p>
<h4 id="INSERT"><a href="#INSERT" class="headerlink" title="INSERT"></a>INSERT</h4><p>1.假设pt-online-schema-change在T(10:00:00)执行<br><br>2.假设新插入数据id=10000001这行数据，在T2(10:30:00)时间进行，由于新插入的数据原表不存在，通过触发器，采用REPLACE INTO，临时表如果存在这条数据，覆盖掉，理论上通过pt-online-schema-change正常执行，临时表也不会存在此行数据<br><br>3.继续往后执行</p>
<h4 id="DELETE"><a href="#DELETE" class="headerlink" title="DELETE"></a>DELETE</h4><p>1.假设pt-online-schema-change在T(10:00:00)执行<br><br>2.假设id=2000050这行数据，在T2(10:01:00)时间进行了delete，生产的数据通过触发器同步到了临时表，delete方式为先DELETE IGNORE<br><br>1)如果id=2000050这行数据还没从原表复制到临时表，此时DELETE IGNORE不会匹配到数据；后面执行到分批从原表复制数据到临时表时，包括将id=2000050这行，由于采用的用INSERT LOW_PRIORITY IGNORE INTO，也就不会插入；<br><br>2)如果id=2000050这行数据已经从原表复制到临时表，此时DELETE IGNORE会匹配到数据并删除<br><br>3.继续往后执行</p>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><p>pt-online-schema-change [OPTIONS] DSN</p>
<p>pt-online-schema-change在不阻塞读或写的情况下更改表的结构。在DSN中指定数据库和表。</p>
<p>sakila.actor增加字段：<br><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-online-schema-change --alter <span class="string">"ADD COLUMN c1 INT"</span> <span class="type">D</span>=sakila,t=<span class="class"><span class="keyword">actor</span></span></span><br></pre></td></tr></table></figure></p>
<p>sakila.actor更改存储引擎为InnoDB：<br><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-online-schema-change --alter <span class="string">"ENGINE=InnoDB"</span> <span class="type">D</span>=sakila,t=<span class="class"><span class="keyword">actor</span></span></span><br></pre></td></tr></table></figure></p>
<h2 id="风险"><a href="#风险" class="headerlink" title="风险"></a>风险</h2><p>Percona Toolkit已经成熟，并得到了验证，并经过了充分测试，但所有数据库工具都可能对系统和数据库服务器造成风险，在使用此工具前注意:</p>
<ul>
<li>阅读工具的文档</li>
<li>查看工具已知的bug列表</li>
<li>在非生产服务器上测试</li>
<li>备份生产服务器并验证备份有效性</li>
</ul>
<h2 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h2><ol>
<li>表中无主键或唯一索引，pt-online-schema-change拒绝执行。</li>
<li>复制集群中存在过滤复制，pt-online-schema-change拒绝执行，修改参数为–[no]check-replication-filters</li>
<li>执行过程中检测到从库延迟，暂停数据复制，调节参数为–max-lag</li>
<li>执行过程中检测到负载过高，pt-online-schema-change暂停或中止执行，调节参数为–max-load和–critical-load</li>
<li>不能通过删除一列，然后再新增一列的方式来完成对列的重命名操作。</li>
<li>新增字段，如果这个字段是NOT NULL，必须要指定default值，否则报错，你必须指定默认值。</li>
<li>如果是DROP FOREIGN KEY constraint_name ， 那么必须指定 _ 加上 constraint_name ， 而不是 constraint_name。</li>
<li>默认会设置锁等待超时时间为1s来避免干扰其他事务的进行，调节参数为–lock-wait-timeout。</li>
<li>默认如果检测到外键冲突后会拒绝改表，调节参数为–alter-foreign-keys-method。</li>
<li>该工具不能在PXC（Percona XtraDB Cluster）集群中对myisam表进行改表操作。</li>
</ol>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>–dry-run 和 –execute 互斥,前者为打印,后者为执行</p>
<h3 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h3><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>–alter</td>
<td>通过这个选项，就不需要alter table关键字了，可以通过逗号来指定多个修改操作。<br>例如：ADD COLUMN c1 INT</td>
</tr>
<tr>
<td>–alter-foreign-keys-method</td>
<td>如何把外键引用到新表?需要特殊处理带有外键约束的表,以保证它们可以应用到新表.当重命名表的时候,外键关系会带到重命名后的表上。<br><br>该工具有两种方法,可以自动找到子表,并修改约束关系。<br>auto： 在rebuild_constraints和drop_swap两种处理方式中选择一个。<br>rebuild_constraints：使用 ALTER TABLE语句先删除外键约束,然后再添加.如果子表很大的话,会导致长时间的阻塞。<br>drop_swap： 执行FOREIGN_KEY_CHECKS=0,禁止外键约束,删除原表,再重命名新表。这种方式很快,也不会产生阻塞,但是有风险：<br>  1.在删除原表和重命名新表的短时间内,表是不存在的,程序会返回错误。<br>  2.如果重命名表出现错误,也不能回滚了.因为原表已经被删除。<br>none： 类似”drop_swap”的处理方式,但是它不删除原表,并且外键关系会随着重命名转到老表上面。</td>
</tr>
<tr>
<td>–[no]analyze-before-swap</td>
<td>默认 yes，在新表与旧表完成转换之前对新表执行ANALYZE TABLE操作，默认会在MySQL5.6及之后版本并且开启innodb_stats_persistent的情况下执行。</td>
</tr>
<tr>
<td>–ask-pass</td>
<td>命令行提示密码输入，保护密码安全，前提需安装模块perl-TermReadKey。</td>
</tr>
<tr>
<td>–channel</td>
<td>指定当主从复制环境是多源复制时需要进行同步哪个主库的数据，适用于多源复制中多个主库对应一个从库的情形。</td>
</tr>
<tr>
<td>–charset</td>
<td>指定连接字符集。</td>
</tr>
<tr>
<td>–[no]check-alter</td>
<td>默认 yes，解析变更选项的内容，发出表变更警告，主要警告项为：<br><br>1.字段重命名<br>在工具的早期版本中，通过指定CHANGE COLUMN name new_name进行字段重命名会导致数据库的丢失，现在的版本已经通过代码解决了数据一致性问题。但这段代码并不能保证能够确保数据的不丢失。所以当涉及到字段名变更时应通过添加选项’–dry-run’和’–print’查看变更是否可以正确执行。<br>2.删除主键<br>如果’–alter’选项中包含DROP PRIMARY KEY删除主键的操作，除非指定选项’–dry-run’，否则工具将退出。变更表的主键是十分危险的，工具变更时建立的触发器，尤其是DELETE触发器，是基于主键的，在做主键变更前先添加选项’–dry-run’和’–print’验证触发器是可用的。</td>
</tr>
<tr>
<td>–check-interval</td>
<td>指定出现从库滞后超过max-lag，则该工具将睡眠多长时间，默认1s，再检查。</td>
</tr>
<tr>
<td>–[no]check-plan</td>
<td>默认 yes，检查查询执行计划的安全性。</td>
</tr>
<tr>
<td>–[no]check-replication-filters</td>
<td>默认 yes，如果工具检测到服务器选项中有任何复制相关的筛选，如指定 binlog_ignore_db 和 replicate_do_db 此类。发现有这样的筛选，工具会报错且退出。因为如果更新的表 Master 上存在，而 Slave 上不存在，会导致复制的失败。使用–no-check-replication-filters 选项来禁用该检查。</td>
</tr>
<tr>
<td>–check-slave-lag</td>
<td>指定一个从库的 DSN 连接地址，如果从库超过 –max-lag 参数设置的值，就会暂停操作。</td>
</tr>
<tr>
<td>–chunk-index</td>
<td>指定使用哪个索引对表进行chunk分块操作。默认情况下会选择最优的索引，工具会在SQL语句中添加FORCE INDEX子句。</td>
</tr>
<tr>
<td>–chunk-index-columns</td>
<td>指定使用选项’–chunk-index’的索引使用最左前缀几个索引字段，只适用于复合索引。</td>
</tr>
<tr>
<td>–chunk-size</td>
<td>指定表分块的chunk大小，每个chunk对应的表行数，默认是 1000 行，也可以是数据块大小，当指定大小时允许的后缀单位为k、M、G。这个块的大小要尽量与 –chunk-time 匹配，如果明确指定这个选项，那么每个块就会指定行数的大小。<font color="FF0000">如果块索引不是唯一的，那么块可能会比期望的大</font></td>
</tr>
<tr>
<td>–chunk-size-limit</td>
<td>当需要复制的块远大于设置的 chunk-size 大小，就不复制。默认值是 4.0，一个没有主键或唯一索引的表，块大小就是不确定的。</td>
</tr>
<tr>
<td>–chunk-time</td>
<td>在 chunk-time 执行的时间内，动态调整 chunk-size 的大小，以适应服务器性能的变化，该参数设置为 0, 或者指定 chunk-size, 都可以禁止动态调整。</td>
</tr>
<tr>
<td>–config</td>
<td>读取以逗号分隔的配置文件列表，如果指定，则必须要在命令行的第一个选项位置</td>
</tr>
<tr>
<td>–critical-load</td>
<td>默认为 Threads_running=50。用法基本与 –max-load 类似，如果不指定 MAX_VALUE，那么工具会这只其为当前值的 200%。如果超过指定值，则工具直接退出，而不是暂停。</td>
</tr>
<tr>
<td>–database</td>
<td>指定连接的数据库，如有多个则用’,’(逗号)隔开。</td>
</tr>
<tr>
<td>–default-engine</td>
<td>默认情况下，新的表与原始表是相同的存储引擎，所以如果原来的表使用 InnoDB 的，那么新表将使用 InnoDB 的。在涉及复制某些情况下，很可能主从的存储引擎不一样。使用该选项会默认使用默认的存储引擎。</td>
</tr>
<tr>
<td>–data-dir</td>
<td>使用DATA DIRECTORY特性在不同的分区上创建新表。只能在5.6以上版本中使用。如果与remove-data-dir同时使用，则忽略此参数。</td>
</tr>
<tr>
<td>–remove-data-dir</td>
<td>如果原始表是使用DATA DIRECTORY特性创建的，那么删除它并在MySQL默认目录中创建新表，而不创建新的isl文件。</td>
</tr>
<tr>
<td>–defaults-file</td>
<td>读取配置文件。</td>
</tr>
<tr>
<td>–[no]drop-new-table</td>
<td>默认 yes。如果拷贝旧表数据到新表时失败，则删除新表。如果指定选项’–no-drop-new-table’以及’–no-swap-tables’将保留一份变更后的副本，但不会对旧表进行修改。-no-drop-new-table不能用于修改-foreign-key -method drop_swap。</td>
</tr>
<tr>
<td>–[no]drop-old-table</td>
<td>默认 yes。复制数据完成重命名之后，删除原表，如果有错误则会保留原表，指定选项’–no-swap-tables’同样不会删除旧表。</td>
</tr>
<tr>
<td>–[no]drop-trigger</td>
<td>默认 yes，删除原表上的触发器。 –no-drop-triggers 会强制开启 –no-drop-old-table 即：不删除触发器就会强制不删除原表。</td>
</tr>
<tr>
<td>–dry-run</td>
<td>创建和修改新表，但不会创建触发器、复制数据、和替换原表。并不真正执行，可以看到生成的执行语句，了解其执行步骤与细节。–dry-run 与 –execute 必须指定一个，二者相互排斥。和 –print 配合最佳。</td>
</tr>
<tr>
<td>–execute</td>
<td>确定修改表，则指定该参数。真正执行。–dry-run 与 –execute 必须指定一个，二者相互排斥。</td>
</tr>
<tr>
<td>–[no]check-unique-key-change</td>
<td>默认值：yes，当工具要进行添加唯一索引的变更时停止运行。因为工具使用语句INSERT IGNORE从旧表进行数据拷贝插入新表，如果插入的值违返唯一性约束，数据插入不会明确提示失败但这样会造成数据丢失。</td>
</tr>
<tr>
<td>–force</td>
<td>强制运行，可能打破外键约束。</td>
</tr>
<tr>
<td>–help</td>
<td>打印帮助。</td>
</tr>
<tr>
<td>–host</td>
<td>连接的host。</td>
</tr>
<tr>
<td>–max-flow-ctl</td>
<td>类似-max-lag，适用于PXC集群。检查用于流控制的平均暂停时间集群，如果超过选项中指定的百分比，则使工具暂停。当检测到任何流控制活动时，值0将使工具暂停。默认情况下没有流控制检查。此选项适用于PXC版本5.6或更高版本。</td>
</tr>
<tr>
<td>–max-lag</td>
<td>默认 1s。每个 chunk 拷贝完成后，会查看所有复制 Slave 的延迟情况。要是延迟大于该值，则暂停复制数据，直到所有从的滞后小于这个值，使用 Seconds_Behind_Master。如果有任何从滞后超过此选项的值，则该工具将睡眠 –check-interval 指定的时间，再检查。如果从被停止，将会永远等待，直到从开始同步，并且延迟小于该值。如果指定 –check-slave-lag，该工具只检查该服务器的延迟，而不是所有服务器。</td>
</tr>
<tr>
<td>–max-load</td>
<td>默认为 Threads_running=25。每个 chunk 拷贝完后，会检查 SHOW GLOBAL STATUS 的内容，检查指标是否超过了tatus 指标 =MAX_VALUE 或者 status 指标：MAX_VALUE。如果不指定 MAX_VALUE，那么工具会这只其为当前值的 120%。</td>
</tr>
<tr>
<td>–preserve-triggers</td>
<td>指定保留旧表的触发器。从MySQL5.7.2起开始支持在同一张给定的表上定义具有相同触发事件和触发时间的多个触发器。这意味着如果表原来已有触发器，那么工具所需的触发器也可以创建成功。如果指定了该选项，则工具将旧表上所有的触发器复制到新表上，然后再进行表数据行的拷贝操作。<br><br>限制：<br>1.如果旧表上的触发器引用了将被工具删除的字段，则触发器失效；<br>2.该选项不能与选项’–no-drop-triggers’、’–no-drop-old-table’和’–no-swap-tables’一起使用，因为该选项需要删除旧表的触发器并在新表上重新创建，因为表不可能有多个同名的触发器。</td>
</tr>
<tr>
<td>–new-table-name</td>
<td>复制创建新表的名称，默认 %T_new。</td>
</tr>
<tr>
<td>–null-to-not-null</td>
<td>指定可以将允许NULL的字段转换为NOT NULL字段。其中如有包含NULL行的字段值转换为字段默认值，如果没有字段值，则根字段类型来分配默认值。如：字符串类型为’’(空字符串)，数值类型为0。</td>
</tr>
<tr>
<td>–only-same-schema-fks</td>
<td>仅在与原始表相同模式的表上检查外键。 此选项很危险，因为如果您有FL引用其他架构中的表，则不会检测到它们。</td>
</tr>
<tr>
<td>–password</td>
<td>连接的密码。</td>
</tr>
<tr>
<td>–pause-file</td>
<td>当此参数指定的文件存在时，执行将暂停。</td>
</tr>
<tr>
<td>–pid</td>
<td>创建给定的PID文件。 如果PID文件已经存在并且包含的PID与当前的PID不同，则该工具将无法启动。但是，如果存在PID文件，并且其中包含的PID不再运行，则该工具将使用当前PID覆盖PID文件。 工具退出后，PID文件将自动删除。</td>
</tr>
<tr>
<td>–plugin</td>
<td>定义”pt_online_schema_change_plugin”类的Perl模块文件。 使用插件，您可以编写一个Perl模块，该模块可以连接到pt-online-schema-change的许多部分。 这需要对Perl和Percona Toolkit约定的充分了解，而这些约定不在本文档的讨论范围之内。 如有疑问或需要帮助，请联系Percona。</td>
</tr>
<tr>
<td>–port</td>
<td>连接的端口。</td>
</tr>
<tr>
<td>–print</td>
<td>打印 SQL 语句到标准输出。指定此选项可以让你看到该工具所执行的语句，和 –dry-run 配合最佳。</td>
</tr>
<tr>
<td>–progress</td>
<td>复制数据的时候打印进度报告，二部分组成：第一部分是百分比，第二部分是时间。</td>
</tr>
<tr>
<td>–quiet</td>
<td>-q，不把信息标准输出。</td>
</tr>
<tr>
<td>–recurse</td>
<td>指定搜寻从库的层级，默认无限级。</td>
</tr>
<tr>
<td>–recursion-method</td>
<td>默认是 show processlist，发现从的方法，也可以是 host，但需要在从上指定 report_host，通过 show slave hosts 来找到，可以指定 none 来不检查 Slave。<br><br>METHOD       USES<br>=====  ========<br>processlist  SHOW PROCESSLIST<br>hosts        SHOW SLAVE HOSTS<br>dsn=DSN      DSNs from a table<br>none         Do not find slaves<br>指定 none 则表示不在乎从的延迟。</td>
</tr>
<tr>
<td>–skip-check-slave-lag</td>
<td>检查SLAVE的时候，指定该SLAVE跳过。</td>
</tr>
<tr>
<td>–slave-user</td>
<td>设置用于连接到从库的用户。</td>
</tr>
<tr>
<td>–slave-password</td>
<td>设置用于连接到从库的密码。</td>
</tr>
<tr>
<td>–set-vars</td>
<td>默认：<br>wait_timeout=10000<br>innodb_lock_wait_timeout=1<br>lock_wait_timeout=60<br>运行检查时指定参数值，如有多个用’,’(逗号)分隔。如’–set-vars wait_timeout=500’。</td>
</tr>
<tr>
<td>–sleep</td>
<td>默认值：0s，每个chunk导入后与下一次chunk导入开始前sleep一会，sleep时间越长，对于磁盘IO的冲击就越小。</td>
</tr>
<tr>
<td>–socket</td>
<td>连接实例的socket。</td>
</tr>
<tr>
<td>–statistics</td>
<td>打印出内部事件的数目，可以看到复制数据插入的数目。</td>
</tr>
<tr>
<td>–[no]swap-tables</td>
<td>默认 yes。交换原始表和新表，除非你禁止 –[no]drop-old-table。</td>
</tr>
<tr>
<td>–tries</td>
<td>尝试几次关键操作。 如果某些操作由于非致命的可恢复错误而失败，则该工具将等待并再次尝试该操作。<br>这些是重试的操作，其默认尝试次数和两次尝试之间的等待时间（以秒为单位）：<br><br>OPERATION            TRIES   WAIT<br>=======  ====   ====<br>create_triggers         10      1<br>drop_triggers           10      1<br>copy_rows               10   0.25<br>swap_tables             10      1<br>update_foreign_keys     10      1<br>analyze_table           10      1<br><br>要更改默认值，请指定新值，例如：–tries create_triggers:5:0.5,drop_triggers:5:0.5</td>
</tr>
<tr>
<td>–user</td>
<td>连接的用户。</td>
</tr>
<tr>
<td>–version</td>
<td>打印版本信息。</td>
</tr>
<tr>
<td>–[no]version-check</td>
<td>默认值：yes，检查Percona Toolkit、MySQL和其他程序的最新版本。</td>
</tr>
</tbody>
</table>
<h3 id="DSN选项"><a href="#DSN选项" class="headerlink" title="DSN选项"></a>DSN选项</h3><p>这些选项选用于创建DSN,每个选项都给出了option=value,选项区分大小写</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>dsn: charset; copy: yes 默认字符集</td>
</tr>
<tr>
<td>D</td>
<td>dsn: database; copy: yes 默认数据库</td>
</tr>
<tr>
<td>F</td>
<td>dsn: mysql_read_default_file; copy: yes 仅从指定文件读取参数</td>
</tr>
<tr>
<td>h</td>
<td>dsn: host; copy: yes 连接的host</td>
</tr>
<tr>
<td>p</td>
<td>dsn: password; copy: yes 连接的密码</td>
</tr>
<tr>
<td>P</td>
<td>dsn: port; copy: yes 连接的端口</td>
</tr>
<tr>
<td>S</td>
<td>dsn: mysql_socket; copy: yes 连接的socket</td>
</tr>
<tr>
<td>u</td>
<td>dsn: user; copy: yes 连接的用户</td>
</tr>
<tr>
<td>t</td>
<td>记录操作的表,通过–log-dsn指定</td>
</tr>
</tbody>
</table>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="创建测试表"><a href="#创建测试表" class="headerlink" title="创建测试表"></a>创建测试表</h3><p>通过存储过程，在test库下创建employee1表<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">DROP <span class="function"><span class="keyword">PROCEDURE</span> <span class="title">IF</span> <span class="title">EXISTS</span> <span class="title">my_test1</span>$$</span></span><br><span class="line"><span class="function"><span class="title">CREATE</span> <span class="title">PROCEDURE</span> <span class="title">my_test1</span><span class="params">(<span class="keyword">IN</span> loop_times INT)</span></span></span><br><span class="line"><span class="function"><span class="title">BEGIN</span></span></span><br><span class="line"><span class="function"><span class="title">DECLARE</span> <span class="title">var</span> <span class="title">INT</span> <span class="title">DEFAULT</span> 0;</span></span><br><span class="line"></span><br><span class="line">PREPARE MSQL <span class="keyword">FROM</span> <span class="string">'CREATE TABLE IF NOT EXISTS `employee1` (`id` int(10) unsigned NOT NULL AUTO_INCREMENT,`employeeid` int(10) unsigned NOT NULL COMMENT ''0'',`employeename` varchar(64) NOT NULL DEFAULT '''',PRIMARY KEY (`id`)) ENGINE=InnoDB'</span>;</span><br><span class="line">EXECUTE MSQL;</span><br><span class="line"></span><br><span class="line">START TRANSACTION;</span><br><span class="line"><span class="keyword">WHILE</span> <span class="keyword">var</span>&lt;loop_times <span class="keyword">DO</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">var</span>=<span class="keyword">var</span>+<span class="number">1</span>;</span><br><span class="line">INSERT <span class="keyword">INTO</span> employee1 (employeeid,employeename) VALUES (<span class="keyword">var</span>,<span class="keyword">CONCAT</span>(<span class="string">'test'</span>,<span class="keyword">var</span>));</span><br><span class="line"> </span><br><span class="line"><span class="keyword">END</span> <span class="keyword">WHILE</span>;</span><br><span class="line">COMMIT;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure></p>
<h3 id="查看表信息及创建过程"><a href="#查看表信息及创建过程" class="headerlink" title="查看表信息及创建过程"></a>查看表信息及创建过程</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">10:20:39</span>]&gt; CREATE PROCEDURE my<span class="emphasis">_test1(IN loop_</span>times INT)</span><br><span class="line"><span class="code">    -&gt; BEGIN</span></span><br><span class="line"><span class="code">    -&gt; DECLARE var INT DEFAULT 0;</span></span><br><span class="line"><span class="code">    -&gt; </span></span><br><span class="line"><span class="code">    -&gt; PREPARE MSQL FROM 'CREATE TABLE IF NOT EXISTS `employee1` (`id` int(10) unsigned NOT NULL AUTO_INCREMENT,`employeeid` int(10) unsigned NOT NULL COMMENT ''0'',`employeename` varchar(64) NOT NULL DEFAULT '''',PRIMARY KEY (`id`)) ENGINE=InnoDB';</span></span><br><span class="line"><span class="code">    -&gt; EXECUTE MSQL;</span></span><br><span class="line"><span class="code">    -&gt; </span></span><br><span class="line"><span class="code">    -&gt; START TRANSACTION;</span></span><br><span class="line"><span class="code">    -&gt; WHILE var&lt;loop_times DO</span></span><br><span class="line"><span class="code">    -&gt; SET var=var+1;</span></span><br><span class="line"><span class="code">    -&gt; INSERT INTO employee1 (employeeid,employeename) VALUES (var,CONCAT('test',var));</span></span><br><span class="line"><span class="code">    -&gt;  </span></span><br><span class="line"><span class="code">    -&gt; END WHILE;</span></span><br><span class="line"><span class="code">    -&gt; COMMIT;</span></span><br><span class="line"><span class="code">    -&gt; END$$</span></span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">10:20:39</span>]&gt; DELIMITER ;</span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">10:20:39</span>]&gt; </span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">10:20:43</span>]&gt; CALL my_test1(10000);</span><br><span class="line">Query OK, 0 rows affected (0.93 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">10:20:59</span>]&gt; select * from employee1 limit 10;</span><br><span class="line">+----+------------+--------------+</span><br><span class="line">| id | employeeid | employeename |</span><br><span class="line">+----+------------+--------------+</span><br><span class="line">|  1 |          1 | test1        |</span><br><span class="line">|  2 |          2 | test2        |</span><br><span class="line">|  3 |          3 | test3        |</span><br><span class="line">|  4 |          4 | test4        |</span><br><span class="line">|  5 |          5 | test5        |</span><br><span class="line">|  6 |          6 | test6        |</span><br><span class="line">|  7 |          7 | test7        |</span><br><span class="line">|  8 |          8 | test8        |</span><br><span class="line">|  9 |          9 | test9        |</span><br><span class="line">| 10 |         10 | test10       |</span><br><span class="line">+----+------------+--------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">10:21:08</span>]&gt; show create table employee1\G</span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line"><span class="code">       Table: employee1</span></span><br><span class="line">Create Table: CREATE TABLE <span class="code">`employee1`</span> (</span><br><span class="line">  <span class="code">`id`</span> int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  <span class="code">`employeeid`</span> int(10) unsigned NOT NULL COMMENT '0',</span><br><span class="line">  <span class="code">`employeename`</span> varchar(64) NOT NULL DEFAULT '',</span><br><span class="line">  PRIMARY KEY (<span class="code">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO<span class="emphasis">_INCREMENT=10001 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_</span>0900<span class="emphasis">_ai_</span>ci</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="添加字段"><a href="#添加字段" class="headerlink" title="添加字段"></a>添加字段</h3><p>添加字段语句：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-online-schema-change <span class="attribute">--user</span>=root  <span class="attribute">--password</span>=111111 <span class="attribute">--socket</span>=/opt/mysql3306/data/mysql.sock  <span class="attribute">D</span>=test,t=employee1 --alter <span class="string">"ADD COLUMN update_time datetime  DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间';"</span>  <span class="attribute">--recursion-method</span>=none --no-check-replication-filters --alter-foreign-keys-method auto --<span class="builtin-name">print</span> --execute <span class="attribute">--critical-load</span>=<span class="string">"Threads_running:200"</span> <span class="attribute">--charset</span>=utf8mb4</span><br></pre></td></tr></table></figure></p>
<p>执行过程：<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_101_centos ~]# pt-online-schema-change --user=root  --password=111111 --socket=/opt/mysql3306/data/mysql.sock  D=test,t=employee1 --alter "ADD COLUMN update_time datetime  DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间';"  --recursion-method=none --no-check-replication-filters --alter-foreign-keys-method auto --print --execute --critical-load="Threads_running:200" --charset=utf8mb4</span><br><span class="line">No slaves found.  See --recursion-method if host VM_24_101_centos has slaves.</span><br><span class="line">Not checking slave lag because no slaves were found and --check-slave-lag was not specified.</span><br><span class="line">Operation, tries, wait:</span><br><span class="line">  analyze_table, 10, <span class="number">1</span></span><br><span class="line">  copy_rows, <span class="number">10</span>, <span class="number">0.25</span></span><br><span class="line">  create_triggers, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  drop_triggers, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  swap_tables, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  update_foreign_keys, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">No foreign <span class="keyword">keys</span> reference <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>; ignoring --alter-foreign-keys-method.</span><br><span class="line">Altering `test`.`employee1`...</span><br><span class="line">Creating new table...</span><br><span class="line"><span class="keyword">CREATE</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> (</span><br><span class="line">  <span class="symbol">`id`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="symbol">`employeeid`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'0'</span>,</span><br><span class="line">  <span class="symbol">`employeename`</span> varchar(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">10001</span> DEFAULT CHARSET=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br><span class="line">Created new table test._employee1_new OK.</span><br><span class="line">Altering new table...</span><br><span class="line"><span class="keyword">ALTER</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> ADD COLUMN update_time datetime  DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">'更新时间'</span>;</span><br><span class="line">Altered `test`.`_employee1_new` OK.</span><br><span class="line">2018-09-21T10:33:08 Creating triggers...</span><br><span class="line">2018-09-21T10:33:08 Created triggers OK.</span><br><span class="line">2018-09-21T10:33:08 Copying approximately 10000 rows...</span><br><span class="line"><span class="keyword">INSERT</span> LOW_PRIORITY <span class="keyword">IGNORE</span> <span class="keyword">INTO</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> (<span class="symbol">`id`</span>, <span class="symbol">`employeeid`</span>, <span class="symbol">`employeename`</span>) <span class="keyword">SELECT</span> <span class="symbol">`id`</span>, <span class="symbol">`employeeid`</span>, <span class="symbol">`employeename`</span> <span class="keyword">FROM</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="symbol">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="symbol">`id`</span> &gt;= ?)) <span class="keyword">AND</span> ((<span class="symbol">`id`</span> &lt;= ?)) LOCK <span class="keyword">IN</span> SHARE MODE <span class="comment">/*pt-online-schema-change 10925 copy nibble*/</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="symbol">`id`</span> <span class="keyword">FROM</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="symbol">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="symbol">`id`</span> &gt;= ?)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="symbol">`id`</span> <span class="keyword">LIMIT</span> ?, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Copied rows OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Analyzing new table...</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Swapping tables...</span><br><span class="line"><span class="keyword">RENAME</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">TO</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span>, <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> <span class="keyword">TO</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Swapped original <span class="keyword">and</span> new tables OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Dropping old table...</span><br><span class="line"><span class="keyword">DROP</span> TABLE <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Dropped old table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span> OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Dropping triggers...</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_del`</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_upd`</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_ins`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Dropped triggers OK.</span><br><span class="line">Successfully altered <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>.</span><br><span class="line">[root@VM_24_101_centos ~]# mysql test -<span class="built_in">e</span> <span class="string">"show create table employee1\G"</span></span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a <span class="keyword">password</span> <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       Table: employee1</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE <span class="symbol">`employee1`</span> (</span><br><span class="line">  <span class="symbol">`id`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="symbol">`employeeid`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'0'</span>,</span><br><span class="line">  <span class="symbol">`employeename`</span> varchar(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>,</span><br><span class="line">  <span class="symbol">`update_time`</span> datetime DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">'更新时间'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">10001</span> DEFAULT CHARSET=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br><span class="line">[root@VM_24_101_centos ~]# mysql test -<span class="built_in">e</span> <span class="string">"select * from employee1 limit 10"</span></span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a <span class="keyword">password</span> <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">+----+------------+--------------+---------------------+</span><br><span class="line">| id | employeeid | employeename | update_time         |</span><br><span class="line">+----+------------+--------------+---------------------+</span><br><span class="line">|  <span class="number">1</span> |          <span class="number">1</span> | test1        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">2</span> |          <span class="number">2</span> | test2        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">3</span> |          <span class="number">3</span> | test3        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">4</span> |          <span class="number">4</span> | test4        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">5</span> |          <span class="number">5</span> | test5        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">6</span> |          <span class="number">6</span> | test6        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">7</span> |          <span class="number">7</span> | test7        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">8</span> |          <span class="number">8</span> | test8        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">9</span> |          <span class="number">9</span> | test9        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">| <span class="number">10</span> |         <span class="number">10</span> | test10       | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">+----+------------+--------------+---------------------+</span><br><span class="line">[root@VM_24_101_centos ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="删除字段"><a href="#删除字段" class="headerlink" title="删除字段"></a>删除字段</h3><p>删除字段语句：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-online-schema-change <span class="attribute">--user</span>=root  <span class="attribute">--password</span>=111111 <span class="attribute">--socket</span>=/opt/mysql3306/data/mysql.sock  <span class="attribute">D</span>=test,t=employee1 --alter <span class="string">"DROP COLUMN update_time;"</span>  <span class="attribute">--recursion-method</span>=none --no-check-replication-filters --alter-foreign-keys-method auto --<span class="builtin-name">print</span> --execute <span class="attribute">--critical-load</span>=<span class="string">"Threads_running:200"</span></span><br></pre></td></tr></table></figure></p>
<p>执行过程：<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_101_centos ~]# pt-online-schema-change --user=root  --password=111111 --socket=/opt/mysql3306/data/mysql.sock  D=test,t=employee1 --alter "<span class="keyword">DROP</span> COLUMN update_time;"  --recursion-method=none --no-check-replication-filters --alter-foreign-keys-method auto --print --execute --critical-load="Threads_running:200" </span><br><span class="line">No slaves found.  See --recursion-method if host VM_24_101_centos has slaves.</span><br><span class="line">Not checking slave lag because no slaves were found and --check-slave-lag was not specified.</span><br><span class="line">Operation, tries, wait:</span><br><span class="line">  analyze_table, 10, <span class="number">1</span></span><br><span class="line">  copy_rows, <span class="number">10</span>, <span class="number">0.25</span></span><br><span class="line">  create_triggers, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  drop_triggers, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  swap_tables, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  update_foreign_keys, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">No foreign <span class="keyword">keys</span> reference <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>; ignoring --alter-foreign-keys-method.</span><br><span class="line">Altering `test`.`employee1`...</span><br><span class="line">Creating new table...</span><br><span class="line"><span class="keyword">CREATE</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> (</span><br><span class="line">  <span class="symbol">`id`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="symbol">`employeeid`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'0'</span>,</span><br><span class="line">  <span class="symbol">`employeename`</span> varchar(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>,</span><br><span class="line">  <span class="symbol">`update_time`</span> datetime DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">'????'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">10001</span> DEFAULT CHARSET=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br><span class="line">Created new table test._employee1_new OK.</span><br><span class="line">Altering new table...</span><br><span class="line"><span class="keyword">ALTER</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> <span class="keyword">DROP</span> COLUMN update_time;</span><br><span class="line">Altered `test`.`_employee1_new` OK.</span><br><span class="line">2018-09-21T10:36:47 Creating triggers...</span><br><span class="line">2018-09-21T10:36:47 Created triggers OK.</span><br><span class="line">2018-09-21T10:36:47 Copying approximately 10000 rows...</span><br><span class="line"><span class="keyword">INSERT</span> LOW_PRIORITY <span class="keyword">IGNORE</span> <span class="keyword">INTO</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> (<span class="symbol">`id`</span>, <span class="symbol">`employeeid`</span>, <span class="symbol">`employeename`</span>) <span class="keyword">SELECT</span> <span class="symbol">`id`</span>, <span class="symbol">`employeeid`</span>, <span class="symbol">`employeename`</span> <span class="keyword">FROM</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="symbol">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="symbol">`id`</span> &gt;= ?)) <span class="keyword">AND</span> ((<span class="symbol">`id`</span> &lt;= ?)) LOCK <span class="keyword">IN</span> SHARE MODE <span class="comment">/*pt-online-schema-change 11401 copy nibble*/</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="symbol">`id`</span> <span class="keyword">FROM</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="symbol">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="symbol">`id`</span> &gt;= ?)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="symbol">`id`</span> <span class="keyword">LIMIT</span> ?, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Copied rows OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Analyzing new table...</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Swapping tables...</span><br><span class="line"><span class="keyword">RENAME</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">TO</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span>, <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> <span class="keyword">TO</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Swapped original <span class="keyword">and</span> new tables OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Dropping old table...</span><br><span class="line"><span class="keyword">DROP</span> TABLE <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Dropped old table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span> OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Dropping triggers...</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_del`</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_upd`</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_ins`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Dropped triggers OK.</span><br><span class="line">Successfully altered <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>.</span><br><span class="line">[root@VM_24_101_centos ~]# mysql test -<span class="built_in">e</span> <span class="string">"show create table employee1\G"</span></span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a <span class="keyword">password</span> <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       Table: employee1</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE <span class="symbol">`employee1`</span> (</span><br><span class="line">  <span class="symbol">`id`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="symbol">`employeeid`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'0'</span>,</span><br><span class="line">  <span class="symbol">`employeename`</span> varchar(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">10001</span> DEFAULT CHARSET=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br><span class="line">[root@VM_24_101_centos ~]#</span><br></pre></td></tr></table></figure></p>
<p>此时，需要将–charset=utf8mb4删除，不然会报错：<font color="FF0000">Error creating new table: Wide character in print at /bin/pt-online-schema-change line 10510. </font></p>
<h3 id="改变字段属性"><a href="#改变字段属性" class="headerlink" title="改变字段属性"></a>改变字段属性</h3><p>改变字段属性的语句：<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_101_centos ~]# pt-online-schema-change --user=root  --password=111111 --socket=/opt/mysql3306/data/mysql.sock  D=test,t=employee1 --alter "MODIFY employeename varchar(300) NOT NULL DEFAULT '';"  --recursion-method=none --no-check-replication-filters --alter-foreign-keys-method auto --print --execute --critical-load="Threads_running:200" --charset=utf8mb4 </span><br><span class="line">No slaves found.  See --recursion-method if host VM_24_101_centos has slaves.</span><br><span class="line">Not checking slave lag because no slaves were found and --check-slave-lag was not specified.</span><br><span class="line">Operation, tries, wait:</span><br><span class="line">  analyze_table, 10, <span class="number">1</span></span><br><span class="line">  copy_rows, <span class="number">10</span>, <span class="number">0.25</span></span><br><span class="line">  create_triggers, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  drop_triggers, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  swap_tables, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  update_foreign_keys, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">No foreign <span class="keyword">keys</span> reference <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>; ignoring --alter-foreign-keys-method.</span><br><span class="line">Altering `test`.`employee1`...</span><br><span class="line">Creating new table...</span><br><span class="line"><span class="keyword">CREATE</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> (</span><br><span class="line">  <span class="symbol">`id`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="symbol">`employeeid`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'0'</span>,</span><br><span class="line">  <span class="symbol">`employeename`</span> varchar(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">10001</span> DEFAULT CHARSET=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br><span class="line">Created new table test._employee1_new OK.</span><br><span class="line">Altering new table...</span><br><span class="line"><span class="keyword">ALTER</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> MODIFY employeename varchar(<span class="number">300</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>;</span><br><span class="line">Altered `test`.`_employee1_new` OK.</span><br><span class="line">2018-09-21T10:45:34 Creating triggers...</span><br><span class="line">2018-09-21T10:45:34 Created triggers OK.</span><br><span class="line">2018-09-21T10:45:34 Copying approximately 10000 rows...</span><br><span class="line"><span class="keyword">INSERT</span> LOW_PRIORITY <span class="keyword">IGNORE</span> <span class="keyword">INTO</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> (<span class="symbol">`id`</span>, <span class="symbol">`employeeid`</span>, <span class="symbol">`employeename`</span>) <span class="keyword">SELECT</span> <span class="symbol">`id`</span>, <span class="symbol">`employeeid`</span>, <span class="symbol">`employeename`</span> <span class="keyword">FROM</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="symbol">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="symbol">`id`</span> &gt;= ?)) <span class="keyword">AND</span> ((<span class="symbol">`id`</span> &lt;= ?)) LOCK <span class="keyword">IN</span> SHARE MODE <span class="comment">/*pt-online-schema-change 12515 copy nibble*/</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="symbol">`id`</span> <span class="keyword">FROM</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="symbol">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="symbol">`id`</span> &gt;= ?)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="symbol">`id`</span> <span class="keyword">LIMIT</span> ?, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Copied rows OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Analyzing new table...</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Swapping tables...</span><br><span class="line"><span class="keyword">RENAME</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">TO</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span>, <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> <span class="keyword">TO</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Swapped original <span class="keyword">and</span> new tables OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Dropping old table...</span><br><span class="line"><span class="keyword">DROP</span> TABLE <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Dropped old table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span> OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Dropping triggers...</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_del`</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_upd`</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_ins`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Dropped triggers OK.</span><br><span class="line">Successfully altered <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>.</span><br><span class="line">[root@VM_24_101_centos ~]# mysql test -<span class="built_in">e</span> <span class="string">"show create table employee1\G"</span></span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a <span class="keyword">password</span> <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       Table: employee1</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE <span class="symbol">`employee1`</span> (</span><br><span class="line">  <span class="symbol">`id`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="symbol">`employeeid`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'0'</span>,</span><br><span class="line">  <span class="symbol">`employeename`</span> varchar(<span class="number">300</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">10001</span> DEFAULT CHARSET=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br></pre></td></tr></table></figure></p>
<h3 id="非分区表改为分区表"><a href="#非分区表改为分区表" class="headerlink" title="非分区表改为分区表"></a>非分区表改为分区表</h3><p>1.将原表的id自增改为非自增，使用mysql online ddl，不锁表的方式<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql test -e "<span class="keyword">alter</span> <span class="keyword">table</span> employee1 <span class="keyword">modify</span> <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,algorithm=inplace,<span class="keyword">lock</span>=<span class="keyword">none</span>;"</span><br></pre></td></tr></table></figure></p>
<p>2.删除分区字段内的空值，省略</p>
<p>3.删除原主键，添加联合主键<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql test -e "<span class="keyword">alter</span> <span class="keyword">table</span> employee1 <span class="keyword">drop</span> primary <span class="keyword">key</span>,<span class="keyword">ADD</span> PRIMARY <span class="keyword">KEY</span> (update_time,<span class="keyword">id</span>),algorithm=inplace,<span class="keyword">lock</span>=<span class="keyword">none</span>;"</span><br></pre></td></tr></table></figure></p>
<p>4.使用pt-online-schema-change建分区<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-online-schema-change <span class="attribute">--user</span>=root  <span class="attribute">--password</span>=111111 <span class="attribute">--socket</span>=/opt/mysql3306/data/mysql.sock  <span class="attribute">D</span>=test,t=employee1 --alter <span class="string">"partition by RANGE COLUMNS (update_time)(PARTITION P202003 VALUES LESS THAN ('2020-04-01'),PARTITION P202004 VALUES LESS THAN ('2020-05-01'),PARTITION P202005 VALUES LESS THAN ('2020-06-01'), PARTITION PMAX VALUES LESS THAN  MAXVALUE  ) "</span>  <span class="attribute">--recursion-method</span>=none --no-check-replication-filters --alter-foreign-keys-method auto --<span class="builtin-name">print</span> --execute <span class="attribute">--critical-load</span>=<span class="string">"Threads_running:200"</span></span><br></pre></td></tr></table></figure></p>
<p>5.以下为执行日志：<br><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_101_centos ~]# mysql test -e <span class="string">"alter table employee1 modify id int(10) unsigned NOT NULL,algorithm=inplace,lock=none;"</span></span><br><span class="line"><span class="symbol">mysql:</span> [Warning] Using <span class="literal">a</span> password on the command line interface can be insecure.</span><br><span class="line">[root@VM_24_101_centos ~]# mysql test -e <span class="string">"alter table employee1 drop primary key,ADD PRIMARY KEY (update_time,id),algorithm=inplace,lock=none;"</span></span><br><span class="line"><span class="symbol">mysql:</span> [Warning] Using <span class="literal">a</span> password on the command line interface can be insecure.</span><br><span class="line">[root@VM_24_101_centos ~]# mysql test -e <span class="string">"show create table employee1\G"</span></span><br><span class="line"><span class="symbol">mysql:</span> [Warning] Using <span class="literal">a</span> password on the command line interface can be insecure.</span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line"><span class="symbol">       Table:</span> employee1</span><br><span class="line"><span class="symbol">Create Table:</span> CREATE TABLE `employee1` (</span><br><span class="line">  `id` int(<span class="number">10</span>) unsigned <span class="literal">NOT</span> NULL,</span><br><span class="line">  `employeeid` int(<span class="number">10</span>) unsigned <span class="literal">NOT</span> NULL COMMENT '<span class="number">0</span>',</span><br><span class="line">  `employeename` varchar(<span class="number">300</span>) <span class="literal">NOT</span> NULL DEFAULT '',</span><br><span class="line">  `update_time` datetime <span class="literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',</span><br><span class="line">  PRIMARY KEY (`update_time`,`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci</span><br><span class="line">[root@VM_24_101_centos ~]# pt-online-schema-change --user=root  --password=<span class="number">111111</span> --socket=/opt/mysql3306/data/mysql.sock  D=test,t=employee1 --alter <span class="string">"partition by RANGE COLUMNS (update_time)(PARTITION P202003 VALUES LESS THAN ('2020-04-01'),PARTITION P202004 VALUES LESS THAN ('2020-05-01'),PARTITION P202005 VALUES LESS THAN ('2020-06-01'), PARTITION PMAX VALUES LESS THAN  MAXVALUE  ) "</span>  --recursion-method=none --no-check-replication-filters --alter-foreign-keys-method auto --print --execute --<span class="keyword">critical</span>-load=<span class="string">"Threads_running:200"</span> --charset=utf8mb4</span><br><span class="line">No slaves found.  See --recursion-method if host VM_24_101_centos has slaves.</span><br><span class="line"><span class="literal">Not</span> checking slave lag because no slaves were found <span class="literal">and</span> --check-slave-lag was <span class="literal">not</span> specified.</span><br><span class="line"><span class="built_in">Operation,</span> tries, wait:</span><br><span class="line"><span class="built_in">  analyze_table,</span> <span class="number">10</span>, <span class="number">1</span></span><br><span class="line"><span class="built_in">  copy_rows,</span> <span class="number">10</span>, <span class="number">0.25</span></span><br><span class="line"><span class="built_in">  create_triggers,</span> <span class="number">10</span>, <span class="number">1</span></span><br><span class="line"><span class="built_in">  drop_triggers,</span> <span class="number">10</span>, <span class="number">1</span></span><br><span class="line"><span class="built_in">  swap_tables,</span> <span class="number">10</span>, <span class="number">1</span></span><br><span class="line"><span class="built_in">  update_foreign_keys,</span> <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">No foreign keys reference `test`.`employee1`; ignoring --alter-foreign-keys-method.</span><br><span class="line">Altering `test`.`employee1`...</span><br><span class="line">Creating <span class="keyword">new</span> table...</span><br><span class="line">CREATE TABLE `test`.`_employee1_new` (</span><br><span class="line">  `id` int(<span class="number">10</span>) unsigned <span class="literal">NOT</span> NULL,</span><br><span class="line">  `employeeid` int(<span class="number">10</span>) unsigned <span class="literal">NOT</span> NULL COMMENT '<span class="number">0</span>',</span><br><span class="line">  `employeename` varchar(<span class="number">300</span>) <span class="literal">NOT</span> NULL DEFAULT '',</span><br><span class="line">  `update_time` datetime <span class="literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',</span><br><span class="line">  PRIMARY KEY (`update_time`,`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci</span><br><span class="line">Created <span class="keyword">new</span> table test._employee1_new OK.</span><br><span class="line">Altering <span class="keyword">new</span> table...</span><br><span class="line">ALTER TABLE `test`.`_employee1_new` partition by RANGE COLUMNS (update_time)(PARTITION P202003 VALUES LESS THAN ('<span class="number">2020</span>-<span class="number">04</span>-<span class="number">01</span>'),PARTITION P202004 VALUES LESS THAN ('<span class="number">2020</span>-<span class="number">05</span>-<span class="number">01</span>'),PARTITION P202005 VALUES LESS THAN ('<span class="number">2020</span>-<span class="number">06</span>-<span class="number">01</span>'), PARTITION PMAX VALUES LESS THAN  MAXVALUE  ) </span><br><span class="line">Altered `test`.`_employee1_new` OK.</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">14</span> Creating triggers...</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">14</span> Created triggers OK.</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">14</span> Copying approximately <span class="number">10000</span> rows...</span><br><span class="line">INSERT LOW_PRIORITY IGNORE INTO `test`.`_employee1_new` (`id`, `employeeid`, `employeename`, `update_time`) SELECT `id`, `employeeid`, `employeename`, `update_time` FROM `test`.`employee1` FORCE INDEX(`PRIMARY`) WHERE ((`update_time` &gt; ?) <span class="literal">OR</span> (`update_time` = ? <span class="literal">AND</span> `id` &gt;= ?)) <span class="literal">AND</span> ((`update_time` &lt; ?) <span class="literal">OR</span> (`update_time` = ? <span class="literal">AND</span> `id` &lt;= ?)) LOCK IN SHARE MODE <span class="comment">/*pt-online-schema-change 16863 copy nibble*/</span></span><br><span class="line">SELECT <span class="comment">/*!40001 SQL_NO_CACHE */</span> `update_time`, `update_time`, `id` FROM `test`.`employee1` FORCE INDEX(`PRIMARY`) WHERE ((`update_time` &gt; ?) <span class="literal">OR</span> (`update_time` = ? <span class="literal">AND</span> `id` &gt;= ?)) ORDER BY `update_time`, `id` LIMIT ?, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Copied rows OK.</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Analyzing <span class="keyword">new</span> table...</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Swapping tables...</span><br><span class="line">RENAME TABLE `test`.`employee1` TO `test`.`_employee1_old`, `test`.`_employee1_new` TO `test`.`employee1`</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Swapped original <span class="literal">and</span> <span class="keyword">new</span> tables OK.</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Dropping old table...</span><br><span class="line">DROP TABLE IF EXISTS `test`.`_employee1_old`</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Dropped old table `test`.`_employee1_old` OK.</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Dropping triggers...</span><br><span class="line">DROP TRIGGER IF EXISTS `test`.`pt_osc_test_employee1_del`</span><br><span class="line">DROP TRIGGER IF EXISTS `test`.`pt_osc_test_employee1_upd`</span><br><span class="line">DROP TRIGGER IF EXISTS `test`.`pt_osc_test_employee1_ins`</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Dropped triggers OK.</span><br><span class="line">Successfully altered `test`.`employee1`.</span><br><span class="line">[root@VM_24_101_centos ~]# mysql test -e <span class="string">"show create table employee1\G"</span></span><br><span class="line"><span class="symbol">mysql:</span> [Warning] Using <span class="literal">a</span> password on the command line interface can be insecure.</span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line"><span class="symbol">       Table:</span> employee1</span><br><span class="line"><span class="symbol">Create Table:</span> CREATE TABLE `employee1` (</span><br><span class="line">  `id` int(<span class="number">10</span>) unsigned <span class="literal">NOT</span> NULL,</span><br><span class="line">  `employeeid` int(<span class="number">10</span>) unsigned <span class="literal">NOT</span> NULL COMMENT '<span class="number">0</span>',</span><br><span class="line">  `employeename` varchar(<span class="number">300</span>) <span class="literal">NOT</span> NULL DEFAULT '',</span><br><span class="line">  `update_time` datetime <span class="literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',</span><br><span class="line">  PRIMARY KEY (`update_time`,`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci</span><br><span class="line"><span class="comment">/*!50500 PARTITION BY RANGE  COLUMNS(update_time)</span></span><br><span class="line"><span class="comment">(PARTITION P202003 VALUES LESS THAN ('2020-04-01') ENGINE = InnoDB,</span></span><br><span class="line"><span class="comment"> PARTITION P202004 VALUES LESS THAN ('2020-05-01') ENGINE = InnoDB,</span></span><br><span class="line"><span class="comment"> PARTITION P202005 VALUES LESS THAN ('2020-06-01') ENGINE = InnoDB,</span></span><br><span class="line"><span class="comment"> PARTITION PMAX VALUES LESS THAN (MAXVALUE) ENGINE = InnoDB) */</span></span><br><span class="line">[root@VM_24_101_centos ~]#</span><br></pre></td></tr></table></figure></p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><h3 id="慎用参数–set-vars-’sql-log-bin-0’"><a href="#慎用参数–set-vars-’sql-log-bin-0’" class="headerlink" title="慎用参数–set-vars=’sql_log_bin=0’"></a>慎用参数–set-vars=’sql_log_bin=0’</h3><p>生产环境，当表中数据量过大，如果遇到添加索引的需求，部分人可能会采用分别在主库和从库加索引的方式，当在主库添加索引的时候，使用了–set-vars=’sql_log_bin=0’参数，可能会导致主从中断。</p>
<p><font color="FF0000">原因：</font><br><br>因为 –set-vars=’sql_log_bin=0’的原因，创建表的DDL语句，无法通过binlog在从库建表，所以临时表主库存在，从库不存在。<br><br>由于增量数据通过触发器将对原表的操作同步到临时表中，此时，对原表的操作会产生binlog，从库在应用此部分的binlog时会报错，提示表不存在。</p>
<p>建议：<br><br>低峰期在主库执行，不要使用参数–set-vars=’sql_log_bin=0’。</p>
<h3 id="谨慎在从库执行-ROW格式"><a href="#谨慎在从库执行-ROW格式" class="headerlink" title="谨慎在从库执行(ROW格式)"></a>谨慎在从库执行(ROW格式)</h3><p>对于生产大表加字段，有种方式是：先在从库加字段，主从切换，再在原主上加字段，可能有效的减小加字段对生产的影响。但是，当复制格式为ROW时，可能会出现复制中断的情况。</p>
<p><font color="FF0000">原因：</font><br><br>当使用pt-online-schema-change在从库执行时，会先创建临时表，在临时表上做DDL变更，然后，通过创建触发器的方式同步增量数据。由于从库同步是应用主库的binlog，从库创建的触发器就不会产生效果，增量数据也就不会同步到临时表，最后在做了临时表和原表的原子重命名后，会丢失数据，复制就会报1032错误，找不到行记录，复制中断。</p>
<p>建议：<br><br>低峰期在主库执行，不要在从库执行。</p>
<h3 id="自增锁"><a href="#自增锁" class="headerlink" title="自增锁"></a>自增锁</h3><p>模拟一种场景：<br><br>1.创建测试表，创建测试临时表，同时在原表上创建更新的触发器，模拟pt-online-schema-change，由于是人工模拟，在触发器中添加了sleep(5)。<br><br>分别在session1更新，session2执行insert low_priority ignore into(session1执行后的5s内执行)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1 (<span class="keyword">id</span> <span class="built_in">int</span> auto_increment primary <span class="keyword">key</span>,<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="literal">null</span>,<span class="string">'A1'</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="literal">null</span>,<span class="string">'B2'</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="literal">null</span>,<span class="string">'C3'</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="literal">null</span>,<span class="string">'D4'</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="literal">null</span>,<span class="string">'E5'</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span>  _t1_new <span class="keyword">like</span> t1;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> _t1_new <span class="keyword">engine</span> = <span class="keyword">innodb</span>;</span><br></pre></td></tr></table></figure></p>
<p>2.session1:更新原表<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">update</span> t1 <span class="keyword">set</span> <span class="keyword">name</span> = <span class="string">'DDD4'</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">4</span>;</span><br></pre></td></tr></table></figure></p>
<p>3.session2:插入数据到临时表(session1执行后的5s内执行)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">low_priority</span> <span class="keyword">ignore</span> <span class="keyword">into</span> _t1_new(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> <span class="keyword">id</span> &gt; <span class="number">2</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;<span class="number">5</span> <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br></pre></td></tr></table></figure></p>
<p>4.session1出现死锁<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ERROR </span>1213 (40001): Deadlock found when trying to get lock; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>5.以下为mysql5.7，rc隔离级别的测试案例<br><br>session1:<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:06</span>]&gt; create table t1 (id int auto_increment primary key,name varchar(10));</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:07</span>]&gt; insert into t1 select null,'A1';</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:07</span>]&gt; insert into t1 select null,'B2';</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:07</span>]&gt; insert into t1 select null,'C3';</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:07</span>]&gt; insert into t1 select null,'D4';</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:07</span>]&gt; insert into t1 select null,'E5';</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:07</span>]&gt; create table  <span class="emphasis">_t1_</span>new like t1;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:07</span>]&gt; alter table <span class="emphasis">_t1_</span>new engine = innodb;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:08</span>]&gt; delimiter //</span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:11</span>]&gt; create trigger  pt<span class="emphasis">_osc_</span>test<span class="emphasis">_t1_</span>upd  after update on test.t1 for  each row  begin  declare x int; set x = sleep(5); delete  IGNORE from  test.<span class="emphasis">_t1_</span>new  where  !(OLD.<span class="code">`id`</span> <span class="xml"><span class="tag">&lt;<span class="name">=</span>&gt;</span></span> NEW.<span class="code">`id`</span>) and  test.<span class="emphasis">_t1_</span>new.id  <span class="xml"><span class="tag">&lt;<span class="name">=</span>&gt;</span></span> OLD.<span class="code">`id`</span>;replace into test.<span class="emphasis">_t1_</span>new  (<span class="code">`id`</span>, <span class="code">`name`</span>)  values  (NEW.<span class="code">`id`</span>, NEW.<span class="code">`name`</span>);END//</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:11</span>]&gt; delimiter ;</span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:16</span>]&gt; select * from t1;</span><br><span class="line">+----+------+</span><br><span class="line">| id | name |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | A1   |</span><br><span class="line">|  2 | B2   |</span><br><span class="line">|  3 | C3   |</span><br><span class="line">|  4 | D4   |</span><br><span class="line">|  5 | E5   |</span><br><span class="line">+----+------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:16</span>]&gt; </span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:25</span>]&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:26</span>]&gt; update t1 set name = 'DDD4' where id = 4;</span><br><span class="line">ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:31</span>]&gt; </span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:34</span>]&gt; show engine innodb status\G</span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">  Type: InnoDB</span><br><span class="line">  Name: </span><br><span class="line">Status: </span><br><span class="line">=====================================</span><br><span class="line">2020-05-28 08:44:38 0x7fa64c23e700 INNODB MONITOR OUTPUT</span><br><span class="line">=====================================</span><br><span class="line">Per second averages calculated from the last 28 seconds</span><br><span class="line">-----------------</span><br><span class="line">BACKGROUND THREAD</span><br><span class="line">-----------------</span><br><span class="line">srv<span class="emphasis">_master_</span>thread loops: 26639 srv<span class="emphasis">_active, 0 srv_</span>shutdown, 395877 srv_idle</span><br><span class="line">srv<span class="emphasis">_master_</span>thread log flush and writes: 422516</span><br><span class="line">----------</span><br><span class="line">SEMAPHORES</span><br><span class="line">----------</span><br><span class="line">OS WAIT ARRAY INFO: reservation count 10330755</span><br><span class="line">OS WAIT ARRAY INFO: signal count 23257527</span><br><span class="line">RW-shared spins 0, rounds 26575782, OS waits 8009821</span><br><span class="line">RW-excl spins 0, rounds 48751926, OS waits 641098</span><br><span class="line">RW-sx spins 299480, rounds 8787074, OS waits 284218</span><br><span class="line">Spin rounds per wait: 26575782.00 RW-shared, 48751926.00 RW-excl, 29.34 RW-sx</span><br><span class="line">------------------------</span><br><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line">2020-05-28 08:44:31 0x7fa64c23e700</span><br><span class="line"><span class="emphasis">***</span> (1) TRANSACTION:</span><br><span class="line">TRANSACTION 4481653631, ACTIVE 1 sec fetching rows</span><br><span class="line">mysql tables in use 2, locked 2</span><br><span class="line">LOCK WAIT 5 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1</span><br><span class="line">MySQL thread id 36589, OS thread handle 140352217921280, query id 207646444 localhost root Sending data</span><br><span class="line">insert low<span class="emphasis">_priority ignore into _</span>t1_new(id,name) select id,name from t1 where id &gt; 2 and id <span class="xml"><span class="tag">&lt;<span class="name">5</span> <span class="attr">lock</span> <span class="attr">in</span> <span class="attr">share</span> <span class="attr">mode</span></span></span></span><br><span class="line"><span class="xml">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</span></span><br><span class="line"><span class="xml">RECORD LOCKS space id 346 page no 3 n bits 80 index PRIMARY of table `test`.`t1` trx id 4481653631 lock mode S locks rec but not gap waiting</span></span><br><span class="line"><span class="xml">Record lock, heap no 7 PHYSICAL RECORD: n_fields 4; compact format; info bits 0</span></span><br><span class="line"><span class="xml"> 0: len 4; hex 80000004; asc     ;;</span></span><br><span class="line"><span class="xml"> 1: len 6; hex 00010b209b7e; asc      ~;;</span></span><br><span class="line"><span class="xml"> 2: len 7; hex 580004fd7008c3; asc X   p  ;;</span></span><br><span class="line"><span class="xml"> 3: len 4; hex 44444434; asc DDD4;;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">*** (2) TRANSACTION:</span></span><br><span class="line"><span class="xml">TRANSACTION 4481653630, ACTIVE 5 sec setting auto-inc lock, thread declared inside InnoDB 5000</span></span><br><span class="line"><span class="xml">mysql tables in use 2, locked 2</span></span><br><span class="line"><span class="xml">4 lock struct(s), heap size 1136, 1 row lock(s), undo log entries 2</span></span><br><span class="line"><span class="xml">MySQL thread id 36587, OS thread handle 140352218720000, query id 207646446 localhost root update</span></span><br><span class="line"><span class="xml">replace into test._t1_new  (`id`, `name`)  values  (NEW.`id`, NEW.`name`)</span></span><br><span class="line"><span class="xml">*** (2) HOLDS THE LOCK(S):</span></span><br><span class="line"><span class="xml">RECORD LOCKS space id 346 page no 3 n bits 72 index PRIMARY of table `test`.`t1` trx id 4481653630 lock_mode X locks rec but not gap</span></span><br><span class="line"><span class="xml">Record lock, heap no 7 PHYSICAL RECORD: n_fields 4; compact format; info bits 0</span></span><br><span class="line"><span class="xml"> 0: len 4; hex 80000004; asc     ;;</span></span><br><span class="line"><span class="xml"> 1: len 6; hex 00010b209b7e; asc      ~;;</span></span><br><span class="line"><span class="xml"> 2: len 7; hex 580004fd7008c3; asc X   p  ;;</span></span><br><span class="line"><span class="xml"> 3: len 4; hex 44444434; asc DDD4;;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</span></span><br><span class="line"><span class="xml">TABLE LOCK table `test`.`_t1_new` trx id 4481653630 lock mode AUTO-INC waiting</span></span><br><span class="line"><span class="xml">*** WE ROLL BACK TRANSACTION (2)</span></span><br><span class="line"><span class="xml">------------</span></span><br><span class="line"><span class="xml">TRANSACTIONS</span></span><br><span class="line"><span class="xml">------------</span></span><br><span class="line"><span class="xml">Trx id counter 4481653637</span></span><br><span class="line"><span class="xml">Purge done for trx's n:o <span class="tag">&lt; <span class="attr">4481653637</span> <span class="attr">undo</span> <span class="attr">n:o</span> &lt; <span class="attr">0</span> <span class="attr">state:</span> <span class="attr">running</span> <span class="attr">but</span> <span class="attr">idle</span></span></span></span><br><span class="line"><span class="xml">History list length 60</span></span><br><span class="line"><span class="xml">LIST OF TRANSACTIONS FOR EACH SESSION:</span></span><br><span class="line"><span class="xml">---TRANSACTION 421829777725264, not started</span></span><br><span class="line"><span class="xml">0 lock struct(s), heap size 1136, 0 row lock(s)</span></span><br><span class="line"><span class="xml">---TRANSACTION 421829777727088, not started</span></span><br><span class="line"><span class="xml">0 lock struct(s), heap size 1136, 0 row lock(s)</span></span><br><span class="line"><span class="xml">---TRANSACTION 4481653631, ACTIVE 8 sec</span></span><br><span class="line"><span class="xml">6 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 2</span></span><br><span class="line"><span class="xml">MySQL thread id 36589, OS thread handle 140352217921280, query id 207646444 localhost root</span></span><br><span class="line"><span class="xml">--------</span></span><br><span class="line"><span class="xml">FILE I/O</span></span><br><span class="line"><span class="xml">--------</span></span><br><span class="line"><span class="xml">...</span></span><br></pre></td></tr></table></figure></p>
<p>session2:<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:29</span>]&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:30</span>]&gt; insert low<span class="emphasis">_priority ignore into _</span>t1_new(id,name) select id,name from t1 where id &gt; 2 and id <span class="xml"><span class="tag">&lt;<span class="name">5</span> <span class="attr">lock</span> <span class="attr">in</span> <span class="attr">share</span> <span class="attr">mode</span>;</span></span></span><br><span class="line"><span class="xml">Query OK, 2 rows affected (1.06 sec)</span></span><br><span class="line"><span class="xml">Records: 2  Duplicates: 0  Warnings: 0</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">[root@localhost][test][08:44:31]&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>分析:<br><br>1.原表更新和触发器触发后的临时表更新在同一事务内，通过查看binlog可以看到<br><br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/</span><span class="comment">;</span></span><br><span class="line"><span class="comment">/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/</span><span class="comment">;</span></span><br><span class="line">DELIMITER <span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line"><span class="comment"># at 4</span></span><br><span class="line"><span class="comment">#180920  8:58:06 server id 1  end_log_pos 124 CRC32 0x9dc68bf8 	Start: binlog v 4, server v 8.0.18 created 180920  8:58:06</span></span><br><span class="line"><span class="comment"># Warning: this binlog is either in use or was not closed properly.</span></span><br><span class="line"><span class="keyword">BINLOG </span><span class="string">'</span></span><br><span class="line"><span class="string">ngzPXg8BAAAAeAAAAHwAAAABAAQAOC4wLjE4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span><br><span class="line"><span class="string">AAAAAAAAAAAAAAAAAAAAAAAAEwANAAgAAAAABAAEAAAAYAAEGggAAAAICAgCAAAACgoKKioAEjQA</span></span><br><span class="line"><span class="string">CgH4i8ad</span></span><br><span class="line"><span class="string">'/*!*/;</span></span><br><span class="line"><span class="string"># at 124</span></span><br><span class="line"><span class="string">#180920  8:58:06 server id 1  end_log_pos 195 CRC32 0x16f7d4d2 	Previous-GTIDs</span></span><br><span class="line"><span class="string"># 3e5359e7-6ca7-11e8-b856-525400931d92:470870-495654</span></span><br><span class="line"><span class="string"># at 195</span></span><br><span class="line"><span class="string">#180920  8:58:21 server id 1  end_log_pos 274 CRC32 0x5e21ec93 	GTID	last_committed=0	sequence_number=1	rbr_only=yes	original_committed_timestamp=1590627501692250	immediate_commit_timestamp=1590627501692250	transaction_length=474</span></span><br><span class="line"><span class="string">/*!50718 SET TRANSACTION ISOLATION LEVEL READ COMMITTED*//*!*/;</span></span><br><span class="line"><span class="string"># original_commit_timestamp=1590627501692250 (2020-05-28 08:58:21.692250 CST)</span></span><br><span class="line"><span class="string"># immediate_commit_timestamp=1590627501692250 (2020-05-28 08:58:21.692250 CST)</span></span><br><span class="line"><span class="string">/*!80001 SET @@session.original_commit_timestamp=1590627501692250*//*!*/;</span></span><br><span class="line"><span class="string">/*!80014 SET @@session.original_server_version=80018*//*!*/;</span></span><br><span class="line"><span class="string">/*!80014 SET @@session.immediate_server_version=80018*//*!*/;</span></span><br><span class="line"><span class="string">SET @@SESSION.GTID_NEXT= '</span><span class="number">3</span>e5359e7-6ca7-11e8-<span class="keyword">b856-525400931d92:495655'/*!*/;</span></span><br><span class="line"><span class="keyword"># </span><span class="built_in">at</span> <span class="number">274</span></span><br><span class="line"><span class="comment">#180920  8:58:15 server id 1  end_log_pos 358 CRC32 0xedf75521 	Query	thread_id=781	exec_time=0	error_code=0</span></span><br><span class="line">SET TIMESTAMP=<span class="number">1590627495</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line">SET @@session.pseudo_thread_id=<span class="number">781</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line">SET @@session.foreign_key_checks=<span class="number">1</span>, @@session.sql_auto_is_null=<span class="number">0</span>, @@session.unique_checks=<span class="number">1</span>, @@session.autocommit=<span class="number">1</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line">SET @@session.sql_mode=<span class="number">1168113696</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line">SET @@session.auto_increment_increment=<span class="number">1</span>, @@session.auto_increment_offset=<span class="number">1</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line"><span class="comment">/*!\C utf8 */</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line">SET @@session.character_set_client=<span class="number">33</span>,@@session.collation_connection=<span class="number">33</span>,@@session.collation_server=<span class="number">255</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line">SET @@session.lc_time_names=<span class="number">0</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line">SET @@session.collation_database=DEFAULT<span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line"><span class="comment">/*!80011 SET @@session.default_collation_for_utf8mb4=255*/</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">/*!*/;</span></span><br><span class="line"><span class="keyword"># </span><span class="built_in">at</span> <span class="number">358</span></span><br><span class="line"><span class="comment">#180920  8:58:15 server id 1  end_log_pos 422 CRC32 0x3e869251 	Rows_query</span></span><br><span class="line"><span class="comment"># update t1 set name = 'DDD4' where id = 4</span></span><br><span class="line"><span class="comment"># at 422</span></span><br><span class="line"><span class="comment">#180920  8:58:15 server id 1  end_log_pos 478 CRC32 0x6c91a26c 	Table_map: `test`.`t1` mapped to number 287</span></span><br><span class="line"><span class="comment"># at 478</span></span><br><span class="line"><span class="comment">#180920  8:58:15 server id 1  end_log_pos 539 CRC32 0xe153a38c 	Table_map: `test`.`_t1_new` mapped to number 286</span></span><br><span class="line"><span class="comment"># at 539</span></span><br><span class="line"><span class="comment">#180920  8:58:15 server id 1  end_log_pos 593 CRC32 0xa2ff1eed 	Update_rows: table id 287</span></span><br><span class="line"><span class="comment"># at 593</span></span><br><span class="line"><span class="comment">#180920  8:58:15 server id 1  end_log_pos 638 CRC32 0xd6d9a8bf 	Write_rows: table id 286 flags: STMT_END_F</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">BINLOG </span><span class="string">'</span></span><br><span class="line"><span class="string">pwzPXh0BAAAAQAAAAKYBAACAACh1cGRhdGUgdDEgc2V0IG5hbWUgPSAnRERENCcgd2hlcmUgaWQg</span></span><br><span class="line"><span class="string">PSA0UZKGPg==</span></span><br><span class="line"><span class="string">pwzPXhMBAAAAOAAAAN4BAAAAAB8BAAAAAAEABHRlc3QAAnQxAAIDDwIoAAIBAQACA/z/AGyikWw=</span></span><br><span class="line"><span class="string">pwzPXhMBAAAAPQAAABsCAAAAAB4BAAAAAAEABHRlc3QAB190MV9uZXcAAgMPAigAAgEBAAID/P8A</span></span><br><span class="line"><span class="string">jKNT4Q==</span></span><br><span class="line"><span class="string">pwzPXh8BAAAANgAAAFECAAAAAB8BAAAAAAAAAgAC//8ABAAAAAJENAAEAAAABERERDTtHv+i</span></span><br><span class="line"><span class="string">pwzPXh4BAAAALQAAAH4CAAAAAB4BAAAAAAEAAgAC/wAEAAAABERERDS/qNnW</span></span><br><span class="line"><span class="string">'/*!*/;</span></span><br><span class="line"><span class="string">### UPDATE `test`.`t1`</span></span><br><span class="line"><span class="string">### WHERE</span></span><br><span class="line"><span class="string">###   @1=4 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="string">###   @2='</span>D4<span class="string">' /* VARSTRING(40) meta=40 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="string">### SET</span></span><br><span class="line"><span class="string">###   @1=4 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="string">###   @2='</span>DDD4<span class="string">' /* VARSTRING(40) meta=40 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="string">### INSERT INTO `test`.`_t1_new`</span></span><br><span class="line"><span class="string">### SET</span></span><br><span class="line"><span class="string">###   @1=4 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="string">###   @2='</span>DDD4<span class="string">' /* VARSTRING(40) meta=40 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="string"># at 638</span></span><br><span class="line"><span class="string">#180920  8:58:21 server id 1  end_log_pos 669 CRC32 0x4847dd4b 	Xid = 61574</span></span><br><span class="line"><span class="string">COMMIT/*!*/;</span></span><br></pre></td></tr></table></figure></p>
<p>其中，最后面的UPDATE <code>test</code>.<code>t1</code>和INSERT INTO <code>test</code>.<code>_t1_new</code>可以看出来。</p>
<p>2.session1执行update t1 set name = ‘DDD4’ where id = 4;时，对应的show engine innodb status中的TRANSACTION 2<br><br>此时，TRANSACTION 2持有t1表id=4的x锁，由于触发器的原因，t1和_t1_new的更新在同一事务内，等待获取_t1_new表的auto-inc lock，等待的语句为：replace into test._t1_new  (<code>id</code>, <code>name</code>)  values  (NEW.<code>id</code>, NEW.<code>name</code>)<br></p>
<p>3.session2执行insert low_priority ignore into _t1_new(id,name) select id,name from t1 where id &gt; 2 and id &lt;5 lock in share mode;时，对应的show engine innodb status中的TRANSACTION 1<br><br>此时，TRANSACTION 1持有_t1_new的auto-inc lock，等待获取t1的记录锁</p>
<p>4.session1和session2产生了死锁，回滚了TRANSACTION 2</p>
<p><font color="FF0000">注意：</font><br><br>MySQL8.0在上述实验场景中，并不会出现死锁。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>pt-online-schema-change是一个很优秀的在线DDL工具，在gh-ost出现之前，广泛应用于生产。同时，为了更好的使用他提高工作效率，需要了解其应用场景与内部工作原理，避免踩到坑。</p>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/MySQL-TimeOut分析.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/MySQL-TimeOut分析.html" itemprop="url">MySQL TimeOut分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-05T11:23:10+08:00">
                2018-08-05
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>在做日常mysql数据库维护过程，时长会遇到关于mysql timeout的相关报错，了解mysql的连接过程和常见的错误类型，知己知彼，可以更好去运维mysql，做到心中有数。</p>
<h2 id="MySQL连接参数"><a href="#MySQL连接参数" class="headerlink" title="MySQL连接参数"></a>MySQL连接参数</h2><p>和网络超时相关的参数，这里做下简单说明：</p>
<ul>
<li><p>interactive_timeout</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">服务器在关闭之前等待交互式连接的超时时间，交互式客户端定义为在mysql_real_<span class="keyword">connect</span><span class="params">()</span>中使用CLIENT_INTERACTIVE选项的客户端。像mysql客户端是交互式客户端。</span><br></pre></td></tr></table></figure>
</li>
<li><p>wait_timeout</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">服务器关闭非交互式连接之前等待活动的秒数，在线程启动时，根据全局<span class="selector-tag">wait_timeout</span>值或全局<span class="selector-tag">interactive_timeout</span>值初始化会话<span class="selector-tag">wait_timeout</span>值，取决于客户端类型(由mysql_real_connect()的连接选项CLIENT_INTERACTIVE定义)。像<span class="selector-tag">java</span>使用的<span class="selector-tag">jdbc</span>连接，<span class="selector-tag">php</span>使用<span class="selector-tag">pdo</span>连接等都是非交互式连接。</span><br></pre></td></tr></table></figure>
</li>
<li><p>net_read_timeout</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在终止读之前，从一个连接获得数据而等待的时间秒数；当服务正在从客户端读取数据时，net_read_timeout控制何时超时。例如<span class="keyword">load</span> <span class="keyword">data</span> <span class="keyword">local</span> <span class="keyword">infile</span>语句。</span><br></pre></td></tr></table></figure>
</li>
<li><p>net_write_timeout</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在终止写之前，等待多少秒把<span class="built_in">block</span>写到连接，当服务正在写数据到客户端时，net_write_timeout控制何时超时</span><br></pre></td></tr></table></figure>
</li>
<li><p>connect_timeout</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">在连接认证阶段的网络交互超时时间(<span class="keyword">ref</span> login_connection)。</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="MySQL连接过程"><a href="#MySQL连接过程" class="headerlink" title="MySQL连接过程"></a>MySQL连接过程</h2><p>其中</p>
<ul>
<li>connect_timeout    在获取连接阶段（authenticate）起作用</li>
<li>interactive_timeout和wait_timeout    在连接空闲阶段（sleep）起作用</li>
<li>net_read_timeout和net_write_timeout    则是在连接繁忙阶段（query）起作用。<h3 id="mysql通信协议"><a href="#mysql通信协议" class="headerlink" title="mysql通信协议"></a>mysql通信协议</h3>mysql 客户端和服务端之间的通信协议是”半双工”， 在任何一个时刻，要么是由服务端向客户端发送数据，要么是由客户端向服务端发送数据，这两个动作不能同时发生。参数max_allowed_packet在做导入数据的时候，net_buffer_length在缓冲数据的时候就很重要了。<h3 id="connect-timeout"><a href="#connect-timeout" class="headerlink" title="connect_timeout"></a>connect_timeout</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Connect_timeout</span><br><span class="line">The number of seconds that the mysqld<span class="built_in"> server </span>waits <span class="keyword">for</span> a connect packet before responding with Bad handshake</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>MySQL连接一次连接需求经过6次“握手”方可成功，任意一次“握手”失败都有可能导致连接失败，前三次握手可以简单理解为TCP建立连接所必须的三次握手，MySQL无法控制，更多的受制于不TCP协议的不同实现，后面的三次握手过程超时与connect_timeout有关。<br><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_1.png" alt="image"></p>
<p>建立连接步骤：</p>
<ol>
<li>客户端向DB发起TCP握手</li>
<li>三次握手成功，由DB发送HandShake信息，这个Packet里面包含了MySql的能力、加密seed等信息。</li>
<li>客户端根据HandShake包里面的加密seed对MySql登录密码进行摘要后，构造Auth认证包发送给DB。</li>
<li>DB接收到客户端发过来的Auth包后会对密码摘要进行比对，从而确认是否能够登录。如果能，则发送Okay包返回。</li>
<li>客户端与DB的连接至此完毕。</li>
</ol>
<h3 id="net-read-timeout-amp-amp-net-write-timeout"><a href="#net-read-timeout-amp-amp-net-write-timeout" class="headerlink" title="net_read_timeout &amp;&amp; net_write_timeout"></a>net_read_timeout &amp;&amp; net_write_timeout</h3><p>当connect建立后，读取命令的流程如下：</p>
<ol>
<li>read_packet    通过函数my_net_read读取数据包，如果一次读不完成，则调用函数net_read_raw_loop进行循环读取，读取的超时由wait_timeout决定<br>1）    会先读取packet header，一个普通的packet header包含4个字节，压缩协议下则另外再加3个字节<br>2）    再从packet header中提取剩下的packet长度，继续从socket读取</li>
<li>vio_read_buff    vio封装了所有对socket的操作,当read_packet完成后，进入到vio相关的函数做封装处理，包括vio_init, vio_read_buffer,vio_read等。</li>
<li>my_net_write    mysql通过read_packet做过相关处理后，通过my_net_write函数将数据先拷贝到NET缓冲区，当长度大于MAX_PACKET_LENGTH(即4MB-1字节)会对Packet进行拆分成多个packet。每个Packet的头部都会留4个字节，其中：1~3字节，存储该packet的长度，第4个字节存储当前的packet的序号，每存储一次后递增net-&gt;pkt_nr。<br>每个Net对象有一个Buff(net-&gt;buff)，即将发送的数据被拷贝到这个buffer中，当Buffer满时需要立刻发出到客户端。如果Buffer足够大，则只做memcpy操作。net-&gt;write_pos被更新到写入结束的位置偏移量 (net_write_buff)。<br>如果一次写入的数据被拆分成多个Packet，那么net-&gt;pkt_nr也对应的递增多次. pkt_nr的作用是在客户端解析时，防止包发送乱序。</li>
<li>net_flush    在my_net_write函数中，如果net-&gt;buff不够用，已经会做网络写了，net_flush最终保证所有在buff中的数据被写到网络。</li>
<li>net_write_raw_loop    当packet准备好发送后，调用函数net_write_raw_loop开始进行数据发送。<br>1）    在发送模式受vio-&gt;write_timeout影响(通过参数net_write_timeout控制)；当该参数被设置成大于等于0时，使用非阻塞模式send数据包(MSG_DONTWAIT)<br>2）    若网络发送被中断（EINTR），会去尝试重传<br>3）    使用非阻塞模式send，每次并不保证数据全部发送完毕，因此需要循环的调用直到所有的数据都发送完毕<br>4）    当输出缓冲区满时，获得错误码EWOULDBLOCK/EAGAIN,则阻塞等待(vio_socket_io_wait)，最大等待时间为net_write_timeout，超时则返回错误</li>
</ol>
<h3 id="interactive-timeout-amp-amp-wait-timeout"><a href="#interactive-timeout-amp-amp-wait-timeout" class="headerlink" title="interactive_timeout &amp;&amp; wait_timeout"></a>interactive_timeout &amp;&amp; wait_timeout</h3><p>当query处理完成后，连接会进入到空闲阶段，此时受interactive_timeout和wait_timeout控制。关于interactive_timeout和wait_timeout，session和global有继承关系，可以自己测试，这里有篇<a href="http://blog.itpub.net/22664653/viewspace-2143671/" target="_blank" rel="noopener">文章</a>，测试的很详细。</p>
<h2 id="MySQL超时类型"><a href="#MySQL超时类型" class="headerlink" title="MySQL超时类型"></a>MySQL超时类型</h2><h3 id="Got-timeout-reading-communication-packets"><a href="#Got-timeout-reading-communication-packets" class="headerlink" title="Got timeout reading communication packets"></a>Got timeout reading communication packets</h3><h4 id="连接超时"><a href="#连接超时" class="headerlink" title="连接超时"></a>连接超时</h4><p>设置interactive_timeout和wait_timeout，使用mysql客户端连接，等待设置的超时时间后被mysql kill掉，在日志观察详情</p>
<h5 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h5><p>设置interactive_timeout和wait_timeout</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_2.png" alt="image"></p>
<h5 id="观察日志"><a href="#观察日志" class="headerlink" title="观察日志"></a>观察日志</h5><p>通过观察error log查看连接是否断开</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_3.png" alt="image"></p>
<p>其中，连接的thread_id为2885，超过10s后断开，出现<font color="FF0000"><b>日志详情</b></font><br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-03</span><span class="string">T10:</span><span class="number">11</span>:<span class="number">48.650754</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">2885</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">2885</span> to <span class="string">db:</span> <span class="string">'unconnected'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got timeout reading communication packets).</span><br></pre></td></tr></table></figure></p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>其他常见的错误，可以参考<a href="https://dev.mysql.com/doc/refman/5.7/en/communication-errors.html" target="_blank" rel="noopener">官方文档</a>，有详情的介绍，也可根据实际测试结果来验证。</p>
<h3 id="Got-an-error-reading-communication-packets"><a href="#Got-an-error-reading-communication-packets" class="headerlink" title="Got an error reading communication packets"></a>Got an error reading communication packets</h3><h4 id="客户端异常退出-数据包异常"><a href="#客户端异常退出-数据包异常" class="headerlink" title="客户端异常退出(数据包异常)"></a>客户端异常退出(<font color="FF0000"><b>数据包异常</b></font>)</h4><p>使用pt-kill工具监控mysql的语句，通过在mysql确认pt-kill守护进程存在，kill掉此进程，观察日志的详情</p>
<h5 id="准备-1"><a href="#准备-1" class="headerlink" title="准备"></a>准备</h5><ol>
<li>pt-kill安装<br>安装pt-kill工具，测试机使用ubuntu 16.04机器，直接使用以下命令：<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget -c https:<span class="comment">//www.percona.com/downloads/percona-toolkit/3.0.10/binary/debian/xenial/x86_64/percona-toolkit_3.0.10-1.xenial_amd64.deb</span></span><br><span class="line">dpkg -<span class="selector-tag">i</span> percona-toolkit_3.<span class="number">0.10</span>-<span class="number">1</span><span class="selector-class">.xenial_amd64</span><span class="selector-class">.deb</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="pt-kill测试"><a href="#pt-kill测试" class="headerlink" title="pt-kill测试"></a>pt-kill测试</h5><ol>
<li>运行pt-kill进程<br>命令：<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> localhost <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql/data/mysql.sock</span> <span class="params">--match-host=</span><span class="string">"127.0.0.1|localhost"</span> <span class="params">--match-user=</span><span class="string">"root"</span> <span class="params">--match-db=</span><span class="string">"sysbench|test"</span> <span class="params">--match-command=</span><span class="string">"Query"</span> <span class="params">--match-state=</span><span class="string">"statistics"</span> <span class="params">--match-info=</span><span class="string">"(?i-xsm:select)"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1  <span class="params">--kill-query</span> <span class="params">--daemonize</span> <span class="params">--print</span> <span class="params">--log=/tmp/pt-kill</span>.log</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_4.png" alt="image"></p>
<ol start="2">
<li>查看pt-kill进程</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_5.png" alt="image"></p>
<ol start="3">
<li>查看mysql相关pt-kill进程</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_6.png" alt="image"></p>
<ol start="4">
<li>Kill掉pt-kill进程</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_7.png" alt="image"></p>
<ol start="5">
<li>观察日志<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-02</span><span class="string">T15:</span><span class="number">21</span>:<span class="number">32.254962</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">62476</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">62476</span> to <span class="string">db:</span> <span class="string">'unconnected'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error readin</span><br><span class="line">g communication packets).</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_8.png" alt="image"></p>
<h4 id="网络错误"><a href="#网络错误" class="headerlink" title="网络错误"></a>网络错误</h4><h5 id="准备-2"><a href="#准备-2" class="headerlink" title="准备"></a>准备</h5><p>使用linux自带的tc命令篡改数据包，设置网卡随机产生30%的<font color="FF0000"><b>损坏数据包</b></font>，也可使用tc的其他场景，比如<font color="FF0000"><b>数据包重复</b></font>等待去做各种测试，这里仅使用2种场景分别测试损坏数据包时，是否产生Got an error writing communication packets的情况</p>
<ol>
<li>设置tc数据包修改: 命令，由于测试的机器包括多块网卡，这里全部设置：<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">tc  qdisc  <span class="keyword">add</span><span class="bash">  dev  eth0  root  netem  corrupt  30% </span></span><br><span class="line"><span class="bash">tc  qdisc  add  dev  eth1  root  netem  corrupt  30%</span></span><br><span class="line"><span class="bash">tc  qdisc  add  dev  lo  root  netem  corrupt  30%</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_9.png" alt="image"></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_10.png" alt="image"></p>
<ol start="2">
<li>ping结果查看: 通过ping查看，tc的设置已经生效，出现了损坏数据包</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_11.png" alt="image"></p>
<h5 id="sysbench测试"><a href="#sysbench测试" class="headerlink" title="sysbench测试"></a>sysbench测试</h5><p>通过在sysbench压测过程中，人工设置，模拟网络出现问题的情况，观察日志</p>
<ol>
<li>sysbench压测<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/sysbench <span class="attribute">--db-driver</span>=mysql <span class="attribute">--mysql-socket</span>=/opt/mysql/data/mysql.sock <span class="attribute">--tables</span>=1 <span class="attribute">--table_size</span>=1000000 <span class="attribute">--report-interval</span>=10 <span class="attribute">--time</span>=3600 <span class="attribute">--mysql-port</span>=3306 <span class="attribute">--mysql-user</span>=root <span class="attribute">--mysql-password</span>=111111 <span class="attribute">--mysql-db</span>=sysbench <span class="attribute">--mysql-host</span>=10.30.167.90 <span class="attribute">--max-requests</span>=0 /usr/local/share/sysbench/oltp_read_write.lua <span class="attribute">--threads</span>=4 run</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>压测结果：</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_12.png" alt="image"></p>
<ol start="2">
<li>观察error log</li>
</ol>
<p>已经出现了Got an error writing communication packets相关告警信息<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-02</span><span class="string">T16:</span><span class="number">35</span>:<span class="number">51.858793</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">65764</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">65764</span> to <span class="string">db:</span> <span class="string">'sysbench'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error writing communication packets).</span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-02</span><span class="string">T16:</span><span class="number">35</span>:<span class="number">51.899059</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">65767</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">65767</span> to <span class="string">db:</span> <span class="string">'sysbench'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error writing communication packets).</span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-02</span><span class="string">T16:</span><span class="number">35</span>:<span class="number">51.899260</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">65765</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">65765</span> to <span class="string">db:</span> <span class="string">'sysbench'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error writing communication packets).</span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-02</span><span class="string">T16:</span><span class="number">35</span>:<span class="number">51.899339</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">65766</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">65766</span> to <span class="string">db:</span> <span class="string">'sysbench'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error writing communication packets).</span><br></pre></td></tr></table></figure></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_13.png" alt="image"></p>
<h5 id="php测试"><a href="#php测试" class="headerlink" title="php测试"></a>php测试</h5><p>通过以运行php代码的形式来访问数据，人工设置，模拟网络出现问题的情况，观察日志</p>
<ol>
<li>php代码运行<br>这里以互联网在线模拟为例子，地址：<a href="https://www.dooccn.com/php/" target="_blank" rel="noopener">https://www.dooccn.com/php/</a></li>
</ol>
<p>代码详情：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="php"><span class="meta">&lt;?php</span></span></span><br><span class="line"><span class="php">header(<span class="string">'content-type:text/html;charset=utf-8'</span>);</span></span><br><span class="line"><span class="php"><span class="keyword">try</span> &#123;  </span></span><br><span class="line"><span class="php">    $db = <span class="keyword">new</span> PDO(<span class="string">'mysql:host=118.190.67.67;dbname=mysql'</span>, <span class="string">'root'</span>, <span class="string">'xxx'</span>);  </span></span><br><span class="line"><span class="php">    <span class="comment">//查询  </span></span></span><br><span class="line"><span class="php">	$rows = $db-&gt;query(<span class="string">'SELECT sleep(100)'</span>)-&gt;fetch(PDO::FETCH_ASSOC);</span></span><br><span class="line"><span class="php">	$rs = <span class="keyword">array</span>();</span></span><br><span class="line"><span class="php">    <span class="keyword">foreach</span>($rows <span class="keyword">as</span> $row) &#123;  </span></span><br><span class="line"><span class="php">        $rs[] = $row; </span></span><br><span class="line"><span class="php">    &#125;  </span></span><br><span class="line"><span class="php">    $db = <span class="keyword">null</span>;  </span></span><br><span class="line"><span class="php">&#125; <span class="keyword">catch</span> (PDOException $e) &#123;  </span></span><br><span class="line"><span class="php">    <span class="keyword">print</span> <span class="string">"Error!: "</span> . $e-&gt;getMessage() . <span class="string">"&lt;br/&gt;"</span>;  </span></span><br><span class="line"><span class="php">    <span class="keyword">die</span>();  </span></span><br><span class="line"><span class="php">&#125;</span></span><br><span class="line"><span class="php">print_r($rs);</span></span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>观察error log</li>
</ol>
<p>已经出现了Got an error writing communication packets相关告警信息<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-02</span><span class="string">T16:</span><span class="number">37</span>:<span class="number">31.183490</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">66089</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">66089</span> to <span class="string">db:</span> <span class="string">'mysql'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'106.14.17.222'</span> (Got an error reading communication packets).</span><br></pre></td></tr></table></figure></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_14.png" alt="image"></p>
<h4 id="max-prepared-stmt-count"><a href="#max-prepared-stmt-count" class="headerlink" title="max_prepared_stmt_count"></a>max_prepared_stmt_count</h4><ul>
<li>max_prepared_stmt_count<br>此参数限制了同一时间在mysqld上所有session中prepared 语句的上限。一般做压力测试的prepare阶段可以会遇到此参数设置较小的问题，同时日志中会返回Got an error reading communication packets的错误，这里不再测试，在做压力测试时，需要将此参数设置大些。</li>
</ul>
<h5 id="准备-3"><a href="#准备-3" class="headerlink" title="准备"></a>准备</h5><ol>
<li>设置max_prepared_stmt_count</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_15.png" alt="image"></p>
<h5 id="sysbench测试-1"><a href="#sysbench测试-1" class="headerlink" title="sysbench测试"></a>sysbench测试</h5><ol>
<li><p>运行压力测试</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/bin/sysbench <span class="attribute">--db-driver</span>=mysql <span class="attribute">--mysql-socket</span>=/opt/mysql/data/mysql.sock <span class="attribute">--tables</span>=1 <span class="attribute">--table_size</span>=1000000 <span class="attribute">--report-interval</span>=10 <span class="attribute">--time</span>=3600 <span class="attribute">--mysql-port</span>=3306 <span class="attribute">--mysql-user</span>=root <span class="attribute">--mysql-password</span>=111111 <span class="attribute">--mysql-db</span>=sysbench <span class="attribute">--mysql-host</span>=10.30.167.90 <span class="attribute">--max-requests</span>=0 /usr/local/share/sysbench/oltp_read_write.lua <span class="attribute">--threads</span>=4 run</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看sysbench日志</p>
</li>
</ol>
<p>在11.04的时候运行的压力测试</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_16.png" alt="image"></p>
<ol start="3">
<li>查看mysql log<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-03</span><span class="string">T11:</span><span class="number">04</span>:<span class="number">07.696809</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">5366</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">5366</span> to <span class="string">db:</span> <span class="string">'sysbench'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error reading communication packets).</span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-03</span><span class="string">T11:</span><span class="number">04</span>:<span class="number">07.696884</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">5365</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">5365</span> to <span class="string">db:</span> <span class="string">'sysbench'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error reading communication packets).</span><br><span class="line"><span class="number">2018</span><span class="number">-08</span><span class="number">-03</span><span class="string">T11:</span><span class="number">04</span>:<span class="number">07.696959</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">5364</span> [Note] [MY<span class="number">-010914</span>] [Server] Aborted connection <span class="number">5364</span> to <span class="string">db:</span> <span class="string">'sysbench'</span> <span class="string">user:</span> <span class="string">'root'</span> <span class="string">host:</span> <span class="string">'localhost'</span> (Got an error reading communication packets).</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_17.png" alt="image"></p>
<h4 id="其他-1"><a href="#其他-1" class="headerlink" title="其他"></a>其他</h4><p>其他常见的错误，可以参考<a href="https://dev.mysql.com/doc/refman/5.7/en/communication-errors.html" target="_blank" rel="noopener">官方文档</a>，有详情的介绍，也可根据实际测试结果来验证。</p>
<h3 id="Lost-connection-to-MySQL-server-during-query"><a href="#Lost-connection-to-MySQL-server-during-query" class="headerlink" title="Lost connection to MySQL server during query"></a>Lost connection to MySQL server during query</h3><h4 id="超时connect-timeout"><a href="#超时connect-timeout" class="headerlink" title="超时connect_timeout"></a>超时connect_timeout</h4><p>使用linux自带的tc命令设置网络延迟，达到测试所需要的效果</p>
<h5 id="准备-4"><a href="#准备-4" class="headerlink" title="准备"></a>准备</h5><ol>
<li>设置tc数据包延迟：命令，由于测试的机器包括多块网卡，这里全部设置：<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">tc qdisc <span class="keyword">add</span><span class="bash"> dev eth1 root netem delay 11000ms</span></span><br><span class="line"><span class="bash">tc qdisc add dev eth0 root netem delay 11000ms</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_18.png" alt="image"></p>
<h5 id="登录连接测试"><a href="#登录连接测试" class="headerlink" title="登录连接测试"></a>登录连接测试</h5><p>通过远程连接其他mysql服务器，查看登录效果，超过了默认connect_timeout的10s，报Lost connection to MySQL server during query错误</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_19.png" alt="image"></p>
<h4 id="客户端异常退出-数据包正常"><a href="#客户端异常退出-数据包正常" class="headerlink" title="客户端异常退出(数据包正常)"></a>客户端异常退出(<font color="FF0000"><b>数据包正常</b></font>)</h4><p>开启2个session窗口，连接同一个mysql实例，第1个session开启查询，第2个session去kill掉第一个session</p>
<h5 id="准备-5"><a href="#准备-5" class="headerlink" title="准备"></a>准备</h5><ol>
<li>Session1开启查询</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_20.png" alt="image"></p>
<h5 id="手动kill"><a href="#手动kill" class="headerlink" title="手动kill"></a>手动kill</h5><ol>
<li>Session2查看processlist</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_21.png" alt="image"></p>
<ol start="2">
<li>session2 手动kill session1连接</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_22.png" alt="image"></p>
<ol start="3">
<li>session1查看查询</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_23.png" alt="image"></p>
<h4 id="其他-2"><a href="#其他-2" class="headerlink" title="其他"></a>其他</h4><p>其他常见的错误，可以参考<a href="https://dev.mysql.com/doc/refman/5.7/en/error-lost-connection.html" target="_blank" rel="noopener">官方文档</a>，有详情的介绍，也可根据实际测试结果来验证。</p>
<h3 id="MySQL-server-has-gone-away"><a href="#MySQL-server-has-gone-away" class="headerlink" title="MySQL server has gone away"></a>MySQL server has gone away</h3><h4 id="MySQL-server-has-gone-away-1"><a href="#MySQL-server-has-gone-away-1" class="headerlink" title="MySQL server has gone away"></a>MySQL server has gone away</h4><p>设置mysql的interactive_timeout，使用mysql客户端开启一个窗口</p>
<h5 id="准备-6"><a href="#准备-6" class="headerlink" title="准备"></a>准备</h5><ol>
<li>设置interactive_timeout的值</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_24.png" alt="image"></p>
<h5 id="执行查询"><a href="#执行查询" class="headerlink" title="执行查询"></a>执行查询</h5><ol>
<li>在同一窗口内执行查询select sleep(10)</li>
</ol>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_25.png" alt="image"></p>
<ol start="2">
<li>等待超过interactive_timeout时间后，再次执行查询</li>
</ol>
<p>已经出现的错误日志：MySQL server has gone away</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_TimeOut_26.png" alt="image"></p>
<h4 id="其他-3"><a href="#其他-3" class="headerlink" title="其他"></a>其他</h4><p>其他常见的错误，可以参考<a href="https://dev.mysql.com/doc/refman/5.7/en/gone-away.html" target="_blank" rel="noopener">官方文档</a>，有详情的介绍，也可根据实际测试结果来验证。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">http:</span><span class="comment">//mysql.taobao.org/monthly/2016/07/04/</span></span><br><span class="line"><span class="symbol">http:</span><span class="comment">//mysql.taobao.org/monthly/2017/05/04/</span></span><br><span class="line"><span class="symbol">http:</span><span class="comment">//www.importnew.com/29055.html</span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//www.cnblogs.com/cchust/p/5025880.html</span></span><br><span class="line"><span class="symbol">https:</span><span class="comment">//my.oschina.net/alchemystar/blog/833598</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/MySQL启动配置文件搜索顺序解析.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/MySQL启动配置文件搜索顺序解析.html" itemprop="url">MySQL启动配置文件搜索顺序解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-20T15:12:47+08:00">
                2018-07-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h2><p>MySQL数据库支持从配置文件中读取启动选项，不用每次启动时在命令行输入，方便管理。很多选项都是以纯文本的形式存在，可以用任何的编辑器打开编辑。.mylogin.cnf文件除外，此文件包含了登录路径的选项，使用mysql_config_editor程序去创建的加密文件。</p>
<h2 id="搜索顺序"><a href="#搜索顺序" class="headerlink" title="搜索顺序"></a>搜索顺序</h2><p>MySQL默认情况下是按照一定的顺序去搜索具体路径的配置文件，并且在windows和linux的操作顺序不一样。<br>搜索顺序，按照下面表格中文件名从上往下，如果存在相同的选项，最后一个出现的选项有最高的优先级。参考官网的解释：<font color="FF0000"><b>”Options are processed in order, so if an option is specified multiple times, the last occurrence takes precedence.”</b></font></p>
<h3 id="Windows"><a href="#Windows" class="headerlink" title="Windows"></a>Windows</h3><p>在windows上，MySQL按照指定的顺序从下表中显示的文件中读取启动选项</p>
<table>
<thead>
<tr>
<th>文件名</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>%WINDIR%\my.ini, %WINDIR%\my.cnf</td>
<td>全局</td>
</tr>
<tr>
<td>C:\my.ini, C:\my.cnf</td>
<td>全局</td>
</tr>
<tr>
<td>BASEDIR\my.ini, BASEDIR\my.cnf</td>
<td>全局</td>
</tr>
<tr>
<td>defaults-extra-file</td>
<td>如果存在—default-extra-file</td>
</tr>
<tr>
<td>%APPDATA%\MySQL.mylogin.cnf</td>
<td>Login选项，仅适用于client</td>
</tr>
</tbody>
</table>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">其中，</span><br><span class="line">WINDIR表示Windows目录的位置，例如<span class="string">C:</span>\Windows</span><br><span class="line">APPDIR表示Windows应用程序数据目录</span><br><span class="line">BASEDIR表示MySQL的安装目录</span><br></pre></td></tr></table></figure>
<h3 id="Linux-or-Unix"><a href="#Linux-or-Unix" class="headerlink" title="Linux or Unix"></a>Linux or Unix</h3><p>在Linux或Unix等类Unix系统上，MySQL按照指定的顺序从下表中显示的文件中读取启动选项</p>
<table>
<thead>
<tr>
<th>文件名</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>/etc/my.cnf</td>
<td>全局</td>
</tr>
<tr>
<td>/etc/mysql/my.cnf</td>
<td>全局</td>
</tr>
<tr>
<td>SYSCONFDIR/my.cnf</td>
<td>全局</td>
</tr>
<tr>
<td>$MYSQL_HOME/my.cnf</td>
<td>仅适用于server</td>
</tr>
<tr>
<td>defaults-extra-file</td>
<td>如果存在—default-extra-file</td>
</tr>
<tr>
<td>~/.my.cnf</td>
<td>用户的选项</td>
</tr>
<tr>
<td>~/.mylogin.cnf</td>
<td>Login选项，仅适用于client</td>
</tr>
</tbody>
</table>
<figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">其中，</span><br><span class="line">~表示当前用户的主目录</span><br><span class="line">SYSCONFIGDIR表示在构建MySQL时使用SYSCONFIGDIR选项CMake的指定目录</span><br><span class="line">MySQL_HOME是一个环境变量，如果没有设置，并使用mysqld_safe启用MySQL，这时MySQL的安装目录就是其BASEDIR</span><br></pre></td></tr></table></figure>
<h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><p>生产环境一般多使用linux系统，在单实例和多实例启动时，my.cnf加载的顺序也存在不一样的情况，这里分别进行测试，对结果进行说明</p>
<h3 id="单实例"><a href="#单实例" class="headerlink" title="单实例"></a>单实例</h3><p>在不考虑SYSCONDIR，同时BASEDIR为/usr/local/mysql的情况下，从上面的搜索顺序来看，MySQL会依次加载以下的文件：</p>
<ul>
<li>/etc/my.cnf</li>
<li>/etc/mysql/my.cnf</li>
<li>/usr/local/mysql/my.cnf</li>
<li>~/.my.cnf<br>也就是说MySQL会找/etc/my.cnf这个文件，如果此文件不存在，继续找/etc/mysql/my.cnf这个文件，依此类推，最后是读取–defaults-file加载的文件，如果最后的文件也不存在，通过mysqld的帮助可以看出来:</li>
</ul>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_1.png" alt="image"></p>
<h4 id="etc-my-cnf"><a href="#etc-my-cnf" class="headerlink" title="/etc/my.cnf"></a>/etc/my.cnf</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf中只存在/etc/my.cnf时，很明显MySQL是加载的<font color="FF0000"><b>/etc/my.cnf</b></font></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_2.png" alt="image"></p>
<h4 id="etc-my-cnf-amp-amp-etc-mysql-my-cnf"><a href="#etc-my-cnf-amp-amp-etc-mysql-my-cnf" class="headerlink" title="/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf"></a>/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf中只存在/etc/my.cnf和/etc/mysql/my.cnf时，很明显MySQL是加载的<font color="FF0000"><b>/etc/mysql/my.cnf</b></font></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_3.png" alt="image"></p>
<h4 id="etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf"><a href="#etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf" class="headerlink" title="/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; /usr/local/mysql/my.cnf"></a>/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; /usr/local/mysql/my.cnf</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf中存在/etc/my.cnf和/etc/mysql/my.cnf和/usr/local/mysql/my.cnf时，很明显MySQL是加载的<font color="FF0000"><b>/usr/local/mysql/my.cnf</b></font></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_4.png" alt="image"></p>
<h4 id="etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-my-cnf"><a href="#etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-my-cnf" class="headerlink" title="/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; /usr/local/mysql/my.cnf &amp;&amp; ~/.my.cnf"></a>/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; /usr/local/mysql/my.cnf &amp;&amp; ~/.my.cnf</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，很明显MySQL是加载的<font color="FF0000"><b>~/my.cnf</b></font></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_5.png" alt="image"></p>
<h4 id="defaults-file"><a href="#defaults-file" class="headerlink" title="defaults-file"></a>defaults-file</h4><p>当指定<font color="FF0000"><b>–defaults-file为/tmp/my.cnf</b></font>时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，很明显MySQL是加载的<font color="FF0000"><b>/tmp/my.cnf</b></font></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_6.png" alt="image"></p>
<h3 id="多实例"><a href="#多实例" class="headerlink" title="多实例"></a>多实例</h3><p>多实例的启动通常使用mysqld_multi脚本，此脚本也支持–defaults-file选项。从mysqld_multi的官档上可以看出，mysqld_multi支持[mysqldN]的标签，其中N代表常量数字，此脚本是调用mysqld_safe命令是启动服务，所以支持<font color="FF0000"><b>[mysqld]标签做通用性配置文件</b></font>，适用于多个实例启动时的通用配置，也可以使用<font color="FF0000"><b>[mysqldN]，N代表特定端口做特殊性实例配置。</b></font></p>
<h4 id="etc-my-cnf-amp-amp-mysqldN"><a href="#etc-my-cnf-amp-amp-mysqldN" class="headerlink" title="/etc/my.cnf &amp;&amp; [mysqldN]"></a>/etc/my.cnf &amp;&amp; [mysqldN]</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在/etc/my.cnf加了一个<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，<font color="FF0000"><b>MySQL是加载的是/etc/my.cnf的[mysqld3306]标签配置文件</b></font></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_7.png" alt="image"></p>
<h4 id="etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-mysqldN"><a href="#etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-mysqldN" class="headerlink" title="/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; [mysqldN]"></a>/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; [mysqldN]</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在/etc/my.cnf和/etc/mysql/my.cnf加了一个<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，<font color="FF0000"><b>MySQL是加载的是/etc/mysql/my.cnf的[mysqld3306]标签配置文件</b></font></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_8.png" alt="image"></p>
<h4 id="etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-mysqldN"><a href="#etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-mysqldN" class="headerlink" title="/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf  &amp;&amp;/usr/local/mysql/my.cnf &amp;&amp; [mysqldN]"></a>/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf  &amp;&amp;/usr/local/mysql/my.cnf &amp;&amp; [mysqldN]</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在/etc/my.cnf和/etc/mysql/my.cnf和/usr/local/mysql/my.cnf加了一个<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，<font color="FF0000"><b>MySQL是加载的还是/etc/my.cnf的[mysqld3306]标签配置文件</b></font></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_9.png" alt="image"></p>
<h4 id="etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-mycf-amp-amp-mysqldN"><a href="#etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-mycf-amp-amp-mysqldN" class="headerlink" title="/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf  &amp;&amp;/usr/local/mysql/my.cnf  &amp;&amp; ~/.mycf &amp;&amp; [mysqldN]"></a>/etc/my.cnf &amp;&amp; /etc/mysql/my.cnf  &amp;&amp;/usr/local/mysql/my.cnf  &amp;&amp; ~/.mycf &amp;&amp; [mysqldN]</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在全部配置了<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，<font color="FF0000"><b>MySQL是加载的是~/my.cnf的[mysqld3306]标签配置文件</b></font></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_10.png" alt="image"></p>
<h4 id="defaults-file-amp-amp-mysqldN"><a href="#defaults-file-amp-amp-mysqldN" class="headerlink" title="defaults-file &amp;&amp; [mysqldN]"></a>defaults-file &amp;&amp; [mysqldN]</h4><p>当<font color="FF0000"><b>指定–defaults-file为/tmp/my.cnf</b></font>时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在了<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在全部配置了了<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，了<font color="FF0000"><b>MySQL是加载的是/tmp/my.cnf的[mysqld3306]标签配置文件</b></font></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_11.png" alt="image"></p>
<h4 id="defaults-file-1"><a href="#defaults-file-1" class="headerlink" title="defaults-file"></a>defaults-file</h4><p>当<font color="FF0000"><b>指定–defaults-file为/tmp/my.cnf</b></font>时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，全部<font color="FF0000"><b>未配置</b></font>了[mysqld3306]标签，这时候，<font color="FF0000"><b>MySQL是加载的是~/my.cnf的配置文件而不是加载的/tmp/my.cnf的配置文件，说明mysqld_multi不加载除默认搜索的配置文件外的其他[mysqld]标签</b></font></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_12.png" alt="image"></p>
<h2 id="启动方式"><a href="#启动方式" class="headerlink" title="启动方式"></a>启动方式</h2><p>MySQL的启动包括多种，包括以下几种：</p>
<ul>
<li>/usr/local/mysql/bin/mysqld –defaults-file=/etc/my.cnf –basedir=/usr/local/mysql –datadir=/opt/mysql/data –user=mysql</li>
<li>/usr/local/mysql/bin/mysqld_safe –defaults-file=/etc/my.cnf –basedir=/usr/local/mysql –datadir=/opt/mysql/data –user=mysql</li>
<li>/etc/init.d/mysqld start &amp;&amp; service mysqld start</li>
<li>mysqld_multi start<h3 id="service-mysqld-start"><a href="#service-mysqld-start" class="headerlink" title="service mysqld start"></a>service mysqld start</h3>service mysqld start的启动有一个要注意的地方，它不会加载~/.my.cnf，实验如下，很明显，部<font color="FF0000"><b>service mysqld start启动方式不加载~/.my.cnf的参数</b></font></li>
</ul>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_13.png" alt="image"></p>
<h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">由于linux的service启动服务的方式是调用的<span class="regexp">/sbin/</span>service脚本来进行管理的，并且<span class="regexp">/sbin/</span>service脚本是shell编写的，可以通过debug的模式来查看具体执行过程</span><br></pre></td></tr></table></figure>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_14.png" alt="image"><br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">通过上面的执行过程可以了解到，service mysqld start启动mysql的方式，实际最终调用的命令为：</span><br><span class="line">env -i PATH=<span class="string">/sbin</span>:<span class="string">/usr/sbin</span>:<span class="string">/bin</span>:<span class="string">/usr/bin</span> TERM=linux SYSTEMCTL_IGNORE_DEPENDENCIES= SYSTEMCTL_SKIP_REDIRECT= <span class="string">/etc/init.d/mysqld</span> start</span><br><span class="line">此命令没有包含<span class="string">/home/mysql</span>的环境变量，如果修改为以下命令，则可以加载~<span class="string">/.my.cnf</span></span><br><span class="line">命令为：</span><br><span class="line">env -i PATH=<span class="string">/sbin</span>:<span class="string">/usr/sbin</span>:<span class="string">/bin</span>:<span class="string">/usr/bin</span> HOME=<span class="string">/home/mysql</span> TERM=linux SYSTEMCTL_IGNORE_DEPENDENCIES= SYSTEMCTL_SKIP_REDIRECT= <span class="string">/etc/init.d/mysqld</span> start</span><br></pre></td></tr></table></figure></p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>从脚本/sbin/service的最下面部分可以看出，具体的启动命令，如果想修改为让service mysqld start的启动方式也能搜索~/.my.cnf的参数，可以修改具体的脚本，添加了一个if else判断条件，如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">将脚本/sbin/service的第81行的原始命令：</span><br><span class="line">env -i <span class="attribute">PATH</span>=<span class="string">"<span class="variable">$PATH</span>"</span> <span class="attribute">TERM</span>=<span class="string">"<span class="variable">$TERM</span>"</span> <span class="attribute">SYSTEMCTL_IGNORE_DEPENDENCIES</span>=<span class="variable">$&#123;SYSTEMCTL_IGNORE_DEPENDENCIES&#125;</span> <span class="attribute">SYSTEMCTL_SKIP_REDIRECT</span>=<span class="variable">$&#123;SYSTEMCTL_SKIP_REDIRECT&#125;</span> <span class="string">"<span class="variable">$&#123;SERVICEDIR&#125;</span>/<span class="variable">$&#123;SERVICE&#125;</span>"</span> <span class="variable">$&#123;ACTION&#125;</span> <span class="variable">$&#123;OPTIONS&#125;</span></span><br><span class="line">修改为</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;SERVICE&#125;</span>"</span> = <span class="string">"mysqld"</span> ]; then</span><br><span class="line">      env -i <span class="attribute">PATH</span>=<span class="string">"<span class="variable">$PATH</span>"</span> <span class="attribute">HOME</span>=/home/mysql <span class="attribute">TERM</span>=<span class="string">"<span class="variable">$TERM</span>"</span> <span class="attribute">SYSTEMCTL_IGNORE_DEPENDENCIES</span>=<span class="variable">$&#123;SYSTEMCTL_IGNORE_DEPENDENCIES&#125;</span> <span class="attribute">SYSTEMCTL_SKIP_REDIRECT</span>=$&#123;SYSTEMCTL_SKIP_REDIREC</span><br><span class="line">T&#125; <span class="string">"<span class="variable">$&#123;SERVICEDIR&#125;</span>/<span class="variable">$&#123;SERVICE&#125;</span>"</span> <span class="variable">$&#123;ACTION&#125;</span> <span class="variable">$&#123;OPTIONS&#125;</span></span><br><span class="line">   <span class="keyword">else</span></span><br><span class="line">      env -i <span class="attribute">PATH</span>=<span class="string">"<span class="variable">$PATH</span>"</span> <span class="attribute">TERM</span>=<span class="string">"<span class="variable">$TERM</span>"</span> <span class="attribute">SYSTEMCTL_IGNORE_DEPENDENCIES</span>=<span class="variable">$&#123;SYSTEMCTL_IGNORE_DEPENDENCIES&#125;</span> <span class="attribute">SYSTEMCTL_SKIP_REDIRECT</span>=<span class="variable">$&#123;SYSTEMCTL_SKIP_REDIRECT&#125;</span> <span class="string">"<span class="variable">$&#123;SERVICEDIR&#125;</span>/<span class="variable">$&#123;SERVICE&#125;</span>"</span> <span class="variable">$&#123;ACTION&#125;</span> <span class="variable">$&#123;OPTIONS&#125;</span></span><br><span class="line">   fi</span><br></pre></td></tr></table></figure></p>
<p>如下：</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_15.png" alt="image"></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_16.png" alt="image"><br><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_17.png" alt="image"></p>
<p>修改后的脚本启动一下测试，查看已经满足需求</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/MySQL_mycnf_18.png" alt="image"></p>
<h3 id="mysqld-multi-start"><a href="#mysqld-multi-start" class="headerlink" title="mysqld_multi start"></a>mysqld_multi start</h3><p>当mysqld_multi方式指定–defaults-file的参数文件时，不加载除默认搜索顺序以外的[mysqld]标签，也可以做下debug，mysqld_multi是perl脚本，可能通过perl -d script的方式进行调试，这里不再展示。</p>
<h2 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h2><p>通过以上的的测试，得出以下结论<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>	默认情况前三种启动方式下，[mysqld]标签以按照<span class="regexp">/etc/</span>my.cnf，<span class="regexp">/etc/</span>mysql<span class="regexp">/my.cnf，/</span>usr<span class="regexp">/local/</span>mysql<span class="regexp">/my.cnf，~/</span>.my.cnf，--defaults-file搜索顺序加载</span><br><span class="line"><span class="number">2.</span>	mysqld_mutli启动方式，[mysqldN]标签也是按照<span class="regexp">/etc/</span>my.cnf，<span class="regexp">/etc/</span>mysql<span class="regexp">/my.cnf，/</span>usr<span class="regexp">/local/</span>mysql<span class="regexp">/my.cnf，~/</span>.my.cnf，--defaults-file搜索顺序加载。但是，[mysqld]标签只按照<span class="regexp">/etc/</span>my.cnf，<span class="regexp">/etc/</span>mysql<span class="regexp">/my.cnf，/</span>usr<span class="regexp">/local/</span>mysql<span class="regexp">/my.cnf，~/</span>.my.cnf搜索顺序加载，不加载--defaults-file的配置</span><br><span class="line"><span class="number">3.</span>	service mysqld start启动方式，默认不加载~/.my.cnf文件，需要修改脚本才能让其支持搜索</span><br><span class="line"><span class="number">4.</span>	当找不到<span class="regexp">/etc/</span>my.cnf，<span class="regexp">/etc/</span>mysql<span class="regexp">/my.cnf，/</span>usr<span class="regexp">/local/</span>mysql<span class="regexp">/my.cnf，~/</span>.my.cnf，--defaults-file的配置时，默认编译的mysql，参数是全部其默认值，数据目录保存在BASEDIR下的data目录。比如，BASEDIR为<span class="regexp">/usr/</span>local<span class="regexp">/mysql，则DATADIR为/</span>usr<span class="regexp">/local/</span>mysql/data，上面没有实验这一项</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/pt-kill-使用教程.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/pt-kill-使用教程.html" itemprop="url">pt-kill 使用教程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-17T15:08:23+08:00">
                2018-07-17
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工具/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>pt-kill 是一个优秀的kill MySQL连接的工具,是percona toolkit的一部分,使用perl语言编写.简单高效.能够按照一定的规则匹配kill掉MySQL中的连接,达到有效保护服务的目的.</p>
<h2 id="用途"><a href="#用途" class="headerlink" title="用途"></a>用途</h2><p>pt-kill主要适用于MySQL实例中异常出现的会话导致整个实例负载过高,甚至出现不可用的情况下,进而影响应用,影响业务的场景.包括以下:</p>
<ul>
<li>手动维护MySQL连接,比如连接突然飙高</li>
<li>自动维护MySQL连接,为了减小对业务的影响,结合定时任务,自动检测匹配超过一定阈值时间的查询,kill掉,保护实例的正常运行</li>
</ul>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>pt-kill的工作原理是连接到MySQL并从show processlist获取查询并进行过滤,然后执行kill或print操作</p>
<h3 id="general-log"><a href="#general-log" class="headerlink" title="general_log"></a>general_log</h3><p>通过开启mysql的general_log，观察pt-kill执行的语句：<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">2018<span class="string">-07</span><span class="string">-16</span>T08:25:26.764023<span class="string">+08</span>:00	  412 Connect	root@localhost on  using TCP/IP</span><br><span class="line">2018<span class="string">-07</span><span class="string">-16</span>T08:25:26.839130<span class="string">+08</span>:00	  412 Query	SHOW VARIABLES LIKE 'wait\_timeout'</span><br><span class="line">2018<span class="string">-07</span><span class="string">-16</span>T08:25:26.936724<span class="string">+08</span>:00	  412 Query	SET SESSION wait_timeout=10000</span><br><span class="line">2018<span class="string">-07</span><span class="string">-16</span>T08:25:26.937101<span class="string">+08</span>:00	  412 Query	SELECT @@SQL_MODE</span><br><span class="line">2018<span class="string">-07</span><span class="string">-16</span>T08:25:26.937323<span class="string">+08</span>:00	  412 Query	SET @@SQL_QUOTE_SHOW_CREATE = 1/*!40101, @@SQL_MODE='NO_AUTO_VALUE_ON_ZERO,ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'*/</span><br><span class="line">2018<span class="string">-07</span><span class="string">-16</span>T08:25:26.937534<span class="string">+08</span>:00	  412 Query	SELECT @@server_id /*!50038 , @@hostname*/</span><br><span class="line">2018<span class="string">-07</span><span class="string">-16</span>T08:25:26.938054<span class="string">+08</span>:00	  412 Query	SHOW FULL PROCESSLIST</span><br><span class="line">2018<span class="string">-07</span><span class="string">-16</span>T08:25:27.938917<span class="string">+08</span>:00	  412 Query	SHOW FULL PROCESSLIST</span><br></pre></td></tr></table></figure></p>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><p>pt-kill [OPTIONS] [DSN] </p>
<p>pt-kill杀死MySQL连接。如果没有给出文件，pt-kill连接到MySQL然后从”SHOW PROCESSLIST”命令输出中获取查询。否则，就从包含有”SHOW PROCESSLIST”输出的一个或者多个文件中读取查询。如果文件是” - “，pt-kill从STDIN读取输入。</p>
<p>1.kill执行时间超过60s的查询<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-<span class="built_in">kill</span> --busy-<span class="built_in">time</span> <span class="number">60</span> --<span class="built_in">kill</span></span><br></pre></td></tr></table></figure></p>
<p>2.条件同上，但是只print不kill<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-<span class="built_in">kill</span> --busy-<span class="built_in">time</span> <span class="number">60</span> --<span class="built_in">print</span></span><br></pre></td></tr></table></figure></p>
<p>3.每10s检查sleep进程并kill<br><figure class="highlight brainfuck"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">pt</span><span class="literal">-</span><span class="comment">kill</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">match</span><span class="literal">-</span><span class="comment">command</span> <span class="comment">Sleep</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">kill</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">victims</span> <span class="comment">all</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">interval</span> <span class="comment">10</span></span><br></pre></td></tr></table></figure></p>
<p>4.打印所有的登录进程<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pt</span>-kill --<span class="keyword">match</span>-state login --<span class="keyword">print</span> --victims <span class="keyword">all</span></span><br></pre></td></tr></table></figure></p>
<p>5.查看当前进程列表中的查询匹配<br><figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -e <span class="string">"SHOW PROCESSLIST"</span> &gt; proclist.txt</span><br><span class="line">pt-kill --test-matching proclist<span class="selector-class">.txt</span> --busy-<span class="selector-tag">time</span> <span class="number">60</span> --print</span><br></pre></td></tr></table></figure></p>
<h2 id="风险"><a href="#风险" class="headerlink" title="风险"></a>风险</h2><p>Percona Toolkit已经成熟，并得到了验证，并经过了充分测试，但所有数据库工具都可能对系统和数据库服务器造成风险，在使用此工具前注意:</p>
<ul>
<li>阅读工具的文档</li>
<li>查看工具已知的bug列表</li>
<li>在非生产服务器上测试</li>
<li>备份生产服务器并验证备份有效性</li>
</ul>
<h2 id="描述"><a href="#描述" class="headerlink" title="描述"></a>描述</h2><p>pt-kill从”SHOW PROCESSLIST”中捕捉查询，筛选，然后kill或者print，被称为“慢查询狙击手”。</p>
<p>pt-kill一般连接到MySQL从”SHOW PROCESSLIST”里获取查询。或者也可以从文件里面读取”SHOW PROCESSLIST”的输出结果。在这种情况下，pt-kill不会连接到MySQL，”–kill”选项也不会起作用。当读取文件时需要用”–print”选项，通过结合”–test-matching”选项读取文件，进行测试，为了保证匹配规则的正确性。特殊情况下要考虑，例如“不kill复制线程”等。</p>
<p>其中，选项–busy-time和–victims比较重要。</p>
<ul>
<li>首先,从”SHOW PROCESSLIST”里匹配对应的结果,比如–match-command规则去匹配command值, –busy-time去匹配time时间</li>
<li>其次, –victims控制从每个类别里面匹配的哪些查询会被kill,默认最长时间的查询优先被kill</li>
</ul>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>至少需要指定一个–kill,–kill-query,–print,–execute-command和–stop,其中以下参数是互斥的</p>
<ul>
<li>–any-busy-time和–each-busy-time</li>
<li>–kill和–kill-query</li>
<li>–daemonize和–test-matching</li>
</ul>
<h3 id="option选项"><a href="#option选项" class="headerlink" title="option选项"></a>option选项</h3><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>–ask-pass</td>
<td>连接MySQL时提示输入密码</td>
</tr>
<tr>
<td>–charset</td>
<td>默认字符集</td>
</tr>
<tr>
<td>–config</td>
<td>指定配置配置文件</td>
</tr>
<tr>
<td>–create-log-table</td>
<td>如果表–log-dsn不存在,则创建此表</td>
</tr>
<tr>
<td>–daemonize</td>
<td>后台进行进程</td>
</tr>
<tr>
<td>–database</td>
<td>连接的数据库</td>
</tr>
<tr>
<td>–defaults-file</td>
<td>从指定的文件读取mysql参数</td>
</tr>
<tr>
<td>–filter</td>
<td>丢弃Perl代码不返回true的事件</td>
</tr>
<tr>
<td>–group-by</td>
<td>将show processlist的匹配分组, 还可以匹配fingerprint查询，通过该查询对Info列中的SQL查询进行抽象</td>
</tr>
<tr>
<td>–help</td>
<td>显示帮助</td>
</tr>
<tr>
<td>–host</td>
<td>连接的主机</td>
</tr>
<tr>
<td>–interval</td>
<td>匹配查询的频繁,如果busy-time未指定,默认为30s</td>
</tr>
<tr>
<td>–log</td>
<td>守护进程日志输出文件</td>
</tr>
<tr>
<td>–log-dsn</td>
<td>将kill的结果存储到表中,传入的dsn必须包括库和表选项,表结构如下,也适用于–create-log-table选项<br>CREATE TABLE kill_log (<br>   kill_id     int(10) unsigned NOT NULL AUTO_INCREMENT,<br>   server_id   bigint(4) NOT NULL DEFAULT ‘0’,<br>   timestamp   DATETIME,<br>   reason      TEXT,<br>   kill_error  TEXT,<br>   Id          bigint(4) NOT NULL DEFAULT ‘0’,<br>   User        varchar(16) NOT NULL DEFAULT ‘’,<br>   Host        varchar(64) NOT NULL DEFAULT ‘’,<br>   db          varchar(64) DEFAULT NULL,<br>   Command     varchar(16) NOT NULL DEFAULT ‘’,<br>   Time        int(7) NOT NULL DEFAULT ‘0’,<br>   State       varchar(64) DEFAULT NULL,<br>   Info        longtext,<br>   Time_ms     bigint(21) DEFAULT ‘0’, # NOTE, TODO: currently not used<br>   PRIMARY KEY (kill_id)<br>) DEFAULT CHARSET=utf8<br></td>
</tr>
<tr>
<td>–password</td>
<td>连接的密码</td>
</tr>
<tr>
<td>–pid</td>
<td>连接的pid</td>
</tr>
<tr>
<td>–port</td>
<td>连接的端口</td>
</tr>
<tr>
<td>–query-id</td>
<td>打印被kill的query id</td>
</tr>
<tr>
<td>–rds</td>
<td>连接到aws rds,rds不能使用–kill和–kill-query选项,改为用函数调用.<br>–kill使用CALL mysql.rds_kill(thread-id)<br>–kill-query使用CALL mysql.rds_kill_query(thread-id)</td>
</tr>
<tr>
<td>–run-time</td>
<td>退出前要运行多长时间,默认pt-kill会一直运行,直到进程被创建的–sentinel文件而触发终止</td>
</tr>
<tr>
<td>–sentinel</td>
<td>如果此文件存在,则pt-kill进程退出</td>
</tr>
<tr>
<td>–slave-user</td>
<td>连接到从库的用户</td>
</tr>
<tr>
<td>–slave-password</td>
<td>连接到从库的密码</td>
</tr>
<tr>
<td>–set-vars</td>
<td>设置mysql的变量,多个变量用逗号分割</td>
</tr>
<tr>
<td>–socket</td>
<td>连接的socket</td>
</tr>
<tr>
<td>–stop</td>
<td>通过创建–sentinel文件停止运行</td>
</tr>
<tr>
<td>–[no]strip-comments</td>
<td>从info查询中删除sql注释</td>
</tr>
<tr>
<td>–user</td>
<td>连接的用户名</td>
</tr>
<tr>
<td>–version</td>
<td>显示版本</td>
</tr>
<tr>
<td>–[no]version-check</td>
<td>检查Toolkit，MySQL和其他程序的最新版本</td>
</tr>
<tr>
<td>–victims</td>
<td>控制从每个类别里面匹配的哪些查询会被kill,包括以下:<br>Oldest:只kil最长的查询,防止误kill<br>All:kill所有<br>All-but-oldest:除最长的查询外,kill 所有</td>
</tr>
<tr>
<td>–wait-after-kill</td>
<td>Kill一个查询后等待时长</td>
</tr>
<tr>
<td>–wait-before-kill</td>
<td>在终止查询之前等待时长</td>
</tr>
</tbody>
</table>
<h3 id="过滤匹配"><a href="#过滤匹配" class="headerlink" title="过滤匹配"></a>过滤匹配</h3><p>这些选项用于过滤匹配查询规则,如果查询不匹配,不会将其删除,如果使用ignore选项,其有最高优先级,默认所有的匹配是区分大小写的,可以通过正则表达式不区分大小写(?i-xsm:select)</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>–busy-time</td>
<td>匹配运行超过此值的查询,此时command=query时生效</td>
</tr>
<tr>
<td>–idle-time</td>
<td>Sleep超过此值的查询,此时command=sleep时生效</td>
</tr>
<tr>
<td>–ignore-command</td>
<td>忽略command的perl正则表达式的查询</td>
</tr>
<tr>
<td>–ignore-db</td>
<td>忽略db的perl正则表达式的查询</td>
</tr>
<tr>
<td>–ignore-host</td>
<td>忽略host的perl正则表达式的查询</td>
</tr>
<tr>
<td>–ignore-info</td>
<td>忽略info的perl正则表达式的查询</td>
</tr>
<tr>
<td>–[no]ignore-self</td>
<td>不kill pt-kill自己的连接,默认为yes</td>
</tr>
<tr>
<td>–ignore-state</td>
<td>忽略state的perl正则表达式的查询</td>
</tr>
<tr>
<td>–ignore-user</td>
<td>忽略user的perl正则表达式的查询</td>
</tr>
<tr>
<td>–match-all</td>
<td>匹配所有未ignore的查询,如未指定ignore,则所有的查询都匹配</td>
</tr>
<tr>
<td>–match-command</td>
<td>匹配command的perl正则表达式的查询,常用command包括:<br>Query<br>Sleep<br>Binlog Dump<br>Connect<br>Delayed insert<br>Execute<br>Fetch<br>Init DB<br>Kill<br>Prepare<br>Processlist<br>Quit<br>Reset stmt<br>Table Dump</td>
</tr>
<tr>
<td>–match-db</td>
<td>匹配db的perl正则表达式的查询</td>
</tr>
<tr>
<td>–match-host</td>
<td>匹配host的perl正则表达式的查询,也支持host:port模式</td>
</tr>
<tr>
<td>–match-info</td>
<td>匹配info的perl正则表达式的查询</td>
</tr>
<tr>
<td>–match-state</td>
<td>匹配state的perl正则表达式的查询,常用state包括:<br>Locked<br>login<br>copy to tmp table<br>Copying to tmp table<br>Copying to tmp table on disk<br>Creating tmp table<br>executing<br>Reading from net<br>Sending data<br>Sorting for order<br>Sorting result<br>Table lock<br>Updating</td>
</tr>
<tr>
<td>–match-user</td>
<td>匹配user的perl正则表达式的查询</td>
</tr>
<tr>
<td>–replication-threads</td>
<td>允许匹配复制线程</td>
</tr>
<tr>
<td>–test-matching</td>
<td>用于测试匹配,此选项禁用了–run-time,–interval和–[no]ignore-self</td>
</tr>
</tbody>
</table>
<h3 id="匹配所有"><a href="#匹配所有" class="headerlink" title="匹配所有"></a>匹配所有</h3><p>这些匹配适用于所有查询,通过指定–group-by来创建组,如未指定,会匹配所有组</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>–any-busy-time</td>
<td>任何查询超过此值则匹配查询,如为10,则至少有一个查询时长超过10,才会匹配</td>
</tr>
<tr>
<td>–each-busy-time</td>
<td>每个查询超过些值则匹配查询,如为10,则只有在每个查询时长超过10,才会匹配</td>
</tr>
<tr>
<td>–query-count</td>
<td>至少有这么多查询才匹配</td>
</tr>
<tr>
<td>–verbose</td>
<td>打印正在完成的工作信息</td>
</tr>
</tbody>
</table>
<h3 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h3><p>对所有的匹配查询采取的操作,默认顺序为–print,–execute-command,–kill/–kill-query.它允许–execute-command查看–print和–kill/–kill-query的输出,默认pt-kill不会传递任何信息.</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>–execute-command</td>
<td>查询匹配时执行此命令</td>
</tr>
<tr>
<td>–kill</td>
<td>终止连接并退出</td>
</tr>
<tr>
<td>–kill-busy-commands</td>
<td>逗号运行命令列表,如果运行超过–busy-time,会被kill,默认query<br>例如:–kill-busy-commands=Query,Execute</td>
</tr>
<tr>
<td>–kill-query</td>
<td>只杀掉连接执行的语句，线程会被终止</td>
</tr>
<tr>
<td>–print</td>
<td>打印匹配查询的KILL语句</td>
</tr>
</tbody>
</table>
<h3 id="DSN选项"><a href="#DSN选项" class="headerlink" title="DSN选项"></a>DSN选项</h3><p>这些选项选用于创建DSN,每个选项都给出了option=value,选项区分大小写</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>dsn: charset; copy: yes 默认字符集</td>
</tr>
<tr>
<td>D</td>
<td>dsn: database; copy: yes 默认数据库</td>
</tr>
<tr>
<td>F</td>
<td>dsn: mysql_read_default_file; copy: yes 仅从指定文件读取参数</td>
</tr>
<tr>
<td>h</td>
<td>dsn: host; copy: yes 连接的host</td>
</tr>
<tr>
<td>p</td>
<td>dsn: password; copy: yes 连接的密码</td>
</tr>
<tr>
<td>P</td>
<td>dsn: port; copy: yes 连接的端口</td>
</tr>
<tr>
<td>S</td>
<td>dsn: mysql_socket; copy: yes 连接的socket</td>
</tr>
<tr>
<td>u</td>
<td>dsn: user; copy: yes 连接的用户</td>
</tr>
<tr>
<td>t</td>
<td>记录操作的表,通过–log-dsn指定</td>
</tr>
</tbody>
</table>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><p>通过测试用例来展示pt-kill的规则及其优秀的工作能力,构造一个测试环境,使用sysbench来做mysql的压力测试,在测试过程中通过pt-kill来匹配规则并kill</p>
<h3 id="测试匹配"><a href="#测试匹配" class="headerlink" title="测试匹配"></a>测试匹配</h3><p>1.查看当前进程列表添加到proclist.txt文件<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="symbol">mysql</span> -S /<span class="meta">opt</span>/mysql3306/<span class="meta">data</span>/mysql3306.sock -e <span class="string">"SHOW PROCESSLIST"</span> &gt; proclist.txt</span><br></pre></td></tr></table></figure></p>
<p>2.查看proclist.txt文件内容</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/pt_kill1.png" alt="image"></p>
<p>3.通过pt-kill匹配测试查询<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--test-matching</span> proclist.txt <span class="params">--match-command=</span><span class="string">"Query"</span>   <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--match-state=</span><span class="string">"Sending data"</span> <span class="params">--print</span></span><br></pre></td></tr></table></figure></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/pt_kill2.png" alt="image"></p>
<p>可以看出测试匹配出了3个command为Query,state为Sending data的sql语句,并且kill的id与show processlist中的id对应</p>
<h3 id="Host匹配查询"><a href="#Host匹配查询" class="headerlink" title="Host匹配查询"></a>Host匹配查询</h3><p>1.通过pt-kill连接host匹配并打印出来<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-host=</span><span class="string">"127.0.0.1"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br></pre></td></tr></table></figure></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/pt_kill3.png" alt="image"></p>
<p>仅匹配了host为127.0.0.1,并且未指定其他匹配,从输出上看command为Query,Sleep都打印了出来</p>
<h3 id="DB匹配查询"><a href="#DB匹配查询" class="headerlink" title="DB匹配查询"></a>DB匹配查询</h3><p>1.通过pt-kill连接db匹配并打印出来<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-db=</span><span class="string">"sysbench"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br></pre></td></tr></table></figure></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/pt_kill4.png" alt="image"></p>
<p>仅匹配了db为sysbench,并且未指定其他匹配,从输出上看command为Query,Sleep都打印了出来</p>
<h3 id="USER匹配查询"><a href="#USER匹配查询" class="headerlink" title="USER匹配查询"></a>USER匹配查询</h3><p>1.通过pt-kill连接user匹配并打印出来<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-user=</span><span class="string">"root"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br></pre></td></tr></table></figure></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/pt_kill5.png" alt="image"></p>
<p>仅匹配了user为root,并且未指定其他匹配,从输出上看command为Query,Sleep都打印了出来</p>
<h3 id="Command匹配查询"><a href="#Command匹配查询" class="headerlink" title="Command匹配查询"></a>Command匹配查询</h3><p>1.通过pt-kill连接command匹配并打印出来,分别打印c<br>mmand只包括Sleep和包括Sleep及Query的示例<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-command=</span><span class="string">"Sleep"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-command=</span><span class="string">"Sleep|Query"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br></pre></td></tr></table></figure></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/pt_kill6.png" alt="image"></p>
<p>当command匹配为Sleep时,只打印了command为Sleep的匹配查询<br><br>当command匹配为Sleep和Query时,打印了command为Sleep和Query的匹配查询<br></p>
<font color="FF000">多个条件匹配时,用|分割</font>

<h3 id="State匹配查询"><a href="#State匹配查询" class="headerlink" title="State匹配查询"></a>State匹配查询</h3><p>1.通过pt-kill连接state匹配并打印出来,分别打印state只包括starting和包括starting及Creating sort index和包括Creating sort index及Sending data的示例<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-state=</span><span class="string">"starting"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-state=</span><span class="string">"starting|Creating sort index"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-state=</span><span class="string">"Creating sort index|Sending data"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br></pre></td></tr></table></figure></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/pt_kill7.png" alt="image"></p>
<p>当state匹配为starting时,只打印了state为starting的匹配查询<br><br>当state匹配为starting和Creating sort index时,打印了state为starting和Creating sort index的匹配查询<br><br>当state匹配为Creating sort index和Sending data时,打印了state为Creating sort index和Sending data的匹配查询</p>
<h3 id="Info匹配查询"><a href="#Info匹配查询" class="headerlink" title="Info匹配查询"></a>Info匹配查询</h3><p>1.通过pt-kill连接info匹配并打印出来,分别打印info只包括COMMIT和只包括SELECT和包括COMMIT及SELECT的示例<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-info=</span><span class="string">"COMMIT"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-info=</span><span class="string">"SELECT|COMMIT"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-info=</span><span class="string">"SELECT"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br></pre></td></tr></table></figure></p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/pt_kill8.png" alt="image"></p>
<p>当info匹配为COMMIT时,只打印了info为starting的匹配查询<br><br>当info匹配为SELECT时,只打印了info为SELECT的匹配查询<br><br>当info匹配为COMMIT和SELECT时,打印了info为SELECT和COMMIT的匹配查询</p>
<h3 id="组合匹配查询"><a href="#组合匹配查询" class="headerlink" title="组合匹配查询"></a>组合匹配查询</h3><p>1.通过pt-kill连接匹配规则如下</p>
<ul>
<li>匹配host为127.0.0.1</li>
<li>匹配user为root</li>
<li>匹配db为sysbench</li>
<li>匹配command为Query</li>
<li>匹配state为Opening tables</li>
<li>匹配info为SELECT<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-host=</span><span class="string">"127.0.0.1"</span> <span class="params">--match-user=</span><span class="string">"root"</span> <span class="params">--match-db=</span><span class="string">"sysbench"</span> <span class="params">--match-command=</span><span class="string">"Query"</span> <span class="params">--match-state=</span><span class="string">"Opening tables"</span> <span class="params">--match-info=</span><span class="string">"SELECT"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://qanp7f2om.bkt.clouddn.com/pt_kill9.png" alt="image"></p>
<p>只有匹配上面所有的条件,才会打印出来匹配的SQL详情</p>
<h3 id="Ignore忽略匹配"><a href="#Ignore忽略匹配" class="headerlink" title="Ignore忽略匹配"></a>Ignore忽略匹配</h3><p>1.通过pt-kill连接匹配规则如下</p>
<ul>
<li>匹配host为127.0.0.1</li>
<li>忽略匹配info为SELECT<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-host=</span><span class="string">"127.0.0.1"</span> <span class="params">--ignore-info=</span><span class="string">"SELECT"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://qanp7f2om.bkt.clouddn.com/pt_kill10.png" alt="image"></p>
<p>当指定ignore时,ignore具有最高的优先级,再去匹配其他规则</p>
<h3 id="DSN匹配查询"><a href="#DSN匹配查询" class="headerlink" title="DSN匹配查询"></a>DSN匹配查询</h3><p>1.通过pt-kill连接匹配,结合ignore并打印出来,同时记录到DNS表中,规则如下</p>
<ul>
<li>匹配host为127.0.0.1</li>
<li>匹配user为root</li>
<li>匹配db为sysbench</li>
<li>匹配command为Query</li>
<li>匹配state为Opening tables</li>
<li>匹配info为SELECT</li>
<li>忽略匹配info为update<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--log-dsn</span> D=test,t=kill_log <span class="params">--create-log-table</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-host=</span><span class="string">"127.0.0.1"</span> <span class="params">--match-user=</span><span class="string">"root"</span> <span class="params">--match-db=</span><span class="string">"sysbench"</span> <span class="params">--match-command=</span><span class="string">"Query"</span> <span class="params">--match-state=</span><span class="string">"Sending data"</span> <span class="params">--match-info=</span><span class="string">"SELECT"</span> <span class="params">--ignore-info=</span>”update” <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--kill-query</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<p><img src="http://qanp7f2om.bkt.clouddn.com/pt_kill11.png" alt="image"></p>
<p>2.结果分析<br><br>只有匹配上面所有的条件,才会将kill的SQL详情保存在test库下的kill_log表中,DSN模式下使用print不会记录到表kill_log中</p>
<p>3.Kill_log表结构</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/pt_kill12.png" alt="image"></p>
<p>4.kill_log表记录</p>
<p><img src="http://qanp7f2om.bkt.clouddn.com/pt_kill13.png" alt="image"></p>
<h2 id="建议"><a href="#建议" class="headerlink" title="建议"></a>建议</h2><h3 id="方法推荐"><a href="#方法推荐" class="headerlink" title="方法推荐"></a>方法推荐</h3><ul>
<li>推荐使用组合匹配加上ignore模式精确匹配,减小误操作的几率</li>
<li>先测试再执行,推荐用print方法,也可使用–test-matching方法</li>
<li>推荐使用DSN模式,能够记录pt-kill的历史记录,方便分析,追溯</li>
<li>推荐使用–kill-query替代–kill,–kill-query对应用更友好</li>
<li>推荐使用后台进程方式–daemonize结合–run-time使用</li>
</ul>
<h3 id="语句推荐"><a href="#语句推荐" class="headerlink" title="语句推荐"></a>语句推荐</h3><p>1.查询推荐<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--log-dsn</span> D=test,t=kill_log <span class="params">--create-log-table</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-host=</span><span class="string">"127.0.0.1|localhost"</span> <span class="params">--match-user=</span><span class="string">"root"</span> <span class="params">--match-db=</span><span class="string">"sysbench|test"</span> <span class="params">--match-command=</span><span class="string">"Query"</span> <span class="params">--match-state=</span><span class="string">"Sending data|User sleep"</span> <span class="params">--match-info=</span><span class="string">"(?i-xsm:select)"</span> <span class="params">--ignore-info=</span><span class="string">"(?i-smx:^insert|^update|^delete|^load)"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br></pre></td></tr></table></figure></p>
<ol start="2">
<li>kill语句保存到DSN并输出到log<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--log-dsn</span> D=test,t=kill_log <span class="params">--create-log-table</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-host=</span><span class="string">"127.0.0.1|localhost"</span> <span class="params">--match-user=</span><span class="string">"root"</span> <span class="params">--match-db=</span><span class="string">"sysbench|test"</span> <span class="params">--match-command=</span><span class="string">"Query"</span> <span class="params">--match-state=</span><span class="string">"Sending data|User sleep"</span> <span class="params">--match-info=</span><span class="string">"(?i-xsm:select)"</span> <span class="params">--ignore-info=</span><span class="string">"(?i-smx:^insert|^update|^delete|^load)"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--kill-query</span> <span class="params">--daemonize</span> <span class="params">--print</span> <span class="params">--log=/tmp/pt-kill</span>.log</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>3.kill语句仅输出到log<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--host</span> 127.0.0.1 <span class="params">--port</span> 3306 <span class="params">--user</span> root <span class="params">--password</span> 111111 <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql3306.sock</span> <span class="params">--match-host=</span><span class="string">"127.0.0.1|localhost"</span> <span class="params">--match-user=</span><span class="string">"root"</span> <span class="params">--match-db=</span><span class="string">"sysbench|test"</span> <span class="params">--match-command=</span><span class="string">"Query"</span> <span class="params">--match-state=</span><span class="string">"Sending data|User sleep"</span> <span class="params">--match-info=</span><span class="string">"(?i-xsm:select)"</span> <span class="params">--ignore-info=</span><span class="string">"(?i-smx:^insert|^update|^delete|^load)"</span> <span class="params">--victim</span> all <span class="params">--interval</span> 1  <span class="params">--kill-query</span> <span class="params">--daemonize</span> <span class="params">--print</span> <span class="params">--log=/tmp/pt-kill</span>.log</span><br></pre></td></tr></table></figure></p>
<h3 id="生产环境"><a href="#生产环境" class="headerlink" title="生产环境"></a>生产环境</h3><p>当生产出现并发队列高导致cpu高时，查看如果为查询引起的话，可直接根据时间来kill，但是可能会造成误杀，在处理问题速度为主的情况下，此种方式也可选择</p>
<p>打印select大于5s的查询<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql.sock</span> <span class="params">--match-info=</span><span class="string">"(?i-xsm:select)"</span> <span class="params">--busy-time</span> 5s <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span></span><br></pre></td></tr></table></figure></p>
<p>kill大于5s的查询<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-kill <span class="params">--no-version-check</span> <span class="params">--socket</span> <span class="string">/opt/mysql3306/data/mysql.sock</span> <span class="params">--match-info=</span><span class="string">"(?i-xsm:select)"</span> <span class="params">--busy-time</span> 5s <span class="params">--victim</span> all <span class="params">--interval</span> 1 <span class="params">--print</span> <span class="params">--kill-query</span> <span class="params">--daemonize</span> <span class="params">--log=/tmp/pt-kill</span>.log</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/MySQL-Group-Replication初探.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/MySQL-Group-Replication初探.html" itemprop="url">MySQL Group Replication初探</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-28T14:01:23+08:00">
                2017-11-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/集群高可用/" itemprop="url" rel="index">
                    <span itemprop="name">集群高可用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>MySQL Group Replication简称MGR，又称MySQL组复制，是MySQL官方于2016年12月12日推出的一个全新的高可用与高扩展的解决方案，首发集成于MySQL5.7.17版本中。MySQL组复制提供了高可用、高扩展、高可靠的MySQL集群服务。高一致性，基于原生复制及paxos协议的组复制技术，并以插件的方式提供，提供一致数据安全保证；高容错性，只要不是大多数节点坏掉就可以继续工作，有自动检测机制，当不同节点产生资源急用冲突时时，不会出现错误，按照先到者优先进行处理，并且内置了自动化脑裂防护机制；高扩展性，节点的新增和移除都是自动的，新节点加入后，会自动从其他节点上同步状态，直到新节点和其他节点保持一致，如果某节点被移除了，其他节点自动更新组信息，自动维护新的组信息；高灵活性，有单主模式和多主模式，单主模式下，会自动选主，所有更新操作都在主上进行；多主模式下，所有server都可以处理更新操作。</p>
<h2 id="要求和限制"><a href="#要求和限制" class="headerlink" title="要求和限制"></a>要求和限制</h2><h3 id="基础结构"><a href="#基础结构" class="headerlink" title="基础结构"></a>基础结构</h3><ul>
<li>数据必须存储在InnoDB存储引擎中</li>
<li>表必须定义一个显式主键</li>
<li>通信引擎仅支持IPv4</li>
<li>需要低延迟，高带宽的网络<h3 id="server实例配置"><a href="#server实例配置" class="headerlink" title="server实例配置"></a>server实例配置</h3></li>
<li>必须开启binlog</li>
<li>必须开启log-slave-updates</li>
<li>binlog格式必须为ROW格式</li>
<li>必须开启GTID模式</li>
<li>复制相关信息必须使用表存储（–master-info-repository = TABLE/–relay-log-info-repository = TABLE）</li>
<li>事务写集合必须打开（Transaction write set extraction）</li>
<li>root用户必须存在(group replication用于检查组用户是否存在)<h3 id="使用限制"><a href="#使用限制" class="headerlink" title="使用限制"></a>使用限制</h3></li>
<li>不支持binlog的checksum，需要设置–binlog-checksum = NONE</li>
<li>不支持savepoint</li>
<li>不支持可串行serializable事务隔离级别</li>
<li>不支持gap locks</li>
<li>不支持lock tables,unlock tables</li>
<li>多主模式下，不支持多节点同时对一个表进行DDL vs DDL/DML</li>
<li>多主模式下，不支持多级关联外键</li>
</ul>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>MySQL组复制是一个MySQL插件，它建立在现有的MySQL复制基础结构上，利用了二进制日志，基于行的日志记录和全局事务标识符等功能。它集成了当前的MySQL框架，如性能模式、插件和服务基础设施等。<br>组复制（Group Replication）基于分布式一致性算法(Paxos协议的变体)实现，一个组允许部分节点挂掉，只要保证绝大多数节点仍然存活并且之间的通讯是没有问题的，那么这个组对外仍然能够提供服务，它是一种被使用在容错系统中的技术。Group Replication（复制组）是由能够相互通信的多个服务器（节点）组成的。在通信层，Group replication实现了一系列的机制：比如原子消息（atomic message delivery）和全序化消息（total ordering of messages）。这些原子化，抽象化的机制，为实现更先进的数据库复制方案提供了强有力的支持。MySQL Group Replication正是基于这些技术和概念，实现了一种多主全更新的复制协议。简而言之，一个Group Replication就是一组节点，每个节点都可以独立执行事务，而读写事务则会在于group内的其他节点进行协调之后再commit。因此，当一个事务准备提交时，会自动在group内进行原子性的广播，告知其他节点变更了什么内容/执行了什么事务。这种原子广播的方式，使得这个事务在每一个节点上都保持着同样顺序。这意味着每一个节点都以同样的顺序，接收到了同样的事务日志，所以每一个节点以同样的顺序重演了这些事务日志，最终整个group保持了完全一致的状态。然而，不同的节点上执行的事务之间有可能存在资源争用。这种现象容易出现在两个不同的并发事务上。假设在不同的节点上有两个并发事务，更新了同一行数据，那么就会发生资源争用。面对这种情况，Group Replication判定先提交的事务为有效事务，会在整个group里面重放，后提交的事务会直接中断，或者回滚，最后丢弃掉。因此，这也是一个无共享的复制方案，每一个节点都保存了完整的数据副本。</p>
<h2 id="组织结构"><a href="#组织结构" class="headerlink" title="组织结构"></a>组织结构</h2><p><img src="https://dev.mysql.com/doc/refman/5.7/en/images/gr-plugin-blocks.png" alt="image"></p>
<ul>
<li>API层 负责完成和MySQL Server的交互，获取server的状态，截获事务提交，干涉事务提交或者回滚。</li>
<li>组件层 特定功能的组件，Capture负责收集事务执行相关信息，Applier负责应用集群事务到本地，Recovery负责新节点的数据恢复。</li>
<li>复制层 负责冲突验证，接收和应用集群事务。</li>
<li>集群通信层 基于Paxos协议的集群通信引擎以及和上层组件的交互接口。</li>
</ul>
<h2 id="容错"><a href="#容错" class="headerlink" title="容错"></a>容错</h2><p>MySQL组复制构建在paxos分布式算法实现的基础上，以提供不同server之间的分布式协调。因此，它需要大多数server处于活动状态以达到仲裁成员数，从而做出决定。这对系统可以容忍的不影响其自身及其整体功能的故障数量有直接影响。容忍f个故障所需的server数量(n)为n=2*f+1。<br>在实践中，这意味着为了容忍一个故障，组必须有三个server。因此，如果一个服务器故障，仍然有两个服务器形成大多数(三分之二)来允许系统自动地继续运行。但是，如果第二个server意外地fail掉，则该组(剩下一个server)锁定，因为没有多数可以达成协议。  </p>
<h3 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h3><table>
<thead>
<tr>
<th>组大小</th>
<th style="text-align:left">多数</th>
<th style="text-align:left">允许的即使故障数</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td>2</td>
<td style="text-align:left">2</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td>3</td>
<td style="text-align:left">2</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td>4</td>
<td style="text-align:left">3</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td>5</td>
<td style="text-align:left">3</td>
<td style="text-align:left">2</td>
</tr>
<tr>
<td>6</td>
<td style="text-align:left">4</td>
<td style="text-align:left">2</td>
</tr>
<tr>
<td>7</td>
<td style="text-align:left">4</td>
<td style="text-align:left">3</td>
</tr>
<tr>
<td>8</td>
<td style="text-align:left">5</td>
<td style="text-align:left">3</td>
</tr>
<tr>
<td>9</td>
<td style="text-align:left">5</td>
<td style="text-align:left">4</td>
</tr>
</tbody>
</table>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="在单主模式下部署组复制"><a href="#在单主模式下部署组复制" class="headerlink" title="在单主模式下部署组复制"></a>在单主模式下部署组复制</h3><h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><p>IP：192.168.7.50<br>system：Centos 6.5<br>hostname：jiessie<br>disk：300G ssd<br>memory：8G<br>cpu：4core<br>节点数：3</p>
<h4 id="二进制安装包下载"><a href="#二进制安装包下载" class="headerlink" title="二进制安装包下载"></a>二进制安装包下载</h4><p>二进制包安装目录：/hwdata/data/mysql5.7.20/base<br>下载地址：<a href="https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz" target="_blank" rel="noopener">https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz</a><br>目录结构：<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/hwdata/data/mysql5.7.20/base</span><br><span class="line">[root@jiessie base]<span class="comment"># ll</span></span><br><span class="line">total 52</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span>7161<span class="number"> 31415 </span>17987 Sep<span class="number"> 13 </span>23:48 COPYING</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span>7161<span class="number"> 31415 </span><span class="number"> 2478 </span>Sep<span class="number"> 13 </span>23:48 README</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span>root root  <span class="number"> 4096 </span>Nov<span class="number"> 29 </span>11:22 bin</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span>root root  <span class="number"> 4096 </span>Nov<span class="number"> 29 </span>11:22 docs</span><br><span class="line">drwxr-xr-x <span class="number"> 3 </span>root root  <span class="number"> 4096 </span>Nov<span class="number"> 29 </span>11:22 include</span><br><span class="line">drwxr-xr-x <span class="number"> 5 </span>root root  <span class="number"> 4096 </span>Nov<span class="number"> 29 </span>11:22 lib</span><br><span class="line">drwxr-xr-x <span class="number"> 4 </span>root root  <span class="number"> 4096 </span>Nov<span class="number"> 29 </span>11:22 man</span><br><span class="line">drwxr-xr-x<span class="number"> 28 </span>root root  <span class="number"> 4096 </span>Nov<span class="number"> 29 </span>11:22 share</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span>root root  <span class="number"> 4096 </span>Nov<span class="number"> 29 </span>11:22 support-files</span><br><span class="line">[root@jiessie base]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<h4 id="数据目录"><a href="#数据目录" class="headerlink" title="数据目录"></a>数据目录</h4><p>数据目录：/hwdata/data/mysql5.7.20/data<br>三节点的数据，分别存放于data子目录下的s1,s2,s3目录中<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]<span class="comment"># pwd</span></span><br><span class="line">/hwdata/data/mysql5.7.20</span><br><span class="line">[root@jiessie mysql5.7.20]<span class="comment"># mkdir data/&#123;s1,s2,s3&#125;</span></span><br><span class="line">[root@jiessie mysql5.7.20]<span class="comment"># ll data/</span></span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>Nov<span class="number"> 29 </span>17:23 s1</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>Nov<span class="number"> 29 </span>17:23 s2</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>Nov<span class="number"> 29 </span>17:23 s3</span><br><span class="line">[root@jiessie mysql5.7.20]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>配置文件：/hwdata/data/mysql5.7.20/conf<br>三节点的配置文件，分别是conf目录下的s1.cnf,s2.cnf,s3.cnf<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# ll conf/</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 root root 948 Nov 29 17:35 s1.cnf</span><br><span class="line">-rw-r--r-- 1 root root 948 Nov 29 17:36 s2.cnf</span><br><span class="line">-rw-r--r-- 1 root root 948 Nov 29 17:37 s3.cnf</span><br><span class="line">[root@jiessie mysql5.7.20]# cat conf/s1.cnf </span><br><span class="line">[mysqld]</span><br><span class="line"><span class="attribute">datadir</span>=/hwdata/data/mysql5.7.20/data/s1</span><br><span class="line"><span class="attribute">basedir</span>=/hwdata/data/mysql5.7.20/base</span><br><span class="line"><span class="attribute">port</span>=9001</span><br><span class="line"><span class="attribute">socket</span>=/hwdata/data/mysql5.7.20/data/s1/s1.sock</span><br><span class="line"></span><br><span class="line"><span class="attribute">server_id</span>=1</span><br><span class="line"><span class="attribute">gtid_mode</span>=ON</span><br><span class="line"><span class="attribute">enforce_gtid_consistency</span>=ON</span><br><span class="line"><span class="attribute">master_info_repository</span>=TABLE</span><br><span class="line"><span class="attribute">relay_log_info_repository</span>=TABLE</span><br><span class="line"><span class="attribute">binlog_checksum</span>=NONE</span><br><span class="line"><span class="attribute">log_slave_updates</span>=ON</span><br><span class="line"><span class="attribute">log_bin</span>=binlog</span><br><span class="line"><span class="attribute">binlog_format</span>=ROW</span><br><span class="line"><span class="attribute">innodb_buffer_pool_instances</span>=4</span><br><span class="line"><span class="attribute">innodb_buffer_pool_size</span>=128M</span><br><span class="line"><span class="attribute">innodb_flush_log_at_trx_commit</span>=2</span><br><span class="line"><span class="attribute">sync_binlog</span>=0</span><br><span class="line"><span class="attribute">slave-parallel-type</span>=LOGICAL_CLOCK</span><br><span class="line"><span class="attribute">slave-parallel-workers</span>=4</span><br><span class="line"><span class="attribute">slave_preserve_commit_order</span>=on</span><br><span class="line"><span class="comment">#group replication</span></span><br><span class="line"><span class="attribute">transaction_write_set_extraction</span>=XXHASH64</span><br><span class="line"><span class="attribute">loose-group_replication_group_name</span>=<span class="string">"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"</span></span><br><span class="line"><span class="attribute">loose-group_replication_start_on_boot</span>=off</span><br><span class="line">loose-group_replication_local_address= <span class="string">"127.0.0.1:10011"</span></span><br><span class="line">loose-group_replication_group_seeds= <span class="string">"127.0.0.1:10011,127.0.0.1:10012,127.0.0.1:10013"</span></span><br><span class="line">loose-group_replication_bootstrap_group= off</span><br><span class="line"><span class="attribute">loose-group_replication_single_primary_mode</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">loose-group_replication_ip_whitelist</span>=<span class="string">"127.0.0.1/20,192.168.7.50/20"</span></span><br><span class="line">[root@jiessie mysql5.7.20]# </span><br><span class="line">[root@jiessie mysql5.7.20]# cat conf/s2.cnf </span><br><span class="line">[mysqld]</span><br><span class="line"><span class="attribute">datadir</span>=/hwdata/data/mysql5.7.20/data/s2</span><br><span class="line"><span class="attribute">basedir</span>=/hwdata/data/mysql5.7.20/base</span><br><span class="line"><span class="attribute">port</span>=9002</span><br><span class="line"><span class="attribute">socket</span>=/hwdata/data/mysql5.7.20/data/s2/s2.sock</span><br><span class="line"></span><br><span class="line"><span class="attribute">server_id</span>=2</span><br><span class="line"><span class="attribute">gtid_mode</span>=ON</span><br><span class="line"><span class="attribute">enforce_gtid_consistency</span>=ON</span><br><span class="line"><span class="attribute">master_info_repository</span>=TABLE</span><br><span class="line"><span class="attribute">relay_log_info_repository</span>=TABLE</span><br><span class="line"><span class="attribute">binlog_checksum</span>=NONE</span><br><span class="line"><span class="attribute">log_slave_updates</span>=ON</span><br><span class="line"><span class="attribute">log_bin</span>=binlog</span><br><span class="line"><span class="attribute">binlog_format</span>=ROW</span><br><span class="line"><span class="attribute">innodb_buffer_pool_instances</span>=4</span><br><span class="line"><span class="attribute">innodb_buffer_pool_size</span>=128M</span><br><span class="line"><span class="attribute">innodb_flush_log_at_trx_commit</span>=2</span><br><span class="line"><span class="attribute">sync_binlog</span>=0</span><br><span class="line"><span class="attribute">slave-parallel-type</span>=LOGICAL_CLOCK</span><br><span class="line"><span class="attribute">slave-parallel-workers</span>=4</span><br><span class="line"><span class="attribute">slave_preserve_commit_order</span>=on</span><br><span class="line"><span class="comment">#group replication</span></span><br><span class="line"><span class="attribute">transaction_write_set_extraction</span>=XXHASH64</span><br><span class="line"><span class="attribute">loose-group_replication_group_name</span>=<span class="string">"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"</span></span><br><span class="line"><span class="attribute">loose-group_replication_start_on_boot</span>=off</span><br><span class="line">loose-group_replication_local_address= <span class="string">"127.0.0.1:10012"</span></span><br><span class="line">loose-group_replication_group_seeds= <span class="string">"127.0.0.1:10011,127.0.0.1:10012,127.0.0.1:10013"</span></span><br><span class="line">loose-group_replication_bootstrap_group= off</span><br><span class="line"><span class="attribute">loose-group_replication_single_primary_mode</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">loose-group_replication_ip_whitelist</span>=<span class="string">"127.0.0.1/20,192.168.7.50/20"</span></span><br><span class="line">[root@jiessie mysql5.7.20]# </span><br><span class="line">[root@jiessie mysql5.7.20]# cat conf/s3.cnf </span><br><span class="line">[mysqld]</span><br><span class="line"><span class="attribute">datadir</span>=/hwdata/data/mysql5.7.20/data/s3</span><br><span class="line"><span class="attribute">basedir</span>=/hwdata/data/mysql5.7.20/base</span><br><span class="line"><span class="attribute">port</span>=9003</span><br><span class="line"><span class="attribute">socket</span>=/hwdata/data/mysql5.7.20/data/s3/s3.sock</span><br><span class="line"></span><br><span class="line"><span class="attribute">server_id</span>=3</span><br><span class="line"><span class="attribute">gtid_mode</span>=ON</span><br><span class="line"><span class="attribute">enforce_gtid_consistency</span>=ON</span><br><span class="line"><span class="attribute">master_info_repository</span>=TABLE</span><br><span class="line"><span class="attribute">relay_log_info_repository</span>=TABLE</span><br><span class="line"><span class="attribute">binlog_checksum</span>=NONE</span><br><span class="line"><span class="attribute">log_slave_updates</span>=ON</span><br><span class="line"><span class="attribute">log_bin</span>=binlog</span><br><span class="line"><span class="attribute">binlog_format</span>=ROW</span><br><span class="line"><span class="attribute">innodb_buffer_pool_instances</span>=4</span><br><span class="line"><span class="attribute">innodb_buffer_pool_size</span>=128M</span><br><span class="line"><span class="attribute">innodb_flush_log_at_trx_commit</span>=2</span><br><span class="line"><span class="attribute">sync_binlog</span>=0</span><br><span class="line"><span class="attribute">slave-parallel-type</span>=LOGICAL_CLOCK</span><br><span class="line"><span class="attribute">slave-parallel-workers</span>=4</span><br><span class="line"><span class="attribute">slave_preserve_commit_order</span>=on</span><br><span class="line"><span class="comment">#group replication</span></span><br><span class="line"><span class="attribute">transaction_write_set_extraction</span>=XXHASH64</span><br><span class="line"><span class="attribute">loose-group_replication_group_name</span>=<span class="string">"aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa"</span></span><br><span class="line"><span class="attribute">loose-group_replication_start_on_boot</span>=off</span><br><span class="line">loose-group_replication_local_address= <span class="string">"127.0.0.1:10013"</span></span><br><span class="line">loose-group_replication_group_seeds= <span class="string">"127.0.0.1:10011,127.0.0.1:10012,127.0.0.1:10013"</span></span><br><span class="line">loose-group_replication_bootstrap_group= off</span><br><span class="line"><span class="attribute">loose-group_replication_single_primary_mode</span>=<span class="literal">true</span></span><br><span class="line"><span class="attribute">loose-group_replication_ip_whitelist</span>=<span class="string">"127.0.0.1/20,192.168.7.50/20"</span></span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure></p>
<ol>
<li>三节点中配置不一致的参数有以下：  </li>
</ol>
<ul>
<li>datadir     #数据目录  </li>
<li>port        #服务端口  </li>
<li>socket      #socket位置  </li>
<li>server_id   #服务器标识  </li>
<li>group_replication_local_address #组复制的本地地址</li>
</ul>
<ol start="2">
<li>组复制相关参数：  </li>
</ol>
<ul>
<li>transaction_write_set_extraction            #指示Server必须为每个事务收集写集合，并使用指定算法将其编码为散列  </li>
<li>loose-group_replication_group_name          #组复制名称  </li>
<li>loose-group_replication_start_on_boot       #server启动时是否自动启动组复制  </li>
<li>loose-group_replication_local_address       #绑定的ip和端口接受其他组成员的连接  </li>
<li>loose-group_replication_group_seeds         #本行为告诉服务器当服务器加入组时，应当连接到此列表的这些种子服务器进行配置。本设置可以不是全部的组成员地址  </li>
<li>loose-group_replication_bootstrap_group     #配置是否自动启动引导组</li>
<li>loose-group_replication_single_primary_mode #配置单主还是多主模式</li>
<li>loose-group_replication_ip_whitelist        #默认情况下只允许127.0.0.1连接到复制组，如果是其他IP则需要配置  </li>
</ul>
<ol start="3">
<li>开启并行复制</li>
</ol>
<ul>
<li>set global slave_parallel_type = ‘LOGICAL_CLOCK’;</li>
<li>set global slave_parallel_workers = N;</li>
<li>set global slave_preserve_commit_order = ON;<br>这三个参数可以开启并行复制，实践中没有配置，特此提示。<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4>使用mysqld分别对s1,s2,s3进行初始化：  </li>
<li>base/bin/mysqld –initialize-insecure –basedir=/hwdata/data/mysql5.7.20/base –datadir=/hwdata/data/mysql5.7.20/data/s1</li>
<li>base/bin/mysqld –initialize-insecure –basedir=/hwdata/data/mysql5.7.20/base –datadir=/hwdata/data/mysql5.7.20/data/s2</li>
<li>base/bin/mysqld –initialize-insecure –basedir=/hwdata/data/mysql5.7.20/base –datadir=/hwdata/data/mysql5.7.20/data/s3<figure class="highlight vhdl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# base/bin/mysqld <span class="comment">--initialize-insecure --basedir=/hwdata/data/mysql5.7.20/base --datadir=/hwdata/data/mysql5.7.20/data/s1                   </span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">55</span>:<span class="number">56.436002</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] TIMESTAMP <span class="keyword">with</span> implicit <span class="keyword">DEFAULT</span> value <span class="keyword">is</span> deprecated. Please <span class="keyword">use</span> <span class="comment">--explicit_defaults_for_timestamp server option (see documentation for more details).</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">55</span>:<span class="number">57.095836</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] InnoDB: <span class="keyword">New</span> log files created, LSN=<span class="number">45790</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">55</span>:<span class="number">57.216615</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">55</span>:<span class="number">57.284024</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] No existing UUID has been found, so we <span class="keyword">assume</span> that this <span class="keyword">is</span> the first <span class="built_in">time</span> that this server has been started. Generating a <span class="keyword">new</span> UUID: c0acc2c7-d58a-<span class="number">11e7</span>-b59f-<span class="number">00163e00</span>dc49.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">55</span>:<span class="number">57.287290</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] Gtid table <span class="keyword">is</span> <span class="keyword">not</span> ready <span class="keyword">to</span> be used. Table <span class="symbol">'mysql</span>.gtid_executed' cannot be opened.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">55</span>:<span class="number">57.287678</span>Z <span class="number">1</span> [<span class="literal">Warning</span>] root@localhost <span class="keyword">is</span> created <span class="keyword">with</span> an empty password ! Please consider switching off the <span class="comment">--initialize-insecure option.</span></span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# </span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# base/bin/mysqld <span class="comment">--initialize-insecure --basedir=/hwdata/data/mysql5.7.20/base --datadir=/hwdata/data/mysql5.7.20/data/s2</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">20.520937</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] TIMESTAMP <span class="keyword">with</span> implicit <span class="keyword">DEFAULT</span> value <span class="keyword">is</span> deprecated. Please <span class="keyword">use</span> <span class="comment">--explicit_defaults_for_timestamp server option (see documentation for more details).</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">21.152584</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] InnoDB: <span class="keyword">New</span> log files created, LSN=<span class="number">45790</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">21.278863</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">21.349754</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] No existing UUID has been found, so we <span class="keyword">assume</span> that this <span class="keyword">is</span> the first <span class="built_in">time</span> that this server has been started. Generating a <span class="keyword">new</span> UUID: cf04e66c-d58a-<span class="number">11e7</span>-b97e-<span class="number">00163e00</span>dc49.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">21.352655</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] Gtid table <span class="keyword">is</span> <span class="keyword">not</span> ready <span class="keyword">to</span> be used. Table <span class="symbol">'mysql</span>.gtid_executed' cannot be opened.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">21.353069</span>Z <span class="number">1</span> [<span class="literal">Warning</span>] root@localhost <span class="keyword">is</span> created <span class="keyword">with</span> an empty password ! Please consider switching off the <span class="comment">--initialize-insecure option.</span></span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# </span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# base/bin/mysqld <span class="comment">--initialize-insecure --basedir=/hwdata/data/mysql5.7.20/base --datadir=/hwdata/data/mysql5.7.20/data/s3</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">28.986804</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] TIMESTAMP <span class="keyword">with</span> implicit <span class="keyword">DEFAULT</span> value <span class="keyword">is</span> deprecated. Please <span class="keyword">use</span> <span class="comment">--explicit_defaults_for_timestamp server option (see documentation for more details).</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">29.712932</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] InnoDB: <span class="keyword">New</span> log files created, LSN=<span class="number">45790</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">29.902130</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">29.970877</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] No existing UUID has been found, so we <span class="keyword">assume</span> that this <span class="keyword">is</span> the first <span class="built_in">time</span> that this server has been started. Generating a <span class="keyword">new</span> UUID: d4286108-d58a-<span class="number">11e7</span>-<span class="number">807</span>d-<span class="number">00163e00</span>dc49.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">29.973699</span>Z <span class="number">0</span> [<span class="literal">Warning</span>] Gtid table <span class="keyword">is</span> <span class="keyword">not</span> ready <span class="keyword">to</span> be used. Table <span class="symbol">'mysql</span>.gtid_executed' cannot be opened.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">30</span>T04:<span class="number">56</span>:<span class="number">29.974087</span>Z <span class="number">1</span> [<span class="literal">Warning</span>] root@localhost <span class="keyword">is</span> created <span class="keyword">with</span> an empty password ! Please consider switching off the <span class="comment">--initialize-insecure option.</span></span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# tree -L <span class="number">2</span> data/ </span><br><span class="line">data/</span><br><span class="line">|<span class="comment">-- s1</span></span><br><span class="line">|   |<span class="comment">-- auto.cnf</span></span><br><span class="line">|   |<span class="comment">-- ib_buffer_pool</span></span><br><span class="line">|   |<span class="comment">-- ib_logfile0</span></span><br><span class="line">|   |<span class="comment">-- ib_logfile1</span></span><br><span class="line">|   |<span class="comment">-- ibdata1</span></span><br><span class="line">|   |<span class="comment">-- mysql</span></span><br><span class="line">|   |<span class="comment">-- performance_schema</span></span><br><span class="line">|   `<span class="comment">-- sys</span></span><br><span class="line">|<span class="comment">-- s2</span></span><br><span class="line">|   |<span class="comment">-- auto.cnf</span></span><br><span class="line">|   |<span class="comment">-- ib_buffer_pool</span></span><br><span class="line">|   |<span class="comment">-- ib_logfile0</span></span><br><span class="line">|   |<span class="comment">-- ib_logfile1</span></span><br><span class="line">|   |<span class="comment">-- ibdata1</span></span><br><span class="line">|   |<span class="comment">-- mysql</span></span><br><span class="line">|   |<span class="comment">-- performance_schema</span></span><br><span class="line">|   `<span class="comment">-- sys</span></span><br><span class="line">`<span class="comment">-- s3</span></span><br><span class="line">    |<span class="comment">-- auto.cnf</span></span><br><span class="line">    |<span class="comment">-- ib_buffer_pool</span></span><br><span class="line">    |<span class="comment">-- ib_logfile0</span></span><br><span class="line">    |<span class="comment">-- ib_logfile1</span></span><br><span class="line">    |<span class="comment">-- ibdata1</span></span><br><span class="line">    |<span class="comment">-- mysql</span></span><br><span class="line">    |<span class="comment">-- performance_schema</span></span><br><span class="line">    `<span class="comment">-- sys</span></span><br><span class="line"></span><br><span class="line"><span class="number">12</span> directories, <span class="number">15</span> files</span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]#</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h4><p>添加权限：chown -R mysql:mysql /hwdata/data/mysql5.7.20/data/<br>分别启动三个节点数据库：</p>
<ul>
<li>base/bin/mysqld_safe –defaults-file=/hwdata/data/mysql5.7.20/conf/s1.cnf &amp;</li>
<li>base/bin/mysqld_safe –defaults-file=/hwdata/data/mysql5.7.20/conf/s2.cnf &amp;</li>
<li>base/bin/mysqld_safe –defaults-file=/hwdata/data/mysql5.7.20/conf/s3.cnf &amp;<figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# base/bin/mysqld_safe --defaults-file=/hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/conf/s1.cnf &amp;</span><br><span class="line">[<span class="number">1</span>] <span class="number">25168</span></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# Logging to <span class="string">'/hwdata/data/mysql5.7.20/data/s1/jiessie.err'</span>.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-30T05:<span class="number">06</span>:<span class="number">34.</span>402042Z mysqld_safe Starting mysqld daemon with databases from /hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/data/s1</span><br><span class="line"></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# base/bin/mysqld_safe --defaults-file=/hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/conf/s2.cnf &amp;   </span><br><span class="line">[<span class="number">2</span>] <span class="number">25681</span></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# Logging to <span class="string">'/hwdata/data/mysql5.7.20/data/s2/jiessie.err'</span>.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-30T05:<span class="number">06</span>:<span class="number">48.</span>204177Z mysqld_safe Starting mysqld daemon with databases from /hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/data/s2</span><br><span class="line"></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# base/bin/mysqld_safe --defaults-file=/hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/conf/s3.cnf &amp; </span><br><span class="line">[<span class="number">3</span>] <span class="number">26193</span></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# Logging to <span class="string">'/hwdata/data/mysql5.7.20/data/s3/jiessie.err'</span>.</span><br><span class="line"><span class="number">2017</span>-<span class="number">11</span>-30T05:<span class="number">06</span>:<span class="number">59.</span>779426Z mysqld_safe Starting mysqld daemon with databases from /hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/data/s3</span><br><span class="line"></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]#</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>查看进程:<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# netstat -tunlp|grep mysql </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">9001</span>                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">25609</span>/mysqld        </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">9002</span>                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">26122</span>/mysqld        </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">9003</span>                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">26634</span>/mysqld        </span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]#</span><br></pre></td></tr></table></figure></p>
<h4 id="添加复制用户"><a href="#添加复制用户" class="headerlink" title="添加复制用户"></a>添加复制用户</h4><p>创建具有replication slave权限的MySQL用户,此操作不应记录到二进制中,以避免将更改传递到其他slave实例.<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# base/bin/mysql -uroot -S /hwdata/data/mysql5.<span class="number">7.20</span>/data/s1/s1.sock</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">3</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">20</span>-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">SET</span> SQL_LOG_BIN=<span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">CREATE</span> USER rpl_user@<span class="string">'%'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE <span class="keyword">ON</span> *.* <span class="keyword">TO</span> rpl_user@<span class="string">'%'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'rpl_pass'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">SET</span> SQL_LOG_BIN=<span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CHANGE MASTER <span class="keyword">TO</span> MASTER_USER=<span class="string">'rpl_user'</span>, MASTER_PASSWORD=<span class="string">'rpl_pass'</span> <span class="keyword">FOR</span> CHANNEL <span class="string">'group_replication_recovery'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">2</span> warnings (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# base/bin/mysql -uroot -S /hwdata/data/mysql5.<span class="number">7.20</span>/data/s2/s2.sock     </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">3</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">20</span>-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">SET</span> SQL_LOG_BIN=<span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">CREATE</span> USER rpl_user@<span class="string">'%'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE <span class="keyword">ON</span> *.* <span class="keyword">TO</span> rpl_user@<span class="string">'%'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'rpl_pass'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">SET</span> SQL_LOG_BIN=<span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CHANGE MASTER <span class="keyword">TO</span> MASTER_USER=<span class="string">'rpl_user'</span>, MASTER_PASSWORD=<span class="string">'rpl_pass'</span> <span class="keyword">FOR</span> CHANNEL <span class="string">'group_replication_recovery'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">2</span> warnings (<span class="number">0.04</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]# base/bin/mysql -uroot -S /hwdata/data/mysql5.<span class="number">7.20</span>/data/s3/s3.sock   </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">3</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">20</span>-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">SET</span> SQL_LOG_BIN=<span class="number">0</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">CREATE</span> USER rpl_user@<span class="string">'%'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE <span class="keyword">ON</span> *.* <span class="keyword">TO</span> rpl_user@<span class="string">'%'</span> IDENTIFIED <span class="keyword">BY</span> <span class="string">'rpl_pass'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">1</span> warning (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">SET</span> SQL_LOG_BIN=<span class="number">1</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CHANGE MASTER <span class="keyword">TO</span> MASTER_USER=<span class="string">'rpl_user'</span>, MASTER_PASSWORD=<span class="string">'rpl_pass'</span> <span class="keyword">FOR</span> CHANNEL <span class="string">'group_replication_recovery'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected, <span class="number">2</span> warnings (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5.<span class="number">7.20</span>]#</span><br></pre></td></tr></table></figure></p>
<h4 id="启动组复制"><a href="#启动组复制" class="headerlink" title="启动组复制"></a>启动组复制</h4><p>配置并启动s1后,安装组复制插件,然后连接到server并执行以下命令.  </p>
<p><font color="#FF0000">注意:<br>创建一个Group Replication,需要在一个节点初始化,也只需要在一个节点初始化,不可在多个节点都执行.</font><br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock</span></span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 4</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; INSTALL PLUGIN group_replication SONAME 'group_replication.so';</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show plugins;</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">|<span class="string"> Name                       </span>|<span class="string"> Status   </span>|<span class="string"> Type               </span>|<span class="string"> Library              </span>|<span class="string"> License </span>|</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">|<span class="string"> binlog                     </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> mysql_native_password      </span>|<span class="string"> ACTIVE   </span>|<span class="string"> AUTHENTICATION     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> sha256_password            </span>|<span class="string"> ACTIVE   </span>|<span class="string"> AUTHENTICATION     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> PERFORMANCE_SCHEMA         </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> MRG_MYISAM                 </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> MEMORY                     </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> InnoDB                     </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_TRX                 </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_LOCKS               </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_LOCK_WAITS          </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_CMP                 </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_CMP_RESET           </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_CMPMEM              </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_CMPMEM_RESET        </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_CMP_PER_INDEX       </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_CMP_PER_INDEX_RESET </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_BUFFER_PAGE         </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_BUFFER_PAGE_LRU     </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_BUFFER_POOL_STATS   </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_TEMP_TABLE_INFO     </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_METRICS             </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_FT_DEFAULT_STOPWORD </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_FT_DELETED          </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_FT_BEING_DELETED    </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_FT_CONFIG           </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_FT_INDEX_CACHE      </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_FT_INDEX_TABLE      </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_TABLES          </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_TABLESTATS      </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_INDEXES         </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_COLUMNS         </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_FIELDS          </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_FOREIGN         </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_FOREIGN_COLS    </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_TABLESPACES     </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_DATAFILES       </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> INNODB_SYS_VIRTUAL         </span>|<span class="string"> ACTIVE   </span>|<span class="string"> INFORMATION SCHEMA </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> CSV                        </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> MyISAM                     </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> ARCHIVE                    </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> partition                  </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> BLACKHOLE                  </span>|<span class="string"> ACTIVE   </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> FEDERATED                  </span>|<span class="string"> DISABLED </span>|<span class="string"> STORAGE ENGINE     </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> ngram                      </span>|<span class="string"> ACTIVE   </span>|<span class="string"> FTPARSER           </span>|<span class="string"> NULL                 </span>|<span class="string"> GPL     </span>|</span><br><span class="line">|<span class="string"> group_replication          </span>|<span class="string"> ACTIVE   </span>|<span class="string"> GROUP REPLICATION  </span>|<span class="string"> group_replication.so </span>|<span class="string"> GPL     </span>|</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">45 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group=ON;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br><span class="line">Query OK, 0 rows affected (3.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group=OFF;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT <span class="symbol">*</span> FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">|<span class="string"> CHANNEL_NAME              </span>|<span class="string"> MEMBER_ID                            </span>|<span class="string"> MEMBER_HOST </span>|<span class="string"> MEMBER_PORT </span>|<span class="string"> MEMBER_STATE </span>|</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">|<span class="string"> group_replication_applier </span>|<span class="string"> c0acc2c7-d58a-11e7-b59f-00163e00dc49 </span>|<span class="string"> jiessie     </span>|<span class="string">        9001 </span>|<span class="string"> ONLINE       </span>|</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<h4 id="添加其他组复制节点"><a href="#添加其他组复制节点" class="headerlink" title="添加其他组复制节点"></a>添加其他组复制节点</h4><p>在其他2个节点上开启组复制<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5<span class="number">.7</span><span class="number">.20</span>]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock</span></span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">4</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.20</span>-<span class="built_in">log</span> MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; INSTALL PLUGIN group_replication SONAME 'group_replication.so';</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">6.57</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5<span class="number">.7</span><span class="number">.20</span>]<span class="comment">#  base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock</span></span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">4</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.20</span>-<span class="built_in">log</span> MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; INSTALL PLUGIN group_replication SONAME 'group_replication.so';</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">3.27</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5<span class="number">.7</span><span class="number">.20</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<h4 id="测试数据同步"><a href="#测试数据同步" class="headerlink" title="测试数据同步"></a>测试数据同步</h4><p>在s1节点上插入数据，在其他节点上查看数据是否同步及binlog详情</p>
<ol>
<li><p>刷新flush logs</p>
<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e "flush logs;show binary logs;"                                  <span class="code">+---------------+</span>-----------+</span><br><span class="line">| Log<span class="emphasis">_name      | File_</span>size |</span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">| binlog.000001 |      1101 |</span><br><span class="line">| binlog.000002 |      1162 |</span><br><span class="line">| binlog.000003 |      2329 |</span><br><span class="line">| binlog.000004 |       230 |</span><br><span class="line">| binlog.000005 |      1017 |</span><br><span class="line">| binlog.000006 |       190 |</span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock -e "flush logs;show binary logs;"  </span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">| Log<span class="emphasis">_name      | File_</span>size |</span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">| binlog.000001 |       169 |</span><br><span class="line">| binlog.000002 |      2054 |</span><br><span class="line">| binlog.000003 |      3106 |</span><br><span class="line">| binlog.000004 |       190 |</span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock -e "flush logs;show binary logs;"  </span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">| Log<span class="emphasis">_name      | File_</span>size |</span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">| binlog.000001 |       169 |</span><br><span class="line">| binlog.000002 |       150 |</span><br><span class="line">| binlog.000003 |      4970 |</span><br><span class="line">| binlog.000004 |       190 |</span><br><span class="line"><span class="code">+---------------+</span>-----------+</span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure>
</li>
<li><p>节点1插入数据</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e "create database if not exists test;create table test.t1(id int unsigned not null auto_increment primary key,name varchar(20))"           </span></span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e "desc test.t1;select * from test.t1"    </span></span><br><span class="line">+-------+------------------+------+-----+---------+----------------+</span><br><span class="line">|<span class="string"> Field </span>|<span class="string"> Type             </span>|<span class="string"> Null </span>|<span class="string"> Key </span>|<span class="string"> Default </span>|<span class="string"> Extra          </span>|</span><br><span class="line">+-------+------------------+------+-----+---------+----------------+</span><br><span class="line">|<span class="string"> id    </span>|<span class="string"> int(10) unsigned </span>|<span class="string"> NO   </span>|<span class="string"> PRI </span>|<span class="string"> NULL    </span>|<span class="string"> auto_increment </span>|</span><br><span class="line">|<span class="string"> name  </span>|<span class="string"> varchar(20)      </span>|<span class="string"> YES  </span>|<span class="string">     </span>|<span class="string"> NULL    </span>|<span class="string">                </span>|</span><br><span class="line">+-------+------------------+------+-----+---------+----------------+</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e "insert into test.t1 values(null,'111')"</span></span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e "select * from test.t1"</span></span><br><span class="line">+----+------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> name </span>|</span><br><span class="line">+----+------+</span><br><span class="line">|<span class="string">  1 </span>|<span class="string"> 111  </span>|</span><br><span class="line">+----+------+</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e "show binlog events in 'binlog.000006'" </span></span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> Log_name      </span>|<span class="string"> Pos </span>|<span class="string"> Event_type     </span>|<span class="string"> Server_id </span>|<span class="string"> End_log_pos </span>|<span class="string"> Info                                                                                       </span>|</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string">   4 </span>|<span class="string"> Format_desc    </span>|<span class="string">         1 </span>|<span class="string">         123 </span>|<span class="string"> Server ver: 5.7.20-log, Binlog ver: 4                                                      </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 123 </span>|<span class="string"> Previous_gtids </span>|<span class="string">         1 </span>|<span class="string">         190 </span>|<span class="string"> aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-19                                                  </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 190 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         251 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:20'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 251 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         360 </span>|<span class="string"> create database if not exists test                                                         </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 360 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         421 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:21'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 421 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         582 </span>|<span class="string"> create table test.t1(id int unsigned not null auto_increment primary key,name varchar(20)) </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 582 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         643 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:22'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 643 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         712 </span>|<span class="string"> BEGIN                                                                                      </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 712 </span>|<span class="string"> Table_map      </span>|<span class="string">         1 </span>|<span class="string">         756 </span>|<span class="string"> table_id: 223 (test.t1)                                                                    </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 756 </span>|<span class="string"> Write_rows     </span>|<span class="string">         1 </span>|<span class="string">         796 </span>|<span class="string"> table_id: 223 flags: STMT_END_F                                                            </span>|</span><br><span class="line">|<span class="string"> binlog.000006 </span>|<span class="string"> 796 </span>|<span class="string"> Xid            </span>|<span class="string">         1 </span>|<span class="string">         823 </span>|<span class="string"> COMMIT /* xid=151 */                                                                       </span>|</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>其他节点查看数据</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock -e "show binlog events in 'binlog.000004'"   </span></span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> Log_name      </span>|<span class="string"> Pos </span>|<span class="string"> Event_type     </span>|<span class="string"> Server_id </span>|<span class="string"> End_log_pos </span>|<span class="string"> Info                                                                                       </span>|</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string">   4 </span>|<span class="string"> Format_desc    </span>|<span class="string">         2 </span>|<span class="string">         123 </span>|<span class="string"> Server ver: 5.7.20-log, Binlog ver: 4                                                      </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 123 </span>|<span class="string"> Previous_gtids </span>|<span class="string">         2 </span>|<span class="string">         190 </span>|<span class="string"> aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-19                                                  </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 190 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         251 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:20'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 251 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         360 </span>|<span class="string"> create database if not exists test                                                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 360 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         421 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:21'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 421 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         582 </span>|<span class="string"> create table test.t1(id int unsigned not null auto_increment primary key,name varchar(20)) </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 582 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         643 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:22'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 643 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         707 </span>|<span class="string"> BEGIN                                                                                      </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 707 </span>|<span class="string"> Table_map      </span>|<span class="string">         1 </span>|<span class="string">         751 </span>|<span class="string"> table_id: 221 (test.t1)                                                                    </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 751 </span>|<span class="string"> Write_rows     </span>|<span class="string">         1 </span>|<span class="string">         791 </span>|<span class="string"> table_id: 221 flags: STMT_END_F                                                            </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 791 </span>|<span class="string"> Xid            </span>|<span class="string">         1 </span>|<span class="string">         818 </span>|<span class="string"> COMMIT /* xid=71 */                                                                        </span>|</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock -e "show binlog events in 'binlog.000004'"  </span></span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> Log_name      </span>|<span class="string"> Pos </span>|<span class="string"> Event_type     </span>|<span class="string"> Server_id </span>|<span class="string"> End_log_pos </span>|<span class="string"> Info                                                                                       </span>|</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string">   4 </span>|<span class="string"> Format_desc    </span>|<span class="string">         3 </span>|<span class="string">         123 </span>|<span class="string"> Server ver: 5.7.20-log, Binlog ver: 4                                                      </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 123 </span>|<span class="string"> Previous_gtids </span>|<span class="string">         3 </span>|<span class="string">         190 </span>|<span class="string"> aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-19                                                  </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 190 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         251 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:20'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 251 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         360 </span>|<span class="string"> create database if not exists test                                                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 360 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         421 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:21'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 421 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         582 </span>|<span class="string"> create table test.t1(id int unsigned not null auto_increment primary key,name varchar(20)) </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 582 </span>|<span class="string"> Gtid           </span>|<span class="string">         1 </span>|<span class="string">         643 </span>|<span class="string"> SET @@SESSION.GTID_NEXT= 'aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:22'                         </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 643 </span>|<span class="string"> Query          </span>|<span class="string">         1 </span>|<span class="string">         707 </span>|<span class="string"> BEGIN                                                                                      </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 707 </span>|<span class="string"> Table_map      </span>|<span class="string">         1 </span>|<span class="string">         751 </span>|<span class="string"> table_id: 221 (test.t1)                                                                    </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 751 </span>|<span class="string"> Write_rows     </span>|<span class="string">         1 </span>|<span class="string">         791 </span>|<span class="string"> table_id: 221 flags: STMT_END_F                                                            </span>|</span><br><span class="line">|<span class="string"> binlog.000004 </span>|<span class="string"> 791 </span>|<span class="string"> Xid            </span>|<span class="string">         1 </span>|<span class="string">         818 </span>|<span class="string"> COMMIT /* xid=58 */                                                                        </span>|</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock -e "select * from test.t1"                  </span></span><br><span class="line">+----+------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> name </span>|</span><br><span class="line">+----+------+</span><br><span class="line">|<span class="string">  1 </span>|<span class="string"> 111  </span>|</span><br><span class="line">+----+------+</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment"># base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock -e "select * from test.t1"  </span></span><br><span class="line">+----+------+</span><br><span class="line">|<span class="string"> id </span>|<span class="string"> name </span>|</span><br><span class="line">+----+------+</span><br><span class="line">|<span class="string">  1 </span>|<span class="string"> 111  </span>|</span><br><span class="line">+----+------+</span><br><span class="line">[root<span class="meta">@jiessie</span> mysql5.7.20]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="节点状态查询"><a href="#节点状态查询" class="headerlink" title="节点状态查询"></a>节点状态查询</h4><p><font color="#FF0000">注意：</font><br>主机名和/etc/hosts中的信息要保持一致，否则可能会报<font color="#FF0000">“There was an error when connecting to the donor server. Please check that group_replication_r<br>ecovery channel credentials and all MEMBER_HOST column values of performance_schema.replication_group_members table are correct and DNS resolvable.”</font><br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance<span class="emphasis">_schema.replication_</span>group<span class="emphasis">_members;</span></span><br><span class="line"><span class="emphasis">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span></span><br><span class="line"><span class="emphasis">| CHANNEL_</span>NAME              | MEMBER<span class="emphasis">_ID                            | MEMBER_</span>HOST | MEMBER<span class="emphasis">_PORT | MEMBER_</span>STATE |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="监控组复制"><a href="#监控组复制" class="headerlink" title="监控组复制"></a>监控组复制</h3><p>假设MySQL已经在启用了性能模式的情况下编译，使用performance_schema表监控组复制</p>
<h4 id="replication-group-member-stats"><a href="#replication-group-member-stats" class="headerlink" title="replication_group_member_stats"></a>replication_group_member_stats</h4><p>复制组中的每个成员都会验证并应用该组提交的事务,有关验证和应用程序的统计信息对于了解申请队列增长情况,触发了多少冲突,检查了多少事务,哪些事务已被所有成员提交等非常有用,performance_shcema.replication_group_member_stats提供与认证过程相关的以下信息<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from performance<span class="emphasis">_schema.replication_</span>group<span class="emphasis">_member_</span>stats;</span><br><span class="line"><span class="code">+---------------------------+</span>---------------------<span class="code">+--------------------------------------+</span>-----------------------------<span class="code">+----------------------------+</span>--------------------------<span class="code">+------------------------------------+</span>-------------------------------------------<span class="code">+-----------------------------------------+</span></span><br><span class="line">| CHANNEL<span class="emphasis">_NAME              | VIEW_</span>ID             | MEMBER<span class="emphasis">_ID                            | COUNT_</span>TRANSACTIONS<span class="emphasis">_IN_</span>QUEUE | COUNT<span class="emphasis">_TRANSACTIONS_</span>CHECKED | COUNT<span class="emphasis">_CONFLICTS_</span>DETECTED | COUNT<span class="emphasis">_TRANSACTIONS_</span>ROWS<span class="emphasis">_VALIDATING | TRANSACTIONS_</span>COMMITTED<span class="emphasis">_ALL_</span>MEMBERS        | LAST<span class="emphasis">_CONFLICT_</span>FREE<span class="emphasis">_TRANSACTION          |</span></span><br><span class="line"><span class="emphasis">+---------------------------+---------------------+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+-------------------------------------------+-----------------------------------------+</span></span><br><span class="line"><span class="emphasis">| group_</span>replication<span class="emphasis">_applier | 15120910223421577:3 | c0acc2c7-d58a-11e7-b59f-00163e00dc49 |                           0 |                         13 |                        0 |                                  0 | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-22 | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:22 |</span></span><br><span class="line"><span class="emphasis">+---------------------------+---------------------+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+-------------------------------------------+-----------------------------------------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br></pre></td></tr></table></figure></p>
<h5 id="参数解释"><a href="#参数解释" class="headerlink" title="参数解释"></a>参数解释</h5><table>
<thead>
<tr>
<th>Field</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CHANNEL_NAME</td>
<td style="text-align:left">组复制通道的名称</td>
</tr>
<tr>
<td>VIEW_ID</td>
<td style="text-align:left">组复制当前视图标识符</td>
</tr>
<tr>
<td>MEMBER_ID</td>
<td style="text-align:left">当前连接到server成员的UUID,组中的每个成员具有不同的值</td>
</tr>
<tr>
<td>COUNT_TRANSACTIONS_IN_QUEUE</td>
<td style="text-align:left">队列中等待冲突检测检查的事务数,冲突检查通过后,他们排队等待应用</td>
</tr>
<tr>
<td>COUNT_TRANSACTIONS_CHECKED</td>
<td style="text-align:left">已进行过冲突检查的事务数</td>
</tr>
<tr>
<td>COUNT_CONFLICTS_DETECTED</td>
<td style="text-align:left">未通过冲突检查的事务数</td>
</tr>
<tr>
<td>COUNT_TRANSACTIONS_ROWS_VALIDATING</td>
<td style="text-align:left">可用于认证的事务行的数量，但没有被垃圾收集</td>
</tr>
<tr>
<td>TRANSACTIONS_COMMITTED_ALL_MEMBERS</td>
<td style="text-align:left">当前视图的所有成员成功提交的事务,此值为固定的时间间隔更新</td>
</tr>
<tr>
<td>LAST_CONFLICT_FREE_TRANSACTION</td>
<td style="text-align:left">最后一个经检查无冲突的事务标识符</td>
</tr>
</tbody>
</table>
<h4 id="replication-group-members"><a href="#replication-group-members" class="headerlink" title="replication_group_members"></a>replication_group_members</h4><p>用于监控在当前视图中的不同server实例的状态<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance<span class="emphasis">_schema.replication_</span>group<span class="emphasis">_members;</span></span><br><span class="line"><span class="emphasis">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span></span><br><span class="line"><span class="emphasis">| CHANNEL_</span>NAME              | MEMBER<span class="emphasis">_ID                            | MEMBER_</span>HOST | MEMBER<span class="emphasis">_PORT | MEMBER_</span>STATE |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h5 id="参数解释-1"><a href="#参数解释-1" class="headerlink" title="参数解释"></a>参数解释</h5><table>
<thead>
<tr>
<th>Field</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CHANNEL_NAME</td>
<td style="text-align:left">组复制通道的名称</td>
</tr>
<tr>
<td>MEMBER_ID</td>
<td style="text-align:left">server成员的UUID</td>
</tr>
<tr>
<td>MEMBER_HOST</td>
<td style="text-align:left">组成员的网络地址</td>
</tr>
<tr>
<td>MEMBER_PORT</td>
<td style="text-align:left">侦听此成员的MySQL连接端口</td>
</tr>
<tr>
<td>MEMBER_STATE</td>
<td style="text-align:left">组成员的状态</td>
</tr>
</tbody>
</table>
<h4 id="replication-connection-status"><a href="#replication-connection-status" class="headerlink" title="replication_connection_status"></a>replication_connection_status</h4><p>此表显示处理从服务器连接主服务器的IO线程的当前状态<br><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from performance_schema.replication_connection_status;</span><br><span class="line">+<span class="params">---------------------------</span>+<span class="params">--------------------------------------</span>+<span class="params">--------------------------------------</span>+<span class="params">-----------</span>+<span class="params">---------------</span>+<span class="params">---------------------------</span>+<span class="params">--------------------------</span>+<span class="params">-------------------------------------------</span>+<span class="params">-------------------</span>+<span class="params">--------------------</span>+<span class="params">----------------------</span>+</span><br><span class="line">| CHANNEL_NAME              | GROUP_NAME                           | SOURCE_UUID                          | THREAD_ID | SERVICE_STATE | COUNT_RECEIVED_HEARTBEATS | LAST_HEARTBEAT_TIMESTAMP | RECEIVED_TRANSACTION_SET                  | LAST_ERROR_NUMBER | LAST_ERROR_MESSAGE | LAST_ERROR_TIMESTAMP |</span><br><span class="line">+<span class="params">---------------------------</span>+<span class="params">--------------------------------------</span>+<span class="params">--------------------------------------</span>+<span class="params">-----------</span>+<span class="params">---------------</span>+<span class="params">---------------------------</span>+<span class="params">--------------------------</span>+<span class="params">-------------------------------------------</span>+<span class="params">-------------------</span>+<span class="params">--------------------</span>+<span class="params">----------------------</span>+</span><br><span class="line">| group_replication_applier | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa |      NULL | ON            |                         0 | 0000-00-00 00<span class="function">:00</span><span class="function">:00</span>      | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa<span class="function">:1-22</span> |                 0 |                    | 0000-00-00 00<span class="function">:00</span><span class="function">:00</span>  |</span><br><span class="line">+<span class="params">---------------------------</span>+<span class="params">--------------------------------------</span>+<span class="params">--------------------------------------</span>+<span class="params">-----------</span>+<span class="params">---------------</span>+<span class="params">---------------------------</span>+<span class="params">--------------------------</span>+<span class="params">-------------------------------------------</span>+<span class="params">-------------------</span>+<span class="params">--------------------</span>+<span class="params">----------------------</span>+</span><br><span class="line">1 row in <span class="keyword">set</span> <span class="params">(0.00 sec)</span></span><br></pre></td></tr></table></figure></p>
<h5 id="参数解释-2"><a href="#参数解释-2" class="headerlink" title="参数解释"></a>参数解释</h5><table>
<thead>
<tr>
<th>Field</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CHANNEL_NAME</td>
<td style="text-align:left">组复制通道的名称</td>
</tr>
<tr>
<td>GROUP_NAME</td>
<td style="text-align:left">如果此服务器是组的成员，则显示服务器所属的组的名称</td>
</tr>
<tr>
<td>SOURCE_UUID</td>
<td style="text-align:left">组的标识符,类似组名称,被用作组复制期间生成的所有事务的UUID</td>
</tr>
<tr>
<td>THREAD_ID</td>
<td style="text-align:left">IO线程ID</td>
</tr>
<tr>
<td>SERVICE_STATE</td>
<td style="text-align:left">IO状态,ON（线程存在并处于活动状态或空闲状态）,OFF（线程不再存在）或CONNECTING（线程存在并连接到主控制器）</td>
</tr>
<tr>
<td>COUNT_RECEIVED_HEARTBEATS</td>
<td style="text-align:left">从上次重新启动或复位复制从服务器接收到的心跳信号的总数或发出CHANGE MASTER TO语句</td>
</tr>
<tr>
<td>LAST_HEARTBEAT_TIMESTAMP</td>
<td style="text-align:left">YYMMDD HH:MM:SS格式中 的时间戳，显示复制从站接收到最新的心跳信号的时间</td>
</tr>
<tr>
<td>RECEIVED_TRANSACTION_SET</td>
<td style="text-align:left">此GTID集合中的事务已由该组的此成员接收</td>
</tr>
<tr>
<td>LAST_ERROR_NUMBER</td>
<td style="text-align:left">导致IO线程停止的错误号</td>
</tr>
<tr>
<td>LAST_ERROR_MESSAGE</td>
<td style="text-align:left">导致IO线程停止的错误消息</td>
</tr>
<tr>
<td>LAST_ERROR_TIMESTAMP</td>
<td style="text-align:left">YYMMDD HH:MM:SS格式 的时间戳,IO发生错误的时间</td>
</tr>
</tbody>
</table>
<h5 id="与show-slave-status的对应关系"><a href="#与show-slave-status的对应关系" class="headerlink" title="与show slave status的对应关系"></a>与show slave status的对应关系</h5><table>
<thead>
<tr>
<th>replication_connection_status Column</th>
<th style="text-align:left">SHOW SLAVE STATUS Column</th>
</tr>
</thead>
<tbody>
<tr>
<td>SOURCE_UUID</td>
<td style="text-align:left">Master_UUID</td>
</tr>
<tr>
<td>THREAD_ID</td>
<td style="text-align:left">None</td>
</tr>
<tr>
<td>SERVICE_STATE</td>
<td style="text-align:left">Slave_IO_Running</td>
</tr>
<tr>
<td>RECEIVED_TRANSACTION_SET</td>
<td style="text-align:left">Retrieved_Gtid_Set</td>
</tr>
<tr>
<td>LAST_ERROR_NUMBER</td>
<td style="text-align:left">Last_IO_Errno</td>
</tr>
<tr>
<td>LAST_ERROR_MESSAGE</td>
<td style="text-align:left">Last_IO_Error</td>
</tr>
<tr>
<td>LAST_ERROR_TIMESTAMP</td>
<td style="text-align:left">Last_IO_Error_Timestamp</td>
</tr>
</tbody>
</table>
<h4 id="replication-applier-status"><a href="#replication-applier-status" class="headerlink" title="replication_applier_status"></a>replication_applier_status</h4><p>此表显示从服务器上当前的一般事务执行状态<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from performance<span class="emphasis">_schema.replication_</span>applier<span class="emphasis">_status;</span></span><br><span class="line"><span class="emphasis">+---------------------------+---------------+-----------------+----------------------------+</span></span><br><span class="line"><span class="emphasis">| CHANNEL_</span>NAME              | SERVICE<span class="emphasis">_STATE | REMAINING_</span>DELAY | COUNT<span class="emphasis">_TRANSACTIONS_</span>RETRIES |</span><br><span class="line"><span class="code">+---------------------------+</span>---------------<span class="code">+-----------------+</span>----------------------------+</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | ON            |            NULL |                          0 |</span><br><span class="line"><span class="code">+---------------------------+</span>---------------<span class="code">+-----------------+</span>----------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h5 id="参数解释-3"><a href="#参数解释-3" class="headerlink" title="参数解释"></a>参数解释</h5><table>
<thead>
<tr>
<th>Field</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CHANNEL_NAME</td>
<td style="text-align:left">组复制通道的名称</td>
</tr>
<tr>
<td>SERVICE_STATE</td>
<td style="text-align:left">显示复制通道状态是ON还是OFF</td>
</tr>
<tr>
<td>REMAINING_DELAY</td>
<td style="text-align:left">如果从站在DESIRED_DELAY主站应用事件之后等待 秒数，则此字段包含剩余的延迟秒数。</td>
</tr>
<tr>
<td>COUNT_TRANSACTIONS_RETRIES</td>
<td style="text-align:left">显示由于从属SQL线程未能应用事务而发生的重试次数。</td>
</tr>
</tbody>
</table>
<h5 id="与show-slave-status的对应关系-1"><a href="#与show-slave-status的对应关系-1" class="headerlink" title="与show slave status的对应关系"></a>与show slave status的对应关系</h5><table>
<thead>
<tr>
<th>replication_connection_status Column</th>
<th style="text-align:left">SHOW SLAVE STATUS Column</th>
</tr>
</thead>
<tbody>
<tr>
<td>SERVICE_STATE</td>
<td style="text-align:left">None</td>
</tr>
<tr>
<td>REMAINING_DELAY</td>
<td style="text-align:left">SQL_Remaining_Delay</td>
</tr>
</tbody>
</table>
<h4 id="组复制中的server状态"><a href="#组复制中的server状态" class="headerlink" title="组复制中的server状态"></a>组复制中的server状态</h4><table>
<thead>
<tr>
<th>Field</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">Group Synchronized</th>
</tr>
</thead>
<tbody>
<tr>
<td>ONLINE</td>
<td style="text-align:left">该成员可以作为一个具有所有功能的组成员,这意味着客户端可以连接并开始执行事务</td>
<td style="text-align:left">Yes</td>
</tr>
<tr>
<td>RECOVERING</td>
<td style="text-align:left">该成员正在成为该组的有效成员,并且正处于恢复过程中,从数据源节点接收状态信息</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td>OFFLINE</td>
<td style="text-align:left">插件已加载,但成员不属于任何组</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td>ERROR</td>
<td style="text-align:left">本地成员的状态,只要恢复阶段或应用更改时出现错误,server就会进入此状态</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td>UNREACHABLE</td>
<td style="text-align:left">每当本地故障检测器怀疑某个给定的server可能由于已经崩溃或被意外地断开而不可访问时,server的状态显示为”UNREACHABLE”</td>
<td style="text-align:left">No</td>
</tr>
</tbody>
</table>
<h4 id="threads"><a href="#threads" class="headerlink" title="threads"></a>threads</h4><p>group replication线程的状态信息可以通过performance_schema.threads表进行查询，目前可以查询到group replication的线程如下：  </p>
<ul>
<li>thread/group_rpl/THD_applier_module_receiver</li>
<li>thread/group_rpl/THD_certifier_broadcast</li>
<li>thread/group_rpl/THD_recovery<h3 id="新成员加入组"><a href="#新成员加入组" class="headerlink" title="新成员加入组"></a>新成员加入组</h3><h4 id="配置group-replication-recovery通道"><a href="#配置group-replication-recovery通道" class="headerlink" title="配置group_replication_recovery通道"></a>配置group_replication_recovery通道</h4>当新成员加入一个group replication组后，首先要从其他节点上把它加入之前的数据复制过来。这些以前的数据不能过group replication的通信协议进行复制，而是使用了异步复制的机制。group replication需要使用一个名叫group_replication_recovery的异步复制通道(Channel)。用户必须要提前配置这个通道，不过只需要为这个通道配置连接需要的用户名和密码，其他参数在group replication插件启动group_replication_recovery通道时会自动进行配置。  </li>
<li>change master to master_host=’rpl_user’,master_password=’rpl_pass’ fro channel = ‘group_replication_recovery’;</li>
<li>连接到哪个成员上去复制数据，是由group replication插件随机选择的，因此为group_replication_recovery配置的用户要在每一个成员上存在<br>在启动group_replication_recovery通道之前，group replication会自动为其配置master_host和master_port。当一个成员加入组时，会收到组内其他成员的配置信息。配置信息中包括主机名和MySQL服务端口号。主机名和服务端口号是从全局只读变量hostname和port中获取的。如果hostname无法正常解析成ip地址或网络中使用了网络地址映射，group_replication_recovery通道就无法正常工作。有如下两种办法来解决这个问题：  </li>
<li>在/etc/hosts中配置所有成员的主机名和ip地址的对应关系</li>
<li>配置MySQL的report_host和report_port的命令行参数。如果用户配置了report_host或report_port，那么group replication会优先使用这个变量中的地址和端口<h4 id="成员加入组的步骤"><a href="#成员加入组的步骤" class="headerlink" title="成员加入组的步骤"></a>成员加入组的步骤</h4>MySQL的相关配置和创建复制用户的步骤略，group replication加入组的步骤如下：</li>
<li>INSTALL PLUGIN group_replication SONAME ‘group_replication.so’;</li>
<li>SET GLOBAL group_replication_group_name = “aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa”;</li>
<li>SET GLOBAL group_replication_local_address= “127.0.0.1:10014”</li>
<li>SET GLOBAL group_replication_group_seeds= “127.0.0.1:10011,127.0.0.1:10012,127.0.0.1:10013,127.0.0.1:10014”</li>
<li>CHANGE MASTER TO MASTER_USER=’rpl_user’,MASTER_PASSWORD=’rpl_pass’ FOR CHANNEL ‘group_replication_recovery’;</li>
<li>START GROUP_REPLICATION;<br>这里不再做演示，还是保持上文中三节点。<h3 id="强制移除故障成员"><a href="#强制移除故障成员" class="headerlink" title="强制移除故障成员"></a>强制移除故障成员</h3>当故障导致半数以上的成员不可用时，group replication就不能对外提供服务，当这种情况发生时，可以设置指定的成员能够立刻对外提供服务。虽然冗余能力不好，但至少能保障业务不中断。可通过以下设置：  </li>
<li>SET GLOBAL group_replication_force_members = <a href="ip:port,ip:port" target="_blank" rel="noopener">ip:port,ip:port</a><br>group_replication_force_members中配置的是成员地址的列表，只需要在列表中的任意一个成员上设置即可，这个就是强制group replication用参数中的几个成员来构成组，把其他成员从组中移除出去。<h2 id="故障演练"><a href="#故障演练" class="headerlink" title="故障演练"></a>故障演练</h2>通过模拟其中一个节点故障后,主节点是否会自动迁移,故障节点恢复后,数据是否会自动同步<h3 id="查看当前组复制状态"><a href="#查看当前组复制状态" class="headerlink" title="查看当前组复制状态"></a>查看当前组复制状态</h3>登录节点1,查看组复制状态,确认当前节点1为主节点<figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock   </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 30</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM performance<span class="emphasis">_schema.replication_</span>group<span class="emphasis">_members;</span></span><br><span class="line"><span class="emphasis">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span></span><br><span class="line"><span class="emphasis">| CHANNEL_</span>NAME              | MEMBER<span class="emphasis">_ID                            | MEMBER_</span>HOST | MEMBER<span class="emphasis">_PORT | MEMBER_</span>STATE |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from performance<span class="emphasis">_schema.global_</span>status where variable<span class="emphasis">_name = 'group_</span>replication<span class="emphasis">_primary_</span>member';</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| VARIABLE<span class="emphasis">_NAME                    | VARIABLE_</span>VALUE                       |</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| group<span class="emphasis">_replication_</span>primary<span class="emphasis">_member | c0acc2c7-d58a-11e7-b59f-00163e00dc49 |</span></span><br><span class="line"><span class="emphasis">+----------------------------------+--------------------------------------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="模拟主节点故障"><a href="#模拟主节点故障" class="headerlink" title="模拟主节点故障"></a>模拟主节点故障</h3><figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; shutdown;</span><br><span class="line">Query OK, <span class="number">0</span> <span class="built_in">rows</span> affected (<span class="number">0.00</span> <span class="built_in">sec</span>)</span><br></pre></td></tr></table></figure>
<h3 id="确认当前组复制状态"><a href="#确认当前组复制状态" class="headerlink" title="确认当前组复制状态"></a>确认当前组复制状态</h3><p>节点1的9001服务已经不存在,通过登录9002查看组成员状态,9002节点已经成为新节点<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# netstat -tunlp|grep mysql|grep 900                                         </span><br><span class="line">tcp        0      0 0.0.0.0:9002                0.0.0.0:*                   LISTEN      22034/mysqld        </span><br><span class="line">tcp        0      0 0.0.0.0:9003                0.0.0.0:*                   LISTEN      6059/mysqld         </span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 28</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM performance<span class="emphasis">_schema.replication_</span>group<span class="emphasis">_members;</span></span><br><span class="line"><span class="emphasis">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span></span><br><span class="line"><span class="emphasis">| CHANNEL_</span>NAME              | MEMBER<span class="emphasis">_ID                            | MEMBER_</span>HOST | MEMBER<span class="emphasis">_PORT | MEMBER_</span>STATE |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from performance<span class="emphasis">_schema.global_</span>status where variable<span class="emphasis">_name = 'group_</span>replication<span class="emphasis">_primary_</span>member';</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| VARIABLE<span class="emphasis">_NAME                    | VARIABLE_</span>VALUE                       |</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| group<span class="emphasis">_replication_</span>primary<span class="emphasis">_member | cf04e66c-d58a-11e7-b97e-00163e00dc49 |</span></span><br><span class="line"><span class="emphasis">+----------------------------------+--------------------------------------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="组复制新主节点插入数据"><a href="#组复制新主节点插入数据" class="headerlink" title="组复制新主节点插入数据"></a>组复制新主节点插入数据</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table test.t2(id int unsigned not null auto<span class="emphasis">_increment primary key,age int);</span></span><br><span class="line"><span class="emphasis">Query OK, 0 rows affected (0.02 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; insert into test.t2 values(null,111111);</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; select * from test.t2;</span></span><br><span class="line"><span class="emphasis">+----+--------+</span></span><br><span class="line"><span class="emphasis">| id | age    |</span></span><br><span class="line"><span class="emphasis">+----+--------+</span></span><br><span class="line"><span class="emphasis">|  2 | 111111 |</span></span><br><span class="line"><span class="emphasis">+----+--------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="从节点查看数据"><a href="#从节点查看数据" class="headerlink" title="从节点查看数据"></a>从节点查看数据</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock   </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 46</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test.t2;</span><br><span class="line"><span class="code">+----+</span>--------+</span><br><span class="line">| id | age    |</span><br><span class="line"><span class="code">+----+</span>--------+</span><br><span class="line">|  2 | 111111 |</span><br><span class="line"><span class="code">+----+</span>--------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<h3 id="故障节点恢复"><a href="#故障节点恢复" class="headerlink" title="故障节点恢复"></a>故障节点恢复</h3><p>故障节点恢复后,登录实例,启动组复制<br><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# base/bin/mysqld_safe --defaults-file=/hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/conf/s1.cnf &amp; </span><br><span class="line">[<span class="number">6</span>] <span class="number">22692</span></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# <span class="number">2017</span>-<span class="number">12</span>-01T07:<span class="number">35</span>:<span class="number">42.</span>377430Z mysqld_safe Logging to <span class="string">'/hwdata/data/mysql5.7.20/data/s1/jiessie.err'</span>.</span><br><span class="line"><span class="number">2017</span>-<span class="number">12</span>-01T07:<span class="number">35</span>:<span class="number">42.</span>396416Z mysqld_safe Starting mysqld daemon with databases from /hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/data/s1</span><br><span class="line"></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# netstat -tunlp|grep mysql|grep <span class="number">900</span></span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">9001</span>                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">23135</span>/mysqld        </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">9002</span>                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">22034</span>/mysqld        </span><br><span class="line">tcp        <span class="number">0</span>      <span class="number">0</span> <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:<span class="number">9003</span>                <span class="number">0.0</span><span class="meta">.0</span><span class="meta">.0</span>:*                   LISTEN      <span class="number">6059</span>/mysqld         </span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]# base/bin/mysql -uroot -S /hwdata/data/mysql5<span class="meta">.7</span><span class="meta">.20</span>/data/s1/s1.sock -e <span class="string">"START GROUP_REPLICATION;"</span></span><br><span class="line">[root@jiessie mysql5<span class="meta">.7</span><span class="meta">.20</span>]#</span><br></pre></td></tr></table></figure></p>
<h3 id="再次查看组复制状态及插入数据状态"><a href="#再次查看组复制状态及插入数据状态" class="headerlink" title="再次查看组复制状态及插入数据状态"></a>再次查看组复制状态及插入数据状态</h3><p>故障节点已经加入到组复制中,同时故障期间插入的数也已经同步过来,主节点还是节点2的9002实例<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 48</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM performance<span class="emphasis">_schema.replication_</span>group<span class="emphasis">_members;</span></span><br><span class="line"><span class="emphasis">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span></span><br><span class="line"><span class="emphasis">| CHANNEL_</span>NAME              | MEMBER<span class="emphasis">_ID                            | MEMBER_</span>HOST | MEMBER<span class="emphasis">_PORT | MEMBER_</span>STATE |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group<span class="emphasis">_replication_</span>applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from performance<span class="emphasis">_schema.global_</span>status where variable<span class="emphasis">_name = 'group_</span>replication<span class="emphasis">_primary_</span>member';</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| VARIABLE<span class="emphasis">_NAME                    | VARIABLE_</span>VALUE                       |</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| group<span class="emphasis">_replication_</span>primary<span class="emphasis">_member | cf04e66c-d58a-11e7-b97e-00163e00dc49 |</span></span><br><span class="line"><span class="emphasis">+----------------------------------+--------------------------------------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; select * from test.t2;</span></span><br><span class="line"><span class="emphasis">+----+--------+</span></span><br><span class="line"><span class="emphasis">| id | age    |</span></span><br><span class="line"><span class="emphasis">+----+--------+</span></span><br><span class="line"><span class="emphasis">|  2 | 111111 |</span></span><br><span class="line"><span class="emphasis">+----+--------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br></pre></td></tr></table></figure></p>
<h2 id="组复制系统变量"><a href="#组复制系统变量" class="headerlink" title="组复制系统变量"></a>组复制系统变量</h2><table>
<thead>
<tr>
<th>变量名</th>
<th style="text-align:left">变量范围</th>
<th style="text-align:left">动态变量</th>
<th style="text-align:left">类型</th>
<th style="text-align:left">默认</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_group_name" target="_blank" rel="noopener">group_replication_group_name</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">此server实例所属组名称,须是UUID格式</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_start_on_boot" target="_blank" rel="noopener">group_replication_start_on_boot</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">ON</td>
<td style="text-align:left">server是否应在自身启动期间启动组复制</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_local_address" target="_blank" rel="noopener">group_replication_local_address</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">作为本地地址,格式为主机:端口</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_member_weight" target="_blank" rel="noopener">group_replication_member_weight</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">50</td>
<td style="text-align:left">可以分配成员的百分比权重,影响成员在发生故障转移时作为主要成员选举的机会</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_group_seeds" target="_blank" rel="noopener">group_replication_group_seeds</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">提供加入成员的成员列表,其中加入成员需要的数据以获得与该组的同步</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_force_members" target="_blank" rel="noopener">group_replication_force_members</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">以逗号分隔开的组内其他成员的地址列表.此选项用于强制建立新的组成员关系,在此过程中已排除的成员不接收新的视图并且被排除在外.您需要手动移除已排除的server</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_bootstrap_group" target="_blank" rel="noopener">group_replication_bootstrap_group</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">OFF</td>
<td style="text-align:left">配置此server以引导组,此选项只能在一个server上设置,且只能在首次启动组或重启整个组时设置.组被引导后,将此选项设置为OFF.</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_poll_spin_loops" target="_blank" rel="noopener">group_replication_poll_spin_loops</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">0</td>
<td style="text-align:left">在组通信线程等待传入更多的网络信息之前,等待mutex被释放的次数</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_retry_count" target="_blank" rel="noopener">group_replication_recovery_retry_count</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">10</td>
<td style="text-align:left">要加入的成员尝试连接到可用数据源节点的次数</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_reconnect_interval" target="_blank" rel="noopener">group_replication_recovery_reconnect_interval</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">60</td>
<td style="text-align:left">在组中找不到数据源节点时,重新尝试连接的时间间隔</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_use_ssl" target="_blank" rel="noopener">group_replication_recovery_use_ssl</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">OFF</td>
<td style="text-align:left">组复制恢复通道是否使用SSL</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_ca" target="_blank" rel="noopener">group_replication_recovery_ssl_ca</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">包含受信任SSL证书颁发机构列表的文件的路径</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_capath" target="_blank" rel="noopener">group_replication_recovery_ssl_capath</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">包含受信任SSL证书颁发证书的目录路径</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_cert" target="_blank" rel="noopener">group_replication_recovery_ssl_cert</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">用于建立安全连接的SSL证书文件的名称</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_key" target="_blank" rel="noopener">group_replication_recovery_ssl_key</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">用于建立安全连接的SSL密钥文件的名称</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_cipher" target="_blank" rel="noopener">group_replication_recovery_ssl_cipher</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">用于SSL加密的密码列表</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_crl" target="_blank" rel="noopener">group_replication_recovery_ssl_crl</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">包含具有证书撤销列表文件的路径</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_crlpath" target="_blank" rel="noopener">group_replication_recovery_ssl_crlpath</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">包含具有证书撤销列表文件的路径</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_verify_server_cert" target="_blank" rel="noopener">group_replication_recovery_ssl_verify_server_cert</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">OFF</td>
<td style="text-align:left">在恢复过程中用于检查数据源节点发送证书中的”通用名称”</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_complete_at" target="_blank" rel="noopener">group_replication_recovery_complete_at</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">enumeration</td>
<td style="text-align:left">TRANSACTIONS_APPLIED</td>
<td style="text-align:left">状态传输后处理缓存中的事务时的恢复策略.此选项指定成员在”接收到加入群组(TRANSACTIONS_CERTIFIED)之前遗漏的所有事务”或”收到并应用了这些事务(TRANSACTIONS_APPLIED)”之后,是否标记在线</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_components_stop_timeout" target="_blank" rel="noopener">group_replication_components_stop_timeout</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">31536000</td>
<td style="text-align:left">组复制在关闭时等待每个组件的超时时间,以秒为单位</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_allow_local_lower_version_join" target="_blank" rel="noopener">group_replication_allow_local_lower_version_join</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">OFF</td>
<td style="text-align:left">即使当前server的插件版本比组的插件版本低,也允许它加入组</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_allow_local_disjoint_gtids_join" target="_blank" rel="noopener">group_replication_allow_local_disjoint_gtids_join</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">OFF</td>
<td style="text-align:left">即使含有组中不存在的事务,也允许当前server加入组,此选项要慎重,可能会破坏组内一致性</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_auto_increment_increment" target="_blank" rel="noopener">group_replication_auto_increment_increment</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">7</td>
<td style="text-align:left">确定在此server实例上执行的连续事务之间的步长</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_compression_threshold" target="_blank" rel="noopener">group_replication_compression_threshold</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">1000000</td>
<td style="text-align:left">以字节为单位,超过该值将强制执行lz4压缩,当设置为0时,压缩设置无效</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_gtid_assignment_block_size" target="_blank" rel="noopener">group_replication_gtid_assignment_block_size</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">1000000</td>
<td style="text-align:left">为每个成员保留的连接GTID数量,每个成员在开始时会消耗掉一些,当需要时在获取更多个</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_ssl_mode" target="_blank" rel="noopener">group_replication_ssl_mode</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">enumeration</td>
<td style="text-align:left">DISABLED</td>
<td style="text-align:left">指定组复制成员之间连接的安全状态</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_single_primary_mode" target="_blank" rel="noopener">group_replication_single_primary_mode</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">ON</td>
<td style="text-align:left">设置组自动选择一个server来处理读写工作,这个server是主(primary),所有其他都是从(secondaries)</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_transaction_size_limit" target="_blank" rel="noopener">group_replication_transaction_size_limit</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">0</td>
<td style="text-align:left">配置组接受最大事务大小,以字节为单位,大于这个事务被回滚.当设置为0时,无限制</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_unreachable_majority_timeout" target="_blank" rel="noopener">group_replication_unreachable_majority_timeout</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">0</td>
<td style="text-align:left">配置在离开组之前遭受网络分区且无法连接到大多数成员的成员需要等待多长时间,默认情况为0,这意味着由于网络分区而成为少数的成员永远等待连接组.</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_enforce_update_everywhere_checks" target="_blank" rel="noopener">group_replication_enforce_update_everywhere_checks</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">OFF</td>
<td style="text-align:left">多主模式下为多主更新或禁用严格一致性检查</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_flow_control_mode" target="_blank" rel="noopener">group_replication_flow_control_mode</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">enumeration</td>
<td style="text-align:left">QUOTA</td>
<td style="text-align:left">指定启用限流模式,不需要重置组复制就可以修改此变量</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_flow_control_certifier_threshold" target="_blank" rel="noopener">group_replication_flow_control_certifier_threshold</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">25000</td>
<td style="text-align:left">触发限流的验证队列的阈值,不需要重置组复制就可以修改此变量</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_flow_control_applier_threshold" target="_blank" rel="noopener">group_replication_flow_control_applier_threshold</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">25000</td>
<td style="text-align:left">触发限流的应用队列的阈值,不需要重置组复制就可以修改此变量</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_ip_whitelist" target="_blank" rel="noopener">group_replication_ip_whitelist</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">AUTOMATIC</td>
<td style="text-align:left">指定允许哪些主机可以访问组,默认为AUTOMATIC,它允许来自主机上的私有子网的连接,多个以逗号分隔</td>
</tr>
</tbody>
</table>
<h2 id="组复制的多主和单主模式"><a href="#组复制的多主和单主模式" class="headerlink" title="组复制的多主和单主模式"></a>组复制的多主和单主模式</h2><p>默认为单主模式,组中的成员不可能以不同的模式部署,例如一个配置为多主模式,另一个配置为单主模式.要切换模式,组和服务器之间需要不的操作配置重新启动.无论部署模式如何,组复制不处理客户端故障切换,必须由应用程序本身,连接器或中间件框架如代理或路由器来处理.  </p>
<h3 id="单主模式"><a href="#单主模式" class="headerlink" title="单主模式"></a>单主模式</h3><p>在此模式下,该组具有设置为读写械的单主服务器,组中的所有其他成员都设置为只读模式(超级只读模式super_read_only),所有其他加入的节点自动识别主节点并设置为自己为只读.</p>
<h4 id="选主过程"><a href="#选主过程" class="headerlink" title="选主过程"></a>选主过程</h4><p>参考官方流程图:<br><img src="https://dev.mysql.com/doc/refman/5.7/en/images/single-primary-election.png" alt="image">在单主机模式下，将禁用在多主机模式下部署的某些检查，因为系统会强制每次只有一个写入节点。例如，允许对具有级联外键的表进行更改，而在多主模式下不允许。在主节点故障时，自动选举机制选择下一个主节点。通过按字典顺序（使用其UUID）并选择列表中的第一个节点来排序剩余的节点来选择下一个主节点,可通过group_replication_member_weight此参数影响选主。如果主节点从组中删除，则执行选择，并从组中的其余节点中选择新的主节点，这个选择按照词典顺序排序节点UUID并选择第一个来执行。一旦选择了新的主节点，其他节点将设置为从节点，从节点为只读。</p>
<h3 id="多主模式"><a href="#多主模式" class="headerlink" title="多主模式"></a>多主模式</h3><p>在多主模式下，没有单个主模式的概念，也没有选举程序，因为没有节点发挥任何特殊的作用。加入组时，所有服务器都设置为读写模式。<br>在多主模式下部署时,将检查语句以确保他们与模式兼容,以多主模式部署组复制时进行以下检查:  </p>
<ol>
<li>如果一个事务在SERIALIZABLE隔离级别下执行，那么当它自己与该组同步时，它的提交失败。</li>
<li>如果事务针对具有级联约束的外键的表执行，则在与组自身同步时，事务无法提交。<br>这些检查可以通过设置选项来禁用 group_replication_enforce_update_everywhere_checks 到FALSE。在单主模式下部署时，必须将此选项设置为FALSE。<h4 id="客户端故障转移"><a href="#客户端故障转移" class="headerlink" title="客户端故障转移"></a>客户端故障转移</h4>参考官方流程图:<br><img src="https://dev.mysql.com/doc/refman/5.7/en/images/multi-primary.png" alt="image"><h4 id="自增字段的处理"><a href="#自增字段的处理" class="headerlink" title="自增字段的处理"></a>自增字段的处理</h4>当使用多主模式时，需要设置autoincrement相关的参数来保证自增字段在每个成员上产生不同的值。group replication提供了两种配置方式，分别如下：</li>
<li>直接配置MySQL的系统变量，通过命令来配置时，需要在所有成员上配置下面两个参数</li>
</ol>
<ul>
<li>set global auto_increment_offset = N;</li>
<li>set global auto_increment_increment = N;</li>
</ul>
<ol start="2">
<li>通过group replication插件来配置，group replication插件定义了一个新的参数来配置自增字段的大小，上面的参数列表中也有解释</li>
</ol>
<ul>
<li>set global group_replication_auto_increment_increment = N;<br>group_replication_auto_increment_increment的默认值是7。如果自增值的浪费不对业务千万影响，可以不用修改这个值。group replication没有提供新的参数来设置自增值的偏移，而是将MySQL服务器的server-id看作自增值的偏移。如果用户的server-id本来就是按照1、2、3这样的顺序配置的，就不需要再做额外的配置。在启动group replication插件时，它会检测用户是否配置了MySQL的自增变量。如果用户没有配置这两个参数（auto_increment_offset和auto_increment_increment都为1），则会自动将group_replication_auto_increment_increment和server-id的值设置到MySQL的auto_increment_increment和auto_increment_offset全局变量中。<br>自增变量将从1开始的连续自增值划分为固定大小的段，各个MySQL服务器分别使用段内不同偏移量的自增值。auto_increment_increment代表段的大小，每个成员都应该配置相同的段大小。而auto_increment_offset是本成员 的自增值在段内的偏移。每个成员应该设置不同的偏移量。假设段的大小设为5，成员A的偏移量设为1，成员B的偏移量设为2，那么成员A上产生的自增值为：1、6、11、16……，成员B上产生的自增值为：2、7、12、17……。如下图所示：<h5 id="自增ID示例图"><a href="#自增ID示例图" class="headerlink" title="自增ID示例图"></a>自增ID示例图</h5></li>
<li>| 偏移1 | 偏移2 | 偏移3 | 偏移4 | 偏移5<br>—|—|—|—|—|—<br>第一段 | 1 | 2 | 3 | 4 | 5 |<br>第二段 | 6 | 7 | 8 | 9 | 10 |<br>第三段 | 11 | 12 | 13 | 14 | 15 |<br>第四段 | 16 | 17 | 18 | 19 | 20 |<br>… | … | … | … | … | … |<br>可以看出，自增字段的大小依赖于group replication组中的成员的多少。auto_increment_increment最小要等于group replication组内的数量。如果段的大小等于组内的数量，则所有的自增id都会被使用。如果段的大小大于组内的成员的数量，则有一部自增值永远不会被使用，会千万一定的浪费。比如，组内有3个成员，偏移分别是1、2、3，而段的大小是5，那么偏移4和5上的值就会被浪费掉。考虑到group replication组的扩展，最好将段的大小设置得比现有的组内成员数量大一些。这样虽然会浪费一些自增值，但是扩展会很简单。在使用的过程中变更自增字段的大小，处理起来会比较麻烦，所以要提前规划好。<h5 id="自增字段演示"><a href="#自增字段演示" class="headerlink" title="自增字段演示"></a>自增字段演示</h5><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e "show variables like <span class="emphasis">'server_id'</span>;"</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| server_</span>id     | 1     |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock -e "show variables like <span class="emphasis">'server_id'</span>;"  </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| server_</span>id     | 2     |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock -e "show variables like <span class="emphasis">'server_id'</span>;"   </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| server_</span>id     | 3     |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 37</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like <span class="emphasis">'group_replication_auto_increment_increment'</span>;</span><br><span class="line"><span class="code">+--------------------------------------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name                              | Value |</span></span><br><span class="line"><span class="emphasis">+--------------------------------------------+-------+</span></span><br><span class="line"><span class="emphasis">| group_</span>replication<span class="emphasis">_auto_</span>increment<span class="emphasis">_increment | 5     |</span></span><br><span class="line"><span class="emphasis">+--------------------------------------------+-------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.01 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; select * from performance_</span>schema.global<span class="emphasis">_status where variable_</span>name = <span class="emphasis">'group_replication_primary_member'</span>;</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| VARIABLE<span class="emphasis">_NAME                    | VARIABLE_</span>VALUE                       |</span><br><span class="line"><span class="code">+----------------------------------+</span>--------------------------------------+</span><br><span class="line">| group<span class="emphasis">_replication_</span>primary<span class="emphasis">_member | c0acc2c7-d58a-11e7-b59f-00163e00dc49 |</span></span><br><span class="line"><span class="emphasis">+----------------------------------+--------------------------------------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; SELECT * FROM performance_</span>schema.replication<span class="emphasis">_group_</span>members;</span><br><span class="line"><span class="code">+---------------------------+</span>--------------------------------------<span class="code">+-------------+</span>-------------<span class="code">+--------------+</span></span><br><span class="line">| CHANNEL<span class="emphasis">_NAME              | MEMBER_</span>ID                            | MEMBER<span class="emphasis">_HOST | MEMBER_</span>PORT | MEMBER<span class="emphasis">_STATE |</span></span><br><span class="line"><span class="emphasis">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span></span><br><span class="line"><span class="emphasis">| group_</span>replication<span class="emphasis">_applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span></span><br><span class="line"><span class="emphasis">| group_</span>replication<span class="emphasis">_applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span></span><br><span class="line"><span class="emphasis">| group_</span>replication<span class="emphasis">_applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span></span><br><span class="line"><span class="emphasis">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span></span><br><span class="line"><span class="emphasis">3 rows in set (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">mysql&gt; create table test.t0(id int unsigned not null primary key auto_</span>increment,name varchar(20));            </span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test.t0 values(null,<span class="emphasis">'111'</span>),(null,<span class="emphasis">'222'</span>),(null,<span class="emphasis">'333'</span>);</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test.t0;</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">| id | name |</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">|  1 | 111  |</span><br><span class="line">|  6 | 222  |</span><br><span class="line">| 11 | 333  |</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 27</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test.t0 values(null,<span class="emphasis">'aaa'</span>),(null,<span class="emphasis">'bbb'</span>),(null,<span class="emphasis">'ccc'</span>);</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test.t0;</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">| id | name |</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">|  1 | 111  |</span><br><span class="line">|  2 | aaa  |</span><br><span class="line">|  6 | 222  |</span><br><span class="line">|  7 | bbb  |</span><br><span class="line">| 11 | 333  |</span><br><span class="line">| 12 | ccc  |</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 23</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="emphasis">'help;'</span> or <span class="emphasis">'\h'</span> for help. Type <span class="emphasis">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test.t0 values(null,<span class="emphasis">'123'</span>),(null,<span class="emphasis">'456'</span>),(null,<span class="emphasis">'789'</span>);</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test.t0;</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">| id | name |</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">|  1 | 111  |</span><br><span class="line">|  2 | aaa  |</span><br><span class="line">|  3 | 123  |</span><br><span class="line">|  6 | 222  |</span><br><span class="line">|  7 | bbb  |</span><br><span class="line">|  8 | 456  |</span><br><span class="line">| 11 | 333  |</span><br><span class="line">| 12 | ccc  |</span><br><span class="line">| 13 | 789  |</span><br><span class="line"><span class="code">+----+</span>------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie percona]#</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="DDL语句并发执行的问题"><a href="#DDL语句并发执行的问题" class="headerlink" title="DDL语句并发执行的问题"></a>DDL语句并发执行的问题</h4><p>多主复制时，通过冲突检测来辨别有冲突的事务，有冲突的事务通过回滚操作来处理。MySQL5.7上的DDL不是原子操作无法回滚，因此group replication没有对DDL做冲突检测。换句话说，DDL语句不会和其他任何语句冲突（包括DML和DDL）。如果DDL和有冲突的语句在不同的成员上同时执行，可能导致错误或数据不一致。假设在成员A上执行如下事务：  </p>
<ul>
<li>BEGIN;</li>
<li>INSERT INTO t1 values(1);<br>此时，成员B上执行以下语句：  </li>
<li>TRUNCATE TABLE t1;<br>成员A上接着执行：  </li>
<li>COMMIT;<br>成员A上两个事务的执行顺序是：  </li>
<li>INSERT INTO t1 VALUES(1);</li>
<li>TRUNCATE TABLE t1;<br>成员B上两个事务的执行顺序是：  </li>
<li>TRUNCATE TABLE t1;</li>
<li>INSERT INTO t1 VALUES(1);<br>这就会导致两个成员上数据的不一致。因此多主模式下，执行任何DDL前，要将可能有冲突的事务迁移到同一台MySQL服务器上，再开始执行DDL语句。<h2 id="组复制基本原理"><a href="#组复制基本原理" class="headerlink" title="组复制基本原理"></a>组复制基本原理</h2><h3 id="状态机复制"><a href="#状态机复制" class="headerlink" title="状态机复制"></a>状态机复制</h3>本质上来说，group replication是一个状态机复制的集群。在状态机复制的架构中，数据库被当作一个状态机。每一次写操作都会导致数据库的状态变化。为了创建一个高可用的数据库集群，有一个组件将这些操作按照同样的顺序发送到多个初始状态一致的数据库上，让这些数据库执行同样的操作。因为初始状态相同，每次执行的操作也相同，所以每次状态变化后各个数据库服务器上的数据保持一致。下图是一个非常简单的状态机复制的示意图。<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct1.png" alt="image"><br>假设图中数据库DB1、DB2和DB3的初始状态是相同的，事务T1、T2和T3分别如下：  </li>
</ul>
<ol>
<li>#T1<blockquote>
<p>DELETE FROM t1 WHERE pk = 1;</p>
</blockquote>
</li>
<li>#T2<blockquote>
<p>UPDATE t1 SET c1 = 100 WHERE pk = 1;</p>
</blockquote>
</li>
<li>#T3<blockquote>
<p>UPDATE t1 SET c1 = 50 WHERE pk = 1;<br>3个客户端并发地将这3个事务发送到事务分发器上，事务分发器首先对这3个事务进行排序 ，然后按照同样的顺序（T3、T1、T2）并发地发送到DB1、DB2和DB3这3个数据库上去执行。T3最先在DB1、DB2和DB3上执行，执行完后，DB1、DB2和DB3上的结果相同。接着T1被执行，执行后DB1、DB2和DB3上t1表中pk为1的记录都被删除了。最后T2被执行，由于T1删除了记录，因此T2执行时会失败。T2在DB1、DB2和DB3上都会失败，所以DB1、DB2和DB3的数据仍然是一致的。  </p>
</blockquote>
<h3 id="分布式的状态机复制"><a href="#分布式的状态机复制" class="headerlink" title="分布式的状态机复制"></a>分布式的状态机复制</h3>在上图的模型中，事务分发器是一个单点故障点。为了避免单点故障，可以采用分布式的状态机复制。在分布式的状态机复制中，有多个事务分发器，它们彼此相互通信。事务分发器可以同时接收事务请求，就像单个事务分发器同时接收事务请求一样。从应用层面来说并发的事务发到同一个事务分发器和发到不同的事务分发器上效果是一样的。事务分发器之间会相互通信，把所有的事务汇总、排序。最终，每个事务分发器上都有一份完整的排好序的事务请求。每个事务分发器只连接到一台数据库服务器上，并负责把事务请求依次发送到这个相连的数据库上去执行。下图所示的是分布式状态机复制的一个模式。<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct2.png" alt="image"><br>数据库DB1、DB2和DB3的初始状态是相同的，事务T1、T2和T3分别如下：  </li>
<li>#T1<blockquote>
<p>DELETE FROM t1 WHERE pk = 1;</p>
</blockquote>
</li>
<li>#T2<blockquote>
<p>UPDATE t1 SET c1 = 100 WHERE pk = 1;</p>
</blockquote>
</li>
<li>#T3<blockquote>
<p>UPDATE t1 SET c1 = 50 WHERE pk = 1;<br>3个客户端并发地将这3个事务发送到各自的事务分发器上。事务分发器彼此之间互相通信，最终每个事务分发器上都会有一份完整的顺序一样的事务请求列表（T3、T1、T2）。3个事务分发器将这些事务请求按照顺序发送到各自的数据库服务器上去执行。T3最先在DB1、DB2和DB3上执行，执行完后DB1、DB2和DB3上的结果相同。接着T1被执行，执行后DB1、DB2和DB3上t1表中pk为1的记录都被删除了。最后T2被执行，由于T1删除了记录，T2在DB1、DB2和DB3上都会失败，所以DB1、DB2和DB3的数据仍然是一致的。<br>不管是单个事务分发器还是多个事务分发协同工作，它们的目标都是一样的：将所有的事务按照同样的顺序发送到数据库服务器上去执行。  </p>
</blockquote>
<h3 id="分布式的高可用数据库"><a href="#分布式的高可用数据库" class="headerlink" title="分布式的高可用数据库"></a>分布式的高可用数据库</h3>如果将上图中的事务分发器集成到数据库系统中，就变成了一个分布式的高可用数据库系统，如下图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct3.png" alt="image"><br>用户通过数据库服务器的用户接口执行事务。数据库服务器收到事务请求后，首先交由事务分发模块处理。事务分发模块将事务汇总排序，然后依次交由数据处理模块去执行这些事务。如果去年内部的细节，就会发现这是一个非常简洁的数据库集群方案。通过group replication构建的MySQL集群就是这样一个分布式的高可用MySQL系统。整个集群的架构如下图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct4.png" alt="image">  <h2 id="深入理解组复制中事务的执行过程"><a href="#深入理解组复制中事务的执行过程" class="headerlink" title="深入理解组复制中事务的执行过程"></a>深入理解组复制中事务的执行过程</h2>从上文中的模型可以知道，group replication插件中最重要的功能就是事务分发器的功能。group replication中实现的事务分发器和模型中的略有不同。在模型中，假设事务分发器分发的是事务的SQL语句，也就是说事务分发器的处理是在事务执行前。而在group replication中，事务分发器分发的是Binlog Event，事务分发器的处理是在事务执行即将结束的时候。group replication将这称作乐观的事务执行策略，可以带来更好的性能。但是在这种策略下，多个成员的事务可能发生冲突。group replication需要一个冲突检测机制来发现并处理冲突。由于Binlog Event的执行和SQL语句的执行过程是不一样的，group replication就用到异步复制中Binlog Event的执行模块。为了更好地理解group replication事务执行的过程，这里将group replication处理的事务分为本地事务和异地事务。本地事务指的是用户Session中或异步复制线程中执行的事务。异地事务指的是group replication中传播的由Binlog Event构成的事务。<br>根据事务处理过程中的不同处理步骤，group replication中事务分发器的功能划分为以下四部分。</li>
</ol>
<ul>
<li>本地事务控制模块</li>
<li>成员间的通信模块</li>
<li>全局事务认证模块</li>
<li>异地事务执行模块<h3 id="本地事务控制模块"><a href="#本地事务控制模块" class="headerlink" title="本地事务控制模块"></a>本地事务控制模块</h3>MySQL通过API向插件提供了事务执行过程中几个重要阶段的监控接口，group replication通过这些接口来监控和控制接口的执行。MySQL的事务在提交时，内部会分为三个阶段：准备(prepare)阶段、记录Binlog文件阶段和提交(commit)阶段。group replication对本地事务的控制逻辑在before_commit这个接口中执行。before_commit是在事务的prepare阶段之后，写Binlog文件阶段之前被执行的。对本地事务的控制包括以下三个步骤：<h4 id="发送事务信息"><a href="#发送事务信息" class="headerlink" title="发送事务信息"></a>发送事务信息</h4>group replication首先会将事务执行的相关信息打包，通过通信模块的接口发送给本地的通信模块。本地事务控制模块只发送信息，不接收任何信息。因此，这个通信是异步过程。只要本地的通信模块接收了消息就返回成功。发送到其他成员是通信模块的职责。事务信息包括主键信息、数据库快照版本和事务产生的Binlog Events。</li>
<li>主键信息是Server层生成Binlog Event的时候一同生成的。是否记录主键信息是通过transaction_write_set_extraction变量来控制的。主键信息中记录的并不是主键字段的值，而是字段值加上库名、表名等哈希值。</li>
<li>数据库快照版本是当前MySQL的全局变量gtid_executed的值。它包含了当前事务提交时所有已经执行了的事务的GTID，代表了当前事务执行时数据库的状态，因此称为数据库的快照版本。</li>
<li>当发送事务信息时，Binlog Event还没有写入Binlog文件。因此，Binlog Event是从当前线程的Binlog Cache中获取的，而不是依赖于Binlog文件。</li>
<li>Transaction_context_log_event，本地成员的UUID、主键信息和数据库快照版本会被封装进Transaction_context_log_event中，和事务产生的Binlog Event一起发送出去。Transaction_context_log_event放在其他Binlog Event前面。<h4 id="等待全局事务认证模块的认证结果"><a href="#等待全局事务认证模块的认证结果" class="headerlink" title="等待全局事务认证模块的认证结果"></a>等待全局事务认证模块的认证结果</h4>在事务信息发送成功后，事务会被阻塞，开始等待全局事务认证模块的认证结果。事务认证完成后，全局事务认证模块会唤醒当前事务的线程，让事务继续执行。<h4 id="认证结果的处理"><a href="#认证结果的处理" class="headerlink" title="认证结果的处理"></a>认证结果的处理</h4>这个过程实际上是由MySQL的代码执行的，而不是由group replication的代码执行的。在哪里执行的并不重要，只要理解这个过程就好。事务继续执行后，会检测 认证结果。如果认证成功，就继续提交事务，如果认证失败就会返回错误。然后由MySQL来执行Rollback的逻辑。<h3 id="成员间的通信模块"><a href="#成员间的通信模块" class="headerlink" title="成员间的通信模块"></a>成员间的通信模块</h3>通信模块分为三部分，如下图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct5.png" alt="image">  </li>
</ul>
<ol>
<li>本地数据接收部分负责接收本地成员上其他模块的数据发送请求，接收到的数据包被放入本地数据队列等待处理。</li>
<li>成员间的通信部分负责和其他成员通信。通信工作包括：从本地数据队列读取数据包发送给其他成员，以及接收其他成员发送过来的数据包。各个成员之间的通信使用了Paxos协议，Paxos协议是一个分布式的一致性协议。</li>
<li>全局数据包发送部分将所有的数据包顺序返回给本地成员上的全局事务认证模块。<br>当各个成员的通信模块接收到上层模块的数据发送请求时，这些并发的数据请求是无序的，如下图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct6.png" alt="image"><br>3个成员分别有1个数据包，分别是T1、T2和T3产生的数据包。这些并发、无序的数据包会通过Paxos协议汇聚到每个成员上，并且排序。最终每个成员的通信模块都会拥有同样的数据库包，这些数据包会按照同样的顺序发送到各自成员上的全局事务认证模块，如下图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct7.png" alt="image"><br>Paxos协议的工作核心就是对所有数据包进行汇聚和排序。为了完成上面的功能，Paxos协议本身会进行三次TCP通信，如下：</li>
</ol>
<ul>
<li>发送数据包给其他成员的通信模块</li>
<li>其他成员的通信模块回应收到的数据包</li>
<li>当超过半数的通信模块(包括它自己)回应后，发送消息告诉所有节点这个数据包同步成功。只有当Paxos协议的三个步骤成功完成后通讯模块才会把这个数据包发送给全局认证模块。这就像是两个公司谈合作经办人多轮协商把所有的条款都谈妥没有异议了，然后才通知老板准备签约。<br>为了保证数据按照同样的顺序发送到全局事务认证模块，Paxos协议还会为每个同步成功的数据包分配一个唯一的ID，当各个成员上的通信模块向上层模块发送这些数据包时，会按照数据包的ID以小到大的顺序发送给全局认证模块。这个ID由两部分组成，分别如下：  </li>
<li>成员序号：每个成员在加入组后，就会获得一个组内成员的唯一序号，这个成员发出的所有数据包都会使用这个成员序号。</li>
<li>自增序号：每个成员的通信模块都会维护一个自增的序号，按照发送数据包的顺序，给每个数据包分配一个顺序号。<br>如图所示，假设一个组有三个成员，那么顺序号为1的成员上的数据包ID是1:1,2:1,…,N:1。顺序号为2的成员上的数据包ID是1:2,2:2,…,N:2。顺序号为3的成员上的数据包ID是1:3,2:3,…,N:3。<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct8.png" alt="image"><br>当向全局认证模块发送这些数据包时，必须按照ID连续发送，不能跳过某个ID的数据包。本质上来说，这是一个轮训(Round Robin)的过程。先发送成员1的第一个数据包，接着发送成员2的第一个数据包，然后发送成员3的第一个数据包，如图所示。<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct9.png" alt="image"><br>如果在这个过程中，成员2上的数据包还没有同步成功呢？这时候就得等着，直到成员2的第一个数据包同步成功的后，才能返回给全局认证模块，然后继续返回成员3的数据包。假如成员2是空闲的，且本地没有任何事务处理呢？这种情况下，成员2需要发一个空操作指令(NOP)，告诉其他成员跳过ID1:2的数据包。这个指令是当成员2收到ID1:1的数据包同步成功的消息(Paxos的第三个TCP消息)后发出的，如图所示。<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct10.png" alt="image"><br>以上介绍的只是Paxos协议很少的一部分，如果想详细了解Paxos协议，还是要查阅更多的资料。总结一下，Paxos在通信上的特别如下：  </li>
<li>数据包同步成功需要三次TCP传输。</li>
<li>每个数据包都要发送到所有的成员上，因此需要传输多份，传输的数据量会被放大。</li>
<li>假设数据包发送到其他所有成员的过程是并发进行的，那么数据包同步成功需要的时间是成员间最慢的那条链路上完成三次TCP通信的时间。<br>这些特点决定了group replication在延迟大、带宽窄的网络中的效率会是比较低的。group replication为了提高Paxos对网络的适用性、做了以下优化：  </li>
<li>使用了LZ4压缩算法对事务信息进行压缩，当数据包的大小超过一个阈值时会被自动压缩。</li>
<li>Paxos会将多个事务信息封装到一个数据包内进行通信，大大减少了Paxos通信的次数。<h3 id="全局事务认证模块"><a href="#全局事务认证模块" class="headerlink" title="全局事务认证模块"></a>全局事务认证模块</h3>全局事务认证模块有一个消息队列，用来存放所有收到的消息。这些消息主要是事务的Binlog Event，也有一部分状态和控制信息。状态表replication_group_member_stats中的字段COUNT_TRANSATION_IN_QUEUE指的就是这个队列中事务数据。<br>全局事务认证模块的核心任务是做冲突检测。冲突检测是指识别出那些同时修改了同样数据的事务，并做出相应的处理。冲突检测中需要的信息包括如下三点：  </li>
<li>主键信息。</li>
<li>事务执行时的数据快照版本。</li>
<li>执行事务的MySQL服务器的UUID。<h4 id="冲突检测需要的信息"><a href="#冲突检测需要的信息" class="headerlink" title="冲突检测需要的信息"></a>冲突检测需要的信息</h4>group replication的冲突检测中以数据行为单位，两个事务是不是修改了同样的数据，是通过事务所修改的主键值来判断的。上方中有介绍，Server层在产生Binlog Event时，会同时记录所修改的主键信息(库名、表名主键等信息产生的哈希值)。当发现两个事务修改了同样的数据后，如何来判断这两个事务是不是同时执行的呢？这里用到了数据库快照版本。数据库快照版本是数据库的一个瞬时状态，每个写操作都会导致数据库的状态变化，不同的状态用不同的快照版本来表示。快照版本是用GTID来表示的，每个写事务都会产生一个唯一的GTID，这个GTID由全局事务认证模块产生，且在事务提交时会被添加到全局变量gtid_executed中。因此，gtid_executed的内容就是MySQL的数据库快照版本。<br>如下图所示，为数据库快照版本变化的示例图。图中，事务T1开始执行时所基于的数据库快照版本为空，T1提交后的数据库版本变为”group_name:1”,group_name是group replication组的UUID。事务T2的执行则基于”group_name:1”的快照版本，这个数据库的快照版本，主键信息及其MySQL服务器的UUID一起被封装到Transaction_context_log_event上，和其他事务产生的Binlog Event一起发送到全局事务检测模块。<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct11.png" alt="image">  <h4 id="冲突检测数据库"><a href="#冲突检测数据库" class="headerlink" title="冲突检测数据库"></a>冲突检测数据库</h4>全局事务认证模块中还维护了一个冲突检测数据库，它是主键哈希+快照版本的列表。快照版本存储的是最后一个修改此主键信息的快照版本加上这个事务的GTID。收到事务信息后，全局事务认证模块会根据Transaction_context_log_event中的主键信息，从冲突检测数据库中检索出所有主键的快照版本和该事务的快照版本进行比对。当前事务的快照版本必须要包含检索出的所有主键快照版本中的GTID，否则就是有冲突。  <h4 id="理解冲突检测的过程"><a href="#理解冲突检测的过程" class="headerlink" title="理解冲突检测的过程"></a>理解冲突检测的过程</h4>下面通过一个例子来理解冲突检测的原理，如图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct12.png" alt="image"><br>假设当前所有成员的数据库状态是一致的，它们的gtid_executed值都为”group_name:1-100”。这时，DB1上执行了事务T1,T1看到数据库快照版本就是”group_name:1-100”。<blockquote>
<p>UPDATE t1 SET c2 = 5 WHERE pk = 1;<br>同时，DB2执行了事务T2,T2看到数据库快照版本就是”group_name:1-100”。<br>UPDATE t1 SET c2 = 10 WHERE pk = 1;<br>经过通信模块排序后，T2排在了T1前面，如图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct13.png" alt="image"><br>因此，在所有成员全局冲突模块中都是先处理T2,再处理T1。在处理T2时，首先根据Transaction_context_log_event中的主键信息从冲突检测数据库中查找该主键上一次被修改后的快照版本。有可能查到，也不可能查不到。查不到就意味没有冲突。假设冲突检测数据库中的内容如下图所示(为了理解方便，图中主键哈希值用主键值代替)<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct14.png" alt="image"><br>从冲突检测数据库中查到此主键上一次被修改后的版本快照是”group_name:1-98”。和T2的快照版本比较得知，T2的快照版本中的GTID集合包含了冲突检测数据中查找到的快照版本的GTID集合。也就意味着，T2在B成员上执行时，上一次该主键的更新已经在B成员上执行了，所以T2和上一次该主键的更新之间是不冲突的。接着，全局事务认证模块会为T2分配一个GTID，并更新冲突检测数据库中此主键的快照版本。假设T2分配的GTID是”group_name:101”,更新后的冲突检测数据库如下图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct15.png" alt="image"><br>T2处理完成后，开始下一个事务T1的冲突检测。首先，也是从冲突检测数据库中查找该主键的快照版本，查到的结果是”group_name:101”，和T1的快照版本对比发现，T1的快照版本不包含”group_name:101”，这就可以判定T1和之前一次的主键修改(T2的修改)是同时进行的，是冲突的。</p>
</blockquote>
<h4 id="冲突处理"><a href="#冲突处理" class="headerlink" title="冲突处理"></a>冲突处理</h4>冲突检测完成后，全局认证模块接下来的处理是有本地事务和异地事务区分的。Transaction_context_log_event中记录了产生这个事务的MySQL服务器的UUID。根据这个UUID，就能判断出这是一个本地事务还是异地事务，对于本地事务的处理如下：</li>
<li>如果没有冲突，唤醒这个事务的线程，并且告诉它完成提交操作。</li>
<li>如果有冲突，唤醒这个事务的线程，并且告诉它发生冲突，需要回滚。</li>
<li>不论是否有冲突，Binlog Event都会被丢弃。<br>对于异地事务的处理如下：</li>
<li>如果没有冲突，将这个事务的Binlog Event写入Relay log中，让group_relication_appliter通道去执行。</li>
<li>如果有冲突，则丢弃这个事务的Binlog Event。<h4 id="冲突检测数据库的清理"><a href="#冲突检测数据库的清理" class="headerlink" title="冲突检测数据库的清理"></a>冲突检测数据库的清理</h4>随着使用时间的越来越长，冲突检测数据库中维护的主键信息会越来越多，这些主键信息将占用巨大的内存。为了减小内存的使用并提高查询效率，全局事务认证模块需要定期的清理冲突检测数据库。如果一个事务已经在所有成员上执行了，其他事务的执行肯定不会和它有冲突，因此这个事务的所有主键信息就可以从冲突检测数据库中移除。主键信息的清理是依据各个成员上的全局变量gtid_executed的GTID集合来做的。全局认证模块启动了一个广播线程，每60s将自己的gtid_executed中的GTID集合广播到所有的成员上。全局事务认证模块收到所有成员的GTID后，取它们的交集。这个交集中包含的就是那些已经在所有成员上执行了的事务GTID集合，称作全局完成的GTID集合。全局事务认证模块会将冲突检测数据库所有主键的快照版本和全局完成的GTID集合进行比对，如果快照版本中的GTID集合是全局完成的GTID集合的子集，则这个主键信息就会从冲突检测数据库中清除掉。<br>replication_group_member_stats表中的TRANSACTION_COMMITED_ALL_MEMBERS显示的就是全局完成的GTID集合。  <h4 id="计算基于主键的逻辑时钟"><a href="#计算基于主键的逻辑时钟" class="headerlink" title="计算基于主键的逻辑时钟"></a>计算基于主键的逻辑时钟</h4>在执行Binlog Event时，group replication采用了基于主键的并发机制。在这种机制中通过主键来判断是否修改了相同的数据，各种情况如下：</li>
<li>修改了不同数据的事务会安排并发执行。</li>
<li>修改了相同数据的事务会安排顺序执行。</li>
<li>DDL不能和任何事务并发执行，必须等待它前面的所有事务执行完毕后才能开始执行，后面的事务也必须要等待DDL执行完毕后，才能开始执行。<br>基于主键的并发机制，刚好可以通过逻辑时钟的方式来表达。因此group replication重用了多线程复制中Logical_clock并发复制的功能。基于主键的并发实现起来很简单，只需要根据主键信息计算出事务的逻辑时间，并更新Gtid_log_event中听last_committed和sequence_number的内容即可。group_replication_applier在执行这些事务时，按照Logical_clock方式进行并发就可以了，不需要任何改动。由于需要用到主键信息，因此计算过程是在冲突检测的过程中完成的。全局事务认证模块维护了一个全局事务的顺序号，它会给每个认证成功的事务分配一个顺序号。这个顺序号就是事务的sequence_number，会存储到冲突检测数据库中。当前事务的last_committed的计算和存储在冲突检测数据库中的sequence_number有关。首先，从冲突检测数据库中找出该事务修改的所有主键的sequence_number，即上一次被修改时的sequence_number，取其中的最大值来作为当前事务的last_committed。<br>假设正在处理的事务如下：<blockquote>
<p>UPDATE t1 SET c2 = 5 WHERE pk=1 OR pk =2;<br>冲突检测数据库中的顺序如下图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct16.png" alt="image"><br>那么该事务的last_committed是120(120和33的最大值)。如果查不到上次记录，则将last_committed设置为上一次DDL的sequence_number，这保证DDL后面的事务不会和DDL并发执行。如果当前事务是DDL，则last_committed会设置成它自己的sequence_number-1，从而保证DDL前面的所有事务都被执行完后它才会被执行。</p>
</blockquote>
<h3 id="异地事务执行模块"><a href="#异地事务执行模块" class="headerlink" title="异地事务执行模块"></a>异地事务执行模块</h3>为了执行异地事务的Binlog Event，group replication会自动创建一个名为group_replication_applier的通道。这个通道的Receiver线程是关闭的，不会从其他成员上去复制Binlog Event。所有的Binlog Event都是由全局事务认证模块通过API写入Relay log的。Binlog Event的执行过程和异步复制没有区别，但是在执行过程中group_replication_applier所执行的事务使用了特权行锁。在对数据加行锁的时候，如果group_replication_applier发现有本地事务已经对数据加了行锁，那么group_replication_applier不会等待本地事务执行完毕，而是立刻将本地事务回滚掉，然后继续执行；而本地事务的Session则会返回错误。这其实很好理解，本地事务和group_replication_applier更新了同样的数据，而且是同时执行的，因此才会返回错误。即便本地事务到了全局事务认证模块，也会因此检测出冲突而被回滚掉。相比而言，由前者回滚本地事务效率更高。<h3 id="事务流程的总结"><a href="#事务流程的总结" class="headerlink" title="事务流程的总结"></a>事务流程的总结</h3>事务在group replication中的执行过程可以总结为三个部分：</li>
<li>网络传输。</li>
<li>事务在本地的执行过程。</li>
<li>事务在异地的执行过程。<h4 id="网络传输"><a href="#网络传输" class="headerlink" title="网络传输"></a>网络传输</h4>group replication通过Paxos协议来传播事务信息。Paxos保证所有的事务信息按照同样的顺序传播到所有的成员上，如下图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct17.png" alt="image">  <h4 id="事务在本地成员上的执行过程"><a href="#事务在本地成员上的执行过程" class="headerlink" title="事务在本地成员上的执行过程"></a>事务在本地成员上的执行过程</h4>事务在本地提交时(prepare之后，写Binlog之前)，将事务信息发送至通信模块，然后开始等待事务认证结果。通信模块将事务排序后发送到本地成员的全局认证模块。全局认证模块做完冲突检测后，唤醒该事务继续执行(如果认证成功)或回滚(如果认证失败)，如下图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct18.png" alt="image">  <h4 id="事务在异地的执行过程"><a href="#事务在异地的执行过程" class="headerlink" title="事务在异地的执行过程"></a>事务在异地的执行过程</h4>通讯模块将事务排序后发到全局事务认证模块。全局认证模块认证成功后，将该事务的Binlog Event写入Relay log，由group_replication_applier通道来执行。如果全局事务认证失败，则会丢弃该事务的Binlog Event，如下图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct19.png" alt="image">  <h2 id="深入理解成员加入组的过程"><a href="#深入理解成员加入组的过程" class="headerlink" title="深入理解成员加入组的过程"></a>深入理解成员加入组的过程</h2>group replication的主要逻辑可以划分为两部分：事务的执行逻辑和成员管理逻辑。上面已经介绍了事务的执行逻辑，下面来介绍成员的管理逻辑。<h3 id="组视图"><a href="#组视图" class="headerlink" title="组视图"></a>组视图</h3>成员管理中有一个很重要的概念叫作组视图(Group View)，或者简称为视图(View)。视图是指group replication组在一段时间内的成员状态。在这个时间段内没有成员变化，即没有成员加入也没有成员退出。如果成员发生了变化，成员状态就变化了，于是它就进入了另外一个视图。不同的视图之间通过视图ID(View ID)来进行区分。视图随时间的变化有先后顺序，因此View ID也是有先后顺序的。View ID被定义为两个部分，分别如下：  </li>
<li>前缀部分(固定部分)：前缀部分是一个随机数。这个值在组初始化时产生。之后，所有View的前缀部分都使用这个随机数，因此也被称为固定部分。</li>
<li>顺序号部分：顺序号部分是数值。初始化时，第一个视图的顺序号从1开始，以后每次视图变化顺序号递增。<br>用户可以通过replication_group_member_stats表查看当前的View ID。View ID显示格式如下：<blockquote>
<p>14870305055874300:2</p>
</blockquote>
<h3 id="加入组时视图的切换"><a href="#加入组时视图的切换" class="headerlink" title="加入组时视图的切换"></a>加入组时视图的切换</h3>当一个MySQL服务器加入组中，group replication插件首先会根据group_replication_group_seeds的内容和一个成员(种子成员)建立TCP连接。而种子成员会根据自己的IP白名单检查是否允许其接入。连接建立后，新成员会发送一个加入请求给种子成员，如下图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct20.png" alt="image"><br>收到请求后，种子成员广播视图变化的消息给所有成员(包括申请加入的成员)，如下图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct21.png" alt="image"><br>各个成员收到消息后开始做视图切换。首先，每个成员都会广播一个状态交换消息出去，如下图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct22.png" alt="image"><br>接着，各个成员开始接收状态交换消息。状态交换消息中包含了成员的当前状态和信息。成员收到状态交换信息后，将消息中的成员信息更新到自己的成员列表中。当收到所有成员中的最后一个状态交换消息时，通信模块将完整的新视图以视图数据包的形式返回给全局事务认证模块进行处理。整个视图的切换过程到此结束，视图切换的整个过程不影响在线成员对外提供服务。<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct23.png" alt="image"><br>离开组时的视图切换和加入组的视图切换过程基本一样，略。<h3 id="View-change-log-event"><a href="#View-change-log-event" class="headerlink" title="View_change_log_event"></a>View_change_log_event</h3>状态交换消息和事务数据包一样都是通过Paxos协议发送的，因此它们之间也是有序的。事务数据包以视图数据包为分界线，划分到不同的视图中。它前面的事务数据包属于前一个视图的事务，而后面的数据包都是属于当前视图中的事务。全局事务认证模块会对每一个视图数据包创建一个View_change_log_event，这个Event会被写入Relay log，然后被执行，最终会出现在Binlog中，因此Binlog里的Event也被View_change_log_event划分到不同的视图中。View_change_log_event里面记录了当前的View ID，还有冲突检测数据库的信息。当记录View_change_log_event到Binlog中时，它会被封装到一个事务中，并且有自己的GTID，包括几个Events。  <blockquote>
<p>Gtid_log_event;<br>Query_log_event(“BEGIN”)<br>View_change_log_event;<br>Query_log_event(“COMMIT”)</p>
</blockquote>
<h3 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h3>视图切换完成后，成员就正式加入组内。它可以收到当前视图任何事务的数据包，但是视图切换前的数据包是收不到的。所以，在MySQL服务器加入组后，不能立即对外提供服务，而需要执行一些操作将自己缺失的数据从其他成员上复制过来。这个过程叫作恢复(Recovery)。一个成员加入组后，会立即将自己的状态设置为RECOVERING，开始执行恢复的过程。恢复过程分为本地恢复、全局恢复和缓存事务执行三个步骤。<h3 id="本地恢复-Local-Recovery"><a href="#本地恢复-Local-Recovery" class="headerlink" title="本地恢复(Local Recovery)"></a>本地恢复(Local Recovery)</h3>如果这个成员曾经加入过这个组，它的group_replication_applier通道的Relay log中可能还有一些Event没有被执行到数据库中。因此，group replication插件首先会启动group_replication_applier通道，将本地的Binlog Event执行完毕。<h3 id="全局恢复-Global-Recovery"><a href="#全局恢复-Global-Recovery" class="headerlink" title="全局恢复(Global Recovery)"></a>全局恢复(Global Recovery)</h3>本地恢复执行完毕后，开始进行全局恢复。全局恢复是通过group_replication_recovery进行的。group replication插件会随机选择一个在线成员作为这个通道的Master，这个被选择的成员叫作Donor。group replication插件会自动配置group_replication_recovery通道，并且启动这个通道进行复制，复制时使用的是GTID复制。全局恢复有容错能力，如果group_replication_recovery通道的接收线程(Receiver)无法连接到当前的Donor或当前Donor上的Binlog已经删除，则会选择其他成员作为Donor进行复制。在启动group_replication_recovery通道时，group replication插件会告诉它：当碰到View ID等于当前View ID的View_change_log_event时停止。当执行完到这个View_change_log_event后，group_replication_recovery通道会将空上Event中的冲突检测数据库初始化到group replication插件中，然后停止运行，如下图所示：<br><img src="http://qanp7f2om.bkt.clouddn.com/MGR_ct24.png" alt="image">  <h3 id="缓存事务执行"><a href="#缓存事务执行" class="headerlink" title="缓存事务执行"></a>缓存事务执行</h3>在执行全局恢复过程的同时，全局事务认证模块还会收到当前视图中产生的事务数据包。这些数据包会被缓存起来直到全局恢复完毕后，全局事务认证模块才开始处理这些事务。当缓存的事务全部执行完毕后，该成员才能设置为ONLINE状态。当然用户也可以让成员在缓存的事务执行之前上线。group replication提供了参数group_replication_recovery_complete_at来控制上线时间。上线不仅仅是状态的改变，在多主模式时，上线意味着只读模式会被关闭，上线后成员就能够接收用户的写操作了。<h3 id="手动恢复"><a href="#手动恢复" class="headerlink" title="手动恢复"></a>手动恢复</h3>虽然group replication的恢复过程是很自动化的，但是并不完美，在有些情况下还是需要手动进行恢复的。  </li>
<li>当group replication运行了很长时间后，以前的Binlog可能已经删除了，这时就无法自动通过全局恢复来复制数据。</li>
<li>当要复制的Binlog很大时，使用异步复制的全局恢复效率比较低，不能短时间内完成。<br>当要加入组内的MySQL服务器符合以上情况时，可以先手动将数据库恢复到一个比较接近的时间点，然后再加入group replication组。<h2 id="运维相关问题"><a href="#运维相关问题" class="headerlink" title="运维相关问题"></a>运维相关问题</h2><h3 id="故障切换"><a href="#故障切换" class="headerlink" title="故障切换"></a>故障切换</h3>目前MySQL官方没有发布连接组复制专用的客户端（如MongoDB连接复制集的客户端），在实际的应用中如果发生故障，需要客户端自己来处理。对于单主模式的话，如果主节点发生故障，客户端需要判断新的主节点是谁，然后把写切换到新的主节点，基本上和当前的异步同步的主从切换一样，并且新的主节点是集群自动产生，不可控；多主模式需要在客户端进行节点可用性检查，当其中的一个写节点不可用时自动使用其他可用节点。<h3 id="大事务支持问题"><a href="#大事务支持问题" class="headerlink" title="大事务支持问题"></a>大事务支持问题</h3>目前版本测试并发进行大数据操作和DDL操作时，kill掉大事务，有几率造成集群不可用；在insert into …….select……limit……这种大事务支持不好，可能造成集群不用；多主模式进行DDL操作需要集群内所有节点都为ONLINE状态才可执行，处于ERROR和RECOVERING状态时有几率导致集群堵塞，严重时集群不可用。<h3 id="备份问题"><a href="#备份问题" class="headerlink" title="备份问题"></a>备份问题</h3>在组复制集群其中的一个节点上执行数据库备份时，不管使用mysqldump（这个不能使用–single-transaction参数，生产中不建议使用mysqldump备份集群数据）或是使用xtrabackup的QPS下降40%，并且备份节点基本停止读写。在测试备份文件导入数据时，多主模式要比单主模式慢。推荐使用组复制+异步复制方式，在异步复制的从节点上进行数据库备份。<h3 id="二进制日志删除问题"><a href="#二进制日志删除问题" class="headerlink" title="二进制日志删除问题"></a>二进制日志删除问题</h3>因为组复制同步还是基于二进制日志来进行同步的，清理某个节点bin-log时，必须判定这个日志文件是否还在使用，如果在使用，则绝对不能删除，如果删除，则整个集群直接ERROR。<h3 id="同步延迟问题"><a href="#同步延迟问题" class="headerlink" title="同步延迟问题"></a>同步延迟问题</h3>目前MySQL5.7.20的版本中无法直观查看节点同步延迟，也无法获取延迟多少，不管是时间或事物数，这个打开MySQL的Debug模式，可以获取到节点的延迟事务情况。<br>组复制的延迟对集群是有影响的，一旦出现延迟（默认延迟25000个事务），则启动流量控制（Flow Control），每个周期性能衰减当前的10%,直到集群不可用（但集群节点状态为online），单个节点慢整个集群全慢。<br>集群中的每个节点都会验证并应用该组提交的事务，有关校验和应用程序过程的统计信息对于了解应用程序队列如何增长，已找到多少冲突，检查了多少事务，在哪里提交了哪些事务等等非常有用。表 performance_schema.replication_group_member_stats 提供与事务认证过程的相关信息，但没有延迟信息。相关字段解释请参考文件<h3 id="数据一致性问题"><a href="#数据一致性问题" class="headerlink" title="数据一致性问题"></a>数据一致性问题</h3>不管是多写还是单写，都并非是强一致性，均允许有延迟，他在校验完事务是否冲突后把当前广播到各个节点并确定各个节点收到事务后即进入下一个事物的冲突检测，此时每个节点只是拿到了所有事务的执行序列，保证了事务最终顺序执行，从而保证数据的最终一致性，但同一时刻并非强一致性的。  <h3 id="节点故障脑裂问题"><a href="#节点故障脑裂问题" class="headerlink" title="节点故障脑裂问题"></a>节点故障脑裂问题</h3>节点越多性能损耗越大，三个节点比较合适。节点故障可能有脑裂等问题：如5个节点分布在两个机房，机房间网络断掉分为两个部分，2个集群的机房不可用，3个节点的可用，而三个节点的机房网络有问题，此时如果想使两个节点的机房可用，需要重新对两个节点做集群重组，三个节点的就无法恢复到两个节点中去；三节点中其中一个节点宕机，其他两个正常节点可用，故障节点重启没有加入到集群时，此时这个节点以单实例存在可读写，此时会发生脑裂。<br>###　弹性扩展问题<br>MySQL官方网站提到了组复制的弹性自动扩展，经过实际测试，这种扩展在生产中是不现实的。可用于生产的弹性扩展要求新加入一个集群，集群中的数据完全由集群来完成自动同步，但由于组复制是基于二进制日志来进行同步的，生产中是不可能完整保留全部的二进制日志，在新加入的节点需要先备份出集群的全量数据，然后根据同步位置去追事务达到数据的一致后节点状态online状态，其实和之前异步同步搭建主从一样。并且官方提示如果恢复时的延迟过大，可能也无法正常达到追到最新数据的位置。<h3 id="客户端连接问题"><a href="#客户端连接问题" class="headerlink" title="客户端连接问题"></a>客户端连接问题</h3>官方说明中关于故障处理的时候有一句话：组复制不处理客户端故障切换，它必须由应用程序本身，连接器或中间件框架（如代理或路由器）处理。<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2>参考<a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-frequently-asked-questions.html" target="_blank" rel="noopener">官方</a>文档<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2>目前MGR还不太成熟,但为MySQL的发展指明了方向,相信在未来的MySQL版本中,MGR能够越来越完善.</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/Aliyun-ECS搭建MHA-Keepalived-VIP-MySQL5-7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Aliyun-ECS搭建MHA-Keepalived-VIP-MySQL5-7.html" itemprop="url">Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-11T13:53:19+08:00">
                2017-10-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/集群高可用/" itemprop="url" rel="index">
                    <span itemprop="name">集群高可用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在Aliyun ECS结合MHA做MySQL的高可用，ECS不支持VIP，但阿里的产品高可用虚拟IP（HaVip）结合keepliaved等第三方软件可间接实现ip的漂移，可满足我们的需求。</p>
<h2 id="MHA简介"><a href="#MHA简介" class="headerlink" title="MHA简介"></a>MHA简介</h2><p>MHA是由日本MySQL专家youshimaton(现就职于Facebook公司)用Perl写的一套MySQL故障切换方案，以保障数据库的高可用性。在MySQL故障切换过程中，MHA能做到在0~30s之内实现主MySQL故障转移。<br>该软件由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）。MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p>
<h2 id="高可用虚拟IP限制"><a href="#高可用虚拟IP限制" class="headerlink" title="高可用虚拟IP限制"></a>高可用虚拟IP限制</h2><ul>
<li>每个VPC中最多只能同时存在5个vip对象</li>
<li>目前VPC中的网络通信不支持多播和广播，只支持单播；所以，如果用户是使用keepalived之类的第三方软件实现高可用，需要通过配置文件把通信方式改成单播；网上可以找到相应的方法 </li>
<li>如果是使用keepalived之类的第三方软件，需要把信条消息的源IP改成ECS的私网IP（而不要用HaVip的私网IP进行心跳检查），不然很容易造成脑裂</li>
<li>当HaVip与EIP绑定后，进行公网通信时，持有HaVip的ECS实例应该通过HaVip的私网ip进行公网通信（而不是ECS自己的私网IP）；因为这时EIP是映射在HaVip的私网IP上，而不是映射在ECS的私网IP上</li>
<li>类似的，当使用HaVip做自建SNAT网关的高可用时，SNAT实例上配置的SNAT规则中，source IP应该是havip的私网IP而不是自己的private IP</li>
</ul>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：Linux Centos 6.5<br>master：192.168.16.80<br>slave: 192.168.16.81<br>vip: 192.168.16.82  （<font color="#FF0000">注：需要和HaVip的私网IP一致</font>）<br>其中，使用两台机器，分别部署主库和从库，MHA默认部署在从库上，下方中的VIP通EIP，最终是要把EIP和HaVip绑定在一起  </p>
<h2 id="系统初始化修改"><a href="#系统初始化修改" class="headerlink" title="系统初始化修改"></a>系统初始化修改</h2><h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><h4 id="主库修改主机名"><a href="#主库修改主机名" class="headerlink" title="主库修改主机名"></a>主库修改主机名</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cat</span> /etc/sysconfig/network|grep HOSTNAME</span><br><span class="line"><span class="attr">HOSTNAME=</span><span class="literal">master</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cat</span> /etc/hosts|grep <span class="literal">master</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">16.80</span> <span class="literal">master</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]#</span></span><br></pre></td></tr></table></figure>
<h4 id="从库修改主机名"><a href="#从库修改主机名" class="headerlink" title="从库修改主机名"></a>从库修改主机名</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="literal">slave</span> ~]<span class="comment"># cat /etc/sysconfig/network|grep HOSTNAME</span></span><br><span class="line"><span class="attr">HOSTNAME=</span><span class="literal">slave</span></span><br><span class="line">[root@<span class="literal">slave</span> ~]<span class="comment"># cat /etc/hosts|grep slave</span></span><br><span class="line"><span class="number">192.168</span>.<span class="number">16.81</span> <span class="literal">slave</span></span><br><span class="line">[root@<span class="literal">slave</span> ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="设置防火墙"><a href="#设置防火墙" class="headerlink" title="设置防火墙"></a>设置防火墙</h3><h4 id="主库设置，允许从库访问"><a href="#主库设置，允许从库访问" class="headerlink" title="主库设置，允许从库访问"></a>主库设置，允许从库访问</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/iptables status|grep <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span></span><br><span class="line"><span class="number">11</span>   ACCEPT     all  --  <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>        <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>           </span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<p>其中，192.168.16.81是允许从库的访问规则</p>
<h4 id="从库设置，允许主库访问"><a href="#从库设置，允许主库访问" class="headerlink" title="从库设置，允许主库访问"></a>从库设置，允许主库访问</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# /etc/init.d/iptables status|grep <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span></span><br><span class="line"><span class="number">11</span>   ACCEPT     all  --  <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>        <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>           </span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<p>其中，192.168.16.80是允许主库的访问规则</p>
<h3 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h3><h4 id="主库查看"><a href="#主库查看" class="headerlink" title="主库查看"></a>主库查看</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@master</span> ~]<span class="meta"># cat /etc/sysconfig/selinux |grep -v <span class="string">'#'</span> |grep <span class="string">'SELINUX='</span> </span></span><br><span class="line">SELINUX=disabled</span><br><span class="line">[root<span class="symbol">@master</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure>
<h4 id="从库查看"><a href="#从库查看" class="headerlink" title="从库查看"></a>从库查看</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># cat /etc/sysconfig/selinux |grep -v <span class="string">'#'</span> |grep <span class="string">'SELINUX='</span> </span></span><br><span class="line">SELINUX=disabled</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure>
<h2 id="建立SSH无密码登录"><a href="#建立SSH无密码登录" class="headerlink" title="建立SSH无密码登录"></a>建立SSH无密码登录</h2><h3 id="主库设置"><a href="#主库设置" class="headerlink" title="主库设置"></a>主库设置</h3><p>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,同时AllowUsers把root也添加上,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# sed</span> '/^<span class="comment">#/d;/^$/d' /etc/ssh/ssh_config |grep GSSAPIAuthentication</span></span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# sed</span> '/^<span class="comment">#/d;/^$/d' /etc/ssh/sshd_config |grep -E 'PasswordAuthentication|PermitRootLogin'</span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# /etc</span>/init.d/sshd restart</span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cat</span> /etc/hosts.allow |grep <span class="number">192.168</span>.<span class="number">16.81</span></span><br><span class="line">sshd: <span class="number">192.168</span>.<span class="number">16.81</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]#</span></span><br></pre></td></tr></table></figure></p>
<p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="meta"># ssh-keygen </span></span><br><span class="line">Generating <span class="keyword">public</span>/<span class="keyword">private</span> rsa <span class="keyword">key</span> pair.</span><br><span class="line">Enter file <span class="keyword">in</span> which <span class="keyword">to</span> save the <span class="keyword">key</span> (/root/.ssh/id_rsa): </span><br><span class="line">Created directory <span class="comment">'/root/.ssh'.</span></span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your <span class="keyword">public</span> <span class="keyword">key</span> has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The <span class="keyword">key</span> fingerprint <span class="keyword">is</span>:</span><br><span class="line"><span class="number">07</span>:<span class="number">86</span>:<span class="number">76</span>:d6:<span class="number">4</span>a:<span class="number">0</span>f:ea:<span class="number">6</span>e:<span class="number">88</span>:<span class="number">00</span>:eb:<span class="number">3</span>d:<span class="number">5</span>f:<span class="number">7</span>e:<span class="number">08</span>:<span class="number">7</span>a root@master</span><br><span class="line">The <span class="keyword">key</span><span class="comment">'s randomart image is:</span></span><br><span class="line">+--[ RSA <span class="number">2048</span>]----+</span><br><span class="line">|                 |</span><br><span class="line">|       . .       |</span><br><span class="line">|      o B .      |</span><br><span class="line">|.    . * =       |</span><br><span class="line">|..    . S o      |</span><br><span class="line">|o    o   .       |</span><br><span class="line">|......o..        |</span><br><span class="line">| ..+.E+. .       |</span><br><span class="line">|    +o...        |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@master ~]<span class="meta"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.81</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">'192.168.16.81 (192.168.16.81)' can't be established.</span></span><br><span class="line">RSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> <span class="number">9</span>f:<span class="number">1</span>f:<span class="number">41</span>:f6:<span class="number">2</span>d:e9:<span class="number">20</span>:<span class="number">83</span>:<span class="number">30</span>:be:cd:<span class="number">20</span>:<span class="number">01</span>:<span class="number">31</span>:ea:<span class="number">6</span>d.</span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added <span class="comment">'192.168.16.81' (RSA) to the list of known hosts.</span></span><br><span class="line">root@<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span><span class="comment">'s password: </span></span><br><span class="line">Now <span class="keyword">try</span> logging <span class="keyword">into</span> the machine, <span class="keyword">with</span> <span class="string">"ssh 'root@192.168.16.81'"</span>, <span class="keyword">and</span> check <span class="keyword">in</span>:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="keyword">to</span> make sure we haven<span class="comment">'t added extra keys that you weren't expecting.</span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="meta"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.80</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">'192.168.16.80 (192.168.16.80)' can't be established.</span></span><br><span class="line">RSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> f2:f8:<span class="number">7</span>d:<span class="number">7</span>d:<span class="number">59</span>:<span class="number">3</span>f:b9:<span class="number">3</span>c:a0:e6:<span class="number">66</span>:<span class="number">54</span>:<span class="number">1</span>f:<span class="number">79</span>:e2:<span class="number">40.</span></span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">root@<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span><span class="comment">'s password: </span></span><br><span class="line">Now <span class="keyword">try</span> logging <span class="keyword">into</span> the machine, <span class="keyword">with</span> <span class="string">"ssh 'root@192.168.16.80'"</span>, <span class="keyword">and</span> check <span class="keyword">in</span>:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="keyword">to</span> make sure we haven<span class="comment">'t added extra keys that you weren't expecting.</span></span><br><span class="line"></span><br><span class="line">[root@master ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p>
<p>测试登录<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ssh root@192.168.16.81</span><br><span class="line">Last login: Wed Oct 11 14:45:10 2017 <span class="keyword">from</span> 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome <span class="keyword">to</span> aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@slave ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection <span class="keyword">to</span> 192.168.16.81 closed.</span><br><span class="line">[root@master ~]# ssh root@192.168.16.80</span><br><span class="line">Last login: Wed Jan 18 16:25:59 2017</span><br><span class="line"></span><br><span class="line">Welcome <span class="keyword">to</span> aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@master ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection <span class="keyword">to</span> 192.168.16.80 closed.</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="从库设置"><a href="#从库设置" class="headerlink" title="从库设置"></a>从库设置</h3><p>和主库保持一致<br>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,同时AllowUsers把root也添加上,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接  </p>
<figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># sed <span class="string">'/^#/d;/^$/d'</span> /etc/ssh/ssh_config |grep GSSAPIAuthentication</span></span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># sed <span class="string">'/^#/d;/^$/d'</span> /etc/ssh/sshd_config |grep -E <span class="string">'PasswordAuthentication|PermitRootLogin'</span></span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># /etc/init.d/sshd restart</span></span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># cat /etc/hosts.allow |grep 192.168.16.80</span></span><br><span class="line">sshd: <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span></span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure>
<p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="meta"># ssh-keygen </span></span><br><span class="line">Generating <span class="keyword">public</span>/<span class="keyword">private</span> rsa <span class="keyword">key</span> pair.</span><br><span class="line">Enter file <span class="keyword">in</span> which <span class="keyword">to</span> save the <span class="keyword">key</span> (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.</span><br><span class="line">Your <span class="keyword">public</span> <span class="keyword">key</span> has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub.</span><br><span class="line">The <span class="keyword">key</span> fingerprint <span class="keyword">is</span>:</span><br><span class="line">ae:<span class="number">04</span>:<span class="number">32</span>:<span class="number">4</span>d:<span class="number">3</span>e:d3:b7:<span class="number">5</span>d:<span class="number">4</span>e:d2:<span class="number">50</span>:<span class="number">7</span>a:<span class="number">4</span>c:<span class="number">44</span>:d7:<span class="number">0</span>a root@slave</span><br><span class="line">The <span class="keyword">key</span><span class="comment">'s randomart image is:</span></span><br><span class="line">+--[ RSA <span class="number">2048</span>]----+</span><br><span class="line">|           o= .. |</span><br><span class="line">|           =E.  .|</span><br><span class="line">|    .     o o. . |</span><br><span class="line">|   + .     +  .  |</span><br><span class="line">|  o * . S . +    |</span><br><span class="line">|   o + o o =     |</span><br><span class="line">|      . o . .    |</span><br><span class="line">|     . .         |</span><br><span class="line">|      .          |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@slave ~]<span class="meta"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.80</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">'192.168.16.80 (192.168.16.80)' can't be established.</span></span><br><span class="line">RSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> f2:f8:<span class="number">7</span>d:<span class="number">7</span>d:<span class="number">59</span>:<span class="number">3</span>f:b9:<span class="number">3</span>c:a0:e6:<span class="number">66</span>:<span class="number">54</span>:<span class="number">1</span>f:<span class="number">79</span>:e2:<span class="number">40.</span></span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added <span class="comment">'192.168.16.80' (RSA) to the list of known hosts.</span></span><br><span class="line">root@<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span><span class="comment">'s password: </span></span><br><span class="line">Now <span class="keyword">try</span> logging <span class="keyword">into</span> the machine, <span class="keyword">with</span> <span class="string">"ssh 'root@192.168.16.80'"</span>, <span class="keyword">and</span> check <span class="keyword">in</span>:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="keyword">to</span> make sure we haven<span class="comment">'t added extra keys that you weren't expecting.</span></span><br><span class="line"></span><br><span class="line">[root@slave ~]<span class="meta"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.81</span></span><br><span class="line">The authenticity <span class="keyword">of</span> host <span class="comment">'192.168.16.81 (192.168.16.81)' can't be established.</span></span><br><span class="line">RSA <span class="keyword">key</span> fingerprint <span class="keyword">is</span> <span class="number">9</span>f:<span class="number">1</span>f:<span class="number">41</span>:f6:<span class="number">2</span>d:e9:<span class="number">20</span>:<span class="number">83</span>:<span class="number">30</span>:be:cd:<span class="number">20</span>:<span class="number">01</span>:<span class="number">31</span>:ea:<span class="number">6</span>d.</span><br><span class="line">Are you sure you want <span class="keyword">to</span> <span class="keyword">continue</span> connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added <span class="comment">'192.168.16.81' (RSA) to the list of known hosts.</span></span><br><span class="line">root@<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span><span class="comment">'s password: </span></span><br><span class="line">Now <span class="keyword">try</span> logging <span class="keyword">into</span> the machine, <span class="keyword">with</span> <span class="string">"ssh 'root@192.168.16.81'"</span>, <span class="keyword">and</span> check <span class="keyword">in</span>:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line"><span class="keyword">to</span> make sure we haven<span class="comment">'t added extra keys that you weren't expecting.</span></span><br><span class="line"></span><br><span class="line">[root@slave ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p>
<p>测试登录<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ssh root@192.168.16.80</span><br><span class="line">Last login: Wed Oct 11 14:48:14 2017 <span class="keyword">from</span> 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome <span class="keyword">to</span> aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@master ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection <span class="keyword">to</span> 192.168.16.80 closed.</span><br><span class="line">[root@slave ~]# ssh root@192.168.16.81</span><br><span class="line">Last login: Wed Oct 11 14:48:10 2017 <span class="keyword">from</span> 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome <span class="keyword">to</span> aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@slave ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection <span class="keyword">to</span> 192.168.16.81 closed.</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL安装"><a href="#MySQL安装" class="headerlink" title="MySQL安装"></a>MySQL安装</h2><p>使用的是自己打包的RPM包，分别登录主库和从库，直接rpm -ivh percona-server-5.7.18-15.x86_64.rpm 即可，也可使用其他方式安装MySQL<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mv /home/duanwenjie/percona-server<span class="number">-5.7</span><span class="number">.18</span><span class="number">-15.</span>x86_64.rpm /usr/src/</span><br><span class="line">[root@master ~]# rpm -ivh /usr/src/percona-server<span class="number">-5.7</span><span class="number">.18</span><span class="number">-15.</span>x86_64.rpm </span><br><span class="line">Preparing...                ########################################### [<span class="number">100</span>%]</span><br><span class="line">Group <span class="string">'mail'</span> not found. Creating the user mailbox file <span class="keyword">with</span> <span class="number">0600</span> mode.</span><br><span class="line">   <span class="number">1</span>:percona-server         ########################################### [<span class="number">100</span>%]</span><br><span class="line">error reading information on service /etc/rc.d/init.d/mysqld: No such file or directory</span><br><span class="line">MySQL (Percona Server) PID file could not be found![FAILED]</span><br><span class="line">Starting MySQL (Percona Server)...[  OK  ]</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Warning: Since password will be sent to server <span class="keyword">in</span> plain text, use ssl connection to ensure password safety.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<p>查看是否安装成功,分别登录主库和从库<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">12</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">03</span>:<span class="number">27</span> &gt; select <span class="built_in">version</span>();</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| <span class="built_in">version</span>()     |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">03</span>:<span class="number">31</span> &gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@master ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL互为主备"><a href="#MySQL互为主备" class="headerlink" title="MySQL互为主备"></a>MySQL互为主备</h2><h3 id="重要参数配置"><a href="#重要参数配置" class="headerlink" title="重要参数配置"></a>重要参数配置</h3><p>主库必须包含以下参数<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># cat /etc/my.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 1</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 1</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br></pre></td></tr></table></figure></p>
<p>从库必须包含以下参数，注意slave需要动态设置read_only=1<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/my.cnf </span><br><span class="line"><span class="meta">[mysqld]</span></span><br><span class="line">server-id = 2</span><br><span class="line">autocommit = 1</span><br><span class="line">auto<span class="emphasis">_increment_</span>increment = 2</span><br><span class="line">auto<span class="emphasis">_increment_</span>offset = 2</span><br><span class="line">log<span class="emphasis">_bin = mysql-bin</span></span><br><span class="line"><span class="emphasis">gtid_</span>mode = on</span><br><span class="line">enforce<span class="emphasis">_gtid_</span>consistency = 1</span><br><span class="line">log<span class="emphasis">_slave_</span>updates</span><br><span class="line">relay<span class="emphasis">_log_</span>purge=0</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e "show variables like <span class="emphasis">'read_only'</span>"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| read_</span>only     | OFF   |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e "set global read<span class="emphasis">_only=1"</span></span><br><span class="line"><span class="emphasis">Enter password: </span></span><br><span class="line"><span class="emphasis">[root@slave ~]# mysql -uroot -p -e "show variables like 'read_</span>only'"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| read_</span>only     | ON    |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="复制帐号建立"><a href="#复制帐号建立" class="headerlink" title="复制帐号建立"></a>复制帐号建立</h3><p>由于MySQL版本使用的是5.7，创建用户的方法以之前有些不同</p>
<h4 id="主库创建"><a href="#主库创建" class="headerlink" title="主库创建"></a>主库创建</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands end <span class="keyword">with</span> ; <span class="keyword">or</span> <span class="string">\g.</span></span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">4</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. Type <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">09</span>:<span class="number">37</span> &gt; create user <span class="string">'slave01'</span>@<span class="string">'192.168.16.81'</span> identified <span class="keyword">by</span> <span class="string">'slave123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">10</span>:<span class="number">13</span> &gt; grant replication slave,replication client <span class="literal">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'192.168.16.81'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">10</span>:<span class="number">39</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">10</span>:<span class="number">42</span> &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@master ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h4 id="从库创建"><a href="#从库创建" class="headerlink" title="从库创建"></a>从库创建</h4><figure class="highlight livescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands end <span class="keyword">with</span> ; <span class="keyword">or</span> <span class="string">\g.</span></span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">7</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. Type <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">11</span>:<span class="number">18</span> &gt; create user <span class="string">'slave01'</span>@<span class="string">'192.168.16.80'</span> identified <span class="keyword">by</span> <span class="string">'slave123456'</span>; </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">11</span>:<span class="number">30</span> &gt; grant replication slave,replication client <span class="literal">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'192.168.16.80'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">11</span>:<span class="number">40</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">11</span>:<span class="number">43</span> &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@slave ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="复制帐号验证"><a href="#复制帐号验证" class="headerlink" title="复制帐号验证"></a>复制帐号验证</h3><p>主库登录从库<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uslave01 -pslave123456 -h192.168.16.81 -e "select version()" </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">| version()     |</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">| 5.7.18-15-log |</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<p>从库登录主库<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uslave01 -pslave123456 -h192.168.16.80 -e "select version()" </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">| version()     |</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">| 5.7.18-15-log |</span><br><span class="line"><span class="code">+---------------+</span></span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="复制关系配置"><a href="#复制关系配置" class="headerlink" title="复制关系配置"></a>复制关系配置</h3><h4 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h4><p>登录主库，设置复制关系，来源于从库的复制<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-p</span></span><br><span class="line"><span class="string">Enter</span> <span class="attr">password:</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">the</span> <span class="string">MySQL</span> <span class="string">monitor.</span>  <span class="string">Commands</span> <span class="string">end</span> <span class="string">with</span> <span class="string">;</span> <span class="string">or</span> <span class="string">\g.</span></span><br><span class="line"><span class="string">Your</span> <span class="string">MySQL</span> <span class="string">connection</span> <span class="string">id</span> <span class="string">is</span> <span class="number">6</span></span><br><span class="line"><span class="string">Server</span> <span class="attr">version:</span> <span class="number">5.7</span><span class="number">.18</span><span class="bullet">-15</span><span class="bullet">-log</span> <span class="string">PLD/Linux</span> <span class="string">Distribution</span> <span class="string">Percona</span> <span class="string">Server</span> <span class="string">RPM</span></span><br><span class="line"></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2009</span><span class="bullet">-2017</span> <span class="string">Percona</span> <span class="string">LLC</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2000</span><span class="string">,</span> <span class="number">2017</span><span class="string">,</span> <span class="string">Oracle</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates.</span> <span class="string">All</span> <span class="string">rights</span> <span class="string">reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Oracle</span> <span class="string">is</span> <span class="string">a</span> <span class="string">registered</span> <span class="string">trademark</span> <span class="string">of</span> <span class="string">Oracle</span> <span class="string">Corporation</span> <span class="string">and/or</span> <span class="string">its</span></span><br><span class="line"><span class="string">affiliates.</span> <span class="string">Other</span> <span class="string">names</span> <span class="string">may</span> <span class="string">be</span> <span class="string">trademarks</span> <span class="string">of</span> <span class="string">their</span> <span class="string">respective</span></span><br><span class="line"><span class="string">owners.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Type</span> <span class="string">'help;'</span> <span class="string">or</span> <span class="string">'\h'</span> <span class="string">for</span> <span class="string">help.</span> <span class="string">Type</span> <span class="string">'\c'</span> <span class="string">to</span> <span class="string">clear</span> <span class="string">the</span> <span class="string">current</span> <span class="string">input</span> <span class="string">statement.</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">15</span><span class="string">:14:07</span> <span class="string">&gt; change master to master_host='192.168.16.81',master_user='slave01',master_password='slave123456',master_auto_position=1;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected, 2 warnings (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 15:14:46 &gt; start slave;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.04 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 15:14:49 &gt; show slave status\G</span></span><br><span class="line"><span class="string">*************************** 1. row ***************************</span></span><br><span class="line"><span class="string"></span><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">slave01</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">812</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">master-relay-bin.000002</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">1025</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">812</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">1233</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="string">e1ec82e8-ae51-11e7-8532-00163e128057</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">mysql.slave_master_info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">more</span> <span class="string">updates</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="attr">e1ec82e8-ae51-11e7-8532-00163e128057:1-3</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="attr">df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3,</span></span><br><span class="line"><span class="attr">e1ec82e8-ae51-11e7-8532-00163e128057:</span><span class="number">1</span><span class="bullet">-3</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </span><br><span class="line"><span class="attr">                 Channel_Name:</span> </span><br><span class="line"><span class="attr">           Master_TLS_Version:</span> </span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">15</span><span class="string">:14:56</span> <span class="string">&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h4><p>登录从库，设置复制关系，来源于主库的复制<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@slave</span> <span class="string">~]#</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-p</span></span><br><span class="line"><span class="string">Enter</span> <span class="attr">password:</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">the</span> <span class="string">MySQL</span> <span class="string">monitor.</span>  <span class="string">Commands</span> <span class="string">end</span> <span class="string">with</span> <span class="string">;</span> <span class="string">or</span> <span class="string">\g.</span></span><br><span class="line"><span class="string">Your</span> <span class="string">MySQL</span> <span class="string">connection</span> <span class="string">id</span> <span class="string">is</span> <span class="number">11</span></span><br><span class="line"><span class="string">Server</span> <span class="attr">version:</span> <span class="number">5.7</span><span class="number">.18</span><span class="bullet">-15</span><span class="bullet">-log</span> <span class="string">PLD/Linux</span> <span class="string">Distribution</span> <span class="string">Percona</span> <span class="string">Server</span> <span class="string">RPM</span></span><br><span class="line"></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2009</span><span class="bullet">-2017</span> <span class="string">Percona</span> <span class="string">LLC</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2000</span><span class="string">,</span> <span class="number">2017</span><span class="string">,</span> <span class="string">Oracle</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates.</span> <span class="string">All</span> <span class="string">rights</span> <span class="string">reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Oracle</span> <span class="string">is</span> <span class="string">a</span> <span class="string">registered</span> <span class="string">trademark</span> <span class="string">of</span> <span class="string">Oracle</span> <span class="string">Corporation</span> <span class="string">and/or</span> <span class="string">its</span></span><br><span class="line"><span class="string">affiliates.</span> <span class="string">Other</span> <span class="string">names</span> <span class="string">may</span> <span class="string">be</span> <span class="string">trademarks</span> <span class="string">of</span> <span class="string">their</span> <span class="string">respective</span></span><br><span class="line"><span class="string">owners.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Type</span> <span class="string">'help;'</span> <span class="string">or</span> <span class="string">'\h'</span> <span class="string">for</span> <span class="string">help.</span> <span class="string">Type</span> <span class="string">'\c'</span> <span class="string">to</span> <span class="string">clear</span> <span class="string">the</span> <span class="string">current</span> <span class="string">input</span> <span class="string">statement.</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">15</span><span class="string">:15:42</span> <span class="string">&gt; change master to master_host='192.168.16.80',master_user='slave01',master_password='slave123456',master_auto_position=1;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected, 2 warnings (0.05 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 15:15:53 &gt; start slave;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.04 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 15:15:55 &gt; show slave status\G</span></span><br><span class="line"><span class="string">*************************** 1. row ***************************</span></span><br><span class="line"><span class="string"></span><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">slave01</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">1470</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">slave-relay-bin.000002</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">1072</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">1470</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">1279</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="string">df5051fc-ae51-11e7-85ee-00163e0f0e4a</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">mysql.slave_master_info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">more</span> <span class="string">updates</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="attr">df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="attr">df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3,</span></span><br><span class="line"><span class="attr">e1ec82e8-ae51-11e7-8532-00163e128057:</span><span class="number">1</span><span class="bullet">-3</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </span><br><span class="line"><span class="attr">                 Channel_Name:</span> </span><br><span class="line"><span class="attr">           Master_TLS_Version:</span> </span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">15</span><span class="string">:16:00</span> <span class="string">&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="复制测试"><a href="#复制测试" class="headerlink" title="复制测试"></a>复制测试</h3><h4 id="主库登录测试"><a href="#主库登录测试" class="headerlink" title="主库登录测试"></a>主库登录测试</h4><p>登录主库，插入测试数据<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MySQL [test11] 15:17:10 &gt; create table if not exists t11(id int unsigned not null auto<span class="emphasis">_increment,name varchar(20),primary key(`id`));</span></span><br><span class="line"><span class="emphasis">Query OK, 0 rows affected (0.04 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">MySQL [test11] 15:17:20 &gt; insert into t11 values(null,'master11');</span></span><br><span class="line"><span class="emphasis">Query OK, 1 row affected (0.00 sec)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">MySQL [test11] 15:17:28 &gt; select * from t11;</span></span><br><span class="line"><span class="emphasis">+----+----------+</span></span><br><span class="line"><span class="emphasis">| id | name     |</span></span><br><span class="line"><span class="emphasis">+----+----------+</span></span><br><span class="line"><span class="emphasis">|  1 | master11 |</span></span><br><span class="line"><span class="emphasis">+----+----------+</span></span><br><span class="line"><span class="emphasis">1 row in set (0.00 sec)</span></span><br></pre></td></tr></table></figure></p>
<p>登录从库，查看测试数据，此时数据已经复制过来<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p test11 -e "select * from t11"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+----+</span>----------+</span><br><span class="line">| id | name     |</span><br><span class="line"><span class="code">+----+</span>----------+</span><br><span class="line">|  1 | master11 |</span><br><span class="line"><span class="code">+----+</span>----------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h4 id="从库登录测试"><a href="#从库登录测试" class="headerlink" title="从库登录测试"></a>从库登录测试</h4><p>登录从库，插入测试数据<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 15:18:56 &gt; <span class="keyword">create</span> <span class="keyword">database</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> test11;use test11;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] 15:19:20 &gt; <span class="keyword">create</span> table <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> t22(id int unsigned <span class="keyword">not</span> <span class="literal">null</span> auto_increment,name varchar(<span class="number">20</span>),<span class="keyword">primary</span> <span class="keyword">key</span>(<span class="symbol">`id`</span>));</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:38 &gt; <span class="keyword">insert</span> <span class="keyword">into</span> t22 <span class="keyword">values</span>(<span class="literal">null</span>,<span class="string">'slave11'</span>); </span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:43 &gt; <span class="keyword">select</span> * <span class="keyword">from</span> t22;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  2 | slave11 |</span><br><span class="line">+----+---------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:51 &gt;</span><br></pre></td></tr></table></figure></p>
<p>登录主库，查看测试数据，此时数据已经复制过来<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p test11 -e "select * from t22"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+----+</span>---------+</span><br><span class="line">| id | name    |</span><br><span class="line"><span class="code">+----+</span>---------+</span><br><span class="line">|  2 | slave11 |</span><br><span class="line"><span class="code">+----+</span>---------+</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="MHA帐号创建"><a href="#MHA帐号创建" class="headerlink" title="MHA帐号创建"></a>MHA帐号创建</h3><h4 id="主库创建-1"><a href="#主库创建-1" class="headerlink" title="主库创建"></a>主库创建</h4><p>登录主库，创建允许主库和从库连接的MHA用户信息，再分别尝试使用MHA用户登录(省略)<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">29</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">23</span>:<span class="number">16</span> &gt; <span class="keyword">create</span> user <span class="string">'mha01'</span>@<span class="string">'192.168.16.81'</span> identified <span class="keyword">by</span> <span class="string">'mha123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">24</span>:<span class="number">02</span> &gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha01'</span>@<span class="string">'192.168.16.81'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">24</span>:<span class="number">27</span> &gt; <span class="keyword">create</span> user <span class="string">'mha01'</span>@<span class="string">'192.168.16.80'</span> identified <span class="keyword">by</span> <span class="string">'mha123456'</span>; </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">24</span>:<span class="number">35</span> &gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha01'</span>@<span class="string">'192.168.16.80'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">15</span>:<span class="number">24</span>:<span class="number">41</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="从库创建-1"><a href="#从库创建-1" class="headerlink" title="从库创建"></a>从库创建</h4><p>登录从库，由于复制已经把在主库创建的MHA用户信息复制了过来，尝试登录即可(省略)</p>
<h2 id="MHA安装"><a href="#MHA安装" class="headerlink" title="MHA安装"></a>MHA安装</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>分别在主库和从库上安装，执行命令：<br>yum -y install gcc gcc-c++ make openssl-devel perl perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Config-IniFiles perl-Time-HiRes perl-Module-Install.noarch mailx jwhois cpan  </p>
<h3 id="主库安装mha4mysql-node"><a href="#主库安装mha4mysql-node" class="headerlink" title="主库安装mha4mysql-node"></a>主库安装mha4mysql-node</h3><p>MHA管理端安装在从库上，主库上只需要mha4mysql-node即可，由于MySQL使用5.7版本，MHA也使用最新的0.57版本，采用编译安装方式。下载地址：<a href="https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw" target="_blank" rel="noopener">https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw</a><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cd</span> /usr/src/</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">src</span>]<span class="comment"># tar -zxf mha4mysql-node-0.57.tar.gz</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># perl Makefile.PL             #编译过程省略</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># make</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># make install</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># ll /usr/local/bin/ -t        #查看安装，有以下文件则mha4mysql-node安装成功</span></span><br><span class="line">total <span class="number">1760</span></span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root  <span class="number">16381</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">8261</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> purge_relay_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">7525</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> save_binary_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">4807</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p>
<h3 id="从库安装mha4mysql-manager和mha4mysql-node"><a href="#从库安装mha4mysql-manager和mha4mysql-node" class="headerlink" title="从库安装mha4mysql-manager和mha4mysql-node"></a>从库安装mha4mysql-manager和mha4mysql-node</h3><p>MHA管理端安装在从库，从库需要安装manager端和node端<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># cd /usr/src/</span></span><br><span class="line">[root@slave src]<span class="comment"># tar -zxf mha4mysql-manager-0.57.tar.gz </span></span><br><span class="line">[root@slave src]<span class="comment"># cd mha4mysql-manager-0.57</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># perl Makefile.PL           #编译过程省略</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># make</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># make install </span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># ll /usr/local/bin/ -t      #查看安装，有以下文件则mha4mysql-manager安装成功</span></span><br><span class="line">total 40</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 1779 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_ssh</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 2517 </span>Oct<span class="number"> 11 </span>15:45 masterha_manager</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 2373 </span>Oct<span class="number"> 11 </span>15:45 masterha_master_switch</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 5171 </span>Oct<span class="number"> 11 </span>15:45 masterha_secondary_check</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 1995 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_repl</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 1865 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_status</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 3201 </span>Oct<span class="number"> 11 </span>15:45 masterha_conf_host</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 2165 </span>Oct<span class="number"> 11 </span>15:45 masterha_master_monitor</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 1739 </span>Oct<span class="number"> 11 </span>15:45 masterha_stop</span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># cd ..</span></span><br><span class="line">[root@slave src]<span class="comment"># tar -zxf mha4mysql-node-0.57.tar.gz </span></span><br><span class="line">[root@slave src]<span class="comment"># cd mha4mysql-node-0.57</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># perl Makefile.PL              #编译过程省略        </span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># make</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># make install</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># ll /usr/local/bin/ -t         #查看安装，有以下文件则mha4mysql-node安装成功</span></span><br><span class="line">total 84</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root<span class="number"> 16381 </span>Oct<span class="number"> 11 </span>15:47 apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root <span class="number"> 4807 </span>Oct<span class="number"> 11 </span>15:47 filter_mysqlbinlog</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root <span class="number"> 8261 </span>Oct<span class="number"> 11 </span>15:47 purge_relay_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root <span class="number"> 7525 </span>Oct<span class="number"> 11 </span>15:47 save_binary_logs</span><br></pre></td></tr></table></figure></p>
<h2 id="MHA目录结构说明"><a href="#MHA目录结构说明" class="headerlink" title="MHA目录结构说明"></a>MHA目录结构说明</h2><h3 id="MHAManager"><a href="#MHAManager" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>mhamanager工具包主要包括以下工具<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@slave  ~]<span class="comment"># ll /usr/local/bin/</span></span><br><span class="line">总用量 40</span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1995 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_repl         <span class="comment">#检查MySQL复制情况</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1779 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_ssh          <span class="comment">#检查MHA的SSH配置情况</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1865 </span>Oct<span class="number"> 11 </span>15:45 masterha_check_status       <span class="comment">#检测当前MHA运行状态</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 3201 </span>Oct<span class="number"> 11 </span>15:45 masterha_conf_host          <span class="comment">#添加或删除配置的server信息</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2517 </span>Oct<span class="number"> 11 </span>15:45 masterha_manager            <span class="comment">#启动MHA</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2165 </span>Oct<span class="number"> 11 </span>15:45 masterha_master_monitor     <span class="comment">#检测Master是否宕机</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2373 </span>Oct<span class="number"> 11 </span>15:45 masterha_master_switch      <span class="comment">#控制故障转移，自动或者手动</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 5172 </span>Oct<span class="number"> 11 </span>15:45 masterha_secondary_check    <span class="comment">#通过其他路由检测Master是否真的宕机</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1739 </span>Oct<span class="number"> 11 </span>15:45 masterha_stop               <span class="comment">#停止MHA</span></span><br></pre></td></tr></table></figure></p>
<h3 id="MHANode"><a href="#MHANode" class="headerlink" title="MHANode"></a>MHANode</h3><p>mhanode工具包主要包括以下工具<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># ll /usr/local/bin/ -t   </span></span><br><span class="line">total 84</span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root<span class="number"> 16371 </span>Oct<span class="number"> 11 </span>15:47 apply_diff_relay_logs       <span class="comment">#识别差异日志的中继日志，并将其差异事件应用于其他Slave</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 4807 </span>Oct<span class="number"> 11 </span>15:47 filter_mysqlbinlog          <span class="comment">#去除不必要的Rollback事件</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 8263 </span>Oct<span class="number"> 11 </span>15:47 purge_relay_logs            <span class="comment">#删除无用的Relay log，避免延时</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 7525 </span>Oct<span class="number"> 11 </span>15:47 save_binary_logs            <span class="comment">#保存和复制down掉的主服务器二进制日志</span></span><br></pre></td></tr></table></figure></p>
<h3 id="自定义扩展脚本说明"><a href="#自定义扩展脚本说明" class="headerlink" title="自定义扩展脚本说明"></a>自定义扩展脚本说明</h3><p>secondary_check_script #通过多条网络路由检测master的可用性<br>master_ip_failover_script #自动failover时候的切换脚本，可将vip信息写入此脚本中<br>shutdown_script #强制关闭master节点执行脚本<br>report_script #发送报告<br>init_conf_load_script #加载初始配置参数，如不想在配置中写明文密码<br>master_ip_online_change_script #手动failover时候的切换脚本  </p>
<h2 id="keepalived安装"><a href="#keepalived安装" class="headerlink" title="keepalived安装"></a>keepalived安装</h2><p>MHA作为MySQL的HA软件,借助脚本或者第三方软件如keepalived,可实现自动的failover<br>本次环境使用yum安装keepalived,主库和从库分别执行安装: yum -y install keepalived<br>keepalived的配置文件,默认在主库上绑定EIP,priority要比备库高,同时为了避免脑裂,两个state同时设置为BACKUP,由于HaVip不支持组播和广播通讯,因此需要将keepalived的心跳方式设置为单播,添加unicast_src_ip和unicast_peer</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><h4 id="主库配置-1"><a href="#主库配置-1" class="headerlink" title="主库配置"></a>主库配置</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     duanwenjie@huan.tv</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">   <span class="built_in"> interface </span>eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.16.82 dev eth0 label eth0:havip</span><br><span class="line">    &#125;</span><br><span class="line">        unicast_src_ip 192.168.16.80</span><br><span class="line">        unicast_peer &#123;</span><br><span class="line">                192.168.16.81</span><br><span class="line">                        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="从库配置-1"><a href="#从库配置-1" class="headerlink" title="从库配置"></a>从库配置</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     duanwenjie@huan.tv</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">   <span class="built_in"> interface </span>eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.16.82 dev eth0 label eth0:havip</span><br><span class="line">    &#125;</span><br><span class="line">        unicast_src_ip 192.168.16.81</span><br><span class="line">        unicast_peer &#123;</span><br><span class="line">                192.168.16.80</span><br><span class="line">                        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="EIP漂移测试"><a href="#EIP漂移测试" class="headerlink" title="EIP漂移测试"></a>EIP漂移测试</h3><p>分别启动keepalived服务，查看默认EIP在哪台机器上，同时关闭EIP所在机器的keepalived服务，查看EIP是否漂移，最后恢复原状</p>
<h4 id="主库启动keepalived服务"><a href="#主库启动keepalived服务" class="headerlink" title="主库启动keepalived服务"></a>主库启动keepalived服务</h4><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">keepalived</span>]<span class="comment"># /etc/init.d/keepalived start</span></span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">keepalived</span>]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h4 id="从库启动keepalived服务"><a href="#从库启动keepalived服务" class="headerlink" title="从库启动keepalived服务"></a>从库启动keepalived服务</h4><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@slave</span> keepalived]<span class="meta"># /etc/init.d/keepalived start</span></span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root<span class="symbol">@slave</span> keepalived]<span class="meta">#</span></span><br></pre></td></tr></table></figure>
<h4 id="查看默认EIP在主库上"><a href="#查看默认EIP在主库上" class="headerlink" title="查看默认EIP在主库上"></a>查看默认EIP在主库上</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span></span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:172562</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:71674</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:200695958</span> (191<span class="selector-class">.3</span> <span class="selector-tag">MiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:12526649</span> (11<span class="selector-class">.9</span> <span class="selector-tag">MiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7946</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7946</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:510910</span> (498<span class="selector-class">.9</span> <span class="selector-tag">KiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:510910</span> (498<span class="selector-class">.9</span> <span class="selector-tag">KiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure>
<h4 id="关闭主库的keepalived服务"><a href="#关闭主库的keepalived服务" class="headerlink" title="关闭主库的keepalived服务"></a>关闭主库的keepalived服务</h4><p>关闭主库的keepalived服务后，EIP消失<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">keepalived</span> <span class="selector-tag">stop</span></span><br><span class="line"><span class="selector-tag">Stopping</span> <span class="selector-tag">keepalived</span>:                                       <span class="selector-attr">[  OK  ]</span></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span></span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:172670</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:71803</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:200704346</span> (<span class="number">191.4</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:12569281</span> (<span class="number">11.9</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7976</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7976</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:512770</span> (<span class="number">500.7</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:512770</span> (<span class="number">500.7</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure></p>
<h4 id="查看EIP是否漂移到从库上"><a href="#查看EIP是否漂移到从库上" class="headerlink" title="查看EIP是否漂移到从库上"></a>查看EIP是否漂移到从库上</h4><p>此时EIP已经漂移到从库上<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@slave ~]</span># <span class="selector-tag">ifconfig</span></span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:80</span><span class="selector-pseudo">:57</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.81</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:164539</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:77532</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:202145589</span> (192<span class="selector-class">.7</span> <span class="selector-tag">MiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:12091265</span> (11<span class="selector-class">.5</span> <span class="selector-tag">MiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:80</span><span class="selector-pseudo">:57</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7961</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:7961</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:508050</span> (496<span class="selector-class">.1</span> <span class="selector-tag">KiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:508050</span> (496<span class="selector-class">.1</span> <span class="selector-tag">KiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@slave ~]</span>#</span><br></pre></td></tr></table></figure></p>
<h4 id="恢复原状"><a href="#恢复原状" class="headerlink" title="恢复原状"></a>恢复原状</h4><p>主库启动keepalived服务，查看EIP已经又漂移回来<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">keepalived</span> <span class="selector-tag">start</span></span><br><span class="line"><span class="selector-tag">Starting</span> <span class="selector-tag">keepalived</span>:                                       <span class="selector-attr">[  OK  ]</span></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span></span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:172863</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:71978</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:200717148</span> (<span class="number">191.4</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:12627987</span> (<span class="number">12.0</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8039</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8039</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:516676</span> (<span class="number">504.5</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:516676</span> (<span class="number">504.5</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure></p>
<h2 id="MHA配置"><a href="#MHA配置" class="headerlink" title="MHA配置"></a>MHA配置</h2><h3 id="MHAManager-1"><a href="#MHAManager-1" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>创建配置目录/etc/masterha/，同时创建一个项目上的配置文件，仅配置自动FailOver部分，脚本暂时不定义，下文会有MHA引入keepalived。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[server default]</span><br><span class="line"><span class="attribute">manager_workdir</span>=/var/log/masterha/app1   </span><br><span class="line"><span class="attribute">manager_log</span>=/var/log/masterha/app1/manager.log </span><br><span class="line"><span class="attribute">master_binlog_dir</span>=/hwdata/data/percona        </span><br><span class="line"><span class="attribute">password</span>=mha123456                             </span><br><span class="line"><span class="attribute">user</span>=mha01                                     </span><br><span class="line"><span class="attribute">ping_interval</span>=1                                    </span><br><span class="line"><span class="attribute">remote_workdir</span>=/tmp                                                </span><br><span class="line"><span class="attribute">repl_password</span>=slave123456                                          </span><br><span class="line"><span class="attribute">repl_user</span>=slave01                                                 </span><br><span class="line"><span class="attribute">ssh_user</span>=root                                                     </span><br><span class="line"><span class="comment">#master_ip_failover_script=/usr/local/bin/master_ip_failover        </span></span><br><span class="line"><span class="comment">#master_ip_online_change_script= /usr/local/bin/master_ip_online_change  </span></span><br><span class="line"><span class="comment">#report_script=/usr/local/bin/send_report                         </span></span><br><span class="line"><span class="comment">#shutdown_script=                                                 </span></span><br><span class="line">secondary_check_script = masterha_secondary_check -s 192.168.16.80 -s 192.168.16.81 <span class="attribute">--user</span>=root <span class="attribute">hostname</span>=192.168.16.80  <span class="attribute">--master_ip</span>=192.168.16.80 <span class="attribute">--master_port</span>=3306 </span><br><span class="line">[server1]</span><br><span class="line"><span class="attribute">hostname</span>=192.168.16.80                                          </span><br><span class="line"><span class="attribute">port</span>=3306</span><br><span class="line">[server2]</span><br><span class="line"><span class="attribute">hostname</span>=192.168.16.81                                         </span><br><span class="line"><span class="attribute">port</span>=3306</span><br><span class="line"><span class="attribute">candidate_master</span>=1</span><br></pre></td></tr></table></figure></p>
<h3 id="测试MHAManager-SSH"><a href="#测试MHAManager-SSH" class="headerlink" title="测试MHAManager SSH"></a>测试MHAManager SSH</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_ssh <span class="attribute">--conf</span>=/etc/masterha/app1.cnf </span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">info</span>] Starting SSH<span class="built_in"> connection </span>tests<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Wed Oct 11 17:21:46 2017 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.16.80(192.168.16.80:22) <span class="keyword">to</span> root@192.168.16.81(192.168.16.81:22)<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@192.168.16.81(192.168.16.81:22) <span class="keyword">to</span> root@192.168.16.80(192.168.16.80:22)<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [<span class="builtin-name">info</span>] All SSH<span class="built_in"> connection </span>tests passed successfully.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h3 id="测试MHAManager-复制"><a href="#测试MHAManager-复制" class="headerlink" title="测试MHAManager 复制"></a>测试MHAManager 复制</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_repl <span class="attribute">--conf</span>=/etc/masterha/app1.cnf</span><br><span class="line">Wed Oct 11 17:22:47 2017 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Wed Oct 11 17:22:47 2017 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:47 2017 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:47 2017 - [<span class="builtin-name">info</span>] MHA::MasterMonitor version 0.57.</span><br><span class="line">Creating directory /var/log/masterha/app1<span class="built_in">..</span> done.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Multi-master configuration is detected. Current primary(writable) master is 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Master configurations are as below: </span><br><span class="line">Master 192.168.16.81(192.168.16.81:3306), replicating <span class="keyword">from</span> 192.168.16.80(192.168.16.80:3306), read-only</span><br><span class="line">Master 192.168.16.80(192.168.16.80:3306), replicating <span class="keyword">from</span> 192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] GTID failover mode = 1</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Dead Servers:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Alive Servers:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]   192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]   192.168.16.81(192.168.16.81:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Alive Slaves:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]   192.168.16.81(192.168.16.81:3306)  <span class="attribute">Version</span>=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]     GTID ON</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Current Alive Master: 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Checking slave configurations<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Checking replication filtering settings<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]  Replication filtering check ok.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] GTID (with auto-pos) is supported. Skipping all SSH <span class="keyword">and</span> Node package checking.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Checking SSH publickey authentication<span class="built_in"> settings </span>on the current master<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] HealthCheck: SSH <span class="keyword">to</span> 192.168.16.80 is reachable.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] </span><br><span class="line">192.168.16.80(192.168.16.80:3306) (current master)</span><br><span class="line"> +--192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Checking replication<span class="built_in"> health </span>on 192.168.16.81<span class="built_in">..</span></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">warning</span>] master_ip_failover_script is <span class="keyword">not</span> defined.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">warning</span>] shutdown_script is <span class="keyword">not</span> defined.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [<span class="builtin-name">info</span>] Got exit code 0 (<span class="keyword">Not</span> master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication<span class="built_in"> Health </span>is OK.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h2 id="MHA引入keepalived"><a href="#MHA引入keepalived" class="headerlink" title="MHA引入keepalived"></a>MHA引入keepalived</h2><p>把keepalived服务引入MHA，需要修改切换是触发的脚本文件master_ip_failover即可，在该脚本中添加在master发生宕机时对keepalived的处理。</p>
<h3 id="master-ip-failover脚本"><a href="#master-ip-failover脚本" class="headerlink" title="master_ip_failover脚本"></a>master_ip_failover脚本</h3><p>编辑脚本/usr/local/bin/master_ip_failover，修改后如下，这里完整的脚本<br><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]<span class="comment"># cat /usr/local/bin/master_ip_failover </span></span><br><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> strict;</span><br><span class="line"><span class="keyword">use</span> warnings <span class="string">FATAL =&gt;</span> <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> Getopt::Long;</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> (</span><br><span class="line">    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,</span><br><span class="line">    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">my</span> $vip = <span class="string">'192.168.16.82'</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_start_vip = <span class="string">"/etc/init.d/keepalived start"</span>;</span><br><span class="line"><span class="keyword">my</span> $ssh_stop_vip = <span class="string">"/etc/init.d/keepalived stop"</span>;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    <span class="string">'command=s'</span>          =&gt; \$command,</span><br><span class="line">    <span class="string">'ssh_user=s'</span>         =&gt; \$ssh_user,</span><br><span class="line">    <span class="string">'orig_master_host=s'</span> =&gt; \$orig_master_host,</span><br><span class="line">    <span class="string">'orig_master_ip=s'</span>   =&gt; \$orig_master_ip,</span><br><span class="line">    <span class="string">'orig_master_port=i'</span> =&gt; \$orig_master_port,</span><br><span class="line">    <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span><br><span class="line">    <span class="string">'new_master_ip=s'</span>    =&gt; \$new_master_ip,</span><br><span class="line">    <span class="string">'new_master_port=i'</span>  =&gt; \$new_master_port,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">print</span> <span class="string">"\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( $command eq <span class="string">"stop"</span> || $command eq <span class="string">"stopssh"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">eval</span> &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Disabling the VIP on old master: $orig_master_host \n"</span>;</span><br><span class="line">            &amp;stop_vip();</span><br><span class="line">            $exit_code = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">            <span class="keyword">warn</span> <span class="string">"Got Error: $@\n"</span>;</span><br><span class="line">            <span class="keyword">exit</span> $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">"start"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">my</span> $exit_code = <span class="number">10</span>;</span><br><span class="line">        <span class="keyword">eval</span> &#123;</span><br><span class="line">            <span class="keyword">print</span> <span class="string">"Enabling the VIP - $vip on the new master - $new_master_host \n"</span>;</span><br><span class="line">            &amp;start_vip();</span><br><span class="line">            $exit_code = <span class="number">0</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">if</span> ($@) &#123;</span><br><span class="line">            <span class="keyword">warn</span> $@;</span><br><span class="line">            <span class="keyword">exit</span> $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">exit</span> $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">elsif</span> ( $command eq <span class="string">"status"</span> ) &#123;</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Checking the Status of the script.. OK \n"</span>;</span><br><span class="line">        <span class="comment">#`ssh $ssh_user\@$orig_master_ip \" $ssh_start_vip \"`;</span></span><br><span class="line">        <span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        &amp;usage();</span><br><span class="line">        <span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># A simple system call that enable the VIP on the new master</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">start_vip</span>() </span>&#123;</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$new_master_host \" $ssh_start_vip \"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># A simple system call that disable the VIP on the old_master</span></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">stop_vip</span>() </span>&#123;</span><br><span class="line">     <span class="keyword">return</span> <span class="number">0</span>  <span class="keyword">unless</span>  ($ssh_user);</span><br><span class="line">    <span class="string">`ssh $ssh_user\@$orig_master_host \" $ssh_stop_vip \"`</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">sub</span> <span class="title">usage</span> </span>&#123;</span><br><span class="line">    <span class="keyword">print</span></span><br><span class="line">    <span class="string">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@slave app1]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<p>添加权限<br>chmod +x /usr/local/bin/master_ip_failover</p>
<h3 id="send-report脚本"><a href="#send-report脚本" class="headerlink" title="send_report脚本"></a>send_report脚本</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/send_report </span></span><br><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">strict</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">warnings</span> <span class="title">FATAL</span> =&gt; '<span class="title">all</span>';</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mail</span>::<span class="title">Sender</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Getopt</span>::<span class="title">Long</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span></span><br><span class="line">my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );</span><br><span class="line">my $smtp=<span class="string">'smtp.126.com'</span>;</span><br><span class="line">my $mail_from=<span class="string">'xxx@126.com'</span>;</span><br><span class="line">my $mail_user=<span class="string">'xxx@126.com'</span>;</span><br><span class="line">my $mail_pass=<span class="string">'xxx'</span>;</span><br><span class="line"><span class="comment">#my $mail_to=['xxx','xxx'];</span></span><br><span class="line">my $mail_to=<span class="string">'xxx'</span>;</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'orig_master_host=s'</span> =&gt; \$dead_master_host,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span><br><span class="line">  <span class="string">'new_slave_hosts=s'</span>  =&gt; \$new_slave_hosts,</span><br><span class="line">  <span class="string">'subject=s'</span>          =&gt; \$subject,</span><br><span class="line">  <span class="string">'body=s'</span>             =&gt; \$body,</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);</span><br><span class="line"> </span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_;</span><br><span class="line">    open my $DEBUG, <span class="string">"&gt; /var/log/masterha/app1/manager.log"</span></span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Can't open the debug      file:$!\n"</span>;</span><br><span class="line">    my $sender = <span class="keyword">new</span> Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; <span class="string">'text/plain; charset=utf-8'</span>,</span><br><span class="line">        encoding    =&gt; <span class="string">'utf-8'</span>,</span><br><span class="line">        smtp        =&gt; $smtp,</span><br><span class="line">        from        =&gt; $mail_from,</span><br><span class="line">        auth        =&gt; <span class="string">'LOGIN'</span>,</span><br><span class="line">        TLS_allowed =&gt; <span class="string">'0'</span>,</span><br><span class="line">        authid      =&gt; $user,</span><br><span class="line">        authpwd     =&gt; $passwd,</span><br><span class="line">        to          =&gt; $mail_to,</span><br><span class="line">        subject     =&gt; $subject,</span><br><span class="line">        debug       =&gt; $DEBUG</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    $sender-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; $msg,</span><br><span class="line">            debug =&gt; $DEBUG</span><br><span class="line">        &#125;</span><br><span class="line">    ) <span class="keyword">or</span> <span class="keyword">print</span> $Mail::Sender::Error;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Do whatever you want here</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<p>添加权限<br>chmod +x /usr/local/bin/send_report</p>
<h3 id="MHAManager修改注释"><a href="#MHAManager修改注释" class="headerlink" title="MHAManager修改注释"></a>MHAManager修改注释</h3><figure class="highlight elixir"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="variable">@slave</span> app1]<span class="comment"># cat /etc/masterha/app1.cnf |grep master_ip_failover_script</span></span><br><span class="line">master_ip_failover_script=<span class="regexp">/usr/local</span><span class="regexp">/bin/master</span>_ip_failover        </span><br><span class="line">[root<span class="variable">@slave</span> app1]<span class="comment"># cat /etc/masterha/app1.cnf |grep report</span></span><br><span class="line">report_script=<span class="regexp">/usr/local</span><span class="regexp">/bin/send</span>_report                         </span><br><span class="line">[root<span class="variable">@slave</span> app1]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="HaVip绑定EIP"><a href="#HaVip绑定EIP" class="headerlink" title="HaVip绑定EIP"></a>HaVip绑定EIP</h2><p>keepalived服务已经配置完成，VIP也可以自动漂移后，但是其还不能在内网中通讯，需要将EIP映射到HaVip中，创建高可用虚拟IP，把master和slave两个实例的绑定在一起，具体步骤省略，见下图<br><img src="http://note.youdao.com/yws/public/resource/eed85389475569ba15ce22e5a266d5fb/xmlnote/E0CF3D2D9BE747299B2348C6AD4EAD30/37915" alt="image"></p>
<h2 id="MHA启动"><a href="#MHA启动" class="headerlink" title="MHA启动"></a>MHA启动</h2><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta"># nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;</span></span><br><span class="line">[<span class="meta">1</span>] <span class="number">6706</span></span><br><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta"># nohup: ignoring input and appending output to `nohup.out'</span></span><br></pre></td></tr></table></figure>
<h3 id="查看启动日志"><a href="#查看启动日志" class="headerlink" title="查看启动日志"></a>查看启动日志</h3><figure class="highlight x86asm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# cat /var/log/masterha/app1/manager.log</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">56</span> <span class="number">2017</span> - [info] MHA::MasterMonitor version <span class="number">0.57</span>.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Multi-master configuration is detected. Current primary(writable) master is <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Master configurations are as below: </span><br><span class="line">Master <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>), replicating from <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>), read-only</span><br><span class="line">Master <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>), replicating from <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">1</span></span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Dead Servers:</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Alive Servers:</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Alive Slaves:</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="meta">.18</span>-<span class="number">15</span>-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]     GTID ON</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Current Alive Master: <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Checking slave configurations..</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Checking replication filtering settings..</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  Replication filtering check ok.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] GTID (with auto-pos) is supported. Skipping all SSH <span class="keyword">and</span> Node package checking.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] HealthCheck: SSH to <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> is reachable.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] </span><br><span class="line"><span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>) (current master)</span><br><span class="line"> +--<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span>:<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Checking master_ip_failover_script status:</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> --orig_master_ip=<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> --orig_master_port=<span class="number">3306</span> </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">IN</span> SCRIPT <span class="keyword">TEST</span>====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  OK.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] shutdown_script is <span class="keyword">not</span> defined.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Set master ping interval <span class="number">1</span> seconds.</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Set secondary check script: masterha_secondary_check -s <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> -s <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.81</span> --user=root hostname=<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>  --master_ip=<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span> --master_port=<span class="number">3306</span></span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Starting ping health check on <span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>(<span class="number">192.168</span><span class="meta">.16</span><span class="meta">.80</span>:<span class="number">3306</span>)..</span><br><span class="line">Thu Oct <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Ping(SELECT) succeeded, waiting until MySQL doesn<span class="string">'t respond..</span></span><br><span class="line"><span class="string">[root@slave app1]#</span></span><br></pre></td></tr></table></figure>
<h2 id="模拟主库故障-自动FailOver"><a href="#模拟主库故障-自动FailOver" class="headerlink" title="模拟主库故障(自动FailOver)"></a>模拟主库故障(自动FailOver)</h2><h3 id="确认MHAManager进程状态"><a href="#确认MHAManager进程状态" class="headerlink" title="确认MHAManager进程状态"></a>确认MHAManager进程状态</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">ps</span> <span class="string">aux|grep</span> <span class="string">master</span></span><br><span class="line"><span class="string">root</span>      <span class="number">1217</span>  <span class="number">0.0</span>  <span class="number">0.0</span>  <span class="number">81520</span>  <span class="number">3440</span> <span class="string">?</span>        <span class="string">Ss</span>   <span class="string">Oct11</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">/usr/libexec/postfix/master</span></span><br><span class="line"><span class="string">root</span>     <span class="number">20887</span>  <span class="number">0.2</span>  <span class="number">0.4</span> <span class="number">194688</span> <span class="number">18736</span> <span class="string">pts/1</span>    <span class="string">S</span>    <span class="number">08</span><span class="string">:57</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">perl</span> <span class="string">/usr/local/bin/masterha_manager</span> <span class="bullet">--conf=/etc/masterha/app1.cnf</span></span><br><span class="line"><span class="string">root</span>     <span class="number">20998</span>  <span class="number">0.0</span>  <span class="number">0.0</span> <span class="number">103252</span>   <span class="number">844</span> <span class="string">pts/1</span>    <span class="string">S+</span>   <span class="number">08</span><span class="string">:59</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">grep</span> <span class="string">master</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">ifconfig</span>     <span class="comment">#VIP不在slave上</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">00</span><span class="string">:16:3E:12:80:57</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:192.168.16.81</span>  <span class="attr">Bcast:192.168.31.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:1500</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:288188</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:129868</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:211584573</span> <span class="string">(201.7</span> <span class="string">MiB)</span>  <span class="string">TX</span> <span class="attr">bytes:50227849</span> <span class="string">(47.9</span> <span class="string">MiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:50346</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:50346</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:0</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:3204922</span> <span class="string">(3.0</span> <span class="string">MiB)</span>  <span class="string">TX</span> <span class="attr">bytes:3204922</span> <span class="string">(3.0</span> <span class="string">MiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span></span><br></pre></td></tr></table></figure>
<h3 id="停止主库MySQL服务"><a href="#停止主库MySQL服务" class="headerlink" title="停止主库MySQL服务"></a>停止主库MySQL服务</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>   #停止前<span class="selector-tag">VIP</span>存在于主库上</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:278061</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:223278</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:210643899</span> (<span class="number">200.8</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:57552395</span> (<span class="number">54.8</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:50158</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:50158</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3130070</span> (<span class="number">2.9</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3130070</span> (<span class="number">2.9</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">mysqld</span> <span class="selector-tag">stop</span></span><br><span class="line"><span class="selector-tag">Shutting</span> <span class="selector-tag">down</span> <span class="selector-tag">MySQL</span> (Percona Server)............           <span class="selector-attr">[  OK  ]</span></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>   #停止后<span class="selector-tag">VIP</span>已经漂移走</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:278240</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:223445</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:210664827</span> (<span class="number">200.9</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:57596785</span> (<span class="number">54.9</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:50175</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:50175</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3131100</span> (<span class="number">2.9</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3131100</span> (<span class="number">2.9</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure>
<h3 id="查看FailOver日志"><a href="#查看FailOver日志" class="headerlink" title="查看FailOver日志"></a>查看FailOver日志</h3><p>登录从库，查看MHAManager日志<br><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# tail -f /var/<span class="built_in">log</span>/masterha/app1/manager.<span class="built_in">log</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">IN</span> SCRIPT TEST====/etc/init.d/keepalived <span class="keyword">stop</span>==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  OK.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] <span class="keyword">Set</span> master ping interval <span class="number">1</span> seconds.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] <span class="keyword">Set</span> secondary check script: masterha_secondary_check -s <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> -s <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> --user=root hostname=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>  --master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --master_port=<span class="number">3306</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Starting ping health check <span class="keyword">on</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">26</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Ping(<span class="keyword">SELECT</span>) succeeded, waiting until MySQL doesn<span class="comment">'t respond..     #开始监听服务状态</span></span><br><span class="line">#监控到master故障后，MHA开始做自动FailOver</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL <span class="keyword">select</span> ping: <span class="number">2006</span> (MySQL <span class="built_in">server</span> has gone away)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Executing secondary network check script: masterha_secondary_check -s <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> -s <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> --user=root hostname=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>  --master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --master_port=<span class="number">3306</span>  --user=root  --master_host=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>  --master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>  --master_port=<span class="number">3306</span> --master_user=mha01 --master_password=mha123456 --ping_type=<span class="keyword">SELECT</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Executing SSH check script: <span class="keyword">exit</span> <span class="number">0</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> <span class="keyword">is</span> reachable.</span><br><span class="line">Monitoring <span class="built_in">server</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> <span class="keyword">is</span> reachable, Master <span class="keyword">is</span> <span class="keyword">not</span> reachable from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>. OK.</span><br><span class="line">Monitoring <span class="built_in">server</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> <span class="keyword">is</span> reachable, Master <span class="keyword">is</span> <span class="keyword">not</span> reachable from <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>. OK.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Master <span class="keyword">is</span> <span class="keyword">not</span> reachable from all other monitoring servers. Failover should start.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">55</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL connect: <span class="number">2013</span> (Lost connection <span class="keyword">to</span> MySQL <span class="built_in">server</span> at <span class="comment">'reading initial communication packet', system error: 111)</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">55</span> <span class="number">2017</span> - [warning] Connection failed <span class="number">2</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">56</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL connect: <span class="number">2013</span> (Lost connection <span class="keyword">to</span> MySQL <span class="built_in">server</span> at <span class="comment">'reading initial communication packet', system error: 111)</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">56</span> <span class="number">2017</span> - [warning] Connection failed <span class="number">3</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">on</span> MySQL connect: <span class="number">2013</span> (Lost connection <span class="keyword">to</span> MySQL <span class="built_in">server</span> at <span class="comment">'reading initial communication packet', system error: 111)</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Connection failed <span class="number">4</span> <span class="built_in">time</span>(s)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Master <span class="keyword">is</span> <span class="keyword">not</span> reachable from health checker!</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Master <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>) <span class="keyword">is</span> <span class="keyword">not</span> reachable!</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] SSH <span class="keyword">is</span> reachable.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> a master <span class="built_in">server</span> failed. Reading configuration file /etc/masterha_default.cnf <span class="keyword">and</span> /etc/masterha/app1.cnf again, <span class="keyword">and</span> trying <span class="keyword">to</span> connect <span class="keyword">to</span> all servers <span class="keyword">to</span> check <span class="built_in">server</span> status..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [warning] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Reading application <span class="keyword">default</span> configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Reading <span class="built_in">server</span> configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">1</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Dead Servers:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Alive Servers:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Alive Slaves:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Checking slave configurations..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Checking replication filtering settings..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info]  Replication filtering check ok.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Master <span class="keyword">is</span> down!</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Terminating monitoring script.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Got <span class="keyword">exit</span> code <span class="number">20</span> (Master dead).</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] MHA::MasterFailover version <span class="number">0.57</span>.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Starting master failover.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">58</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">1</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Dead Servers:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Checking master reachability via MySQL(double check)...</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  ok.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Alive Servers:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Alive Slaves:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Starting GTID based failover.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Forcing shutdown so that applications never connect <span class="keyword">to</span> the current master..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Executing master IP deactivation script:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   /usr/local/bin/master_ip_failover --orig_master_host=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --orig_master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --orig_master_port=<span class="number">3306</span> --command=stopssh --ssh_user=root  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">IN</span> SCRIPT TEST====/etc/init.d/keepalived <span class="keyword">stop</span>==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Disabling the VIP <span class="keyword">on</span> old master: <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  done.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping <span class="keyword">explicit</span> shutting down of the dead master.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] The latest binary <span class="built_in">log</span> file/position <span class="keyword">on</span> all slaves <span class="keyword">is</span> mysql-bin<span class="number">.000005</span>:<span class="number">234</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Latest slaves (Slaves that received relay <span class="built_in">log</span> files <span class="keyword">to</span> the latest):</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] The oldest binary <span class="built_in">log</span> file/position <span class="keyword">on</span> all slaves <span class="keyword">is</span> mysql-bin<span class="number">.000005</span>:<span class="number">234</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Oldest slaves:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining <span class="keyword">New</span> Master Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Searching <span class="keyword">new</span> master from slaves..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Candidate masters from the configuration file:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> (oldest major version between slaves) <span class="built_in">log</span>-bin:enabled</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Replicating from <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Non-candidate masters:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Searching from candidate_master slaves which have received the latest relay <span class="built_in">log</span> events..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] <span class="keyword">New</span> master <span class="keyword">is</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Starting master failover..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">From:</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>) (current master)</span><br><span class="line"> +-<span class="number">-192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">To</span>:</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) (<span class="keyword">new</span> master)</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: <span class="keyword">New</span> Master Recovery Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Waiting all logs <span class="keyword">to</span> be applied.. </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   done.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Getting <span class="keyword">new</span> master<span class="comment">'s binlog name and position..</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  mysql-bin<span class="number">.000002</span>:<span class="number">4876</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER <span class="keyword">TO</span> MASTER_HOST=<span class="comment">'192.168.16.81', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='slave01', MASTER_PASSWORD='xxx';</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin<span class="number">.000002</span>, <span class="number">4876</span>, df5051fc-ae51<span class="number">-11e7</span><span class="number">-85</span>ee<span class="number">-00163e0</span>f0e4a:<span class="number">1</span><span class="number">-15</span>,</span><br><span class="line">e1ec82e8-ae51<span class="number">-11e7</span><span class="number">-8532</span><span class="number">-00163e128057</span>:<span class="number">1</span><span class="number">-6</span></span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Executing master IP activate script:</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   /usr/local/bin/master_ip_failover --command=start --ssh_user=root --orig_master_host=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --orig_master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span> --orig_master_port=<span class="number">3306</span> --new_master_host=<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> --new_master_ip=<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> --new_master_port=<span class="number">3306</span> --new_master_user=<span class="comment">'mha01'   --new_master_password=xxx</span></span><br><span class="line">Unknown <span class="keyword">option</span>: new_master_user</span><br><span class="line">Unknown <span class="keyword">option</span>: new_master_password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">IN</span> SCRIPT TEST====/etc/init.d/keepalived <span class="keyword">stop</span>==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Enabling the VIP - <span class="number">192.168</span><span class="number">.16</span><span class="number">.200</span> <span class="keyword">on</span> the <span class="keyword">new</span> master - <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span> </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  OK.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Setting read_only=<span class="number">0</span> <span class="keyword">on</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>)..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  ok.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] ** Finished master recovery successfully.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.1</span>: Starting Slaves <span class="keyword">in</span> parallel..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] All <span class="keyword">new</span> slave servers recovered successfully.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> master cleanup phase..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Resetting slave info <span class="keyword">on</span> the <span class="keyword">new</span> master..</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>: Resetting slave info succeeded.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Master failover <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) completed successfully.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] </span><br><span class="line"></span><br><span class="line">----- Failover Report -----</span><br><span class="line"></span><br><span class="line">app1: MySQL Master failover <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>) <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) succeeded</span><br><span class="line"></span><br><span class="line">Master <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>) <span class="keyword">is</span> down!</span><br><span class="line"></span><br><span class="line">Check MHA Manager logs at slave:/var/<span class="built_in">log</span>/masterha/app1/manager.<span class="built_in">log</span> <span class="keyword">for</span> details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated master IP address <span class="keyword">on</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.80</span>:<span class="number">3306</span>)</span><br><span class="line">Selected <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) as a <span class="keyword">new</span> master.</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>): OK: Applying all logs succeeded.</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>): OK: Activated master IP address.</span><br><span class="line"><span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>): Resetting slave info succeeded.</span><br><span class="line">Master failover <span class="keyword">to</span> <span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>(<span class="number">192.168</span><span class="number">.16</span><span class="number">.81</span>:<span class="number">3306</span>) completed successfully.</span><br><span class="line">Thu <span class="built_in">Oct</span> <span class="number">12</span> <span class="number">09</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Sending mail..</span><br><span class="line"><span class="keyword">Option</span> new_slave_hosts requires an argument</span><br><span class="line">Unknown <span class="keyword">option</span>: conf</span><br><span class="line">tail: /var/<span class="built_in">log</span>/masterha/app1/manager.<span class="built_in">log</span>: file truncated</span><br><span class="line">^C</span><br><span class="line">[<span class="number">1</span>]+  Done                    nohup masterha_manager --conf=/etc/masterha/app1.cnf  (wd: /etc/masterha)</span><br><span class="line">(wd <span class="built_in">now</span>: /var/<span class="built_in">log</span>/masterha/app1)</span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure></p>
<p><font color="#FF0000">注意：<br>由于阿里云的ECS默认不允许发送邮件，它们把25端口已经封掉，如果需要开通25端口，主联系阿里云技术支持。本次切换日志在最后没有发送邮件，是由于这个原因导致的。</font></p>
<h3 id="日志解析过程"><a href="#日志解析过程" class="headerlink" title="日志解析过程"></a>日志解析过程</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">启动前的准备工作</span><br><span class="line">检查数据库服务器状态,获取相关参数设置</span><br><span class="line">检查GTID、candidate_master、过滤DB是否设置</span><br><span class="line">测试ssh连接是否成功</span><br><span class="line">测试MHA <span class="keyword">node</span><span class="title">是否可用</span></span><br><span class="line"><span class="title">创建MHA</span>日志目录</span><br><span class="line">开始检查<span class="literal">slave</span>的差异日志应用权限</span><br><span class="line">确定当前的复制架构</span><br><span class="line">调试master_ip_failover_script</span><br><span class="line">调试shutdown_script</span><br><span class="line">设置二次检查的主机masterha_secondary_check</span><br><span class="line">MHA启动完毕,进入监测状态</span><br><span class="line">监测<span class="literal">master</span>服务器挂了</span><br><span class="line">通过定义的二次监测,确认<span class="literal">master</span>是否挂了</span><br><span class="line">确认<span class="literal">master</span>挂了,开始进入failover流程</span><br><span class="line">再试尝试连接<span class="literal">master</span>和<span class="literal">master</span>的ssh</span><br><span class="line">通过MHA配置文件,监测其他<span class="literal">slave</span>的状态</span><br><span class="line">再次监测<span class="literal">slave</span>的配置是否有变化,是否符合failover条件</span><br><span class="line">正式开始failover</span><br><span class="line">再次对<span class="literal">slave</span>配置做检查</span><br><span class="line">对原<span class="literal">Master</span>做master_ip_failover_script和shutdown_script的操作</span><br><span class="line">开始差异日志的恢复，获取<span class="literal">slave</span>最后得到的binlog位置</span><br><span class="line">获取原<span class="literal">master</span>的binlog日志</span><br><span class="line">确定新的<span class="literal">master</span></span><br><span class="line">在new <span class="literal">master</span>上应用差异的binlog日志</span><br><span class="line">获取new <span class="literal">master</span>的binlog位置。</span><br><span class="line">执行master_ip_failover_script,调用aws_vip_change.sh，执行VIP漂移</span><br><span class="line">开始恢复其他<span class="literal">slave</span>的差异日志</span><br><span class="line">差异日志应用完成以后,切换所有<span class="literal">slave</span>到new <span class="literal">master</span>。</span><br><span class="line">failover操作完成,生成failover报告</span><br><span class="line">最后发送邮件通知</span><br></pre></td></tr></table></figure>
<h3 id="确认FailOver状态"><a href="#确认FailOver状态" class="headerlink" title="确认FailOver状态"></a>确认FailOver状态</h3><p>登录从库，查看VIP是否漂移过程<br><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@slave app1]</span># <span class="selector-tag">ifconfig</span>     <span class="selector-id">#VIP</span>已经漂移过程</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:80</span><span class="selector-pseudo">:57</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.81</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:295022</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:135929</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:212253710</span> (202<span class="selector-class">.4</span> <span class="selector-tag">MiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:52246361</span> (49<span class="selector-class">.8</span> <span class="selector-tag">MiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth0</span><span class="selector-pseudo">:havip</span> <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> 00<span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:80</span><span class="selector-pseudo">:57</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.82</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:0.0.0.0</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.255.255</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:52973</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:52973</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3597938</span> (3<span class="selector-class">.4</span> <span class="selector-tag">MiB</span>)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3597938</span> (3<span class="selector-class">.4</span> <span class="selector-tag">MiB</span>)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@slave app1]</span>#</span><br></pre></td></tr></table></figure></p>
<p>登录主库，查看VIP是否存在，keepalived服务状态<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>   <span class="selector-id">#VIP</span>已经不存在</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">00</span><span class="selector-pseudo">:16</span><span class="selector-pseudo">:3E</span><span class="selector-pseudo">:0F</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:4A</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:192.168.16.80</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:192.168.31.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:1500</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:284277</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:229786</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:211190989</span> (<span class="number">201.4</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:60010868</span> (<span class="number">57.2</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:51564</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:51564</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:0</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3217146</span> (<span class="number">3.0</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:3217146</span> (<span class="number">3.0</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">keepalived</span> <span class="selector-tag">status</span>  <span class="selector-id">#keepalived</span>服务已经停止</span><br><span class="line"><span class="selector-tag">keepalived</span> <span class="selector-tag">is</span> <span class="selector-tag">stopped</span></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure></p>
<h3 id="手动FailOver"><a href="#手动FailOver" class="headerlink" title="手动FailOver"></a>手动FailOver</h3><p>MHA的手动FailOver不在本文范围，详情理论可参考官方文档。</p>
<h3 id="参数列表"><a href="#参数列表" class="headerlink" title="参数列表"></a>参数列表</h3><p>请参考之前<a href="https://dwj999.github.io/AWS-EC2%E6%90%AD%E5%BB%BAmha-vip-MySQL5-7.html#参数列表">文章</a>。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://dwj999.github.io/AWS-EC2搭建mha-vip-MySQL5-7.htm">https://dwj999.github.io/AWS-EC2搭建mha-vip-MySQL5-7.htm</a></p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>云服务器上MySQL高可用，也可通过云负载均衡产品+MySQL复制来实现，但在数据安全性上，没有MHA+VIP+MySQL相对安全。</p>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/ProxySQL-安装配置详解及读写分离、负载均衡.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/ProxySQL-安装配置详解及读写分离、负载均衡.html" itemprop="url">ProxySQL 安装配置详解及读写分离、负载均衡</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-29T15:58:45+08:00">
                2017-08-29
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/中间件/" itemprop="url" rel="index">
                    <span itemprop="name">中间件</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在MySQL的高可用集群环境中，中间件是不可缺少的一部分，它提供了读写分离、负载均衡等各种功能，满足集群的横向、纵向的可扩展。由于官方并没有在这方面推出好的产品，更多的是第三方的产品。如：</p>
<ul>
<li>ProxySQL  #Percona</li>
<li>MaxScale  #MariaDB</li>
<li>Atlas     #360开源</li>
<li>OneProxy  #平民软件楼方鑫</li>
<li>MyCat     #社区推广</li>
<li>KingShard #原Atlas作者离职后使用go开发</li>
<li>TDDL      #阿里巴巴开源</li>
<li>Cobar     #阿里巴巴开源</li>
<li>DBProxy   #美团在360Atlas上修改后开源</li>
<li>Fabric    #官方产品</li>
<li>DRDS      #阿里云分库分表产品</li>
</ul>
<p>本次以测试ProxySQL为例，逐步了解ProxySQL的使用方式。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>环境：<br>ProxySQL:   1.4.1<br>Master:     118.190.67.67<br>Slave:      139.196.95.103(192.168.7.50)</p>
<h2 id="安装配置详解"><a href="#安装配置详解" class="headerlink" title="安装配置详解"></a>安装配置详解</h2><p>官网：<a href="http://www.proxysql.com/" target="_blank" rel="noopener">http://www.proxysql.com/</a><br>Percona地址：<a href="https://www.percona.com/downloads/proxysql/" target="_blank" rel="noopener">https://www.percona.com/downloads/proxysql/</a><br>Github地址：<a href="https://github.com/sysown/proxysql/" target="_blank" rel="noopener">https://github.com/sysown/proxysql/</a><br>本文通过作者编译好的rpm安装，也可通过编译安装的方式安装，本文省略  </p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>下载proxysql可以有三种途径,分别为官网、Percona网站和Github网站<br>本文从github上下载最新稳定版本，这里选择centos67对应的rpm包<br>下载：wget -c -O proxysql-1.4.1-1-centos67.x86_64.rpm <a href="https://github.com/sysown/proxysql/releases/download/v1.4.1/proxysql-1.4.1-1-centos67.x86_64.rpm" target="_blank" rel="noopener">https://github.com/sysown/proxysql/releases/download/v1.4.1/proxysql-1.4.1-1-centos67.x86_64.rpm</a><br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ test]# yum localinstall -y proxysql-1.4.1-1-centos67.x86<span class="emphasis">_64.rpm</span></span><br><span class="line"><span class="emphasis">Loaded plugins: security</span></span><br><span class="line"><span class="emphasis">docker-main-repo                                                                                                                                 | 2.9 kB     00:00     </span></span><br><span class="line"><span class="emphasis">Setting up Install Process</span></span><br><span class="line"><span class="emphasis">Resolving Dependencies</span></span><br><span class="line"><span class="emphasis">There are unfinished transactions remaining. You might consider running yum-complete-transaction first to finish them.</span></span><br><span class="line"><span class="emphasis">--&gt; Running transaction check</span></span><br><span class="line"><span class="emphasis">---&gt; Package proxysql.x86_</span>64 0:1.4.1-1 will be installed</span><br><span class="line">--&gt; Finished Dependency Resolution</span><br><span class="line"></span><br><span class="line">Dependencies Resolved</span><br><span class="line"></span><br><span class="line">========================================================================================================================================================================</span><br><span class="line"><span class="code"> Package                           Arch                            Version                             Repository                                                  Size</span></span><br><span class="line">========================================================================================================================================================================</span><br><span class="line">Installing:</span><br><span class="line"><span class="code"> proxysql                          x86_64                          1.4.1-1                             /proxysql-1.4.1-1-centos67.x86_64                           19 M</span></span><br><span class="line"></span><br><span class="line">Transaction Summary</span><br><span class="line">========================================================================================================================================================================</span><br><span class="line">Install       1 Package(s)</span><br><span class="line"></span><br><span class="line">Total size: 19 M</span><br><span class="line">Installed size: 19 M</span><br><span class="line">Downloading Packages:</span><br><span class="line">Running rpm<span class="emphasis">_check_</span>debug</span><br><span class="line">Running Transaction Test</span><br><span class="line">Transaction Test Succeeded</span><br><span class="line">Running Transaction</span><br><span class="line"><span class="code">  Installing : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></span><br><span class="line"><span class="code">  Verifying  : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line"><span class="code">  proxysql.x86_64 0:1.4.1-1                                                                                                                                             </span></span><br><span class="line"></span><br><span class="line">Complete!</span><br></pre></td></tr></table></figure></p>
<p>ProxySQL默认配置文件为/etc/proxysql.cnf,只在第一次启动的时候有用,后续的所有配置都是通过对SQLite数据库的操作,并且不会更新到proxysql中,而是存储在/var/lib/proxysql/proxysql.db中<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie test]<span class="meta">#  proxysql --version    #查看版本</span></span><br><span class="line">ProxySQL version <span class="number">1.4</span><span class="number">.1</span><span class="number">-45</span>-gab4e6ee, codename Truls</span><br><span class="line">[root@jiessie test]<span class="meta"># rpm -ql proxysql   #查看安装的具体内容</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>init.d/proxysql                    <span class="meta">#启动脚本</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>proxysql.cnf                       <span class="meta">#默认配置文件</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>bin/proxysql                       <span class="meta">#执行文件</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/proxysql/</span>tools/proxysql_galera_checker.sh    <span class="meta">#ProxySQL调度程序检查pxc_maint_mode参数状态,持续检测各个节点的状态</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/proxysql/</span>tools/proxysql_galera_writer.pl <span class="meta">#ProxySQL指定一个节点直接将流量写入galera</span></span><br><span class="line">[root@jiessie test]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>启动之后才会生成存储目录/var/lib/proxysql<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie test]<span class="comment"># /etc/init.d/proxysql start</span></span><br><span class="line">Starting ProxySQL: DONE!</span><br><span class="line">[root@jiessie test]<span class="comment"># ll /var/lib/proxysql/</span></span><br><span class="line">总用量 108</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root<span class="number"> 98304 </span>8月 <span class="number"> 29 </span>15:37 proxysql.db</span><br><span class="line">-rw-------<span class="number"> 1 </span>root root <span class="number"> 4306 </span>8月 <span class="number"> 29 </span>16:25 proxysql.log</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root root    <span class="number"> 5 </span>8月 <span class="number"> 29 </span>16:25 proxysql.pid</span><br><span class="line">[root@jiessie test]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<h2 id="内置对象介绍"><a href="#内置对象介绍" class="headerlink" title="内置对象介绍"></a>内置对象介绍</h2><h3 id="登录"><a href="#登录" class="headerlink" title="登录"></a>登录</h3><p>启动了6032和6033两个端口,默认管理端口是6032,客户端服务端口是6033,默认的用户名密码都是 admin,通过mysql的客户端可以登录<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie test]<span class="comment"># netstat -tunlp|grep proxysql</span></span><br><span class="line">tcp        0      0 0.0.0.0:6032                0.0.0.0:*                   LISTEN      5181/proxysql       </span><br><span class="line">tcp        0      0 0.0.0.0:6033                0.0.0.0:*                   LISTEN      5181/proxysql       </span><br><span class="line">[root@jiessie test]<span class="comment"># mysql -uadmin -padmin -h127.0.0.1 -P6032</span></span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQ<span class="class">L monitor.  Commands end with ;</span><span class="built_in"> or </span>\g.</span><br><span class="line">Your MySQL connection id is 1</span><br><span class="line">Server version: 5.5.30 (ProxySQL Admin Module)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC<span class="built_in"> and/or </span>its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle<span class="built_in"> and/or </span>its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation<span class="built_in"> and/or </span>its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;'<span class="built_in"> or </span>'\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 16:28:32 &gt; show databases;</span><br><span class="line">+-----+---------+-------------------------------+</span><br><span class="line">| seq | name    | file                          |</span><br><span class="line">+-----+---------+-------------------------------+</span><br><span class="line">| 0   | main    |                               |</span><br><span class="line">| 2   | disk    | /var/lib/proxysql/proxysql.db |</span><br><span class="line">| 3   | stats   |                               |</span><br><span class="line">| 4   |<span class="built_in"> monitor </span>|                               |</span><br><span class="line">+-----+---------+-------------------------------+</span><br><span class="line">4 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 16:28:41 &gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="内置库"><a href="#内置库" class="headerlink" title="内置库"></a>内置库</h3><p>main：默认数据库名,用于存放后端db实例、用户认证、路由规则等信息。表名以runtime_开头的表示proxysql当前运行的配置内容，不能通过dml语句修改。只能修改对应的不以runtime_开头的（在内存）里的表，然后LOAD使其生效，SAVE使其存到硬盘以供下次重启加载。<br>disk：是持久化到硬盘的配置，sqlite数据文件。<br>stats：是proxysql运行抓取的统计信息，包括到后端各命令的执行次数、流量、processlist、查询各类汇总、执行时间等。<br>monitor：库存储monitor模块收集的信息，主要是对后端db的健康、延迟检查。  </p>
<h4 id="main库"><a href="#main库" class="headerlink" title="main库"></a>main库</h4><h5 id="runtime-表"><a href="#runtime-表" class="headerlink" title="runtime_表"></a>runtime_表</h5><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 17:19:10 &gt; use main</span><br><span class="line">Database changed</span><br><span class="line">MySQL [main] 17:22:15 &gt; show tables;</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">|<span class="string"> tables                                     </span>|</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">|<span class="string"> global_variables                           </span>|</span><br><span class="line">|<span class="string"> mysql_collations                           </span>|</span><br><span class="line">|<span class="string"> mysql_group_replication_hostgroups         </span>|</span><br><span class="line">|<span class="string"> mysql_query_rules                          </span>|</span><br><span class="line">|<span class="string"> mysql_replication_hostgroups               </span>|</span><br><span class="line">|<span class="string"> mysql_servers                              </span>|</span><br><span class="line">|<span class="string"> mysql_users                                </span>|</span><br><span class="line">|<span class="string"> proxysql_servers                           </span>|</span><br><span class="line">|<span class="string"> runtime_global_variables                   </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_group_replication_hostgroups </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_query_rules                  </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_replication_hostgroups       </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_servers                      </span>|</span><br><span class="line">|<span class="string"> runtime_mysql_users                        </span>|</span><br><span class="line">|<span class="string"> runtime_proxysql_servers                   </span>|</span><br><span class="line">|<span class="string"> runtime_scheduler                          </span>|</span><br><span class="line">|<span class="string"> scheduler                                  </span>|</span><br><span class="line">+--------------------------------------------+</span><br><span class="line">17 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 17:22:16 &gt;</span><br></pre></td></tr></table></figure>
<p>其中，runtime_开关的表如下：  </p>
<ul>
<li>runtime_global_variables：global_variables的运行时版本  </li>
<li>runtime_mysql_group_replication_hostgroups：mysql_group_replication_hostgroups的运行时版本  </li>
<li>runtime_mysql_query_rules：mysql_query_rules的运行时版本  </li>
<li>runtime_mysql_replication_hostgroups：mysql_replication_hostsgroups的运行时版本  </li>
<li>runtime_mysql_servers：mysql_servers的运行时版本  </li>
<li>runtime_mysql_users：mysql_users的运行时版本  </li>
<li><p>runtime_scheduler：scheduler调度程序的运行时版本</p>
<h6 id="global-variables表"><a href="#global-variables表" class="headerlink" title="global_variables表"></a>global_variables表</h6><p>内置参数表，参考下文</p>
<h6 id="mysql-servers表"><a href="#mysql-servers表" class="headerlink" title="mysql_servers表"></a>mysql_servers表</h6><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] <span class="number">17</span>:<span class="number">22</span>:<span class="number">16</span> &gt; show create table mysql_servers\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: mysql_servers</span><br><span class="line">Create Table: CREATE TABLE mysql_servers (</span><br><span class="line">    hostgroup_id <span class="built_in">INT</span> <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    hostname VARCHAR <span class="literal">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    port <span class="built_in">INT</span> <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">3306</span>,</span><br><span class="line">    status VARCHAR CHECK (UPPER(status) <span class="keyword">IN</span> (<span class="string">'ONLINE'</span>,<span class="string">'SHUNNED'</span>,<span class="string">'OFFLINE_SOFT'</span>, <span class="string">'OFFLINE_HARD'</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'ONLINE'</span>,</span><br><span class="line">    weight <span class="built_in">INT</span> CHECK (weight &gt;= <span class="number">0</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1</span>,</span><br><span class="line">    compression <span class="built_in">INT</span> CHECK (compression &gt;=<span class="number">0</span> <span class="literal">AND</span> compression &lt;= <span class="number">102400</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    max_connections <span class="built_in">INT</span> CHECK (max_connections &gt;=<span class="number">0</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">1000</span>,</span><br><span class="line">    max_replication_lag <span class="built_in">INT</span> CHECK (max_replication_lag &gt;= <span class="number">0</span> <span class="literal">AND</span> max_replication_lag &lt;= <span class="number">126144000</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    use_ssl <span class="built_in">INT</span> CHECK (use_ssl <span class="keyword">IN</span>(<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    max_latency_ms <span class="built_in">INT</span> UNSIGNED CHECK (max_latency_ms&gt;=<span class="number">0</span>) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    comment VARCHAR <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">    PRIMARY KEY (hostgroup_id, hostname, port) )</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] <span class="number">17</span>:<span class="number">34</span>:<span class="number">05</span> &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>hostgroup_id：ProxySQL通过hostgroup的形式组织后端db实例,一个hostgroup代表同属于一个角色。<br>表的主键是(hostgroup_id, hostname, port),以hostname:port在多个hostgroup中存在。<br>一个hostgroup可以有多个实例，即是多个从库，可能通过weight分配权重。<br>hostgroup_id 0是一个特殊的hostgroup，路由查询的时候，没有匹配到规则则默认选择hostgroup 0。  </p>
</li>
<li>status：<br>ONLINE：当前后端实例状态正常。<br>SHUNNED：临时被剔除，可能因为后端too many connection error，或者超过了max_replication_lag。<br>OFFLINE_SOFT：软离线状态，不再接受新的连接，但已建立的连接会等待活跃事务完成。<br>OFFLINE_HARD：硬离线状态，不再接受新的连接，已建立的连接或被强制中断，当后端实例宕机或网络不可达，会出现。  </li>
<li>max_connections：允许连接到该后端实例的最大连接数，不要大于MySQL的max_connections。<br>如果后端实例hostname:port在多个hostgroup里，以较大者为准，而不是各自独立允许的最大连接数。  </li>
<li>max_replication_lag：允许的最大延迟，主库不受影响，默认为0，如果&gt;0，monitor模块监控主从延迟大于阈值时，会临时把它的状态变更为SHUNNED。  </li>
<li>max_latency_ms：mysql_ping响应时间，大于这个阈值会把它从连接池剔除，即使是ONLINE。  </li>
<li>comment：备注，不建设为空。  </li>
<li><p>其他的字段，可通过字面意思理解。  </p>
<h5 id="mysql-users表"><a href="#mysql-users表" class="headerlink" title="mysql_users表"></a>mysql_users表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 09:13:02 &gt; show create table mysql_users\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_users</span><br><span class="line">Create Table: CREATE TABLE mysql_users (</span><br><span class="line">    username VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    password VARCHAR,</span><br><span class="line">    active INT CHECK (active <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</span><br><span class="line">    use_ssl INT CHECK (use_ssl <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    default_hostgroup INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    default_schema VARCHAR,</span><br><span class="line">    schema_locked INT CHECK (schema_locked <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    transaction_persistent INT CHECK (transaction_persistent <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</span><br><span class="line">    fast_forward INT CHECK (fast_forward <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    backend INT CHECK (backend <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</span><br><span class="line">    frontend INT CHECK (frontend <span class="keyword">IN</span> (0,1)) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>1,</span><br><span class="line">    max_connections INT CHECK (max_connections &gt;=0) <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>10000,</span><br><span class="line">    PRIMARY KEY (username, backend),</span><br><span class="line">    UNIQUE (username, frontend))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 09:13:08 &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>username,password：连接到后端MySQL或ProxySQL实例的凭证,参考<a href="https://github.com/sysown/proxysql/wiki/Passwords-management" target="_blank" rel="noopener">密码管理</a>。<br>密码可插入明文，也可通过PASSWORD()插入密文，proxysql以*开头判断插入是否是密文。<br>但是runtime_mysql_users里统一是密文，所以明文插入，再SAVE MYSQL USERS TO MEM，此时看到的也是HASH密文。  </p>
</li>
<li>active：是否生效该用户，active=0的用户将在数据库中被跟踪，但不会加载到内存中的数据结构中。  </li>
<li>default_hostgroup：这个用户的请求没有匹配到规则时，默认发到hostgroup，默认0。  </li>
<li>default_schema：这个用户连接时没有指定schema时，默认使用的schema。<br>默认为NULL，实际上受变量mysql-default_schema的影响，默认为information_schema。  </li>
<li>transaction_persistent： 如果设置为1，连接上ProxySQL的会话后，如果在一个hostgroup上开启了事务，那么后续的sql都继续维持在这个hostgroup上，不论是否会匹配上其它路由规则，直到事务结束。  </li>
<li>frontend：如果设置为1，则用户名、密码对ProxySQL进行身份验证。  </li>
<li><p>backend：如果设置为1，则用户名、密码根据任何主机组向mysqld服务器进行身份验证。<br>注意，目前所有用户都需要将“前端”和“后端“都设置为1，未来版本的ProxySQL将分离前端和后端之间的crendentials。以这种方式，前端将永远不会知道直接连接到后端的凭据，强制所有通过ProxySQL的连接并增加系统的安全性。  </p>
<h5 id="mysql-replication-hostgroups表"><a href="#mysql-replication-hostgroups表" class="headerlink" title="mysql_replication_hostgroups表"></a>mysql_replication_hostgroups表</h5><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 10:<span class="number">18</span>:<span class="number">15</span> &gt; <span class="keyword">show</span> <span class="keyword">create</span> table mysql_replication_hostgroups\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: mysql_replication_hostgroups</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE mysql_replication_hostgroups (</span><br><span class="line">    writer_hostgroup INT CHECK (writer_hostgroup&gt;=<span class="number">0</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>,</span><br><span class="line">    reader_hostgroup INT <span class="keyword">NOT</span> <span class="literal">NULL</span> CHECK (reader_hostgroup&lt;&gt;writer_hostgroup <span class="keyword">AND</span> reader_hostgroup&gt;<span class="number">0</span>),</span><br><span class="line">    comment VARCHAR,</span><br><span class="line">    <span class="keyword">UNIQUE</span> (reader_hostgroup))</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] <span class="number">10</span>:<span class="number">18</span>:<span class="number">22</span> &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义hostgroup的主从关系。ProxySQL monitor模块会监控hostgroup后端所有servers的read_only变量，如果发现从库的read_only变为0、主库变为1，则认为角色互换了，自动改写mysql_servers表里面hostgroup关系，达到failover效果。  </p>
<h5 id="mysql-query-rules查询规则表"><a href="#mysql-query-rules查询规则表" class="headerlink" title="mysql_query_rules查询规则表"></a>mysql_query_rules查询规则表</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] <span class="number">10</span>:<span class="number">25</span>:<span class="number">22</span> &gt; show create table mysql_query_rules\G           </span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: mysql_query_rules</span><br><span class="line">Create Table: CREATE TABLE mysql_query_rules (</span><br><span class="line">    rule_id INTEGER PRIMARY KEY AUTOINCREMENT <span class="literal">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    active <span class="built_in">INT</span> CHECK (active <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    username VARCHAR,</span><br><span class="line">    schemaname VARCHAR,</span><br><span class="line">    flagIN <span class="built_in">INT</span> <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    client_addr VARCHAR,</span><br><span class="line">    proxy_addr VARCHAR,</span><br><span class="line">    proxy_port <span class="built_in">INT</span>,</span><br><span class="line">    digest VARCHAR,</span><br><span class="line">    match_digest VARCHAR,</span><br><span class="line">    match_pattern VARCHAR,</span><br><span class="line">    negate_match_pattern <span class="built_in">INT</span> CHECK (negate_match_pattern <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    re_modifiers VARCHAR <span class="keyword">DEFAULT</span> <span class="string">'CASELESS'</span>,</span><br><span class="line">    flagOUT <span class="built_in">INT</span>,</span><br><span class="line">    replace_pattern VARCHAR,</span><br><span class="line">    destination_hostgroup <span class="built_in">INT</span> <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cache_ttl <span class="built_in">INT</span> CHECK(cache_ttl &gt; <span class="number">0</span>),</span><br><span class="line">    reconnect <span class="built_in">INT</span> CHECK (reconnect <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">    timeout <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    retries <span class="built_in">INT</span> CHECK (retries&gt;=<span class="number">0</span> <span class="literal">AND</span> retries &lt;=<span class="number">1000</span>),</span><br><span class="line">    delay <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    next_query_flagIN <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    mirror_flagOUT <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    mirror_hostgroup <span class="built_in">INT</span> UNSIGNED,</span><br><span class="line">    error_msg VARCHAR,</span><br><span class="line">    OK_msg VARCHAR,</span><br><span class="line">    sticky_conn <span class="built_in">INT</span> CHECK (sticky_conn <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)),</span><br><span class="line">    multiplex <span class="built_in">INT</span> CHECK (multiplex <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>,<span class="number">2</span>)),</span><br><span class="line">    <span class="built_in">log</span> <span class="built_in">INT</span> CHECK (<span class="built_in">log</span> <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)),</span><br><span class="line">    apply <span class="built_in">INT</span> CHECK(apply <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="literal">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    comment VARCHAR)</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] <span class="number">10</span>:<span class="number">25</span>:<span class="number">34</span> &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>rule_id：表主键，自增，规则处理是以rule_id为顺序进行。  </p>
</li>
<li>active：只有active=1时的规则才会参与匹配。  </li>
<li>username：过滤匹配用户名的条件，如果是非空值，则仅当连接使用正确的用户名时，查询才匹配。  </li>
<li>schemaname：匹配schemaname的过滤条件，如果是非空值，则仅当连接schemaname用作默认模式时，查询才匹配。  </li>
<li>flagIN,flagOUT,apply：用来定义路由链chains of rules<br>首先会检查flagIN=0的规则，以rule_id的顺序；如果没有匹配上，则走这个用户的default_hostgroup。<br>当匹配一条规则后，会检查flagOUT。<br>如果不为NULL，并且flagIN!=flagOUT，则进入以flagIN为上一个flagOUT值的新规则链。<br>如果不为NULL，并且flagIN=flagOUT，则应用这条规则。<br>如果为NULL，或者apply=1，则结束，应用这条规则。<br>如果最终没有匹配到，则找到这个用户的default_hostgroup。  </li>
<li>client_addr：匹配客户端来源IP。  </li>
<li>proxy_addr,proxy_port：匹配本地proxysql的ip、端口。  </li>
<li>digest：精确匹配的查询。  </li>
<li>match_digest：正则匹配查询。query,digest是指对查询去掉具体值后进行”模糊化“后的查询，类似pt-query-digest的效果。  </li>
<li>match_pattern：正则匹配查询。<br>以上都是匹配查询的规则，1.4版本可以通过变量mysql-query_processor_regex设置，支持RE2和PCRE，1.4版本开始默认为PCRE。  </li>
<li>negate_match_pattern：反向匹配，相当于对match_digest/match_pattern的匹配取反。  </li>
<li>re_modifiers：修改正则匹配的参数，比如默认的：忽略大小写CASELESS、禁用GLOBAL。  </li>
<li>下面是匹配后的行为：  </li>
<li>replace_pattern：查询重写，默认为空。  </li>
<li>destination_hostgroup：路由查询到这个hostgroup，当然如果用户显式start transaction且transaction_persistent=1,那么即使匹配到了，也依然按照事务里第一条sql的路由规则去走的。  </li>
<li>cache_ttl：查询结果缓存的毫秒数。  </li>
<li>timeout：这一类查询执行的的最大时间(毫秒),超时则自动kill。<br>这是对后端DB的保护机制，相当于阿里云RDS的loose_max_statement_time变量的功能，但不同的是，阿里云这个变量的时间时不包括DML操作出现InnoDB行锁等待的时间，而ProxySQL的这个timeout是计算从发送sql到等待响应的时间。默认mysql-default_query_timeout是10h。  </li>
<li>retries：语句在执行失败时，重试次数。默认由mysql-query_retries_on_failure变量指定，为1。建议不要重试，有风险。  </li>
<li>delay：查询延迟执行，这是ProxySQL提供的限流机制，会让其它的查询优先执行。<br>默认值mysql-default_query_delay为0。  </li>
<li>mirror_flagOUT,mirror_hostgroup：与镜像相关的设置。  </li>
<li>error_msg：默认为NULL，如果指定了则这个查询直接被block掉，将error_msg返回给客户端。  </li>
<li>multiplex：连接是否利用，请参考<a href="http://seanlook.com/2017/04/17/mysql-proxysql-multiplexing/" target="_blank" rel="noopener">文章</a>。  </li>
<li><p>log：是否记录查询日志，可以看到log是否记录的对象是根据规则。<br>要开启日志记录，需要设置变量mysql-eventslog_filename来指定文件名，然后这个log标记为1。但是目前proxysql记录的日志是二进制格式，需要特定的工具才能读取：eventslog_reader_sample。这个工具在源码目录 tools下面。  </p>
<h5 id="scheduler调度表"><a href="#scheduler调度表" class="headerlink" title="scheduler调度表"></a>scheduler调度表</h5><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 10:<span class="number">27</span>:<span class="number">52</span> &gt; <span class="keyword">show</span> <span class="keyword">create</span> table scheduler\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: scheduler</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE scheduler (</span><br><span class="line">    id INTEGER <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> AUTOINCREMENT <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    active INT CHECK (active <span class="keyword">IN</span> (<span class="number">0</span>,<span class="number">1</span>)) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="number">1</span>,</span><br><span class="line">    interval_ms INTEGER CHECK (interval_ms&gt;=<span class="number">100</span> <span class="keyword">AND</span> interval_ms&lt;=<span class="number">100000000</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    filename VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    arg1 VARCHAR,</span><br><span class="line">    arg2 VARCHAR,</span><br><span class="line">    arg3 VARCHAR,</span><br><span class="line">    arg4 VARCHAR,</span><br><span class="line">    arg5 VARCHAR,</span><br><span class="line">    comment VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>)</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] <span class="number">11</span>:<span class="number">09</span>:<span class="number">59</span> &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>id：调度程序作业的唯一标识符。  </p>
</li>
<li>active：如果设置为1，则作业处于活动状态。</li>
<li>interval_ms：工作的开始频率(以毫秒为单位)，最小interval_ms为100毫秒。  </li>
<li>filename：可执行文件的完整路径。  </li>
<li>arg1-arg5：传递作业的参数。最多5个。  </li>
<li>comment：注释。  </li>
<li>参考<a href="https://github.com/sysown/proxysql/wiki/Scheduler" target="_blank" rel="noopener">文档</a><h4 id="disk库"><a href="#disk库" class="headerlink" title="disk库"></a>disk库</h4><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 15:12:14 &gt; show tables from disk;</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">| tables                             |</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">| global<span class="emphasis">_variables                   |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>collations                   |</span><br><span class="line">| mysql<span class="emphasis">_group_</span>replication<span class="emphasis">_hostgroups |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>query<span class="emphasis">_rules                  |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>replication<span class="emphasis">_hostgroups       |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>servers                      |</span><br><span class="line">| mysql<span class="emphasis">_users                        |</span></span><br><span class="line"><span class="emphasis">| proxysql_</span>servers                   |</span><br><span class="line">| scheduler                          |</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">9 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 15:12:26 &gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>具体的表介绍和main库一致。  </p>
<h4 id="stats库"><a href="#stats库" class="headerlink" title="stats库"></a>stats库</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 15:12:26 &gt; show tables from stats;</span><br><span class="line">+-----------------------------------+</span><br><span class="line">|<span class="string"> tables                            </span>|</span><br><span class="line">+-----------------------------------+</span><br><span class="line">|<span class="string"> global_variables                  </span>|</span><br><span class="line">|<span class="string"> stats_memory_metrics              </span>|</span><br><span class="line">|<span class="string"> stats_mysql_commands_counters     </span>|</span><br><span class="line">|<span class="string"> stats_mysql_connection_pool       </span>|</span><br><span class="line">|<span class="string"> stats_mysql_connection_pool_reset </span>|</span><br><span class="line">|<span class="string"> stats_mysql_global                </span>|</span><br><span class="line">|<span class="string"> stats_mysql_processlist           </span>|</span><br><span class="line">|<span class="string"> stats_mysql_query_digest          </span>|</span><br><span class="line">|<span class="string"> stats_mysql_query_digest_reset    </span>|</span><br><span class="line">|<span class="string"> stats_mysql_query_rules           </span>|</span><br><span class="line">|<span class="string"> stats_mysql_users                 </span>|</span><br><span class="line">|<span class="string"> stats_proxysql_servers_metrics    </span>|</span><br><span class="line">|<span class="string"> stats_proxysql_servers_status     </span>|</span><br><span class="line">+-----------------------------------+</span><br><span class="line">13 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 15:13:53 &gt;</span><br></pre></td></tr></table></figure>
<h5 id="stats-mysql-commands-counters表"><a href="#stats-mysql-commands-counters表" class="headerlink" title="stats_mysql_commands_counters表"></a>stats_mysql_commands_counters表</h5><figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] <span class="number">15</span>:<span class="number">15</span>:<span class="number">36</span> &gt; show create table stats.stats_mysql_commands_counters\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: stats_mysql_commands_counters</span><br><span class="line">Create Table: CREATE TABLE stats_mysql_commands_counters (</span><br><span class="line">    Command VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span> PRIMARY KEY,</span><br><span class="line">    Total_Time_us <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    Total_cnt <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_100us <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_500us <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_1ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_5ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_10ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_50ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_100ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_500ms <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_1s <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_5s <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_10s <span class="built_in">INT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    cnt_INFs)</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] <span class="number">15</span>:<span class="number">15</span>:<span class="number">58</span> &gt;</span><br></pre></td></tr></table></figure>
<ul>
<li>command：已执行的SQL命令的类型，如FLUSH、INSERT、KILL、SELECT FOR UPDATE等。  </li>
<li>Total_Time_us：执行该类型命令的总时间(以毫秒为单位)。  </li>
<li>Total_cnt：执行该类型的命令的总数。  </li>
<li><p>cnt_100us-cnt_INFs：在指定的时间限制内执行的给定类型的命令总数和前一个命令的总数。<br>#####　stats_mysql_connection_pool表</p>
<figure class="highlight excel"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] <span class="symbol">15:15</span><span class="symbol">:58</span> &gt; show create table stats.stats_mysql_connection_pool \G </span><br><span class="line">*************************** <span class="number">1</span>. <span class="built_in">row</span> ***************************</span><br><span class="line">       tab<span class="symbol">le:</span> stats_mysql_connection_pool</span><br><span class="line">Create Tab<span class="symbol">le:</span> CREATE TABLE stats_mysql_connection_pool (</span><br><span class="line">    hostgroup <span class="built_in">INT</span>,</span><br><span class="line">    srv_host VARCHAR,</span><br><span class="line">    srv_port <span class="built_in">INT</span>,</span><br><span class="line">    status VARCHAR,</span><br><span class="line">    ConnUsed <span class="built_in">INT</span>,</span><br><span class="line">    ConnFree <span class="built_in">INT</span>,</span><br><span class="line">    ConnOK <span class="built_in">INT</span>,</span><br><span class="line">    ConnERR <span class="built_in">INT</span>,</span><br><span class="line">    Queries <span class="built_in">INT</span>,</span><br><span class="line">    Bytes_data_sent <span class="built_in">INT</span>,</span><br><span class="line">    Bytes_data_recv <span class="built_in">INT</span>,</span><br><span class="line">    Latency_us <span class="built_in">INT</span>)</span><br><span class="line"><span class="number">1</span> <span class="built_in">row</span> in set (<span class="number">0.00</span> <span class="built_in">sec</span>)</span><br><span class="line"></span><br><span class="line">MySQL [stats] <span class="symbol">15:20</span><span class="symbol">:08</span> &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>hostgroup：后端服务器所属的主机组，单个后端服务器可以属于多个主机组。  </p>
</li>
<li>srv_host,srv_port：mysqld后端服务器正在侦听连接的TCP端点的IP和Port。  </li>
<li>status：后端服务器的状态。可以有ONLINE，SHUNNED，OFFLINE_SOFT，OFFLINE_HARD。  </li>
<li>ConnUsed：ProxySQL当前使用多少个连接来向后端服务器发送查询。  </li>
<li>ConnFree：目前有多少个连接是空闲。  </li>
<li>ConnOK：成功建立了多少个连接。</li>
<li>ConnERR：没有成功建立多少个连接。</li>
<li>Queries：路由到此特定后端服务器的查询数。</li>
<li>Bytes_data_sent：发送到后端的数据量。</li>
<li>Bytes_data_recv：从后端接收的数据量。</li>
<li><p>Latency_ms：从Monitor报告的当前ping以毫秒为单位的延迟时间。</p>
<h5 id="stats-mysql-global表"><a href="#stats-mysql-global表" class="headerlink" title="stats_mysql_global表"></a>stats_mysql_global表</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:20:08 &gt; show create table stats.stats<span class="emphasis">_mysql_</span>global\G          </span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line"><span class="code">       table: stats_mysql_global</span></span><br><span class="line">Create Table: CREATE TABLE stats<span class="emphasis">_mysql_</span>global (</span><br><span class="line"><span class="code">    Variable_Name VARCHAR NOT NULL PRIMARY KEY,</span></span><br><span class="line"><span class="code">    Variable_Value VARCHAR NOT NULL)</span></span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:22:35 &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Variable_Name：代表与MySQL相关的代理级别的全局统计<br>如Client_Connections_aborted：由于无效凭据或max_connections而导致的前端连接数已达到；<br>如Client_Connections_connected：当前连接的前端连接数。<br>如Client_Connections_created：到目前为止创建的前端连接数。等等。</p>
</li>
<li><p>Variable_Value：统计所对应的值。  </p>
<h5 id="stats-mysql-processlist表"><a href="#stats-mysql-processlist表" class="headerlink" title="stats_mysql_processlist表"></a>stats_mysql_processlist表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:24:11 &gt; show create table stats.stats_mysql_processlist\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: stats_mysql_processlist</span><br><span class="line">Create Table: CREATE TABLE stats_mysql_processlist (</span><br><span class="line">    ThreadID INT <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    SessionID INTEGER PRIMARY KEY,</span><br><span class="line">   <span class="built_in"> user </span>VARCHAR,</span><br><span class="line">    db VARCHAR,</span><br><span class="line">    cli_host VARCHAR,</span><br><span class="line">    cli_port INT,</span><br><span class="line">    hostgroup INT,</span><br><span class="line">    l_srv_host VARCHAR,</span><br><span class="line">    l_srv_port INT,</span><br><span class="line">    srv_host VARCHAR,</span><br><span class="line">    srv_port INT,</span><br><span class="line">    command VARCHAR,</span><br><span class="line">    time_ms INT <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="builtin-name">info</span> VARCHAR)</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:26:43 &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>ThreadID：ProxySQL线程的内部ID。  </p>
</li>
<li>SessionID：ProxySQL会话ID，通过这个ID可以进行kill操作。</li>
<li>user：与MySQL客户端连接到ProxySQL的用户。</li>
<li>db：当前选择的数据库。</li>
<li>cli_host,cli_port：连接ProxySQL的IP和TCP端口。</li>
<li>hostgroup：当前主机组。如果正在处理查询，则是查询已被路由或将要路由的主机组，或默认主机组。可以通过这个查看该SQL到底是到哪个HG里。</li>
<li>l_srv_host,l_srv_port：ProxySQL的IP和TCP端口。</li>
<li>srv_host,srv_port：后端MySQL服务器的IP和端口。</li>
<li>command：正在执行的MySQL查询的类型。</li>
<li>time_ms：命令执行的时间(以毫秒为单位)。</li>
<li><p>info：正在执行的SQL。</p>
<h5 id="stats-mysql-query-digest表"><a href="#stats-mysql-query-digest表" class="headerlink" title="stats_mysql_query_digest表"></a>stats_mysql_query_digest表</h5><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:26:43 &gt; show <span class="keyword">create</span> table stats.stats_mysql_query_digest\G</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       table: stats_mysql_query_digest</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE stats_mysql_query_digest (</span><br><span class="line">    hostgroup INT,</span><br><span class="line">    schemaname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    username VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    digest VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    digest_text VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    count_star INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    first_seen INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    last_seen INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    sum_time INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    min_time INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    max_time INTEGER <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span>(hostgroup, schemaname, username, digest))</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] <span class="number">15</span>:<span class="number">29</span>:<span class="number">27</span> &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>hostgroup：发送查询的主机组。值-1表示查询查询缓存。</p>
</li>
<li>schemaname：查询的数据库。</li>
<li>user：连接ProxySQL的用户名。</li>
<li>digest：一个十六进制散列，表示其参数剥离的SQL。</li>
<li>digest_text：参数剥离的实际SQL文本</li>
<li>count_star：执行查询的总次数（参数的值不同）。</li>
<li>first_seen：unix时间戳，是通过代理路由查询的第一时刻。</li>
<li>last_seen：unix时间戳，当查询通过代理路由时的最后一刻（到目前为止）。</li>
<li>sum_time：执行此类查询的总时间（以微秒为单位）。<br>这对于确定应用程序工作负载中花费的最多时间在哪里是非常有用的，并为改进的地方提供了一个良好的起点。</li>
<li><p>min_time,max_time - 执行此类查询时期望的持续时间范围。<br>min_time是到目前为止所看到的最小执行时间，而max_time表示最大执行时间，以微秒为单位。</p>
<h5 id="stats-mysql-query-rules表"><a href="#stats-mysql-query-rules表" class="headerlink" title="stats_mysql_query_rules表"></a>stats_mysql_query_rules表</h5><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:29:27 &gt; show create table stats.stats<span class="emphasis">_mysql_</span>query_rules\G </span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line"><span class="code">       table: stats_mysql_query_rules</span></span><br><span class="line">Create Table: CREATE TABLE stats<span class="emphasis">_mysql_</span>query_rules (</span><br><span class="line"><span class="code">    rule_id INTEGER PRIMARY KEY,</span></span><br><span class="line"><span class="code">    hits INT NOT NULL)</span></span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:31:57 &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>rule_id：路由规则的ID与main.mysql_query_rules的id对应。</p>
</li>
<li>hits：此路由规则的匹配总数。 如果当前传入的查询符合规则，则会记录一次命中。<h4 id="monitor库"><a href="#monitor库" class="headerlink" title="monitor库"></a>monitor库</h4>对后端MySQL的健康检查，由变量mysql-monitor_enabled来确定是否开启Monitor模块。  <figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:35:32 &gt; show tables from monitor;                               </span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">| tables                             |</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">| mysql<span class="emphasis">_server_</span>connect               |</span><br><span class="line">| mysql<span class="emphasis">_server_</span>connect<span class="emphasis">_log           |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>server<span class="emphasis">_group_</span>replication<span class="emphasis">_log |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>server<span class="emphasis">_ping                  |</span></span><br><span class="line"><span class="emphasis">| mysql_</span>server<span class="emphasis">_ping_</span>log              |</span><br><span class="line">| mysql<span class="emphasis">_server_</span>read<span class="emphasis">_only_</span>log         |</span><br><span class="line">| mysql<span class="emphasis">_server_</span>replication<span class="emphasis">_lag_</span>log   |</span><br><span class="line"><span class="code">+------------------------------------+</span></span><br><span class="line">7 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:35:52 &gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="mysql-server-connect-mysql-server-connect-log表"><a href="#mysql-server-connect-mysql-server-connect-log表" class="headerlink" title="mysql_server_connect/mysql_server_connect_log表"></a>mysql_server_connect/mysql_server_connect_log表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:37:39 &gt; show create table monitor.mysql_server_connect\G  </span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_connect</span><br><span class="line">Create Table: CREATE TABLE mysql_server_connect (</span><br><span class="line">    hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_since INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    time_until INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_time_min INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_time_max INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_time_total INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_failure_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_failure_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_failure_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    PRIMARY KEY (hostname, port))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:37:46 &gt; show create table monitor.mysql_server_connect_log\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_connect_log</span><br><span class="line">Create Table: CREATE TABLE mysql_server_connect_log (</span><br><span class="line">    hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_start_us INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_success_time_us INT<span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    connect_error VARCHAR,</span><br><span class="line">    PRIMARY KEY (hostname, port, time_start_us))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:37:51 &gt;</span><br></pre></td></tr></table></figure>
<ul>
<li><p>连接到所有MySQL服务器以检查它们是否可用，该表用来存放检测连接的日志。由变量mysql-monitor_connect_interval来控制其检测的时间间隔，由参数mysql-monitor_connect_timeout控制连接是否超时（默认200毫秒）。</p>
<h5 id="mysql-server-ping-mysql-server-ping-log表"><a href="#mysql-server-ping-mysql-server-ping-log表" class="headerlink" title="mysql_server_ping/mysql_server_ping_log表"></a>mysql_server_ping/mysql_server_ping_log表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:39:23 &gt; show create table monitor.mysql_server_ping\G       </span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_ping</span><br><span class="line">Create Table: CREATE TABLE mysql_server_ping (</span><br><span class="line">    hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_since INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    time_until INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0, ping_success_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_time_min INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_time_max INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_time_total INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_failure_count INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_failure_first INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_failure_last INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    PRIMARY KEY (hostname, port))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:40:12 &gt; show create table monitor.mysql_server_ping_log\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_ping_log</span><br><span class="line">Create Table: CREATE TABLE mysql_server_ping_log (</span><br><span class="line">     hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_start_us INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_success_time_us INT<span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    ping_error VARCHAR,</span><br><span class="line">    PRIMARY KEY (hostname, port, time_start_us))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:40:15 &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用mysql_ping API ping后端MySQL服务器检查它们是否可用，该表用来存放ping的日志。由变量mysql-monitor_ping_interval控制ping的时间间隔，默认值：10000（毫秒，相当于10秒）。</p>
<h5 id="mysql-server-replication-lag-log表"><a href="#mysql-server-replication-lag-log表" class="headerlink" title="mysql_server_replication_lag_log表"></a>mysql_server_replication_lag_log表</h5><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MySQL [stats] 15:40:53 &gt; show create table monitor.mysql_server_replication_lag_log\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       table: mysql_server_replication_lag_log</span><br><span class="line">Create Table: CREATE TABLE mysql_server_replication_lag_log (</span><br><span class="line">     hostname VARCHAR <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">   <span class="built_in"> port </span>INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>3306,</span><br><span class="line">    time_start_us INT <span class="keyword">NOT</span> <span class="literal">NULL</span><span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    success_time_us INT<span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    repl_lag INT<span class="built_in"> DEFAULT </span>0,</span><br><span class="line">    <span class="builtin-name">error</span> VARCHAR,</span><br><span class="line">    PRIMARY KEY (hostname, port, time_start_us))</span><br><span class="line">1 row <span class="keyword">in</span> <span class="builtin-name">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [stats] 15:41:12 &gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p>后端MySQL服务主从延迟的检测。由参数mysql-monitor_replication_lag_interval控制检测间隔时间， 如果复制滞后太大，可以暂时关闭从。由mysql_servers.max_replication_lag列控制。默认值：10000（毫秒，相当于10秒）。</p>
</li>
</ul>
<h4 id="内置参数"><a href="#内置参数" class="headerlink" title="内置参数"></a>内置参数</h4><p>global_variables 1.4版本中有95个参数，参数较多，解释请参考<a href="https://github.com/sysown/proxysql/wiki/Global-variables" target="_blank" rel="noopener">文档</a>。<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 11:16:22 &gt; show variables;</span><br><span class="line">+-----------------------------------------------------+--------------------+</span><br><span class="line">|<span class="string"> Variable_name                                       </span>|<span class="string"> Value              </span>|</span><br><span class="line">+-----------------------------------------------------+--------------------+</span><br><span class="line">|<span class="string"> admin-admin_credentials                             </span>|<span class="string"> admin:admin        </span>|</span><br><span class="line">|<span class="string"> admin-cluster_check_interval_ms                     </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> admin-cluster_password                              </span>|<span class="string">                    </span>|</span><br><span class="line">|<span class="string"> admin-cluster_username                              </span>|<span class="string">                    </span>|</span><br><span class="line">|<span class="string"> admin-hash_passwords                                </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> admin-mysql_ifaces                                  </span>|<span class="string"> 0.0.0.0:6032       </span>|</span><br><span class="line">|<span class="string"> admin-read_only                                     </span>|<span class="string"> false              </span>|</span><br><span class="line">|<span class="string"> admin-refresh_interval                              </span>|<span class="string"> 2000               </span>|</span><br><span class="line">|<span class="string"> admin-stats_credentials                             </span>|<span class="string"> stats:stats        </span>|</span><br><span class="line">|<span class="string"> admin-telnet_admin_ifaces                           </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> admin-telnet_stats_ifaces                           </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> admin-version                                       </span>|<span class="string"> 1.4.1-45-gab4e6ee  </span>|</span><br><span class="line">|<span class="string"> mysql-client_found_rows                             </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-commands_stats                                </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-connect_retries_delay                         </span>|<span class="string"> 1                  </span>|</span><br><span class="line">|<span class="string"> mysql-connect_retries_on_failure                    </span>|<span class="string"> 10                 </span>|</span><br><span class="line">|<span class="string"> mysql-connect_timeout_server                        </span>|<span class="string"> 3000               </span>|</span><br><span class="line">|<span class="string"> mysql-connect_timeout_server_max                    </span>|<span class="string"> 10000              </span>|</span><br><span class="line">|<span class="string"> mysql-connection_delay_multiplex_ms                 </span>|<span class="string"> 0                  </span>|</span><br><span class="line">|<span class="string"> mysql-connection_max_age_ms                         </span>|<span class="string"> 0                  </span>|</span><br><span class="line">|<span class="string"> mysql-default_charset                               </span>|<span class="string"> utf8               </span>|</span><br><span class="line">|<span class="string"> mysql-default_max_latency_ms                        </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-default_query_delay                           </span>|<span class="string"> 0                  </span>|</span><br><span class="line">|<span class="string"> mysql-default_query_timeout                         </span>|<span class="string"> 36000000           </span>|</span><br><span class="line">|<span class="string"> mysql-default_reconnect                             </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-default_schema                                </span>|<span class="string"> information_schema </span>|</span><br><span class="line">|<span class="string"> mysql-default_sql_mode                              </span>|<span class="string">                    </span>|</span><br><span class="line">|<span class="string"> mysql-default_time_zone                             </span>|<span class="string"> SYSTEM             </span>|</span><br><span class="line">|<span class="string"> mysql-enforce_autocommit_on_reads                   </span>|<span class="string"> false              </span>|</span><br><span class="line">|<span class="string"> mysql-eventslog_filename                            </span>|<span class="string">                    </span>|</span><br><span class="line">|<span class="string"> mysql-eventslog_filesize                            </span>|<span class="string"> 104857600          </span>|</span><br><span class="line">|<span class="string"> mysql-forward_autocommit                            </span>|<span class="string"> false              </span>|</span><br><span class="line">|<span class="string"> mysql-free_connections_pct                          </span>|<span class="string"> 10                 </span>|</span><br><span class="line">|<span class="string"> mysql-have_compress                                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-hostgroup_manager_verbose                     </span>|<span class="string"> 1                  </span>|</span><br><span class="line">|<span class="string"> mysql-init_connect                                  </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-interfaces                                    </span>|<span class="string"> 0.0.0.0:6033       </span>|</span><br><span class="line">|<span class="string"> mysql-long_query_time                               </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-max_allowed_packet                            </span>|<span class="string"> 4194304            </span>|</span><br><span class="line">|<span class="string"> mysql-max_connections                               </span>|<span class="string"> 2048               </span>|</span><br><span class="line">|<span class="string"> mysql-max_stmts_cache                               </span>|<span class="string"> 10000              </span>|</span><br><span class="line">|<span class="string"> mysql-max_stmts_per_connection                      </span>|<span class="string"> 20                 </span>|</span><br><span class="line">|<span class="string"> mysql-max_transaction_time                          </span>|<span class="string"> 14400000           </span>|</span><br><span class="line">|<span class="string"> mysql-mirror_max_concurrency                        </span>|<span class="string"> 16                 </span>|</span><br><span class="line">|<span class="string"> mysql-mirror_max_queue_length                       </span>|<span class="string"> 32000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_connect_interval                      </span>|<span class="string"> 60000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_connect_timeout                       </span>|<span class="string"> 600                </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_enabled                               </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_groupreplication_healthcheck_interval </span>|<span class="string"> 5000               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_groupreplication_healthcheck_timeout  </span>|<span class="string"> 800                </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_history                               </span>|<span class="string"> 600000             </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_password                              </span>|<span class="string"> monitor            </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_ping_interval                         </span>|<span class="string"> 10000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_ping_max_failures                     </span>|<span class="string"> 3                  </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_ping_timeout                          </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_query_interval                        </span>|<span class="string"> 60000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_query_timeout                         </span>|<span class="string"> 100                </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_read_only_interval                    </span>|<span class="string"> 1500               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_read_only_timeout                     </span>|<span class="string"> 500                </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_replication_lag_interval              </span>|<span class="string"> 10000              </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_replication_lag_timeout               </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_slave_lag_when_null                   </span>|<span class="string"> 60                 </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_username                              </span>|<span class="string"> monitor            </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_wait_timeout                          </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-monitor_writer_is_also_reader                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-multiplexing                                  </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-ping_interval_server_msec                     </span>|<span class="string"> 120000             </span>|</span><br><span class="line">|<span class="string"> mysql-ping_timeout_server                           </span>|<span class="string"> 500                </span>|</span><br><span class="line">|<span class="string"> mysql-poll_timeout                                  </span>|<span class="string"> 2000               </span>|</span><br><span class="line">|<span class="string"> mysql-poll_timeout_on_failure                       </span>|<span class="string"> 100                </span>|</span><br><span class="line">|<span class="string"> mysql-query_cache_size_MB                           </span>|<span class="string"> 256                </span>|</span><br><span class="line">|<span class="string"> mysql-query_digests                                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-query_digests_lowercase                       </span>|<span class="string"> false              </span>|</span><br><span class="line">|<span class="string"> mysql-query_digests_max_digest_length               </span>|<span class="string"> 2048               </span>|</span><br><span class="line">|<span class="string"> mysql-query_digests_max_query_length                </span>|<span class="string"> 65000              </span>|</span><br><span class="line">|<span class="string"> mysql-query_processor_iterations                    </span>|<span class="string"> 0                  </span>|</span><br><span class="line">|<span class="string"> mysql-query_processor_regex                         </span>|<span class="string"> 1                  </span>|</span><br><span class="line">|<span class="string"> mysql-query_retries_on_failure                      </span>|<span class="string"> 1                  </span>|</span><br><span class="line">|<span class="string"> mysql-server_capabilities                           </span>|<span class="string"> 45578              </span>|</span><br><span class="line">|<span class="string"> mysql-server_version                                </span>|<span class="string"> 5.5.30             </span>|</span><br><span class="line">|<span class="string"> mysql-servers_stats                                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-session_idle_ms                               </span>|<span class="string"> 1000               </span>|</span><br><span class="line">|<span class="string"> mysql-session_idle_show_processlist                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-sessions_sort                                 </span>|<span class="string"> true               </span>|</span><br><span class="line">|<span class="string"> mysql-shun_on_failures                              </span>|<span class="string"> 5                  </span>|</span><br><span class="line">|<span class="string"> mysql-shun_recovery_time_sec                        </span>|<span class="string"> 10                 </span>|</span><br><span class="line">|<span class="string"> mysql-ssl_p2s_ca                                    </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-ssl_p2s_cert                                  </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-ssl_p2s_cipher                                </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-ssl_p2s_key                                   </span>|<span class="string"> (null)             </span>|</span><br><span class="line">|<span class="string"> mysql-stacksize                                     </span>|<span class="string"> 1048576            </span>|</span><br><span class="line">|<span class="string"> mysql-threads                                       </span>|<span class="string"> 4                  </span>|</span><br><span class="line">|<span class="string"> mysql-threshold_query_length                        </span>|<span class="string"> 524288             </span>|</span><br><span class="line">|<span class="string"> mysql-threshold_resultset_size                      </span>|<span class="string"> 4194304            </span>|</span><br><span class="line">|<span class="string"> mysql-wait_timeout                                  </span>|<span class="string"> 28800000           </span>|</span><br><span class="line">+-----------------------------------------------------+--------------------+</span><br><span class="line">95 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 11:16:33 &gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="ProxySQL多层配置设计"><a href="#ProxySQL多层配置设计" class="headerlink" title="ProxySQL多层配置设计"></a>ProxySQL多层配置设计</h3><h4 id="ProxySQL设计模型介绍"><a href="#ProxySQL设计模型介绍" class="headerlink" title="ProxySQL设计模型介绍"></a>ProxySQL设计模型介绍</h4><p>ProxySQL使用多层配置系统，适合满足以下需求：  </p>
<ul>
<li>允许自动更新配置，与MySQL兼容管理界面；  </li>
<li>允许在线修改配置，不用重启ProxySQL；  </li>
<li><p>允许回滚配置；<br>多层配置系统的实现，如下图：  </p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">+-------------------------+</span><br><span class="line">|<span class="string">         RUNTIME         </span>|</span><br><span class="line">+-------------------------+</span><br><span class="line">       /|<span class="string">\          </span>|</span><br><span class="line">        |<span class="string">           </span>|</span><br><span class="line">    [1] |<span class="string">       [2] </span>|</span><br><span class="line">        |<span class="string">          \</span>|<span class="string">/</span></span><br><span class="line"><span class="string">+-------------------------+</span></span><br><span class="line">|<span class="string">         MEMORY          </span>|</span><br><span class="line">+-------------------------+ _</span><br><span class="line">       /|<span class="string">\          </span>|<span class="string">      </span>|<span class="string">\</span></span><br><span class="line"><span class="string">        </span>|<span class="string">           </span>|<span class="string">        \</span></span><br><span class="line"><span class="string">    [3] </span>|<span class="string">       [4] </span>|<span class="string">         \ [5]</span></span><br><span class="line"><span class="string">        </span>|<span class="string">          \</span>|<span class="string">/         \</span></span><br><span class="line"><span class="string">+-------------------------+  +-------------------------+</span></span><br><span class="line">|<span class="string">          DISK           </span>|<span class="string">  </span>|<span class="string">       CONFIG FILE       </span>|</span><br><span class="line">+-------------------------+  +-------------------------+</span><br></pre></td></tr></table></figure>
</li>
<li><p>RUNTIME代表ProxySQL当前生效的配置，包括global_variables、mysql_servers、mysql_users、mysql_query_rules。无法直接修改这里的配置，必须要从下一层load过来。  </p>
</li>
<li><p>MEMORY(main)代表平时在mysql命令行修改的main里的配置，可以认为是SQLite数据库在内存的镜像。可修改以下：    </p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mysql_server</span>        后端服务器列表</span><br><span class="line">mysql_users         连接到ProxySQL的用户列表及其凭据 </span><br><span class="line">mysql_query_rules   将流量路由到不同的后端服务器的规则列表</span><br><span class="line">global_variables    全局变量列表</span><br><span class="line">mysql_collat        MySQL排序规则列表</span><br></pre></td></tr></table></figure>
</li>
<li><p>DISK和CONFIG FILE表示磁盘上SQLite数据库，默认位置在$datadir/proxysql.db，在重新启动过程中，内存中未被保存的配置将丢失。/etc/proxysql.cnf文件只在第一次初始化的时候用到。如要修改端口，还是需要在管理命令行里修改，再save到磁盘。  </p>
<h5 id="ProxySQL多层配置修改示例"><a href="#ProxySQL多层配置修改示例" class="headerlink" title="ProxySQL多层配置修改示例"></a>ProxySQL多层配置修改示例</h5></li>
<li><p>mysql users</p>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> RUNTIME / LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> MEMORY</span><br><span class="line">SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> MEMORY / SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> RUNTIME</span><br><span class="line">LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> MEMORY / LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> DISK</span><br><span class="line">SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">TO</span> DISK /  SAVE MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> MEMORY</span><br><span class="line">LOAD MYSQL<span class="built_in"> USERS </span><span class="keyword">FROM</span> CONFIG</span><br></pre></td></tr></table></figure>
</li>
<li><p>mysql servers </p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">LOAD</span> MYSQL SERVERS <span class="keyword">TO</span> RUNTIME   让修改的配置生效</span><br><span class="line"><span class="keyword">SAVE</span> MYSQL SERVERS <span class="keyword">TO</span> <span class="keyword">MEMORY</span></span><br><span class="line"><span class="keyword">LOAD</span> MYSQL SERVERS <span class="keyword">TO</span> <span class="keyword">MEMORY</span></span><br><span class="line"><span class="keyword">SAVE</span> MYSQL SERVERS <span class="keyword">TO</span> DISK      将修改的配置持久化</span><br><span class="line"><span class="keyword">LOAD</span> MYSQL SERVERS <span class="keyword">FROM</span> CONFIG</span><br></pre></td></tr></table></figure>
</li>
<li><p>mysql query rules</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> run</span><br><span class="line"><span class="keyword">save</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> mem</span><br><span class="line"><span class="keyword">load</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> mem</span><br><span class="line"><span class="keyword">save</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">to</span> disk</span><br><span class="line"><span class="keyword">load</span> mysql <span class="keyword">query</span> <span class="keyword">rules</span> <span class="keyword">from</span> config</span><br></pre></td></tr></table></figure>
</li>
<li><p>mysql variables</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> runtime</span><br><span class="line"><span class="keyword">save</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></span><br><span class="line"><span class="keyword">load</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></span><br><span class="line"><span class="keyword">save</span> mysql <span class="keyword">variables</span> <span class="keyword">to</span> disk</span><br><span class="line"><span class="keyword">load</span> mysql <span class="keyword">variables</span> <span class="keyword">from</span> config</span><br></pre></td></tr></table></figure>
</li>
<li><p>admin variables</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">load</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> runtime</span><br><span class="line"><span class="keyword">save</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></span><br><span class="line"><span class="keyword">load</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> <span class="keyword">memory</span></span><br><span class="line"><span class="keyword">save</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">to</span> disk</span><br><span class="line"><span class="keyword">load</span> <span class="keyword">admin</span> <span class="keyword">variables</span> <span class="keyword">from</span> config</span><br></pre></td></tr></table></figure>
</li>
<li><p>参考</p>
</li>
<li><a href="https://github.com/sysown/proxysql/wiki/Multi-layer-configuration-system" target="_blank" rel="noopener">https://github.com/sysown/proxysql/wiki/Multi-layer-configuration-system</a></li>
<li><a href="https://severalnines.com/blog/mysql-load-balancing-proxysql-overview" target="_blank" rel="noopener">https://severalnines.com/blog/mysql-load-balancing-proxysql-overview</a></li>
<li><a href="http://seanlook.com/2017/04/10/mysql-proxysql-install-config/" target="_blank" rel="noopener">http://seanlook.com/2017/04/10/mysql-proxysql-install-config/</a></li>
</ul>
<h2 id="ProxySQL读写分离示例"><a href="#ProxySQL读写分离示例" class="headerlink" title="ProxySQL读写分离示例"></a>ProxySQL读写分离示例</h2><h3 id="准备-1"><a href="#准备-1" class="headerlink" title="准备"></a>准备</h3><p>Master:118.190.67.67:3306<br>Slave :139.196.95.103:3306(192.168.7.50)<br>ProxySQL：139.196.95.103:3306(192.168.7.50)<br>版本：percona-server 5.7.18  </p>
<h3 id="安装配置"><a href="#安装配置" class="headerlink" title="安装配置"></a>安装配置</h3><p>主从安装配置省略。  </p>
<h3 id="示例目标"><a href="#示例目标" class="headerlink" title="示例目标"></a>示例目标</h3><p>客户端通过访问ProxySQL的ip，实际访问Master和Slave的效果。  </p>
<h3 id="添加后端DB服务"><a href="#添加后端DB服务" class="headerlink" title="添加后端DB服务"></a>添加后端DB服务</h3><p>100是主库，101是从库，同时主库也处理1/10的读请求，登录ProxySQL管理端设置：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[(none)]</span> <span class="selector-tag">14</span><span class="selector-pseudo">:22</span><span class="selector-pseudo">:06</span> &gt; <span class="selector-tag">insert</span> <span class="selector-tag">into</span> <span class="selector-tag">mysql_servers</span>(hostgroup_id,hostname,port,weight,comment) <span class="selector-tag">values</span>(<span class="number">100</span>, <span class="string">'118.190.67.67'</span>, <span class="number">3306</span>, <span class="number">1</span>, <span class="string">'db0,ReadWrite'</span>),(<span class="number">101</span>, <span class="string">'192.168.7.50'</span>, <span class="number">3306</span>, <span class="number">9</span>, <span class="string">'db0,ReadOnly'</span>);</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">2</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="添加访问用户"><a href="#添加访问用户" class="headerlink" title="添加访问用户"></a>添加访问用户</h3><p>登录Master主库设置监控用户和程序用户(由于是测试使用，权限较大，主机允许所有)：<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 15:51:32 &gt; <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">'monitor'</span>@<span class="string">'%'</span> identified <span class="keyword">by</span> <span class="string">'monitor'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:51:37 &gt; grant <span class="keyword">select</span>,super,process,<span class="keyword">show</span> databases,replication client,replication slave <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'monitor'</span>@<span class="string">'%'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:45:23 &gt; <span class="keyword">create</span> <span class="keyword">user</span> <span class="string">'user0'</span>@<span class="string">'%'</span> identified <span class="keyword">by</span> <span class="string">'password0'</span>;                   </span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:49:42 &gt; GRANT <span class="keyword">SELECT</span>, RELOAD, PROCESS, <span class="keyword">SHOW</span> DATABASES, SUPER, LOCK TABLES, <span class="keyword">EXECUTE</span>, <span class="keyword">SHOW</span> <span class="keyword">VIEW</span>, <span class="keyword">TRIGGER</span>, EVENT <span class="keyword">ON</span> *.* <span class="keyword">TO</span> <span class="string">'read0'</span>@<span class="string">'%'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>登录ProxySQL管理端设置：<br>这里default_hostgroup指定了hostgroup为100的主库，下文会设置SELECT …FOR UPDATE规则到100，SELECT到101，其他所有的SQL到default_hostgroup，也就是主库。<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[(none)]</span> <span class="selector-tag">14</span><span class="selector-pseudo">:22</span><span class="selector-pseudo">:15</span> &gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">mysql_users</span> (username, password, active, default_hostgroup, max_connections) <span class="selector-tag">VALUES</span> (<span class="string">'user0'</span>, <span class="string">'password0'</span>, <span class="number">1</span>, <span class="number">100</span>, <span class="number">1000</span>); </span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">2</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="添加复制关系"><a href="#添加复制关系" class="headerlink" title="添加复制关系"></a>添加复制关系</h3><p>登录ProxySQL管理端设置：<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">MySQL [main] 17:32:46 &gt; INSERT INTO mysql_replication_hostgroups VALUES(100,101,'db0');</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 17:33:30 &gt; load mysql variables to runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 17:33:54 &gt; save mysql variables to disk;</span><br><span class="line">Query OK, 83 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [main] 17:35:53 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_read_only_log ORDER BY time_start_us DESC LIMIT 10;</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> success_time_us </span>|<span class="string"> read_only </span>|<span class="string"> error </span>|</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085770195146 </span>|<span class="string"> 630             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085770194710 </span>|<span class="string"> 23722           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085768695087 </span>|<span class="string"> 650             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085768694620 </span>|<span class="string"> 23706           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085767194957 </span>|<span class="string"> 628             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085767194507 </span>|<span class="string"> 23686           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085765694834 </span>|<span class="string"> 634             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085765694387 </span>|<span class="string"> 23669           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085764194744 </span>|<span class="string"> 641             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504085764194301 </span>|<span class="string"> 23729           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="修改全局变量"><a href="#修改全局变量" class="headerlink" title="修改全局变量"></a>修改全局变量</h3><p>登录ProxySQL管理端设置：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-query_retries_on_failure</span>=0;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-max_stmts_per_connection</span>=1000;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-eventslog_filename</span>=<span class="string">'queries.log'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_slave_lag_when_null</span>=7200;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-ping_timeout_server</span>=1500;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_connect_timeout</span>=1000;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-default_max_latency_ms</span>=2000;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_username</span>=<span class="string">'monitor'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-monitor_password</span>=<span class="string">'monitor'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:07 &gt; <span class="builtin-name">set</span> <span class="attribute">mysql-server_version</span>=<span class="string">'5.7.18'</span>;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>全局变量生效并保存到磁盘：<br>登录ProxySQL管理端设置：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 14:25:07 &gt; load mysql<span class="built_in"> users </span><span class="keyword">to</span> runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:27 &gt; load mysql servers <span class="keyword">to</span> runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:27 &gt; load mysql variables <span class="keyword">to</span> runtime;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:28 &gt; save mysql<span class="built_in"> users </span><span class="keyword">to</span> disk;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:36 &gt; save mysql servers <span class="keyword">to</span> disk;</span><br><span class="line">save mysql variables <span class="keyword">to</span> disk;Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:37 &gt; save mysql variables <span class="keyword">to</span> disk;</span><br><span class="line">Query OK, 83 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 14:25:37 &gt; save mysql<span class="built_in"> users </span><span class="keyword">to</span> mem;  -- 可以屏蔽看到的明文密码</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="路由规则"><a href="#路由规则" class="headerlink" title="路由规则"></a>路由规则</h3><ul>
<li>ProxySQL使用查询规则来确定路由，如果没有规则用于查询，默认会访问hostgroup 0主机组，会报以下错误：<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie ~]# mysql -uuser0 -ppassword0 -h 127.0.0.1 -P6033 -e <span class="string">"SELECT 1"</span></span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line"><span class="builtin-name">ERROR</span> 9001 (HY000) at line 1: Max connect timeout reached <span class="keyword">while</span> reaching hostgroup 1 after 2000ms</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>设置路由规则：<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[(none)]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:14</span> &gt; <span class="selector-tag">use</span> <span class="selector-tag">main</span>;</span><br><span class="line"><span class="selector-tag">Database</span> <span class="selector-tag">changed</span></span><br><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:15</span> &gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">mysql_query_rules</span> (active, match_pattern, destination_hostgroup, cache_ttl) <span class="selector-tag">VALUES</span> (<span class="number">1</span>, <span class="string">'^SELECT .* FOR UPDATE'</span>, <span class="number">100</span>, NULL);</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">1</span> <span class="selector-tag">row</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:17</span> &gt; <span class="selector-tag">INSERT</span> <span class="selector-tag">INTO</span> <span class="selector-tag">mysql_query_rules</span> (active, match_pattern, destination_hostgroup, cache_ttl) <span class="selector-tag">VALUES</span> (<span class="number">1</span>, <span class="string">'^SELECT .*'</span>, <span class="number">101</span>, NULL);</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">1</span> <span class="selector-tag">row</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:18</span> &gt; <span class="selector-tag">load</span> <span class="selector-tag">mysql</span> <span class="selector-tag">query</span> <span class="selector-tag">rules</span> <span class="selector-tag">to</span> <span class="selector-tag">run</span>;</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">0</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">MySQL</span> <span class="selector-attr">[main]</span> <span class="selector-tag">09</span><span class="selector-pseudo">:29</span><span class="selector-pseudo">:56</span> &gt; <span class="selector-tag">save</span> <span class="selector-tag">mysql</span> <span class="selector-tag">query</span> <span class="selector-tag">rules</span> <span class="selector-tag">to</span> <span class="selector-tag">disk</span>;</span><br><span class="line"><span class="selector-tag">Query</span> <span class="selector-tag">OK</span>, <span class="selector-tag">0</span> <span class="selector-tag">rows</span> <span class="selector-tag">affected</span> (<span class="number">0.03</span> sec)</span><br></pre></td></tr></table></figure></p>
<h3 id="常用查询"><a href="#常用查询" class="headerlink" title="常用查询"></a>常用查询</h3><ul>
<li><p>查询连接日志：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:45:08 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_connect_log ORDER BY time_start_us DESC LIMIT 10;</span><br><span class="line">+---------------+------+------------------+-------------------------+---------------+</span><br><span class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> connect_success_time_us </span>|<span class="string"> connect_error </span>|</span><br><span class="line">+---------------+------+------------------+-------------------------+---------------+</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590343795072 </span>|<span class="string"> 410                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590343780010 </span>|<span class="string"> 69662                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590283795083 </span>|<span class="string"> 521                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590283779977 </span>|<span class="string"> 68310                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590223794987 </span>|<span class="string"> 533                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590223779913 </span>|<span class="string"> 53220                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590163794887 </span>|<span class="string"> 497                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590163779772 </span>|<span class="string"> 71389                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590103794788 </span>|<span class="string"> 487                     </span>|<span class="string"> NULL          </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590103779728 </span>|<span class="string"> 68372                   </span>|<span class="string"> NULL          </span>|</span><br><span class="line">+---------------+------+------------------+-------------------------+---------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询ping日志：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:46:22 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_ping_log ORDER BY time_start_us DESC LIMIT 10;</span><br><span class="line">+---------------+------+------------------+----------------------+------------+</span><br><span class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> ping_success_time_us </span>|<span class="string"> ping_error </span>|</span><br><span class="line">+---------------+------+------------------+----------------------+------------+</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590413773092 </span>|<span class="string"> 100                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590413770521 </span>|<span class="string"> 23105                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590403773088 </span>|<span class="string"> 168                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590403770479 </span>|<span class="string"> 23080                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590393772977 </span>|<span class="string"> 135                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590393770364 </span>|<span class="string"> 23078                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590383772899 </span>|<span class="string"> 138                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590383770309 </span>|<span class="string"> 23205                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590373772885 </span>|<span class="string"> 102                  </span>|<span class="string"> NULL       </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590373770291 </span>|<span class="string"> 23099                </span>|<span class="string"> NULL       </span>|</span><br><span class="line">+---------------+------+------------------+----------------------+------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询后端DB状态</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] <span class="number">13</span>:<span class="number">46</span>:<span class="number">55</span> &gt; SELECT * FROM mysql_servers;</span><br><span class="line">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+</span><br><span class="line">| <span class="type">hostgroup_id</span> | <span class="type">hostname</span>      | <span class="type">port</span> | <span class="type">status</span> | <span class="type">weight</span> | <span class="type">compression</span> | <span class="type">max_connections</span> | <span class="type">max_replication_lag</span> | <span class="type">use_ssl</span> | <span class="type">max_latency_ms</span> | <span class="type">comment</span>       |<span class="type"></span></span><br><span class="line"><span class="type">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+</span></span><br><span class="line"><span class="type">| 100</span>          | <span class="type">118</span><span class="number">.190</span><span class="number">.67</span><span class="number">.67</span> | <span class="type">3306</span> | <span class="type">ONLINE</span> | <span class="type">1</span>      | <span class="type">0</span>           | <span class="type">1000</span>            | <span class="type">0</span>                   | <span class="type">0</span>       | <span class="type">0</span>              | <span class="type">db0</span>,ReadWrite |<span class="type"></span></span><br><span class="line"><span class="type">| 101</span>          | <span class="type">192</span><span class="number">.168</span><span class="number">.7</span><span class="number">.50</span>  | <span class="type">3306</span> | <span class="type">ONLINE</span> | <span class="type">9</span>      | <span class="type">0</span>           | <span class="type">1000</span>            | <span class="type">0</span>                   | <span class="type">0</span>       | <span class="type">0</span>              | <span class="type">db0</span>,ReadOnly  |<span class="type"></span></span><br><span class="line"><span class="type">+--------------+---------------+------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------+</span></span><br><span class="line"><span class="type">2</span> rows <span class="built_in">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询监控状态：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:47:56 &gt; SELECT <span class="symbol">*</span> FROM monitor.mysql_server_read_only_log ORDER BY time_start_us DESC LIMIT 10;   </span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">|<span class="string"> hostname      </span>|<span class="string"> port </span>|<span class="string"> time_start_us    </span>|<span class="string"> success_time_us </span>|<span class="string"> read_only </span>|<span class="string"> error </span>|</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590524103828 </span>|<span class="string"> 577             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590524103406 </span>|<span class="string"> 23499           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590522603717 </span>|<span class="string"> 646             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590522603268 </span>|<span class="string"> 23487           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590521103641 </span>|<span class="string"> 629             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590521103182 </span>|<span class="string"> 23497           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590519603662 </span>|<span class="string"> 639             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590519603201 </span>|<span class="string"> 23525           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 192.168.7.50  </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590518103492 </span>|<span class="string"> 618             </span>|<span class="string"> 1         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">|<span class="string"> 118.190.67.67 </span>|<span class="string"> 3306 </span>|<span class="string"> 1504590518103062 </span>|<span class="string"> 23508           </span>|<span class="string"> 0         </span>|<span class="string"> NULL  </span>|</span><br><span class="line">+---------------+------+------------------+-----------------+-----------+-------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询用户信息：</p>
<figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">MySQL [<span class="params">(none)</span>] 13<span class="function">:49</span><span class="function">:28</span> &gt;  SELECT * FROM mysql_users;   </span><br><span class="line">+<span class="params">----------</span>+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">-------------------</span>+<span class="params">----------------</span>+<span class="params">---------------</span>+<span class="params">------------------------</span>+<span class="params">--------------</span>+<span class="params">---------</span>+<span class="params">----------</span>+<span class="params">-----------------</span>+</span><br><span class="line">| username | password  | active | use_ssl | default_hostgroup | default_schema | schema_locked | transaction_persistent | fast_forward | backend | frontend | max_connections |</span><br><span class="line">+<span class="params">----------</span>+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">-------------------</span>+<span class="params">----------------</span>+<span class="params">---------------</span>+<span class="params">------------------------</span>+<span class="params">--------------</span>+<span class="params">---------</span>+<span class="params">----------</span>+<span class="params">-----------------</span>+</span><br><span class="line">| user0    | password0 | 1      | 0       | 100               | NULL           | 0             | 1                      | 0            | 1       | 1        | 1000            |</span><br><span class="line">+<span class="params">----------</span>+<span class="params">-----------</span>+<span class="params">--------</span>+<span class="params">---------</span>+<span class="params">-------------------</span>+<span class="params">----------------</span>+<span class="params">---------------</span>+<span class="params">------------------------</span>+<span class="params">--------------</span>+<span class="params">---------</span>+<span class="params">----------</span>+<span class="params">-----------------</span>+</span><br><span class="line">1 row in <span class="keyword">set</span> <span class="params">(0.00 sec)</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查询连接池：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] <span class="number">13</span>:<span class="number">51</span>:<span class="number">19</span> &gt; SELECT * FROM stats.stats_mysql_connection_pool;</span><br><span class="line">+-----------+---------------+----------+--------+----------+----------+--------+---------+---------+-----------------+-----------------+------------+</span><br><span class="line">| <span class="type">hostgroup</span> | <span class="type">srv_host</span>      | <span class="type">srv_port</span> | <span class="type">status</span> | <span class="type">ConnUsed</span> | <span class="type">ConnFree</span> | <span class="type">ConnOK</span> | <span class="type">ConnERR</span> | <span class="type">Queries</span> | <span class="type">Bytes_data_sent</span> | <span class="type">Bytes_data_recv</span> | <span class="type">Latency_us</span> |<span class="type"></span></span><br><span class="line"><span class="type">+-----------+---------------+----------+--------+----------+----------+--------+---------+---------+-----------------+-----------------+------------+</span></span><br><span class="line"><span class="type">| 100</span>       | <span class="type">118</span><span class="number">.190</span><span class="number">.67</span><span class="number">.67</span> | <span class="type">3306</span>     | <span class="type">ONLINE</span> | <span class="type">0</span>        | <span class="type">1</span>        | <span class="type">1</span>      | <span class="type">0</span>       | <span class="type">3</span>       | <span class="type">58</span>              | <span class="type">233</span>             | <span class="type">23059</span>      |<span class="type"></span></span><br><span class="line"><span class="type">| 101</span>       | <span class="type">192</span><span class="number">.168</span><span class="number">.7</span><span class="number">.50</span>  | <span class="type">3306</span>     | <span class="type">ONLINE</span> | <span class="type">0</span>        | <span class="type">1</span>        | <span class="type">3</span>      | <span class="type">88</span>      | <span class="type">5</span>       | <span class="type">106</span>             | <span class="type">360</span>             | <span class="type">102</span>        |<span class="type"></span></span><br><span class="line"><span class="type">+-----------+---------------+----------+--------+----------+----------+--------+---------+---------+-----------------+-----------------+------------+</span></span><br><span class="line"><span class="type">2</span> rows <span class="built_in">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询执行命令统计信息：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:51:47 &gt; SELECT <span class="symbol">*</span> FROM stats_mysql_commands_counters WHERE Total_cnt;</span><br><span class="line">+---------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</span><br><span class="line">|<span class="string"> Command </span>|<span class="string"> Total_Time_us </span>|<span class="string"> Total_cnt </span>|<span class="string"> cnt_100us </span>|<span class="string"> cnt_500us </span>|<span class="string"> cnt_1ms </span>|<span class="string"> cnt_5ms </span>|<span class="string"> cnt_10ms </span>|<span class="string"> cnt_50ms </span>|<span class="string"> cnt_100ms </span>|<span class="string"> cnt_500ms </span>|<span class="string"> cnt_1s </span>|<span class="string"> cnt_5s </span>|<span class="string"> cnt_10s </span>|<span class="string"> cnt_INFs </span>|</span><br><span class="line">+---------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</span><br><span class="line">|<span class="string"> SELECT  </span>|<span class="string"> 167664        </span>|<span class="string"> 27        </span>|<span class="string"> 15        </span>|<span class="string"> 4         </span>|<span class="string"> 0       </span>|<span class="string"> 6       </span>|<span class="string"> 0        </span>|<span class="string"> 1        </span>|<span class="string"> 0         </span>|<span class="string"> 1         </span>|<span class="string"> 0      </span>|<span class="string"> 0      </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> SET     </span>|<span class="string"> 0             </span>|<span class="string"> 2         </span>|<span class="string"> 2         </span>|<span class="string"> 0         </span>|<span class="string"> 0       </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0         </span>|<span class="string"> 0         </span>|<span class="string"> 0      </span>|<span class="string"> 0      </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> SHOW    </span>|<span class="string"> 13818         </span>|<span class="string"> 1         </span>|<span class="string"> 0         </span>|<span class="string"> 0         </span>|<span class="string"> 0       </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|<span class="string"> 1        </span>|<span class="string"> 0         </span>|<span class="string"> 0         </span>|<span class="string"> 0      </span>|<span class="string"> 0      </span>|<span class="string"> 0       </span>|<span class="string"> 0        </span>|</span><br><span class="line">+---------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询路由规则的详情：</p>
<figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 13:53:05 &gt; SELECT <span class="symbol">*</span> FROM stats_mysql_query_digest ORDER BY sum_time DESC;</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">|<span class="string"> hostgroup </span>|<span class="string"> schemaname         </span>|<span class="string"> username </span>|<span class="string"> digest             </span>|<span class="string"> digest_text                      </span>|<span class="string"> count_star </span>|<span class="string"> first_seen </span>|<span class="string"> last_seen  </span>|<span class="string"> sum_time </span>|<span class="string"> min_time </span>|<span class="string"> max_time </span>|</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0xA322907BCBC120DD </span>|<span class="string"> select * from tables limit ?     </span>|<span class="string"> 1          </span>|<span class="string"> 1504589288 </span>|<span class="string"> 1504589288 </span>|<span class="string"> 133826   </span>|<span class="string"> 133826   </span>|<span class="string"> 133826   </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x02033E45904D3DF0 </span>|<span class="string"> show databases                   </span>|<span class="string"> 1          </span>|<span class="string"> 1504589886 </span>|<span class="string"> 1504589886 </span>|<span class="string"> 13818    </span>|<span class="string"> 13818    </span>|<span class="string"> 13818    </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x3765930C7143F468 </span>|<span class="string"> select * from t1                 </span>|<span class="string"> 1          </span>|<span class="string"> 1504589311 </span>|<span class="string"> 1504589311 </span>|<span class="string"> 13466    </span>|<span class="string"> 13466    </span>|<span class="string"> 13466    </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0xA322907BCBC120DD </span>|<span class="string"> select * from tables limit ?     </span>|<span class="string"> 2          </span>|<span class="string"> 1504582304 </span>|<span class="string"> 1504583327 </span>|<span class="string"> 7325     </span>|<span class="string"> 3564     </span>|<span class="string"> 3761     </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x814EDBB68FBACD5D </span>|<span class="string"> select * from neworders limit ?  </span>|<span class="string"> 2          </span>|<span class="string"> 1504583184 </span>|<span class="string"> 1504583242 </span>|<span class="string"> 5959     </span>|<span class="string"> 2964     </span>|<span class="string"> 2995     </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x3765930C7143F468 </span>|<span class="string"> select * from t1                 </span>|<span class="string"> 3          </span>|<span class="string"> 1504583288 </span>|<span class="string"> 1504589859 </span>|<span class="string"> 3386     </span>|<span class="string"> 64       </span>|<span class="string"> 3056     </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0xA322907BCBC120DD </span>|<span class="string"> select * from tables limit ?     </span>|<span class="string"> 2          </span>|<span class="string"> 1504583168 </span>|<span class="string"> 1504583299 </span>|<span class="string"> 3095     </span>|<span class="string"> 117      </span>|<span class="string"> 2978     </span>|</span><br><span class="line">|<span class="string"> 101       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x620B328FE9D6D71A </span>|<span class="string"> SELECT DATABASE()                </span>|<span class="string"> 2          </span>|<span class="string"> 1504589729 </span>|<span class="string"> 1504589859 </span>|<span class="string"> 607      </span>|<span class="string"> 193      </span>|<span class="string"> 414      </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x226CD90D52A2BA0B </span>|<span class="string"> select @@version_comment limit ? </span>|<span class="string"> 8          </span>|<span class="string"> 1504582304 </span>|<span class="string"> 1504589886 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x52B8B04283B3A18D </span>|<span class="string"> set names utf8                   </span>|<span class="string"> 1          </span>|<span class="string"> 1504583162 </span>|<span class="string"> 1504583162 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> information_schema </span>|<span class="string"> user0    </span>|<span class="string"> 0x52B8B04283B3A18D </span>|<span class="string"> set names utf8                   </span>|<span class="string"> 1          </span>|<span class="string"> 1504582582 </span>|<span class="string"> 1504582582 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</span><br><span class="line">|<span class="string"> 100       </span>|<span class="string"> test               </span>|<span class="string"> user0    </span>|<span class="string"> 0x226CD90D52A2BA0B </span>|<span class="string"> select @@version_comment limit ? </span>|<span class="string"> 6          </span>|<span class="string"> 1504583162 </span>|<span class="string"> 1504583299 </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|<span class="string"> 0        </span>|</span><br><span class="line">+-----------+--------------------+----------+--------------------+----------------------------------+------------+------------+------------+----------+----------+----------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 13:55:46 &gt; SELECT hostgroup hg, sum_time, count_star, digest_text FROM stats_mysql_query_digest ORDER BY sum_time DESC;</span><br><span class="line">+-----+----------+------------+----------------------------------+</span><br><span class="line">|<span class="string"> hg  </span>|<span class="string"> sum_time </span>|<span class="string"> count_star </span>|<span class="string"> digest_text                      </span>|</span><br><span class="line">+-----+----------+------------+----------------------------------+</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 133826   </span>|<span class="string"> 1          </span>|<span class="string"> select * from tables limit ?     </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 13818    </span>|<span class="string"> 1          </span>|<span class="string"> show databases                   </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 13466    </span>|<span class="string"> 1          </span>|<span class="string"> select * from t1                 </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 7325     </span>|<span class="string"> 2          </span>|<span class="string"> select * from tables limit ?     </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 5959     </span>|<span class="string"> 2          </span>|<span class="string"> select * from neworders limit ?  </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 3386     </span>|<span class="string"> 3          </span>|<span class="string"> select * from t1                 </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 3095     </span>|<span class="string"> 2          </span>|<span class="string"> select * from tables limit ?     </span>|</span><br><span class="line">|<span class="string"> 101 </span>|<span class="string"> 607      </span>|<span class="string"> 2          </span>|<span class="string"> SELECT DATABASE()                </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 8          </span>|<span class="string"> select @@version_comment limit ? </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 1          </span>|<span class="string"> set names utf8                   </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 1          </span>|<span class="string"> set names utf8                   </span>|</span><br><span class="line">|<span class="string"> 100 </span>|<span class="string"> 0        </span>|<span class="string"> 6          </span>|<span class="string"> select @@version_comment limit ? </span>|</span><br><span class="line">+-----+----------+------------+----------------------------------+</span><br><span class="line">12 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查询路由规则：</p>
<figure class="highlight coq"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] <span class="number">13</span>:<span class="number">57</span>:<span class="number">12</span> &gt; SELECT rule_id, match_digest, match_pattern, replace_pattern, cache_ttl, <span class="built_in">apply</span> FROM mysql_query_rules ORDER BY rule_id;</span><br><span class="line">+---------+--------------+-----------------------+-----------------+-----------+-------+</span><br><span class="line">| <span class="type">rule_id</span> | <span class="type">match_digest</span> | <span class="type">match_pattern</span>         | <span class="type">replace_pattern</span> | <span class="type">cache_ttl</span> | <span class="type">apply</span> |<span class="type"></span></span><br><span class="line"><span class="type">+---------+--------------+-----------------------+-----------------+-----------+-------+</span></span><br><span class="line"><span class="type">| 10</span>      | <span class="type">NULL</span>         | <span class="type">^SELECT</span> .* FOR UPDATE | <span class="type">NULL</span>            | <span class="type">NULL</span>      | <span class="type">0</span>     |<span class="type"></span></span><br><span class="line"><span class="type">| 11</span>      | <span class="type">NULL</span>         | <span class="type">^SELECT</span> .*            | <span class="type">NULL</span>            | <span class="type">NULL</span>      | <span class="type">0</span>     |<span class="type"></span></span><br><span class="line"><span class="type">+---------+--------------+-----------------------+-----------------+-----------+-------+</span></span><br><span class="line"><span class="type">2</span> rows <span class="built_in">in</span> <span class="built_in">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>参考：</p>
</li>
<li><a href="https://github.com/sysown/proxysql/wiki/ProxySQL-Configuration#p6033" target="_blank" rel="noopener">https://github.com/sysown/proxysql/wiki/ProxySQL-Configuration#p6033</a></li>
<li><a href="http://seanlook.com/2017/04/17/mysql-proxysql-route-rw_split/" target="_blank" rel="noopener">http://seanlook.com/2017/04/17/mysql-proxysql-route-rw_split/</a></li>
<li><a href="http://severalnines.com/blog/how-proxysql-adds-failover-and-query-control-your-mysql-replication-setup" target="_blank" rel="noopener">http://severalnines.com/blog/how-proxysql-adds-failover-and-query-control-your-mysql-replication-setup</a></li>
</ul>
<h2 id="ProxySQL监控"><a href="#ProxySQL监控" class="headerlink" title="ProxySQL监控"></a>ProxySQL监控</h2><p>PMM是Percona推出的一款很好的监控MySQL和MongoDB的开源工具，安装方便，功能丰富，图表美观，同时也支持ProxySQL的监控，故选择PMM作为ProxySQL的监控软件。<br>这里以ProxySQL服务端(192.168.7.50)为例，作为PMM的客户端，PMM服务器为139.196.99.230,仅演示ProxySQL安装PMM客户端，服务器安装配置省略。  </p>
<h3 id="PMM-Client安装"><a href="#PMM-Client安装" class="headerlink" title="PMM Client安装"></a>PMM Client安装</h3><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie ~]# yum localinstall -y /hwdata/duanwenjie/test/proxysql-1.4.1-1-centos67.x86<span class="emphasis">_64.rpm </span></span><br><span class="line"><span class="emphasis">Loaded plugins: security</span></span><br><span class="line"><span class="emphasis">Setting up Local Package Process</span></span><br><span class="line"><span class="emphasis">Examining /hwdata/duanwenjie/test/proxysql-1.4.1-1-centos67.x86_</span>64.rpm: proxysql-1.4.1-1.x86<span class="emphasis">_64</span></span><br><span class="line"><span class="emphasis">Marking /hwdata/duanwenjie/test/proxysql-1.4.1-1-centos67.x86_</span>64.rpm to be installed</span><br><span class="line">Resolving Dependencies</span><br><span class="line">There are unfinished transactions remaining. You might consider running yum-complete-transaction first to finish them.</span><br><span class="line">--&gt; Running transaction check</span><br><span class="line">---&gt; Package proxysql.x86<span class="emphasis">_64 0:1.4.1-1 will be installed</span></span><br><span class="line"><span class="emphasis">--&gt; Finished Dependency Resolution</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">Dependencies Resolved</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">========================================================================================================================================================================</span></span><br><span class="line"><span class="emphasis"> Package                           Arch                            Version                             Repository                                                  Size</span></span><br><span class="line"><span class="emphasis">========================================================================================================================================================================</span></span><br><span class="line"><span class="emphasis">Installing:</span></span><br><span class="line"><span class="emphasis"> proxysql                          x86_</span>64                          1.4.1-1                             /proxysql-1.4.1-1-centos67.x86<span class="emphasis">_64                           19 M</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">Transaction Summary</span></span><br><span class="line"><span class="emphasis">========================================================================================================================================================================</span></span><br><span class="line"><span class="emphasis">Install       1 Package(s)</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">Total size: 19 M</span></span><br><span class="line"><span class="emphasis">Installed size: 19 M</span></span><br><span class="line"><span class="emphasis">Downloading Packages:</span></span><br><span class="line"><span class="emphasis">Running rpm_</span>check<span class="emphasis">_debug</span></span><br><span class="line"><span class="emphasis">Running Transaction Test</span></span><br><span class="line"><span class="emphasis">Transaction Test Succeeded</span></span><br><span class="line"><span class="emphasis">Running Transaction</span></span><br><span class="line"><span class="emphasis">Warning: RPMDB altered outside of yum.</span></span><br><span class="line"><span class="emphasis">** Found 1 pre-existing rpmdb problem(s), 'yum check' output follows:</span></span><br><span class="line"><span class="emphasis">mysql-community-libs-5.7.16-1.el6.x86_</span>64 has missing requires of mysql-community-common(x86-64) &gt;= (<span class="emphasis">'0'</span>, <span class="emphasis">'5.7.9'</span>, None)</span><br><span class="line"><span class="code">  Installing : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></span><br><span class="line"><span class="code">  Verifying  : proxysql-1.4.1-1.x86_64                                                                                                                              1/1 </span></span><br><span class="line"></span><br><span class="line">Installed:</span><br><span class="line"><span class="code">  proxysql.x86_64 0:1.4.1-1                                                                                                                                             </span></span><br><span class="line"></span><br><span class="line">Complete!</span><br><span class="line">[root@jiessie ~]#</span><br></pre></td></tr></table></figure>
<h3 id="PMM-Client配置"><a href="#PMM-Client配置" class="headerlink" title="PMM Client配置"></a>PMM Client配置</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie ~]# ifconfig  #查看IP地址</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:00:DC:49  </span><br><span class="line">          inet addr:192.168.7.50  Bcast:192.168.15.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:1017660 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:1380639 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:273791594 (261.1 MiB)  TX bytes:116287303 (110.9 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap<span class="keyword">:Local</span> Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:1297762 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:1297762 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:141606631 (135.0 MiB)  TX bytes:141606631 (135.0 MiB)</span><br><span class="line"></span><br><span class="line">[root@jiessie ~]# pmm-admin<span class="built_in"> config </span>--bind-address 192.168.7.50 --client-address 139.196.95.103 --server 139.196.99.230:8080 --client-name ProxySQL_Test   #添加config</span><br><span class="line">OK, PMM<span class="built_in"> server </span>is alive.</span><br><span class="line"></span><br><span class="line">PMM<span class="built_in"> Server </span>     | 139.196.99.230:8080 </span><br><span class="line">Client Name     | ProxySQL_Test</span><br><span class="line">Client<span class="built_in"> Address </span> | 139.196.95.103 (192.168.7.50)</span><br><span class="line">[root@jiessie ~]# pmm-admin <span class="builtin-name">add</span> linux:metrics --force ProxySQL_Test     #添加Linux监控</span><br><span class="line">OK, now monitoring this system.</span><br><span class="line">[root@jiessie ~]# </span><br><span class="line">[root@jiessie ~]# pmm-admin <span class="builtin-name">add</span> proxysql:metrics --dsn <span class="string">"admin:admin@tcp(127.0.0.1:6032)/"</span> proxysql6032 #添加ProxySQL监控</span><br><span class="line">OK, now monitoring ProxySQL metrics using DSN admin:***@tcp(localhost:6032)</span><br><span class="line">[root@jiessie ~]# </span><br><span class="line">[root@jiessie ~]# pmm-admin list    #查看状态</span><br><span class="line">pmm-admin 1.3.0</span><br><span class="line"></span><br><span class="line">PMM<span class="built_in"> Server </span>     | 139.196.99.230:8080 </span><br><span class="line">Client Name     | ProxySQL_Test</span><br><span class="line">Client<span class="built_in"> Address </span> | 139.196.95.103 (192.168.7.50)</span><br><span class="line">Service Manager | unix-systemv</span><br><span class="line"></span><br><span class="line">----------------- -------------- ----------- -------- ------------------------------ --------</span><br><span class="line">SERVICE<span class="built_in"> TYPE </span>     NAME           LOCAL<span class="built_in"> PORT </span> RUNNING  DATA SOURCE                    OPTIONS </span><br><span class="line">----------------- -------------- ----------- -------- ------------------------------ --------</span><br><span class="line">linux:metrics     ProxySQL_Test  42000       <span class="literal">YES</span>      -                                      </span><br><span class="line">mysql:metrics     ProxySQL_Test  42002       <span class="literal">YES</span>      root:***@tcp(127.0.0.1:3306)           </span><br><span class="line">proxysql:metrics  proxysql6032   42004       <span class="literal">YES</span>      admin:***@tcp(127.0.0.1:6032)          </span><br><span class="line"></span><br><span class="line">[root@jiessie ~]#</span><br></pre></td></tr></table></figure>
<h3 id="PMM-Server监控展示"><a href="#PMM-Server监控展示" class="headerlink" title="PMM Server监控展示"></a>PMM Server监控展示</h3><p>PMM Server监控项包括：</p>
<ul>
<li>客户端连接数</li>
<li>客户端总查询</li>
<li>ProxySQL连接池状态</li>
<li>活动连接</li>
<li>失败连接</li>
<li>客户端查询路由详情</li>
<li>客户端延迟状态</li>
<li>网络接口<br><img src="http://note.youdao.com/yws/public/resource/eda87c5cc1090ba9cc4be116906c805b/xmlnote/784F7090F01E4C62AE28CA4BB08A82F8/37001" alt="image"></li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>ProxySQL是一款很出色的MySQL中间件，在稳定性上、易用性、高性能等方面表现很不错。由于发布的时间较短，功能可能还不太完善，需要多做测试，特别是查询路由和规则方面需要详情的了解，测试。可重点关注。</p>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/误删除ibdata1-Table-doesn-t-exist-恢复案例.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/误删除ibdata1-Table-doesn-t-exist-恢复案例.html" itemprop="url">误删除ibdata1(Table doesn,t exist)恢复案例</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-26T16:12:30+08:00">
                2017-07-26
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/备份恢复/" itemprop="url" rel="index">
                    <span itemprop="name">备份恢复</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>MySQL从5.5版本开始，InnoDB存储引擎已经成为默认存储引擎。从物理文件的结构来看，InnoDB包含ibdata1,ib_logfilexx,数据文件等其他日志文件;其中参数innodb_file_per_table用于设置是否开启独立表空间，当开启独立表空间时数据和索引会存在于ibd文件中，当未开启独立表空间时，此时使用的是共享表空间，数据和索引会存储在ibdata1文件中。如果在清理空间时不小心把ibdata1文件删除了，未开启独立表空间时，数据也会被删除，只能从备份中恢复，没有其他办法。如果开启了独立表空间，可从ibd文件中恢复数据。本文将介绍在开启独立表空间一些恢复案例，前提是无备份。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>MySQL版本：percona server 5.6.36</p>
<h2 id="案例步骤"><a href="#案例步骤" class="headerlink" title="案例步骤"></a>案例步骤</h2><ul>
<li>启动MySQL实例</li>
<li>插入数据，中间穿插创建删除表，操持ibdata1内部tablespace的ID真实性</li>
<li>模拟删除ibdata1和ib_logfile文件</li>
<li>保存数据文件和表结构文件到其他目录</li>
<li>提取该实例的所有表结构</li>
<li>通过提取的表结构，创建实例下的所有表</li>
<li>通过ALTER TABLE dbName.tableName DISCARD TABLESPACE删除新创建表的ibd文件</li>
<li>拷贝原数据文件到对应的ibd文件目录</li>
<li>修改ibd文件权限</li>
<li>通过ALTER TABLE dbName.tableName IMPORT TABLESPACE导入拷贝的ibd文件</li>
<li>使用mysqldump导出数据</li>
<li>重建实例，导入数据</li>
</ul>
<h2 id="原理分析"><a href="#原理分析" class="headerlink" title="原理分析"></a>原理分析</h2><ul>
<li>恢复的步骤中，其中修改InnoDB表的tablespace ID最为重要。默认情况下，当开启独立表空间时，即使表数据文件和索引存在于数据目录中，但是每个表都有一个表的空间ID做标识，这部分标识同样存在于ibdata1中，是一个关联的关系。当两者不一致时，数据字典里找不到表，InnoDB引擎就无法加载数据目录下的ibd文件。恢复的目的使两者保持一致，正常加载数据。  </li>
<li>ibdata1内部结构<br><img src="http://note.youdao.com/yws/public/resource/201a8fd072347ee005ead80faff0d73f/xmlnote/3779D26FBB26415081E28594C9D34419/34308" alt="image"></li>
<li>ibd内部结构<br><img src="http://note.youdao.com/yws/public/resource/201a8fd072347ee005ead80faff0d73f/xmlnote/84FC7DF3BD594204AA6F70B8208D0E05/34310" alt="image"></li>
<li><a href="https://blog.jcole.us/2013/01/03/the-basics-of-innodb-space-file-layout/" target="_blank" rel="noopener">图片来源于</a>Jeremy Cole，原理写的很清楚，请参考。</li>
<li>ibdata1中的insert buffer/double buffer等可以不用关心，本次恢复用不到。</li>
</ul>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="启动MySQL实例"><a href="#启动MySQL实例" class="headerlink" title="启动MySQL实例"></a>启动MySQL实例</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># ll /hwdata/data/percona</span></span><br><span class="line">总用量 1341500</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql        <span class="number"> 56 </span>7月  <span class="number"> 4 </span>23:50 auto.cnf</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 1073741824 </span>7月 <span class="number"> 27 </span>15:44 ibdata1</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql <span class="number"> 134217728 </span>7月 <span class="number"> 27 </span>15:44 ib_logfile0</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql <span class="number"> 134217728 </span>7月 <span class="number"> 27 </span>15:44 ib_logfile1</span><br><span class="line">drwx------<span class="number"> 2 </span>mysql mysql      <span class="number"> 4096 </span>6月 <span class="number"> 20 </span>13:43 mysql</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql       <span class="number"> 151 </span>7月 <span class="number"> 27 </span>15:44 mysql-bin.000001</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql        <span class="number"> 19 </span>7月 <span class="number"> 27 </span>15:44 mysql-bin.index</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql     <span class="number"> 26901 </span>7月 <span class="number"> 27 </span>15:44 mysql-error.log</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql         <span class="number"> 5 </span>7月 <span class="number"> 27 </span>15:44 mysql.pid</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql      <span class="number"> 1037 </span>7月 <span class="number"> 27 </span>15:44 mysql-slow.log</span><br><span class="line">drwx------<span class="number"> 2 </span>mysql mysql      <span class="number"> 4096 </span>6月 <span class="number"> 20 </span>13:43 performance_schema</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 10485760 </span>7月 <span class="number"> 27 </span>15:44 undo001</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 10485760 </span>7月 <span class="number"> 27 </span>15:44 undo002</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 10485760 </span>7月 <span class="number"> 27 </span>15:44 undo003</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /etc/init.d/mysqld stop</span></span><br><span class="line">Shutting down MySQL (Percona Server)..                     [确定]</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># rm -rf /hwdata/data/percona/ib* /hwdata/data/percona/undo00*</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># ll /hwdata/data/percona                                     </span></span><br><span class="line">总用量 60</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql   <span class="number"> 56 </span>7月  <span class="number"> 4 </span>23:50 auto.cnf</span><br><span class="line">drwx------<span class="number"> 2 </span>mysql mysql <span class="number"> 4096 </span>6月 <span class="number"> 20 </span>13:43 mysql</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 174 </span>7月 <span class="number"> 27 </span>15:45 mysql-bin.000001</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql   <span class="number"> 19 </span>7月 <span class="number"> 27 </span>15:44 mysql-bin.index</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 31528 </span>7月 <span class="number"> 27 </span>15:45 mysql-error.log</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql <span class="number"> 1037 </span>7月 <span class="number"> 27 </span>15:44 mysql-slow.log</span><br><span class="line">drwx------<span class="number"> 2 </span>mysql mysql <span class="number"> 4096 </span>6月 <span class="number"> 20 </span>13:43 performance_schema</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /etc/init.d/mysqld start</span></span><br><span class="line">Starting MySQL (Percona Server)............                [确定]</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="插入数据"><a href="#插入数据" class="headerlink" title="插入数据"></a>插入数据</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># cat auto_insert_data.sh   #简单的插入脚本</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Name: auto_insert_data</span></span><br><span class="line"><span class="comment"># Author: jiessie</span></span><br><span class="line"><span class="comment"># Describe: auto insert data</span></span><br><span class="line"><span class="comment"># Date: 20170727</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># basic variables</span></span><br><span class="line">MySQL_CMD=/usr/<span class="built_in">local</span>/mysql/bin/mysql</span><br><span class="line">MySQL_User=root</span><br><span class="line">MySQL_Pass=123456</span><br><span class="line">MySQL_Host=localhost</span><br><span class="line">MySQL_Db=test1</span><br><span class="line"></span><br><span class="line"><span class="comment"># create database</span></span><br><span class="line"><span class="variable">$MySQL_CMD</span> -h<span class="variable">$MySQL_Host</span> -u<span class="variable">$MySQL_User</span> -p<span class="variable">$MySQL_Pass</span> -e <span class="string">"create database if not exists <span class="variable">$MySQL_Db</span>;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># insert data</span></span><br><span class="line"><span class="keyword">for</span> ((i=1;i&lt;=10;i++));</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        <span class="variable">$MySQL_CMD</span> -h<span class="variable">$MySQL_Host</span> -u<span class="variable">$MySQL_User</span> -p<span class="variable">$MySQL_Pass</span> <span class="variable">$MySQL_Db</span> -e <span class="string">"create table employee<span class="variable">$i</span>(id int(10) unsigned NOT NULL AUTO_INCREMENT,empname varchar(64) NOT NULL DEFAULT '',PRIMARY KEY (id));"</span></span><br><span class="line">        <span class="keyword">for</span>((j=1;j&lt;=1000;j++));</span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">                <span class="variable">$MySQL_CMD</span> -h<span class="variable">$MySQL_Host</span> -u<span class="variable">$MySQL_User</span> -p<span class="variable">$MySQL_Pass</span> <span class="variable">$MySQL_Db</span> -e <span class="string">"insert into employee<span class="variable">$i</span> values(null,'employee<span class="variable">$j</span>');"</span></span><br><span class="line">        <span class="keyword">done</span></span><br><span class="line">        <span class="comment"># create other table and delete</span></span><br><span class="line">        <span class="variable">$MySQL_CMD</span> -h<span class="variable">$MySQL_Host</span> -u<span class="variable">$MySQL_User</span> -p<span class="variable">$MySQL_Pass</span> <span class="variable">$MySQL_Db</span> -e <span class="string">"create table tmp<span class="variable">$i</span>(id int);drop table tmp<span class="variable">$i</span>;"</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># nohup ./auto_insert_data.sh &amp;     #执行插入数据</span></span><br><span class="line">[1] 4562</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># nohup: 忽略输入并把输出追加到"nohup.out"</span></span><br><span class="line"></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="查看数据"><a href="#查看数据" class="headerlink" title="查看数据"></a>查看数据</h3><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# mysql -uroot -p123456 test1</span><br><span class="line">Warning: <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line <span class="keyword">interface</span> can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">10202</span></span><br><span class="line">Server version: <span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [test1] <span class="number">17</span>:<span class="number">04</span>:<span class="number">40</span> &gt; show tables;</span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_test1 |</span><br><span class="line">+-----------------+</span><br><span class="line">| employee1       |</span><br><span class="line">| employee10      |</span><br><span class="line">| employee2       |</span><br><span class="line">| employee3       |</span><br><span class="line">| employee4       |</span><br><span class="line">| employee5       |</span><br><span class="line">| employee6       |</span><br><span class="line">| employee7       |</span><br><span class="line">| employee8       |</span><br><span class="line">| employee9       |</span><br><span class="line">+-----------------+</span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test1] <span class="number">17</span>:<span class="number">04</span>:<span class="number">42</span> &gt; <span class="keyword">select</span> count<span class="comment">(*) from employee1;</span></span><br><span class="line"><span class="comment">+----------+</span></span><br><span class="line"><span class="comment">| count(*)</span> |</span><br><span class="line">+----------+</span><br><span class="line">|     <span class="number">1000</span> |</span><br><span class="line">+----------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test1] <span class="number">17</span>:<span class="number">04</span>:<span class="number">44</span> &gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]#</span><br></pre></td></tr></table></figure>
<h3 id="删除ibdata1"><a href="#删除ibdata1" class="headerlink" title="删除ibdata1"></a>删除ibdata1</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># cd /hwdata/data/percona</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># ll</span></span><br><span class="line">总用量 1345228</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql        <span class="number"> 56 </span>7月  <span class="number"> 4 </span>23:50 auto.cnf</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql     <span class="number"> 14522 </span>7月 <span class="number"> 27 </span>17:02 ib_buffer_pool</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 1073741824 </span>7月 <span class="number"> 27 </span>17:03 ibdata1</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql <span class="number"> 134217728 </span>7月 <span class="number"> 27 </span>17:03 ib_logfile0</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql <span class="number"> 134217728 </span>7月 <span class="number"> 27 </span>17:02 ib_logfile1</span><br><span class="line">drwx------<span class="number"> 2 </span>mysql mysql      <span class="number"> 4096 </span>6月 <span class="number"> 20 </span>13:43 mysql</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql   <span class="number"> 3325813 </span>7月 <span class="number"> 27 </span>17:03 mysql-bin.000001</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql        <span class="number"> 19 </span>7月 <span class="number"> 27 </span>17:02 mysql-bin.index</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql    <span class="number"> 496222 </span>7月 <span class="number"> 27 </span>17:05 mysql-error.log</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql         <span class="number"> 5 </span>7月 <span class="number"> 27 </span>17:02 mysql.pid</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql      <span class="number"> 2383 </span>7月 <span class="number"> 27 </span>17:04 mysql-slow.log</span><br><span class="line">drwx------<span class="number"> 2 </span>mysql mysql      <span class="number"> 4096 </span>6月 <span class="number"> 20 </span>13:43 performance_schema</span><br><span class="line">drwx------<span class="number"> 2 </span>mysql mysql      <span class="number"> 4096 </span>7月 <span class="number"> 27 </span>17:03 test1</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 10485760 </span>7月 <span class="number"> 27 </span>17:03 undo001</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 10485760 </span>7月 <span class="number"> 27 </span>17:03 undo002</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 10485760 </span>7月 <span class="number"> 27 </span>17:03 undo003</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># rm -rf ib_buffer_pool ib_logfile* undo00* ibdata1   #删除ibdata1相关信息</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># /etc/init.d/mysqld restart                          #重启服务</span></span><br><span class="line">Shutting down MySQL (Percona Server)..                     [确定]</span><br><span class="line">Starting MySQL (Percona Server)............                [确定]</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># mysql -uroot -p123456 test1</span></span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 17</span><br><span class="line">Server version: 5.6.36-82.0-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [test1] 17:08:29 &gt; select count(*) from employee1;                                    <span class="comment">#提示表不存在</span></span><br><span class="line">ERROR<span class="number"> 1146 </span>(42S02): Table 'test1.employee1' doesn't exist</span><br><span class="line">MySQL [test1] 17:08:32 &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># ll test1/                                           #查看frm和ibd文件存在</span></span><br><span class="line">总用量 1404</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql    <span class="number"> 59 </span>7月 <span class="number"> 27 </span>17:03 db.opt</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee10.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee10.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee1.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee1.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee2.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee2.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee3.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee3.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee4.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee4.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee5.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee5.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee6.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee6.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee7.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee7.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee8.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee8.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee9.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 e</span><br><span class="line">yee9.ibd</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="保存数据文件"><a href="#保存数据文件" class="headerlink" title="保存数据文件"></a>保存数据文件</h3><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># cp -a test1/ /usr/src/  #数据暂时保存到/usr/src目录下</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># ll /usr/src/test1 |wc -l</span></span><br><span class="line"><span class="number">22</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="恢复表结构"><a href="#恢复表结构" class="headerlink" title="恢复表结构"></a>恢复表结构</h3><p>如果表结构保存的有，不需要此步骤，直接按照表结构重新创建表<br>此步骤使用官方工具mysql-utilities通过frm文件提取表结构，地址<a href="https://dev.mysql.com/downloads/utilities/" target="_blank" rel="noopener">：</a></p>
<h4 id="mysql-utilities原理"><a href="#mysql-utilities原理" class="headerlink" title="mysql-utilities原理"></a>mysql-utilities原理</h4><ul>
<li>默认以再生实例启动，读取frm文件，再生实例关闭，清理临时文件</li>
<li>另一个模式是诊断模式，需要指定 –diagnostic 选项。byte-by-byte读取.frm文件，该模式有更多的局限性，不能校验字符集</li>
<li>请参考<a href="https://dev.mysql.com/doc/mysql-utilities/1.5/en/mysqlfrm.html" target="_blank" rel="noopener">官网：</a></li>
</ul>
<h4 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h4><ul>
<li>某些引擎表在默认模式下不可读取的。如PARTITION, PERFORMANCE_SCHEMA，必需在诊断模式下可读。</li>
<li>要在创建语句中改变存储引擎，可使用–new-storage-engine 选项。如果有指定该选项，同时必须指定–frmdir选项，该工具生成新的.frm文件，前缀为new_，并保存在–frmdir目录下。</li>
<li>关掉所有信息除了CREATE 语句和警告或错误信息，使用–quiet选项。</li>
<li>使用–show-stats 选项统计每个.frm文件信息。</li>
<li>使用–user 选项指定再生的实例以哪个权限运行。</li>
<li>如果再生的实例超过10秒启动，需调大–start-timeout 选项参数。</li>
</ul>
<h4 id="mysql-utilities安装"><a href="#mysql-utilities安装" class="headerlink" title="mysql-utilities安装"></a>mysql-utilities安装</h4><p>由于yum安装的是1.3的版本，1.6有bug，使用1.5.6版本，故采用源码包的形式安装，安装过程中如报错，请先安装驱动程序Connector/Python<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># cd /usr/src/</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ src]<span class="comment"># wget https://dev.mysql.com/get/Downloads/MySQLGUITools/mysql-utilities-1.5.6.tar.gz</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ src]<span class="comment"># tar -zxf mysql-utilities-1.5.6.tar.gz </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ src]<span class="comment"># cd mysql-utilities-1.5.6</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ mysql-utilities-1.5.6]<span class="comment"># </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ mysql-utilities-1.5.6]<span class="comment"># python ./setup.py build   #编译,过程省略</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ mysql-utilities-1.5.6]<span class="comment"># python ./setup.py install #安装,过程省略</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ mysql-utilities-1.5.6]<span class="comment"># ll /usr/bin/mysql* -t     #以下为生成的可执行文件</span></span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root <span class="number"> 11966 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlauditadmin</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root <span class="number"> 12217 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlauditgrep</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root <span class="number"> 16680 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqldbcompare</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root <span class="number"> 13918 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqldbcopy</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root <span class="number"> 14815 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqldbexport</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root <span class="number"> 13605 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqldbimport</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root <span class="number"> 10722 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqldiff</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 7385 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqldiskusage</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root <span class="number"> 14197 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlfabric</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root <span class="number"> 15457 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlfailover</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root <span class="number"> 18222 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlfrm</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 6251 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlindexcheck</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 5356 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlmetagrep</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 5984 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlprocgrep</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 7694 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlreplicate</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root <span class="number"> 16669 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlrpladmin</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 6407 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlrplcheck</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root <span class="number"> 15542 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlrplms</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 6695 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlrplshow</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root <span class="number"> 11489 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlrplsync</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 8642 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlserverclone</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 5945 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqlserverinfo</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 6923 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqluc</span><br><span class="line">-rwxr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 8048 </span>7月 <span class="number"> 27 </span>11:50 /usr/bin/mysqluserclone</span><br></pre></td></tr></table></figure></p>
<p>以上为生成的可执行文件中，我们只需要用到mysqlfrm，用于表结构恢复</p>
<h4 id="开始提取frm表结构"><a href="#开始提取frm表结构" class="headerlink" title="开始提取frm表结构"></a>开始提取frm表结构</h4><p>此用法启动了3333的实例，读取hwdata/data/percona/test1/下的所有frm文件，没有指定数据库，生成了以最后一个文件夹为DB名字的表结构<br><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# mysqlfrm --basedir=/usr/local/mysql --port=<span class="number">3333</span> --user=mysql /hwdata/data/percona/test1/ &gt; table_frm.sql</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# mysqlfrm --help     #其他使用方法请参考帮助</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# sed <span class="string">'/^#/d;/^$/d'</span> table_frm.sql |head <span class="number">-5</span>    #如下显示</span><br><span class="line">CREATE TABLE `test1`.`employee1` (</span><br><span class="line">  `id` int(<span class="number">10</span>) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `empname` varchar(<span class="number">64</span>) NOT NULL DEFAULT <span class="string">''</span>,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=gbk</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# sed -i <span class="string">'s@CHARSET=gbk@CHARSET=gbk;@g'</span> table_frm.sql #由于导出后没有以分号结尾，此命令处理添加上分号</span><br></pre></td></tr></table></figure></p>
<h4 id="导入frm表结构"><a href="#导入frm表结构" class="headerlink" title="导入frm表结构"></a>导入frm表结构</h4><p>确认数据文件已经保存至其他目录<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># ll /usr/src/test1/      #确认下数据文件是否保存在此</span></span><br><span class="line">总用量 1404</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql    <span class="number"> 59 </span>7月 <span class="number"> 27 </span>17:03 db.opt</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee10.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee10.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee1.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee1.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee2.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee2.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee3.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee3.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee4.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee4.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee5.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee5.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee6.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee6.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee7.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee7.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee8.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee8.ibd</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 8592 </span>7月 <span class="number"> 27 </span>17:03 employee9.frm</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 131072 </span>7月 <span class="number"> 27 </span>17:03 employee9.ibd</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># ll</span></span><br><span class="line">总用量 1351956</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql        <span class="number"> 56 </span>7月  <span class="number"> 4 </span>23:50 auto.cnf</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root  root          <span class="number"> 0 </span>7月 <span class="number"> 27 </span>17:08 exit</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql      <span class="number"> 2563 </span>7月 <span class="number"> 27 </span>17:08 ib_buffer_pool</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql<span class="number"> 1073741824 </span>7月 <span class="number"> 27 </span>17:08 ibdata1</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql <span class="number"> 134217728 </span>7月 <span class="number"> 27 </span>17:08 ib_logfile0</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql <span class="number"> 134217728 </span>7月 <span class="number"> 27 </span>17:08 ib_logfile1</span><br><span class="line">drwx------<span class="number"> 2 </span>mysql mysql      <span class="number"> 4096 </span>6月 <span class="number"> 20 </span>13:43 mysql</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql   <span class="number"> 3325836 </span>7月 <span class="number"> 27 </span>17:08 mysql-bin.000001</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql       <span class="number"> 191 </span>7月 <span class="number"> 27 </span>17:08 mysql-bin.000002</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql        <span class="number"> 38 </span>7月 <span class="number"> 27 </span>17:08 mysql-bin.index</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql   <span class="number"> 7003893 </span>7月 <span class="number"> 28 </span>10:44 mysql-error.log</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql         <span class="number"> 6 </span>7月 <span class="number"> 27 </span>17:08 mysql.pid</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql    <span class="number"> 387620 </span>7月 <span class="number"> 28 </span>10:37 mysql-slow.log</span><br><span class="line">drwx------<span class="number"> 2 </span>mysql mysql      <span class="number"> 4096 </span>6月 <span class="number"> 20 </span>13:43 performance_schema</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root  root          <span class="number"> 0 </span>7月 <span class="number"> 27 </span>17:08 show</span><br><span class="line">-rw-r--r--<span class="number"> 1 </span>root  root       <span class="number"> 3064 </span>7月 <span class="number"> 28 </span>10:42 table_frm.sql</span><br><span class="line">drwx------<span class="number"> 2 </span>mysql mysql      <span class="number"> 4096 </span>7月 <span class="number"> 28 </span>10:27 test1</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 10485760 </span>7月 <span class="number"> 27 </span>17:08 undo001</span><br><span class="line">-rw-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 10485760 </span>7月 <span class="number"> 27 </span>17:08 undo002</span><br><span class="line">  w-rw----<span class="number"> 1 </span>mysql mysql  <span class="number"> 10485760 </span>7月 <span class="number"> 27 </span>17:08 undo003</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># rm -rf test1/*</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># /etc/init.d/mysqld restart</span></span><br><span class="line">Shutting down MySQL (Percona Server)..                     [确定]</span><br><span class="line">Starting MySQL (Percona Server)..                          [确定]</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]<span class="comment"># mysql -uroot -p123456 test1</span></span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 4</span><br><span class="line">Server version: 5.6.36-82.0-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [test1] 10:47:30 &gt; source /hwdata/data/percona/table_frm.sql;</span><br><span class="line">Query OK,<span class="number"> 0 </span>rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">Query OK,<span class="number"> 0 </span>rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">Query OK,<span class="number"> 0 </span>rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">Query OK,<span class="number"> 0 </span>rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">Query OK,<span class="number"> 0 </span>rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">Query OK,<span class="number"> 0 </span>rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">Query OK,<span class="number"> 0 </span>rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">Query OK,<span class="number"> 0 </span>rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">Query OK,<span class="number"> 0 </span>rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">Query OK,<span class="number"> 0 </span>rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test1] 10:47:31 &gt; show tables;           <span class="comment">#新表已创建</span></span><br><span class="line">+-----------------+</span><br><span class="line">| Tables_in_test1 |</span><br><span class="line">+-----------------+</span><br><span class="line">| employee1       |</span><br><span class="line">| employee10      |</span><br><span class="line">| employee2       |</span><br><span class="line">| employee3       |</span><br><span class="line">| employee4       |</span><br><span class="line">| employee5       |</span><br><span class="line">| employee6       |</span><br><span class="line">| employee7       |</span><br><span class="line">| employee8       |</span><br><span class="line">| employee9       |</span><br><span class="line">+-----------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test1] 10:49:54 &gt; select count(*) from employee1;    <span class="comment">#目录无数据</span></span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|       <span class="number"> 0 </span>|</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test1] 10:50:01 &gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="删除新创建表的ibd文件"><a href="#删除新创建表的ibd文件" class="headerlink" title="删除新创建表的ibd文件"></a>删除新创建表的ibd文件</h3><p>由于表比较多，通过脚本的形式去执行批量删除操作<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># cat auto_delete_tablespace.sh     #简单的批量删除表空间脚本</span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="comment"># Name: auto_delete_tablespace</span></span><br><span class="line"><span class="comment"># Author: jiessie</span></span><br><span class="line"><span class="comment"># Describe: auto delete create table tablespace</span></span><br><span class="line"><span class="comment"># Date: 20170727</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># basic variables</span></span><br><span class="line">MySQL_CMD=/usr/<span class="keyword">local</span>/mysql/bin/mysql</span><br><span class="line">MySQL_User=root</span><br><span class="line">MySQL_Pass=<span class="number">123456</span></span><br><span class="line">MySQL_Host=localhost</span><br><span class="line">MySQL_Db=test1</span><br><span class="line">MySQL_Table_list=/tmp/table_list.sql</span><br><span class="line"></span><br><span class="line"><span class="comment"># generate table list and exec delete tablespace sql</span></span><br><span class="line">$MySQL_CMD -h$MySQL_Host -u$MySQL_User -p$MySQL_Pass $MySQL_Db -e <span class="string">"select concat('alter table $MySQL_Db.',table_name,' discard tablespace;') from information_schema.tables where table_schema='$MySQL_Db'"</span> &gt; $MySQL_Table_list</span><br><span class="line">sed -i '<span class="number">1</span>d' $MySQL_Table_list</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># ./auto_delete_tablespace.sh       #执行获取删除表空间脚本</span></span><br><span class="line">mysql: [Warning] Using a password <span class="keyword">on</span> <span class="keyword">the</span> command line interface can be insecure.</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># cat /tmp/table_list.sql           #查看生成的删除表空间的SQL语句</span></span><br><span class="line">alter table test1.employee1 discard tablespace;</span><br><span class="line">alter table test1.employee10 discard tablespace;</span><br><span class="line">alter table test1.employee2 discard tablespace;</span><br><span class="line">alter table test1.employee3 discard tablespace;</span><br><span class="line">alter table test1.employee4 discard tablespace;</span><br><span class="line">alter table test1.employee5 discard tablespace;</span><br><span class="line">alter table test1.employee6 discard tablespace;</span><br><span class="line">alter table test1.employee7 discard tablespace;</span><br><span class="line">alter table test1.employee8 discard tablespace;</span><br><span class="line">alter table test1.employee9 discard tablespace;</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># ll /hwdata/data/percona/test1/*.ibd   #查询新创建表后生成的ibd文件</span></span><br><span class="line">-rw-rw<span class="comment">---- 1 mysql mysql 98304 7月  28 10:47 /hwdata/data/percona/test1/employee10.ibd</span></span><br><span class="line">-rw-rw<span class="comment">---- 1 mysql mysql 98304 7月  28 10:47 /hwdata/data/percona/test1/employee1.ibd</span></span><br><span class="line">-rw-rw<span class="comment">---- 1 mysql mysql 98304 7月  28 10:47 /hwdata/data/percona/test1/employee2.ibd</span></span><br><span class="line">-rw-rw<span class="comment">---- 1 mysql mysql 98304 7月  28 10:47 /hwdata/data/percona/test1/employee3.ibd</span></span><br><span class="line">-rw-rw<span class="comment">---- 1 mysql mysql 98304 7月  28 10:47 /hwdata/data/percona/test1/employee4.ibd</span></span><br><span class="line">-rw-rw<span class="comment">---- 1 mysql mysql 98304 7月  28 10:47 /hwdata/data/percona/test1/employee5.ibd</span></span><br><span class="line">-rw-rw<span class="comment">---- 1 mysql mysql 98304 7月  28 10:47 /hwdata/data/percona/test1/employee6.ibd</span></span><br><span class="line">-rw-rw<span class="comment">---- 1 mysql mysql 98304 7月  28 10:47 /hwdata/data/percona/test1/employee7.ibd</span></span><br><span class="line">-rw-rw<span class="comment">---- 1 mysql mysql 98304 7月  28 10:47 /hwdata/data/percona/test1/employee8.ibd</span></span><br><span class="line">-rw-rw<span class="comment">---- 1 mysql mysql 98304 7月  28 10:47 /hwdata/data/percona/test1/employee9.ibd</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># mysql -uroot -p123456 test1        </span></span><br><span class="line">Warning: Using a password <span class="keyword">on</span> <span class="keyword">the</span> command line interface can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">1753</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.6</span><span class="number">.36</span><span class="number">-82.0</span>-<span class="built_in">log</span> Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [test1] <span class="number">11</span>:<span class="number">10</span>:<span class="number">40</span> &gt; source /tmp/table_list.sql;                    <span class="comment">#执行删除表空间</span></span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test1] <span class="number">11</span>:<span class="number">10</span>:<span class="number">46</span> &gt; <span class="keyword">exit</span></span><br><span class="line">Bye</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># ll /hwdata/data/percona/test1/*.ibd   #验证表空间已经删除</span></span><br><span class="line">ls: 无法访问/hwdata/data/percona/test1/*.ibd: 没有那个文件或目录</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<h3 id="导入原数据ibd文件"><a href="#导入原数据ibd文件" class="headerlink" title="导入原数据ibd文件"></a>导入原数据ibd文件</h3><p>由于原表过多，通过脚本实现<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# <span class="keyword">cat</span> auto_recovery_data.<span class="keyword">sh</span>         #恢复ibd文件脚本</span><br><span class="line">#!/bin/bash</span><br><span class="line"># Name: auto_delete_tablespace</span><br><span class="line"># Author: jiessie</span><br><span class="line"># Describe: auto <span class="keyword">delete</span> create table tablespace</span><br><span class="line"># Date: <span class="number">20170727</span></span><br><span class="line"></span><br><span class="line"># basic variables</span><br><span class="line">MySQL_CMD=/usr/local/mysql/bin/mysql</span><br><span class="line">MySQL_User=root</span><br><span class="line">MySQL_Pass=<span class="number">123456</span></span><br><span class="line">MySQL_Host=localhost</span><br><span class="line">MySQL_Db=test1</span><br><span class="line">MySQL_Ibd_filepath=/usr/src/test1/</span><br><span class="line">MySQL_Table_list=/tmp/tables.sql</span><br><span class="line">MySQL_Table_path=/hwdata/data/percona/test1</span><br><span class="line"></span><br><span class="line"># import ibd <span class="keyword">file</span></span><br><span class="line">/etc/init.d/mysqld <span class="keyword">stop</span></span><br><span class="line"><span class="keyword">cd</span> $MySQL_Ibd_filepath &amp;&amp; <span class="keyword">cp</span> -<span class="keyword">a</span> * $MySQL_Table_path</span><br><span class="line">chown -R mysq<span class="variable">l:mysql</span> $MySQL_Table_path</span><br><span class="line">/etc/init.d/mysqld start</span><br><span class="line">$MySQL_CMD -h$MySQL_Host -<span class="keyword">u</span>$MySQL_User -<span class="keyword">p</span>$MySQL_Pass $MySQL_Db -<span class="keyword">e</span> <span class="string">"select table_name from information_schema.tables where table_schema='$MySQL_Db'"</span> &gt; $MySQL_Table_list</span><br><span class="line">sed -i <span class="string">'1d'</span> $MySQL_Table_list</span><br><span class="line"><span class="keyword">cat</span> $MySQL_Table_list | <span class="keyword">while</span> <span class="keyword">read</span> <span class="built_in">line</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">        $MySQL_CMD -h$MySQL_Host -<span class="keyword">u</span>$MySQL_User -<span class="keyword">p</span>$MySQL_Pass $MySQL_Db -<span class="keyword">e</span> <span class="string">"alter table $MySQL_Db.$line import tablespace;"</span></span><br><span class="line">done</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# ./auto_recovery_data.<span class="keyword">sh</span>           #执行恢复脚本</span><br><span class="line">Shutting down MySQL (Percona Server)...                    [确定]</span><br><span class="line">Starting MySQL (Percona Server)..                          [确定]</span><br><span class="line">mysq<span class="variable">l:</span> [Warning] Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</span><br><span class="line">mysq<span class="variable">l:</span> [Warning] Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</span><br><span class="line">mysq<span class="variable">l:</span> [Warning] Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</span><br><span class="line">mysq<span class="variable">l:</span> [Warning] Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</span><br><span class="line">mysq<span class="variable">l:</span> [Warning] Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</span><br><span class="line">mysq<span class="variable">l:</span> [Warning] Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</span><br><span class="line">mysq<span class="variable">l:</span> [Warning] Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</span><br><span class="line">mysq<span class="variable">l:</span> [Warning] Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</span><br><span class="line">mysq<span class="variable">l:</span> [Warning] Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</span><br><span class="line">mysq<span class="variable">l:</span> [Warning] Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</span><br><span class="line">mysq<span class="variable">l:</span> [Warning] Using <span class="keyword">a</span> password <span class="keyword">on</span> the <span class="keyword">command</span> <span class="built_in">line</span> interface can <span class="keyword">be</span> insecure.</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="数据验证"><a href="#数据验证" class="headerlink" title="数据验证"></a>数据验证</h3><p>通过count计数，比较数据是否恢复正常<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># mysql -uroot -p123456 test1</span></span><br><span class="line"><span class="symbol">Warning:</span> Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; or \g.</span><br><span class="line">Your MySQL connection id is <span class="number">704</span></span><br><span class="line">Server <span class="symbol">version:</span> <span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark <span class="keyword">of</span> Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> help. Type <span class="string">'\c'</span> to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [test1] <span class="number">14</span>:<span class="number">51</span>:<span class="number">58</span> &gt; <span class="keyword">select</span> count(*) from employee1</span><br><span class="line">    -&gt; <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line">    -&gt; <span class="keyword">select</span> count(*) from employee2</span><br><span class="line">    -&gt; <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line">    -&gt; <span class="keyword">select</span> count(*) from employee3</span><br><span class="line">    -&gt; <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line">    -&gt; <span class="keyword">select</span> count(*) from employee4</span><br><span class="line">    -&gt; <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line">    -&gt; <span class="keyword">select</span> count(*) from employee5</span><br><span class="line">    -&gt; <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line">    -&gt; <span class="keyword">select</span> count(*) from employee6</span><br><span class="line">    -&gt; <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line">    -&gt; <span class="keyword">select</span> count(*) from employee7</span><br><span class="line">    -&gt; <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line">    -&gt; <span class="keyword">select</span> count(*) from employee8</span><br><span class="line">    -&gt; <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line">    -&gt; <span class="keyword">select</span> count(*) from employee9</span><br><span class="line">    -&gt; <span class="class"><span class="keyword">union</span> <span class="title">all</span></span></span><br><span class="line">    -&gt; <span class="keyword">select</span> count(*) from employee10;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     <span class="number">1000</span> |</span><br><span class="line">|     <span class="number">1000</span> |</span><br><span class="line">|     <span class="number">1000</span> |</span><br><span class="line">|     <span class="number">1000</span> |</span><br><span class="line">|     <span class="number">1000</span> |</span><br><span class="line">|     <span class="number">1000</span> |</span><br><span class="line">|     <span class="number">1000</span> |</span><br><span class="line">|     <span class="number">1000</span> |</span><br><span class="line">|     <span class="number">1000</span> |</span><br><span class="line">|     <span class="number">1000</span> |</span><br><span class="line">+----------+</span><br><span class="line"><span class="number">10</span> rows in set (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test1] <span class="number">14</span>:<span class="number">52</span>:<span class="number">04</span> &gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="mysqldump导出"><a href="#mysqldump导出" class="headerlink" title="mysqldump导出"></a>mysqldump导出</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# mysqldump -uroot -p123456 test1 <span class="attribute">--set-gtid-purged</span>=OFF --opt -q <span class="attribute">--master-data</span>=2 --single-transaction -R --events --triggers &gt; test1_20170728.sql</span><br><span class="line">Warning: Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# ll test1_20170728.sql </span><br><span class="line">-rw-r--r-- 1 root root 206957 7月  28 15:16 test1_20170728.sql</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]#</span><br></pre></td></tr></table></figure>
<h3 id="重启导入"><a href="#重启导入" class="headerlink" title="重启导入"></a>重启导入</h3><p>可把test1库删除后，重启服务，重新创建test1库，把mysqldump出的文件再次导入。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li>像实验中案例，误删除ibdata1数据的经常会出现。 </li>
<li><font color="#dd0000">但是在最新的5.6.36版本中，不管是当前实验案例，还是直接从其他实例拷贝frm和ibd文件，在当前实例中重新创建表，再discard掉ibd文件，最后再import ibd文件，竟然没有报表空间ID不一致的错误。以前在5.5版本中，确认是会报表空间ID不一致情况，不确定是不是5.6版本改进了这方面的功能。</font><br>  </li>
<li>5.5版本版本恢复案例请参考(<a href="https://dbarobin.com/2016/04/23/ibd-recovery/)，思路不错。" target="_blank" rel="noopener">https://dbarobin.com/2016/04/23/ibd-recovery/)，思路不错。</a></li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/AWS-EC2搭建MHA-VIP-MySQL5-7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/AWS-EC2搭建MHA-VIP-MySQL5-7.html" itemprop="url">AWS EC2搭建MHA+VIP+MySQL5.7</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T16:51:22+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/集群高可用/" itemprop="url" rel="index">
                    <span itemprop="name">集群高可用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在AWS EC2结合MHA做MySQL的高可用，EC2不支持VIP，可通过绑定私有IP的方式来实现。</p>
<h2 id="MHA简介"><a href="#MHA简介" class="headerlink" title="MHA简介"></a>MHA简介</h2><p>MHA是由日本MySQL专家youshimaton(现就职于Facebook公司)用Perl写的一套MySQL故障切换方案，以保障数据库的高可用性。在MySQL故障切换过程中，MHA能做到在0~30s之内实现主MySQL故障转移。<br>该软件由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）。MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：Amazon Linux<br>master:172.31.13.126<br>slave:172.31.9.182<br>vip:172.31.0.200<br>其中，使用两台机器，分别部署主库和从库，MHA默认部署在从库上，下方中的VIP通指私有IP。  </p>
<h2 id="系统初始化修改"><a href="#系统初始化修改" class="headerlink" title="系统初始化修改"></a>系统初始化修改</h2><h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><h4 id="主库修改主机名"><a href="#主库修改主机名" class="headerlink" title="主库修改主机名"></a>主库修改主机名</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/sysconfig/network</span><br><span class="line"><span class="attribute">NETWORKING</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">HOSTNAME</span>=master</span><br></pre></td></tr></table></figure>
<h4 id="从库修改主机名"><a href="#从库修改主机名" class="headerlink" title="从库修改主机名"></a>从库修改主机名</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/sysconfig/network</span><br><span class="line"><span class="attribute">NETWORKING</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">HOSTNAME</span>=slave</span><br></pre></td></tr></table></figure>
<h3 id="修改时区"><a href="#修改时区" class="headerlink" title="修改时区"></a>修改时区</h3><p>Amazon Linux默认安装好后英国时间，需要在主库和从库修改时区<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# ln</span> -sf /usr/share/zone<span class="literal">inf</span>o/Asia/Shanghai /etc/localtime</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# /usr</span>/sbin/ntpdate <span class="number">0</span>.centos.pool.ntp.org &amp;&amp; /sbin/hwclock -w &amp;&gt;/dev/null</span><br></pre></td></tr></table></figure></p>
<h3 id="设置防火墙"><a href="#设置防火墙" class="headerlink" title="设置防火墙"></a>设置防火墙</h3><h4 id="主库设置，允许从库访问"><a href="#主库设置，允许从库访问" class="headerlink" title="主库设置，允许从库访问"></a>主库设置，允许从库访问</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/iptables status|grep <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span></span><br><span class="line"><span class="number">15</span>   ACCEPT     all  --  <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span>         <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>           </span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<p>其中，172.31.9.182是允许从库的访问规则</p>
<h4 id="从库设置，允许主库访问"><a href="#从库设置，允许主库访问" class="headerlink" title="从库设置，允许主库访问"></a>从库设置，允许主库访问</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# /etc/init.d/iptables status|grep <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span> </span><br><span class="line"><span class="number">15</span>   ACCEPT     all  --  <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span>        <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>           </span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<p>其中，172.31.13.126是允许主库的访问规则</p>
<h3 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h3><p>由于使用的操作系统为Amazon Linux，通过查看无selinux设置。</p>
<h2 id="建立SSH无密码登录"><a href="#建立SSH无密码登录" class="headerlink" title="建立SSH无密码登录"></a>建立SSH无密码登录</h2><h3 id="主库设置"><a href="#主库设置" class="headerlink" title="主库设置"></a>主库设置</h3><p>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no。<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# sed</span> '/^<span class="comment">#/d;/^$/d' /etc/ssh/ssh_config |grep GSSAPIAuthentication</span></span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# sed</span> '/^<span class="comment">#/d;/^$/d' /etc/ssh/sshd_config |grep -E 'PasswordAuthentication|PermitRootLogin'</span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PermitRootLogin forced-commands-only</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# /etc</span>/init.d/sshd restart</span><br><span class="line">停止 sshd：                                                [确定]</span><br><span class="line">正在启动 sshd：                                            [确定]</span><br></pre></td></tr></table></figure></p>
<p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">43:a3:80:f1:8c:d4:5e:8d:3c:99:e5:39:39:e3:89:9a root<span class="meta">@master</span></span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|<span class="string">  o. . *.        </span>|</span><br><span class="line">|<span class="string"> . *. B..o       </span>|</span><br><span class="line">|<span class="string">  o.+. .X        </span>|</span><br><span class="line">|<span class="string">    .. = *       </span>|</span><br><span class="line">|<span class="string">      o S        </span>|</span><br><span class="line">|<span class="string">     o   .       </span>|</span><br><span class="line">|<span class="string">    E            </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">+-----------------+</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.9.182</span></span><br><span class="line">The authenticity of host '172.31.9.182 (172.31.9.182)' can't be established.</span><br><span class="line">ECDSA key fingerprint is 72:71:66:dc:6c:b0:31:e7:6c:77:4c:8d:32:69:e0:88.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.9.182's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.9.182'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.13.126</span></span><br><span class="line">The authenticity of host '172.31.13.126 (172.31.13.126)' can't be established.</span><br><span class="line">ECDSA key fingerprint is b6:ef:9f:f0:5e:fd:8f:49:ef:be:79:fb:44:ea:63:08.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.13.126's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.13.126'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh 'root@172.31.9.182'</span></span><br><span class="line">Last login: Thu Jul 20 04:51:07 2017</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.9.182 closed.</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh 'root@172.31.13.126'</span></span><br><span class="line">Last login: Thu Jul 20 04:37:13 2017</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br></pre></td></tr></table></figure></p>
<h3 id="从库设置"><a href="#从库设置" class="headerlink" title="从库设置"></a>从库设置</h3><p>和主库的配置相同<br>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no。<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># sed <span class="string">'/^#/d;/^$/d'</span> /etc/ssh/ssh_config |grep GSSAPIAuthentication</span></span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># sed <span class="string">'/^#/d;/^$/d'</span> /etc/ssh/sshd_config |grep -E <span class="string">'PasswordAuthentication|PermitRootLogin'</span></span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PermitRootLogin forced-commands-only</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># /etc/init.d/sshd restart</span></span><br><span class="line">停止 sshd：                                                [确定]</span><br><span class="line">正在启动 sshd：                                            [确定]</span><br></pre></td></tr></table></figure></p>
<p>使用命令ssh-keygen生成公钥，发送到主库，同时尝试在从库无密码形式登录主库，而且也要保证本机无密码登录本机<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">7d:57:15:e0:20:6f:6f:45:00:76:c4:ba:66:32:fd:b3 root<span class="meta">@slave</span></span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|<span class="string">         . ++=ooo</span>|</span><br><span class="line">|<span class="string">          + +.. .</span>|</span><br><span class="line">|<span class="string">           o.. ..</span>|</span><br><span class="line">|<span class="string">         .... .. </span>|</span><br><span class="line">|<span class="string">        S o oo.  </span>|</span><br><span class="line">|<span class="string">         o *..   </span>|</span><br><span class="line">|<span class="string">          = .    </span>|</span><br><span class="line">|<span class="string">             o   </span>|</span><br><span class="line">|<span class="string">             Eo  </span>|</span><br><span class="line">+-----------------+</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">da:ea:e3:1c:fb:4b:f5:84:da:a3:47:ea:2c:fa:3c:a6 root<span class="meta">@slave</span></span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">           .     </span>|</span><br><span class="line">|<span class="string">        S o .    </span>|</span><br><span class="line">|<span class="string">       o +.o     </span>|</span><br><span class="line">|<span class="string">      o +oo .    </span>|</span><br><span class="line">|<span class="string">     o=*....     </span>|</span><br><span class="line">|<span class="string">    EBO**o       </span>|</span><br><span class="line">+-----------------+</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.13.126</span></span><br><span class="line">The authenticity of host '172.31.13.126 (172.31.13.126)' can't be established.</span><br><span class="line">ECDSA key fingerprint is b6:ef:9f:f0:5e:fd:8f:49:ef:be:79:fb:44:ea:63:08.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.13.126's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.13.126'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.9.182</span></span><br><span class="line">The authenticity of host '172.31.9.182 (172.31.9.182)' can't be established.</span><br><span class="line">ECDSA key fingerprint is 72:71:66:dc:6c:b0:31:e7:6c:77:4c:8d:32:69:e0:88.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.9.182's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.9.182'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh 'root@172.31.13.126'</span></span><br><span class="line">Last login: Thu Jul 20 05:36:57 2017 from 172.31.13.126</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh 'root@172.31.9.182' </span></span><br><span class="line">Last login: Thu Jul 20 05:36:46 2017 from 172.31.13.126</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.9.182 closed.</span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL安装"><a href="#MySQL安装" class="headerlink" title="MySQL安装"></a>MySQL安装</h2><p>使用的是自己打包的RPM包，分别登录主库和从库，直接rpm -ivh percona-server-5.7.18-15.x86_64.rpm 即可，也可使用其他方式安装MySQL<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mv /home/zhouting/percona-server-5.7.18-15.x86_64.rpm  /usr/src/</span><br><span class="line">[root@master ~]# rpm -ivh /usr/src/percona-server-5.7.18-15.x86_64.rpm </span><br><span class="line">Preparing<span class="built_in">..</span>.                          ################################# [100%]</span><br><span class="line">Updating / installing<span class="built_in">..</span>.</span><br><span class="line">   1:percona-server-5.7.18-15         ################################# [100%]</span><br><span class="line"><span class="builtin-name">error</span> reading information on<span class="built_in"> service </span>/etc/rc.d/init.d/mysqld: <span class="literal">No</span> such file <span class="keyword">or</span> directory</span><br><span class="line"> ERROR! MySQL (Percona Server) PID file could <span class="keyword">not</span> be found!</span><br><span class="line">Starting MySQL (Percona Server)<span class="built_in">..</span> SUCCESS! </span><br><span class="line">mysqladmin: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">Warning: Since password will be sent <span class="keyword">to</span><span class="built_in"> server </span><span class="keyword">in</span> plain text, use ssl<span class="built_in"> connection </span><span class="keyword">to</span> ensure password safety.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br></pre></td></tr></table></figure></p>
<p>查看是否安装成功，分别登录主库和从库查看<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">11</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">16</span>:<span class="number">57</span>:<span class="number">43</span> &gt; select <span class="built_in">version</span>();</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| <span class="built_in">version</span>()     |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">16</span>:<span class="number">57</span>:<span class="number">47</span> &gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL互为主备"><a href="#MySQL互为主备" class="headerlink" title="MySQL互为主备"></a>MySQL互为主备</h2><h3 id="重要参数配置"><a href="#重要参数配置" class="headerlink" title="重要参数配置"></a>重要参数配置</h3><p>主库必须包含以下参数<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># cat /etc/my.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 1</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 1</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br></pre></td></tr></table></figure></p>
<p>从库必须包含以下参数，注意slave需要动态设置read_only=1，<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/my.cnf </span><br><span class="line"><span class="meta">[mysqld]</span></span><br><span class="line">server-id = 2</span><br><span class="line">autocommit = 1</span><br><span class="line">auto<span class="emphasis">_increment_</span>increment = 2</span><br><span class="line">auto<span class="emphasis">_increment_</span>offset = 2</span><br><span class="line">log<span class="emphasis">_bin = mysql-bin</span></span><br><span class="line"><span class="emphasis">gtid_</span>mode = on</span><br><span class="line">enforce<span class="emphasis">_gtid_</span>consistency = 1</span><br><span class="line">log<span class="emphasis">_slave_</span>updates</span><br><span class="line">relay<span class="emphasis">_log_</span>purge=0</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e "show variables like <span class="emphasis">'read_only'</span>"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| read_</span>only     | OFF   |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e "set global read<span class="emphasis">_only=1"</span></span><br><span class="line"><span class="emphasis">Enter password: </span></span><br><span class="line"><span class="emphasis">[root@slave ~]# mysql -uroot -p -e "show variables like 'read_</span>only'"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| read_</span>only     | ON    |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="复制帐号建立"><a href="#复制帐号建立" class="headerlink" title="复制帐号建立"></a>复制帐号建立</h3><p>由于MySQL版本使用的是5.7，创建用户的方法以之前有些不同  </p>
<h4 id="主库创建"><a href="#主库创建" class="headerlink" title="主库创建"></a>主库创建</h4><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">6</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">16</span>:<span class="number">52</span> &gt; <span class="keyword">create</span> user <span class="string">'slave01'</span>@<span class="string">'172.31.9.182'</span> identified <span class="keyword">by</span> <span class="string">'slave123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">17</span>:<span class="number">21</span> &gt; grant replication slave,replication client <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'172.31.9.182'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">17</span>:<span class="number">34</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">17</span>:<span class="number">38</span> &gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>
<h4 id="从库创建"><a href="#从库创建" class="headerlink" title="从库创建"></a>从库创建</h4><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">6</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">19</span>:<span class="number">24</span> &gt; <span class="keyword">create</span> user <span class="string">'slave01'</span>@<span class="string">'172.31.13.126'</span> identified <span class="keyword">by</span> <span class="string">'slave123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">19</span>:<span class="number">49</span> &gt; grant replication slave,replication client <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'172.31.13.126'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">20</span>:<span class="number">02</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">20</span>:<span class="number">05</span> &gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>
<h4 id="复制帐号验证"><a href="#复制帐号验证" class="headerlink" title="复制帐号验证"></a>复制帐号验证</h4><p>主库登录从库<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -h172.31.9.182 -uslave01 -pslave123456</span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQ<span class="class">L monitor.  Commands end with ;</span><span class="built_in"> or </span>\g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC<span class="built_in"> and/or </span>its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle<span class="built_in"> and/or </span>its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation<span class="built_in"> and/or </span>its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;'<span class="built_in"> or </span>'\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:22:15 &gt; exit</span><br></pre></td></tr></table></figure></p>
<p>从库登录主库<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -h172.31.13.126 -uslave01 -pslave123456             </span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQ<span class="class">L monitor.  Commands end with ;</span><span class="built_in"> or </span>\g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC<span class="built_in"> and/or </span>its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle<span class="built_in"> and/or </span>its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation<span class="built_in"> and/or </span>its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;'<span class="built_in"> or </span>'\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:22:57 &gt; exit</span><br></pre></td></tr></table></figure></p>
<h3 id="复制关系配置"><a href="#复制关系配置" class="headerlink" title="复制关系配置"></a>复制关系配置</h3><h4 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h4><p>登录主库，设置复制关系，来源于从库的复制<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-p</span></span><br><span class="line"><span class="string">Enter</span> <span class="attr">password:</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">the</span> <span class="string">MySQL</span> <span class="string">monitor.</span>  <span class="string">Commands</span> <span class="string">end</span> <span class="string">with</span> <span class="string">;</span> <span class="string">or</span> <span class="string">\g.</span></span><br><span class="line"><span class="string">Your</span> <span class="string">MySQL</span> <span class="string">connection</span> <span class="string">id</span> <span class="string">is</span> <span class="number">17</span></span><br><span class="line"><span class="string">Server</span> <span class="attr">version:</span> <span class="number">5.7</span><span class="number">.18</span><span class="bullet">-15</span><span class="bullet">-log</span> <span class="string">PLD/Linux</span> <span class="string">Distribution</span> <span class="string">Percona</span> <span class="string">Server</span> <span class="string">RPM</span></span><br><span class="line"></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2009</span><span class="bullet">-2017</span> <span class="string">Percona</span> <span class="string">LLC</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2000</span><span class="string">,</span> <span class="number">2017</span><span class="string">,</span> <span class="string">Oracle</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates.</span> <span class="string">All</span> <span class="string">rights</span> <span class="string">reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Oracle</span> <span class="string">is</span> <span class="string">a</span> <span class="string">registered</span> <span class="string">trademark</span> <span class="string">of</span> <span class="string">Oracle</span> <span class="string">Corporation</span> <span class="string">and/or</span> <span class="string">its</span></span><br><span class="line"><span class="string">affiliates.</span> <span class="string">Other</span> <span class="string">names</span> <span class="string">may</span> <span class="string">be</span> <span class="string">trademarks</span> <span class="string">of</span> <span class="string">their</span> <span class="string">respective</span></span><br><span class="line"><span class="string">owners.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Type</span> <span class="string">'help;'</span> <span class="string">or</span> <span class="string">'\h'</span> <span class="string">for</span> <span class="string">help.</span> <span class="string">Type</span> <span class="string">'\c'</span> <span class="string">to</span> <span class="string">clear</span> <span class="string">the</span> <span class="string">current</span> <span class="string">input</span> <span class="string">statement.</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:32:19</span> <span class="string">&gt; change master to master_host='172.31.9.182',master_user='slave01',master_password='slave123456',master_auto_position=1;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected, 2 warnings (0.04 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:33:03 &gt; start slave;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:33:47 &gt; show slave status\G;</span></span><br><span class="line"><span class="string">*************************** 1. row ***************************</span></span><br><span class="line"><span class="string"></span><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">slave01</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">mysql-bin.000003</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">810</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">master-relay-bin.000002</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">1023</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">mysql-bin.000003</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">810</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">1231</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="string">a1c1d189-6b96-11e7-9825-02a13635a5ca</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">mysql.slave_master_info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">more</span> <span class="string">updates</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="attr">a1c1d189-6b96-11e7-9825-02a13635a5ca:1-3</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="number">9</span><span class="attr">a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17,</span></span><br><span class="line"><span class="attr">a1c1d189-6b96-11e7-9825-02a13635a5ca:</span><span class="number">1</span><span class="bullet">-3</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </span><br><span class="line"><span class="attr">                 Channel_Name:</span> </span><br><span class="line"><span class="attr">           Master_TLS_Version:</span> </span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ERROR:</span> </span><br><span class="line"><span class="literal">No</span> <span class="string">query</span> <span class="string">specified</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:33:54</span> <span class="string">&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h4><p>登录从库，设置复制关系，来源于主库的复制<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@slave</span> <span class="string">~]#</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-p</span></span><br><span class="line"><span class="string">Enter</span> <span class="attr">password:</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">the</span> <span class="string">MySQL</span> <span class="string">monitor.</span>  <span class="string">Commands</span> <span class="string">end</span> <span class="string">with</span> <span class="string">;</span> <span class="string">or</span> <span class="string">\g.</span></span><br><span class="line"><span class="string">Your</span> <span class="string">MySQL</span> <span class="string">connection</span> <span class="string">id</span> <span class="string">is</span> <span class="number">10</span></span><br><span class="line"><span class="string">Server</span> <span class="attr">version:</span> <span class="number">5.7</span><span class="number">.18</span><span class="bullet">-15</span><span class="bullet">-log</span> <span class="string">PLD/Linux</span> <span class="string">Distribution</span> <span class="string">Percona</span> <span class="string">Server</span> <span class="string">RPM</span></span><br><span class="line"></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2009</span><span class="bullet">-2017</span> <span class="string">Percona</span> <span class="string">LLC</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2000</span><span class="string">,</span> <span class="number">2017</span><span class="string">,</span> <span class="string">Oracle</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates.</span> <span class="string">All</span> <span class="string">rights</span> <span class="string">reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Oracle</span> <span class="string">is</span> <span class="string">a</span> <span class="string">registered</span> <span class="string">trademark</span> <span class="string">of</span> <span class="string">Oracle</span> <span class="string">Corporation</span> <span class="string">and/or</span> <span class="string">its</span></span><br><span class="line"><span class="string">affiliates.</span> <span class="string">Other</span> <span class="string">names</span> <span class="string">may</span> <span class="string">be</span> <span class="string">trademarks</span> <span class="string">of</span> <span class="string">their</span> <span class="string">respective</span></span><br><span class="line"><span class="string">owners.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Type</span> <span class="string">'help;'</span> <span class="string">or</span> <span class="string">'\h'</span> <span class="string">for</span> <span class="string">help.</span> <span class="string">Type</span> <span class="string">'\c'</span> <span class="string">to</span> <span class="string">clear</span> <span class="string">the</span> <span class="string">current</span> <span class="string">input</span> <span class="string">statement.</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:34:41</span> <span class="string">&gt; change master to master_host='172.31.13.126',master_user='slave01',master_password='slave123456',master_auto_position=1;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected, 2 warnings (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:35:14 &gt; start slave;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:35:15 &gt; show slave status\G;</span></span><br><span class="line"><span class="string">*************************** 1. row ***************************</span></span><br><span class="line"><span class="string"></span><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.139</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">slave01</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">4455</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">slave-relay-bin.000002</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">4059</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">4455</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">4266</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="number">9</span><span class="string">a7b78fc-6b96-11e7-9856-0232d9c5deea</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">mysql.slave_master_info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">more</span> <span class="string">updates</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="number">9</span><span class="attr">a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="number">9</span><span class="attr">a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17,</span></span><br><span class="line"><span class="attr">a1c1d189-6b96-11e7-9825-02a13635a5ca:</span><span class="number">1</span><span class="bullet">-3</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </span><br><span class="line"><span class="attr">                 Channel_Name:</span> </span><br><span class="line"><span class="attr">           Master_TLS_Version:</span> </span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ERROR:</span> </span><br><span class="line"><span class="literal">No</span> <span class="string">query</span> <span class="string">specified</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:35:18</span> <span class="string">&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="复制测试"><a href="#复制测试" class="headerlink" title="复制测试"></a>复制测试</h3><h4 id="主库登录测试"><a href="#主库登录测试" class="headerlink" title="主库登录测试"></a>主库登录测试</h4><p>登录主库，插入测试数据<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">37</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">35</span>:<span class="number">48</span> &gt; create database <span class="keyword">if</span> <span class="keyword">not</span> exists test11;use test11;                                                           </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">35</span>:<span class="number">52</span> &gt; create table <span class="keyword">if</span> <span class="keyword">not</span> exists t11(<span class="built_in">id</span> int unsigned <span class="keyword">not</span> null auto_increment,<span class="built_in">name</span> varchar(<span class="number">20</span>),primary key(`<span class="built_in">id</span>`));</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">35</span>:<span class="number">55</span> &gt; insert <span class="keyword">into</span> t11 values(null,'master11');</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">35</span>:<span class="number">58</span> &gt; select * <span class="keyword">from</span> t11;</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>     |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">|  <span class="number">1</span> | master11 |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">36</span>:<span class="number">02</span> &gt;</span><br></pre></td></tr></table></figure></p>
<p>登录从库，查看测试数据，此时数据已经复制过来<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -uroot -p </span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">29</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">36</span>:<span class="number">25</span> &gt; select * <span class="keyword">from</span> test11.t11;</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>     |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">|  <span class="number">1</span> | master11 |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">36</span>:<span class="number">30</span> &gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="从库登录测试"><a href="#从库登录测试" class="headerlink" title="从库登录测试"></a>从库登录测试</h4><p>登录从库，插入测试数据<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -uroot -p </span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">32</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">37</span>:<span class="number">59</span> &gt; create database <span class="keyword">if</span> <span class="keyword">not</span> exists test11;use test11;</span><br><span class="line">Query OK, <span class="number">1</span> row affected, <span class="number">1</span> warning (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">03</span> &gt; create table <span class="keyword">if</span> <span class="keyword">not</span> exists t22(<span class="built_in">id</span> int unsigned <span class="keyword">not</span> null auto_increment,<span class="built_in">name</span> varchar(<span class="number">20</span>),primary key(`<span class="built_in">id</span>`));     </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">18</span> &gt; insert <span class="keyword">into</span> t22 values(null,'slave11'); </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">30</span> &gt; select * <span class="keyword">from</span> t22;</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>    |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">|  <span class="number">2</span> | slave11 |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">35</span> &gt;</span><br></pre></td></tr></table></figure></p>
<p>登录主库，查看测试数据，此时数据已经复制过来<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">38</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">39</span>:<span class="number">09</span> &gt; select * <span class="keyword">from</span> test11.t22;</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>    |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">|  <span class="number">2</span> | slave11 |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">39</span>:<span class="number">15</span> &gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="MHA帐号建立"><a href="#MHA帐号建立" class="headerlink" title="MHA帐号建立"></a>MHA帐号建立</h3><h4 id="主库创建-1"><a href="#主库创建-1" class="headerlink" title="主库创建"></a>主库创建</h4><p>登录主库，创建允许主库和从库连接的MHA用户信息，再分别尝试使用MHA用户登录(省略)<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">41</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">36</span>:<span class="number">55</span> &gt; <span class="keyword">create</span> user <span class="string">'mha01'</span>@<span class="string">'172.31.9.182'</span> identified <span class="keyword">by</span> <span class="string">'mha123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">37</span>:<span class="number">14</span> &gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha01'</span>@<span class="string">'172.31.9.182'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">38</span>:<span class="number">02</span> &gt; <span class="keyword">create</span> user <span class="string">'mha01'</span>@<span class="string">'172.31.13.126'</span> identified <span class="keyword">by</span> <span class="string">'mha123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">38</span>:<span class="number">14</span> &gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha01'</span>@<span class="string">'172.31.13.126'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">38</span>:<span class="number">18</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="从库创建-1"><a href="#从库创建-1" class="headerlink" title="从库创建"></a>从库创建</h4><p>登录从库，由于复制已经把在主库创建的MHA用户信息复制了过来，尝试登录即可(省略)</p>
<h2 id="MHA安装"><a href="#MHA安装" class="headerlink" title="MHA安装"></a>MHA安装</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>分别在主库和从库上安装，执行命令：<br>yum -y install gcc gcc-c++ make openssl-devel perl perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Config-IniFiles perl-Time-HiRes perl-Module-Install.noarch mailx jwhois</p>
<h3 id="主库安装mha4mysql-node"><a href="#主库安装mha4mysql-node" class="headerlink" title="主库安装mha4mysql-node"></a>主库安装mha4mysql-node</h3><p>MHA管理端安装在从库上，主库上只需要mha4mysql-node即可，由于MySQL使用5.7版本，MHA也使用最新的0.57版本，采用编译安装方式。下载地址：<a href="https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw" target="_blank" rel="noopener">https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw</a><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cd</span> /usr/src/</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">src</span>]<span class="comment"># tar -zxf mha4mysql-node-0.57.tar.gz</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># perl Makefile.PL             #编译过程省略</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># make</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># make install</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># ll /usr/local/bin/ -t        #查看安装，有以下文件则mha4mysql-node安装成功</span></span><br><span class="line">total <span class="number">1760</span></span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root  <span class="number">16381</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">8261</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> purge_relay_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">7525</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> save_binary_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">4807</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p>
<h3 id="从库安装mha4mysql-manager和mha4mysql-node"><a href="#从库安装mha4mysql-manager和mha4mysql-node" class="headerlink" title="从库安装mha4mysql-manager和mha4mysql-node"></a>从库安装mha4mysql-manager和mha4mysql-node</h3><p>MHA管理端安装在从库，从库需要安装manager端和node端<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># cd /usr/src/</span></span><br><span class="line">[root@slave src]<span class="comment"># tar -zxf mha4mysql-manager-0.57.tar.gz </span></span><br><span class="line">[root@slave src]<span class="comment"># cd mha4mysql-manager-0.57</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># perl Makefile.PL           #编译过程省略</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># make</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># make install </span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># ll /usr/local/bin/ -t      #查看安装，有以下文件则mha4mysql-manager安装成功</span></span><br><span class="line">total 1756</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1779 </span>Jul<span class="number"> 21 </span>09:48 masterha_check_ssh</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 2517 </span>Jul<span class="number"> 21 </span>09:48 masterha_manager</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 2373 </span>Jul<span class="number"> 21 </span>09:48 masterha_master_switch</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 5171 </span>Jul<span class="number"> 21 </span>09:48 masterha_secondary_check</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1995 </span>Jul<span class="number"> 21 </span>09:48 masterha_check_repl</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1865 </span>Jul<span class="number"> 21 </span>09:48 masterha_check_status</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 3201 </span>Jul<span class="number"> 21 </span>09:48 masterha_conf_host</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 2165 </span>Jul<span class="number"> 21 </span>09:48 masterha_master_monitor</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1739 </span>Jul<span class="number"> 21 </span>09:48 masterha_stop</span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># cd ..</span></span><br><span class="line">[root@slave src]<span class="comment"># tar -zxf mha4mysql-node-0.57.tar.gz </span></span><br><span class="line">[root@slave src]<span class="comment"># cd mha4mysql-node-0.57</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># perl Makefile.PL              #编译过程省略        </span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># make</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># make install</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># ll /usr/local/bin/ -t         #查看安装，有以下文件则mha4mysql-node安装成功</span></span><br><span class="line">total 1800</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root <span class="number"> 16381 </span>Jul<span class="number"> 21 </span>09:54 apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 8261 </span>Jul<span class="number"> 21 </span>09:54 purge_relay_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 7525 </span>Jul<span class="number"> 21 </span>09:54 save_binary_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 4807 </span>Jul<span class="number"> 21 </span>09:54 filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p>
<h2 id="MHA目录结构说明"><a href="#MHA目录结构说明" class="headerlink" title="MHA目录结构说明"></a>MHA目录结构说明</h2><h3 id="MHAManager"><a href="#MHAManager" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>mhamanager工具包主要包括以下工具<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@slave  ~]<span class="comment"># ll /usr/local/bin/</span></span><br><span class="line">总用量 84</span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1995 </span>7月 <span class="number"> 19 </span>11:49 masterha_check_repl         <span class="comment">#检查MySQL复制情况</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1779 </span>7月 <span class="number"> 19 </span>11:49 masterha_check_ssh          <span class="comment">#检查MHA的SSH配置情况</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1865 </span>7月 <span class="number"> 19 </span>11:49 masterha_check_status       <span class="comment">#检测当前MHA运行状态</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 3201 </span>7月 <span class="number"> 19 </span>11:49 masterha_conf_host          <span class="comment">#添加或删除配置的server信息</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2517 </span>7月 <span class="number"> 19 </span>11:49 masterha_manager            <span class="comment">#启动MHA</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2165 </span>7月 <span class="number"> 19 </span>11:49 masterha_master_monitor     <span class="comment">#检测Master是否宕机</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2373 </span>7月 <span class="number"> 19 </span>11:49 masterha_master_switch      <span class="comment">#控制故障转移，自动或者手动</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 5172 </span>7月 <span class="number"> 19 </span>11:49 masterha_secondary_check    <span class="comment">#通过其他路由检测Master是否真的宕机</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1739 </span>7月 <span class="number"> 19 </span>11:49 masterha_stop               <span class="comment">#停止MHA</span></span><br></pre></td></tr></table></figure></p>
<h3 id="MHANode"><a href="#MHANode" class="headerlink" title="MHANode"></a>MHANode</h3><p>mhanode工具包主要包括以下工具<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master  ~]<span class="comment"># ll /usr/local/bin/</span></span><br><span class="line">总用量 44</span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root<span class="number"> 16371 </span>7月 <span class="number"> 19 </span>11:41 apply_diff_relay_logs       <span class="comment">#识别差异日志的中继日志，并将其差异事件应用于其他Slave</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 4807 </span>7月 <span class="number"> 19 </span>11:41 filter_mysqlbinlog          <span class="comment">#去除不必要的Rollback事件</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 8263 </span>7月 <span class="number"> 19 </span>11:41 purge_relay_logs            <span class="comment">#删除无用的Relay log，避免延时</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 7525 </span>7月 <span class="number"> 19 </span>11:41 save_binary_logs            <span class="comment">#保存和复制down掉的主服务器二进制日志</span></span><br></pre></td></tr></table></figure></p>
<h3 id="自定义扩展脚本说明"><a href="#自定义扩展脚本说明" class="headerlink" title="自定义扩展脚本说明"></a>自定义扩展脚本说明</h3><p>secondary_check_script          #通过多条网络路由检测master的可用性<br>master_ip_failover_script       #自动failover时候的切换脚本，可将vip信息写入此脚本中<br>shutdown_script                 #强制关闭master节点执行脚本<br>report_script                   #发送报告<br>init_conf_load_script           #加载初始配置参数，如不想在配置中写明文密码<br>master_ip_online_change_script  #手动failover时候的切换脚本  </p>
<h2 id="MHA扩展脚本"><a href="#MHA扩展脚本" class="headerlink" title="MHA扩展脚本"></a>MHA扩展脚本</h2><p>由于使用的AWS EC2，不支持VIP，可通过辅助IP的形式实现，这里使用脚本来辅助实现HA。</p>
<h3 id="aws-vip-change-sh"><a href="#aws-vip-change-sh" class="headerlink" title="aws_vip_change.sh"></a>aws_vip_change.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/aws_vip_change.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -lt 2 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Illegal param count.count = <span class="variable">$#</span>"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># High Availability IP variables</span></span><br><span class="line"><span class="comment"># Other node's IP to ping and VIP to swap if other node goes down</span></span><br><span class="line">VIP_ENI_ID=eni-7a5c7722</span><br><span class="line"></span><br><span class="line">NEW_MASTER_IP=<span class="variable">$1</span></span><br><span class="line">OLD_MASTER_IP=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"NEW_MASTER_IP=<span class="variable">$&#123;NEW_MASTER_IP&#125;</span>,OLD_MASTER_IP=<span class="variable">$&#123;OLD_MASTER_IP&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify the EC2 region that this will be running in   #以下为当前用户能够执行aws cli命令的key信息</span></span><br><span class="line">REGION=cn-north-1</span><br><span class="line">AWSAccessKeyId=AKIAPUXGZV6F6EKCOK7Q</span><br><span class="line">AWSSecretKey=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       </span><br><span class="line"></span><br><span class="line"><span class="comment"># Run aws-apitools-common.sh to set up default environment variables and to</span></span><br><span class="line"><span class="comment"># leverage AWS security credentials provided by EC2 roles</span></span><br><span class="line">. /etc/profile.d/aws-apitools-common.sh</span><br><span class="line"></span><br><span class="line">ACCESS_USER_OPTION=<span class="string">"--aws-access-key <span class="variable">$&#123;AWSAccessKeyId&#125;</span> --aws-secret-key <span class="variable">$&#123;AWSSecretKey&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">ssh -t -t root@<span class="variable">$&#123;OLD_MASTER_IP&#125;</span> /sbin/ifconfig eth4 down    <span class="comment">#其中eth4网卡名要与下文中，新申请ENI并绑定实例ID对应的网卡名相同</span></span><br><span class="line"></span><br><span class="line">VIP_ATTACHMENT_ID=`ec2-describe-network-interface-attribute <span class="variable">$&#123;VIP_ENI_ID&#125;</span> <span class="variable">$&#123;ACCESS_USER_OPTION&#125;</span> --region <span class="variable">$&#123;REGION&#125;</span> -a | grep ATTACHMENT -m 1 | awk <span class="string">'&#123;print $3;&#125;'</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"VIP_ATTACHMENT_ID=<span class="variable">$&#123;VIP_ATTACHMENT_ID&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">/opt/aws/bin/ec2-detach-network-interface <span class="variable">$&#123;VIP_ATTACHMENT_ID&#125;</span> <span class="variable">$&#123;ACCESS_USER_OPTION&#125;</span> --force --region <span class="variable">$&#123;REGION&#125;</span></span><br><span class="line">sleep 10</span><br><span class="line"></span><br><span class="line">INSTANCE_ID=`ssh root@<span class="variable">$&#123;NEW_MASTER_IP&#125;</span> /usr/bin/curl --silent http://169.254.169.254/latest/meta-data/instance-id`  <span class="comment">#其中169.254.169.254从本地链路中获取实例ID</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"INSTANCE_ID=<span class="variable">$&#123;INSTANCE_ID&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">/opt/aws/bin/ec2-attach-network-interface <span class="variable">$&#123;VIP_ENI_ID&#125;</span> -i <span class="variable">$&#123;INSTANCE_ID&#125;</span> -d 1 <span class="variable">$&#123;ACCESS_USER_OPTION&#125;</span> --region <span class="variable">$&#123;REGION&#125;</span></span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="master-ip-failover"><a href="#master-ip-failover" class="headerlink" title="master_ip_failover"></a>master_ip_failover</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/master_ip_failover </span></span><br><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">#  it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">#  GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment">#   along with this program; if not, write to the Free Software</span></span><br><span class="line"><span class="comment">#  Foundation, Inc.,</span></span><br><span class="line"><span class="comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## <span class="doctag">Note:</span> This is a sample script and is not complete. Modify the script based on your environment.</span></span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line">use Getopt::Long;</span><br><span class="line">use MHA::DBHelper;</span><br><span class="line"></span><br><span class="line">my (</span><br><span class="line">  <span class="variable">$command</span>,        <span class="variable">$ssh_user</span>,         <span class="variable">$orig_master_host</span>,</span><br><span class="line">  <span class="variable">$orig_master_ip</span>, <span class="variable">$orig_master_port</span>, <span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="variable">$new_master_ip</span>,  <span class="variable">$new_master_port</span>,  <span class="variable">$new_master_user</span>,</span><br><span class="line">  <span class="variable">$new_master_password</span></span><br><span class="line">);</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'command=s'</span>             =&gt; \<span class="variable">$command</span>,</span><br><span class="line">  <span class="string">'ssh_user=s'</span>            =&gt; \<span class="variable">$ssh_user</span>,</span><br><span class="line">  <span class="string">'orig_master_host=s'</span>    =&gt; \<span class="variable">$orig_master_host</span>,</span><br><span class="line">  <span class="string">'orig_master_ip=s'</span>      =&gt; \<span class="variable">$orig_master_ip</span>,</span><br><span class="line">  <span class="string">'orig_master_port=i'</span>    =&gt; \<span class="variable">$orig_master_port</span>,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>     =&gt; \<span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="string">'new_master_ip=s'</span>       =&gt; \<span class="variable">$new_master_ip</span>,</span><br><span class="line">  <span class="string">'new_master_port=i'</span>     =&gt; \<span class="variable">$new_master_port</span>,</span><br><span class="line">  <span class="string">'new_master_user=s'</span>     =&gt; \<span class="variable">$new_master_user</span>,</span><br><span class="line">  <span class="string">'new_master_password=s'</span> =&gt; \<span class="variable">$new_master_password</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line">sub main &#123;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="variable">$command</span> eq <span class="string">"stop"</span> || <span class="variable">$command</span> eq <span class="string">"stopssh"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># $orig_master_host, $orig_master_ip, $orig_master_port are passed.</span></span><br><span class="line">    <span class="comment"># If you manage master ip address at global catalog database,</span></span><br><span class="line">    <span class="comment"># invalidate orig_master_ip here.</span></span><br><span class="line">    my <span class="variable">$exit_code</span> = <span class="number">1</span>;</span><br><span class="line">    eval &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment"># updating global catalog, etc</span></span><br><span class="line">      <span class="variable">$exit_code</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">      warn <span class="string">"Got Error: $@\n"</span>;</span><br><span class="line">      <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  elsif ( <span class="variable">$command</span> eq <span class="string">"start"</span> ) &#123;</span><br><span class="line">    my <span class="variable">$exit_code</span> = <span class="number">10</span>;</span><br><span class="line">    my @vip_change_cmd = (<span class="string">"/usr/local/bin/aws_vip_change.sh"</span>,<span class="variable">$new_master_host</span>,<span class="variable">$orig_master_host</span>);</span><br><span class="line">    system @vip_change_cmd;</span><br><span class="line">    <span class="variable">$exit_code</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">      warn <span class="variable">$@</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment"># If you want to continue failover, exit 10.</span></span><br><span class="line">      <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  elsif ( <span class="variable">$command</span> eq <span class="string">"status"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># do nothing</span></span><br><span class="line">    <span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    &amp;usage();</span><br><span class="line">    <span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub usage &#123;</span><br><span class="line">  print</span><br><span class="line"><span class="string">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="send-report"><a href="#send-report" class="headerlink" title="send_report"></a>send_report</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/send_report </span></span><br><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">strict</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">warnings</span> <span class="title">FATAL</span> =&gt; '<span class="title">all</span>';</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mail</span>::<span class="title">Sender</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Getopt</span>::<span class="title">Long</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span></span><br><span class="line">my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );</span><br><span class="line">my $smtp=<span class="string">'smtp.126.com'</span>;</span><br><span class="line">my $mail_from=<span class="string">'xxx@126.com'</span>;</span><br><span class="line">my $mail_user=<span class="string">'xxx@126.com'</span>;</span><br><span class="line">my $mail_pass=<span class="string">'xxx'</span>;</span><br><span class="line"><span class="comment">#my $mail_to=['xxx','xxx'];</span></span><br><span class="line">my $mail_to=<span class="string">'xxx'</span>;</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'orig_master_host=s'</span> =&gt; \$dead_master_host,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span><br><span class="line">  <span class="string">'new_slave_hosts=s'</span>  =&gt; \$new_slave_hosts,</span><br><span class="line">  <span class="string">'subject=s'</span>          =&gt; \$subject,</span><br><span class="line">  <span class="string">'body=s'</span>             =&gt; \$body,</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);</span><br><span class="line"> </span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_;</span><br><span class="line">    open my $DEBUG, <span class="string">"&gt; /var/log/masterha/app1/manager.log"</span></span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Can't open the debug      file:$!\n"</span>;</span><br><span class="line">    my $sender = <span class="keyword">new</span> Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; <span class="string">'text/plain; charset=utf-8'</span>,</span><br><span class="line">        encoding    =&gt; <span class="string">'utf-8'</span>,</span><br><span class="line">        smtp        =&gt; $smtp,</span><br><span class="line">        from        =&gt; $mail_from,</span><br><span class="line">        auth        =&gt; <span class="string">'LOGIN'</span>,</span><br><span class="line">        TLS_allowed =&gt; <span class="string">'0'</span>,</span><br><span class="line">        authid      =&gt; $user,</span><br><span class="line">        authpwd     =&gt; $passwd,</span><br><span class="line">        to          =&gt; $mail_to,</span><br><span class="line">        subject     =&gt; $subject,</span><br><span class="line">        debug       =&gt; $DEBUG</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    $sender-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; $msg,</span><br><span class="line">            debug =&gt; $DEBUG</span><br><span class="line">        &#125;</span><br><span class="line">    ) <span class="keyword">or</span> <span class="keyword">print</span> $Mail::Sender::Error;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Do whatever you want here</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">exit</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<h2 id="主库手动绑定ENI和实例关系"><a href="#主库手动绑定ENI和实例关系" class="headerlink" title="主库手动绑定ENI和实例关系"></a>主库手动绑定ENI和实例关系</h2><p>在主库上先申请新的ENI，注意申请时先绑定的group，以满足其他EC2能够连接些ENI。<br>申请成功后，根据新的ENI和当前主实例的实例ID绑定，最终确认新的VIP是否绑定上。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">ifconfig</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:E6:0B:68:5C:1C</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.13.126</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::e6:bff:fe68:5c1c/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:4063</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:3292</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:691839</span> <span class="string">(675.6</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:390499</span> <span class="string">(381.3</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="string">::1/128</span> <span class="attr">Scope:Host</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">aws</span> <span class="string">ec2</span> <span class="string">create-network-interface</span> <span class="bullet">--subnet-id</span> <span class="string">subnet-33859151</span> <span class="bullet">--private-ip-address</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.200</span> <span class="bullet">--groups</span> <span class="string">sg-e50a1c87</span> <span class="string">sg-6b1f0809</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "NetworkInterface":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">        "Status":</span> <span class="string">"pending"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "MacAddress":</span> <span class="string">"02:12:25:83:a0:22"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "SourceDestCheck":</span> <span class="literal">true</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "VpcId":</span> <span class="string">"vpc-b18195d3"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "Description":</span> <span class="string">""</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "NetworkInterfaceId":</span> <span class="string">"eni-7a5c7722"</span><span class="string">,</span>   <span class="comment">#新申请的ENI名字</span></span><br><span class="line"><span class="attr">        "PrivateIpAddresses":</span> <span class="string">[</span></span><br><span class="line">            <span class="string">&#123;</span></span><br><span class="line"><span class="attr">                "PrivateDnsName":</span> <span class="string">"ip-172-31-0-200.cn-north-1.compute.internal"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "Primary":</span> <span class="literal">true</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "PrivateIpAddress":</span> <span class="string">"172.31.0.200"</span>  <span class="comment">#新ENI绑定的私有IP</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">],</span> </span><br><span class="line"><span class="attr">        "RequesterManaged":</span> <span class="literal">false</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "Groups":</span> <span class="string">[</span></span><br><span class="line">            <span class="string">&#123;</span></span><br><span class="line"><span class="attr">                "GroupName":</span> <span class="string">"For Mysql"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "GroupId":</span> <span class="string">"sg-e50a1c87"</span></span><br><span class="line">            <span class="string">&#125;,</span> </span><br><span class="line">            <span class="string">&#123;</span></span><br><span class="line"><span class="attr">                "GroupName":</span> <span class="string">"OnlySSH-Allow"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "GroupId":</span> <span class="string">"sg-6b1f0809"</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">],</span> </span><br><span class="line"><span class="attr">        "PrivateDnsName":</span> <span class="string">"ip-172-31-0-200.cn-north-1.compute.internal"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "AvailabilityZone":</span> <span class="string">"cn-north-1a"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "RequesterId":</span> <span class="string">"AIDAPVDKK6NLF6SZ553KS"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "SubnetId":</span> <span class="string">"subnet-33859151"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "OwnerId":</span> <span class="string">"981100955930"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "TagSet":</span> <span class="string">[],</span> </span><br><span class="line"><span class="attr">        "PrivateIpAddress":</span> <span class="string">"172.31.0.200"</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">aws</span> <span class="string">ec2</span> <span class="string">attach-network-interface</span> <span class="bullet">--network-interface-id</span> <span class="string">eni-7a5c7722</span> <span class="bullet">--instance-id</span> <span class="string">i-0a259e4950b0b3cf9</span> <span class="bullet">--device-index</span> <span class="number">1</span>    <span class="comment">#将ENI和实例绑定</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "AttachmentId":</span> <span class="string">"eni-attach-2b2c9345"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">ifconfig</span>   <span class="comment">#查看ip：172.31.0.200已绑定成功，同时要在其他EC2确定此安全组是否能够满足需求，否则还需要重新调整。</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:E6:0B:68:5C:1C</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.13.126</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::e6:bff:fe68:5c1c/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:5435</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:4190</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:810999</span> <span class="string">(791.9</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:501986</span> <span class="string">(490.2</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">eth4</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:12:25:83:A0:22</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.0.200</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::12:25ff:fe83:a022/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:11</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:26</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:1218</span> <span class="string">(1.1</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:2664</span> <span class="string">(2.6</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="string">::1/128</span> <span class="attr">Scope:Host</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span></span><br></pre></td></tr></table></figure></p>
<h2 id="从库配置MHAManager"><a href="#从库配置MHAManager" class="headerlink" title="从库配置MHAManager"></a>从库配置MHAManager</h2><p>创建配置目录/etc/masterha/，同时创建一个项目上的配置文件，仅配置自动FailOver部分，只需要master_ip_failover和report_script脚本，其他脚本暂时不定义。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mkdir -p /etc/masterha/</span></span><br><span class="line">[root@slave ~]<span class="comment"># cd /etc/masterha/</span></span><br><span class="line">[root@slave masterha]<span class="comment"># </span></span><br><span class="line">[root@slave masterha]<span class="comment"># cat app1.cnf </span></span><br><span class="line">[server default]</span><br><span class="line">manager_workdir=/var/log/masterha/app1                              <span class="comment">#manager工作目录</span></span><br><span class="line">manager_log=/var/log/masterha/app1/manager.log                      <span class="comment">#manager日志</span></span><br><span class="line">master_binlog_dir=/hwdata/data/percona                              <span class="comment">#mysql数据目录</span></span><br><span class="line">password=mha123456                                                  <span class="comment">#mha连接密码</span></span><br><span class="line">user=mha01                                                          <span class="comment">#mha连接用户</span></span><br><span class="line">ping_interval=1                                                     <span class="comment">#监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行failover</span></span><br><span class="line">remote_workdir=/tmp                                                 <span class="comment">#远端mysql在发生切换时binlog的保存位置</span></span><br><span class="line">repl_password=slave123456                                           <span class="comment">#复制密码</span></span><br><span class="line">repl_user=slave01                                                   <span class="comment">#复制用户</span></span><br><span class="line">ssh_user=root                                                       <span class="comment">#ssh用户</span></span><br><span class="line">master_ip_failover_script=/usr/local/bin/master_ip_failover         <span class="comment">#自动failover切换脚本</span></span><br><span class="line"><span class="comment">#master_ip_online_change_script= /usr/local/bin/master_ip_online_change      #手动failover切换脚本</span></span><br><span class="line">report_script=/usr/local/bin/send_report                            <span class="comment">#报告发送脚本(不是必须)</span></span><br><span class="line"><span class="comment">#shutdown_script=                                                   #故障发生后关闭主机的脚本(不是必须)</span></span><br><span class="line">secondary_check_script = masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306 <span class="comment">#通过第三方机器确认目标主库是否存活，这里的ip可换成其他机器，用于检测</span></span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname=172.31.13.126                                              <span class="comment">#主库地址</span></span><br><span class="line">port=3306</span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">hostname=172.31.9.182                                               <span class="comment">#从库地址</span></span><br><span class="line">port=3306</span><br><span class="line">candidate_master=1                                                  <span class="comment">#候选master</span></span><br></pre></td></tr></table></figure></p>
<h2 id="测试MHAManager-SSH"><a href="#测试MHAManager-SSH" class="headerlink" title="测试MHAManager SSH"></a>测试MHAManager SSH</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_ssh <span class="attribute">--conf</span>=/etc/masterha/app1.cnf </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">info</span>] Starting SSH<span class="built_in"> connection </span>tests<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@172.31.13.126(172.31.13.126:22) <span class="keyword">to</span> root@172.31.9.182(172.31.9.182:22)<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Mon Jul 24 13:58:05 2017 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@172.31.9.182(172.31.9.182:22) <span class="keyword">to</span> root@172.31.13.126(172.31.13.126:22)<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Mon Jul 24 13:58:05 2017 - [<span class="builtin-name">info</span>] All SSH<span class="built_in"> connection </span>tests passed successfully.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h2 id="测试MHAManager-复制"><a href="#测试MHAManager-复制" class="headerlink" title="测试MHAManager 复制"></a>测试MHAManager 复制</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_repl <span class="attribute">--conf</span>=/etc/masterha/app1.cnf </span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">info</span>] MHA::MasterMonitor version 0.57.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Master configurations are as below: </span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating <span class="keyword">from</span> 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating <span class="keyword">from</span> 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] GTID failover mode = 1</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Dead Servers:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Alive Servers:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Alive Slaves:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   172.31.9.182(172.31.9.182:3306)  <span class="attribute">Version</span>=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]     GTID ON</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Current Alive Master: 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking slave configurations<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking replication filtering settings<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  Replication filtering check ok.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] GTID (with auto-pos) is supported. Skipping all SSH <span class="keyword">and</span> Node package checking.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking SSH publickey authentication<span class="built_in"> settings </span>on the current master<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] HealthCheck: SSH <span class="keyword">to</span> 172.31.13.126 is reachable.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking replication<span class="built_in"> health </span>on 172.31.9.182<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   /usr/local/bin/master_ip_failover <span class="attribute">--command</span>=status <span class="attribute">--ssh_user</span>=root <span class="attribute">--orig_master_host</span>=172.31.13.126 <span class="attribute">--orig_master_ip</span>=172.31.13.126 <span class="attribute">--orig_master_port</span>=3306 </span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  OK.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">warning</span>] shutdown_script is <span class="keyword">not</span> defined.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Got exit code 0 (<span class="keyword">Not</span> master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication<span class="built_in"> Health </span>is OK.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h2 id="启动MHAManager"><a href="#启动MHAManager" class="headerlink" title="启动MHAManager"></a>启动MHAManager</h2><h3 id="启动进程"><a href="#启动进程" class="headerlink" title="启动进程"></a>启动进程</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta"># nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;</span></span><br><span class="line">[<span class="meta">1</span>] <span class="number">4439</span></span><br><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta"># nohup: ignoring input and appending output to ‘nohup.out’</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta">#</span></span><br></pre></td></tr></table></figure>
<h3 id="查看启动日志"><a href="#查看启动日志" class="headerlink" title="查看启动日志"></a>查看启动日志</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># cat /var/log/masterha/app1/manager.log </span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:10<span class="number"> 2017 </span>- [info] MHA::MasterMonitor version 0.57.  <span class="comment">#检查版本</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306) <span class="comment">#获取当前主节点ip</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Master configurations are as below:   <span class="comment">#获取复制结构</span></span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating from 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating from 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] GTID failover mode =<span class="number"> 1 </span>   <span class="comment">#GTID模式</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Alive Servers:            <span class="comment">#当前在线实例列表</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Alive Slaves:             <span class="comment">#当前在线slave列表及版本信息</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Current Alive Master: 172.31.13.126(172.31.13.126:3306)   <span class="comment">#当前主实例信息</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking slave configurations..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]  binlog_do_db= , binlog_ignore_db=                        <span class="comment">#复制过滤</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] HealthCheck: SSH to 172.31.13.126 is reachable.           <span class="comment">#ssh可用</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)                                          <span class="comment">#再次确认当前复制架构</span></span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 </span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]  OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [warning] shutdown_script is not defined.                        <span class="comment">#shutdown_script脚本未定义    </span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Set master ping interval<span class="number"> 1 </span>seconds.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Set secondary check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306                                                <span class="comment">#第三方检查登录</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Starting ping health check on 172.31.13.126(172.31.13.126:3306)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Ping(SELECT) succeeded, waiting until MySQL doesn't respond.. <span class="comment">#启动成功，等待failover</span></span><br><span class="line">[root@slave masterha]<span class="comment"># ps aux|grep master</span></span><br><span class="line">root     <span class="number"> 4439 </span> 0.0  0.2<span class="number"> 287004 </span>23636 pts/0    S    14:04   0:00 perl /usr/local/bin/masterha_manager --conf=/etc/masterha/app1.cnf <span class="comment">#进程存在</span></span><br><span class="line">root     <span class="number"> 5008 </span> 0.0  0.0<span class="number"> 110456 </span><span class="number"> 2092 </span>pts/0    S+   14:13   0:00 grep --color=auto master</span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="模拟主库故障"><a href="#模拟主库故障" class="headerlink" title="模拟主库故障"></a>模拟主库故障</h2><h3 id="确认当前VIP状态"><a href="#确认当前VIP状态" class="headerlink" title="确认当前VIP状态"></a>确认当前VIP状态</h3><p>在主库上执行停止服务，观察MHAManager日志，并确认VIP是否切换到从库上<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>       #确认当前<span class="selector-tag">VIP</span>：<span class="selector-tag">172</span><span class="selector-class">.31</span><span class="selector-class">.0</span><span class="selector-class">.200</span>在主库上</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:E6</span><span class="selector-pseudo">:0B</span><span class="selector-pseudo">:68</span><span class="selector-pseudo">:5C</span><span class="selector-pseudo">:1C</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.13.126</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::e6</span><span class="selector-pseudo">:bff</span><span class="selector-pseudo">:fe68</span><span class="selector-pseudo">:5c1c</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:9629</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8119</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1202679</span> (<span class="number">1.1</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1113439</span> (<span class="number">1.0</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth4</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:25</span><span class="selector-pseudo">:83</span><span class="selector-pseudo">:A0</span><span class="selector-pseudo">:22</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.0.200</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::12</span><span class="selector-pseudo">:25ff</span><span class="selector-pseudo">:fe83</span><span class="selector-pseudo">:a022</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:4</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:4</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:562</span> (<span class="number">562.0</span> b)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:600</span> (<span class="number">600.0</span> b)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-pseudo">::1</span>/<span class="selector-tag">128</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Host</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:90</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:90</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17324</span> (<span class="number">16.9</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17324</span> (<span class="number">16.9</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure></p>
<h3 id="确认MHAManger进程状态"><a href="#确认MHAManger进程状态" class="headerlink" title="确认MHAManger进程状态"></a>确认MHAManger进程状态</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@slave</span> <span class="string">masterha]#</span> <span class="string">ps</span> <span class="string">aux|grep</span> <span class="string">master</span></span><br><span class="line"><span class="string">root</span>     <span class="number">11333</span>  <span class="number">0.4</span>  <span class="number">0.2</span> <span class="number">287004</span> <span class="number">23604</span> <span class="string">pts/0</span>    <span class="string">S</span>    <span class="number">15</span><span class="string">:36</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">perl</span> <span class="string">/usr/local/bin/masterha_manager</span> <span class="bullet">--conf=/etc/masterha/app1.cnf</span></span><br><span class="line"><span class="string">root</span>     <span class="number">11377</span>  <span class="number">0.0</span>  <span class="number">0.0</span> <span class="number">110456</span>  <span class="number">2252</span> <span class="string">pts/0</span>    <span class="string">S+</span>   <span class="number">15</span><span class="string">:37</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">grep</span> <span class="bullet">--color=auto</span> <span class="string">master</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">masterha]#</span> <span class="string">cd</span> <span class="string">/var/log/masterha/app1/</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">ll</span></span><br><span class="line"><span class="string">total</span> <span class="number">8</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>   <span class="number">36</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:37</span> <span class="string">app1.master_status.health</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">2833</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:36</span> <span class="string">manager.log</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">cat</span> <span class="string">manager.log</span> <span class="string">|tail</span> <span class="bullet">-2</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:36:54</span> <span class="number">2017</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Starting</span> <span class="string">ping</span> <span class="string">health</span> <span class="string">check</span> <span class="string">on</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:36:54</span> <span class="number">2017</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Ping(SELECT)</span> <span class="string">succeeded,</span> <span class="string">waiting</span> <span class="string">until</span> <span class="string">MySQL</span> <span class="string">doesn't</span> <span class="string">respond..</span>     <span class="comment">#正在等待主库FailOver</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">ifconfig</span>     <span class="comment">#当前从库没有存在VIP：172.31.0.200</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:0E:FB:F1:E9:4E</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.9.182</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::e:fbff:fef1:e94e/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:16565</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:17269</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:2084631</span> <span class="string">(1.9</span> <span class="string">MiB)</span>  <span class="string">TX</span> <span class="attr">bytes:2304176</span> <span class="string">(2.1</span> <span class="string">MiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="string">::1/128</span> <span class="attr">Scope:Host</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:2556</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:2556</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:605471</span> <span class="string">(591.2</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:605471</span> <span class="string">(591.2</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span></span><br></pre></td></tr></table></figure>
<h3 id="停止主库服务，触发主库FailOver"><a href="#停止主库服务，触发主库FailOver" class="headerlink" title="停止主库服务，触发主库FailOver"></a>停止主库服务，触发主库FailOver</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">mysqld</span> <span class="selector-tag">stop</span>                    #服务停止</span><br><span class="line"><span class="selector-tag">Shutting</span> <span class="selector-tag">down</span> <span class="selector-tag">MySQL</span> (Percona Server)............ <span class="selector-tag">SUCCESS</span>! </span><br><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>                                   <span class="selector-id">#VIP</span>已经不存在</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:E6</span><span class="selector-pseudo">:0B</span><span class="selector-pseudo">:68</span><span class="selector-pseudo">:5C</span><span class="selector-pseudo">:1C</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.13.126</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::e6</span><span class="selector-pseudo">:bff</span><span class="selector-pseudo">:fe68</span><span class="selector-pseudo">:5c1c</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:10242</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8535</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1256340</span> (<span class="number">1.1</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1175340</span> (<span class="number">1.1</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-pseudo">::1</span>/<span class="selector-tag">128</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Host</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:92</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:92</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17424</span> (<span class="number">17.0</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17424</span> (<span class="number">17.0</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure>
<h3 id="观察FailOver日志"><a href="#观察FailOver日志" class="headerlink" title="观察FailOver日志"></a>观察FailOver日志</h3><p>登录从库，查看MHAManager日志<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]<span class="comment"># cat manager.log </span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:52<span class="number"> 2017 </span>- [info] MHA::MasterMonitor version 0.57.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Master configurations are as below: </span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating from 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating from 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] GTID failover mode = 1</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Alive Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Alive Slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Current Alive Master: 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking slave configurations..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] HealthCheck: SSH to 172.31.13.126 is reachable.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]  OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [warning] shutdown_script is not defined.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Set master ping interval<span class="number"> 1 </span>seconds.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Set secondary check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Starting ping health check on 172.31.13.126(172.31.13.126:3306)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Ping(SELECT) succeeded, waiting until MySQL doesn't respond..         <span class="comment">#等待主库FailOver</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [warning] Got error on MySQL select ping:<span class="number"> 2006 </span>(MySQL server has gone away)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] Executing secondary network check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306  --user=root  --master_host=172.31.13.126  --master_ip=172.31.13.126  --master_port=3306 --master_user=mha01 --master_password=mha123456 --ping_type=SELECT</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] Executing SSH check script: exit 0</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] HealthCheck: SSH to 172.31.13.126 is reachable.</span><br><span class="line">Monitoring server 172.31.13.126 is reachable, Master is not reachable from 172.31.13.126. OK.</span><br><span class="line">Monitoring server 172.31.9.182 is reachable, Master is not reachable from 172.31.9.182. OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] Master is not reachable from all other monitoring servers. Failover should start.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:02<span class="number"> 2017 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '172.31.13.126' (111))</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:02<span class="number"> 2017 </span>- [warning] Connection failed<span class="number"> 2 </span>time(s)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:03<span class="number"> 2017 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '172.31.13.126' (111))</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:03<span class="number"> 2017 </span>- [warning] Connection failed<span class="number"> 3 </span>time(s)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '172.31.13.126' (111))</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Connection failed<span class="number"> 4 </span>time(s)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Master is not reachable from health checker!</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Master 172.31.13.126(172.31.13.126:3306) is not reachable!</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] SSH is reachable.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [info] Connecting to a master server failed. Reading configuration file /etc/masterha_default.cnf and /etc/masterha/app1.cnf again, and trying to connect to all servers to check server status..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] GTID failover mode = 1</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Alive Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Alive Slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Checking slave configurations..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Master is down!</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Terminating monitoring script.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Got exit code<span class="number"> 20 </span>(Master dead).</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] MHA::MasterFailover version 0.57.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Starting master failover.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] * Phase 1: Configuration Check Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] GTID failover mode = 1</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Checking master reachability via MySQL(double check)...</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Alive Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Alive Slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Starting GTID based failover.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] ** Phase 1: Configuration Check Phase completed.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 2: Dead Master Shutdown Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Forcing shutdown so that applications never connect to the current master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Executing master IP deactivation script:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 --command=stopssh --ssh_user=root  </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  done.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 2: Dead Master Shutdown Phase completed.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3: Master Recovery Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3.1: Getting Latest Slaves Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] The latest binary log file/position on all slaves is mysql-bin.000011:234</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Latest slaves (Slaves that received relay log files to the latest):</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] The oldest binary log file/position on all slaves is mysql-bin.000011:234</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Oldest slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3.3: Determining New Master Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Searching new master from slaves..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Candidate masters from the configuration file:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Non-candidate masters:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Searching from candidate_master slaves which have received the latest relay log events..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] New master is 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Starting master failover..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">From:</span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">To:</span><br><span class="line">172.31.9.182(172.31.9.182:3306) (new master)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3.3: New Master Recovery Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Waiting all logs to be applied.. </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   done.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Getting new master's binlog name and position..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  mysql-bin.000008:234</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='172.31.9.182', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='slave01', MASTER_PASSWORD='xxx';</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000008, 234, 28a037e5-6d0f-11e7-b43a-02e60b685c1c:1-15,</span><br><span class="line">39292a50-6d0f-11e7-999e-020efbf1e94e:1-4</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Executing master IP activate script:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --command=start --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 --new_master_host=172.31.9.182 --new_master_ip=172.31.9.182 --new_master_port=3306 --new_master_user='mha01'   --new_master_password=xxx</span><br><span class="line">NEW_MASTER_IP=172.31.9.182,OLD_MASTER_IP=172.31.13.126</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br><span class="line">VIP_ATTACHMENT_ID=eni-attach-5b219e35</span><br><span class="line">ATTACHMENT              eni-attach-5b219e35     detaching</span><br><span class="line">INSTANCE_ID=i-03135a59c242e9bad</span><br><span class="line">eni-attach-0f209f61</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info]  OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] Setting read_only=0 on 172.31.9.182(172.31.9.182:3306)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info]  ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] ** Finished master recovery successfully.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 3: Master Recovery Phase completed.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 4: Slaves Recovery Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 4.1: Starting Slaves in parallel..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] All new slave servers recovered successfully.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 5: New master cleanup phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] Resetting slave info on the new master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info]  172.31.9.182: Resetting slave info succeeded.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] Master failover to 172.31.9.182(172.31.9.182:3306) completed successfully.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line"></span><br><span class="line">----- Failover Report --<span class="yaml"><span class="meta">---</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="attr">app1:</span> <span class="string">MySQL</span> <span class="string">Master</span> <span class="string">failover</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">succeeded</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Master</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">is</span> <span class="string">down!</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Check</span> <span class="string">MHA</span> <span class="string">Manager</span> <span class="string">logs</span> <span class="string">at</span> <span class="attr">slave:/var/log/masterha/app1/manager.log</span> <span class="string">for</span> <span class="string">details.</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Started</span> <span class="string">automated(non-interactive)</span> <span class="string">failover.</span></span></span><br><span class="line"><span class="yaml"><span class="string">Invalidated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address</span> <span class="string">on</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span></span></span><br><span class="line"><span class="yaml"><span class="string">Selected</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">as</span> <span class="string">a</span> <span class="string">new</span> <span class="string">master.</span></span></span><br><span class="line"><span class="yaml"><span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Applying</span> <span class="string">all</span> <span class="string">logs</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Activated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address.</span></span></span><br><span class="line"><span class="yaml"><span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="string">Resetting</span> <span class="string">slave</span> <span class="string">info</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="string">Master</span> <span class="string">failover</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">completed</span> <span class="string">successfully.</span></span></span><br><span class="line"><span class="yaml"><span class="string">Mon</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">16</span><span class="string">:27:13</span> <span class="number">2017</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Sending</span> <span class="string">mail..</span></span></span><br><span class="line"><span class="yaml"><span class="string">defined(@array)</span> <span class="string">is</span> <span class="string">deprecated</span> <span class="string">at</span> <span class="string">/usr/share/perl5/vendor_perl/Mail/Sender.pm</span> <span class="string">line</span> <span class="number">318.</span></span></span><br><span class="line"><span class="yaml">        <span class="string">(Maybe</span> <span class="string">you</span> <span class="string">should</span> <span class="string">just</span> <span class="string">omit</span> <span class="string">the</span> <span class="string">defined()?)</span></span></span><br><span class="line"><span class="yaml"><span class="string">defined(@array)</span> <span class="string">is</span> <span class="string">deprecated</span> <span class="string">at</span> <span class="string">/usr/share/perl5/vendor_perl/Mail/Sender.pm</span> <span class="string">line</span> <span class="number">2693.</span></span></span><br><span class="line"><span class="yaml">        <span class="string">(Maybe</span> <span class="string">you</span> <span class="string">should</span> <span class="string">just</span> <span class="string">omit</span> <span class="string">the</span> <span class="string">defined()?)</span></span></span><br><span class="line"><span class="yaml"><span class="string">Option</span> <span class="string">new_slave_hosts</span> <span class="string">requires</span> <span class="string">an</span> <span class="string">argument</span></span></span><br><span class="line"><span class="yaml"><span class="string">Unknown</span> <span class="attr">option:</span> <span class="string">conf</span></span></span><br><span class="line"><span class="yaml"><span class="attr">tail:</span> <span class="string">manager.log:</span> <span class="string">file</span> <span class="string">truncated</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">220</span> <span class="number">126.</span><span class="string">com</span> <span class="string">Anti-spam</span> <span class="string">GT</span> <span class="string">for</span> <span class="string">Coremail</span> <span class="string">System</span> <span class="string">(126com[20140526])</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">EHLO</span> <span class="string">slave</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-mail</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-PIPELINING</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-AUTH</span> <span class="string">LOGIN</span> <span class="string">PLAIN</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-AUTH=LOGIN</span> <span class="string">PLAIN</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-coremail</span> <span class="number">1</span><span class="string">Uxr2xKj7kG0xkI17xGrU7I0s8FY2U3Uj8Cz28x1UUUUU7Ic2I0Y2Ur0Vl_3UCa0xDrUUUUj</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-STARTTLS</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="number">8</span><span class="string">BITMIME</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">AUTH</span> <span class="string">LOGIN</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">334</span> <span class="string">dXNlcm5hbWU6</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">ZHdqNTY4NTg4QDEyNi5jb20=</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">334</span> <span class="string">UGFzc3dvcmQ6</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">RHdqMTIzNDU=</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">235</span> <span class="string">Authentication</span> <span class="string">successful</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">MAIL</span> <span class="attr">FROM:&lt;dwj568588@126.com&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="string">Mail</span> <span class="string">OK</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">RCPT</span> <span class="attr">TO:&lt;duanwenjie@huan.tv&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="string">Mail</span> <span class="string">OK</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">DATA</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">354</span> <span class="string">End</span> <span class="string">data</span> <span class="string">with</span> <span class="string">&lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">To:</span> <span class="string">duanwenjie@huan.tv</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">From:</span> <span class="string">dwj568588@126.com</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Subject:</span> <span class="attr">app1:</span> <span class="string">MySQL</span> <span class="string">Master</span> <span class="string">failover</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">succeeded</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Date:</span> <span class="string">Mon,</span> <span class="number">24</span> <span class="string">Jul</span> <span class="number">2017</span> <span class="number">16</span><span class="string">:27:15</span> <span class="string">+0800</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">X-Mailer:</span> <span class="string">Perl</span> <span class="string">script</span> <span class="string">"send_report"</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span>      <span class="string">using</span> <span class="attr">Mail::Sender</span> <span class="number">0.8</span><span class="number">.16</span> <span class="string">by</span> <span class="string">Jenda</span> <span class="string">Krynicky,</span> <span class="string">Czechlands</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span>      <span class="string">running</span> <span class="string">on</span> <span class="string">slave</span> <span class="string">()</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span>      <span class="string">under</span> <span class="string">account</span> <span class="string">"zhouting"</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Message-ID:</span> <span class="string">&lt;20170724_082715_056339.dwj568588@126.com&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">MIME-Version:</span> <span class="number">1.0</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Content-type:</span> <span class="string">text/plain;</span> <span class="string">charset=utf-8</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Master</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">is</span> <span class="string">down!</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Check</span> <span class="string">MHA</span> <span class="string">Manager</span> <span class="string">logs</span> <span class="string">at</span> <span class="attr">slave:/var/log/masterha/app1/manager.log</span> <span class="string">for</span> <span class="string">details.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Started</span> <span class="string">automated(non-interactive)</span> <span class="string">failover.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Invalidated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address</span> <span class="string">on</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Selected</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">as</span> <span class="string">a</span> <span class="string">new</span> <span class="string">master.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Applying</span> <span class="string">all</span> <span class="string">logs</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Activated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="string">Resetting</span> <span class="string">slave</span> <span class="string">info</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Master</span> <span class="string">failover</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">completed</span> <span class="string">successfully.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="string">Mail</span> <span class="string">OK</span> <span class="string">queued</span> <span class="string">as</span> <span class="string">smtp1,C8mowAAH7yZhr3VZFR+JCA--.54250S2</span> <span class="number">1500884834</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">QUIT</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">221</span> <span class="string">Bye</span></span></span><br><span class="line"><span class="yaml"><span class="string">[root@slave</span> <span class="string">app1]#</span></span></span><br></pre></td></tr></table></figure></p>
<h3 id="日志过程解析"><a href="#日志过程解析" class="headerlink" title="日志过程解析"></a>日志过程解析</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">启动前的准备工作</span><br><span class="line">检查数据库服务器状态,获取相关参数设置</span><br><span class="line">检查GTID、candidate_master、过滤DB是否设置</span><br><span class="line">测试ssh连接是否成功</span><br><span class="line">测试MHA <span class="keyword">node</span><span class="title">是否可用</span></span><br><span class="line"><span class="title">创建MHA</span>日志目录</span><br><span class="line">开始检查<span class="literal">slave</span>的差异日志应用权限</span><br><span class="line">确定当前的复制架构</span><br><span class="line">调试master_ip_failover_script</span><br><span class="line">调试shutdown_script</span><br><span class="line">设置二次检查的主机masterha_secondary_check</span><br><span class="line">MHA启动完毕,进入监测状态</span><br><span class="line">监测<span class="literal">master</span>服务器挂了</span><br><span class="line">通过定义的二次监测,确认<span class="literal">master</span>是否挂了</span><br><span class="line">确认<span class="literal">master</span>挂了,开始进入failover流程</span><br><span class="line">再试尝试连接<span class="literal">master</span>和<span class="literal">master</span>的ssh</span><br><span class="line">通过MHA配置文件,监测其他<span class="literal">slave</span>的状态</span><br><span class="line">再次监测<span class="literal">slave</span>的配置是否有变化,是否符合failover条件</span><br><span class="line">正式开始failover</span><br><span class="line">再次对<span class="literal">slave</span>配置做检查</span><br><span class="line">对原<span class="literal">Master</span>做master_ip_failover_script和shutdown_script的操作</span><br><span class="line">开始差异日志的恢复，获取<span class="literal">slave</span>最后得到的binlog位置</span><br><span class="line">获取原<span class="literal">master</span>的binlog日志</span><br><span class="line">确定新的<span class="literal">master</span></span><br><span class="line">在new <span class="literal">master</span>上应用差异的binlog日志</span><br><span class="line">获取new <span class="literal">master</span>的binlog位置。</span><br><span class="line">执行master_ip_failover_script,调用aws_vip_change.sh，执行VIP漂移</span><br><span class="line">开始恢复其他<span class="literal">slave</span>的差异日志</span><br><span class="line">差异日志应用完成以后,切换所有<span class="literal">slave</span>到new <span class="literal">master</span>。</span><br><span class="line">failover操作完成,生成failover报告</span><br><span class="line">最后发送邮件通知</span><br></pre></td></tr></table></figure>
<h3 id="确认FailOver状态"><a href="#确认FailOver状态" class="headerlink" title="确认FailOver状态"></a>确认FailOver状态</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@slave app1]</span># <span class="selector-tag">ifconfig</span>             <span class="selector-id">#vip</span>已经添加到从库上</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:FB</span><span class="selector-pseudo">:F1</span><span class="selector-pseudo">:E9</span><span class="selector-pseudo">:4E</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.9.182</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::e</span><span class="selector-pseudo">:fbff</span><span class="selector-pseudo">:fef1</span><span class="selector-pseudo">:e94e</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:17060</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:17883</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:2142676</span> (<span class="number">2.0</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:2390595</span> (<span class="number">2.2</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth1</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:25</span><span class="selector-pseudo">:83</span><span class="selector-pseudo">:A0</span><span class="selector-pseudo">:22</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.0.200</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::12</span><span class="selector-pseudo">:25ff</span><span class="selector-pseudo">:fe83</span><span class="selector-pseudo">:a022</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:18</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:798</span> (<span class="number">798.0</span> b)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1828</span> (<span class="number">1.7</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-pseudo">::1</span>/<span class="selector-tag">128</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Host</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:2789</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:2789</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:669913</span> (<span class="number">654.2</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:669913</span> (<span class="number">654.2</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@slave app1]</span>#</span><br></pre></td></tr></table></figure>
<h3 id="查看邮件发送状态"><a href="#查看邮件发送状态" class="headerlink" title="查看邮件发送状态"></a>查看邮件发送状态</h3><p>登录邮件，查看是否收到报警邮件。<br><img src="http://note.youdao.com/yws/public/resource/bba80193f9c2d29f073784f4e498b134/xmlnote/0A43FC640BD84154ADCD175F765F82E1/33468" alt="image">  </p>
<h3 id="手动FailOver"><a href="#手动FailOver" class="headerlink" title="手动FailOver"></a>手动FailOver</h3><p>MHA的手动FailOver不在本文范围，详情理论可参考官方文档。  </p>
<h3 id="参数列表"><a href="#参数列表" class="headerlink" title="参数列表"></a>参数列表</h3><table>
<thead>
<tr>
<th>参数名</th>
<th>是否必须</th>
<th>参数使用域</th>
<th>默认值</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr>
<td>hostname</td>
<td>Yes</td>
<td>Local Only</td>
<td>-</td>
<td>hostname=master,hostname=slave</td>
</tr>
<tr>
<td>ip</td>
<td>No</td>
<td>Local Only</td>
<td>gethostbyname($hostname)</td>
<td>ip=192.168.1.100</td>
</tr>
<tr>
<td>port</td>
<td>No</td>
<td>Local/App/Global</td>
<td>3306</td>
<td>port=3306</td>
</tr>
<tr>
<td>ssh_host</td>
<td>No</td>
<td>Local Only</td>
<td>same as hostname</td>
<td>ssh_host=master,ssh_host=slave</td>
</tr>
<tr>
<td>ssh_ip</td>
<td>No</td>
<td>Local Only</td>
<td>gethostbyname($ssh_host)</td>
<td>ssh_ip=192.168.1.101</td>
</tr>
<tr>
<td>ssh_port</td>
<td>No</td>
<td>Local/App/Global</td>
<td>22</td>
<td>ssh_port=22</td>
</tr>
<tr>
<td>ssh_connection_timeout</td>
<td>No</td>
<td>Local/App/Global</td>
<td>5</td>
<td>ssh_connection_timeout=20</td>
</tr>
<tr>
<td>ssh_options</td>
<td>No</td>
<td>Local/App/Global</td>
<td>“”(empty string)</td>
<td>ssh_options=”-i /root/.ssh/id_dsa2”</td>
</tr>
<tr>
<td>candidate_master</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>candidate_master=1</td>
</tr>
<tr>
<td>no_master</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>no_master=1</td>
</tr>
<tr>
<td>ignore_fail</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>ignore_fail=1</td>
</tr>
<tr>
<td>skip_init_ssh_check</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>skip_init_ssh_check=1</td>
</tr>
<tr>
<td>skip_reset_slave</td>
<td>No</td>
<td>Local/App/Global</td>
<td>0</td>
<td>skip_reset_slave=1</td>
</tr>
<tr>
<td>user</td>
<td>No</td>
<td>Local/App/Global</td>
<td>root</td>
<td>user=root</td>
</tr>
<tr>
<td>password</td>
<td>No</td>
<td>Local/App/Global</td>
<td>“”(empty string)</td>
<td>password=rootpass</td>
</tr>
<tr>
<td>repl_user</td>
<td>No</td>
<td>Local/App/Global</td>
<td>Master_User value from SHOW SLAVE STATUS</td>
<td>repl_user=repl</td>
</tr>
<tr>
<td>repl_password</td>
<td>No</td>
<td>Local/App/Global</td>
<td>(current replication password)</td>
<td>repl_user=replpass</td>
</tr>
<tr>
<td>disable_log_bin</td>
<td>No</td>
<td>Local/App/Global</td>
<td>0</td>
<td>disable_log_bin=1</td>
</tr>
<tr>
<td>master_pid_file</td>
<td>No</td>
<td>Local/App/Global</td>
<td>“”(empty string)</td>
<td>master_pid_file=/var/lib/mysql/master1.pid</td>
</tr>
<tr>
<td>ssh_user</td>
<td>No</td>
<td>Local/App/Global</td>
<td>current OS user</td>
<td>ssh_user=root</td>
</tr>
<tr>
<td>remote_workdir</td>
<td>No</td>
<td>Local/App/Global</td>
<td>/var/tmp</td>
<td>remote_workdir=/var/log/masterha/app1</td>
</tr>
<tr>
<td>master_binlog_dir</td>
<td>No</td>
<td>Local/App/Global</td>
<td>/var/lib/mysql</td>
<td>master_binlog_dir=/data/mysql1</td>
</tr>
<tr>
<td>log_level</td>
<td>No</td>
<td>App/Global</td>
<td>info</td>
<td>log_level=debug</td>
</tr>
<tr>
<td>manager_workdir</td>
<td>No</td>
<td>App</td>
<td>/var/tmp</td>
<td>manager_workdir=/var/log/masterha</td>
</tr>
<tr>
<td>client_bindir</td>
<td>No</td>
<td>App</td>
<td>-</td>
<td>client_bindir=/usr/mysql/bin</td>
</tr>
<tr>
<td>client_libdir</td>
<td>No</td>
<td>App</td>
<td>-</td>
<td>client_libdir=/usr/lib/mysql</td>
</tr>
<tr>
<td>manager_log</td>
<td>No</td>
<td>App</td>
<td>STDERR</td>
<td>manager_log=/var/log/masterha/app1.log</td>
</tr>
<tr>
<td>check_repl_delay</td>
<td>No</td>
<td>App/Global</td>
<td>1</td>
<td>check_repl_delay=0</td>
</tr>
<tr>
<td>check_repl_filter</td>
<td>No</td>
<td>App/Global</td>
<td>1</td>
<td>check_repl_filter=0</td>
</tr>
<tr>
<td>latest_priority</td>
<td>No</td>
<td>App/Global</td>
<td>1</td>
<td>latest_priority=0</td>
</tr>
<tr>
<td>multi_tier_slave</td>
<td>No</td>
<td>App/Global</td>
<td>0</td>
<td>multi_tier_slave=1</td>
</tr>
<tr>
<td>ping_interval</td>
<td>No</td>
<td>App/Global</td>
<td>3</td>
<td>ping_interval=5</td>
</tr>
<tr>
<td>ping_type</td>
<td>No</td>
<td>App/Global</td>
<td>SELECT</td>
<td>ping_type=CONNECT</td>
</tr>
<tr>
<td>secondary_check_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>secondary_check_script= masterha_secondary_check -s remote_dc1 -s remote_dc2</td>
</tr>
<tr>
<td>master_ip_failover_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>master_ip_failover_script=/usr/local/bin/master_ip_failover</td>
</tr>
<tr>
<td>master_ip_online_change_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>master_ip_online_change_script= /usr/local/bin/master_ip_online_change</td>
</tr>
<tr>
<td>shutdown_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>shutdown_script= /usr/local/bin/master_shutdown</td>
</tr>
<tr>
<td>report_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>report_script= /usr/local/bin/report</td>
</tr>
</tbody>
</table>
<h4 id="详情解释"><a href="#详情解释" class="headerlink" title="详情解释"></a>详情解释</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">Local Scope:        针对每个server级别有效的选项.local scope级别的参数需要在配置文件的 [server_xxx]段落配置  </span><br><span class="line">App Scope:          这个参数可以理解为针对一组master-slave集群. 这些参数需要在 [server_default]段落配置  </span><br><span class="line">Global Scope:       这个参数针对所有的MHA管理的实例. global scope级别的配置只有你在使用一个manager server管理多组master-slave时使用 </span><br><span class="line">hostname：          目标Mysql服务器的主机名或者IP地址,这个参数是强制的,并且必须配置在[server_xxx]段落</span><br><span class="line">ip：                目标Mysql服务器的IP地址,默认是通过$hostname变量获取.MHA manager和MHA Node</span><br><span class="line">                    内部使用这个IP地址链接到Mysql和SSH.通常你不需要配置这个参数,因为它可以通过$hostname解析获得</span><br><span class="line">port：              mysql服务器使用的端口号,默认是3306,MHA链接到mysql通过IP地址和端口</span><br><span class="line">ssh_host：          从0.53版本开始支持此参数,此参数的主要目的在于你mysql复制使用的IP地址由于安全策略,不能直接连接,</span><br><span class="line">                    所以需要通过其他IP和端口连接到mysql server或者ssh,默认这个参数和hostname的值相同</span><br><span class="line">ssh_ip：            从0.53版本开始支持此参数,连接到目标mysql server的ssh ip地址,默认从$ssh_host获取</span><br><span class="line">ssh_port：          从0.53版本开始支持此参数,连接到目标mysql server的ssh端口,默认是22</span><br><span class="line">ssh_connection_timeout：从0.54开始支持此参数,默认是5秒,添加此参数的原因是以前我们在程序里面写死了</span><br><span class="line">ssh_options：       从0.53开始支持此参数,可以添加SSH命令行的参数</span><br><span class="line">candidate_master：  </span><br><span class="line">你的slave的硬件配置或者用途可能不太一样,你想要提升更加可靠的slave作为新的master</span><br><span class="line">如果设置candidate_master的值为1,那么这个server会优先成为master,只要它满足成为master的条件(binlog开启的,没有严重的复制延时等)</span><br><span class="line">所以意味着配置了candiate_master=1的服务器并不是肯定可以成为new master,但是这个参数能够帮助提高优先级</span><br><span class="line">如果你在多个服务器上设置了candidate_master=1,那么在配置文件中[server_xxx]的配置顺序,会成为第二排序规则,排在上面的越优先</span><br><span class="line">no_master：         no_master=1是默认值,意思是这个server从来不会成为新的master,这个参数用来标记某些从来不用成为new master的服务器</span><br><span class="line">ignore_fail：       </span><br><span class="line">默认是0,当某个slave的ssh或者mysql当掉或者复制失败的时候,MHA manager不启动failover。</span><br><span class="line">但是有些环境下,你想要在某个特定的slave失败的时候继续执行failover,把么就设置这个ignore_fail=1,即时这个slave失败的时候,failover依然继续执行</span><br><span class="line">skip_init_ssh_check：启动的时候跳过ssh连接测试</span><br><span class="line">skip_reset_slave：  从0.56版本开始支持此参数,在master执行failover以后跳过执行<span class="keyword">reset</span> <span class="keyword">slave</span> all(译者感觉应该是方便MM复制的后期恢复)</span><br><span class="line"><span class="keyword">user</span>：              mysql管理员命令,建议赋予all <span class="keyword">privileges</span>权限</span><br><span class="line"><span class="keyword">password</span>：          上面mysql <span class="keyword">user</span>的密码</span><br><span class="line">repl_user：         mysql复制使用的用户名,需要执行<span class="keyword">change</span> <span class="keyword">master</span> <span class="keyword">to</span>命令和<span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>命令等.一般赋予<span class="keyword">replication</span> <span class="keyword">slave</span>,<span class="keyword">replication</span> <span class="keyword">client</span>权限</span><br><span class="line">repl_password：     上面用户对应的密码.默认情况下,使用的是当前复制的密码</span><br><span class="line">disable_log_bin：   当这个参数设置以后,当应用差异日志到<span class="keyword">slave</span>的时候,<span class="keyword">slave</span>不会生成binlog. Internally MHA passes <span class="comment">--disable-log-bin to mysqlbinlog command</span></span><br><span class="line">master_pid_file：   设置<span class="keyword">master</span>的pid文件位置,当你的服务器上运行了多个mysql的时候使用</span><br><span class="line">ssh_user：          </span><br><span class="line">MHA manager和MHA node通过这个用户连接到mysql <span class="keyword">server</span>的OS上,在对应的OS上执行相关命令和拷贝差异日志等等</span><br><span class="line">这个用户必须有读取mysql <span class="built_in">binary</span>/relay 相关日志文件的权限,还有日志目录的写入权限.(remote_workdir目录)</span><br><span class="line">这个用户必须可以直接连接到服务器上,不用任何交互的操作.通过使用ssh <span class="keyword">public</span> <span class="keyword">key</span>作为认证方式.默认使用的用户是manager当前的用户</span><br><span class="line">remote_workdir：    </span><br><span class="line">每个MHA node上,MHA工作使用的目录的绝对路径.如果目录不存在,MHA会自动创建,如果权限不够,那么MHA node会意外终止,</span><br><span class="line">注意MHA manager和MHA node都不会检查这个目录的磁盘可用空间,你需要自己保证有足够的可用空间.默认的remote_workdir是<span class="string">'/var/tmp'</span></span><br><span class="line">master_binlog_dir： </span><br><span class="line"><span class="keyword">master</span> mysql保存<span class="keyword">binlog</span>的目录的绝对路径.如果参数的主要目的是在<span class="keyword">master</span> mysql宕机以后,为了通过ssh拷贝需要的<span class="keyword">binlog</span> <span class="keyword">event</span></span><br><span class="line">这个参数是需要的,因为当mysql宕机以后,没法自动获取<span class="built_in">binary</span> <span class="keyword">log</span>的目录</span><br><span class="line">默认情况下,master_binlog_dir的值是<span class="string">"/var/lib/mysql/,/var/log/mysql/"</span>,/<span class="keyword">var</span>/lib/mysql/是大部分mysql发布版本的默认mysql输出目录,</span><br><span class="line">你可以设置多个目录,使用逗号分隔.比如(/data1,/data2,/data3)</span><br><span class="line">log_level：         MHA manager 的日志级别,默认是info级别,在大多数环境下没有问题.可用的级别有.debug/info/<span class="keyword">warning</span>/<span class="keyword">error</span></span><br><span class="line">manager_workdir：   MHA manager使用的工作目录,如果没有设置,默认使用/<span class="keyword">var</span>/tmp</span><br><span class="line">client_bindir：     如果mysql命令行工具没有安装在默认目录,可以使用这个选项配置</span><br><span class="line">client_libdir：     如果mysql lib没有安装在默认目录,可以使用这个选项配置</span><br><span class="line">manager_log：       MHA manager日志文件的绝对目录和文件名,如果没有设置,那么将直接打印到标准输出和标准错误输出</span><br><span class="line">当执行交互式的<span class="keyword">failover</span>时,MHA manager将会忽略manager_log设置,直接答应到标准输出和标准错误输出</span><br><span class="line">check_repl_delay：  </span><br><span class="line">默认情况下如果一个<span class="keyword">slave</span>比<span class="keyword">master</span>延时了<span class="number">100</span>M的relay logs.MHA不会选择这个<span class="keyword">slave</span>作为新的master.因为他需要更多的时间来<span class="keyword">recovery</span></span><br><span class="line">设置check_repl_delay=<span class="number">0</span>,MHA在选择<span class="keyword">new</span> <span class="keyword">master</span>时将会忽略复制的延时.这个参数通常和candidate_master=<span class="number">1</span>同时使用</span><br><span class="line">check_repl_filter： </span><br><span class="line">默认情况下如果<span class="keyword">master</span>和<span class="keyword">slave</span>有不同的<span class="built_in">binary</span> <span class="keyword">log</span>/<span class="keyword">replication</span> 过滤规则的话,MHA打印错误,不进行<span class="keyword">start</span> <span class="keyword">monitoring</span>或者<span class="keyword">failover</span></span><br><span class="line">这么做的目的是为了避免<span class="keyword">recover</span>的时候出现意外的错误,例如<span class="string">"Table not exists"</span>,如果你<span class="number">100</span>%确定你不同的过滤规则不会导致<span class="keyword">recover</span>时候报错,</span><br><span class="line">那么你可以设置check_repl_fiter=<span class="number">0</span>,这样的话,MHA在应用差异日志的时候将不会在检查过滤规则.使用这个参数的时候需要非常小心</span><br><span class="line">latest_priority：   默认情况下,接收到了最新的<span class="keyword">binlog</span>的<span class="keyword">slave</span>优先被选为<span class="keyword">new</span> <span class="keyword">master</span>,如果你想要控制优先级的顺序,比如(host2&gt;host3&gt;host4),那么设置latest_priority=<span class="number">0</span>会有所帮助</span><br><span class="line">multi_tier_slave：  </span><br><span class="line">MHA manager从<span class="number">0.5</span><span class="number">.2</span>开始支持多主复制.默认情况下,它不支持三层以上的复制架构.例如,host2是host1的<span class="keyword">slave</span>,host3是host2的<span class="keyword">slave</span>,</span><br><span class="line">默认不允许把这个三个主机写到同一个配置文件中因为这是一个三层的复制架构,并且MHA会因此报错,并停止工作.如果设置了multi_tier_slave,</span><br><span class="line">MHA manager不会因为多层架构而终止,它会忽略三层及以上的主机,例如<span class="keyword">master</span>(host1)挂掉以后,host2会被选为新的<span class="keyword">master</span>,host3将继续从host2复制</span><br><span class="line">ping_interval：     </span><br><span class="line">这个参数声明MHA manager pings(通过执行<span class="keyword">sql</span>来ping) <span class="keyword">master</span>的间隔.当连续三次ping失败,MHA manager认为这个Mysql <span class="keyword">master</span>宕机,从宕机到检测到宕机,</span><br><span class="line">最大的消耗时间是这个参数的四倍,这个参数默认值是<span class="number">3</span>(<span class="number">3</span>秒),如果MHA manager因为权限问题多次连接失败,这不认为<span class="keyword">master</span> dead</span><br><span class="line">ping_type：</span><br><span class="line">从MHA manager <span class="number">0.53</span>开始支持这个参数, MHA建立一个长连接到<span class="keyword">master</span>,然后通过执行<span class="string">"SELECT 1"</span> (ping_type=<span class="keyword">SELECT</span>)来判断<span class="keyword">master</span>是否可用</span><br><span class="line">但是在一些环境下,最好使用短连接的方式,因为这样的方式更严格,也能检测TCP连接级别的失败.设置ping_type=<span class="keyword">CONNECT</span>可以实现.从<span class="number">0.56</span>版本开始,支持ping_type=<span class="keyword">INSERT</span></span><br><span class="line">secondary_check_script：</span><br><span class="line">通常情况,强力推荐使用两个或者多个路由检测Mysql <span class="keyword">master</span>默认MHA通过一个路由检测:从manager到master.这是不推荐的</span><br><span class="line">MHA manager可以通过secondary_check_script参数调用一个内部脚本来实现两个或者多个路由的检测.下面是一个配置实例</span><br><span class="line">secondary_check_script = masterha_secondary_check -s remote_host1 -s remote_host2</span><br><span class="line">MHA manager包含masterha_secondary_check 脚本.内置的masterha_secondary_check脚本可以满足大多是环境,当然你也可以调用你自定义的脚本.</span><br><span class="line">在上面的实例中,MHA manager通过这两个路由检测<span class="keyword">master</span>主机</span><br><span class="line">Manager-(A)-&gt;remote_host1-(B)-&gt;master_host</span><br><span class="line">Manager-(A)-&gt;remote_host2-(B)-&gt;master_host</span><br><span class="line">如果两条路径中,A都是成功的,B都是不成功的,那么masterha_secondary_check将会退出,返回状态<span class="number">0.</span>MHA manager将会认为Mysql <span class="keyword">master</span>宕机,开始<span class="keyword">failover</span></span><br><span class="line">如果A失败,那么masterha_secondary_check将退出,返回状态<span class="number">2</span>,MHA manager网络出现问题,不会开始<span class="keyword">failover</span></span><br><span class="line">如果B检测成功,masterha_secondary_check退出并返回状态<span class="number">3</span>,MHA manager明确的知道mysql <span class="keyword">master</span>是活跃的,不开始<span class="keyword">failover</span></span><br><span class="line">通常来讲,remote_host1和remote_host2必须和 MHA manager及Mysql <span class="keyword">server</span>不在同一个网段,这样才更有意义</span><br><span class="line">MHA调用secondary_check_script参数对应的脚本会自动传递以下参数(所以你不需要在配置文件中设置),</span><br><span class="line">masterha_secondary_check适用于大多数环境,如果你需要其他的功能可以自己写一个网络检查的脚本.</span><br><span class="line"><span class="comment">--user=(SSH username of the remote hosts. ssh_user parameter value will be passed)</span></span><br><span class="line"><span class="comment">--master_host=(master's hostname)</span></span><br><span class="line"><span class="comment">--master_ip=(master's ip address)</span></span><br><span class="line"><span class="comment">--master_port=(master's port number)</span></span><br><span class="line">注意:</span><br><span class="line">masterha_secondary_check脚本依赖于IO::Socket::INET perl包,在perl v5<span class="number">.6</span><span class="number">.0</span>中默认包含,masterha_secondary_check脚本会通过</span><br><span class="line">ssh连接到所有的remote servers.所以SSH <span class="keyword">public</span> <span class="keyword">key</span> 认证需要设置.另外masterha_secondary_check脚本尝试使用TCP连接从remote <span class="keyword">server</span>到mysql master.这意味着服务器设置的max_connections参数对此连接无效,并且如果TCP连接成功,Aborted_connects状态将会加<span class="number">1</span></span><br><span class="line">master_ip_failover_script：</span><br><span class="line">常见的HA环境下,大多是情况会给<span class="keyword">master</span>分配一个虚拟IP,如果<span class="keyword">master</span>宕机,HA软件像一个Pacemaker将虚拟IP转移到备用的<span class="keyword">master</span>上</span><br><span class="line">另外一种常见的方法就是创建一个全局目录数据库,包含所有应用和writer/reader ip地址.例如&#123;app_master1,<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>&#125;,&#123;app_master2,<span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span>&#125;...,代替使用虚拟IP,</span><br><span class="line">这种情况,你需要在<span class="keyword">master</span>宕机的时候更新目录数据库</span><br><span class="line">两种方法都有好的或者不好的地方,MHA不强制要求使用哪一种,但是提供了master_ip_failover_script参数来完成此目的</span><br><span class="line">换句话说,你需要写一个脚本来调整应用服务连接到新的<span class="keyword">master</span>,然后定义master_ip_failover_script的参数,下面是一个实例</span><br><span class="line">master_ip_failover_script= /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/master_ip_failover</span><br><span class="line">你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/master_ip_failover找到一个简单的脚本.这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">MHA manager会调用master_ip_failover_script三次,</span><br><span class="line">第一次,在开始<span class="keyword">master</span> monitor之前调用(目的是检查脚本是否可用),</span><br><span class="line">第二次是在调用shutdown_script脚本前调用,</span><br><span class="line">第三次是在<span class="keyword">new</span> <span class="keyword">master</span>应用完所有的差异日志以后,MHA manager会传递给脚本如下参数.(你不用在配置文件中指明这些参数)</span><br><span class="line">Checking phase</span><br><span class="line"><span class="comment">--command=status</span></span><br><span class="line"><span class="comment">--ssh_user=(current master's ssh username)</span></span><br><span class="line"><span class="comment">--orig_master_host=(current master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(current master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(current master's port number)</span></span><br><span class="line"><span class="keyword">Current</span> <span class="keyword">master</span> <span class="keyword">shutdown</span> phase</span><br><span class="line"><span class="comment">--command=stop or stopssh</span></span><br><span class="line"><span class="comment">--ssh_user=(dead master's ssh username, if reachable via ssh)</span></span><br><span class="line"><span class="comment">--orig_master_host=(current(dead) master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(current(dead) master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(current(dead) master's port number)</span></span><br><span class="line"><span class="keyword">New</span> <span class="keyword">master</span> activation phase</span><br><span class="line"><span class="comment">--command=start</span></span><br><span class="line"><span class="comment">--ssh_user=(new master's ssh username)</span></span><br><span class="line"><span class="comment">--orig_master_host=(dead master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(dead master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(dead master's port number)</span></span><br><span class="line"><span class="comment">--new_master_host=(new master's hostname)</span></span><br><span class="line"><span class="comment">--new_master_ip=(new master's ip address)</span></span><br><span class="line"><span class="comment">--new_master_port(new master's port number)</span></span><br><span class="line"><span class="comment">--new_master_user=(new master's user)</span></span><br><span class="line"><span class="comment">--new_master_password(new master's password)</span></span><br><span class="line">如果你使用共享虚拟IP的方法,你不需要在<span class="keyword">master</span> <span class="keyword">shutdown</span>阶段做任何事情,只要通过shutdown_script脚本关掉原来<span class="keyword">master</span>的电源,在激活<span class="keyword">new</span> <span class="keyword">master</span>阶段,</span><br><span class="line">你需要分配虚拟IP给<span class="keyword">new</span> master.如果你使用目录数据库的方法,你需要在宕机的<span class="keyword">master</span> <span class="keyword">shutdown</span>阶段删除或者更新失效<span class="keyword">master</span>的记录</span><br><span class="line">在<span class="keyword">new</span> <span class="keyword">master</span>生效阶段需要插入或者更新<span class="keyword">new</span> <span class="keyword">master</span>的记录.另外你可以做任何事情来保证应用程序可以成功的写入<span class="keyword">new</span> <span class="keyword">master</span></span><br><span class="line">比如<span class="keyword">SET</span> <span class="keyword">GLOBAL</span> read_only=<span class="number">0</span>，创建有写入权限的数据库用户等等</span><br><span class="line">MHA manager检查脚本的退出状态,如果脚本退出状态是<span class="number">0</span>或者<span class="number">10</span>,MHA manager继续操作,如果脚本退出状态不是<span class="number">0</span>或者<span class="number">10</span>,MHA manager将会意外终止,并不继续continue failover.默认这个参数是空的</span><br><span class="line">master_ip_online_change_script：</span><br><span class="line">这是几个简单版本的master_ip_failover_script参数,但是<span class="keyword">master</span> <span class="keyword">failover</span>命令并不调用它.master <span class="keyword">online</span> <span class="keyword">change</span>命令会调用它.(masterha_master_switch <span class="comment">--master_state=alive),传递以下参数</span></span><br><span class="line"><span class="keyword">Current</span> <span class="keyword">master</span> write freezing phase</span><br><span class="line"><span class="comment">--command=stop or stopssh</span></span><br><span class="line"><span class="comment">--orig_master_host=(current master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(current master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(current master's port number)</span></span><br><span class="line"><span class="comment">--orig_master_user=(current master's user)</span></span><br><span class="line"><span class="comment">--orig_master_password=(current master's password)</span></span><br><span class="line"><span class="comment">--orig_master_ssh_user=(from 0.56, current master's ssh user)</span></span><br><span class="line"><span class="comment">--orig_master_is_new_slave=(from 0.56, notifying whether the orig master will be new slave or not)</span></span><br><span class="line"><span class="keyword">New</span> <span class="keyword">master</span> granting write phase</span><br><span class="line"><span class="comment">--command=start</span></span><br><span class="line"><span class="comment">--orig_master_host=(orig master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(orig master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(orig master's port number)</span></span><br><span class="line"><span class="comment">--new_master_host=(new master's hostname)</span></span><br><span class="line"><span class="comment">--new_master_ip=(new master's ip address)</span></span><br><span class="line"><span class="comment">--new_master_port(new master's port number)</span></span><br><span class="line"><span class="comment">--new_master_user=(new master's user)</span></span><br><span class="line"><span class="comment">--new_master_password=(new master's password)</span></span><br><span class="line"><span class="comment">--new_master_ssh_user=(from 0.56, new master's ssh user)</span></span><br><span class="line">MHA在当前的<span class="keyword">master</span> write freezing阶段后执行FLUASH <span class="keyword">TABLES</span> <span class="keyword">WITH</span> <span class="keyword">READ</span> <span class="keyword">LOCK</span>, 在<span class="keyword">new</span> mastergranting write阶段你可以执行一些类似master_ip_failover_script的操作</span><br><span class="line">比如创建一个有写入权限的用户,执行<span class="keyword">SET</span> <span class="keyword">GLOBAL</span> read_only=<span class="number">0</span>,更新目录数据库等.如果你的脚本退出返回状态不是<span class="number">1</span>或者<span class="number">10</span>,那么MHA manager将会意外终止,</span><br><span class="line">停止<span class="keyword">master</span> <span class="keyword">switch</span>这个参数默认为空,所以MHA manager不做任何调用你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/master_ip_online_change找到一个简单的脚本</span><br><span class="line">这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">shutdown_script：</span><br><span class="line">你可能需要强制关闭<span class="keyword">master</span>服务器,避免他再次提供服务,这对于避免脑裂很重要.下面是一个实例</span><br><span class="line">shutdown_script= /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/power_manager</span><br><span class="line">你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/power_manager找到一个简单的脚本.这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">在调用shutdown_script脚本之前,MHA manager内部会通过ssh尝试连接到mysql <span class="keyword">master</span>,如果ssh可以连接(意思就是OS是存活的,但是Mysqld没有运行),MHAmanager就会传递下面的参数</span><br><span class="line"><span class="comment">--command=stopssh (这个意思就是指停止服务,不会关机)</span></span><br><span class="line"><span class="comment">--ssh_user=(ssh username so that you can connect to the master)</span></span><br><span class="line"><span class="comment">--host=(master's hostname)</span></span><br><span class="line"><span class="comment">--ip=(master's ip address)</span></span><br><span class="line"><span class="comment">--port=(master's port number)</span></span><br><span class="line"><span class="comment">--pid_file=(master's pid file)</span></span><br><span class="line">如果<span class="keyword">master</span>主机的ssh不能连接,那么MHA会使用如下参数</span><br><span class="line"><span class="comment">--command=stop (这个会通过fence设备关掉电源)</span></span><br><span class="line"><span class="comment">--host=(master's hostname)</span></span><br><span class="line"><span class="comment">--ip=(master's ip address)</span></span><br><span class="line">这个脚本的大概功能如下,如果<span class="comment">--command=stopssh被调用,脚本会使用killall -9 杀掉目标服务器上所有的mysqld_safe服务</span></span><br><span class="line">如果<span class="comment">--pid_file被设置,脚本尝试kill指定的进程.如果脚本执行成功,那么脚本会退出返回状态10.如果退出状态为10,</span></span><br><span class="line">MHA manager后面会通过ssh连接到<span class="keyword">master</span>,获取需要的<span class="built_in">binary</span> log.如果脚本通过ssh连接到服务器失败,那么就会传递<span class="comment">--command=stop参数,这个参数尝试关闭机器的电源,</span></span><br><span class="line">关闭电源依赖于H/W.HP(ILO),DELL(DRAC).如果<span class="keyword">power</span> <span class="keyword">off</span>成功,脚本会然会状态<span class="number">0</span>,其他情况会返回状态<span class="number">1.</span>当返回状态是<span class="number">0</span>的时候MHA manager </span><br><span class="line">开始failover.如果返回状态不是<span class="number">0</span>或者<span class="number">10</span>,那么MHA manager会意外终止.这个参数默认是空,所以MHA manager不会调用任何脚本</span><br><span class="line">另外,MHA manager在启动<span class="keyword">monitoring</span>之前调用shutdown_script.这时候会传递下面的参数.目的是检测脚本是否可用,如果发现错误,你可以提前知道</span><br><span class="line"><span class="comment">--command=status</span></span><br><span class="line"><span class="comment">--host=(master's hostname)</span></span><br><span class="line"><span class="comment">--ip=(master's ip address)</span></span><br><span class="line">report_script：</span><br><span class="line">你希望当<span class="keyword">failover</span>发生以后可以发送一个报告(例如email),report_script可以达到这个目的,MHA manager传递下面的参数</span><br><span class="line"><span class="comment">--orig_master_host=(dead master's hostname)</span></span><br><span class="line"><span class="comment">--new_master_host=(new master's hostname)</span></span><br><span class="line"><span class="comment">--new_slave_hosts=(new slaves' hostnames, delimited by commas)</span></span><br><span class="line"><span class="comment">--subject=(mail subject)</span></span><br><span class="line"><span class="comment">--body=(body)</span></span><br><span class="line">默认这个参数是空的,所以MHA manager不调用任何脚本，你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/send_report找到一个简单的脚本</span><br><span class="line">这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">init_conf_load_script：</span><br><span class="line">这个脚本可以在你不想在配置文件中写明文密码的时候使用.你可以覆盖全局配置参数.实例脚本如下</span><br><span class="line">#!/usr/<span class="keyword">bin</span>/perl</span><br><span class="line">print <span class="string">"password=$ROOT_PASS\n"</span>;</span><br><span class="line">print "repl_password=$REPL_PASS\n";</span><br><span class="line">这个参数默认为空,所以MHA manager默认不调用任何脚本</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>MySQL Master High Available 理论篇：<br><a href="https://yq.aliyun.com/articles/58004?spm=5176.100239.blogcont57855.9.jUuCt0" target="_blank" rel="noopener">https://yq.aliyun.com/articles/58004?spm=5176.100239.blogcont57855.9.jUuCt0</a></p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>云服务器上MySQL高可用，也可通过云负载均衡产品+MySQL复制来实现，但在数据安全性上，没有MHA+VIP+MySQL相对安全。</p>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/jiessie.png"
                alt="Jiessie" />
            
              <p class="site-author-name" itemprop="name">Jiessie</p>
              <p class="site-description motion-element" itemprop="description">最怕一生碌碌无为,还说平凡难能可贵！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">25</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.percona.com/" target="_blank" title="Percona">
                      
                        <i class="fa fa-fw fa-globe"></i>Percona</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://mariadb.com/kb/zh-cn/mariadb/" target="_blank" title="MariaDB">
                      
                        <i class="fa fa-fw fa-globe"></i>MariaDB</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysqlserverteam.com/" target="_blank" title="serverteam">
                      
                        <i class="fa fa-fw fa-globe"></i>serverteam</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysqlhighavailability.com/" target="_blank" title="highavailability">
                      
                        <i class="fa fa-fw fa-globe"></i>highavailability</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysql.taobao.org/monthly/" target="_blank" title="淘宝月报">
                      
                        <i class="fa fa-fw fa-globe"></i>淘宝月报</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://dimitrik.free.fr/blog/" target="_blank" title="dimitrik">
                      
                        <i class="fa fa-fw fa-globe"></i>dimitrik</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiessie</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

</body>
</html>
