<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Jiessie's' Blog" type="application/atom+xml" />






<meta name="description" content="最怕一生碌碌无为,还说平凡难能可贵！">
<meta property="og:type" content="website">
<meta property="og:title" content="Jiessie&#39;s&#39; Blog">
<meta property="og:url" content="https://dwj999.github.io/index.html">
<meta property="og:site_name" content="Jiessie&#39;s&#39; Blog">
<meta property="og:description" content="最怕一生碌碌无为,还说平凡难能可贵！">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jiessie&#39;s&#39; Blog">
<meta name="twitter:description" content="最怕一生碌碌无为,还说平凡难能可贵！">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dwj999.github.io/"/>





  <title>Jiessie's' Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jiessie's' Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">没伞的孩子必须努力奔跑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/hello-world.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/hello-world.html" itemprop="url">Hello World</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-29T17:53:26+08:00">
                2018-07-29
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Welcome to <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="noopener">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="noopener">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="noopener">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">"My New Post"</span></span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="noopener">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="noopener">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="noopener">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="noopener">Deployment</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/MySQL启动配置文件搜索顺序解析.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/MySQL启动配置文件搜索顺序解析.html" itemprop="url">MySQL启动配置文件搜索顺序解析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-20T15:12:47+08:00">
                2018-07-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/MySQL/" itemprop="url" rel="index">
                    <span itemprop="name">MySQL</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-引言"><a href="#1-引言" class="headerlink" title="1    引言"></a>1    引言</h2><p>MySQL数据库支持从配置文件中读取启动选项，不用每次启动时在命令行输入，方便管理。很多选项都是以纯文本的形式存在，可以用任何的编辑器打开编辑。.mylogin.cnf文件除外，此文件包含了登录路径的选项，使用mysql_config_editor程序去创建的加密文件。</p>
<h2 id="2-搜索顺序"><a href="#2-搜索顺序" class="headerlink" title="2    搜索顺序"></a>2    搜索顺序</h2><p>MySQL默认情况下是按照一定的顺序去搜索具体路径的配置文件，并且在windows和linux的操作顺序不一样。<br>搜索顺序，按照下面表格中文件名从上往下，如果存在相同的选项，最后一个出现的选项有最高的优先级。参考官网的解释：<font color="FF0000"><b>”Options are processed in order, so if an option is specified multiple times, the last occurrence takes precedence.”</b></font></p>
<h3 id="2-1-Windows"><a href="#2-1-Windows" class="headerlink" title="2.1    Windows"></a>2.1    Windows</h3><p>在windows上，MySQL按照指定的顺序从下表中显示的文件中读取启动选项</p>
<table>
<thead>
<tr>
<th>文件名</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>%WINDIR%\my.ini, %WINDIR%\my.cnf</td>
<td>全局</td>
</tr>
<tr>
<td>C:\my.ini, C:\my.cnf</td>
<td>全局</td>
</tr>
<tr>
<td>BASEDIR\my.ini, BASEDIR\my.cnf</td>
<td>全局</td>
</tr>
<tr>
<td>defaults-extra-file</td>
<td>如果存在—default-extra-file</td>
</tr>
<tr>
<td>%APPDATA%\MySQL.mylogin.cnf</td>
<td>Login选项，仅适用于client</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">其中，</span><br><span class="line">WINDIR表示Windows目录的位置，例如C:\Windows</span><br><span class="line">APPDIR表示Windows应用程序数据目录</span><br><span class="line">BASEDIR表示MySQL的安装目录</span><br></pre></td></tr></table></figure>
<h3 id="2-2-Linux-or-Unix"><a href="#2-2-Linux-or-Unix" class="headerlink" title="2.2    Linux or Unix"></a>2.2    Linux or Unix</h3><p>在Linux或Unix等类Unix系统上，MySQL按照指定的顺序从下表中显示的文件中读取启动选项</p>
<table>
<thead>
<tr>
<th>文件名</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>/etc/my.cnf</td>
<td>全局</td>
</tr>
<tr>
<td>/etc/mysql/my.cnf</td>
<td>全局</td>
</tr>
<tr>
<td>SYSCONFDIR/my.cnf</td>
<td>全局</td>
</tr>
<tr>
<td>$MYSQL_HOME/my.cnf</td>
<td>仅适用于server</td>
</tr>
<tr>
<td>defaults-extra-file</td>
<td>如果存在—default-extra-file</td>
</tr>
<tr>
<td>~/.my.cnf</td>
<td>用户的选项</td>
</tr>
<tr>
<td>~/.mylogin.cnf</td>
<td>Login选项，仅适用于client</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">其中，</span><br><span class="line">~表示当前用户的主目录</span><br><span class="line">SYSCONFIGDIR表示在构建MySQL时使用SYSCONFIGDIR选项CMake的指定目录</span><br><span class="line">MySQL_HOME是一个环境变量，如果没有设置，并使用mysqld_safe启用MySQL，这时MySQL的安装目录就是其BASEDIR</span><br></pre></td></tr></table></figure>
<h2 id="3-实验"><a href="#3-实验" class="headerlink" title="3    实验"></a>3    实验</h2><p>生产环境一般多使用linux系统，在单实例和多实例启动时，my.cnf加载的顺序也存在不一样的情况，这里分别进行测试，对结果进行说明</p>
<h3 id="3-1-单实例"><a href="#3-1-单实例" class="headerlink" title="3.1    单实例"></a>3.1    单实例</h3><p>在不考虑SYSCONDIR，同时BASEDIR为/usr/local/mysql的情况下，从上面的搜索顺序来看，MySQL会依次加载以下的文件：</p>
<ul>
<li>/etc/my.cnf</li>
<li>/etc/mysql/my.cnf</li>
<li>/usr/local/mysql/my.cnf</li>
<li>~/.my.cnf<br>也就是说MySQL会找/etc/my.cnf这个文件，如果此文件不存在，继续找/etc/mysql/my.cnf这个文件，依此类推，最后是读取–defaults-file加载的文件，如果最后的文件也不存在，通过mysqld的帮助可以看出来:</li>
</ul>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/4790EAB515654EF6BDE79AC7E24DC180/56032" alt="image"></p>
<h4 id="3-1-1-etc-my-cnf"><a href="#3-1-1-etc-my-cnf" class="headerlink" title="3.1.1    /etc/my.cnf"></a>3.1.1    /etc/my.cnf</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf中只存在/etc/my.cnf时，很明显MySQL是加载的<font color="FF0000"><b>/etc/my.cnf</b></font></p>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/9F08A98F5E304257B81684C84D7F1A4C/56057" alt="image"></p>
<h4 id="3-1-2-etc-my-cnf-amp-amp-etc-mysql-my-cnf"><a href="#3-1-2-etc-my-cnf-amp-amp-etc-mysql-my-cnf" class="headerlink" title="3.1.2    /etc/my.cnf &amp;&amp; /etc/mysql/my.cnf"></a>3.1.2    /etc/my.cnf &amp;&amp; /etc/mysql/my.cnf</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf中只存在/etc/my.cnf和/etc/mysql/my.cnf时，很明显MySQL是加载的<font color="FF0000"><b>/etc/mysql/my.cnf</b></font></p>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/F98D157B588946A6BE9579B6EA14B677/56069" alt="image"></p>
<h4 id="3-1-3-etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf"><a href="#3-1-3-etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf" class="headerlink" title="3.1.3    /etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; /usr/local/mysql/my.cnf"></a>3.1.3    /etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; /usr/local/mysql/my.cnf</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf中存在/etc/my.cnf和/etc/mysql/my.cnf和/usr/local/mysql/my.cnf时，很明显MySQL是加载的<font color="FF0000"><b>/usr/local/mysql/my.cnf</b></font></p>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/A89ED641C57C4F5FA13F56D0FEAB9215/56077" alt="image"></p>
<h4 id="3-1-4-etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-my-cnf"><a href="#3-1-4-etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-my-cnf" class="headerlink" title="3.1.4    /etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; /usr/local/mysql/my.cnf &amp;&amp; ~/.my.cnf"></a>3.1.4    /etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; /usr/local/mysql/my.cnf &amp;&amp; ~/.my.cnf</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，很明显MySQL是加载的<font color="FF0000"><b>~/my.cnf</b></font></p>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/6C413D12F7754A71A4755FCE6ABC4530/56084" alt="image"></p>
<h4 id="3-1-5-defaults-file"><a href="#3-1-5-defaults-file" class="headerlink" title="3.1.5    defaults-file"></a>3.1.5    defaults-file</h4><p>当指定<font color="FF0000"><b>–defaults-file为/tmp/my.cnf</b></font>时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，很明显MySQL是加载的<font color="FF0000"><b>/tmp/my.cnf</b></font></p>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/DC1A2943DDE54CA0B0836BABDC1FA112/56095" alt="image"></p>
<h3 id="3-2-多实例"><a href="#3-2-多实例" class="headerlink" title="3.2    多实例"></a>3.2    多实例</h3><p>多实例的启动通常使用mysqld_multi脚本，此脚本也支持–defaults-file选项。从mysqld_multi的官档上可以看出，mysqld_multi支持[mysqldN]的标签，其中N代表常量数字，此脚本是调用mysqld_safe命令是启动服务，所以支持<font color="FF0000"><b>[mysqld]标签做通用性配置文件</b></font>，适用于多个实例启动时的通用配置，也可以使用<font color="FF0000"><b>[mysqldN]，N代表特定端口做特殊性实例配置。</b></font></p>
<h4 id="3-2-1-etc-my-cnf-amp-amp-mysqldN"><a href="#3-2-1-etc-my-cnf-amp-amp-mysqldN" class="headerlink" title="3.2.1    /etc/my.cnf &amp;&amp; [mysqldN]"></a>3.2.1    /etc/my.cnf &amp;&amp; [mysqldN]</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在/etc/my.cnf加了一个<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，<font color="FF0000"><b>MySQL是加载的是/etc/my.cnf的[mysqld3306]标签配置文件</b></font></p>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/F9010C7078314524B68ABCCB79075320/56115" alt="image"></p>
<h4 id="3-2-2-etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-mysqldN"><a href="#3-2-2-etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-mysqldN" class="headerlink" title="3.2.2    /etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; [mysqldN]"></a>3.2.2    /etc/my.cnf &amp;&amp; /etc/mysql/my.cnf &amp;&amp; [mysqldN]</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在/etc/my.cnf和/etc/mysql/my.cnf加了一个<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，<font color="FF0000"><b>MySQL是加载的是/etc/mysql/my.cnf的[mysqld3306]标签配置文件</b></font></p>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/917AB5B37FFD4A8187526979CEEFEF2A/56124" alt="image"></p>
<h4 id="3-2-3-etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-mysqldN"><a href="#3-2-3-etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-mysqldN" class="headerlink" title="3.2.3    /etc/my.cnf &amp;&amp; /etc/mysql/my.cnf  &amp;&amp;/usr/local/mysql/my.cnf &amp;&amp; [mysqldN]"></a>3.2.3    /etc/my.cnf &amp;&amp; /etc/mysql/my.cnf  &amp;&amp;/usr/local/mysql/my.cnf &amp;&amp; [mysqldN]</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在/etc/my.cnf和/etc/mysql/my.cnf和/usr/local/mysql/my.cnf加了一个<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，<font color="FF0000"><b>MySQL是加载的还是/etc/my.cnf的[mysqld3306]标签配置文件</b></font></p>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/C07D630920334BD682CA1F7F04667F43/56133" alt="image"></p>
<h4 id="3-2-4-etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-mycf-amp-amp-mysqldN"><a href="#3-2-4-etc-my-cnf-amp-amp-etc-mysql-my-cnf-amp-amp-usr-local-mysql-my-cnf-amp-amp-mycf-amp-amp-mysqldN" class="headerlink" title="3.2.4    /etc/my.cnf &amp;&amp; /etc/mysql/my.cnf  &amp;&amp;/usr/local/mysql/my.cnf  &amp;&amp; ~/.mycf &amp;&amp; [mysqldN]"></a>3.2.4    /etc/my.cnf &amp;&amp; /etc/mysql/my.cnf  &amp;&amp;/usr/local/mysql/my.cnf  &amp;&amp; ~/.mycf &amp;&amp; [mysqldN]</h4><p>当没有指定–defaults-file时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在全部配置了<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，<font color="FF0000"><b>MySQL是加载的是~/my.cnf的[mysqld3306]标签配置文件</b></font></p>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/1617DEDF15AA4734A86C7037814A0C69/56142" alt="image"></p>
<h4 id="3-2-5-defaults-file-amp-amp-mysqldN"><a href="#3-2-5-defaults-file-amp-amp-mysqldN" class="headerlink" title="3.2.5    defaults-file &amp;&amp; [mysqldN]"></a>3.2.5    defaults-file &amp;&amp; [mysqldN]</h4><p>当<font color="FF0000"><b>指定–defaults-file为/tmp/my.cnf</b></font>时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在了<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，又在全部配置了了<font color="FF0000"><b>[mysqld3306]</b></font>标签，这时候，了<font color="FF0000"><b>MySQL是加载的是/tmp/my.cnf的[mysqld3306]标签配置文件</b></font></p>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/833693EF85DB4F809E03E3F14A11373C/56152" alt="image"></p>
<h4 id="3-2-6-defaults-file"><a href="#3-2-6-defaults-file" class="headerlink" title="3.2.6    defaults-file"></a>3.2.6    defaults-file</h4><p>当<font color="FF0000"><b>指定–defaults-file为/tmp/my.cnf</b></font>时，而且/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf全部存在时，同时在<font color="FF0000"><b>[mysqld]中全部配置</b></font>innodb_lock_wait_timeout，全部<font color="FF0000"><b>未配置</b></font>了[mysqld3306]标签，这时候，<font color="FF0000"><b>MySQL是加载的是~/my.cnf的配置文件而不是加载的/tmp/my.cnf的配置文件，说明mysqld_multi不加载除默认搜索的配置文件外的其他[mysqld]标签</b></font></p>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/390A51668F654EEBACE26FD87CF50C3F/56164" alt="image"></p>
<h2 id="4-启动方式"><a href="#4-启动方式" class="headerlink" title="4    启动方式"></a>4    启动方式</h2><p>MySQL的启动包括多种，包括以下几种：</p>
<ul>
<li>/usr/local/mysql/bin/mysqld –defaults-file=/etc/my.cnf –basedir=/usr/local/mysql –datadir=/opt/mysql/data –user=mysql</li>
<li>/usr/local/mysql/bin/mysqld_safe –defaults-file=/etc/my.cnf –basedir=/usr/local/mysql –datadir=/opt/mysql/data –user=mysql</li>
<li>/etc/init.d/mysqld start &amp;&amp; service mysqld start</li>
<li>mysqld_multi start<h3 id="4-1-service-mysqld-start"><a href="#4-1-service-mysqld-start" class="headerlink" title="4.1    service mysqld start"></a>4.1    service mysqld start</h3>service mysqld start的启动有一个要注意的地方，它不会加载~/.my.cnf，实验如下，很明显，部<font color="FF0000"><b>service mysqld start启动方式不加载~/.my.cnf的参数</b></font></li>
</ul>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/A284976227264421919972DF05A06BAC/56183" alt="image"></p>
<h4 id="4-1-1-分析"><a href="#4-1-1-分析" class="headerlink" title="4.1.1 分析"></a>4.1.1 分析</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">由于linux的service启动服务的方式是调用的/sbin/service脚本来进行管理的，并且/sbin/service脚本是shell编写的，可以通过debug的模式来查看具体执行过程</span><br></pre></td></tr></table></figure>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/835F9C7BF570488EA0D2A1099F009BF4/56191" alt="image"><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">通过上面的执行过程可以了解到，service mysqld start启动mysql的方式，实际最终调用的命令为：</span><br><span class="line">env -i PATH=/sbin:/usr/sbin:/bin:/usr/bin TERM=linux SYSTEMCTL_IGNORE_DEPENDENCIES= SYSTEMCTL_SKIP_REDIRECT= /etc/init.d/mysqld start</span><br><span class="line">此命令没有包含/home/mysql的环境变量，如果修改为以下命令，则可以加载~/.my.cnf</span><br><span class="line">命令为：</span><br><span class="line">env -i PATH=/sbin:/usr/sbin:/bin:/usr/bin HOME=/home/mysql TERM=linux SYSTEMCTL_IGNORE_DEPENDENCIES= SYSTEMCTL_SKIP_REDIRECT= /etc/init.d/mysqld start</span><br></pre></td></tr></table></figure></p>
<h4 id="4-1-2-解决方案"><a href="#4-1-2-解决方案" class="headerlink" title="4.1.2 解决方案"></a>4.1.2 解决方案</h4><p>从脚本/sbin/service的最下面部分可以看出，具体的启动命令，如果想修改为让service mysqld start的启动方式也能搜索~/.my.cnf的参数，可以修改具体的脚本，添加了一个if else判断条件，如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">将脚本/sbin/service的第81行的原始命令：</span><br><span class="line">env -i PATH=&quot;$PATH&quot; TERM=&quot;$TERM&quot; SYSTEMCTL_IGNORE_DEPENDENCIES=$&#123;SYSTEMCTL_IGNORE_DEPENDENCIES&#125; SYSTEMCTL_SKIP_REDIRECT=$&#123;SYSTEMCTL_SKIP_REDIRECT&#125; &quot;$&#123;SERVICEDIR&#125;/$&#123;SERVICE&#125;&quot; $&#123;ACTION&#125; $&#123;OPTIONS&#125;</span><br><span class="line">修改为</span><br><span class="line">if [ &quot;$&#123;SERVICE&#125;&quot; = &quot;mysqld&quot; ]; then</span><br><span class="line">      env -i PATH=&quot;$PATH&quot; HOME=/home/mysql TERM=&quot;$TERM&quot; SYSTEMCTL_IGNORE_DEPENDENCIES=$&#123;SYSTEMCTL_IGNORE_DEPENDENCIES&#125; SYSTEMCTL_SKIP_REDIRECT=$&#123;SYSTEMCTL_SKIP_REDIREC</span><br><span class="line">T&#125; &quot;$&#123;SERVICEDIR&#125;/$&#123;SERVICE&#125;&quot; $&#123;ACTION&#125; $&#123;OPTIONS&#125;</span><br><span class="line">   else</span><br><span class="line">      env -i PATH=&quot;$PATH&quot; TERM=&quot;$TERM&quot; SYSTEMCTL_IGNORE_DEPENDENCIES=$&#123;SYSTEMCTL_IGNORE_DEPENDENCIES&#125; SYSTEMCTL_SKIP_REDIRECT=$&#123;SYSTEMCTL_SKIP_REDIRECT&#125; &quot;$&#123;SERVICEDIR&#125;/$&#123;SERVICE&#125;&quot; $&#123;ACTION&#125; $&#123;OPTIONS&#125;</span><br><span class="line">   fi</span><br></pre></td></tr></table></figure></p>
<p>如下：</p>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/6EF18BE4F04B4EAC860937772527AFBF/56208" alt="image"></p>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/55AABFB711964631877B3132DFB71DBD/56212" alt="image"></p>
<p>修改后的脚本启动一下测试，查看已经满足需求</p>
<p><img src="https://note.youdao.com/yws/public/resource/7a2a9244a0e6fb6138204da4675bbe06/xmlnote/DDB2AF9783C44EB290A3F38CEB996C1E/56214" alt="image"></p>
<h3 id="4-3-mysqld-multi-start"><a href="#4-3-mysqld-multi-start" class="headerlink" title="4.3    mysqld_multi start"></a>4.3    mysqld_multi start</h3><p>当mysqld_multi方式指定–defaults-file的参数文件时，不加载除默认搜索顺序以外的[mysqld]标签，也可以做下debug，mysqld_multi是perl脚本，可能通过perl -d script的方式进行调试，这里不再展示。</p>
<h2 id="5-结论"><a href="#5-结论" class="headerlink" title="5    结论"></a>5    结论</h2><p>通过以上的的测试，得出以下结论<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1.	默认情况前三种启动方式下，[mysqld]标签以按照/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf，--defaults-file搜索顺序加载</span><br><span class="line">2.	mysqld_mutli启动方式，[mysqldN]标签也是按照/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf，--defaults-file搜索顺序加载。但是，[mysqld]标签只按照/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf搜索顺序加载，不加载--defaults-file的配置</span><br><span class="line">3.	service mysqld start启动方式，默认不加载~/.my.cnf文件，需要修改脚本才能让其支持搜索</span><br><span class="line">4.	当找不到/etc/my.cnf，/etc/mysql/my.cnf，/usr/local/mysql/my.cnf，~/.my.cnf，--defaults-file的配置时，默认编译的mysql，参数是全部其默认值，数据目录保存在BASEDIR下的data目录。比如，BASEDIR为/usr/local/mysql，则DATADIR为/usr/local/mysql/data，上面没有实验这一项</span><br></pre></td></tr></table></figure></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/MySQL-Group-Replication初探.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/MySQL-Group-Replication初探.html" itemprop="url">MySQL Group Replication初探</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-11-28T14:01:23+08:00">
                2017-11-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/集群高可用/" itemprop="url" rel="index">
                    <span itemprop="name">集群高可用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>MySQL Group Replication简称MGR，又称MySQL组复制，是MySQL官方于2016年12月12日推出的一个全新的高可用与高扩展的解决方案，首发集成于MySQL5.7.17版本中。MySQL组复制提供了高可用、高扩展、高可靠的MySQL集群服务。高一致性，基于原生复制及paxos协议的组复制技术，并以插件的方式提供，提供一致数据安全保证；高容错性，只要不是大多数节点坏掉就可以继续工作，有自动检测机制，当不同节点产生资源急用冲突时时，不会出现错误，按照先到者优先进行处理，并且内置了自动化脑裂防护机制；高扩展性，节点的新增和移除都是自动的，新节点加入后，会自动从其他节点上同步状态，直到新节点和其他节点保持一致，如果某节点被移除了，其他节点自动更新组信息，自动维护新的组信息；高灵活性，有单主模式和多主模式，单主模式下，会自动选主，所有更新操作都在主上进行；多主模式下，所有server都可以处理更新操作。</p>
<h2 id="要求和限制"><a href="#要求和限制" class="headerlink" title="要求和限制"></a>要求和限制</h2><h3 id="基础结构"><a href="#基础结构" class="headerlink" title="基础结构"></a>基础结构</h3><ul>
<li>数据必须存储在InnoDB存储引擎中</li>
<li>表必须定义一个显式主键</li>
<li>通信引擎仅支持IPv4</li>
<li>需要低延迟，高带宽的网络<h3 id="server实例配置"><a href="#server实例配置" class="headerlink" title="server实例配置"></a>server实例配置</h3></li>
<li>必须开启binlog</li>
<li>必须开启log-slave-updates</li>
<li>binlog格式必须为ROW格式</li>
<li>必须开启GTID模式</li>
<li>复制相关信息必须使用表存储（–master-info-repository = TABLE/–relay-log-info-repository = TABLE）</li>
<li>事务写集合必须打开（Transaction write set extraction）</li>
<li>root用户必须存在(group replication用于检查组用户是否存在)<h3 id="使用限制"><a href="#使用限制" class="headerlink" title="使用限制"></a>使用限制</h3></li>
<li>不支持binlog的checksum，需要设置–binlog-checksum = NONE</li>
<li>不支持savepoint</li>
<li>不支持可串行serializable事务隔离级别</li>
<li>不支持gap locks</li>
<li>不支持lock tables,unlock tables</li>
<li>多主模式下，不支持多节点同时对一个表进行DDL vs DDL/DML</li>
<li>多主模式下，不支持多级关联外键</li>
</ul>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>MySQL组复制是一个MySQL插件，它建立在现有的MySQL复制基础结构上，利用了二进制日志，基于行的日志记录和全局事务标识符等功能。它集成了当前的MySQL框架，如性能模式、插件和服务基础设施等。<br>组复制（Group Replication）基于分布式一致性算法(Paxos协议的变体)实现，一个组允许部分节点挂掉，只要保证绝大多数节点仍然存活并且之间的通讯是没有问题的，那么这个组对外仍然能够提供服务，它是一种被使用在容错系统中的技术。Group Replication（复制组）是由能够相互通信的多个服务器（节点）组成的。在通信层，Group replication实现了一系列的机制：比如原子消息（atomic message delivery）和全序化消息（total ordering of messages）。这些原子化，抽象化的机制，为实现更先进的数据库复制方案提供了强有力的支持。MySQL Group Replication正是基于这些技术和概念，实现了一种多主全更新的复制协议。简而言之，一个Group Replication就是一组节点，每个节点都可以独立执行事务，而读写事务则会在于group内的其他节点进行协调之后再commit。因此，当一个事务准备提交时，会自动在group内进行原子性的广播，告知其他节点变更了什么内容/执行了什么事务。这种原子广播的方式，使得这个事务在每一个节点上都保持着同样顺序。这意味着每一个节点都以同样的顺序，接收到了同样的事务日志，所以每一个节点以同样的顺序重演了这些事务日志，最终整个group保持了完全一致的状态。然而，不同的节点上执行的事务之间有可能存在资源争用。这种现象容易出现在两个不同的并发事务上。假设在不同的节点上有两个并发事务，更新了同一行数据，那么就会发生资源争用。面对这种情况，Group Replication判定先提交的事务为有效事务，会在整个group里面重放，后提交的事务会直接中断，或者回滚，最后丢弃掉。因此，这也是一个无共享的复制方案，每一个节点都保存了完整的数据副本。</p>
<h2 id="组织结构"><a href="#组织结构" class="headerlink" title="组织结构"></a>组织结构</h2><p><img src="https://dev.mysql.com/doc/refman/5.7/en/images/gr-plugin-blocks.png" alt="image"></p>
<ul>
<li>API层 负责完成和MySQL Server的交互，获取server的状态，截获事务提交，干涉事务提交或者回滚。</li>
<li>组件层 特定功能的组件，Capture负责收集事务执行相关信息，Applier负责应用集群事务到本地，Recovery负责新节点的数据恢复。</li>
<li>复制层 负责冲突验证，接收和应用集群事务。</li>
<li>集群通信层 基于Paxos协议的集群通信引擎以及和上层组件的交互接口。</li>
</ul>
<h2 id="容错"><a href="#容错" class="headerlink" title="容错"></a>容错</h2><p>MySQL组复制构建在paxos分布式算法实现的基础上，以提供不同server之间的分布式协调。因此，它需要大多数server处于活动状态以达到仲裁成员数，从而做出决定。这对系统可以容忍的不影响其自身及其整体功能的故障数量有直接影响。容忍f个故障所需的server数量(n)为n=2*f+1。<br>在实践中，这意味着为了容忍一个故障，组必须有三个server。因此，如果一个服务器故障，仍然有两个服务器形成大多数(三分之二)来允许系统自动地继续运行。但是，如果第二个server意外地fail掉，则该组(剩下一个server)锁定，因为没有多数可以达成协议。  </p>
<h3 id="列表"><a href="#列表" class="headerlink" title="列表"></a>列表</h3><table>
<thead>
<tr>
<th>组大小</th>
<th style="text-align:left">多数</th>
<th style="text-align:left">允许的即使故障数</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td style="text-align:left">1</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td>2</td>
<td style="text-align:left">2</td>
<td style="text-align:left">0</td>
</tr>
<tr>
<td>3</td>
<td style="text-align:left">2</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td>4</td>
<td style="text-align:left">3</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td>5</td>
<td style="text-align:left">3</td>
<td style="text-align:left">2</td>
</tr>
<tr>
<td>6</td>
<td style="text-align:left">4</td>
<td style="text-align:left">2</td>
</tr>
<tr>
<td>7</td>
<td style="text-align:left">4</td>
<td style="text-align:left">3</td>
</tr>
<tr>
<td>8</td>
<td style="text-align:left">5</td>
<td style="text-align:left">3</td>
</tr>
<tr>
<td>9</td>
<td style="text-align:left">5</td>
<td style="text-align:left">4</td>
</tr>
</tbody>
</table>
<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h3 id="在单主模式下部署组复制"><a href="#在单主模式下部署组复制" class="headerlink" title="在单主模式下部署组复制"></a>在单主模式下部署组复制</h3><h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><p>IP：192.168.7.50<br>system：Centos 6.5<br>hostname：jiessie<br>disk：300G ssd<br>memory：8G<br>cpu：4core<br>节点数：3</p>
<h4 id="二进制安装包下载"><a href="#二进制安装包下载" class="headerlink" title="二进制安装包下载"></a>二进制安装包下载</h4><p>二进制包安装目录：/hwdata/data/mysql5.7.20/base<br>下载地址：<a href="https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz" target="_blank" rel="noopener">https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.20-linux-glibc2.12-x86_64.tar.gz</a><br>目录结构：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">/hwdata/data/mysql5.7.20/base</span><br><span class="line">[root@jiessie base]# ll</span><br><span class="line">total 52</span><br><span class="line">-rw-r--r--  1 7161 31415 17987 Sep 13 23:48 COPYING</span><br><span class="line">-rw-r--r--  1 7161 31415  2478 Sep 13 23:48 README</span><br><span class="line">drwxr-xr-x  2 root root   4096 Nov 29 11:22 bin</span><br><span class="line">drwxr-xr-x  2 root root   4096 Nov 29 11:22 docs</span><br><span class="line">drwxr-xr-x  3 root root   4096 Nov 29 11:22 include</span><br><span class="line">drwxr-xr-x  5 root root   4096 Nov 29 11:22 lib</span><br><span class="line">drwxr-xr-x  4 root root   4096 Nov 29 11:22 man</span><br><span class="line">drwxr-xr-x 28 root root   4096 Nov 29 11:22 share</span><br><span class="line">drwxr-xr-x  2 root root   4096 Nov 29 11:22 support-files</span><br><span class="line">[root@jiessie base]#</span><br></pre></td></tr></table></figure></p>
<h4 id="数据目录"><a href="#数据目录" class="headerlink" title="数据目录"></a>数据目录</h4><p>数据目录：/hwdata/data/mysql5.7.20/data<br>三节点的数据，分别存放于data子目录下的s1,s2,s3目录中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# pwd</span><br><span class="line">/hwdata/data/mysql5.7.20</span><br><span class="line">[root@jiessie mysql5.7.20]# mkdir data/&#123;s1,s2,s3&#125;</span><br><span class="line">[root@jiessie mysql5.7.20]# ll data/</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x 2 root root 4096 Nov 29 17:23 s1</span><br><span class="line">drwxr-xr-x 2 root root 4096 Nov 29 17:23 s2</span><br><span class="line">drwxr-xr-x 2 root root 4096 Nov 29 17:23 s3</span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure></p>
<h4 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h4><p>配置文件：/hwdata/data/mysql5.7.20/conf<br>三节点的配置文件，分别是conf目录下的s1.cnf,s2.cnf,s3.cnf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# ll conf/</span><br><span class="line">total 12</span><br><span class="line">-rw-r--r-- 1 root root 948 Nov 29 17:35 s1.cnf</span><br><span class="line">-rw-r--r-- 1 root root 948 Nov 29 17:36 s2.cnf</span><br><span class="line">-rw-r--r-- 1 root root 948 Nov 29 17:37 s3.cnf</span><br><span class="line">[root@jiessie mysql5.7.20]# cat conf/s1.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/hwdata/data/mysql5.7.20/data/s1</span><br><span class="line">basedir=/hwdata/data/mysql5.7.20/base</span><br><span class="line">port=9001</span><br><span class="line">socket=/hwdata/data/mysql5.7.20/data/s1/s1.sock</span><br><span class="line"></span><br><span class="line">server_id=1</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line">log_slave_updates=ON</span><br><span class="line">log_bin=binlog</span><br><span class="line">binlog_format=ROW</span><br><span class="line">innodb_buffer_pool_instances=4</span><br><span class="line">innodb_buffer_pool_size=128M</span><br><span class="line">innodb_flush_log_at_trx_commit=2</span><br><span class="line">sync_binlog=0</span><br><span class="line">slave-parallel-type=LOGICAL_CLOCK</span><br><span class="line">slave-parallel-workers=4</span><br><span class="line">slave_preserve_commit_order=on</span><br><span class="line">#group replication</span><br><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">loose-group_replication_group_name=&quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;</span><br><span class="line">loose-group_replication_start_on_boot=off</span><br><span class="line">loose-group_replication_local_address= &quot;127.0.0.1:10011&quot;</span><br><span class="line">loose-group_replication_group_seeds= &quot;127.0.0.1:10011,127.0.0.1:10012,127.0.0.1:10013&quot;</span><br><span class="line">loose-group_replication_bootstrap_group= off</span><br><span class="line">loose-group_replication_single_primary_mode=true</span><br><span class="line">loose-group_replication_ip_whitelist=&quot;127.0.0.1/20,192.168.7.50/20&quot;</span><br><span class="line">[root@jiessie mysql5.7.20]# </span><br><span class="line">[root@jiessie mysql5.7.20]# cat conf/s2.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/hwdata/data/mysql5.7.20/data/s2</span><br><span class="line">basedir=/hwdata/data/mysql5.7.20/base</span><br><span class="line">port=9002</span><br><span class="line">socket=/hwdata/data/mysql5.7.20/data/s2/s2.sock</span><br><span class="line"></span><br><span class="line">server_id=2</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line">log_slave_updates=ON</span><br><span class="line">log_bin=binlog</span><br><span class="line">binlog_format=ROW</span><br><span class="line">innodb_buffer_pool_instances=4</span><br><span class="line">innodb_buffer_pool_size=128M</span><br><span class="line">innodb_flush_log_at_trx_commit=2</span><br><span class="line">sync_binlog=0</span><br><span class="line">slave-parallel-type=LOGICAL_CLOCK</span><br><span class="line">slave-parallel-workers=4</span><br><span class="line">slave_preserve_commit_order=on</span><br><span class="line">#group replication</span><br><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">loose-group_replication_group_name=&quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;</span><br><span class="line">loose-group_replication_start_on_boot=off</span><br><span class="line">loose-group_replication_local_address= &quot;127.0.0.1:10012&quot;</span><br><span class="line">loose-group_replication_group_seeds= &quot;127.0.0.1:10011,127.0.0.1:10012,127.0.0.1:10013&quot;</span><br><span class="line">loose-group_replication_bootstrap_group= off</span><br><span class="line">loose-group_replication_single_primary_mode=true</span><br><span class="line">loose-group_replication_ip_whitelist=&quot;127.0.0.1/20,192.168.7.50/20&quot;</span><br><span class="line">[root@jiessie mysql5.7.20]# </span><br><span class="line">[root@jiessie mysql5.7.20]# cat conf/s3.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/hwdata/data/mysql5.7.20/data/s3</span><br><span class="line">basedir=/hwdata/data/mysql5.7.20/base</span><br><span class="line">port=9003</span><br><span class="line">socket=/hwdata/data/mysql5.7.20/data/s3/s3.sock</span><br><span class="line"></span><br><span class="line">server_id=3</span><br><span class="line">gtid_mode=ON</span><br><span class="line">enforce_gtid_consistency=ON</span><br><span class="line">master_info_repository=TABLE</span><br><span class="line">relay_log_info_repository=TABLE</span><br><span class="line">binlog_checksum=NONE</span><br><span class="line">log_slave_updates=ON</span><br><span class="line">log_bin=binlog</span><br><span class="line">binlog_format=ROW</span><br><span class="line">innodb_buffer_pool_instances=4</span><br><span class="line">innodb_buffer_pool_size=128M</span><br><span class="line">innodb_flush_log_at_trx_commit=2</span><br><span class="line">sync_binlog=0</span><br><span class="line">slave-parallel-type=LOGICAL_CLOCK</span><br><span class="line">slave-parallel-workers=4</span><br><span class="line">slave_preserve_commit_order=on</span><br><span class="line">#group replication</span><br><span class="line">transaction_write_set_extraction=XXHASH64</span><br><span class="line">loose-group_replication_group_name=&quot;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa&quot;</span><br><span class="line">loose-group_replication_start_on_boot=off</span><br><span class="line">loose-group_replication_local_address= &quot;127.0.0.1:10013&quot;</span><br><span class="line">loose-group_replication_group_seeds= &quot;127.0.0.1:10011,127.0.0.1:10012,127.0.0.1:10013&quot;</span><br><span class="line">loose-group_replication_bootstrap_group= off</span><br><span class="line">loose-group_replication_single_primary_mode=true</span><br><span class="line">loose-group_replication_ip_whitelist=&quot;127.0.0.1/20,192.168.7.50/20&quot;</span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure></p>
<ol>
<li>三节点中配置不一致的参数有以下：  </li>
</ol>
<ul>
<li>datadir     #数据目录  </li>
<li>port        #服务端口  </li>
<li>socket      #socket位置  </li>
<li>server_id   #服务器标识  </li>
<li>group_replication_local_address #组复制的本地地址</li>
</ul>
<ol start="2">
<li>组复制相关参数：  </li>
</ol>
<ul>
<li>transaction_write_set_extraction            #指示Server必须为每个事务收集写集合，并使用指定算法将其编码为散列  </li>
<li>loose-group_replication_group_name          #组复制名称  </li>
<li>loose-group_replication_start_on_boot       #server启动时是否自动启动组复制  </li>
<li>loose-group_replication_local_address       #绑定的ip和端口接受其他组成员的连接  </li>
<li>loose-group_replication_group_seeds         #本行为告诉服务器当服务器加入组时，应当连接到此列表的这些种子服务器进行配置。本设置可以不是全部的组成员地址  </li>
<li>loose-group_replication_bootstrap_group     #配置是否自动启动引导组</li>
<li>loose-group_replication_single_primary_mode #配置单主还是多主模式</li>
<li>loose-group_replication_ip_whitelist        #默认情况下只允许127.0.0.1连接到复制组，如果是其他IP则需要配置  </li>
</ul>
<ol start="3">
<li>开启并行复制</li>
</ol>
<ul>
<li>set global slave_parallel_type = ‘LOGICAL_CLOCK’;</li>
<li>set global slave_parallel_workers = N;</li>
<li>set global slave_preserve_commit_order = ON;<br>这三个参数可以开启并行复制，实践中没有配置，特此提示。<h4 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h4>使用mysqld分别对s1,s2,s3进行初始化：  </li>
<li>base/bin/mysqld –initialize-insecure –basedir=/hwdata/data/mysql5.7.20/base –datadir=/hwdata/data/mysql5.7.20/data/s1</li>
<li>base/bin/mysqld –initialize-insecure –basedir=/hwdata/data/mysql5.7.20/base –datadir=/hwdata/data/mysql5.7.20/data/s2</li>
<li>base/bin/mysqld –initialize-insecure –basedir=/hwdata/data/mysql5.7.20/base –datadir=/hwdata/data/mysql5.7.20/data/s3<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysqld --initialize-insecure --basedir=/hwdata/data/mysql5.7.20/base --datadir=/hwdata/data/mysql5.7.20/data/s1                   </span><br><span class="line">2017-11-30T04:55:56.436002Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2017-11-30T04:55:57.095836Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2017-11-30T04:55:57.216615Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2017-11-30T04:55:57.284024Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: c0acc2c7-d58a-11e7-b59f-00163e00dc49.</span><br><span class="line">2017-11-30T04:55:57.287290Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2017-11-30T04:55:57.287678Z 1 [Warning] root@localhost is created with an empty password ! Please consider switching off the --initialize-insecure option.</span><br><span class="line">[root@jiessie mysql5.7.20]# </span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysqld --initialize-insecure --basedir=/hwdata/data/mysql5.7.20/base --datadir=/hwdata/data/mysql5.7.20/data/s2</span><br><span class="line">2017-11-30T04:56:20.520937Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2017-11-30T04:56:21.152584Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2017-11-30T04:56:21.278863Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2017-11-30T04:56:21.349754Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: cf04e66c-d58a-11e7-b97e-00163e00dc49.</span><br><span class="line">2017-11-30T04:56:21.352655Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2017-11-30T04:56:21.353069Z 1 [Warning] root@localhost is created with an empty password ! Please consider switching off the --initialize-insecure option.</span><br><span class="line">[root@jiessie mysql5.7.20]# </span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysqld --initialize-insecure --basedir=/hwdata/data/mysql5.7.20/base --datadir=/hwdata/data/mysql5.7.20/data/s3</span><br><span class="line">2017-11-30T04:56:28.986804Z 0 [Warning] TIMESTAMP with implicit DEFAULT value is deprecated. Please use --explicit_defaults_for_timestamp server option (see documentation for more details).</span><br><span class="line">2017-11-30T04:56:29.712932Z 0 [Warning] InnoDB: New log files created, LSN=45790</span><br><span class="line">2017-11-30T04:56:29.902130Z 0 [Warning] InnoDB: Creating foreign key constraint system tables.</span><br><span class="line">2017-11-30T04:56:29.970877Z 0 [Warning] No existing UUID has been found, so we assume that this is the first time that this server has been started. Generating a new UUID: d4286108-d58a-11e7-807d-00163e00dc49.</span><br><span class="line">2017-11-30T04:56:29.973699Z 0 [Warning] Gtid table is not ready to be used. Table &apos;mysql.gtid_executed&apos; cannot be opened.</span><br><span class="line">2017-11-30T04:56:29.974087Z 1 [Warning] root@localhost is created with an empty password ! Please consider switching off the --initialize-insecure option.</span><br><span class="line">[root@jiessie mysql5.7.20]# tree -L 2 data/ </span><br><span class="line">data/</span><br><span class="line">|-- s1</span><br><span class="line">|   |-- auto.cnf</span><br><span class="line">|   |-- ib_buffer_pool</span><br><span class="line">|   |-- ib_logfile0</span><br><span class="line">|   |-- ib_logfile1</span><br><span class="line">|   |-- ibdata1</span><br><span class="line">|   |-- mysql</span><br><span class="line">|   |-- performance_schema</span><br><span class="line">|   `-- sys</span><br><span class="line">|-- s2</span><br><span class="line">|   |-- auto.cnf</span><br><span class="line">|   |-- ib_buffer_pool</span><br><span class="line">|   |-- ib_logfile0</span><br><span class="line">|   |-- ib_logfile1</span><br><span class="line">|   |-- ibdata1</span><br><span class="line">|   |-- mysql</span><br><span class="line">|   |-- performance_schema</span><br><span class="line">|   `-- sys</span><br><span class="line">`-- s3</span><br><span class="line">    |-- auto.cnf</span><br><span class="line">    |-- ib_buffer_pool</span><br><span class="line">    |-- ib_logfile0</span><br><span class="line">    |-- ib_logfile1</span><br><span class="line">    |-- ibdata1</span><br><span class="line">    |-- mysql</span><br><span class="line">    |-- performance_schema</span><br><span class="line">    `-- sys</span><br><span class="line"></span><br><span class="line">12 directories, 15 files</span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="启动数据库"><a href="#启动数据库" class="headerlink" title="启动数据库"></a>启动数据库</h4><p>添加权限：chown -R mysql:mysql /hwdata/data/mysql5.7.20/data/<br>分别启动三个节点数据库：</p>
<ul>
<li>base/bin/mysqld_safe –defaults-file=/hwdata/data/mysql5.7.20/conf/s1.cnf &amp;</li>
<li>base/bin/mysqld_safe –defaults-file=/hwdata/data/mysql5.7.20/conf/s2.cnf &amp;</li>
<li>base/bin/mysqld_safe –defaults-file=/hwdata/data/mysql5.7.20/conf/s3.cnf &amp;<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysqld_safe --defaults-file=/hwdata/data/mysql5.7.20/conf/s1.cnf &amp;</span><br><span class="line">[1] 25168</span><br><span class="line">[root@jiessie mysql5.7.20]# Logging to &apos;/hwdata/data/mysql5.7.20/data/s1/jiessie.err&apos;.</span><br><span class="line">2017-11-30T05:06:34.402042Z mysqld_safe Starting mysqld daemon with databases from /hwdata/data/mysql5.7.20/data/s1</span><br><span class="line"></span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysqld_safe --defaults-file=/hwdata/data/mysql5.7.20/conf/s2.cnf &amp;   </span><br><span class="line">[2] 25681</span><br><span class="line">[root@jiessie mysql5.7.20]# Logging to &apos;/hwdata/data/mysql5.7.20/data/s2/jiessie.err&apos;.</span><br><span class="line">2017-11-30T05:06:48.204177Z mysqld_safe Starting mysqld daemon with databases from /hwdata/data/mysql5.7.20/data/s2</span><br><span class="line"></span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysqld_safe --defaults-file=/hwdata/data/mysql5.7.20/conf/s3.cnf &amp; </span><br><span class="line">[3] 26193</span><br><span class="line">[root@jiessie mysql5.7.20]# Logging to &apos;/hwdata/data/mysql5.7.20/data/s3/jiessie.err&apos;.</span><br><span class="line">2017-11-30T05:06:59.779426Z mysqld_safe Starting mysqld daemon with databases from /hwdata/data/mysql5.7.20/data/s3</span><br><span class="line"></span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>查看进程:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# netstat -tunlp|grep mysql </span><br><span class="line">tcp        0      0 0.0.0.0:9001                0.0.0.0:*                   LISTEN      25609/mysqld        </span><br><span class="line">tcp        0      0 0.0.0.0:9002                0.0.0.0:*                   LISTEN      26122/mysqld        </span><br><span class="line">tcp        0      0 0.0.0.0:9003                0.0.0.0:*                   LISTEN      26634/mysqld        </span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure></p>
<h4 id="添加复制用户"><a href="#添加复制用户" class="headerlink" title="添加复制用户"></a>添加复制用户</h4><p>创建具有replication slave权限的MySQL用户,此操作不应记录到二进制中,以避免将更改传递到其他slave实例.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SET SQL_LOG_BIN=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE USER rpl_user@&apos;%&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO rpl_user@&apos;%&apos; IDENTIFIED BY &apos;rpl_pass&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SET SQL_LOG_BIN=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CHANGE MASTER TO MASTER_USER=&apos;rpl_user&apos;, MASTER_PASSWORD=&apos;rpl_pass&apos; FOR CHANNEL &apos;group_replication_recovery&apos;;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock     </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SET SQL_LOG_BIN=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE USER rpl_user@&apos;%&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO rpl_user@&apos;%&apos; IDENTIFIED BY &apos;rpl_pass&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SET SQL_LOG_BIN=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CHANGE MASTER TO MASTER_USER=&apos;rpl_user&apos;, MASTER_PASSWORD=&apos;rpl_pass&apos; FOR CHANNEL &apos;group_replication_recovery&apos;;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock   </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 3</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SET SQL_LOG_BIN=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CREATE USER rpl_user@&apos;%&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; GRANT REPLICATION SLAVE ON *.* TO rpl_user@&apos;%&apos; IDENTIFIED BY &apos;rpl_pass&apos;;</span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; FLUSH PRIVILEGES;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SET SQL_LOG_BIN=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; CHANGE MASTER TO MASTER_USER=&apos;rpl_user&apos;, MASTER_PASSWORD=&apos;rpl_pass&apos; FOR CHANNEL &apos;group_replication_recovery&apos;;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.03 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure></p>
<h4 id="启动组复制"><a href="#启动组复制" class="headerlink" title="启动组复制"></a>启动组复制</h4><p>配置并启动s1后,安装组复制插件,然后连接到server并执行以下命令.  </p>
<p><font color="#FF0000">注意:<br>创建一个Group Replication,需要在一个节点初始化,也只需要在一个节点初始化,不可在多个节点都执行.</font><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 4</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; INSTALL PLUGIN group_replication SONAME &apos;group_replication.so&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show plugins;</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">| Name                       | Status   | Type               | Library              | License |</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">| binlog                     | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</span><br><span class="line">| mysql_native_password      | ACTIVE   | AUTHENTICATION     | NULL                 | GPL     |</span><br><span class="line">| sha256_password            | ACTIVE   | AUTHENTICATION     | NULL                 | GPL     |</span><br><span class="line">| PERFORMANCE_SCHEMA         | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</span><br><span class="line">| MRG_MYISAM                 | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</span><br><span class="line">| MEMORY                     | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</span><br><span class="line">| InnoDB                     | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</span><br><span class="line">| INNODB_TRX                 | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_LOCKS               | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_LOCK_WAITS          | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_CMP                 | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_CMP_RESET           | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_CMPMEM              | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_CMPMEM_RESET        | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_CMP_PER_INDEX       | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_CMP_PER_INDEX_RESET | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_BUFFER_PAGE         | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_BUFFER_PAGE_LRU     | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_BUFFER_POOL_STATS   | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_TEMP_TABLE_INFO     | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_METRICS             | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_FT_DEFAULT_STOPWORD | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_FT_DELETED          | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_FT_BEING_DELETED    | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_FT_CONFIG           | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_FT_INDEX_CACHE      | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_FT_INDEX_TABLE      | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_SYS_TABLES          | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_SYS_TABLESTATS      | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_SYS_INDEXES         | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_SYS_COLUMNS         | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_SYS_FIELDS          | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_SYS_FOREIGN         | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_SYS_FOREIGN_COLS    | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_SYS_TABLESPACES     | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_SYS_DATAFILES       | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| INNODB_SYS_VIRTUAL         | ACTIVE   | INFORMATION SCHEMA | NULL                 | GPL     |</span><br><span class="line">| CSV                        | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</span><br><span class="line">| MyISAM                     | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</span><br><span class="line">| ARCHIVE                    | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</span><br><span class="line">| partition                  | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</span><br><span class="line">| BLACKHOLE                  | ACTIVE   | STORAGE ENGINE     | NULL                 | GPL     |</span><br><span class="line">| FEDERATED                  | DISABLED | STORAGE ENGINE     | NULL                 | GPL     |</span><br><span class="line">| ngram                      | ACTIVE   | FTPARSER           | NULL                 | GPL     |</span><br><span class="line">| group_replication          | ACTIVE   | GROUP REPLICATION  | group_replication.so | GPL     |</span><br><span class="line">+----------------------------+----------+--------------------+----------------------+---------+</span><br><span class="line">45 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group=ON;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br><span class="line">Query OK, 0 rows affected (3.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SET GLOBAL group_replication_bootstrap_group=OFF;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure></p>
<h4 id="添加其他组复制节点"><a href="#添加其他组复制节点" class="headerlink" title="添加其他组复制节点"></a>添加其他组复制节点</h4><p>在其他2个节点上开启组复制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 4</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; INSTALL PLUGIN group_replication SONAME &apos;group_replication.so&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br><span class="line">Query OK, 0 rows affected (6.57 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5.7.20]#  base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 4</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; INSTALL PLUGIN group_replication SONAME &apos;group_replication.so&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; START GROUP_REPLICATION;</span><br><span class="line">Query OK, 0 rows affected (3.27 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure></p>
<h4 id="测试数据同步"><a href="#测试数据同步" class="headerlink" title="测试数据同步"></a>测试数据同步</h4><p>在s1节点上插入数据，在其他节点上查看数据是否同步及binlog详情</p>
<ol>
<li><p>刷新flush logs</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e &quot;flush logs;show binary logs;&quot;                                  +---------------+-----------+</span><br><span class="line">| Log_name      | File_size |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| binlog.000001 |      1101 |</span><br><span class="line">| binlog.000002 |      1162 |</span><br><span class="line">| binlog.000003 |      2329 |</span><br><span class="line">| binlog.000004 |       230 |</span><br><span class="line">| binlog.000005 |      1017 |</span><br><span class="line">| binlog.000006 |       190 |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock -e &quot;flush logs;show binary logs;&quot;  </span><br><span class="line">+---------------+-----------+</span><br><span class="line">| Log_name      | File_size |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| binlog.000001 |       169 |</span><br><span class="line">| binlog.000002 |      2054 |</span><br><span class="line">| binlog.000003 |      3106 |</span><br><span class="line">| binlog.000004 |       190 |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock -e &quot;flush logs;show binary logs;&quot;  </span><br><span class="line">+---------------+-----------+</span><br><span class="line">| Log_name      | File_size |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">| binlog.000001 |       169 |</span><br><span class="line">| binlog.000002 |       150 |</span><br><span class="line">| binlog.000003 |      4970 |</span><br><span class="line">| binlog.000004 |       190 |</span><br><span class="line">+---------------+-----------+</span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure>
</li>
<li><p>节点1插入数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e &quot;create database if not exists test;create table test.t1(id int unsigned not null auto_increment primary key,name varchar(20))&quot;           </span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e &quot;desc test.t1;select * from test.t1&quot;    </span><br><span class="line">+-------+------------------+------+-----+---------+----------------+</span><br><span class="line">| Field | Type             | Null | Key | Default | Extra          |</span><br><span class="line">+-------+------------------+------+-----+---------+----------------+</span><br><span class="line">| id    | int(10) unsigned | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name  | varchar(20)      | YES  |     | NULL    |                |</span><br><span class="line">+-------+------------------+------+-----+---------+----------------+</span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e &quot;insert into test.t1 values(null,&apos;111&apos;)&quot;</span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e &quot;select * from test.t1&quot;</span><br><span class="line">+----+------+</span><br><span class="line">| id | name |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | 111  |</span><br><span class="line">+----+------+</span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e &quot;show binlog events in &apos;binlog.000006&apos;&quot; </span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">| Log_name      | Pos | Event_type     | Server_id | End_log_pos | Info                                                                                       |</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">| binlog.000006 |   4 | Format_desc    |         1 |         123 | Server ver: 5.7.20-log, Binlog ver: 4                                                      |</span><br><span class="line">| binlog.000006 | 123 | Previous_gtids |         1 |         190 | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-19                                                  |</span><br><span class="line">| binlog.000006 | 190 | Gtid           |         1 |         251 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:20&apos;                         |</span><br><span class="line">| binlog.000006 | 251 | Query          |         1 |         360 | create database if not exists test                                                         |</span><br><span class="line">| binlog.000006 | 360 | Gtid           |         1 |         421 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:21&apos;                         |</span><br><span class="line">| binlog.000006 | 421 | Query          |         1 |         582 | create table test.t1(id int unsigned not null auto_increment primary key,name varchar(20)) |</span><br><span class="line">| binlog.000006 | 582 | Gtid           |         1 |         643 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:22&apos;                         |</span><br><span class="line">| binlog.000006 | 643 | Query          |         1 |         712 | BEGIN                                                                                      |</span><br><span class="line">| binlog.000006 | 712 | Table_map      |         1 |         756 | table_id: 223 (test.t1)                                                                    |</span><br><span class="line">| binlog.000006 | 756 | Write_rows     |         1 |         796 | table_id: 223 flags: STMT_END_F                                                            |</span><br><span class="line">| binlog.000006 | 796 | Xid            |         1 |         823 | COMMIT /* xid=151 */                                                                       |</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure>
</li>
<li><p>其他节点查看数据</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock -e &quot;show binlog events in &apos;binlog.000004&apos;&quot;   </span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">| Log_name      | Pos | Event_type     | Server_id | End_log_pos | Info                                                                                       |</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">| binlog.000004 |   4 | Format_desc    |         2 |         123 | Server ver: 5.7.20-log, Binlog ver: 4                                                      |</span><br><span class="line">| binlog.000004 | 123 | Previous_gtids |         2 |         190 | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-19                                                  |</span><br><span class="line">| binlog.000004 | 190 | Gtid           |         1 |         251 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:20&apos;                         |</span><br><span class="line">| binlog.000004 | 251 | Query          |         1 |         360 | create database if not exists test                                                         |</span><br><span class="line">| binlog.000004 | 360 | Gtid           |         1 |         421 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:21&apos;                         |</span><br><span class="line">| binlog.000004 | 421 | Query          |         1 |         582 | create table test.t1(id int unsigned not null auto_increment primary key,name varchar(20)) |</span><br><span class="line">| binlog.000004 | 582 | Gtid           |         1 |         643 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:22&apos;                         |</span><br><span class="line">| binlog.000004 | 643 | Query          |         1 |         707 | BEGIN                                                                                      |</span><br><span class="line">| binlog.000004 | 707 | Table_map      |         1 |         751 | table_id: 221 (test.t1)                                                                    |</span><br><span class="line">| binlog.000004 | 751 | Write_rows     |         1 |         791 | table_id: 221 flags: STMT_END_F                                                            |</span><br><span class="line">| binlog.000004 | 791 | Xid            |         1 |         818 | COMMIT /* xid=71 */                                                                        |</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock -e &quot;show binlog events in &apos;binlog.000004&apos;&quot;  </span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">| Log_name      | Pos | Event_type     | Server_id | End_log_pos | Info                                                                                       |</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">| binlog.000004 |   4 | Format_desc    |         3 |         123 | Server ver: 5.7.20-log, Binlog ver: 4                                                      |</span><br><span class="line">| binlog.000004 | 123 | Previous_gtids |         3 |         190 | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-19                                                  |</span><br><span class="line">| binlog.000004 | 190 | Gtid           |         1 |         251 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:20&apos;                         |</span><br><span class="line">| binlog.000004 | 251 | Query          |         1 |         360 | create database if not exists test                                                         |</span><br><span class="line">| binlog.000004 | 360 | Gtid           |         1 |         421 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:21&apos;                         |</span><br><span class="line">| binlog.000004 | 421 | Query          |         1 |         582 | create table test.t1(id int unsigned not null auto_increment primary key,name varchar(20)) |</span><br><span class="line">| binlog.000004 | 582 | Gtid           |         1 |         643 | SET @@SESSION.GTID_NEXT= &apos;aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:22&apos;                         |</span><br><span class="line">| binlog.000004 | 643 | Query          |         1 |         707 | BEGIN                                                                                      |</span><br><span class="line">| binlog.000004 | 707 | Table_map      |         1 |         751 | table_id: 221 (test.t1)                                                                    |</span><br><span class="line">| binlog.000004 | 751 | Write_rows     |         1 |         791 | table_id: 221 flags: STMT_END_F                                                            |</span><br><span class="line">| binlog.000004 | 791 | Xid            |         1 |         818 | COMMIT /* xid=58 */                                                                        |</span><br><span class="line">+---------------+-----+----------------+-----------+-------------+--------------------------------------------------------------------------------------------+</span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock -e &quot;select * from test.t1&quot;                  </span><br><span class="line">+----+------+</span><br><span class="line">| id | name |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | 111  |</span><br><span class="line">+----+------+</span><br><span class="line">You have new mail in /var/spool/mail/root</span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock -e &quot;select * from test.t1&quot;  </span><br><span class="line">+----+------+</span><br><span class="line">| id | name |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | 111  |</span><br><span class="line">+----+------+</span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="节点状态查询"><a href="#节点状态查询" class="headerlink" title="节点状态查询"></a>节点状态查询</h4><p><font color="#FF0000">注意：</font><br>主机名和/etc/hosts中的信息要保持一致，否则可能会报<font color="#FF0000">“There was an error when connecting to the donor server. Please check that group_replication_r<br>ecovery channel credentials and all MEMBER_HOST column values of performance_schema.replication_group_members table are correct and DNS resolvable.”</font><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span><br><span class="line">| group_replication_applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group_replication_applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="监控组复制"><a href="#监控组复制" class="headerlink" title="监控组复制"></a>监控组复制</h3><p>假设MySQL已经在启用了性能模式的情况下编译，使用performance_schema表监控组复制</p>
<h4 id="replication-group-member-stats"><a href="#replication-group-member-stats" class="headerlink" title="replication_group_member_stats"></a>replication_group_member_stats</h4><p>复制组中的每个成员都会验证并应用该组提交的事务,有关验证和应用程序的统计信息对于了解申请队列增长情况,触发了多少冲突,检查了多少事务,哪些事务已被所有成员提交等非常有用,performance_shcema.replication_group_member_stats提供与认证过程相关的以下信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from performance_schema.replication_group_member_stats;</span><br><span class="line">+---------------------------+---------------------+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+-------------------------------------------+-----------------------------------------+</span><br><span class="line">| CHANNEL_NAME              | VIEW_ID             | MEMBER_ID                            | COUNT_TRANSACTIONS_IN_QUEUE | COUNT_TRANSACTIONS_CHECKED | COUNT_CONFLICTS_DETECTED | COUNT_TRANSACTIONS_ROWS_VALIDATING | TRANSACTIONS_COMMITTED_ALL_MEMBERS        | LAST_CONFLICT_FREE_TRANSACTION          |</span><br><span class="line">+---------------------------+---------------------+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+-------------------------------------------+-----------------------------------------+</span><br><span class="line">| group_replication_applier | 15120910223421577:3 | c0acc2c7-d58a-11e7-b59f-00163e00dc49 |                           0 |                         13 |                        0 |                                  0 | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-22 | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:22 |</span><br><span class="line">+---------------------------+---------------------+--------------------------------------+-----------------------------+----------------------------+--------------------------+------------------------------------+-------------------------------------------+-----------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h5 id="参数解释"><a href="#参数解释" class="headerlink" title="参数解释"></a>参数解释</h5><table>
<thead>
<tr>
<th>Field</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CHANNEL_NAME</td>
<td style="text-align:left">组复制通道的名称</td>
</tr>
<tr>
<td>VIEW_ID</td>
<td style="text-align:left">组复制当前视图标识符</td>
</tr>
<tr>
<td>MEMBER_ID</td>
<td style="text-align:left">当前连接到server成员的UUID,组中的每个成员具有不同的值</td>
</tr>
<tr>
<td>COUNT_TRANSACTIONS_IN_QUEUE</td>
<td style="text-align:left">队列中等待冲突检测检查的事务数,冲突检查通过后,他们排队等待应用</td>
</tr>
<tr>
<td>COUNT_TRANSACTIONS_CHECKED</td>
<td style="text-align:left">已进行过冲突检查的事务数</td>
</tr>
<tr>
<td>COUNT_CONFLICTS_DETECTED</td>
<td style="text-align:left">未通过冲突检查的事务数</td>
</tr>
<tr>
<td>COUNT_TRANSACTIONS_ROWS_VALIDATING</td>
<td style="text-align:left">可用于认证的事务行的数量，但没有被垃圾收集</td>
</tr>
<tr>
<td>TRANSACTIONS_COMMITTED_ALL_MEMBERS</td>
<td style="text-align:left">当前视图的所有成员成功提交的事务,此值为固定的时间间隔更新</td>
</tr>
<tr>
<td>LAST_CONFLICT_FREE_TRANSACTION</td>
<td style="text-align:left">最后一个经检查无冲突的事务标识符</td>
</tr>
</tbody>
</table>
<h4 id="replication-group-members"><a href="#replication-group-members" class="headerlink" title="replication_group_members"></a>replication_group_members</h4><p>用于监控在当前视图中的不同server实例的状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span><br><span class="line">| group_replication_applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group_replication_applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h5 id="参数解释-1"><a href="#参数解释-1" class="headerlink" title="参数解释"></a>参数解释</h5><table>
<thead>
<tr>
<th>Field</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CHANNEL_NAME</td>
<td style="text-align:left">组复制通道的名称</td>
</tr>
<tr>
<td>MEMBER_ID</td>
<td style="text-align:left">server成员的UUID</td>
</tr>
<tr>
<td>MEMBER_HOST</td>
<td style="text-align:left">组成员的网络地址</td>
</tr>
<tr>
<td>MEMBER_PORT</td>
<td style="text-align:left">侦听此成员的MySQL连接端口</td>
</tr>
<tr>
<td>MEMBER_STATE</td>
<td style="text-align:left">组成员的状态</td>
</tr>
</tbody>
</table>
<h4 id="replication-connection-status"><a href="#replication-connection-status" class="headerlink" title="replication_connection_status"></a>replication_connection_status</h4><p>此表显示处理从服务器连接主服务器的IO线程的当前状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from performance_schema.replication_connection_status;</span><br><span class="line">+---------------------------+--------------------------------------+--------------------------------------+-----------+---------------+---------------------------+--------------------------+-------------------------------------------+-------------------+--------------------+----------------------+</span><br><span class="line">| CHANNEL_NAME              | GROUP_NAME                           | SOURCE_UUID                          | THREAD_ID | SERVICE_STATE | COUNT_RECEIVED_HEARTBEATS | LAST_HEARTBEAT_TIMESTAMP | RECEIVED_TRANSACTION_SET                  | LAST_ERROR_NUMBER | LAST_ERROR_MESSAGE | LAST_ERROR_TIMESTAMP |</span><br><span class="line">+---------------------------+--------------------------------------+--------------------------------------+-----------+---------------+---------------------------+--------------------------+-------------------------------------------+-------------------+--------------------+----------------------+</span><br><span class="line">| group_replication_applier | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa |      NULL | ON            |                         0 | 0000-00-00 00:00:00      | aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa:1-22 |                 0 |                    | 0000-00-00 00:00:00  |</span><br><span class="line">+---------------------------+--------------------------------------+--------------------------------------+-----------+---------------+---------------------------+--------------------------+-------------------------------------------+-------------------+--------------------+----------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h5 id="参数解释-2"><a href="#参数解释-2" class="headerlink" title="参数解释"></a>参数解释</h5><table>
<thead>
<tr>
<th>Field</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CHANNEL_NAME</td>
<td style="text-align:left">组复制通道的名称</td>
</tr>
<tr>
<td>GROUP_NAME</td>
<td style="text-align:left">如果此服务器是组的成员，则显示服务器所属的组的名称</td>
</tr>
<tr>
<td>SOURCE_UUID</td>
<td style="text-align:left">组的标识符,类似组名称,被用作组复制期间生成的所有事务的UUID</td>
</tr>
<tr>
<td>THREAD_ID</td>
<td style="text-align:left">IO线程ID</td>
</tr>
<tr>
<td>SERVICE_STATE</td>
<td style="text-align:left">IO状态,ON（线程存在并处于活动状态或空闲状态）,OFF（线程不再存在）或CONNECTING（线程存在并连接到主控制器）</td>
</tr>
<tr>
<td>COUNT_RECEIVED_HEARTBEATS</td>
<td style="text-align:left">从上次重新启动或复位复制从服务器接收到的心跳信号的总数或发出CHANGE MASTER TO语句</td>
</tr>
<tr>
<td>LAST_HEARTBEAT_TIMESTAMP</td>
<td style="text-align:left">YYMMDD HH:MM:SS格式中 的时间戳，显示复制从站接收到最新的心跳信号的时间</td>
</tr>
<tr>
<td>RECEIVED_TRANSACTION_SET</td>
<td style="text-align:left">此GTID集合中的事务已由该组的此成员接收</td>
</tr>
<tr>
<td>LAST_ERROR_NUMBER</td>
<td style="text-align:left">导致IO线程停止的错误号</td>
</tr>
<tr>
<td>LAST_ERROR_MESSAGE</td>
<td style="text-align:left">导致IO线程停止的错误消息</td>
</tr>
<tr>
<td>LAST_ERROR_TIMESTAMP</td>
<td style="text-align:left">YYMMDD HH:MM:SS格式 的时间戳,IO发生错误的时间</td>
</tr>
</tbody>
</table>
<h5 id="与show-slave-status的对应关系"><a href="#与show-slave-status的对应关系" class="headerlink" title="与show slave status的对应关系"></a>与show slave status的对应关系</h5><table>
<thead>
<tr>
<th>replication_connection_status Column</th>
<th style="text-align:left">SHOW SLAVE STATUS Column</th>
</tr>
</thead>
<tbody>
<tr>
<td>SOURCE_UUID</td>
<td style="text-align:left">Master_UUID</td>
</tr>
<tr>
<td>THREAD_ID</td>
<td style="text-align:left">None</td>
</tr>
<tr>
<td>SERVICE_STATE</td>
<td style="text-align:left">Slave_IO_Running</td>
</tr>
<tr>
<td>RECEIVED_TRANSACTION_SET</td>
<td style="text-align:left">Retrieved_Gtid_Set</td>
</tr>
<tr>
<td>LAST_ERROR_NUMBER</td>
<td style="text-align:left">Last_IO_Errno</td>
</tr>
<tr>
<td>LAST_ERROR_MESSAGE</td>
<td style="text-align:left">Last_IO_Error</td>
</tr>
<tr>
<td>LAST_ERROR_TIMESTAMP</td>
<td style="text-align:left">Last_IO_Error_Timestamp</td>
</tr>
</tbody>
</table>
<h4 id="replication-applier-status"><a href="#replication-applier-status" class="headerlink" title="replication_applier_status"></a>replication_applier_status</h4><p>此表显示从服务器上当前的一般事务执行状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from performance_schema.replication_applier_status;</span><br><span class="line">+---------------------------+---------------+-----------------+----------------------------+</span><br><span class="line">| CHANNEL_NAME              | SERVICE_STATE | REMAINING_DELAY | COUNT_TRANSACTIONS_RETRIES |</span><br><span class="line">+---------------------------+---------------+-----------------+----------------------------+</span><br><span class="line">| group_replication_applier | ON            |            NULL |                          0 |</span><br><span class="line">+---------------------------+---------------+-----------------+----------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h5 id="参数解释-3"><a href="#参数解释-3" class="headerlink" title="参数解释"></a>参数解释</h5><table>
<thead>
<tr>
<th>Field</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>CHANNEL_NAME</td>
<td style="text-align:left">组复制通道的名称</td>
</tr>
<tr>
<td>SERVICE_STATE</td>
<td style="text-align:left">显示复制通道状态是ON还是OFF</td>
</tr>
<tr>
<td>REMAINING_DELAY</td>
<td style="text-align:left">如果从站在DESIRED_DELAY主站应用事件之后等待 秒数，则此字段包含剩余的延迟秒数。</td>
</tr>
<tr>
<td>COUNT_TRANSACTIONS_RETRIES</td>
<td style="text-align:left">显示由于从属SQL线程未能应用事务而发生的重试次数。</td>
</tr>
</tbody>
</table>
<h5 id="与show-slave-status的对应关系-1"><a href="#与show-slave-status的对应关系-1" class="headerlink" title="与show slave status的对应关系"></a>与show slave status的对应关系</h5><table>
<thead>
<tr>
<th>replication_connection_status Column</th>
<th style="text-align:left">SHOW SLAVE STATUS Column</th>
</tr>
</thead>
<tbody>
<tr>
<td>SERVICE_STATE</td>
<td style="text-align:left">None</td>
</tr>
<tr>
<td>REMAINING_DELAY</td>
<td style="text-align:left">SQL_Remaining_Delay</td>
</tr>
</tbody>
</table>
<h4 id="组复制中的server状态"><a href="#组复制中的server状态" class="headerlink" title="组复制中的server状态"></a>组复制中的server状态</h4><table>
<thead>
<tr>
<th>Field</th>
<th style="text-align:left">描述</th>
<th style="text-align:left">Group Synchronized</th>
</tr>
</thead>
<tbody>
<tr>
<td>ONLINE</td>
<td style="text-align:left">该成员可以作为一个具有所有功能的组成员,这意味着客户端可以连接并开始执行事务</td>
<td style="text-align:left">Yes</td>
</tr>
<tr>
<td>RECOVERING</td>
<td style="text-align:left">该成员正在成为该组的有效成员,并且正处于恢复过程中,从数据源节点接收状态信息</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td>OFFLINE</td>
<td style="text-align:left">插件已加载,但成员不属于任何组</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td>ERROR</td>
<td style="text-align:left">本地成员的状态,只要恢复阶段或应用更改时出现错误,server就会进入此状态</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td>UNREACHABLE</td>
<td style="text-align:left">每当本地故障检测器怀疑某个给定的server可能由于已经崩溃或被意外地断开而不可访问时,server的状态显示为”UNREACHABLE”</td>
<td style="text-align:left">No</td>
</tr>
</tbody>
</table>
<h4 id="threads"><a href="#threads" class="headerlink" title="threads"></a>threads</h4><p>group replication线程的状态信息可以通过performance_schema.threads表进行查询，目前可以查询到group replication的线程如下：  </p>
<ul>
<li>thread/group_rpl/THD_applier_module_receiver</li>
<li>thread/group_rpl/THD_certifier_broadcast</li>
<li>thread/group_rpl/THD_recovery<h3 id="新成员加入组"><a href="#新成员加入组" class="headerlink" title="新成员加入组"></a>新成员加入组</h3><h4 id="配置group-replication-recovery通道"><a href="#配置group-replication-recovery通道" class="headerlink" title="配置group_replication_recovery通道"></a>配置group_replication_recovery通道</h4>当新成员加入一个group replication组后，首先要从其他节点上把它加入之前的数据复制过来。这些以前的数据不能过group replication的通信协议进行复制，而是使用了异步复制的机制。group replication需要使用一个名叫group_replication_recovery的异步复制通道(Channel)。用户必须要提前配置这个通道，不过只需要为这个通道配置连接需要的用户名和密码，其他参数在group replication插件启动group_replication_recovery通道时会自动进行配置。  </li>
<li>change master to master_host=’rpl_user’,master_password=’rpl_pass’ fro channel = ‘group_replication_recovery’;</li>
<li>连接到哪个成员上去复制数据，是由group replication插件随机选择的，因此为group_replication_recovery配置的用户要在每一个成员上存在<br>在启动group_replication_recovery通道之前，group replication会自动为其配置master_host和master_port。当一个成员加入组时，会收到组内其他成员的配置信息。配置信息中包括主机名和MySQL服务端口号。主机名和服务端口号是从全局只读变量hostname和port中获取的。如果hostname无法正常解析成ip地址或网络中使用了网络地址映射，group_replication_recovery通道就无法正常工作。有如下两种办法来解决这个问题：  </li>
<li>在/etc/hosts中配置所有成员的主机名和ip地址的对应关系</li>
<li>配置MySQL的report_host和report_port的命令行参数。如果用户配置了report_host或report_port，那么group replication会优先使用这个变量中的地址和端口<h4 id="成员加入组的步骤"><a href="#成员加入组的步骤" class="headerlink" title="成员加入组的步骤"></a>成员加入组的步骤</h4>MySQL的相关配置和创建复制用户的步骤略，group replication加入组的步骤如下：</li>
<li>INSTALL PLUGIN group_replication SONAME ‘group_replication.so’;</li>
<li>SET GLOBAL group_replication_group_name = “aaaaaaaa-aaaa-aaaa-aaaa-aaaaaaaaaaaa”;</li>
<li>SET GLOBAL group_replication_local_address= “127.0.0.1:10014”</li>
<li>SET GLOBAL group_replication_group_seeds= “127.0.0.1:10011,127.0.0.1:10012,127.0.0.1:10013,127.0.0.1:10014”</li>
<li>CHANGE MASTER TO MASTER_USER=’rpl_user’,MASTER_PASSWORD=’rpl_pass’ FOR CHANNEL ‘group_replication_recovery’;</li>
<li>START GROUP_REPLICATION;<br>这里不再做演示，还是保持上文中三节点。<h3 id="强制移除故障成员"><a href="#强制移除故障成员" class="headerlink" title="强制移除故障成员"></a>强制移除故障成员</h3>当故障导致半数以上的成员不可用时，group replication就不能对外提供服务，当这种情况发生时，可以设置指定的成员能够立刻对外提供服务。虽然冗余能力不好，但至少能保障业务不中断。可通过以下设置：  </li>
<li>SET GLOBAL group_replication_force_members = <a href="ip:port,ip:port" target="_blank" rel="noopener">ip:port,ip:port</a><br>group_replication_force_members中配置的是成员地址的列表，只需要在列表中的任意一个成员上设置即可，这个就是强制group replication用参数中的几个成员来构成组，把其他成员从组中移除出去。<h2 id="故障演练"><a href="#故障演练" class="headerlink" title="故障演练"></a>故障演练</h2>通过模拟其中一个节点故障后,主节点是否会自动迁移,故障节点恢复后,数据是否会自动同步<h3 id="查看当前组复制状态"><a href="#查看当前组复制状态" class="headerlink" title="查看当前组复制状态"></a>查看当前组复制状态</h3>登录节点1,查看组复制状态,确认当前节点1为主节点<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock   </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 30</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span><br><span class="line">| group_replication_applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group_replication_applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from performance_schema.global_status where variable_name = &apos;group_replication_primary_member&apos;;</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| VARIABLE_NAME                    | VARIABLE_VALUE                       |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| group_replication_primary_member | c0acc2c7-d58a-11e7-b59f-00163e00dc49 |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="模拟主节点故障"><a href="#模拟主节点故障" class="headerlink" title="模拟主节点故障"></a>模拟主节点故障</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; shutdown;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="确认当前组复制状态"><a href="#确认当前组复制状态" class="headerlink" title="确认当前组复制状态"></a>确认当前组复制状态</h3><p>节点1的9001服务已经不存在,通过登录9002查看组成员状态,9002节点已经成为新节点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# netstat -tunlp|grep mysql|grep 900                                         </span><br><span class="line">tcp        0      0 0.0.0.0:9002                0.0.0.0:*                   LISTEN      22034/mysqld        </span><br><span class="line">tcp        0      0 0.0.0.0:9003                0.0.0.0:*                   LISTEN      6059/mysqld         </span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 28</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group_replication_applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from performance_schema.global_status where variable_name = &apos;group_replication_primary_member&apos;;</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| VARIABLE_NAME                    | VARIABLE_VALUE                       |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| group_replication_primary_member | cf04e66c-d58a-11e7-b97e-00163e00dc49 |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="组复制新主节点插入数据"><a href="#组复制新主节点插入数据" class="headerlink" title="组复制新主节点插入数据"></a>组复制新主节点插入数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; create table test.t2(id int unsigned not null auto_increment primary key,age int);</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test.t2 values(null,111111);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test.t2;</span><br><span class="line">+----+--------+</span><br><span class="line">| id | age    |</span><br><span class="line">+----+--------+</span><br><span class="line">|  2 | 111111 |</span><br><span class="line">+----+--------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<h3 id="从节点查看数据"><a href="#从节点查看数据" class="headerlink" title="从节点查看数据"></a>从节点查看数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock   </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 46</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test.t2;</span><br><span class="line">+----+--------+</span><br><span class="line">| id | age    |</span><br><span class="line">+----+--------+</span><br><span class="line">|  2 | 111111 |</span><br><span class="line">+----+--------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt;</span><br></pre></td></tr></table></figure>
<h3 id="故障节点恢复"><a href="#故障节点恢复" class="headerlink" title="故障节点恢复"></a>故障节点恢复</h3><p>故障节点恢复后,登录实例,启动组复制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysqld_safe --defaults-file=/hwdata/data/mysql5.7.20/conf/s1.cnf &amp; </span><br><span class="line">[6] 22692</span><br><span class="line">[root@jiessie mysql5.7.20]# 2017-12-01T07:35:42.377430Z mysqld_safe Logging to &apos;/hwdata/data/mysql5.7.20/data/s1/jiessie.err&apos;.</span><br><span class="line">2017-12-01T07:35:42.396416Z mysqld_safe Starting mysqld daemon with databases from /hwdata/data/mysql5.7.20/data/s1</span><br><span class="line"></span><br><span class="line">[root@jiessie mysql5.7.20]# netstat -tunlp|grep mysql|grep 900</span><br><span class="line">tcp        0      0 0.0.0.0:9001                0.0.0.0:*                   LISTEN      23135/mysqld        </span><br><span class="line">tcp        0      0 0.0.0.0:9002                0.0.0.0:*                   LISTEN      22034/mysqld        </span><br><span class="line">tcp        0      0 0.0.0.0:9003                0.0.0.0:*                   LISTEN      6059/mysqld         </span><br><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e &quot;START GROUP_REPLICATION;&quot;</span><br><span class="line">[root@jiessie mysql5.7.20]#</span><br></pre></td></tr></table></figure></p>
<h3 id="再次查看组复制状态及插入数据状态"><a href="#再次查看组复制状态及插入数据状态" class="headerlink" title="再次查看组复制状态及插入数据状态"></a>再次查看组复制状态及插入数据状态</h3><p>故障节点已经加入到组复制中,同时故障期间插入的数也已经同步过来,主节点还是节点2的9002实例<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie mysql5.7.20]# base/bin/mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 48</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span><br><span class="line">| group_replication_applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group_replication_applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from performance_schema.global_status where variable_name = &apos;group_replication_primary_member&apos;;</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| VARIABLE_NAME                    | VARIABLE_VALUE                       |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| group_replication_primary_member | cf04e66c-d58a-11e7-b97e-00163e00dc49 |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test.t2;</span><br><span class="line">+----+--------+</span><br><span class="line">| id | age    |</span><br><span class="line">+----+--------+</span><br><span class="line">|  2 | 111111 |</span><br><span class="line">+----+--------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h2 id="组复制系统变量"><a href="#组复制系统变量" class="headerlink" title="组复制系统变量"></a>组复制系统变量</h2><table>
<thead>
<tr>
<th>变量名</th>
<th style="text-align:left">变量范围</th>
<th style="text-align:left">动态变量</th>
<th style="text-align:left">类型</th>
<th style="text-align:left">默认</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_group_name" target="_blank" rel="noopener">group_replication_group_name</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">此server实例所属组名称,须是UUID格式</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_start_on_boot" target="_blank" rel="noopener">group_replication_start_on_boot</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">ON</td>
<td style="text-align:left">server是否应在自身启动期间启动组复制</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_local_address" target="_blank" rel="noopener">group_replication_local_address</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">作为本地地址,格式为主机:端口</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_member_weight" target="_blank" rel="noopener">group_replication_member_weight</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">50</td>
<td style="text-align:left">可以分配成员的百分比权重,影响成员在发生故障转移时作为主要成员选举的机会</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_group_seeds" target="_blank" rel="noopener">group_replication_group_seeds</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">提供加入成员的成员列表,其中加入成员需要的数据以获得与该组的同步</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_force_members" target="_blank" rel="noopener">group_replication_force_members</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">以逗号分隔开的组内其他成员的地址列表.此选项用于强制建立新的组成员关系,在此过程中已排除的成员不接收新的视图并且被排除在外.您需要手动移除已排除的server</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_bootstrap_group" target="_blank" rel="noopener">group_replication_bootstrap_group</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">OFF</td>
<td style="text-align:left">配置此server以引导组,此选项只能在一个server上设置,且只能在首次启动组或重启整个组时设置.组被引导后,将此选项设置为OFF.</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_poll_spin_loops" target="_blank" rel="noopener">group_replication_poll_spin_loops</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">0</td>
<td style="text-align:left">在组通信线程等待传入更多的网络信息之前,等待mutex被释放的次数</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_retry_count" target="_blank" rel="noopener">group_replication_recovery_retry_count</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">10</td>
<td style="text-align:left">要加入的成员尝试连接到可用数据源节点的次数</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_reconnect_interval" target="_blank" rel="noopener">group_replication_recovery_reconnect_interval</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">60</td>
<td style="text-align:left">在组中找不到数据源节点时,重新尝试连接的时间间隔</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_use_ssl" target="_blank" rel="noopener">group_replication_recovery_use_ssl</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">OFF</td>
<td style="text-align:left">组复制恢复通道是否使用SSL</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_ca" target="_blank" rel="noopener">group_replication_recovery_ssl_ca</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">包含受信任SSL证书颁发机构列表的文件的路径</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_capath" target="_blank" rel="noopener">group_replication_recovery_ssl_capath</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">包含受信任SSL证书颁发证书的目录路径</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_cert" target="_blank" rel="noopener">group_replication_recovery_ssl_cert</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">用于建立安全连接的SSL证书文件的名称</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_key" target="_blank" rel="noopener">group_replication_recovery_ssl_key</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">用于建立安全连接的SSL密钥文件的名称</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_cipher" target="_blank" rel="noopener">group_replication_recovery_ssl_cipher</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">用于SSL加密的密码列表</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_crl" target="_blank" rel="noopener">group_replication_recovery_ssl_crl</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">包含具有证书撤销列表文件的路径</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_crlpath" target="_blank" rel="noopener">group_replication_recovery_ssl_crlpath</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">NULL</td>
<td style="text-align:left">包含具有证书撤销列表文件的路径</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_ssl_verify_server_cert" target="_blank" rel="noopener">group_replication_recovery_ssl_verify_server_cert</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">OFF</td>
<td style="text-align:left">在恢复过程中用于检查数据源节点发送证书中的”通用名称”</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_recovery_complete_at" target="_blank" rel="noopener">group_replication_recovery_complete_at</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">enumeration</td>
<td style="text-align:left">TRANSACTIONS_APPLIED</td>
<td style="text-align:left">状态传输后处理缓存中的事务时的恢复策略.此选项指定成员在”接收到加入群组(TRANSACTIONS_CERTIFIED)之前遗漏的所有事务”或”收到并应用了这些事务(TRANSACTIONS_APPLIED)”之后,是否标记在线</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_components_stop_timeout" target="_blank" rel="noopener">group_replication_components_stop_timeout</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">31536000</td>
<td style="text-align:left">组复制在关闭时等待每个组件的超时时间,以秒为单位</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_allow_local_lower_version_join" target="_blank" rel="noopener">group_replication_allow_local_lower_version_join</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">OFF</td>
<td style="text-align:left">即使当前server的插件版本比组的插件版本低,也允许它加入组</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_allow_local_disjoint_gtids_join" target="_blank" rel="noopener">group_replication_allow_local_disjoint_gtids_join</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">OFF</td>
<td style="text-align:left">即使含有组中不存在的事务,也允许当前server加入组,此选项要慎重,可能会破坏组内一致性</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_auto_increment_increment" target="_blank" rel="noopener">group_replication_auto_increment_increment</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">7</td>
<td style="text-align:left">确定在此server实例上执行的连续事务之间的步长</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_compression_threshold" target="_blank" rel="noopener">group_replication_compression_threshold</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">1000000</td>
<td style="text-align:left">以字节为单位,超过该值将强制执行lz4压缩,当设置为0时,压缩设置无效</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_gtid_assignment_block_size" target="_blank" rel="noopener">group_replication_gtid_assignment_block_size</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">1000000</td>
<td style="text-align:left">为每个成员保留的连接GTID数量,每个成员在开始时会消耗掉一些,当需要时在获取更多个</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_ssl_mode" target="_blank" rel="noopener">group_replication_ssl_mode</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">enumeration</td>
<td style="text-align:left">DISABLED</td>
<td style="text-align:left">指定组复制成员之间连接的安全状态</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_single_primary_mode" target="_blank" rel="noopener">group_replication_single_primary_mode</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">ON</td>
<td style="text-align:left">设置组自动选择一个server来处理读写工作,这个server是主(primary),所有其他都是从(secondaries)</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_transaction_size_limit" target="_blank" rel="noopener">group_replication_transaction_size_limit</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">0</td>
<td style="text-align:left">配置组接受最大事务大小,以字节为单位,大于这个事务被回滚.当设置为0时,无限制</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_unreachable_majority_timeout" target="_blank" rel="noopener">group_replication_unreachable_majority_timeout</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">0</td>
<td style="text-align:left">配置在离开组之前遭受网络分区且无法连接到大多数成员的成员需要等待多长时间,默认情况为0,这意味着由于网络分区而成为少数的成员永远等待连接组.</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_enforce_update_everywhere_checks" target="_blank" rel="noopener">group_replication_enforce_update_everywhere_checks</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">boolean</td>
<td style="text-align:left">OFF</td>
<td style="text-align:left">多主模式下为多主更新或禁用严格一致性检查</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_flow_control_mode" target="_blank" rel="noopener">group_replication_flow_control_mode</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">enumeration</td>
<td style="text-align:left">QUOTA</td>
<td style="text-align:left">指定启用限流模式,不需要重置组复制就可以修改此变量</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_flow_control_certifier_threshold" target="_blank" rel="noopener">group_replication_flow_control_certifier_threshold</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">25000</td>
<td style="text-align:left">触发限流的验证队列的阈值,不需要重置组复制就可以修改此变量</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_flow_control_applier_threshold" target="_blank" rel="noopener">group_replication_flow_control_applier_threshold</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">integer</td>
<td style="text-align:left">25000</td>
<td style="text-align:left">触发限流的应用队列的阈值,不需要重置组复制就可以修改此变量</td>
</tr>
<tr>
<td><a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-options.html#sysvar_group_replication_ip_whitelist" target="_blank" rel="noopener">group_replication_ip_whitelist</a></td>
<td style="text-align:left">Global</td>
<td style="text-align:left">Yes</td>
<td style="text-align:left">string</td>
<td style="text-align:left">AUTOMATIC</td>
<td style="text-align:left">指定允许哪些主机可以访问组,默认为AUTOMATIC,它允许来自主机上的私有子网的连接,多个以逗号分隔</td>
</tr>
</tbody>
</table>
<h2 id="组复制的多主和单主模式"><a href="#组复制的多主和单主模式" class="headerlink" title="组复制的多主和单主模式"></a>组复制的多主和单主模式</h2><p>默认为单主模式,组中的成员不可能以不同的模式部署,例如一个配置为多主模式,另一个配置为单主模式.要切换模式,组和服务器之间需要不的操作配置重新启动.无论部署模式如何,组复制不处理客户端故障切换,必须由应用程序本身,连接器或中间件框架如代理或路由器来处理.  </p>
<h3 id="单主模式"><a href="#单主模式" class="headerlink" title="单主模式"></a>单主模式</h3><p>在此模式下,该组具有设置为读写械的单主服务器,组中的所有其他成员都设置为只读模式(超级只读模式super_read_only),所有其他加入的节点自动识别主节点并设置为自己为只读.</p>
<h4 id="选主过程"><a href="#选主过程" class="headerlink" title="选主过程"></a>选主过程</h4><p>参考官方流程图:<br><img src="https://dev.mysql.com/doc/refman/5.7/en/images/single-primary-election.png" alt="image">在单主机模式下，将禁用在多主机模式下部署的某些检查，因为系统会强制每次只有一个写入节点。例如，允许对具有级联外键的表进行更改，而在多主模式下不允许。在主节点故障时，自动选举机制选择下一个主节点。通过按字典顺序（使用其UUID）并选择列表中的第一个节点来排序剩余的节点来选择下一个主节点,可通过group_replication_member_weight此参数影响选主。如果主节点从组中删除，则执行选择，并从组中的其余节点中选择新的主节点，这个选择按照词典顺序排序节点UUID并选择第一个来执行。一旦选择了新的主节点，其他节点将设置为从节点，从节点为只读。</p>
<h3 id="多主模式"><a href="#多主模式" class="headerlink" title="多主模式"></a>多主模式</h3><p>在多主模式下，没有单个主模式的概念，也没有选举程序，因为没有节点发挥任何特殊的作用。加入组时，所有服务器都设置为读写模式。<br>在多主模式下部署时,将检查语句以确保他们与模式兼容,以多主模式部署组复制时进行以下检查:  </p>
<ol>
<li>如果一个事务在SERIALIZABLE隔离级别下执行，那么当它自己与该组同步时，它的提交失败。</li>
<li>如果事务针对具有级联约束的外键的表执行，则在与组自身同步时，事务无法提交。<br>这些检查可以通过设置选项来禁用 group_replication_enforce_update_everywhere_checks 到FALSE。在单主模式下部署时，必须将此选项设置为FALSE。<h4 id="客户端故障转移"><a href="#客户端故障转移" class="headerlink" title="客户端故障转移"></a>客户端故障转移</h4>参考官方流程图:<br><img src="https://dev.mysql.com/doc/refman/5.7/en/images/multi-primary.png" alt="image"><h4 id="自增字段的处理"><a href="#自增字段的处理" class="headerlink" title="自增字段的处理"></a>自增字段的处理</h4>当使用多主模式时，需要设置autoincrement相关的参数来保证自增字段在每个成员上产生不同的值。group replication提供了两种配置方式，分别如下：</li>
<li>直接配置MySQL的系统变量，通过命令来配置时，需要在所有成员上配置下面两个参数</li>
</ol>
<ul>
<li>set global auto_increment_offset = N;</li>
<li>set global auto_increment_increment = N;</li>
</ul>
<ol start="2">
<li>通过group replication插件来配置，group replication插件定义了一个新的参数来配置自增字段的大小，上面的参数列表中也有解释</li>
</ol>
<ul>
<li>set global group_replication_auto_increment_increment = N;<br>group_replication_auto_increment_increment的默认值是7。如果自增值的浪费不对业务千万影响，可以不用修改这个值。group replication没有提供新的参数来设置自增值的偏移，而是将MySQL服务器的server-id看作自增值的偏移。如果用户的server-id本来就是按照1、2、3这样的顺序配置的，就不需要再做额外的配置。在启动group replication插件时，它会检测用户是否配置了MySQL的自增变量。如果用户没有配置这两个参数（auto_increment_offset和auto_increment_increment都为1），则会自动将group_replication_auto_increment_increment和server-id的值设置到MySQL的auto_increment_increment和auto_increment_offset全局变量中。<br>自增变量将从1开始的连续自增值划分为固定大小的段，各个MySQL服务器分别使用段内不同偏移量的自增值。auto_increment_increment代表段的大小，每个成员都应该配置相同的段大小。而auto_increment_offset是本成员 的自增值在段内的偏移。每个成员应该设置不同的偏移量。假设段的大小设为5，成员A的偏移量设为1，成员B的偏移量设为2，那么成员A上产生的自增值为：1、6、11、16……，成员B上产生的自增值为：2、7、12、17……。如下图所示：<h5 id="自增ID示例图"><a href="#自增ID示例图" class="headerlink" title="自增ID示例图"></a>自增ID示例图</h5></li>
<li>| 偏移1 | 偏移2 | 偏移3 | 偏移4 | 偏移5<br>—|—|—|—|—|—<br>第一段 | 1 | 2 | 3 | 4 | 5 |<br>第二段 | 6 | 7 | 8 | 9 | 10 |<br>第三段 | 11 | 12 | 13 | 14 | 15 |<br>第四段 | 16 | 17 | 18 | 19 | 20 |<br>… | … | … | … | … | … |<br>可以看出，自增字段的大小依赖于group replication组中的成员的多少。auto_increment_increment最小要等于group replication组内的数量。如果段的大小等于组内的数量，则所有的自增id都会被使用。如果段的大小大于组内的成员的数量，则有一部自增值永远不会被使用，会千万一定的浪费。比如，组内有3个成员，偏移分别是1、2、3，而段的大小是5，那么偏移4和5上的值就会被浪费掉。考虑到group replication组的扩展，最好将段的大小设置得比现有的组内成员数量大一些。这样虽然会浪费一些自增值，但是扩展会很简单。在使用的过程中变更自增字段的大小，处理起来会比较麻烦，所以要提前规划好。<h5 id="自增字段演示"><a href="#自增字段演示" class="headerlink" title="自增字段演示"></a>自增字段演示</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock -e &quot;show variables like &apos;server_id&apos;;&quot;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| server_id     | 1     |</span><br><span class="line">+---------------+-------+</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock -e &quot;show variables like &apos;server_id&apos;;&quot;  </span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| server_id     | 2     |</span><br><span class="line">+---------------+-------+</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock -e &quot;show variables like &apos;server_id&apos;;&quot;   </span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| server_id     | 3     |</span><br><span class="line">+---------------+-------+</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s1/s1.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 37</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like &apos;group_replication_auto_increment_increment&apos;;</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| Variable_name                              | Value |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">| group_replication_auto_increment_increment | 5     |</span><br><span class="line">+--------------------------------------------+-------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from performance_schema.global_status where variable_name = &apos;group_replication_primary_member&apos;;</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| VARIABLE_NAME                    | VARIABLE_VALUE                       |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">| group_replication_primary_member | c0acc2c7-d58a-11e7-b59f-00163e00dc49 |</span><br><span class="line">+----------------------------------+--------------------------------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT * FROM performance_schema.replication_group_members;</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| CHANNEL_NAME              | MEMBER_ID                            | MEMBER_HOST | MEMBER_PORT | MEMBER_STATE |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">| group_replication_applier | c0acc2c7-d58a-11e7-b59f-00163e00dc49 | jiessie     |        9001 | ONLINE       |</span><br><span class="line">| group_replication_applier | cf04e66c-d58a-11e7-b97e-00163e00dc49 | jiessie     |        9002 | ONLINE       |</span><br><span class="line">| group_replication_applier | d4286108-d58a-11e7-807d-00163e00dc49 | jiessie     |        9003 | ONLINE       |</span><br><span class="line">+---------------------------+--------------------------------------+-------------+-------------+--------------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; create table test.t0(id int unsigned not null primary key auto_increment,name varchar(20));            </span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test.t0 values(null,&apos;111&apos;),(null,&apos;222&apos;),(null,&apos;333&apos;);</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test.t0;</span><br><span class="line">+----+------+</span><br><span class="line">| id | name |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | 111  |</span><br><span class="line">|  6 | 222  |</span><br><span class="line">| 11 | 333  |</span><br><span class="line">+----+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s2/s2.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 27</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test.t0 values(null,&apos;aaa&apos;),(null,&apos;bbb&apos;),(null,&apos;ccc&apos;);</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test.t0;</span><br><span class="line">+----+------+</span><br><span class="line">| id | name |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | 111  |</span><br><span class="line">|  2 | aaa  |</span><br><span class="line">|  6 | 222  |</span><br><span class="line">|  7 | bbb  |</span><br><span class="line">| 11 | 333  |</span><br><span class="line">| 12 | ccc  |</span><br><span class="line">+----+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie percona]# mysql -uroot -S /hwdata/data/mysql5.7.20/data/s3/s3.sock</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 23</span><br><span class="line">Server version: 5.7.20-log MySQL Community Server (GPL)</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">mysql&gt; insert into test.t0 values(null,&apos;123&apos;),(null,&apos;456&apos;),(null,&apos;789&apos;);</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Records: 3  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test.t0;</span><br><span class="line">+----+------+</span><br><span class="line">| id | name |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | 111  |</span><br><span class="line">|  2 | aaa  |</span><br><span class="line">|  3 | 123  |</span><br><span class="line">|  6 | 222  |</span><br><span class="line">|  7 | bbb  |</span><br><span class="line">|  8 | 456  |</span><br><span class="line">| 11 | 333  |</span><br><span class="line">| 12 | ccc  |</span><br><span class="line">| 13 | 789  |</span><br><span class="line">+----+------+</span><br><span class="line">3 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@jiessie percona]#</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="DDL语句并发执行的问题"><a href="#DDL语句并发执行的问题" class="headerlink" title="DDL语句并发执行的问题"></a>DDL语句并发执行的问题</h4><p>多主复制时，通过冲突检测来辨别有冲突的事务，有冲突的事务通过回滚操作来处理。MySQL5.7上的DDL不是原子操作无法回滚，因此group replication没有对DDL做冲突检测。换句话说，DDL语句不会和其他任何语句冲突（包括DML和DDL）。如果DDL和有冲突的语句在不同的成员上同时执行，可能导致错误或数据不一致。假设在成员A上执行如下事务：  </p>
<ul>
<li>BEGIN;</li>
<li>INSERT INTO t1 values(1);<br>此时，成员B上执行以下语句：  </li>
<li>TRUNCATE TABLE t1;<br>成员A上接着执行：  </li>
<li>COMMIT;<br>成员A上两个事务的执行顺序是：  </li>
<li>INSERT INTO t1 VALUES(1);</li>
<li>TRUNCATE TABLE t1;<br>成员B上两个事务的执行顺序是：  </li>
<li>TRUNCATE TABLE t1;</li>
<li>INSERT INTO t1 VALUES(1);<br>这就会导致两个成员上数据的不一致。因此多主模式下，执行任何DDL前，要将可能有冲突的事务迁移到同一台MySQL服务器上，再开始执行DDL语句。<h2 id="组复制基本原理"><a href="#组复制基本原理" class="headerlink" title="组复制基本原理"></a>组复制基本原理</h2><h3 id="状态机复制"><a href="#状态机复制" class="headerlink" title="状态机复制"></a>状态机复制</h3>本质上来说，group replication是一个状态机复制的集群。在状态机复制的架构中，数据库被当作一个状态机。每一次写操作都会导致数据库的状态变化。为了创建一个高可用的数据库集群，有一个组件将这些操作按照同样的顺序发送到多个初始状态一致的数据库上，让这些数据库执行同样的操作。因为初始状态相同，每次执行的操作也相同，所以每次状态变化后各个数据库服务器上的数据保持一致。下图是一个非常简单的状态机复制的示意图。<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/1E369A3D807949C1B0B563C5F04A6165/41768" alt="image"><br>假设图中数据库DB1、DB2和DB3的初始状态是相同的，事务T1、T2和T3分别如下：  </li>
</ul>
<ol>
<li>#T1<blockquote>
<p>DELETE FROM t1 WHERE pk = 1;</p>
</blockquote>
</li>
<li>#T2<blockquote>
<p>UPDATE t1 SET c1 = 100 WHERE pk = 1;</p>
</blockquote>
</li>
<li>#T3<blockquote>
<p>UPDATE t1 SET c1 = 50 WHERE pk = 1;<br>3个客户端并发地将这3个事务发送到事务分发器上，事务分发器首先对这3个事务进行排序 ，然后按照同样的顺序（T3、T1、T2）并发地发送到DB1、DB2和DB3这3个数据库上去执行。T3最先在DB1、DB2和DB3上执行，执行完后，DB1、DB2和DB3上的结果相同。接着T1被执行，执行后DB1、DB2和DB3上t1表中pk为1的记录都被删除了。最后T2被执行，由于T1删除了记录，因此T2执行时会失败。T2在DB1、DB2和DB3上都会失败，所以DB1、DB2和DB3的数据仍然是一致的。  </p>
</blockquote>
<h3 id="分布式的状态机复制"><a href="#分布式的状态机复制" class="headerlink" title="分布式的状态机复制"></a>分布式的状态机复制</h3>在上图的模型中，事务分发器是一个单点故障点。为了避免单点故障，可以采用分布式的状态机复制。在分布式的状态机复制中，有多个事务分发器，它们彼此相互通信。事务分发器可以同时接收事务请求，就像单个事务分发器同时接收事务请求一样。从应用层面来说并发的事务发到同一个事务分发器和发到不同的事务分发器上效果是一样的。事务分发器之间会相互通信，把所有的事务汇总、排序。最终，每个事务分发器上都有一份完整的排好序的事务请求。每个事务分发器只连接到一台数据库服务器上，并负责把事务请求依次发送到这个相连的数据库上去执行。下图所示的是分布式状态机复制的一个模式。<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/9259ECA7A83F43FCA15A73FFE800D447/41765" alt="image"><br>数据库DB1、DB2和DB3的初始状态是相同的，事务T1、T2和T3分别如下：  </li>
<li>#T1<blockquote>
<p>DELETE FROM t1 WHERE pk = 1;</p>
</blockquote>
</li>
<li>#T2<blockquote>
<p>UPDATE t1 SET c1 = 100 WHERE pk = 1;</p>
</blockquote>
</li>
<li>#T3<blockquote>
<p>UPDATE t1 SET c1 = 50 WHERE pk = 1;<br>3个客户端并发地将这3个事务发送到各自的事务分发器上。事务分发器彼此之间互相通信，最终每个事务分发器上都会有一份完整的顺序一样的事务请求列表（T3、T1、T2）。3个事务分发器将这些事务请求按照顺序发送到各自的数据库服务器上去执行。T3最先在DB1、DB2和DB3上执行，执行完后DB1、DB2和DB3上的结果相同。接着T1被执行，执行后DB1、DB2和DB3上t1表中pk为1的记录都被删除了。最后T2被执行，由于T1删除了记录，T2在DB1、DB2和DB3上都会失败，所以DB1、DB2和DB3的数据仍然是一致的。<br>不管是单个事务分发器还是多个事务分发协同工作，它们的目标都是一样的：将所有的事务按照同样的顺序发送到数据库服务器上去执行。  </p>
</blockquote>
<h3 id="分布式的高可用数据库"><a href="#分布式的高可用数据库" class="headerlink" title="分布式的高可用数据库"></a>分布式的高可用数据库</h3>如果将上图中的事务分发器集成到数据库系统中，就变成了一个分布式的高可用数据库系统，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/BD936C654F294854BC735E45E94327AB/41797" alt="image"><br>用户通过数据库服务器的用户接口执行事务。数据库服务器收到事务请求后，首先交由事务分发模块处理。事务分发模块将事务汇总排序，然后依次交由数据处理模块去执行这些事务。如果去年内部的细节，就会发现这是一个非常简洁的数据库集群方案。通过group replication构建的MySQL集群就是这样一个分布式的高可用MySQL系统。整个集群的架构如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/53E2199DB34F47618272939F924E5820/41808" alt="image">  <h2 id="深入理解组复制中事务的执行过程"><a href="#深入理解组复制中事务的执行过程" class="headerlink" title="深入理解组复制中事务的执行过程"></a>深入理解组复制中事务的执行过程</h2>从上文中的模型可以知道，group replication插件中最重要的功能就是事务分发器的功能。group replication中实现的事务分发器和模型中的略有不同。在模型中，假设事务分发器分发的是事务的SQL语句，也就是说事务分发器的处理是在事务执行前。而在group replication中，事务分发器分发的是Binlog Event，事务分发器的处理是在事务执行即将结束的时候。group replication将这称作乐观的事务执行策略，可以带来更好的性能。但是在这种策略下，多个成员的事务可能发生冲突。group replication需要一个冲突检测机制来发现并处理冲突。由于Binlog Event的执行和SQL语句的执行过程是不一样的，group replication就用到异步复制中Binlog Event的执行模块。为了更好地理解group replication事务执行的过程，这里将group replication处理的事务分为本地事务和异地事务。本地事务指的是用户Session中或异步复制线程中执行的事务。异地事务指的是group replication中传播的由Binlog Event构成的事务。<br>根据事务处理过程中的不同处理步骤，group replication中事务分发器的功能划分为以下四部分。</li>
</ol>
<ul>
<li>本地事务控制模块</li>
<li>成员间的通信模块</li>
<li>全局事务认证模块</li>
<li>异地事务执行模块<h3 id="本地事务控制模块"><a href="#本地事务控制模块" class="headerlink" title="本地事务控制模块"></a>本地事务控制模块</h3>MySQL通过API向插件提供了事务执行过程中几个重要阶段的监控接口，group replication通过这些接口来监控和控制接口的执行。MySQL的事务在提交时，内部会分为三个阶段：准备(prepare)阶段、记录Binlog文件阶段和提交(commit)阶段。group replication对本地事务的控制逻辑在before_commit这个接口中执行。before_commit是在事务的prepare阶段之后，写Binlog文件阶段之前被执行的。对本地事务的控制包括以下三个步骤：<h4 id="发送事务信息"><a href="#发送事务信息" class="headerlink" title="发送事务信息"></a>发送事务信息</h4>group replication首先会将事务执行的相关信息打包，通过通信模块的接口发送给本地的通信模块。本地事务控制模块只发送信息，不接收任何信息。因此，这个通信是异步过程。只要本地的通信模块接收了消息就返回成功。发送到其他成员是通信模块的职责。事务信息包括主键信息、数据库快照版本和事务产生的Binlog Events。</li>
<li>主键信息是Server层生成Binlog Event的时候一同生成的。是否记录主键信息是通过transaction_write_set_extraction变量来控制的。主键信息中记录的并不是主键字段的值，而是字段值加上库名、表名等哈希值。</li>
<li>数据库快照版本是当前MySQL的全局变量gtid_executed的值。它包含了当前事务提交时所有已经执行了的事务的GTID，代表了当前事务执行时数据库的状态，因此称为数据库的快照版本。</li>
<li>当发送事务信息时，Binlog Event还没有写入Binlog文件。因此，Binlog Event是从当前线程的Binlog Cache中获取的，而不是依赖于Binlog文件。</li>
<li>Transaction_context_log_event，本地成员的UUID、主键信息和数据库快照版本会被封装进Transaction_context_log_event中，和事务产生的Binlog Event一起发送出去。Transaction_context_log_event放在其他Binlog Event前面。<h4 id="等待全局事务认证模块的认证结果"><a href="#等待全局事务认证模块的认证结果" class="headerlink" title="等待全局事务认证模块的认证结果"></a>等待全局事务认证模块的认证结果</h4>在事务信息发送成功后，事务会被阻塞，开始等待全局事务认证模块的认证结果。事务认证完成后，全局事务认证模块会唤醒当前事务的线程，让事务继续执行。<h4 id="认证结果的处理"><a href="#认证结果的处理" class="headerlink" title="认证结果的处理"></a>认证结果的处理</h4>这个过程实际上是由MySQL的代码执行的，而不是由group replication的代码执行的。在哪里执行的并不重要，只要理解这个过程就好。事务继续执行后，会检测 认证结果。如果认证成功，就继续提交事务，如果认证失败就会返回错误。然后由MySQL来执行Rollback的逻辑。<h3 id="成员间的通信模块"><a href="#成员间的通信模块" class="headerlink" title="成员间的通信模块"></a>成员间的通信模块</h3>通信模块分为三部分，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/0E5E7CCE172449C6990D237B25C46493/41896" alt="image">  </li>
</ul>
<ol>
<li>本地数据接收部分负责接收本地成员上其他模块的数据发送请求，接收到的数据包被放入本地数据队列等待处理。</li>
<li>成员间的通信部分负责和其他成员通信。通信工作包括：从本地数据队列读取数据包发送给其他成员，以及接收其他成员发送过来的数据包。各个成员之间的通信使用了Paxos协议，Paxos协议是一个分布式的一致性协议。</li>
<li>全局数据包发送部分将所有的数据包顺序返回给本地成员上的全局事务认证模块。<br>当各个成员的通信模块接收到上层模块的数据发送请求时，这些并发的数据请求是无序的，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/69AF4FC0CD2B461FA576430FEE91F002/41910" alt="image"><br>3个成员分别有1个数据包，分别是T1、T2和T3产生的数据包。这些并发、无序的数据包会通过Paxos协议汇聚到每个成员上，并且排序。最终每个成员的通信模块都会拥有同样的数据库包，这些数据包会按照同样的顺序发送到各自成员上的全局事务认证模块，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/E89D346C4CE0480E997A46F6598991D8/41920" alt="image"><br>Paxos协议的工作核心就是对所有数据包进行汇聚和排序。为了完成上面的功能，Paxos协议本身会进行三次TCP通信，如下：</li>
</ol>
<ul>
<li>发送数据包给其他成员的通信模块</li>
<li>其他成员的通信模块回应收到的数据包</li>
<li>当超过半数的通信模块(包括它自己)回应后，发送消息告诉所有节点这个数据包同步成功。只有当Paxos协议的三个步骤成功完成后通讯模块才会把这个数据包发送给全局认证模块。这就像是两个公司谈合作经办人多轮协商把所有的条款都谈妥没有异议了，然后才通知老板准备签约。<br>为了保证数据按照同样的顺序发送到全局事务认证模块，Paxos协议还会为每个同步成功的数据包分配一个唯一的ID，当各个成员上的通信模块向上层模块发送这些数据包时，会按照数据包的ID以小到大的顺序发送给全局认证模块。这个ID由两部分组成，分别如下：  </li>
<li>成员序号：每个成员在加入组后，就会获得一个组内成员的唯一序号，这个成员发出的所有数据包都会使用这个成员序号。</li>
<li>自增序号：每个成员的通信模块都会维护一个自增的序号，按照发送数据包的顺序，给每个数据包分配一个顺序号。<br>如图所示，假设一个组有三个成员，那么顺序号为1的成员上的数据包ID是1:1,2:1,…,N:1。顺序号为2的成员上的数据包ID是1:2,2:2,…,N:2。顺序号为3的成员上的数据包ID是1:3,2:3,…,N:3。<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/2E3B711A745D4835804B8C73B3828D5C/41969" alt="image"><br>当向全局认证模块发送这些数据包时，必须按照ID连续发送，不能跳过某个ID的数据包。本质上来说，这是一个轮训(Round Robin)的过程。先发送成员1的第一个数据包，接着发送成员2的第一个数据包，然后发送成员3的第一个数据包，如图所示。<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/8C70F6129567449EAAA0402A5BE74797/41980" alt="image"><br>如果在这个过程中，成员2上的数据包还没有同步成功呢？这时候就得等着，直到成员2的第一个数据包同步成功的后，才能返回给全局认证模块，然后继续返回成员3的数据包。假如成员2是空闲的，且本地没有任何事务处理呢？这种情况下，成员2需要发一个空操作指令(NOP)，告诉其他成员跳过ID1:2的数据包。这个指令是当成员2收到ID1:1的数据包同步成功的消息(Paxos的第三个TCP消息)后发出的，如图所示。<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/1E24039CABA940DCB555BFFB16C0FAAC/41995" alt="image"><br>以上介绍的只是Paxos协议很少的一部分，如果想详细了解Paxos协议，还是要查阅更多的资料。总结一下，Paxos在通信上的特别如下：  </li>
<li>数据包同步成功需要三次TCP传输。</li>
<li>每个数据包都要发送到所有的成员上，因此需要传输多份，传输的数据量会被放大。</li>
<li>假设数据包发送到其他所有成员的过程是并发进行的，那么数据包同步成功需要的时间是成员间最慢的那条链路上完成三次TCP通信的时间。<br>这些特点决定了group replication在延迟大、带宽窄的网络中的效率会是比较低的。group replication为了提高Paxos对网络的适用性、做了以下优化：  </li>
<li>使用了LZ4压缩算法对事务信息进行压缩，当数据包的大小超过一个阈值时会被自动压缩。</li>
<li>Paxos会将多个事务信息封装到一个数据包内进行通信，大大减少了Paxos通信的次数。<h3 id="全局事务认证模块"><a href="#全局事务认证模块" class="headerlink" title="全局事务认证模块"></a>全局事务认证模块</h3>全局事务认证模块有一个消息队列，用来存放所有收到的消息。这些消息主要是事务的Binlog Event，也有一部分状态和控制信息。状态表replication_group_member_stats中的字段COUNT_TRANSATION_IN_QUEUE指的就是这个队列中事务数据。<br>全局事务认证模块的核心任务是做冲突检测。冲突检测是指识别出那些同时修改了同样数据的事务，并做出相应的处理。冲突检测中需要的信息包括如下三点：  </li>
<li>主键信息。</li>
<li>事务执行时的数据快照版本。</li>
<li>执行事务的MySQL服务器的UUID。<h4 id="冲突检测需要的信息"><a href="#冲突检测需要的信息" class="headerlink" title="冲突检测需要的信息"></a>冲突检测需要的信息</h4>group replication的冲突检测中以数据行为单位，两个事务是不是修改了同样的数据，是通过事务所修改的主键值来判断的。上方中有介绍，Server层在产生Binlog Event时，会同时记录所修改的主键信息(库名、表名主键等信息产生的哈希值)。当发现两个事务修改了同样的数据后，如何来判断这两个事务是不是同时执行的呢？这里用到了数据库快照版本。数据库快照版本是数据库的一个瞬时状态，每个写操作都会导致数据库的状态变化，不同的状态用不同的快照版本来表示。快照版本是用GTID来表示的，每个写事务都会产生一个唯一的GTID，这个GTID由全局事务认证模块产生，且在事务提交时会被添加到全局变量gtid_executed中。因此，gtid_executed的内容就是MySQL的数据库快照版本。<br>如下图所示，为数据库快照版本变化的示例图。图中，事务T1开始执行时所基于的数据库快照版本为空，T1提交后的数据库版本变为”group_name:1”,group_name是group replication组的UUID。事务T2的执行则基于”group_name:1”的快照版本，这个数据库的快照版本，主键信息及其MySQL服务器的UUID一起被封装到Transaction_context_log_event上，和其他事务产生的Binlog Event一起发送到全局事务检测模块。<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/8375C243E6614C17B5B99222154D8891/42081" alt="image">  <h4 id="冲突检测数据库"><a href="#冲突检测数据库" class="headerlink" title="冲突检测数据库"></a>冲突检测数据库</h4>全局事务认证模块中还维护了一个冲突检测数据库，它是主键哈希+快照版本的列表。快照版本存储的是最后一个修改此主键信息的快照版本加上这个事务的GTID。收到事务信息后，全局事务认证模块会根据Transaction_context_log_event中的主键信息，从冲突检测数据库中检索出所有主键的快照版本和该事务的快照版本进行比对。当前事务的快照版本必须要包含检索出的所有主键快照版本中的GTID，否则就是有冲突。  <h4 id="理解冲突检测的过程"><a href="#理解冲突检测的过程" class="headerlink" title="理解冲突检测的过程"></a>理解冲突检测的过程</h4>下面通过一个例子来理解冲突检测的原理，如图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/E14FC995A3274640812B5B858DEEF447/42271" alt="image"><br>假设当前所有成员的数据库状态是一致的，它们的gtid_executed值都为”group_name:1-100”。这时，DB1上执行了事务T1,T1看到数据库快照版本就是”group_name:1-100”。<blockquote>
<p>UPDATE t1 SET c2 = 5 WHERE pk = 1;<br>同时，DB2执行了事务T2,T2看到数据库快照版本就是”group_name:1-100”。<br>UPDATE t1 SET c2 = 10 WHERE pk = 1;<br>经过通信模块排序后，T2排在了T1前面，如图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/94B9F228E3FD4295BDE411526066DF49/42098" alt="image"><br>因此，在所有成员全局冲突模块中都是先处理T2,再处理T1。在处理T2时，首先根据Transaction_context_log_event中的主键信息从冲突检测数据库中查找该主键上一次被修改后的快照版本。有可能查到，也不可能查不到。查不到就意味没有冲突。假设冲突检测数据库中的内容如下图所示(为了理解方便，图中主键哈希值用主键值代替)<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/2C2984AF9A8E4880A2B9A5EF5AF6926C/42113" alt="image"><br>从冲突检测数据库中查到此主键上一次被修改后的版本快照是”group_name:1-98”。和T2的快照版本比较得知，T2的快照版本中的GTID集合包含了冲突检测数据中查找到的快照版本的GTID集合。也就意味着，T2在B成员上执行时，上一次该主键的更新已经在B成员上执行了，所以T2和上一次该主键的更新之间是不冲突的。接着，全局事务认证模块会为T2分配一个GTID，并更新冲突检测数据库中此主键的快照版本。假设T2分配的GTID是”group_name:101”,更新后的冲突检测数据库如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/8621CA95B2884616BDA1DF5B1E6DFAB9/42129" alt="image"><br>T2处理完成后，开始下一个事务T1的冲突检测。首先，也是从冲突检测数据库中查找该主键的快照版本，查到的结果是”group_name:101”，和T1的快照版本对比发现，T1的快照版本不包含”group_name:101”，这就可以判定T1和之前一次的主键修改(T2的修改)是同时进行的，是冲突的。</p>
</blockquote>
<h4 id="冲突处理"><a href="#冲突处理" class="headerlink" title="冲突处理"></a>冲突处理</h4>冲突检测完成后，全局认证模块接下来的处理是有本地事务和异地事务区分的。Transaction_context_log_event中记录了产生这个事务的MySQL服务器的UUID。根据这个UUID，就能判断出这是一个本地事务还是异地事务，对于本地事务的处理如下：</li>
<li>如果没有冲突，唤醒这个事务的线程，并且告诉它完成提交操作。</li>
<li>如果有冲突，唤醒这个事务的线程，并且告诉它发生冲突，需要回滚。</li>
<li>不论是否有冲突，Binlog Event都会被丢弃。<br>对于异地事务的处理如下：</li>
<li>如果没有冲突，将这个事务的Binlog Event写入Relay log中，让group_relication_appliter通道去执行。</li>
<li>如果有冲突，则丢弃这个事务的Binlog Event。<h4 id="冲突检测数据库的清理"><a href="#冲突检测数据库的清理" class="headerlink" title="冲突检测数据库的清理"></a>冲突检测数据库的清理</h4>随着使用时间的越来越长，冲突检测数据库中维护的主键信息会越来越多，这些主键信息将占用巨大的内存。为了减小内存的使用并提高查询效率，全局事务认证模块需要定期的清理冲突检测数据库。如果一个事务已经在所有成员上执行了，其他事务的执行肯定不会和它有冲突，因此这个事务的所有主键信息就可以从冲突检测数据库中移除。主键信息的清理是依据各个成员上的全局变量gtid_executed的GTID集合来做的。全局认证模块启动了一个广播线程，每60s将自己的gtid_executed中的GTID集合广播到所有的成员上。全局事务认证模块收到所有成员的GTID后，取它们的交集。这个交集中包含的就是那些已经在所有成员上执行了的事务GTID集合，称作全局完成的GTID集合。全局事务认证模块会将冲突检测数据库所有主键的快照版本和全局完成的GTID集合进行比对，如果快照版本中的GTID集合是全局完成的GTID集合的子集，则这个主键信息就会从冲突检测数据库中清除掉。<br>replication_group_member_stats表中的TRANSACTION_COMMITED_ALL_MEMBERS显示的就是全局完成的GTID集合。  <h4 id="计算基于主键的逻辑时钟"><a href="#计算基于主键的逻辑时钟" class="headerlink" title="计算基于主键的逻辑时钟"></a>计算基于主键的逻辑时钟</h4>在执行Binlog Event时，group replication采用了基于主键的并发机制。在这种机制中通过主键来判断是否修改了相同的数据，各种情况如下：</li>
<li>修改了不同数据的事务会安排并发执行。</li>
<li>修改了相同数据的事务会安排顺序执行。</li>
<li>DDL不能和任何事务并发执行，必须等待它前面的所有事务执行完毕后才能开始执行，后面的事务也必须要等待DDL执行完毕后，才能开始执行。<br>基于主键的并发机制，刚好可以通过逻辑时钟的方式来表达。因此group replication重用了多线程复制中Logical_clock并发复制的功能。基于主键的并发实现起来很简单，只需要根据主键信息计算出事务的逻辑时间，并更新Gtid_log_event中听last_committed和sequence_number的内容即可。group_replication_applier在执行这些事务时，按照Logical_clock方式进行并发就可以了，不需要任何改动。由于需要用到主键信息，因此计算过程是在冲突检测的过程中完成的。全局事务认证模块维护了一个全局事务的顺序号，它会给每个认证成功的事务分配一个顺序号。这个顺序号就是事务的sequence_number，会存储到冲突检测数据库中。当前事务的last_committed的计算和存储在冲突检测数据库中的sequence_number有关。首先，从冲突检测数据库中找出该事务修改的所有主键的sequence_number，即上一次被修改时的sequence_number，取其中的最大值来作为当前事务的last_committed。<br>假设正在处理的事务如下：<blockquote>
<p>UPDATE t1 SET c2 = 5 WHERE pk=1 OR pk =2;<br>冲突检测数据库中的顺序如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/A20F24C576B4491586110097130E61B0/42216" alt="image"><br>那么该事务的last_committed是120(120和33的最大值)。如果查不到上次记录，则将last_committed设置为上一次DDL的sequence_number，这保证DDL后面的事务不会和DDL并发执行。如果当前事务是DDL，则last_committed会设置成它自己的sequence_number-1，从而保证DDL前面的所有事务都被执行完后它才会被执行。</p>
</blockquote>
<h3 id="异地事务执行模块"><a href="#异地事务执行模块" class="headerlink" title="异地事务执行模块"></a>异地事务执行模块</h3>为了执行异地事务的Binlog Event，group replication会自动创建一个名为group_replication_applier的通道。这个通道的Receiver线程是关闭的，不会从其他成员上去复制Binlog Event。所有的Binlog Event都是由全局事务认证模块通过API写入Relay log的。Binlog Event的执行过程和异步复制没有区别，但是在执行过程中group_replication_applier所执行的事务使用了特权行锁。在对数据加行锁的时候，如果group_replication_applier发现有本地事务已经对数据加了行锁，那么group_replication_applier不会等待本地事务执行完毕，而是立刻将本地事务回滚掉，然后继续执行；而本地事务的Session则会返回错误。这其实很好理解，本地事务和group_replication_applier更新了同样的数据，而且是同时执行的，因此才会返回错误。即便本地事务到了全局事务认证模块，也会因此检测出冲突而被回滚掉。相比而言，由前者回滚本地事务效率更高。<h3 id="事务流程的总结"><a href="#事务流程的总结" class="headerlink" title="事务流程的总结"></a>事务流程的总结</h3>事务在group replication中的执行过程可以总结为三个部分：</li>
<li>网络传输。</li>
<li>事务在本地的执行过程。</li>
<li>事务在异地的执行过程。<h4 id="网络传输"><a href="#网络传输" class="headerlink" title="网络传输"></a>网络传输</h4>group replication通过Paxos协议来传播事务信息。Paxos保证所有的事务信息按照同样的顺序传播到所有的成员上，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/F41CB459A2C742A184F38407634D4BFF/42257" alt="image">  <h4 id="事务在本地成员上的执行过程"><a href="#事务在本地成员上的执行过程" class="headerlink" title="事务在本地成员上的执行过程"></a>事务在本地成员上的执行过程</h4>事务在本地提交时(prepare之后，写Binlog之前)，将事务信息发送至通信模块，然后开始等待事务认证结果。通信模块将事务排序后发送到本地成员的全局认证模块。全局认证模块做完冲突检测后，唤醒该事务继续执行(如果认证成功)或回滚(如果认证失败)，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/262EA905BF1049A6BF0747EBED444562/42274" alt="image">  <h4 id="事务在异地的执行过程"><a href="#事务在异地的执行过程" class="headerlink" title="事务在异地的执行过程"></a>事务在异地的执行过程</h4>通讯模块将事务排序后发到全局事务认证模块。全局认证模块认证成功后，将该事务的Binlog Event写入Relay log，由group_replication_applier通道来执行。如果全局事务认证失败，则会丢弃该事务的Binlog Event，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/AF94CE1CF3F646FF87BD1B4049B240AF/42287" alt="image">  <h2 id="深入理解成员加入组的过程"><a href="#深入理解成员加入组的过程" class="headerlink" title="深入理解成员加入组的过程"></a>深入理解成员加入组的过程</h2>group replication的主要逻辑可以划分为两部分：事务的执行逻辑和成员管理逻辑。上面已经介绍了事务的执行逻辑，下面来介绍成员的管理逻辑。<h3 id="组视图"><a href="#组视图" class="headerlink" title="组视图"></a>组视图</h3>成员管理中有一个很重要的概念叫作组视图(Group View)，或者简称为视图(View)。视图是指group replication组在一段时间内的成员状态。在这个时间段内没有成员变化，即没有成员加入也没有成员退出。如果成员发生了变化，成员状态就变化了，于是它就进入了另外一个视图。不同的视图之间通过视图ID(View ID)来进行区分。视图随时间的变化有先后顺序，因此View ID也是有先后顺序的。View ID被定义为两个部分，分别如下：  </li>
<li>前缀部分(固定部分)：前缀部分是一个随机数。这个值在组初始化时产生。之后，所有View的前缀部分都使用这个随机数，因此也被称为固定部分。</li>
<li>顺序号部分：顺序号部分是数值。初始化时，第一个视图的顺序号从1开始，以后每次视图变化顺序号递增。<br>用户可以通过replication_group_member_stats表查看当前的View ID。View ID显示格式如下：<blockquote>
<p>14870305055874300:2</p>
</blockquote>
<h3 id="加入组时视图的切换"><a href="#加入组时视图的切换" class="headerlink" title="加入组时视图的切换"></a>加入组时视图的切换</h3>当一个MySQL服务器加入组中，group replication插件首先会根据group_replication_group_seeds的内容和一个成员(种子成员)建立TCP连接。而种子成员会根据自己的IP白名单检查是否允许其接入。连接建立后，新成员会发送一个加入请求给种子成员，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/5AAD32035BD94793924F14F024565AB5/42326" alt="image"><br>收到请求后，种子成员广播视图变化的消息给所有成员(包括申请加入的成员)，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/E364021100CB465FAA23F3ECB4E47A54/42338" alt="image"><br>各个成员收到消息后开始做视图切换。首先，每个成员都会广播一个状态交换消息出去，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/85B1C1CF87564981A5FD4D1213101D55/42341" alt="image"><br>接着，各个成员开始接收状态交换消息。状态交换消息中包含了成员的当前状态和信息。成员收到状态交换信息后，将消息中的成员信息更新到自己的成员列表中。当收到所有成员中的最后一个状态交换消息时，通信模块将完整的新视图以视图数据包的形式返回给全局事务认证模块进行处理。整个视图的切换过程到此结束，视图切换的整个过程不影响在线成员对外提供服务。<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/C8D5BFBFA1DA44B5AE0CB5752220F0F2/42352" alt="image"><br>离开组时的视图切换和加入组的视图切换过程基本一样，略。<h3 id="View-change-log-event"><a href="#View-change-log-event" class="headerlink" title="View_change_log_event"></a>View_change_log_event</h3>状态交换消息和事务数据包一样都是通过Paxos协议发送的，因此它们之间也是有序的。事务数据包以视图数据包为分界线，划分到不同的视图中。它前面的事务数据包属于前一个视图的事务，而后面的数据包都是属于当前视图中的事务。全局事务认证模块会对每一个视图数据包创建一个View_change_log_event，这个Event会被写入Relay log，然后被执行，最终会出现在Binlog中，因此Binlog里的Event也被View_change_log_event划分到不同的视图中。View_change_log_event里面记录了当前的View ID，还有冲突检测数据库的信息。当记录View_change_log_event到Binlog中时，它会被封装到一个事务中，并且有自己的GTID，包括几个Events。  <blockquote>
<p>Gtid_log_event;<br>Query_log_event(“BEGIN”)<br>View_change_log_event;<br>Query_log_event(“COMMIT”)</p>
</blockquote>
<h3 id="恢复"><a href="#恢复" class="headerlink" title="恢复"></a>恢复</h3>视图切换完成后，成员就正式加入组内。它可以收到当前视图任何事务的数据包，但是视图切换前的数据包是收不到的。所以，在MySQL服务器加入组后，不能立即对外提供服务，而需要执行一些操作将自己缺失的数据从其他成员上复制过来。这个过程叫作恢复(Recovery)。一个成员加入组后，会立即将自己的状态设置为RECOVERING，开始执行恢复的过程。恢复过程分为本地恢复、全局恢复和缓存事务执行三个步骤。<h3 id="本地恢复-Local-Recovery"><a href="#本地恢复-Local-Recovery" class="headerlink" title="本地恢复(Local Recovery)"></a>本地恢复(Local Recovery)</h3>如果这个成员曾经加入过这个组，它的group_replication_applier通道的Relay log中可能还有一些Event没有被执行到数据库中。因此，group replication插件首先会启动group_replication_applier通道，将本地的Binlog Event执行完毕。<h3 id="全局恢复-Global-Recovery"><a href="#全局恢复-Global-Recovery" class="headerlink" title="全局恢复(Global Recovery)"></a>全局恢复(Global Recovery)</h3>本地恢复执行完毕后，开始进行全局恢复。全局恢复是通过group_replication_recovery进行的。group replication插件会随机选择一个在线成员作为这个通道的Master，这个被选择的成员叫作Donor。group replication插件会自动配置group_replication_recovery通道，并且启动这个通道进行复制，复制时使用的是GTID复制。全局恢复有容错能力，如果group_replication_recovery通道的接收线程(Receiver)无法连接到当前的Donor或当前Donor上的Binlog已经删除，则会选择其他成员作为Donor进行复制。在启动group_replication_recovery通道时，group replication插件会告诉它：当碰到View ID等于当前View ID的View_change_log_event时停止。当执行完到这个View_change_log_event后，group_replication_recovery通道会将空上Event中的冲突检测数据库初始化到group replication插件中，然后停止运行，如下图所示：<br><img src="https://note.youdao.com/yws/public/resource/10358468375e69edf5395125053e89c9/xmlnote/DE962A8B547D446DA2D71CD5BB47D0DE/42409" alt="image">  <h3 id="缓存事务执行"><a href="#缓存事务执行" class="headerlink" title="缓存事务执行"></a>缓存事务执行</h3>在执行全局恢复过程的同时，全局事务认证模块还会收到当前视图中产生的事务数据包。这些数据包会被缓存起来直到全局恢复完毕后，全局事务认证模块才开始处理这些事务。当缓存的事务全部执行完毕后，该成员才能设置为ONLINE状态。当然用户也可以让成员在缓存的事务执行之前上线。group replication提供了参数group_replication_recovery_complete_at来控制上线时间。上线不仅仅是状态的改变，在多主模式时，上线意味着只读模式会被关闭，上线后成员就能够接收用户的写操作了。<h3 id="手动恢复"><a href="#手动恢复" class="headerlink" title="手动恢复"></a>手动恢复</h3>虽然group replication的恢复过程是很自动化的，但是并不完美，在有些情况下还是需要手动进行恢复的。  </li>
<li>当group replication运行了很长时间后，以前的Binlog可能已经删除了，这时就无法自动通过全局恢复来复制数据。</li>
<li>当要复制的Binlog很大时，使用异步复制的全局恢复效率比较低，不能短时间内完成。<br>当要加入组内的MySQL服务器符合以上情况时，可以先手动将数据库恢复到一个比较接近的时间点，然后再加入group replication组。<h2 id="运维相关问题"><a href="#运维相关问题" class="headerlink" title="运维相关问题"></a>运维相关问题</h2><h3 id="故障切换"><a href="#故障切换" class="headerlink" title="故障切换"></a>故障切换</h3>目前MySQL官方没有发布连接组复制专用的客户端（如MongoDB连接复制集的客户端），在实际的应用中如果发生故障，需要客户端自己来处理。对于单主模式的话，如果主节点发生故障，客户端需要判断新的主节点是谁，然后把写切换到新的主节点，基本上和当前的异步同步的主从切换一样，并且新的主节点是集群自动产生，不可控；多主模式需要在客户端进行节点可用性检查，当其中的一个写节点不可用时自动使用其他可用节点。<h3 id="大事务支持问题"><a href="#大事务支持问题" class="headerlink" title="大事务支持问题"></a>大事务支持问题</h3>目前版本测试并发进行大数据操作和DDL操作时，kill掉大事务，有几率造成集群不可用；在insert into …….select……limit……这种大事务支持不好，可能造成集群不用；多主模式进行DDL操作需要集群内所有节点都为ONLINE状态才可执行，处于ERROR和RECOVERING状态时有几率导致集群堵塞，严重时集群不可用。<h3 id="备份问题"><a href="#备份问题" class="headerlink" title="备份问题"></a>备份问题</h3>在组复制集群其中的一个节点上执行数据库备份时，不管使用mysqldump（这个不能使用–single-transaction参数，生产中不建议使用mysqldump备份集群数据）或是使用xtrabackup的QPS下降40%，并且备份节点基本停止读写。在测试备份文件导入数据时，多主模式要比单主模式慢。推荐使用组复制+异步复制方式，在异步复制的从节点上进行数据库备份。<h3 id="二进制日志删除问题"><a href="#二进制日志删除问题" class="headerlink" title="二进制日志删除问题"></a>二进制日志删除问题</h3>因为组复制同步还是基于二进制日志来进行同步的，清理某个节点bin-log时，必须判定这个日志文件是否还在使用，如果在使用，则绝对不能删除，如果删除，则整个集群直接ERROR。<h3 id="同步延迟问题"><a href="#同步延迟问题" class="headerlink" title="同步延迟问题"></a>同步延迟问题</h3>目前MySQL5.7.20的版本中无法直观查看节点同步延迟，也无法获取延迟多少，不管是时间或事物数，这个打开MySQL的Debug模式，可以获取到节点的延迟事务情况。<br>组复制的延迟对集群是有影响的，一旦出现延迟（默认延迟25000个事务），则启动流量控制（Flow Control），每个周期性能衰减当前的10%,直到集群不可用（但集群节点状态为online），单个节点慢整个集群全慢。<br>集群中的每个节点都会验证并应用该组提交的事务，有关校验和应用程序过程的统计信息对于了解应用程序队列如何增长，已找到多少冲突，检查了多少事务，在哪里提交了哪些事务等等非常有用。表 performance_schema.replication_group_member_stats 提供与事务认证过程的相关信息，但没有延迟信息。相关字段解释请参考文件<h3 id="数据一致性问题"><a href="#数据一致性问题" class="headerlink" title="数据一致性问题"></a>数据一致性问题</h3>不管是多写还是单写，都并非是强一致性，均允许有延迟，他在校验完事务是否冲突后把当前广播到各个节点并确定各个节点收到事务后即进入下一个事物的冲突检测，此时每个节点只是拿到了所有事务的执行序列，保证了事务最终顺序执行，从而保证数据的最终一致性，但同一时刻并非强一致性的。  <h3 id="节点故障脑裂问题"><a href="#节点故障脑裂问题" class="headerlink" title="节点故障脑裂问题"></a>节点故障脑裂问题</h3>节点越多性能损耗越大，三个节点比较合适。节点故障可能有脑裂等问题：如5个节点分布在两个机房，机房间网络断掉分为两个部分，2个集群的机房不可用，3个节点的可用，而三个节点的机房网络有问题，此时如果想使两个节点的机房可用，需要重新对两个节点做集群重组，三个节点的就无法恢复到两个节点中去；三节点中其中一个节点宕机，其他两个正常节点可用，故障节点重启没有加入到集群时，此时这个节点以单实例存在可读写，此时会发生脑裂。<br>###　弹性扩展问题<br>MySQL官方网站提到了组复制的弹性自动扩展，经过实际测试，这种扩展在生产中是不现实的。可用于生产的弹性扩展要求新加入一个集群，集群中的数据完全由集群来完成自动同步，但由于组复制是基于二进制日志来进行同步的，生产中是不可能完整保留全部的二进制日志，在新加入的节点需要先备份出集群的全量数据，然后根据同步位置去追事务达到数据的一致后节点状态online状态，其实和之前异步同步搭建主从一样。并且官方提示如果恢复时的延迟过大，可能也无法正常达到追到最新数据的位置。<h3 id="客户端连接问题"><a href="#客户端连接问题" class="headerlink" title="客户端连接问题"></a>客户端连接问题</h3>官方说明中关于故障处理的时候有一句话：组复制不处理客户端故障切换，它必须由应用程序本身，连接器或中间件框架（如代理或路由器）处理。<h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2>参考<a href="https://dev.mysql.com/doc/refman/5.7/en/group-replication-frequently-asked-questions.html" target="_blank" rel="noopener">官方</a>文档<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2>目前MGR还不太成熟,但为MySQL的发展指明了方向,相信在未来的MySQL版本中,MGR能够越来越完善.</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/Aliyun-ECS搭建MHA-Keepalived-VIP-MySQL5-7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/Aliyun-ECS搭建MHA-Keepalived-VIP-MySQL5-7.html" itemprop="url">Aliyun ECS搭建MHA+Keepalived+VIP+MySQL5.7</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-10-11T13:53:19+08:00">
                2017-10-11
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/集群高可用/" itemprop="url" rel="index">
                    <span itemprop="name">集群高可用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在Aliyun ECS结合MHA做MySQL的高可用，ECS不支持VIP，但阿里的产品高可用虚拟IP（HaVip）结合keepliaved等第三方软件可间接实现ip的漂移，可满足我们的需求。</p>
<h2 id="MHA简介"><a href="#MHA简介" class="headerlink" title="MHA简介"></a>MHA简介</h2><p>MHA是由日本MySQL专家youshimaton(现就职于Facebook公司)用Perl写的一套MySQL故障切换方案，以保障数据库的高可用性。在MySQL故障切换过程中，MHA能做到在0~30s之内实现主MySQL故障转移。<br>该软件由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）。MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p>
<h2 id="高可用虚拟IP限制"><a href="#高可用虚拟IP限制" class="headerlink" title="高可用虚拟IP限制"></a>高可用虚拟IP限制</h2><ul>
<li>每个VPC中最多只能同时存在5个vip对象</li>
<li>目前VPC中的网络通信不支持多播和广播，只支持单播；所以，如果用户是使用keepalived之类的第三方软件实现高可用，需要通过配置文件把通信方式改成单播；网上可以找到相应的方法 </li>
<li>如果是使用keepalived之类的第三方软件，需要把信条消息的源IP改成ECS的私网IP（而不要用HaVip的私网IP进行心跳检查），不然很容易造成脑裂</li>
<li>当HaVip与EIP绑定后，进行公网通信时，持有HaVip的ECS实例应该通过HaVip的私网ip进行公网通信（而不是ECS自己的私网IP）；因为这时EIP是映射在HaVip的私网IP上，而不是映射在ECS的私网IP上</li>
<li>类似的，当使用HaVip做自建SNAT网关的高可用时，SNAT实例上配置的SNAT规则中，source IP应该是havip的私网IP而不是自己的private IP</li>
</ul>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：Linux Centos 6.5<br>master：192.168.16.80<br>slave: 192.168.16.81<br>vip: 192.168.16.82  （<font color="#FF0000">注：需要和HaVip的私网IP一致</font>）<br>其中，使用两台机器，分别部署主库和从库，MHA默认部署在从库上，下方中的VIP通EIP，最终是要把EIP和HaVip绑定在一起  </p>
<h2 id="系统初始化修改"><a href="#系统初始化修改" class="headerlink" title="系统初始化修改"></a>系统初始化修改</h2><h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><h4 id="主库修改主机名"><a href="#主库修改主机名" class="headerlink" title="主库修改主机名"></a>主库修改主机名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/sysconfig/network|grep HOSTNAME</span><br><span class="line">HOSTNAME=master</span><br><span class="line">[root@master ~]# cat /etc/hosts|grep master</span><br><span class="line">192.168.16.80 master</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<h4 id="从库修改主机名"><a href="#从库修改主机名" class="headerlink" title="从库修改主机名"></a>从库修改主机名</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/sysconfig/network|grep HOSTNAME</span><br><span class="line">HOSTNAME=slave</span><br><span class="line">[root@slave ~]# cat /etc/hosts|grep slave</span><br><span class="line">192.168.16.81 slave</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<h3 id="设置防火墙"><a href="#设置防火墙" class="headerlink" title="设置防火墙"></a>设置防火墙</h3><h4 id="主库设置，允许从库访问"><a href="#主库设置，允许从库访问" class="headerlink" title="主库设置，允许从库访问"></a>主库设置，允许从库访问</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/iptables status|grep 192.168.16.81</span><br><span class="line">11   ACCEPT     all  --  192.168.16.81        0.0.0.0/0           </span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<p>其中，192.168.16.81是允许从库的访问规则</p>
<h4 id="从库设置，允许主库访问"><a href="#从库设置，允许主库访问" class="headerlink" title="从库设置，允许主库访问"></a>从库设置，允许主库访问</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# /etc/init.d/iptables status|grep 192.168.16.80</span><br><span class="line">11   ACCEPT     all  --  192.168.16.80        0.0.0.0/0           </span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<p>其中，192.168.16.80是允许主库的访问规则</p>
<h3 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h3><h4 id="主库查看"><a href="#主库查看" class="headerlink" title="主库查看"></a>主库查看</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/sysconfig/selinux |grep -v &apos;#&apos; |grep &apos;SELINUX=&apos; </span><br><span class="line">SELINUX=disabled</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<h4 id="从库查看"><a href="#从库查看" class="headerlink" title="从库查看"></a>从库查看</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/sysconfig/selinux |grep -v &apos;#&apos; |grep &apos;SELINUX=&apos; </span><br><span class="line">SELINUX=disabled</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<h2 id="建立SSH无密码登录"><a href="#建立SSH无密码登录" class="headerlink" title="建立SSH无密码登录"></a>建立SSH无密码登录</h2><h3 id="主库设置"><a href="#主库设置" class="headerlink" title="主库设置"></a>主库设置</h3><p>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,同时AllowUsers把root也添加上,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# sed &apos;/^#/d;/^$/d&apos; /etc/ssh/ssh_config |grep GSSAPIAuthentication</span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root@master ~]# sed &apos;/^#/d;/^$/d&apos; /etc/ssh/sshd_config |grep -E &apos;PasswordAuthentication|PermitRootLogin&apos;</span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root@master ~]# /etc/init.d/sshd restart</span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line">[root@master ~]# cat /etc/hosts.allow |grep 192.168.16.81</span><br><span class="line">sshd: 192.168.16.81</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ssh-keygen </span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Created directory &apos;/root/.ssh&apos;.</span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">07:86:76:d6:4a:0f:ea:6e:88:00:eb:3d:5f:7e:08:7a root@master</span><br><span class="line">The key&apos;s randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|                 |</span><br><span class="line">|       . .       |</span><br><span class="line">|      o B .      |</span><br><span class="line">|.    . * =       |</span><br><span class="line">|..    . S o      |</span><br><span class="line">|o    o   .       |</span><br><span class="line">|......o..        |</span><br><span class="line">| ..+.E+. .       |</span><br><span class="line">|    +o...        |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@master ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.81</span><br><span class="line">The authenticity of host &apos;192.168.16.81 (192.168.16.81)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is 9f:1f:41:f6:2d:e9:20:83:30:be:cd:20:01:31:ea:6d.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &apos;192.168.16.81&apos; (RSA) to the list of known hosts.</span><br><span class="line">root@192.168.16.81&apos;s password: </span><br><span class="line">Now try logging into the machine, with &quot;ssh &apos;root@192.168.16.81&apos;&quot;, and check in:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">to make sure we haven&apos;t added extra keys that you weren&apos;t expecting.</span><br><span class="line"></span><br><span class="line">[root@master ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.80</span><br><span class="line">The authenticity of host &apos;192.168.16.80 (192.168.16.80)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is f2:f8:7d:7d:59:3f:b9:3c:a0:e6:66:54:1f:79:e2:40.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root@192.168.16.80&apos;s password: </span><br><span class="line">Now try logging into the machine, with &quot;ssh &apos;root@192.168.16.80&apos;&quot;, and check in:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">to make sure we haven&apos;t added extra keys that you weren&apos;t expecting.</span><br><span class="line"></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<p>测试登录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ssh root@192.168.16.81</span><br><span class="line">Last login: Wed Oct 11 14:45:10 2017 from 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome to aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@slave ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection to 192.168.16.81 closed.</span><br><span class="line">[root@master ~]# ssh root@192.168.16.80</span><br><span class="line">Last login: Wed Jan 18 16:25:59 2017</span><br><span class="line"></span><br><span class="line">Welcome to aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@master ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection to 192.168.16.80 closed.</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="从库设置"><a href="#从库设置" class="headerlink" title="从库设置"></a>从库设置</h3><p>和主库保持一致<br>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,同时AllowUsers把root也添加上,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# sed &apos;/^#/d;/^$/d&apos; /etc/ssh/ssh_config |grep GSSAPIAuthentication</span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root@slave ~]# sed &apos;/^#/d;/^$/d&apos; /etc/ssh/sshd_config |grep -E &apos;PasswordAuthentication|PermitRootLogin&apos;</span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root@slave ~]# /etc/init.d/sshd restart</span><br><span class="line">Stopping sshd:                                             [  OK  ]</span><br><span class="line">Starting sshd:                                             [  OK  ]</span><br><span class="line">[root@slave ~]# cat /etc/hosts.allow |grep 192.168.16.80</span><br><span class="line">sshd: 192.168.16.80</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ssh-keygen </span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">ae:04:32:4d:3e:d3:b7:5d:4e:d2:50:7a:4c:44:d7:0a root@slave</span><br><span class="line">The key&apos;s randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|           o= .. |</span><br><span class="line">|           =E.  .|</span><br><span class="line">|    .     o o. . |</span><br><span class="line">|   + .     +  .  |</span><br><span class="line">|  o * . S . +    |</span><br><span class="line">|   o + o o =     |</span><br><span class="line">|      . o . .    |</span><br><span class="line">|     . .         |</span><br><span class="line">|      .          |</span><br><span class="line">+-----------------+</span><br><span class="line">[root@slave ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.80</span><br><span class="line">The authenticity of host &apos;192.168.16.80 (192.168.16.80)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is f2:f8:7d:7d:59:3f:b9:3c:a0:e6:66:54:1f:79:e2:40.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &apos;192.168.16.80&apos; (RSA) to the list of known hosts.</span><br><span class="line">root@192.168.16.80&apos;s password: </span><br><span class="line">Now try logging into the machine, with &quot;ssh &apos;root@192.168.16.80&apos;&quot;, and check in:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">to make sure we haven&apos;t added extra keys that you weren&apos;t expecting.</span><br><span class="line"></span><br><span class="line">[root@slave ~]# ssh-copy-id -i ~/.ssh/id_rsa.pub root@192.168.16.81</span><br><span class="line">The authenticity of host &apos;192.168.16.81 (192.168.16.81)&apos; can&apos;t be established.</span><br><span class="line">RSA key fingerprint is 9f:1f:41:f6:2d:e9:20:83:30:be:cd:20:01:31:ea:6d.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &apos;192.168.16.81&apos; (RSA) to the list of known hosts.</span><br><span class="line">root@192.168.16.81&apos;s password: </span><br><span class="line">Now try logging into the machine, with &quot;ssh &apos;root@192.168.16.81&apos;&quot;, and check in:</span><br><span class="line"></span><br><span class="line">  .ssh/authorized_keys</span><br><span class="line"></span><br><span class="line">to make sure we haven&apos;t added extra keys that you weren&apos;t expecting.</span><br><span class="line"></span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<p>测试登录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ssh root@192.168.16.80</span><br><span class="line">Last login: Wed Oct 11 14:48:14 2017 from 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome to aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@master ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection to 192.168.16.80 closed.</span><br><span class="line">[root@slave ~]# ssh root@192.168.16.81</span><br><span class="line">Last login: Wed Oct 11 14:48:10 2017 from 192.168.16.80</span><br><span class="line"></span><br><span class="line">Welcome to aliyun Elastic Compute Service!</span><br><span class="line"></span><br><span class="line">[root@slave ~]# exit</span><br><span class="line">logout</span><br><span class="line">Connection to 192.168.16.81 closed.</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL安装"><a href="#MySQL安装" class="headerlink" title="MySQL安装"></a>MySQL安装</h2><p>使用的是自己打包的RPM包，分别登录主库和从库，直接rpm -ivh percona-server-5.7.18-15.x86_64.rpm 即可，也可使用其他方式安装MySQL<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mv /home/duanwenjie/percona-server-5.7.18-15.x86_64.rpm /usr/src/</span><br><span class="line">[root@master ~]# rpm -ivh /usr/src/percona-server-5.7.18-15.x86_64.rpm </span><br><span class="line">Preparing...                ########################################### [100%]</span><br><span class="line">Group &apos;mail&apos; not found. Creating the user mailbox file with 0600 mode.</span><br><span class="line">   1:percona-server         ########################################### [100%]</span><br><span class="line">error reading information on service /etc/rc.d/init.d/mysqld: No such file or directory</span><br><span class="line">MySQL (Percona Server) PID file could not be found![FAILED]</span><br><span class="line">Starting MySQL (Percona Server)...[  OK  ]</span><br><span class="line">mysqladmin: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Warning: Since password will be sent to server in plain text, use ssl connection to ensure password safety.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<p>查看是否安装成功,分别登录主库和从库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 12</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:03:27 &gt; select version();</span><br><span class="line">+---------------+</span><br><span class="line">| version()     |</span><br><span class="line">+---------------+</span><br><span class="line">| 5.7.18-15-log |</span><br><span class="line">+---------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:03:31 &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL互为主备"><a href="#MySQL互为主备" class="headerlink" title="MySQL互为主备"></a>MySQL互为主备</h2><h3 id="重要参数配置"><a href="#重要参数配置" class="headerlink" title="重要参数配置"></a>重要参数配置</h3><p>主库必须包含以下参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 1</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 1</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br></pre></td></tr></table></figure></p>
<p>从库必须包含以下参数，注意slave需要动态设置read_only=1<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/my.cnf </span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 2</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 2</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br><span class="line">relay_log_purge=0</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e &quot;show variables like &apos;read_only&apos;&quot;</span><br><span class="line">Enter password: </span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| read_only     | OFF   |</span><br><span class="line">+---------------+-------+</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e &quot;set global read_only=1&quot;</span><br><span class="line">Enter password: </span><br><span class="line">[root@slave ~]# mysql -uroot -p -e &quot;show variables like &apos;read_only&apos;&quot;</span><br><span class="line">Enter password: </span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| read_only     | ON    |</span><br><span class="line">+---------------+-------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="复制帐号建立"><a href="#复制帐号建立" class="headerlink" title="复制帐号建立"></a>复制帐号建立</h3><p>由于MySQL版本使用的是5.7，创建用户的方法以之前有些不同</p>
<h4 id="主库创建"><a href="#主库创建" class="headerlink" title="主库创建"></a>主库创建</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 4</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:09:37 &gt; create user &apos;slave01&apos;@&apos;192.168.16.81&apos; identified by &apos;slave123456&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:10:13 &gt; grant replication slave,replication client on *.* to &apos;slave01&apos;@&apos;192.168.16.81&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.03 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:10:39 &gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:10:42 &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<h4 id="从库创建"><a href="#从库创建" class="headerlink" title="从库创建"></a>从库创建</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:11:18 &gt; create user &apos;slave01&apos;@&apos;192.168.16.80&apos; identified by &apos;slave123456&apos;; </span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:11:30 &gt; grant replication slave,replication client on *.* to &apos;slave01&apos;@&apos;192.168.16.80&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:11:40 &gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:11:43 &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<h3 id="复制帐号验证"><a href="#复制帐号验证" class="headerlink" title="复制帐号验证"></a>复制帐号验证</h3><p>主库登录从库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uslave01 -pslave123456 -h192.168.16.81 -e &quot;select version()&quot; </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+---------------+</span><br><span class="line">| version()     |</span><br><span class="line">+---------------+</span><br><span class="line">| 5.7.18-15-log |</span><br><span class="line">+---------------+</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<p>从库登录主库<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uslave01 -pslave123456 -h192.168.16.80 -e &quot;select version()&quot; </span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">+---------------+</span><br><span class="line">| version()     |</span><br><span class="line">+---------------+</span><br><span class="line">| 5.7.18-15-log |</span><br><span class="line">+---------------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="复制关系配置"><a href="#复制关系配置" class="headerlink" title="复制关系配置"></a>复制关系配置</h3><h4 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h4><p>登录主库，设置复制关系，来源于从库的复制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 6</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:14:07 &gt; change master to master_host=&apos;192.168.16.81&apos;,master_user=&apos;slave01&apos;,master_password=&apos;slave123456&apos;,master_auto_position=1;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.03 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:14:46 &gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:14:49 &gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.16.81</span><br><span class="line">                  Master_User: slave01</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 812</span><br><span class="line">               Relay_Log_File: master-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 1025</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 812</span><br><span class="line">              Relay_Log_Space: 1233</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 2</span><br><span class="line">                  Master_UUID: e1ec82e8-ae51-11e7-8532-00163e128057</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: e1ec82e8-ae51-11e7-8532-00163e128057:1-3</span><br><span class="line">            Executed_Gtid_Set: df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3,</span><br><span class="line">e1ec82e8-ae51-11e7-8532-00163e128057:1-3</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:14:56 &gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h4><p>登录从库，设置复制关系，来源于主库的复制<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 11</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:15:42 &gt; change master to master_host=&apos;192.168.16.80&apos;,master_user=&apos;slave01&apos;,master_password=&apos;slave123456&apos;,master_auto_position=1;</span><br><span class="line">Query OK, 0 rows affected, 2 warnings (0.05 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:15:53 &gt; start slave;</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:15:55 &gt; show slave status\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting for master to send event</span><br><span class="line">                  Master_Host: 192.168.16.80</span><br><span class="line">                  Master_User: slave01</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 1470</span><br><span class="line">               Relay_Log_File: slave-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 1072</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB: </span><br><span class="line">          Replicate_Ignore_DB: </span><br><span class="line">           Replicate_Do_Table: </span><br><span class="line">       Replicate_Ignore_Table: </span><br><span class="line">      Replicate_Wild_Do_Table: </span><br><span class="line">  Replicate_Wild_Ignore_Table: </span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error: </span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 1470</span><br><span class="line">              Relay_Log_Space: 1279</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File: </span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File: </span><br><span class="line">           Master_SSL_CA_Path: </span><br><span class="line">              Master_SSL_Cert: </span><br><span class="line">            Master_SSL_Cipher: </span><br><span class="line">               Master_SSL_Key: </span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error: </span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error: </span><br><span class="line">  Replicate_Ignore_Server_Ids: </span><br><span class="line">             Master_Server_Id: 1</span><br><span class="line">                  Master_UUID: df5051fc-ae51-11e7-85ee-00163e0f0e4a</span><br><span class="line">             Master_Info_File: mysql.slave_master_info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind: </span><br><span class="line">      Last_IO_Error_Timestamp: </span><br><span class="line">     Last_SQL_Error_Timestamp: </span><br><span class="line">               Master_SSL_Crl: </span><br><span class="line">           Master_SSL_Crlpath: </span><br><span class="line">           Retrieved_Gtid_Set: df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3</span><br><span class="line">            Executed_Gtid_Set: df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-3,</span><br><span class="line">e1ec82e8-ae51-11e7-8532-00163e128057:1-3</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">         Replicate_Rewrite_DB: </span><br><span class="line">                 Channel_Name: </span><br><span class="line">           Master_TLS_Version: </span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:16:00 &gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="复制测试"><a href="#复制测试" class="headerlink" title="复制测试"></a>复制测试</h3><h4 id="主库登录测试"><a href="#主库登录测试" class="headerlink" title="主库登录测试"></a>主库登录测试</h4><p>登录主库，插入测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MySQL [test11] 15:17:10 &gt; create table if not exists t11(id int unsigned not null auto_increment,name varchar(20),primary key(`id`));</span><br><span class="line">Query OK, 0 rows affected (0.04 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:17:20 &gt; insert into t11 values(null,&apos;master11&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:17:28 &gt; select * from t11;</span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | master11 |</span><br><span class="line">+----+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>登录从库，查看测试数据，此时数据已经复制过来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p test11 -e &quot;select * from t11&quot;</span><br><span class="line">Enter password: </span><br><span class="line">+----+----------+</span><br><span class="line">| id | name     |</span><br><span class="line">+----+----------+</span><br><span class="line">|  1 | master11 |</span><br><span class="line">+----+----------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h4 id="从库登录测试"><a href="#从库登录测试" class="headerlink" title="从库登录测试"></a>从库登录测试</h4><p>登录从库，插入测试数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MySQL [(none)] 15:18:56 &gt; create database if not exists test11;use test11;</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] 15:19:20 &gt; create table if not exists t22(id int unsigned not null auto_increment,name varchar(20),primary key(`id`));</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:38 &gt; insert into t22 values(null,&apos;slave11&apos;); </span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:43 &gt; select * from t22;</span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  2 | slave11 |</span><br><span class="line">+----+---------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 15:19:51 &gt;</span><br></pre></td></tr></table></figure></p>
<p>登录主库，查看测试数据，此时数据已经复制过来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p test11 -e &quot;select * from t22&quot;</span><br><span class="line">Enter password: </span><br><span class="line">+----+---------+</span><br><span class="line">| id | name    |</span><br><span class="line">+----+---------+</span><br><span class="line">|  2 | slave11 |</span><br><span class="line">+----+---------+</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="MHA帐号创建"><a href="#MHA帐号创建" class="headerlink" title="MHA帐号创建"></a>MHA帐号创建</h3><h4 id="主库创建-1"><a href="#主库创建-1" class="headerlink" title="主库创建"></a>主库创建</h4><p>登录主库，创建允许主库和从库连接的MHA用户信息，再分别尝试使用MHA用户登录(省略)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 29</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:23:16 &gt; create user &apos;mha01&apos;@&apos;192.168.16.81&apos; identified by &apos;mha123456&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:24:02 &gt; grant all privileges on *.* to &apos;mha01&apos;@&apos;192.168.16.81&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:24:27 &gt; create user &apos;mha01&apos;@&apos;192.168.16.80&apos; identified by &apos;mha123456&apos;; </span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:24:35 &gt; grant all privileges on *.* to &apos;mha01&apos;@&apos;192.168.16.80&apos;;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 15:24:41 &gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="从库创建-1"><a href="#从库创建-1" class="headerlink" title="从库创建"></a>从库创建</h4><p>登录从库，由于复制已经把在主库创建的MHA用户信息复制了过来，尝试登录即可(省略)</p>
<h2 id="MHA安装"><a href="#MHA安装" class="headerlink" title="MHA安装"></a>MHA安装</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>分别在主库和从库上安装，执行命令：<br>yum -y install gcc gcc-c++ make openssl-devel perl perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Config-IniFiles perl-Time-HiRes perl-Module-Install.noarch mailx jwhois cpan  </p>
<h3 id="主库安装mha4mysql-node"><a href="#主库安装mha4mysql-node" class="headerlink" title="主库安装mha4mysql-node"></a>主库安装mha4mysql-node</h3><p>MHA管理端安装在从库上，主库上只需要mha4mysql-node即可，由于MySQL使用5.7版本，MHA也使用最新的0.57版本，采用编译安装方式。下载地址：<a href="https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw" target="_blank" rel="noopener">https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cd /usr/src/</span><br><span class="line">[root@master src]# tar -zxf mha4mysql-node-0.57.tar.gz</span><br><span class="line">[root@master mha4mysql-node-0.57]# perl Makefile.PL             #编译过程省略</span><br><span class="line">[root@master mha4mysql-node-0.57]# make</span><br><span class="line">[root@master mha4mysql-node-0.57]# make install</span><br><span class="line">[root@master mha4mysql-node-0.57]# ll /usr/local/bin/ -t        #查看安装，有以下文件则mha4mysql-node安装成功</span><br><span class="line">total 1760</span><br><span class="line">-r-xr-xr-x 1 root root  16381 Jul 21 09:41 apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x 1 root root   8261 Jul 21 09:41 purge_relay_logs</span><br><span class="line">-r-xr-xr-x 1 root root   7525 Jul 21 09:41 save_binary_logs</span><br><span class="line">-r-xr-xr-x 1 root root   4807 Jul 21 09:41 filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p>
<h3 id="从库安装mha4mysql-manager和mha4mysql-node"><a href="#从库安装mha4mysql-manager和mha4mysql-node" class="headerlink" title="从库安装mha4mysql-manager和mha4mysql-node"></a>从库安装mha4mysql-manager和mha4mysql-node</h3><p>MHA管理端安装在从库，从库需要安装manager端和node端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cd /usr/src/</span><br><span class="line">[root@slave src]# tar -zxf mha4mysql-manager-0.57.tar.gz </span><br><span class="line">[root@slave src]# cd mha4mysql-manager-0.57</span><br><span class="line">[root@slave mha4mysql-manager-0.57]# perl Makefile.PL           #编译过程省略</span><br><span class="line">[root@slave mha4mysql-manager-0.57]# make</span><br><span class="line">[root@slave mha4mysql-manager-0.57]# make install </span><br><span class="line">[root@slave mha4mysql-manager-0.57]# ll /usr/local/bin/ -t      #查看安装，有以下文件则mha4mysql-manager安装成功</span><br><span class="line">total 40</span><br><span class="line">-r-xr-xr-x 1 root root 1779 Oct 11 15:45 masterha_check_ssh</span><br><span class="line">-r-xr-xr-x 1 root root 2517 Oct 11 15:45 masterha_manager</span><br><span class="line">-r-xr-xr-x 1 root root 2373 Oct 11 15:45 masterha_master_switch</span><br><span class="line">-r-xr-xr-x 1 root root 5171 Oct 11 15:45 masterha_secondary_check</span><br><span class="line">-r-xr-xr-x 1 root root 1995 Oct 11 15:45 masterha_check_repl</span><br><span class="line">-r-xr-xr-x 1 root root 1865 Oct 11 15:45 masterha_check_status</span><br><span class="line">-r-xr-xr-x 1 root root 3201 Oct 11 15:45 masterha_conf_host</span><br><span class="line">-r-xr-xr-x 1 root root 2165 Oct 11 15:45 masterha_master_monitor</span><br><span class="line">-r-xr-xr-x 1 root root 1739 Oct 11 15:45 masterha_stop</span><br><span class="line">[root@slave mha4mysql-manager-0.57]# cd ..</span><br><span class="line">[root@slave src]# tar -zxf mha4mysql-node-0.57.tar.gz </span><br><span class="line">[root@slave src]# cd mha4mysql-node-0.57</span><br><span class="line">[root@slave mha4mysql-node-0.57]# perl Makefile.PL              #编译过程省略        </span><br><span class="line">[root@slave mha4mysql-node-0.57]# make</span><br><span class="line">[root@slave mha4mysql-node-0.57]# make install</span><br><span class="line">[root@slave mha4mysql-node-0.57]# ll /usr/local/bin/ -t         #查看安装，有以下文件则mha4mysql-node安装成功</span><br><span class="line">total 84</span><br><span class="line">-r-xr-xr-x 1 root root 16381 Oct 11 15:47 apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x 1 root root  4807 Oct 11 15:47 filter_mysqlbinlog</span><br><span class="line">-r-xr-xr-x 1 root root  8261 Oct 11 15:47 purge_relay_logs</span><br><span class="line">-r-xr-xr-x 1 root root  7525 Oct 11 15:47 save_binary_logs</span><br></pre></td></tr></table></figure></p>
<h2 id="MHA目录结构说明"><a href="#MHA目录结构说明" class="headerlink" title="MHA目录结构说明"></a>MHA目录结构说明</h2><h3 id="MHAManager"><a href="#MHAManager" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>mhamanager工具包主要包括以下工具<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@slave  ~]# ll /usr/local/bin/</span><br><span class="line">总用量 40</span><br><span class="line">-r-xr-xr-x  1 root root  1995 Oct 11 15:45 masterha_check_repl         #检查MySQL复制情况</span><br><span class="line">-r-xr-xr-x  1 root root  1779 Oct 11 15:45 masterha_check_ssh          #检查MHA的SSH配置情况</span><br><span class="line">-r-xr-xr-x  1 root root  1865 Oct 11 15:45 masterha_check_status       #检测当前MHA运行状态</span><br><span class="line">-r-xr-xr-x  1 root root  3201 Oct 11 15:45 masterha_conf_host          #添加或删除配置的server信息</span><br><span class="line">-r-xr-xr-x  1 root root  2517 Oct 11 15:45 masterha_manager            #启动MHA</span><br><span class="line">-r-xr-xr-x  1 root root  2165 Oct 11 15:45 masterha_master_monitor     #检测Master是否宕机</span><br><span class="line">-r-xr-xr-x  1 root root  2373 Oct 11 15:45 masterha_master_switch      #控制故障转移，自动或者手动</span><br><span class="line">-r-xr-xr-x  1 root root  5172 Oct 11 15:45 masterha_secondary_check    #通过其他路由检测Master是否真的宕机</span><br><span class="line">-r-xr-xr-x  1 root root  1739 Oct 11 15:45 masterha_stop               #停止MHA</span><br></pre></td></tr></table></figure></p>
<h3 id="MHANode"><a href="#MHANode" class="headerlink" title="MHANode"></a>MHANode</h3><p>mhanode工具包主要包括以下工具<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ll /usr/local/bin/ -t   </span><br><span class="line">total 84</span><br><span class="line">-r-xr-xr-x  1 root root 16371 Oct 11 15:47 apply_diff_relay_logs       #识别差异日志的中继日志，并将其差异事件应用于其他Slave</span><br><span class="line">-r-xr-xr-x  1 root root  4807 Oct 11 15:47 filter_mysqlbinlog          #去除不必要的Rollback事件</span><br><span class="line">-r-xr-xr-x  1 root root  8263 Oct 11 15:47 purge_relay_logs            #删除无用的Relay log，避免延时</span><br><span class="line">-r-xr-xr-x  1 root root  7525 Oct 11 15:47 save_binary_logs            #保存和复制down掉的主服务器二进制日志</span><br></pre></td></tr></table></figure></p>
<h3 id="自定义扩展脚本说明"><a href="#自定义扩展脚本说明" class="headerlink" title="自定义扩展脚本说明"></a>自定义扩展脚本说明</h3><p>secondary_check_script #通过多条网络路由检测master的可用性<br>master_ip_failover_script #自动failover时候的切换脚本，可将vip信息写入此脚本中<br>shutdown_script #强制关闭master节点执行脚本<br>report_script #发送报告<br>init_conf_load_script #加载初始配置参数，如不想在配置中写明文密码<br>master_ip_online_change_script #手动failover时候的切换脚本  </p>
<h2 id="keepalived安装"><a href="#keepalived安装" class="headerlink" title="keepalived安装"></a>keepalived安装</h2><p>MHA作为MySQL的HA软件,借助脚本或者第三方软件如keepalived,可实现自动的failover<br>本次环境使用yum安装keepalived,主库和从库分别执行安装: yum -y install keepalived<br>keepalived的配置文件,默认在主库上绑定EIP,priority要比备库高,同时为了避免脑裂,两个state同时设置为BACKUP,由于HaVip不支持组播和广播通讯,因此需要将keepalived的心跳方式设置为单播,添加unicast_src_ip和unicast_peer</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><h4 id="主库配置-1"><a href="#主库配置-1" class="headerlink" title="主库配置"></a>主库配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     duanwenjie@huan.tv</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.16.82 dev eth0 label eth0:havip</span><br><span class="line">    &#125;</span><br><span class="line">        unicast_src_ip 192.168.16.80</span><br><span class="line">        unicast_peer &#123;</span><br><span class="line">                192.168.16.81</span><br><span class="line">                        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="从库配置-1"><a href="#从库配置-1" class="headerlink" title="从库配置"></a>从库配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/keepalived/keepalived.conf</span><br><span class="line">! Configuration File for keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     duanwenjie@huan.tv</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 99</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.16.82 dev eth0 label eth0:havip</span><br><span class="line">    &#125;</span><br><span class="line">        unicast_src_ip 192.168.16.81</span><br><span class="line">        unicast_peer &#123;</span><br><span class="line">                192.168.16.80</span><br><span class="line">                        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="EIP漂移测试"><a href="#EIP漂移测试" class="headerlink" title="EIP漂移测试"></a>EIP漂移测试</h3><p>分别启动keepalived服务，查看默认EIP在哪台机器上，同时关闭EIP所在机器的keepalived服务，查看EIP是否漂移，最后恢复原状</p>
<h4 id="主库启动keepalived服务"><a href="#主库启动keepalived服务" class="headerlink" title="主库启动keepalived服务"></a>主库启动keepalived服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master keepalived]# /etc/init.d/keepalived start</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@master keepalived]#</span><br></pre></td></tr></table></figure>
<h4 id="从库启动keepalived服务"><a href="#从库启动keepalived服务" class="headerlink" title="从库启动keepalived服务"></a>从库启动keepalived服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave keepalived]# /etc/init.d/keepalived start</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@slave keepalived]#</span><br></pre></td></tr></table></figure>
<h4 id="查看默认EIP在主库上"><a href="#查看默认EIP在主库上" class="headerlink" title="查看默认EIP在主库上"></a>查看默认EIP在主库上</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.80  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:172562 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:71674 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:200695958 (191.3 MiB)  TX bytes:12526649 (11.9 MiB)</span><br><span class="line"></span><br><span class="line">eth0:havip Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.82  Bcast:0.0.0.0  Mask:255.255.255.255</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:7946 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:7946 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:510910 (498.9 KiB)  TX bytes:510910 (498.9 KiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<h4 id="关闭主库的keepalived服务"><a href="#关闭主库的keepalived服务" class="headerlink" title="关闭主库的keepalived服务"></a>关闭主库的keepalived服务</h4><p>关闭主库的keepalived服务后，EIP消失<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/keepalived stop</span><br><span class="line">Stopping keepalived:                                       [  OK  ]</span><br><span class="line">[root@master ~]# ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.80  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:172670 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:71803 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:200704346 (191.4 MiB)  TX bytes:12569281 (11.9 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:7976 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:7976 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:512770 (500.7 KiB)  TX bytes:512770 (500.7 KiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h4 id="查看EIP是否漂移到从库上"><a href="#查看EIP是否漂移到从库上" class="headerlink" title="查看EIP是否漂移到从库上"></a>查看EIP是否漂移到从库上</h4><p>此时EIP已经漂移到从库上<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:12:80:57  </span><br><span class="line">          inet addr:192.168.16.81  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:164539 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:77532 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:202145589 (192.7 MiB)  TX bytes:12091265 (11.5 MiB)</span><br><span class="line"></span><br><span class="line">eth0:havip Link encap:Ethernet  HWaddr 00:16:3E:12:80:57  </span><br><span class="line">          inet addr:192.168.16.82  Bcast:0.0.0.0  Mask:255.255.255.255</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:7961 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:7961 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:508050 (496.1 KiB)  TX bytes:508050 (496.1 KiB)</span><br><span class="line"></span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h4 id="恢复原状"><a href="#恢复原状" class="headerlink" title="恢复原状"></a>恢复原状</h4><p>主库启动keepalived服务，查看EIP已经又漂移回来<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/keepalived start</span><br><span class="line">Starting keepalived:                                       [  OK  ]</span><br><span class="line">[root@master ~]# ifconfig</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.80  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:172863 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:71978 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:200717148 (191.4 MiB)  TX bytes:12627987 (12.0 MiB)</span><br><span class="line"></span><br><span class="line">eth0:havip Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.82  Bcast:0.0.0.0  Mask:255.255.255.255</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:8039 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:8039 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:516676 (504.5 KiB)  TX bytes:516676 (504.5 KiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h2 id="MHA配置"><a href="#MHA配置" class="headerlink" title="MHA配置"></a>MHA配置</h2><h3 id="MHAManager-1"><a href="#MHAManager-1" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>创建配置目录/etc/masterha/，同时创建一个项目上的配置文件，仅配置自动FailOver部分，脚本暂时不定义，下文会有MHA引入keepalived。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">[server default]</span><br><span class="line">manager_workdir=/var/log/masterha/app1   </span><br><span class="line">manager_log=/var/log/masterha/app1/manager.log </span><br><span class="line">master_binlog_dir=/hwdata/data/percona        </span><br><span class="line">password=mha123456                             </span><br><span class="line">user=mha01                                     </span><br><span class="line">ping_interval=1                                    </span><br><span class="line">remote_workdir=/tmp                                                </span><br><span class="line">repl_password=slave123456                                          </span><br><span class="line">repl_user=slave01                                                 </span><br><span class="line">ssh_user=root                                                     </span><br><span class="line">#master_ip_failover_script=/usr/local/bin/master_ip_failover        </span><br><span class="line">#master_ip_online_change_script= /usr/local/bin/master_ip_online_change  </span><br><span class="line">#report_script=/usr/local/bin/send_report                         </span><br><span class="line">#shutdown_script=                                                 </span><br><span class="line">secondary_check_script = masterha_secondary_check -s 192.168.16.80 -s 192.168.16.81 --user=root hostname=192.168.16.80  --master_ip=192.168.16.80 --master_port=3306 </span><br><span class="line">[server1]</span><br><span class="line">hostname=192.168.16.80                                          </span><br><span class="line">port=3306</span><br><span class="line">[server2]</span><br><span class="line">hostname=192.168.16.81                                         </span><br><span class="line">port=3306</span><br><span class="line">candidate_master=1</span><br></pre></td></tr></table></figure></p>
<h3 id="测试MHAManager-SSH"><a href="#测试MHAManager-SSH" class="headerlink" title="测试MHAManager SSH"></a>测试MHAManager SSH</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_ssh --conf=/etc/masterha/app1.cnf </span><br><span class="line">Wed Oct 11 17:21:46 2017 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Oct 11 17:21:46 2017 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Oct 11 17:21:46 2017 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Oct 11 17:21:46 2017 - [info] Starting SSH connection tests..</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [debug] </span><br><span class="line">Wed Oct 11 17:21:46 2017 - [debug]  Connecting via SSH from root@192.168.16.80(192.168.16.80:22) to root@192.168.16.81(192.168.16.81:22)..</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [debug]   ok.</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [debug] </span><br><span class="line">Wed Oct 11 17:21:47 2017 - [debug]  Connecting via SSH from root@192.168.16.81(192.168.16.81:22) to root@192.168.16.80(192.168.16.80:22)..</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [debug]   ok.</span><br><span class="line">Wed Oct 11 17:21:47 2017 - [info] All SSH connection tests passed successfully.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h3 id="测试MHAManager-复制"><a href="#测试MHAManager-复制" class="headerlink" title="测试MHAManager 复制"></a>测试MHAManager 复制</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_repl --conf=/etc/masterha/app1.cnf</span><br><span class="line">Wed Oct 11 17:22:47 2017 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Wed Oct 11 17:22:47 2017 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Oct 11 17:22:47 2017 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Wed Oct 11 17:22:47 2017 - [info] MHA::MasterMonitor version 0.57.</span><br><span class="line">Creating directory /var/log/masterha/app1.. done.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Multi-master configuration is detected. Current primary(writable) master is 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Master configurations are as below: </span><br><span class="line">Master 192.168.16.81(192.168.16.81:3306), replicating from 192.168.16.80(192.168.16.80:3306), read-only</span><br><span class="line">Master 192.168.16.80(192.168.16.80:3306), replicating from 192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] GTID failover mode = 1</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Dead Servers:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Alive Servers:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]   192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]   192.168.16.81(192.168.16.81:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Alive Slaves:</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]   192.168.16.81(192.168.16.81:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]     GTID ON</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]     Replicating from 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Current Alive Master: 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Checking slave configurations..</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Checking replication filtering settings..</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]  Replication filtering check ok.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] HealthCheck: SSH to 192.168.16.80 is reachable.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] </span><br><span class="line">192.168.16.80(192.168.16.80:3306) (current master)</span><br><span class="line"> +--192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Checking replication health on 192.168.16.81..</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info]  ok.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [warning] master_ip_failover_script is not defined.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [warning] shutdown_script is not defined.</span><br><span class="line">Wed Oct 11 17:22:48 2017 - [info] Got exit code 0 (Not master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication Health is OK.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h2 id="MHA引入keepalived"><a href="#MHA引入keepalived" class="headerlink" title="MHA引入keepalived"></a>MHA引入keepalived</h2><p>把keepalived服务引入MHA，需要修改切换是触发的脚本文件master_ip_failover即可，在该脚本中添加在master发生宕机时对keepalived的处理。</p>
<h3 id="master-ip-failover脚本"><a href="#master-ip-failover脚本" class="headerlink" title="master_ip_failover脚本"></a>master_ip_failover脚本</h3><p>编辑脚本/usr/local/bin/master_ip_failover，修改后如下，这里完整的脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# cat /usr/local/bin/master_ip_failover </span><br><span class="line">#!/usr/bin/env perl</span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; &apos;all&apos;;</span><br><span class="line"></span><br><span class="line">use Getopt::Long;</span><br><span class="line"></span><br><span class="line">my (</span><br><span class="line">    $command,          $ssh_user,        $orig_master_host, $orig_master_ip,</span><br><span class="line">    $orig_master_port, $new_master_host, $new_master_ip,    $new_master_port</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">my $vip = &apos;192.168.16.82&apos;;</span><br><span class="line">my $ssh_start_vip = &quot;/etc/init.d/keepalived start&quot;;</span><br><span class="line">my $ssh_stop_vip = &quot;/etc/init.d/keepalived stop&quot;;</span><br><span class="line"></span><br><span class="line">GetOptions(</span><br><span class="line">    &apos;command=s&apos;          =&gt; \$command,</span><br><span class="line">    &apos;ssh_user=s&apos;         =&gt; \$ssh_user,</span><br><span class="line">    &apos;orig_master_host=s&apos; =&gt; \$orig_master_host,</span><br><span class="line">    &apos;orig_master_ip=s&apos;   =&gt; \$orig_master_ip,</span><br><span class="line">    &apos;orig_master_port=i&apos; =&gt; \$orig_master_port,</span><br><span class="line">    &apos;new_master_host=s&apos;  =&gt; \$new_master_host,</span><br><span class="line">    &apos;new_master_ip=s&apos;    =&gt; \$new_master_ip,</span><br><span class="line">    &apos;new_master_port=i&apos;  =&gt; \$new_master_port,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">exit &amp;main();</span><br><span class="line"></span><br><span class="line">sub main &#123;</span><br><span class="line"></span><br><span class="line">    print &quot;\n\nIN SCRIPT TEST====$ssh_stop_vip==$ssh_start_vip===\n\n&quot;;</span><br><span class="line"></span><br><span class="line">    if ( $command eq &quot;stop&quot; || $command eq &quot;stopssh&quot; ) &#123;</span><br><span class="line"></span><br><span class="line">        my $exit_code = 1;</span><br><span class="line">        eval &#123;</span><br><span class="line">            print &quot;Disabling the VIP on old master: $orig_master_host \n&quot;;</span><br><span class="line">            &amp;stop_vip();</span><br><span class="line">            $exit_code = 0;</span><br><span class="line">        &#125;;</span><br><span class="line">        if ($@) &#123;</span><br><span class="line">            warn &quot;Got Error: $@\n&quot;;</span><br><span class="line">            exit $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        exit $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( $command eq &quot;start&quot; ) &#123;</span><br><span class="line"></span><br><span class="line">        my $exit_code = 10;</span><br><span class="line">        eval &#123;</span><br><span class="line">            print &quot;Enabling the VIP - $vip on the new master - $new_master_host \n&quot;;</span><br><span class="line">            &amp;start_vip();</span><br><span class="line">            $exit_code = 0;</span><br><span class="line">        &#125;;</span><br><span class="line">        if ($@) &#123;</span><br><span class="line">            warn $@;</span><br><span class="line">            exit $exit_code;</span><br><span class="line">        &#125;</span><br><span class="line">        exit $exit_code;</span><br><span class="line">    &#125;</span><br><span class="line">    elsif ( $command eq &quot;status&quot; ) &#123;</span><br><span class="line">        print &quot;Checking the Status of the script.. OK \n&quot;;</span><br><span class="line">        #`ssh $ssh_user\@$orig_master_ip \&quot; $ssh_start_vip \&quot;`;</span><br><span class="line">        exit 0;</span><br><span class="line">    &#125;</span><br><span class="line">    else &#123;</span><br><span class="line">        &amp;usage();</span><br><span class="line">        exit 1;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># A simple system call that enable the VIP on the new master</span><br><span class="line">sub start_vip() &#123;</span><br><span class="line">    `ssh $ssh_user\@$new_master_host \&quot; $ssh_start_vip \&quot;`;</span><br><span class="line">&#125;</span><br><span class="line"># A simple system call that disable the VIP on the old_master</span><br><span class="line">sub stop_vip() &#123;</span><br><span class="line">     return 0  unless  ($ssh_user);</span><br><span class="line">    `ssh $ssh_user\@$orig_master_host \&quot; $ssh_stop_vip \&quot;`;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub usage &#123;</span><br><span class="line">    print</span><br><span class="line">    &quot;Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure></p>
<p>添加权限<br>chmod +x /usr/local/bin/master_ip_failover</p>
<h3 id="send-report脚本"><a href="#send-report脚本" class="headerlink" title="send_report脚本"></a>send_report脚本</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# cat /usr/local/bin/send_report </span><br><span class="line">#!/usr/bin/perl</span><br><span class="line"> </span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; &apos;all&apos;;</span><br><span class="line">use Mail::Sender;</span><br><span class="line">use Getopt::Long;</span><br><span class="line"> </span><br><span class="line">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span><br><span class="line">my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );</span><br><span class="line">my $smtp=&apos;smtp.126.com&apos;;</span><br><span class="line">my $mail_from=&apos;xxx@126.com&apos;;</span><br><span class="line">my $mail_user=&apos;xxx@126.com&apos;;</span><br><span class="line">my $mail_pass=&apos;xxx&apos;;</span><br><span class="line">#my $mail_to=[&apos;xxx&apos;,&apos;xxx&apos;];</span><br><span class="line">my $mail_to=&apos;xxx&apos;;</span><br><span class="line">GetOptions(</span><br><span class="line">  &apos;orig_master_host=s&apos; =&gt; \$dead_master_host,</span><br><span class="line">  &apos;new_master_host=s&apos;  =&gt; \$new_master_host,</span><br><span class="line">  &apos;new_slave_hosts=s&apos;  =&gt; \$new_slave_hosts,</span><br><span class="line">  &apos;subject=s&apos;          =&gt; \$subject,</span><br><span class="line">  &apos;body=s&apos;             =&gt; \$body,</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);</span><br><span class="line"> </span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_;</span><br><span class="line">    open my $DEBUG, &quot;&gt; /var/log/masterha/app1/manager.log&quot;</span><br><span class="line">        or die &quot;Can&apos;t open the debug      file:$!\n&quot;;</span><br><span class="line">    my $sender = new Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; &apos;text/plain; charset=utf-8&apos;,</span><br><span class="line">        encoding    =&gt; &apos;utf-8&apos;,</span><br><span class="line">        smtp        =&gt; $smtp,</span><br><span class="line">        from        =&gt; $mail_from,</span><br><span class="line">        auth        =&gt; &apos;LOGIN&apos;,</span><br><span class="line">        TLS_allowed =&gt; &apos;0&apos;,</span><br><span class="line">        authid      =&gt; $user,</span><br><span class="line">        authpwd     =&gt; $passwd,</span><br><span class="line">        to          =&gt; $mail_to,</span><br><span class="line">        subject     =&gt; $subject,</span><br><span class="line">        debug       =&gt; $DEBUG</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    $sender-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; $msg,</span><br><span class="line">            debug =&gt; $DEBUG</span><br><span class="line">        &#125;</span><br><span class="line">    ) or print $Mail::Sender::Error;</span><br><span class="line">    return 1;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"># Do whatever you want here</span><br><span class="line"> </span><br><span class="line">exit 0;</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<p>添加权限<br>chmod +x /usr/local/bin/send_report</p>
<h3 id="MHAManager修改注释"><a href="#MHAManager修改注释" class="headerlink" title="MHAManager修改注释"></a>MHAManager修改注释</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# cat /etc/masterha/app1.cnf |grep master_ip_failover_script</span><br><span class="line">master_ip_failover_script=/usr/local/bin/master_ip_failover        </span><br><span class="line">[root@slave app1]# cat /etc/masterha/app1.cnf |grep report</span><br><span class="line">report_script=/usr/local/bin/send_report                         </span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure>
<h2 id="HaVip绑定EIP"><a href="#HaVip绑定EIP" class="headerlink" title="HaVip绑定EIP"></a>HaVip绑定EIP</h2><p>keepalived服务已经配置完成，VIP也可以自动漂移后，但是其还不能在内网中通讯，需要将EIP映射到HaVip中，创建高可用虚拟IP，把master和slave两个实例的绑定在一起，具体步骤省略，见下图<br><img src="http://note.youdao.com/yws/public/resource/eed85389475569ba15ce22e5a266d5fb/xmlnote/E0CF3D2D9BE747299B2348C6AD4EAD30/37915" alt="image"></p>
<h2 id="MHA启动"><a href="#MHA启动" class="headerlink" title="MHA启动"></a>MHA启动</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;</span><br><span class="line">[1] 6706</span><br><span class="line">[root@slave masterha]# nohup: ignoring input and appending output to `nohup.out&apos;</span><br></pre></td></tr></table></figure>
<h3 id="查看启动日志"><a href="#查看启动日志" class="headerlink" title="查看启动日志"></a>查看启动日志</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# cat /var/log/masterha/app1/manager.log</span><br><span class="line">Thu Oct 12 09:26:56 2017 - [info] MHA::MasterMonitor version 0.57.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Multi-master configuration is detected. Current primary(writable) master is 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Master configurations are as below: </span><br><span class="line">Master 192.168.16.81(192.168.16.81:3306), replicating from 192.168.16.80(192.168.16.80:3306), read-only</span><br><span class="line">Master 192.168.16.80(192.168.16.80:3306), replicating from 192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] GTID failover mode = 1</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Dead Servers:</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Alive Servers:</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]   192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]   192.168.16.81(192.168.16.81:3306)</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Alive Slaves:</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]   192.168.16.81(192.168.16.81:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]     GTID ON</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]     Replicating from 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Current Alive Master: 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Checking slave configurations..</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Checking replication filtering settings..</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]  Replication filtering check ok.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] HealthCheck: SSH to 192.168.16.80 is reachable.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] </span><br><span class="line">192.168.16.80(192.168.16.80:3306) (current master)</span><br><span class="line"> +--192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Checking master_ip_failover_script status:</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=192.168.16.80 --orig_master_ip=192.168.16.80 --orig_master_port=3306 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]  OK.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [warning] shutdown_script is not defined.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Set master ping interval 1 seconds.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Set secondary check script: masterha_secondary_check -s 192.168.16.80 -s 192.168.16.81 --user=root hostname=192.168.16.80  --master_ip=192.168.16.80 --master_port=3306</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Starting ping health check on 192.168.16.80(192.168.16.80:3306)..</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn&apos;t respond..</span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure>
<h2 id="模拟主库故障-自动FailOver"><a href="#模拟主库故障-自动FailOver" class="headerlink" title="模拟主库故障(自动FailOver)"></a>模拟主库故障(自动FailOver)</h2><h3 id="确认MHAManager进程状态"><a href="#确认MHAManager进程状态" class="headerlink" title="确认MHAManager进程状态"></a>确认MHAManager进程状态</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# ps aux|grep master</span><br><span class="line">root      1217  0.0  0.0  81520  3440 ?        Ss   Oct11   0:00 /usr/libexec/postfix/master</span><br><span class="line">root     20887  0.2  0.4 194688 18736 pts/1    S    08:57   0:00 perl /usr/local/bin/masterha_manager --conf=/etc/masterha/app1.cnf</span><br><span class="line">root     20998  0.0  0.0 103252   844 pts/1    S+   08:59   0:00 grep master</span><br><span class="line">[root@slave app1]# ifconfig     #VIP不在slave上</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:12:80:57  </span><br><span class="line">          inet addr:192.168.16.81  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:288188 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:129868 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:211584573 (201.7 MiB)  TX bytes:50227849 (47.9 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:50346 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:50346 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:3204922 (3.0 MiB)  TX bytes:3204922 (3.0 MiB)</span><br><span class="line"></span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure>
<h3 id="停止主库MySQL服务"><a href="#停止主库MySQL服务" class="headerlink" title="停止主库MySQL服务"></a>停止主库MySQL服务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ifconfig   #停止前VIP存在于主库上</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.80  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:278061 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:223278 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:210643899 (200.8 MiB)  TX bytes:57552395 (54.8 MiB)</span><br><span class="line"></span><br><span class="line">eth0:havip Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.82  Bcast:0.0.0.0  Mask:255.255.255.255</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:50158 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:50158 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:3130070 (2.9 MiB)  TX bytes:3130070 (2.9 MiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]# /etc/init.d/mysqld stop</span><br><span class="line">Shutting down MySQL (Percona Server)............           [  OK  ]</span><br><span class="line">[root@master ~]# ifconfig   #停止后VIP已经漂移走</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.80  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:278240 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:223445 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:210664827 (200.9 MiB)  TX bytes:57596785 (54.9 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:50175 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:50175 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:3131100 (2.9 MiB)  TX bytes:3131100 (2.9 MiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<h3 id="查看FailOver日志"><a href="#查看FailOver日志" class="headerlink" title="查看FailOver日志"></a>查看FailOver日志</h3><p>登录从库，查看MHAManager日志<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# tail -f /var/log/masterha/app1/manager.log</span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Checking the Status of the script.. OK </span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info]  OK.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [warning] shutdown_script is not defined.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Set master ping interval 1 seconds.</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Set secondary check script: masterha_secondary_check -s 192.168.16.80 -s 192.168.16.81 --user=root hostname=192.168.16.80  --master_ip=192.168.16.80 --master_port=3306</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Starting ping health check on 192.168.16.80(192.168.16.80:3306)..</span><br><span class="line">Thu Oct 12 09:26:57 2017 - [info] Ping(SELECT) succeeded, waiting until MySQL doesn&apos;t respond..     #开始监听服务状态</span><br><span class="line">#监控到master故障后，MHA开始做自动FailOver</span><br><span class="line">Thu Oct 12 09:27:54 2017 - [warning] Got error on MySQL select ping: 2006 (MySQL server has gone away)</span><br><span class="line">Thu Oct 12 09:27:54 2017 - [info] Executing secondary network check script: masterha_secondary_check -s 192.168.16.80 -s 192.168.16.81 --user=root hostname=192.168.16.80  --master_ip=192.168.16.80 --master_port=3306  --user=root  --master_host=192.168.16.80  --master_ip=192.168.16.80  --master_port=3306 --master_user=mha01 --master_password=mha123456 --ping_type=SELECT</span><br><span class="line">Thu Oct 12 09:27:54 2017 - [info] Executing SSH check script: exit 0</span><br><span class="line">Thu Oct 12 09:27:54 2017 - [info] HealthCheck: SSH to 192.168.16.80 is reachable.</span><br><span class="line">Monitoring server 192.168.16.80 is reachable, Master is not reachable from 192.168.16.80. OK.</span><br><span class="line">Monitoring server 192.168.16.81 is reachable, Master is not reachable from 192.168.16.81. OK.</span><br><span class="line">Thu Oct 12 09:27:54 2017 - [info] Master is not reachable from all other monitoring servers. Failover should start.</span><br><span class="line">Thu Oct 12 09:27:55 2017 - [warning] Got error on MySQL connect: 2013 (Lost connection to MySQL server at &apos;reading initial communication packet&apos;, system error: 111)</span><br><span class="line">Thu Oct 12 09:27:55 2017 - [warning] Connection failed 2 time(s)..</span><br><span class="line">Thu Oct 12 09:27:56 2017 - [warning] Got error on MySQL connect: 2013 (Lost connection to MySQL server at &apos;reading initial communication packet&apos;, system error: 111)</span><br><span class="line">Thu Oct 12 09:27:56 2017 - [warning] Connection failed 3 time(s)..</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [warning] Got error on MySQL connect: 2013 (Lost connection to MySQL server at &apos;reading initial communication packet&apos;, system error: 111)</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [warning] Connection failed 4 time(s)..</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [warning] Master is not reachable from health checker!</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [warning] Master 192.168.16.80(192.168.16.80:3306) is not reachable!</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [warning] SSH is reachable.</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [info] Connecting to a master server failed. Reading configuration file /etc/masterha_default.cnf and /etc/masterha/app1.cnf again, and trying to connect to all servers to check server status..</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Thu Oct 12 09:27:57 2017 - [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] GTID failover mode = 1</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Dead Servers:</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info]   192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Alive Servers:</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info]   192.168.16.81(192.168.16.81:3306)</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Alive Slaves:</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info]   192.168.16.81(192.168.16.81:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info]     GTID ON</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info]     Replicating from 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Checking slave configurations..</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Checking replication filtering settings..</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info]  Replication filtering check ok.</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Master is down!</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Terminating monitoring script.</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Got exit code 20 (Master dead).</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] MHA::MasterFailover version 0.57.</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] Starting master failover.</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] * Phase 1: Configuration Check Phase..</span><br><span class="line">Thu Oct 12 09:27:58 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] GTID failover mode = 1</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Dead Servers:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Checking master reachability via MySQL(double check)...</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  ok.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Alive Servers:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   192.168.16.81(192.168.16.81:3306)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Alive Slaves:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   192.168.16.81(192.168.16.81:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     GTID ON</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Replicating from 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Starting GTID based failover.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] ** Phase 1: Configuration Check Phase completed.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 2: Dead Master Shutdown Phase..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Forcing shutdown so that applications never connect to the current master..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Executing master IP deactivation script:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   /usr/local/bin/master_ip_failover --orig_master_host=192.168.16.80 --orig_master_ip=192.168.16.80 --orig_master_port=3306 --command=stopssh --ssh_user=root  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Disabling the VIP on old master: 192.168.16.80 </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  done.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 2: Dead Master Shutdown Phase completed.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 3: Master Recovery Phase..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 3.1: Getting Latest Slaves Phase..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] The latest binary log file/position on all slaves is mysql-bin.000005:234</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Latest slaves (Slaves that received relay log files to the latest):</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   192.168.16.81(192.168.16.81:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     GTID ON</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Replicating from 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] The oldest binary log file/position on all slaves is mysql-bin.000005:234</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Oldest slaves:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   192.168.16.81(192.168.16.81:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     GTID ON</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Replicating from 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 3.3: Determining New Master Phase..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Searching new master from slaves..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  Candidate masters from the configuration file:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   192.168.16.81(192.168.16.81:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     GTID ON</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Replicating from 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  Non-candidate masters:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  Searching from candidate_master slaves which have received the latest relay log events..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] New master is 192.168.16.81(192.168.16.81:3306)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Starting master failover..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">From:</span><br><span class="line">192.168.16.80(192.168.16.80:3306) (current master)</span><br><span class="line"> +--192.168.16.81(192.168.16.81:3306)</span><br><span class="line"></span><br><span class="line">To:</span><br><span class="line">192.168.16.81(192.168.16.81:3306) (new master)</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 3.3: New Master Recovery Phase..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  Waiting all logs to be applied.. </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   done.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Getting new master&apos;s binlog name and position..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  mysql-bin.000002:4876</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=&apos;192.168.16.81&apos;, MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER=&apos;slave01&apos;, MASTER_PASSWORD=&apos;xxx&apos;;</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000002, 4876, df5051fc-ae51-11e7-85ee-00163e0f0e4a:1-15,</span><br><span class="line">e1ec82e8-ae51-11e7-8532-00163e128057:1-6</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Executing master IP activate script:</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]   /usr/local/bin/master_ip_failover --command=start --ssh_user=root --orig_master_host=192.168.16.80 --orig_master_ip=192.168.16.80 --orig_master_port=3306 --new_master_host=192.168.16.81 --new_master_ip=192.168.16.81 --new_master_port=3306 --new_master_user=&apos;mha01&apos;   --new_master_password=xxx</span><br><span class="line">Unknown option: new_master_user</span><br><span class="line">Unknown option: new_master_password</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">IN SCRIPT TEST====/etc/init.d/keepalived stop==/etc/init.d/keepalived start===</span><br><span class="line"></span><br><span class="line">Enabling the VIP - 192.168.16.200 on the new master - 192.168.16.81 </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  OK.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Setting read_only=0 on 192.168.16.81(192.168.16.81:3306)..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  ok.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] ** Finished master recovery successfully.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 3: Master Recovery Phase completed.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 4: Slaves Recovery Phase..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 4.1: Starting Slaves in parallel..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] All new slave servers recovered successfully.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] * Phase 5: New master cleanup phase..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Resetting slave info on the new master..</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info]  192.168.16.81: Resetting slave info succeeded.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Master failover to 192.168.16.81(192.168.16.81:3306) completed successfully.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] </span><br><span class="line"></span><br><span class="line">----- Failover Report -----</span><br><span class="line"></span><br><span class="line">app1: MySQL Master failover 192.168.16.80(192.168.16.80:3306) to 192.168.16.81(192.168.16.81:3306) succeeded</span><br><span class="line"></span><br><span class="line">Master 192.168.16.80(192.168.16.80:3306) is down!</span><br><span class="line"></span><br><span class="line">Check MHA Manager logs at slave:/var/log/masterha/app1/manager.log for details.</span><br><span class="line"></span><br><span class="line">Started automated(non-interactive) failover.</span><br><span class="line">Invalidated master IP address on 192.168.16.80(192.168.16.80:3306)</span><br><span class="line">Selected 192.168.16.81(192.168.16.81:3306) as a new master.</span><br><span class="line">192.168.16.81(192.168.16.81:3306): OK: Applying all logs succeeded.</span><br><span class="line">192.168.16.81(192.168.16.81:3306): OK: Activated master IP address.</span><br><span class="line">192.168.16.81(192.168.16.81:3306): Resetting slave info succeeded.</span><br><span class="line">Master failover to 192.168.16.81(192.168.16.81:3306) completed successfully.</span><br><span class="line">Thu Oct 12 09:27:59 2017 - [info] Sending mail..</span><br><span class="line">Option new_slave_hosts requires an argument</span><br><span class="line">Unknown option: conf</span><br><span class="line">tail: /var/log/masterha/app1/manager.log: file truncated</span><br><span class="line">^C</span><br><span class="line">[1]+  Done                    nohup masterha_manager --conf=/etc/masterha/app1.cnf  (wd: /etc/masterha)</span><br><span class="line">(wd now: /var/log/masterha/app1)</span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure></p>
<p><font color="#FF0000">注意：<br>由于阿里云的ECS默认不允许发送邮件，它们把25端口已经封掉，如果需要开通25端口，主联系阿里云技术支持。本次切换日志在最后没有发送邮件，是由于这个原因导致的。</font></p>
<h3 id="日志解析过程"><a href="#日志解析过程" class="headerlink" title="日志解析过程"></a>日志解析过程</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">启动前的准备工作</span><br><span class="line">检查数据库服务器状态,获取相关参数设置</span><br><span class="line">检查GTID、candidate_master、过滤DB是否设置</span><br><span class="line">测试ssh连接是否成功</span><br><span class="line">测试MHA node是否可用</span><br><span class="line">创建MHA日志目录</span><br><span class="line">开始检查slave的差异日志应用权限</span><br><span class="line">确定当前的复制架构</span><br><span class="line">调试master_ip_failover_script</span><br><span class="line">调试shutdown_script</span><br><span class="line">设置二次检查的主机masterha_secondary_check</span><br><span class="line">MHA启动完毕,进入监测状态</span><br><span class="line">监测master服务器挂了</span><br><span class="line">通过定义的二次监测,确认master是否挂了</span><br><span class="line">确认master挂了,开始进入failover流程</span><br><span class="line">再试尝试连接master和master的ssh</span><br><span class="line">通过MHA配置文件,监测其他slave的状态</span><br><span class="line">再次监测slave的配置是否有变化,是否符合failover条件</span><br><span class="line">正式开始failover</span><br><span class="line">再次对slave配置做检查</span><br><span class="line">对原Master做master_ip_failover_script和shutdown_script的操作</span><br><span class="line">开始差异日志的恢复，获取slave最后得到的binlog位置</span><br><span class="line">获取原master的binlog日志</span><br><span class="line">确定新的master</span><br><span class="line">在new master上应用差异的binlog日志</span><br><span class="line">获取new master的binlog位置。</span><br><span class="line">执行master_ip_failover_script,调用aws_vip_change.sh，执行VIP漂移</span><br><span class="line">开始恢复其他slave的差异日志</span><br><span class="line">差异日志应用完成以后,切换所有slave到new master。</span><br><span class="line">failover操作完成,生成failover报告</span><br><span class="line">最后发送邮件通知</span><br></pre></td></tr></table></figure>
<h3 id="确认FailOver状态"><a href="#确认FailOver状态" class="headerlink" title="确认FailOver状态"></a>确认FailOver状态</h3><p>登录从库，查看VIP是否漂移过程<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]# ifconfig     #VIP已经漂移过程</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:12:80:57  </span><br><span class="line">          inet addr:192.168.16.81  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:295022 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:135929 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:212253710 (202.4 MiB)  TX bytes:52246361 (49.8 MiB)</span><br><span class="line"></span><br><span class="line">eth0:havip Link encap:Ethernet  HWaddr 00:16:3E:12:80:57  </span><br><span class="line">          inet addr:192.168.16.82  Bcast:0.0.0.0  Mask:255.255.255.255</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:52973 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:52973 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:3597938 (3.4 MiB)  TX bytes:3597938 (3.4 MiB)</span><br><span class="line"></span><br><span class="line">[root@slave app1]#</span><br></pre></td></tr></table></figure></p>
<p>登录主库，查看VIP是否存在，keepalived服务状态<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# ifconfig   #VIP已经不存在</span><br><span class="line">eth0      Link encap:Ethernet  HWaddr 00:16:3E:0F:0E:4A  </span><br><span class="line">          inet addr:192.168.16.80  Bcast:192.168.31.255  Mask:255.255.240.0</span><br><span class="line">          UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1</span><br><span class="line">          RX packets:284277 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:229786 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:1000 </span><br><span class="line">          RX bytes:211190989 (201.4 MiB)  TX bytes:60010868 (57.2 MiB)</span><br><span class="line"></span><br><span class="line">lo        Link encap:Local Loopback  </span><br><span class="line">          inet addr:127.0.0.1  Mask:255.0.0.0</span><br><span class="line">          UP LOOPBACK RUNNING  MTU:65536  Metric:1</span><br><span class="line">          RX packets:51564 errors:0 dropped:0 overruns:0 frame:0</span><br><span class="line">          TX packets:51564 errors:0 dropped:0 overruns:0 carrier:0</span><br><span class="line">          collisions:0 txqueuelen:0 </span><br><span class="line">          RX bytes:3217146 (3.0 MiB)  TX bytes:3217146 (3.0 MiB)</span><br><span class="line"></span><br><span class="line">[root@master ~]# /etc/init.d/keepalived status  #keepalived服务已经停止</span><br><span class="line">keepalived is stopped</span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="手动FailOver"><a href="#手动FailOver" class="headerlink" title="手动FailOver"></a>手动FailOver</h3><p>MHA的手动FailOver不在本文范围，详情理论可参考官方文档。</p>
<h3 id="参数列表"><a href="#参数列表" class="headerlink" title="参数列表"></a>参数列表</h3><p>请参考之前<a href="https://dwj999.github.io/AWS-EC2%E6%90%AD%E5%BB%BAmha-vip-MySQL5-7.html#参数列表">文章</a>。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://dwj999.github.io/AWS-EC2搭建mha-vip-MySQL5-7.htm">https://dwj999.github.io/AWS-EC2搭建mha-vip-MySQL5-7.htm</a></p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>云服务器上MySQL高可用，也可通过云负载均衡产品+MySQL复制来实现，但在数据安全性上，没有MHA+VIP+MySQL相对安全。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/误删除frm、ibd文件恢复案例.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/误删除frm、ibd文件恢复案例.html" itemprop="url">误删除frm、ibd文件恢复案例</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-28T15:51:07+08:00">
                2017-07-28
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/备份恢复/" itemprop="url" rel="index">
                    <span itemprop="name">备份恢复</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>MySQL从5.5版本开始，InnoDB存储引擎已经成为默认存储引擎。通过参数innodb_file_per_table控制设置是否开启独立表空间，当开启独立表空间时数据和索引会存在于ibd文件中,数据目录中会存在frm和ibd文件;当未开启独立表空间时，此时使用的是共享表空间，数据和索引会存储在ibdata1文件中，数据目录只会存在frm文件。如果不小心删除了数据目录下的frm或者ibd文件时，当然是开启独立表空间时，除了xtrabackup、mysqldump恢复之外，介绍一下从物理备份通过拷贝文件的方式恢复。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>MySQL版本：percona server 5.6.36</p>
<h2 id="误删除ibd文件"><a href="#误删除ibd文件" class="headerlink" title="误删除ibd文件"></a>误删除ibd文件</h2><p>当识删除ibd文件时，由于frm表结构文件还存在，ibdata1元数据中的表信息也存在，可通过物理备份的ibd文件拷贝至数据目录，不需要修改tablespace ID即可完成恢复。</p>
<h3 id="创建测试表并插入数据"><a href="#创建测试表并插入数据" class="headerlink" title="创建测试表并插入数据"></a>创建测试表并插入数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# mysql -uroot -p123456 -e &quot;create database test11&quot;</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# ll test11/</span><br><span class="line">总用量 4</span><br><span class="line">-rw-rw---- 1 mysql mysql 61 7月  28 16:12 db.opt</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# mysql -uroot -p123456 test11</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 117</span><br><span class="line">Server version: 5.6.36-82.0-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [test11] 16:12:29 &gt; create table t11(id int unsigned not null auto_increment,name varchar(20),primary key(id));</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 16:13:26 &gt; insert into t11 values(null,&apos;aaa11&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 16:13:45 &gt; insert into t11 values(null,&apos;bbb22&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 16:13:53 &gt; insert into t11 values(null,&apos;ccc33&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 16:13:59 &gt; insert into t11 values(null,&apos;ddd44&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 16:14:04 &gt; insert into t11 values(null,&apos;eee55&apos;);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 16:14:10 &gt; select * from t11;</span><br><span class="line">+----+-------+</span><br><span class="line">| id | name  |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 | aaa11 |</span><br><span class="line">|  2 | bbb22 |</span><br><span class="line">|  3 | ccc33 |</span><br><span class="line">|  4 | ddd44 |</span><br><span class="line">|  5 | eee55 |</span><br><span class="line">+----+-------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] 16:14:13 &gt;</span><br></pre></td></tr></table></figure>
<h3 id="查看数据目录"><a href="#查看数据目录" class="headerlink" title="查看数据目录"></a>查看数据目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# ll test11/</span><br><span class="line">总用量 112</span><br><span class="line">-rw-rw---- 1 mysql mysql    61 7月  28 16:12 db.opt</span><br><span class="line">-rw-rw---- 1 mysql mysql  8586 7月  28 16:13 t11.frm</span><br><span class="line">-rw-rw---- 1 mysql mysql 98304 7月  28 16:14 t11.ibd</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]#</span><br></pre></td></tr></table></figure>
<h3 id="保存一份数据文件"><a href="#保存一份数据文件" class="headerlink" title="保存一份数据文件"></a>保存一份数据文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# /etc/init.d/mysqld stop</span><br><span class="line">Shutting down MySQL (Percona Server)...                    [确定]</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# cp -a test11/ /usr/src/ &amp;&amp; ll /usr/src/test11</span><br><span class="line">总用量 112</span><br><span class="line">-rw-rw---- 1 mysql mysql    61 7月  28 16:12 db.opt</span><br><span class="line">-rw-rw---- 1 mysql mysql  8586 7月  28 16:13 t11.frm</span><br><span class="line">-rw-rw---- 1 mysql mysql 98304 7月  28 16:14 t11.ibd</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]#</span><br></pre></td></tr></table></figure>
<h3 id="模拟删除ibd文件"><a href="#模拟删除ibd文件" class="headerlink" title="模拟删除ibd文件"></a>模拟删除ibd文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# ll test11/</span><br><span class="line">总用量 112</span><br><span class="line">-rw-rw---- 1 mysql mysql    61 7月  28 16:12 db.opt</span><br><span class="line">-rw-rw---- 1 mysql mysql  8586 7月  28 16:13 t11.frm</span><br><span class="line">-rw-rw---- 1 mysql mysql 98304 7月  28 16:14 t11.ibd</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# rm -rf test11/t11.ibd </span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# /etc/init.d/mysqld start</span><br><span class="line">Starting MySQL (Percona Server)..                          [确定]</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# mysql -uroot -p123456 test11 -e &quot;desc t11&quot;</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">ERROR 1146 (42S02) at line 1: Table &apos;test11.t11&apos; doesn&apos;t exist</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]#</span><br></pre></td></tr></table></figure>
<h3 id="通过备份恢复数据"><a href="#通过备份恢复数据" class="headerlink" title="通过备份恢复数据"></a>通过备份恢复数据</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# cp /usr/src/test11/t11.ibd test11/</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# chown -R mysql:mysql test11/</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# /etc/init.d/mysqld restart</span><br><span class="line">Shutting down MySQL (Percona Server)..                     [确定]</span><br><span class="line">Starting MySQL (Percona Server)..                          [确定]</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]# mysql -uroot -p123456 test11 -e &quot;select * from t11&quot;</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">+----+-------+</span><br><span class="line">| id | name  |</span><br><span class="line">+----+-------+</span><br><span class="line">|  1 | aaa11 |</span><br><span class="line">|  2 | bbb22 |</span><br><span class="line">|  3 | ccc33 |</span><br><span class="line">|  4 | ddd44 |</span><br><span class="line">+----+-------+</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona]#</span><br></pre></td></tr></table></figure>
<h2 id="误删除frm文件"><a href="#误删除frm文件" class="headerlink" title="误删除frm文件"></a>误删除frm文件</h2><h2 id="误执行drop操作"><a href="#误执行drop操作" class="headerlink" title="误执行drop操作"></a>误执行drop操作</h2><p>参考 ：<br><a href="http://dbaplus.cn/news-11-1199-1.html" target="_blank" rel="noopener">http://dbaplus.cn/news-11-1199-1.html</a><br><a href="http://cenalulu.github.io/mysql/innodb-single-tablespace-recovery/" target="_blank" rel="noopener">http://cenalulu.github.io/mysql/innodb-single-tablespace-recovery/</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jiessie</p>
              <p class="site-description motion-element" itemprop="description">最怕一生碌碌无为,还说平凡难能可贵！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">3</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiessie</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
