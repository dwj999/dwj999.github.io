<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="Jiessie's' Blog" type="application/atom+xml" />






<meta name="description" content="最怕一生碌碌无为,还说平凡难能可贵！">
<meta property="og:type" content="website">
<meta property="og:title" content="Jiessie&#39;s&#39; Blog">
<meta property="og:url" content="https://dwj999.github.io/page/2/index.html">
<meta property="og:site_name" content="Jiessie&#39;s&#39; Blog">
<meta property="og:description" content="最怕一生碌碌无为,还说平凡难能可贵！">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Jiessie&#39;s&#39; Blog">
<meta name="twitter:description" content="最怕一生碌碌无为,还说平凡难能可贵！">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dwj999.github.io/page/2/"/>





<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

  <title>Jiessie's' Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"><a href="https://github.com/dwj999" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jiessie's' Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">没伞的孩子必须努力奔跑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/AWS-EC2搭建MHA-VIP-MySQL5-7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/AWS-EC2搭建MHA-VIP-MySQL5-7.html" itemprop="url">AWS EC2搭建MHA+VIP+MySQL5.7</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-24T16:51:22+08:00">
                2017-07-24
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/集群高可用/" itemprop="url" rel="index">
                    <span itemprop="name">集群高可用</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>随着云服务的迅速发展，越来越多企业选择将服务托管在云服务中，在数据库领域，AWS RDS、Aliyun RDS等都是不错的选择，默认已经做了高可用，基础运维，可以为企业节省不少的运维成本。由于RDS物理数据、Root权限等其他对象对用户不开放，难免在自动化运维中有些壁垒。本文将围绕在AWS EC2结合MHA做MySQL的高可用，EC2不支持VIP，可通过绑定私有IP的方式来实现。</p>
<h2 id="MHA简介"><a href="#MHA简介" class="headerlink" title="MHA简介"></a>MHA简介</h2><p>MHA是由日本MySQL专家youshimaton(现就职于Facebook公司)用Perl写的一套MySQL故障切换方案，以保障数据库的高可用性。在MySQL故障切换过程中，MHA能做到在0~30s之内实现主MySQL故障转移。<br>该软件由两部分组成：MHA Manager（管理节点）和MHA Node（数据节点）。MHA Manager可以单独部署在一台独立的机器上管理多个master-slave集群，也可以部署在一台slave节点上。MHA Node运行在每台MySQL服务器上，MHA Manager会定时探测集群中的master节点，当master出现故障时，它可以自动将最新数据的slave提升为新的master，然后将所有其他的slave重新指向新的master。整个故障转移过程对应用程序完全透明。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：Amazon Linux<br>master:172.31.13.126<br>slave:172.31.9.182<br>vip:172.31.0.200<br>其中，使用两台机器，分别部署主库和从库，MHA默认部署在从库上，下方中的VIP通指私有IP。  </p>
<h2 id="系统初始化修改"><a href="#系统初始化修改" class="headerlink" title="系统初始化修改"></a>系统初始化修改</h2><h3 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h3><h4 id="主库修改主机名"><a href="#主库修改主机名" class="headerlink" title="主库修改主机名"></a>主库修改主机名</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# cat /etc/sysconfig/network</span><br><span class="line"><span class="attribute">NETWORKING</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">HOSTNAME</span>=master</span><br></pre></td></tr></table></figure>
<h4 id="从库修改主机名"><a href="#从库修改主机名" class="headerlink" title="从库修改主机名"></a>从库修改主机名</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/sysconfig/network</span><br><span class="line"><span class="attribute">NETWORKING</span>=<span class="literal">yes</span></span><br><span class="line"><span class="attribute">HOSTNAME</span>=slave</span><br></pre></td></tr></table></figure>
<h3 id="修改时区"><a href="#修改时区" class="headerlink" title="修改时区"></a>修改时区</h3><p>Amazon Linux默认安装好后英国时间，需要在主库和从库修改时区<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# ln</span> -sf /usr/share/zone<span class="literal">inf</span>o/Asia/Shanghai /etc/localtime</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# /usr</span>/sbin/ntpdate <span class="number">0</span>.centos.pool.ntp.org &amp;&amp; /sbin/hwclock -w &amp;&gt;/dev/null</span><br></pre></td></tr></table></figure></p>
<h3 id="设置防火墙"><a href="#设置防火墙" class="headerlink" title="设置防火墙"></a>设置防火墙</h3><h4 id="主库设置，允许从库访问"><a href="#主库设置，允许从库访问" class="headerlink" title="主库设置，允许从库访问"></a>主库设置，允许从库访问</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# /etc/init.d/iptables status|grep <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span></span><br><span class="line"><span class="number">15</span>   ACCEPT     all  --  <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span>         <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>           </span><br><span class="line">[root@master ~]#</span><br></pre></td></tr></table></figure>
<p>其中，172.31.9.182是允许从库的访问规则</p>
<h4 id="从库设置，允许主库访问"><a href="#从库设置，允许主库访问" class="headerlink" title="从库设置，允许主库访问"></a>从库设置，允许主库访问</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# /etc/init.d/iptables status|grep <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span> </span><br><span class="line"><span class="number">15</span>   ACCEPT     all  --  <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span>        <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span>           </span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure>
<p>其中，172.31.13.126是允许主库的访问规则</p>
<h3 id="关闭SELINUX"><a href="#关闭SELINUX" class="headerlink" title="关闭SELINUX"></a>关闭SELINUX</h3><p>由于使用的操作系统为Amazon Linux，通过查看无selinux设置。</p>
<h2 id="建立SSH无密码登录"><a href="#建立SSH无密码登录" class="headerlink" title="建立SSH无密码登录"></a>建立SSH无密码登录</h2><h3 id="主库设置"><a href="#主库设置" class="headerlink" title="主库设置"></a>主库设置</h3><p>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no。<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# sed</span> '/^<span class="comment">#/d;/^$/d' /etc/ssh/ssh_config |grep GSSAPIAuthentication</span></span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# sed</span> '/^<span class="comment">#/d;/^$/d' /etc/ssh/sshd_config |grep -E 'PasswordAuthentication|PermitRootLogin'</span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PermitRootLogin forced-commands-only</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# /etc</span>/init.d/sshd restart</span><br><span class="line">停止 sshd：                                                [确定]</span><br><span class="line">正在启动 sshd：                                            [确定]</span><br></pre></td></tr></table></figure></p>
<p>使用命令ssh-keygen生成公钥，发送到从库，同时尝试在主库无密码形式登录从库，而且也要保证本机无密码登录本机<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">43:a3:80:f1:8c:d4:5e:8d:3c:99:e5:39:39:e3:89:9a root<span class="meta">@master</span></span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|<span class="string">  o. . *.        </span>|</span><br><span class="line">|<span class="string"> . *. B..o       </span>|</span><br><span class="line">|<span class="string">  o.+. .X        </span>|</span><br><span class="line">|<span class="string">    .. = *       </span>|</span><br><span class="line">|<span class="string">      o S        </span>|</span><br><span class="line">|<span class="string">     o   .       </span>|</span><br><span class="line">|<span class="string">    E            </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">+-----------------+</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.9.182</span></span><br><span class="line">The authenticity of host '172.31.9.182 (172.31.9.182)' can't be established.</span><br><span class="line">ECDSA key fingerprint is 72:71:66:dc:6c:b0:31:e7:6c:77:4c:8d:32:69:e0:88.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.9.182's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.9.182'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.13.126</span></span><br><span class="line">The authenticity of host '172.31.13.126 (172.31.13.126)' can't be established.</span><br><span class="line">ECDSA key fingerprint is b6:ef:9f:f0:5e:fd:8f:49:ef:be:79:fb:44:ea:63:08.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.13.126's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.13.126'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh 'root@172.31.9.182'</span></span><br><span class="line">Last login: Thu Jul 20 04:51:07 2017</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.9.182 closed.</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># ssh 'root@172.31.13.126'</span></span><br><span class="line">Last login: Thu Jul 20 04:37:13 2017</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br></pre></td></tr></table></figure></p>
<h3 id="从库设置"><a href="#从库设置" class="headerlink" title="从库设置"></a>从库设置</h3><p>和主库的配置相同<br>修改服务器/etc/ssh/ssh_config文件，把参数GSSAPIAuthentication修改为no。<br>修改服务器/etc/ssh/sshd_config文件，把参数PasswordAuthentication修改为yes,参数PermitRootLogin修改为yes,重启ssh服务<br>修改服务器/etc/hosts.allow文件，允许从库连接<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># sed <span class="string">'/^#/d;/^$/d'</span> /etc/ssh/ssh_config |grep GSSAPIAuthentication</span></span><br><span class="line">        GSSAPIAuthentication no</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># sed <span class="string">'/^#/d;/^$/d'</span> /etc/ssh/sshd_config |grep -E <span class="string">'PasswordAuthentication|PermitRootLogin'</span></span></span><br><span class="line">PermitRootLogin yes</span><br><span class="line">PermitRootLogin forced-commands-only</span><br><span class="line">PasswordAuthentication yes</span><br><span class="line">[root<span class="symbol">@slave</span> ~]<span class="meta"># /etc/init.d/sshd restart</span></span><br><span class="line">停止 sshd：                                                [确定]</span><br><span class="line">正在启动 sshd：                                            [确定]</span><br></pre></td></tr></table></figure></p>
<p>使用命令ssh-keygen生成公钥，发送到主库，同时尝试在从库无密码形式登录主库，而且也要保证本机无密码登录本机<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">7d:57:15:e0:20:6f:6f:45:00:76:c4:ba:66:32:fd:b3 root<span class="meta">@slave</span></span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|<span class="string">         . ++=ooo</span>|</span><br><span class="line">|<span class="string">          + +.. .</span>|</span><br><span class="line">|<span class="string">           o.. ..</span>|</span><br><span class="line">|<span class="string">         .... .. </span>|</span><br><span class="line">|<span class="string">        S o oo.  </span>|</span><br><span class="line">|<span class="string">         o *..   </span>|</span><br><span class="line">|<span class="string">          = .    </span>|</span><br><span class="line">|<span class="string">             o   </span>|</span><br><span class="line">|<span class="string">             Eo  </span>|</span><br><span class="line">+-----------------+</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-keygen</span></span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file in which to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty for no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved in /root/.ssh/id_rsa.</span><br><span class="line">Your public key has been saved in /root/.ssh/id_rsa.pub.</span><br><span class="line">The key fingerprint is:</span><br><span class="line">da:ea:e3:1c:fb:4b:f5:84:da:a3:47:ea:2c:fa:3c:a6 root<span class="meta">@slave</span></span><br><span class="line">The key's randomart image is:</span><br><span class="line">+--[ RSA 2048]----+</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">                 </span>|</span><br><span class="line">|<span class="string">           .     </span>|</span><br><span class="line">|<span class="string">        S o .    </span>|</span><br><span class="line">|<span class="string">       o +.o     </span>|</span><br><span class="line">|<span class="string">      o +oo .    </span>|</span><br><span class="line">|<span class="string">     o=*....     </span>|</span><br><span class="line">|<span class="string">    EBO**o       </span>|</span><br><span class="line">+-----------------+</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.13.126</span></span><br><span class="line">The authenticity of host '172.31.13.126 (172.31.13.126)' can't be established.</span><br><span class="line">ECDSA key fingerprint is b6:ef:9f:f0:5e:fd:8f:49:ef:be:79:fb:44:ea:63:08.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.13.126's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.13.126'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh-copy-id -i ~/.ssh/id_rsa.pub root@172.31.9.182</span></span><br><span class="line">The authenticity of host '172.31.9.182 (172.31.9.182)' can't be established.</span><br><span class="line">ECDSA key fingerprint is 72:71:66:dc:6c:b0:31:e7:6c:77:4c:8d:32:69:e0:88.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">root<span class="meta">@172.31.9.182's</span> password: </span><br><span class="line"></span><br><span class="line">Number of key(s) added: 1</span><br><span class="line"></span><br><span class="line">Now try logging into the machine, with:   <span class="string">"ssh 'root@172.31.9.182'"</span></span><br><span class="line">and check to make sure that only the key(s) you wanted were added.</span><br><span class="line"></span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh 'root@172.31.13.126'</span></span><br><span class="line">Last login: Thu Jul 20 05:36:57 2017 from 172.31.13.126</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@master</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># ssh 'root@172.31.9.182' </span></span><br><span class="line">Last login: Thu Jul 20 05:36:46 2017 from 172.31.13.126</span><br><span class="line"></span><br><span class="line">       __|<span class="string">  __</span>|<span class="string">_  )</span></span><br><span class="line"><span class="string">       _</span>|<span class="string">  (     /   Amazon Linux AMI</span></span><br><span class="line"><span class="string">      ___</span>|<span class="string">\___</span>|<span class="string">___</span>|</span><br><span class="line"></span><br><span class="line">https://aws.amazon.com/amazon-linux-ami/2017.03-release-notes/</span><br><span class="line">[root<span class="meta">@slave</span> ~]<span class="comment"># exit</span></span><br><span class="line">logout</span><br><span class="line">Connection to 172.31.9.182 closed.</span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL安装"><a href="#MySQL安装" class="headerlink" title="MySQL安装"></a>MySQL安装</h2><p>使用的是自己打包的RPM包，分别登录主库和从库，直接rpm -ivh percona-server-5.7.18-15.x86_64.rpm 即可，也可使用其他方式安装MySQL<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mv /home/zhouting/percona-server-5.7.18-15.x86_64.rpm  /usr/src/</span><br><span class="line">[root@master ~]# rpm -ivh /usr/src/percona-server-5.7.18-15.x86_64.rpm </span><br><span class="line">Preparing<span class="built_in">..</span>.                          ################################# [100%]</span><br><span class="line">Updating / installing<span class="built_in">..</span>.</span><br><span class="line">   1:percona-server-5.7.18-15         ################################# [100%]</span><br><span class="line"><span class="builtin-name">error</span> reading information on<span class="built_in"> service </span>/etc/rc.d/init.d/mysqld: <span class="literal">No</span> such file <span class="keyword">or</span> directory</span><br><span class="line"> ERROR! MySQL (Percona Server) PID file could <span class="keyword">not</span> be found!</span><br><span class="line">Starting MySQL (Percona Server)<span class="built_in">..</span> SUCCESS! </span><br><span class="line">mysqladmin: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">Warning: Since password will be sent <span class="keyword">to</span><span class="built_in"> server </span><span class="keyword">in</span> plain text, use ssl<span class="built_in"> connection </span><span class="keyword">to</span> ensure password safety.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br><span class="line">mysql: [<span class="builtin-name">Warning</span>] Using a password on the command line<span class="built_in"> interface </span>can be insecure.</span><br></pre></td></tr></table></figure></p>
<p>查看是否安装成功，分别登录主库和从库查看<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">11</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">16</span>:<span class="number">57</span>:<span class="number">43</span> &gt; select <span class="built_in">version</span>();</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| <span class="built_in">version</span>()     |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line">| <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> |</span><br><span class="line">+<span class="comment">---------------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">16</span>:<span class="number">57</span>:<span class="number">47</span> &gt;</span><br></pre></td></tr></table></figure></p>
<h2 id="MySQL互为主备"><a href="#MySQL互为主备" class="headerlink" title="MySQL互为主备"></a>MySQL互为主备</h2><h3 id="重要参数配置"><a href="#重要参数配置" class="headerlink" title="重要参数配置"></a>重要参数配置</h3><p>主库必须包含以下参数<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># cat /etc/my.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">server-id = 1</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 1</span><br><span class="line">auto_increment_offset = 2</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br></pre></td></tr></table></figure></p>
<p>从库必须包含以下参数，注意slave需要动态设置read_only=1，<br><figure class="highlight asciidoc"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# cat /etc/my.cnf </span><br><span class="line"><span class="meta">[mysqld]</span></span><br><span class="line">server-id = 2</span><br><span class="line">autocommit = 1</span><br><span class="line">auto<span class="emphasis">_increment_</span>increment = 2</span><br><span class="line">auto<span class="emphasis">_increment_</span>offset = 2</span><br><span class="line">log<span class="emphasis">_bin = mysql-bin</span></span><br><span class="line"><span class="emphasis">gtid_</span>mode = on</span><br><span class="line">enforce<span class="emphasis">_gtid_</span>consistency = 1</span><br><span class="line">log<span class="emphasis">_slave_</span>updates</span><br><span class="line">relay<span class="emphasis">_log_</span>purge=0</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e "show variables like <span class="emphasis">'read_only'</span>"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| read_</span>only     | OFF   |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@slave ~]# mysql -uroot -p -e "set global read<span class="emphasis">_only=1"</span></span><br><span class="line"><span class="emphasis">Enter password: </span></span><br><span class="line"><span class="emphasis">[root@slave ~]# mysql -uroot -p -e "show variables like 'read_</span>only'"</span><br><span class="line">Enter password: </span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">| Variable<span class="emphasis">_name | Value |</span></span><br><span class="line"><span class="emphasis">+---------------+-------+</span></span><br><span class="line"><span class="emphasis">| read_</span>only     | ON    |</span><br><span class="line"><span class="code">+---------------+</span>-------+</span><br><span class="line">[root@slave ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="复制帐号建立"><a href="#复制帐号建立" class="headerlink" title="复制帐号建立"></a>复制帐号建立</h3><p>由于MySQL版本使用的是5.7，创建用户的方法以之前有些不同  </p>
<h4 id="主库创建"><a href="#主库创建" class="headerlink" title="主库创建"></a>主库创建</h4><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">6</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">16</span>:<span class="number">52</span> &gt; <span class="keyword">create</span> user <span class="string">'slave01'</span>@<span class="string">'172.31.9.182'</span> identified <span class="keyword">by</span> <span class="string">'slave123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">17</span>:<span class="number">21</span> &gt; grant replication slave,replication client <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'172.31.9.182'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">17</span>:<span class="number">34</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">17</span>:<span class="number">38</span> &gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>
<h4 id="从库创建"><a href="#从库创建" class="headerlink" title="从库创建"></a>从库创建</h4><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">6</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">19</span>:<span class="number">24</span> &gt; <span class="keyword">create</span> user <span class="string">'slave01'</span>@<span class="string">'172.31.13.126'</span> identified <span class="keyword">by</span> <span class="string">'slave123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">19</span>:<span class="number">49</span> &gt; grant replication slave,replication client <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'slave01'</span>@<span class="string">'172.31.13.126'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">20</span>:<span class="number">02</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">20</span>:<span class="number">05</span> &gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure>
<h4 id="复制帐号验证"><a href="#复制帐号验证" class="headerlink" title="复制帐号验证"></a>复制帐号验证</h4><p>主库登录从库<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -h172.31.9.182 -uslave01 -pslave123456</span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQ<span class="class">L monitor.  Commands end with ;</span><span class="built_in"> or </span>\g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC<span class="built_in"> and/or </span>its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle<span class="built_in"> and/or </span>its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation<span class="built_in"> and/or </span>its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;'<span class="built_in"> or </span>'\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:22:15 &gt; exit</span><br></pre></td></tr></table></figure></p>
<p>从库登录主库<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -h172.31.13.126 -uslave01 -pslave123456             </span></span><br><span class="line">mysql: [Warning] Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQ<span class="class">L monitor.  Commands end with ;</span><span class="built_in"> or </span>\g.</span><br><span class="line">Your MySQL connection id is 7</span><br><span class="line">Server version: 5.7.18-15-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC<span class="built_in"> and/or </span>its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle<span class="built_in"> and/or </span>its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation<span class="built_in"> and/or </span>its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;'<span class="built_in"> or </span>'\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 17:22:57 &gt; exit</span><br></pre></td></tr></table></figure></p>
<h3 id="复制关系配置"><a href="#复制关系配置" class="headerlink" title="复制关系配置"></a>复制关系配置</h3><h4 id="主库配置"><a href="#主库配置" class="headerlink" title="主库配置"></a>主库配置</h4><p>登录主库，设置复制关系，来源于从库的复制<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-p</span></span><br><span class="line"><span class="string">Enter</span> <span class="attr">password:</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">the</span> <span class="string">MySQL</span> <span class="string">monitor.</span>  <span class="string">Commands</span> <span class="string">end</span> <span class="string">with</span> <span class="string">;</span> <span class="string">or</span> <span class="string">\g.</span></span><br><span class="line"><span class="string">Your</span> <span class="string">MySQL</span> <span class="string">connection</span> <span class="string">id</span> <span class="string">is</span> <span class="number">17</span></span><br><span class="line"><span class="string">Server</span> <span class="attr">version:</span> <span class="number">5.7</span><span class="number">.18</span><span class="bullet">-15</span><span class="bullet">-log</span> <span class="string">PLD/Linux</span> <span class="string">Distribution</span> <span class="string">Percona</span> <span class="string">Server</span> <span class="string">RPM</span></span><br><span class="line"></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2009</span><span class="bullet">-2017</span> <span class="string">Percona</span> <span class="string">LLC</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2000</span><span class="string">,</span> <span class="number">2017</span><span class="string">,</span> <span class="string">Oracle</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates.</span> <span class="string">All</span> <span class="string">rights</span> <span class="string">reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Oracle</span> <span class="string">is</span> <span class="string">a</span> <span class="string">registered</span> <span class="string">trademark</span> <span class="string">of</span> <span class="string">Oracle</span> <span class="string">Corporation</span> <span class="string">and/or</span> <span class="string">its</span></span><br><span class="line"><span class="string">affiliates.</span> <span class="string">Other</span> <span class="string">names</span> <span class="string">may</span> <span class="string">be</span> <span class="string">trademarks</span> <span class="string">of</span> <span class="string">their</span> <span class="string">respective</span></span><br><span class="line"><span class="string">owners.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Type</span> <span class="string">'help;'</span> <span class="string">or</span> <span class="string">'\h'</span> <span class="string">for</span> <span class="string">help.</span> <span class="string">Type</span> <span class="string">'\c'</span> <span class="string">to</span> <span class="string">clear</span> <span class="string">the</span> <span class="string">current</span> <span class="string">input</span> <span class="string">statement.</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:32:19</span> <span class="string">&gt; change master to master_host='172.31.9.182',master_user='slave01',master_password='slave123456',master_auto_position=1;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected, 2 warnings (0.04 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:33:03 &gt; start slave;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:33:47 &gt; show slave status\G;</span></span><br><span class="line"><span class="string">*************************** 1. row ***************************</span></span><br><span class="line"><span class="string"></span><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">slave01</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">mysql-bin.000003</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">810</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">master-relay-bin.000002</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">1023</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">mysql-bin.000003</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">810</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">1231</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">2</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="string">a1c1d189-6b96-11e7-9825-02a13635a5ca</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">mysql.slave_master_info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">more</span> <span class="string">updates</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="attr">a1c1d189-6b96-11e7-9825-02a13635a5ca:1-3</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="number">9</span><span class="attr">a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17,</span></span><br><span class="line"><span class="attr">a1c1d189-6b96-11e7-9825-02a13635a5ca:</span><span class="number">1</span><span class="bullet">-3</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </span><br><span class="line"><span class="attr">                 Channel_Name:</span> </span><br><span class="line"><span class="attr">           Master_TLS_Version:</span> </span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ERROR:</span> </span><br><span class="line"><span class="literal">No</span> <span class="string">query</span> <span class="string">specified</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:33:54</span> <span class="string">&gt;</span></span><br></pre></td></tr></table></figure></p>
<h4 id="从库配置"><a href="#从库配置" class="headerlink" title="从库配置"></a>从库配置</h4><p>登录从库，设置复制关系，来源于主库的复制<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@slave</span> <span class="string">~]#</span> <span class="string">mysql</span> <span class="bullet">-uroot</span> <span class="bullet">-p</span></span><br><span class="line"><span class="string">Enter</span> <span class="attr">password:</span> </span><br><span class="line"><span class="string">Welcome</span> <span class="string">to</span> <span class="string">the</span> <span class="string">MySQL</span> <span class="string">monitor.</span>  <span class="string">Commands</span> <span class="string">end</span> <span class="string">with</span> <span class="string">;</span> <span class="string">or</span> <span class="string">\g.</span></span><br><span class="line"><span class="string">Your</span> <span class="string">MySQL</span> <span class="string">connection</span> <span class="string">id</span> <span class="string">is</span> <span class="number">10</span></span><br><span class="line"><span class="string">Server</span> <span class="attr">version:</span> <span class="number">5.7</span><span class="number">.18</span><span class="bullet">-15</span><span class="bullet">-log</span> <span class="string">PLD/Linux</span> <span class="string">Distribution</span> <span class="string">Percona</span> <span class="string">Server</span> <span class="string">RPM</span></span><br><span class="line"></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2009</span><span class="bullet">-2017</span> <span class="string">Percona</span> <span class="string">LLC</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates</span></span><br><span class="line"><span class="string">Copyright</span> <span class="string">(c)</span> <span class="number">2000</span><span class="string">,</span> <span class="number">2017</span><span class="string">,</span> <span class="string">Oracle</span> <span class="string">and/or</span> <span class="string">its</span> <span class="string">affiliates.</span> <span class="string">All</span> <span class="string">rights</span> <span class="string">reserved.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Oracle</span> <span class="string">is</span> <span class="string">a</span> <span class="string">registered</span> <span class="string">trademark</span> <span class="string">of</span> <span class="string">Oracle</span> <span class="string">Corporation</span> <span class="string">and/or</span> <span class="string">its</span></span><br><span class="line"><span class="string">affiliates.</span> <span class="string">Other</span> <span class="string">names</span> <span class="string">may</span> <span class="string">be</span> <span class="string">trademarks</span> <span class="string">of</span> <span class="string">their</span> <span class="string">respective</span></span><br><span class="line"><span class="string">owners.</span></span><br><span class="line"></span><br><span class="line"><span class="string">Type</span> <span class="string">'help;'</span> <span class="string">or</span> <span class="string">'\h'</span> <span class="string">for</span> <span class="string">help.</span> <span class="string">Type</span> <span class="string">'\c'</span> <span class="string">to</span> <span class="string">clear</span> <span class="string">the</span> <span class="string">current</span> <span class="string">input</span> <span class="string">statement.</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:34:41</span> <span class="string">&gt; change master to master_host='172.31.13.126',master_user='slave01',master_password='slave123456',master_auto_position=1;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected, 2 warnings (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:35:14 &gt; start slave;</span></span><br><span class="line"><span class="string">Query OK, 0 rows affected (0.03 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">MySQL [(none)] 17:35:15 &gt; show slave status\G;</span></span><br><span class="line"><span class="string">*************************** 1. row ***************************</span></span><br><span class="line"><span class="string"></span><span class="attr">               Slave_IO_State:</span> <span class="string">Waiting</span> <span class="string">for</span> <span class="string">master</span> <span class="string">to</span> <span class="string">send</span> <span class="string">event</span></span><br><span class="line"><span class="attr">                  Master_Host:</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.139</span></span><br><span class="line"><span class="attr">                  Master_User:</span> <span class="string">slave01</span></span><br><span class="line"><span class="attr">                  Master_Port:</span> <span class="number">3306</span></span><br><span class="line"><span class="attr">                Connect_Retry:</span> <span class="number">60</span></span><br><span class="line"><span class="attr">              Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">          Read_Master_Log_Pos:</span> <span class="number">4455</span></span><br><span class="line"><span class="attr">               Relay_Log_File:</span> <span class="string">slave-relay-bin.000002</span></span><br><span class="line"><span class="attr">                Relay_Log_Pos:</span> <span class="number">4059</span></span><br><span class="line"><span class="attr">        Relay_Master_Log_File:</span> <span class="string">mysql-bin.000002</span></span><br><span class="line"><span class="attr">             Slave_IO_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">            Slave_SQL_Running:</span> <span class="literal">Yes</span></span><br><span class="line"><span class="attr">              Replicate_Do_DB:</span> </span><br><span class="line"><span class="attr">          Replicate_Ignore_DB:</span> </span><br><span class="line"><span class="attr">           Replicate_Do_Table:</span> </span><br><span class="line"><span class="attr">       Replicate_Ignore_Table:</span> </span><br><span class="line"><span class="attr">      Replicate_Wild_Do_Table:</span> </span><br><span class="line"><span class="attr">  Replicate_Wild_Ignore_Table:</span> </span><br><span class="line"><span class="attr">                   Last_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                   Last_Error:</span> </span><br><span class="line"><span class="attr">                 Skip_Counter:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          Exec_Master_Log_Pos:</span> <span class="number">4455</span></span><br><span class="line"><span class="attr">              Relay_Log_Space:</span> <span class="number">4266</span></span><br><span class="line"><span class="attr">              Until_Condition:</span> <span class="string">None</span></span><br><span class="line"><span class="attr">               Until_Log_File:</span> </span><br><span class="line"><span class="attr">                Until_Log_Pos:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">           Master_SSL_Allowed:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">           Master_SSL_CA_File:</span> </span><br><span class="line"><span class="attr">           Master_SSL_CA_Path:</span> </span><br><span class="line"><span class="attr">              Master_SSL_Cert:</span> </span><br><span class="line"><span class="attr">            Master_SSL_Cipher:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Key:</span> </span><br><span class="line"><span class="attr">        Seconds_Behind_Master:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">Master_SSL_Verify_Server_Cert:</span> <span class="literal">No</span></span><br><span class="line"><span class="attr">                Last_IO_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">                Last_IO_Error:</span> </span><br><span class="line"><span class="attr">               Last_SQL_Errno:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">               Last_SQL_Error:</span> </span><br><span class="line"><span class="attr">  Replicate_Ignore_Server_Ids:</span> </span><br><span class="line"><span class="attr">             Master_Server_Id:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">                  Master_UUID:</span> <span class="number">9</span><span class="string">a7b78fc-6b96-11e7-9856-0232d9c5deea</span></span><br><span class="line"><span class="attr">             Master_Info_File:</span> <span class="string">mysql.slave_master_info</span></span><br><span class="line"><span class="attr">                    SQL_Delay:</span> <span class="number">0</span></span><br><span class="line"><span class="attr">          SQL_Remaining_Delay:</span> <span class="literal">NULL</span></span><br><span class="line"><span class="attr">      Slave_SQL_Running_State:</span> <span class="string">Slave</span> <span class="string">has</span> <span class="string">read</span> <span class="string">all</span> <span class="string">relay</span> <span class="string">log;</span> <span class="string">waiting</span> <span class="string">for</span> <span class="string">more</span> <span class="string">updates</span></span><br><span class="line"><span class="attr">           Master_Retry_Count:</span> <span class="number">86400</span></span><br><span class="line"><span class="attr">                  Master_Bind:</span> </span><br><span class="line"><span class="attr">      Last_IO_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">     Last_SQL_Error_Timestamp:</span> </span><br><span class="line"><span class="attr">               Master_SSL_Crl:</span> </span><br><span class="line"><span class="attr">           Master_SSL_Crlpath:</span> </span><br><span class="line"><span class="attr">           Retrieved_Gtid_Set:</span> <span class="number">9</span><span class="attr">a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17</span></span><br><span class="line"><span class="attr">            Executed_Gtid_Set:</span> <span class="number">9</span><span class="attr">a7b78fc-6b96-11e7-9856-0232d9c5deea:1-17,</span></span><br><span class="line"><span class="attr">a1c1d189-6b96-11e7-9825-02a13635a5ca:</span><span class="number">1</span><span class="bullet">-3</span></span><br><span class="line"><span class="attr">                Auto_Position:</span> <span class="number">1</span></span><br><span class="line"><span class="attr">         Replicate_Rewrite_DB:</span> </span><br><span class="line"><span class="attr">                 Channel_Name:</span> </span><br><span class="line"><span class="attr">           Master_TLS_Version:</span> </span><br><span class="line"><span class="number">1</span> <span class="string">row</span> <span class="string">in</span> <span class="string">set</span> <span class="string">(0.00</span> <span class="string">sec)</span></span><br><span class="line"></span><br><span class="line"><span class="attr">ERROR:</span> </span><br><span class="line"><span class="literal">No</span> <span class="string">query</span> <span class="string">specified</span></span><br><span class="line"></span><br><span class="line"><span class="string">MySQL</span> <span class="string">[(none)]</span> <span class="number">17</span><span class="string">:35:18</span> <span class="string">&gt;</span></span><br></pre></td></tr></table></figure></p>
<h3 id="复制测试"><a href="#复制测试" class="headerlink" title="复制测试"></a>复制测试</h3><h4 id="主库登录测试"><a href="#主库登录测试" class="headerlink" title="主库登录测试"></a>主库登录测试</h4><p>登录主库，插入测试数据<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">37</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">35</span>:<span class="number">48</span> &gt; create database <span class="keyword">if</span> <span class="keyword">not</span> exists test11;use test11;                                                           </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">35</span>:<span class="number">52</span> &gt; create table <span class="keyword">if</span> <span class="keyword">not</span> exists t11(<span class="built_in">id</span> int unsigned <span class="keyword">not</span> null auto_increment,<span class="built_in">name</span> varchar(<span class="number">20</span>),primary key(`<span class="built_in">id</span>`));</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">35</span>:<span class="number">55</span> &gt; insert <span class="keyword">into</span> t11 values(null,'master11');</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">35</span>:<span class="number">58</span> &gt; select * <span class="keyword">from</span> t11;</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>     |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">|  <span class="number">1</span> | master11 |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">36</span>:<span class="number">02</span> &gt;</span><br></pre></td></tr></table></figure></p>
<p>登录从库，查看测试数据，此时数据已经复制过来<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -uroot -p </span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">29</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">36</span>:<span class="number">25</span> &gt; select * <span class="keyword">from</span> test11.t11;</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>     |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line">|  <span class="number">1</span> | master11 |</span><br><span class="line">+<span class="comment">----+----------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">36</span>:<span class="number">30</span> &gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="从库登录测试"><a href="#从库登录测试" class="headerlink" title="从库登录测试"></a>从库登录测试</h4><p>登录从库，插入测试数据<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mysql -uroot -p </span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">32</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">37</span>:<span class="number">59</span> &gt; create database <span class="keyword">if</span> <span class="keyword">not</span> exists test11;use test11;</span><br><span class="line">Query OK, <span class="number">1</span> row affected, <span class="number">1</span> warning (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">03</span> &gt; create table <span class="keyword">if</span> <span class="keyword">not</span> exists t22(<span class="built_in">id</span> int unsigned <span class="keyword">not</span> null auto_increment,<span class="built_in">name</span> varchar(<span class="number">20</span>),primary key(`<span class="built_in">id</span>`));     </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.03</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">18</span> &gt; insert <span class="keyword">into</span> t22 values(null,'slave11'); </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">30</span> &gt; select * <span class="keyword">from</span> t22;</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>    |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">|  <span class="number">2</span> | slave11 |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test11] <span class="number">17</span>:<span class="number">38</span>:<span class="number">35</span> &gt;</span><br></pre></td></tr></table></figure></p>
<p>登录主库，查看测试数据，此时数据已经复制过来<br><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]<span class="comment"># mysql -uroot -p</span></span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">38</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.7</span><span class="number">.18</span><span class="number">-15</span>-<span class="built_in">log</span> PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">39</span>:<span class="number">09</span> &gt; select * <span class="keyword">from</span> test11.t22;</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">| <span class="built_in">id</span> | <span class="built_in">name</span>    |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line">|  <span class="number">2</span> | slave11 |</span><br><span class="line">+<span class="comment">----+---------+</span></span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">17</span>:<span class="number">39</span>:<span class="number">15</span> &gt;</span><br></pre></td></tr></table></figure></p>
<h3 id="MHA帐号建立"><a href="#MHA帐号建立" class="headerlink" title="MHA帐号建立"></a>MHA帐号建立</h3><h4 id="主库创建-1"><a href="#主库创建-1" class="headerlink" title="主库创建"></a>主库创建</h4><p>登录主库，创建允许主库和从库连接的MHA用户信息，再分别尝试使用MHA用户登录(省略)<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@master ~]# mysql -uroot -p</span><br><span class="line">Enter password: </span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">41</span></span><br><span class="line">Server version: <span class="number">5.7</span>.<span class="number">18</span>-<span class="number">15</span>-log PLD/Linux Distribution Percona Server RPM</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">36</span>:<span class="number">55</span> &gt; <span class="keyword">create</span> user <span class="string">'mha01'</span>@<span class="string">'172.31.9.182'</span> identified <span class="keyword">by</span> <span class="string">'mha123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">37</span>:<span class="number">14</span> &gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha01'</span>@<span class="string">'172.31.9.182'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">38</span>:<span class="number">02</span> &gt; <span class="keyword">create</span> user <span class="string">'mha01'</span>@<span class="string">'172.31.13.126'</span> identified <span class="keyword">by</span> <span class="string">'mha123456'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">38</span>:<span class="number">14</span> &gt; grant all privileges <span class="keyword">on</span> *.* <span class="keyword">to</span> <span class="string">'mha01'</span>@<span class="string">'172.31.13.126'</span>;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">38</span>:<span class="number">18</span> &gt; flush privileges;</span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<h4 id="从库创建-1"><a href="#从库创建-1" class="headerlink" title="从库创建"></a>从库创建</h4><p>登录从库，由于复制已经把在主库创建的MHA用户信息复制了过来，尝试登录即可(省略)</p>
<h2 id="MHA安装"><a href="#MHA安装" class="headerlink" title="MHA安装"></a>MHA安装</h2><h3 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h3><p>分别在主库和从库上安装，执行命令：<br>yum -y install gcc gcc-c++ make openssl-devel perl perl-DBD-MySQL perl-Config-Tiny perl-Log-Dispatch perl-Parallel-ForkManager perl-Config-IniFiles perl-Time-HiRes perl-Module-Install.noarch mailx jwhois</p>
<h3 id="主库安装mha4mysql-node"><a href="#主库安装mha4mysql-node" class="headerlink" title="主库安装mha4mysql-node"></a>主库安装mha4mysql-node</h3><p>MHA管理端安装在从库上，主库上只需要mha4mysql-node即可，由于MySQL使用5.7版本，MHA也使用最新的0.57版本，采用编译安装方式。下载地址：<a href="https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw" target="_blank" rel="noopener">https://mega.nz/#F!G4oRjARB!SWzFS59bUv9VrKwdAeIGVw</a><br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@<span class="keyword">master</span> <span class="title">~]# cd</span> /usr/src/</span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">src</span>]<span class="comment"># tar -zxf mha4mysql-node-0.57.tar.gz</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># perl Makefile.PL             #编译过程省略</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># make</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># make install</span></span><br><span class="line">[root@<span class="keyword">master</span> <span class="title">mha4mysql-node-0</span>.<span class="number">57</span>]<span class="comment"># ll /usr/local/bin/ -t        #查看安装，有以下文件则mha4mysql-node安装成功</span></span><br><span class="line">total <span class="number">1760</span></span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root  <span class="number">16381</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">8261</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> purge_relay_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">7525</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> save_binary_logs</span><br><span class="line">-r-xr-xr-x <span class="number">1</span> root root   <span class="number">4807</span> Jul <span class="number">21</span> <span class="number">09</span>:<span class="number">41</span> filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p>
<h3 id="从库安装mha4mysql-manager和mha4mysql-node"><a href="#从库安装mha4mysql-manager和mha4mysql-node" class="headerlink" title="从库安装mha4mysql-manager和mha4mysql-node"></a>从库安装mha4mysql-manager和mha4mysql-node</h3><p>MHA管理端安装在从库，从库需要安装manager端和node端<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># cd /usr/src/</span></span><br><span class="line">[root@slave src]<span class="comment"># tar -zxf mha4mysql-manager-0.57.tar.gz </span></span><br><span class="line">[root@slave src]<span class="comment"># cd mha4mysql-manager-0.57</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># perl Makefile.PL           #编译过程省略</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># make</span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># make install </span></span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># ll /usr/local/bin/ -t      #查看安装，有以下文件则mha4mysql-manager安装成功</span></span><br><span class="line">total 1756</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1779 </span>Jul<span class="number"> 21 </span>09:48 masterha_check_ssh</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 2517 </span>Jul<span class="number"> 21 </span>09:48 masterha_manager</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 2373 </span>Jul<span class="number"> 21 </span>09:48 masterha_master_switch</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 5171 </span>Jul<span class="number"> 21 </span>09:48 masterha_secondary_check</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1995 </span>Jul<span class="number"> 21 </span>09:48 masterha_check_repl</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1865 </span>Jul<span class="number"> 21 </span>09:48 masterha_check_status</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 3201 </span>Jul<span class="number"> 21 </span>09:48 masterha_conf_host</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 2165 </span>Jul<span class="number"> 21 </span>09:48 masterha_master_monitor</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 1739 </span>Jul<span class="number"> 21 </span>09:48 masterha_stop</span><br><span class="line">[root@slave mha4mysql-manager-0.57]<span class="comment"># cd ..</span></span><br><span class="line">[root@slave src]<span class="comment"># tar -zxf mha4mysql-node-0.57.tar.gz </span></span><br><span class="line">[root@slave src]<span class="comment"># cd mha4mysql-node-0.57</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># perl Makefile.PL              #编译过程省略        </span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># make</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># make install</span></span><br><span class="line">[root@slave mha4mysql-node-0.57]<span class="comment"># ll /usr/local/bin/ -t         #查看安装，有以下文件则mha4mysql-node安装成功</span></span><br><span class="line">total 1800</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root <span class="number"> 16381 </span>Jul<span class="number"> 21 </span>09:54 apply_diff_relay_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 8261 </span>Jul<span class="number"> 21 </span>09:54 purge_relay_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 7525 </span>Jul<span class="number"> 21 </span>09:54 save_binary_logs</span><br><span class="line">-r-xr-xr-x<span class="number"> 1 </span>root root  <span class="number"> 4807 </span>Jul<span class="number"> 21 </span>09:54 filter_mysqlbinlog</span><br></pre></td></tr></table></figure></p>
<h2 id="MHA目录结构说明"><a href="#MHA目录结构说明" class="headerlink" title="MHA目录结构说明"></a>MHA目录结构说明</h2><h3 id="MHAManager"><a href="#MHAManager" class="headerlink" title="MHAManager"></a>MHAManager</h3><p>mhamanager工具包主要包括以下工具<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@slave  ~]<span class="comment"># ll /usr/local/bin/</span></span><br><span class="line">总用量 84</span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1995 </span>7月 <span class="number"> 19 </span>11:49 masterha_check_repl         <span class="comment">#检查MySQL复制情况</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1779 </span>7月 <span class="number"> 19 </span>11:49 masterha_check_ssh          <span class="comment">#检查MHA的SSH配置情况</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1865 </span>7月 <span class="number"> 19 </span>11:49 masterha_check_status       <span class="comment">#检测当前MHA运行状态</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 3201 </span>7月 <span class="number"> 19 </span>11:49 masterha_conf_host          <span class="comment">#添加或删除配置的server信息</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2517 </span>7月 <span class="number"> 19 </span>11:49 masterha_manager            <span class="comment">#启动MHA</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2165 </span>7月 <span class="number"> 19 </span>11:49 masterha_master_monitor     <span class="comment">#检测Master是否宕机</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 2373 </span>7月 <span class="number"> 19 </span>11:49 masterha_master_switch      <span class="comment">#控制故障转移，自动或者手动</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 5172 </span>7月 <span class="number"> 19 </span>11:49 masterha_secondary_check    <span class="comment">#通过其他路由检测Master是否真的宕机</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1739 </span>7月 <span class="number"> 19 </span>11:49 masterha_stop               <span class="comment">#停止MHA</span></span><br></pre></td></tr></table></figure></p>
<h3 id="MHANode"><a href="#MHANode" class="headerlink" title="MHANode"></a>MHANode</h3><p>mhanode工具包主要包括以下工具<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master  ~]<span class="comment"># ll /usr/local/bin/</span></span><br><span class="line">总用量 44</span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root<span class="number"> 16371 </span>7月 <span class="number"> 19 </span>11:41 apply_diff_relay_logs       <span class="comment">#识别差异日志的中继日志，并将其差异事件应用于其他Slave</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 4807 </span>7月 <span class="number"> 19 </span>11:41 filter_mysqlbinlog          <span class="comment">#去除不必要的Rollback事件</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 8263 </span>7月 <span class="number"> 19 </span>11:41 purge_relay_logs            <span class="comment">#删除无用的Relay log，避免延时</span></span><br><span class="line">-r-xr-xr-x <span class="number"> 1 </span>root root <span class="number"> 7525 </span>7月 <span class="number"> 19 </span>11:41 save_binary_logs            <span class="comment">#保存和复制down掉的主服务器二进制日志</span></span><br></pre></td></tr></table></figure></p>
<h3 id="自定义扩展脚本说明"><a href="#自定义扩展脚本说明" class="headerlink" title="自定义扩展脚本说明"></a>自定义扩展脚本说明</h3><p>secondary_check_script          #通过多条网络路由检测master的可用性<br>master_ip_failover_script       #自动failover时候的切换脚本，可将vip信息写入此脚本中<br>shutdown_script                 #强制关闭master节点执行脚本<br>report_script                   #发送报告<br>init_conf_load_script           #加载初始配置参数，如不想在配置中写明文密码<br>master_ip_online_change_script  #手动failover时候的切换脚本  </p>
<h2 id="MHA扩展脚本"><a href="#MHA扩展脚本" class="headerlink" title="MHA扩展脚本"></a>MHA扩展脚本</h2><p>由于使用的AWS EC2，不支持VIP，可通过辅助IP的形式实现，这里使用脚本来辅助实现HA。</p>
<h3 id="aws-vip-change-sh"><a href="#aws-vip-change-sh" class="headerlink" title="aws_vip_change.sh"></a>aws_vip_change.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/aws_vip_change.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$#</span> -lt 2 ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Illegal param count.count = <span class="variable">$#</span>"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># High Availability IP variables</span></span><br><span class="line"><span class="comment"># Other node's IP to ping and VIP to swap if other node goes down</span></span><br><span class="line">VIP_ENI_ID=eni-7a5c7722</span><br><span class="line"></span><br><span class="line">NEW_MASTER_IP=<span class="variable">$1</span></span><br><span class="line">OLD_MASTER_IP=<span class="variable">$2</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"NEW_MASTER_IP=<span class="variable">$&#123;NEW_MASTER_IP&#125;</span>,OLD_MASTER_IP=<span class="variable">$&#123;OLD_MASTER_IP&#125;</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify the EC2 region that this will be running in   #以下为当前用户能够执行aws cli命令的key信息</span></span><br><span class="line">REGION=cn-north-1</span><br><span class="line">AWSAccessKeyId=AKIAPUXGZV6F6EKCOK7Q</span><br><span class="line">AWSSecretKey=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       </span><br><span class="line"></span><br><span class="line"><span class="comment"># Run aws-apitools-common.sh to set up default environment variables and to</span></span><br><span class="line"><span class="comment"># leverage AWS security credentials provided by EC2 roles</span></span><br><span class="line">. /etc/profile.d/aws-apitools-common.sh</span><br><span class="line"></span><br><span class="line">ACCESS_USER_OPTION=<span class="string">"--aws-access-key <span class="variable">$&#123;AWSAccessKeyId&#125;</span> --aws-secret-key <span class="variable">$&#123;AWSSecretKey&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">ssh -t -t root@<span class="variable">$&#123;OLD_MASTER_IP&#125;</span> /sbin/ifconfig eth4 down    <span class="comment">#其中eth4网卡名要与下文中，新申请ENI并绑定实例ID对应的网卡名相同</span></span><br><span class="line"></span><br><span class="line">VIP_ATTACHMENT_ID=`ec2-describe-network-interface-attribute <span class="variable">$&#123;VIP_ENI_ID&#125;</span> <span class="variable">$&#123;ACCESS_USER_OPTION&#125;</span> --region <span class="variable">$&#123;REGION&#125;</span> -a | grep ATTACHMENT -m 1 | awk <span class="string">'&#123;print $3;&#125;'</span>`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"VIP_ATTACHMENT_ID=<span class="variable">$&#123;VIP_ATTACHMENT_ID&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">/opt/aws/bin/ec2-detach-network-interface <span class="variable">$&#123;VIP_ATTACHMENT_ID&#125;</span> <span class="variable">$&#123;ACCESS_USER_OPTION&#125;</span> --force --region <span class="variable">$&#123;REGION&#125;</span></span><br><span class="line">sleep 10</span><br><span class="line"></span><br><span class="line">INSTANCE_ID=`ssh root@<span class="variable">$&#123;NEW_MASTER_IP&#125;</span> /usr/bin/curl --silent http://169.254.169.254/latest/meta-data/instance-id`  <span class="comment">#其中169.254.169.254从本地链路中获取实例ID</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"INSTANCE_ID=<span class="variable">$&#123;INSTANCE_ID&#125;</span>"</span></span><br><span class="line"></span><br><span class="line">/opt/aws/bin/ec2-attach-network-interface <span class="variable">$&#123;VIP_ENI_ID&#125;</span> -i <span class="variable">$&#123;INSTANCE_ID&#125;</span> -d 1 <span class="variable">$&#123;ACCESS_USER_OPTION&#125;</span> --region <span class="variable">$&#123;REGION&#125;</span></span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="master-ip-failover"><a href="#master-ip-failover" class="headerlink" title="master_ip_failover"></a>master_ip_failover</h3><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/master_ip_failover </span></span><br><span class="line"><span class="comment">#!/usr/bin/env perl</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  Copyright (C) 2011 DeNA Co.,Ltd.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is free software; you can redistribute it and/or modify</span></span><br><span class="line"><span class="comment">#  it under the terms of the GNU General Public License as published by</span></span><br><span class="line"><span class="comment">#  the Free Software Foundation; either version 2 of the License, or</span></span><br><span class="line"><span class="comment">#  (at your option) any later version.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  This program is distributed in the hope that it will be useful,</span></span><br><span class="line"><span class="comment">#  but WITHOUT ANY WARRANTY; without even the implied warranty of</span></span><br><span class="line"><span class="comment">#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span></span><br><span class="line"><span class="comment">#  GNU General Public License for more details.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#  You should have received a copy of the GNU General Public License</span></span><br><span class="line"><span class="comment">#   along with this program; if not, write to the Free Software</span></span><br><span class="line"><span class="comment">#  Foundation, Inc.,</span></span><br><span class="line"><span class="comment">#  51 Franklin Street, Fifth Floor, Boston, MA  02110-1301  USA</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## <span class="doctag">Note:</span> This is a sample script and is not complete. Modify the script based on your environment.</span></span><br><span class="line"></span><br><span class="line">use strict;</span><br><span class="line">use warnings FATAL =&gt; <span class="string">'all'</span>;</span><br><span class="line"></span><br><span class="line">use Getopt::Long;</span><br><span class="line">use MHA::DBHelper;</span><br><span class="line"></span><br><span class="line">my (</span><br><span class="line">  <span class="variable">$command</span>,        <span class="variable">$ssh_user</span>,         <span class="variable">$orig_master_host</span>,</span><br><span class="line">  <span class="variable">$orig_master_ip</span>, <span class="variable">$orig_master_port</span>, <span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="variable">$new_master_ip</span>,  <span class="variable">$new_master_port</span>,  <span class="variable">$new_master_user</span>,</span><br><span class="line">  <span class="variable">$new_master_password</span></span><br><span class="line">);</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'command=s'</span>             =&gt; \<span class="variable">$command</span>,</span><br><span class="line">  <span class="string">'ssh_user=s'</span>            =&gt; \<span class="variable">$ssh_user</span>,</span><br><span class="line">  <span class="string">'orig_master_host=s'</span>    =&gt; \<span class="variable">$orig_master_host</span>,</span><br><span class="line">  <span class="string">'orig_master_ip=s'</span>      =&gt; \<span class="variable">$orig_master_ip</span>,</span><br><span class="line">  <span class="string">'orig_master_port=i'</span>    =&gt; \<span class="variable">$orig_master_port</span>,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>     =&gt; \<span class="variable">$new_master_host</span>,</span><br><span class="line">  <span class="string">'new_master_ip=s'</span>       =&gt; \<span class="variable">$new_master_ip</span>,</span><br><span class="line">  <span class="string">'new_master_port=i'</span>     =&gt; \<span class="variable">$new_master_port</span>,</span><br><span class="line">  <span class="string">'new_master_user=s'</span>     =&gt; \<span class="variable">$new_master_user</span>,</span><br><span class="line">  <span class="string">'new_master_password=s'</span> =&gt; \<span class="variable">$new_master_password</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">exit</span> &amp;main();</span><br><span class="line"></span><br><span class="line">sub main &#123;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="variable">$command</span> eq <span class="string">"stop"</span> || <span class="variable">$command</span> eq <span class="string">"stopssh"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># $orig_master_host, $orig_master_ip, $orig_master_port are passed.</span></span><br><span class="line">    <span class="comment"># If you manage master ip address at global catalog database,</span></span><br><span class="line">    <span class="comment"># invalidate orig_master_ip here.</span></span><br><span class="line">    my <span class="variable">$exit_code</span> = <span class="number">1</span>;</span><br><span class="line">    eval &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment"># updating global catalog, etc</span></span><br><span class="line">      <span class="variable">$exit_code</span> = <span class="number">0</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">      warn <span class="string">"Got Error: $@\n"</span>;</span><br><span class="line">      <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  elsif ( <span class="variable">$command</span> eq <span class="string">"start"</span> ) &#123;</span><br><span class="line">    my <span class="variable">$exit_code</span> = <span class="number">10</span>;</span><br><span class="line">    my @vip_change_cmd = (<span class="string">"/usr/local/bin/aws_vip_change.sh"</span>,<span class="variable">$new_master_host</span>,<span class="variable">$orig_master_host</span>);</span><br><span class="line">    system @vip_change_cmd;</span><br><span class="line">    <span class="variable">$exit_code</span> = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="variable">$@</span>) &#123;</span><br><span class="line">      warn <span class="variable">$@</span>;</span><br><span class="line"></span><br><span class="line">      <span class="comment"># If you want to continue failover, exit 10.</span></span><br><span class="line">      <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">exit</span> <span class="variable">$exit_code</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  elsif ( <span class="variable">$command</span> eq <span class="string">"status"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># do nothing</span></span><br><span class="line">    <span class="keyword">exit</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    &amp;usage();</span><br><span class="line">    <span class="keyword">exit</span> <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">sub usage &#123;</span><br><span class="line">  print</span><br><span class="line"><span class="string">"Usage: master_ip_failover --command=start|stop|stopssh|status --orig_master_host=host --orig_master_ip=ip --orig_master_port=port --new_master_host=host --new_master_ip=ip --new_master_port=port\n"</span>;</span><br><span class="line">&#125;</span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h3 id="send-report"><a href="#send-report" class="headerlink" title="send_report"></a>send_report</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]<span class="comment"># cat /usr/local/bin/send_report </span></span><br><span class="line"><span class="comment">#!/usr/bin/perl</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">use</span> <span class="title">strict</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">warnings</span> <span class="title">FATAL</span> =&gt; '<span class="title">all</span>';</span><br><span class="line"><span class="keyword">use</span> <span class="title">Mail</span>::<span class="title">Sender</span>;</span><br><span class="line"><span class="keyword">use</span> <span class="title">Getopt</span>::<span class="title">Long</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">#new_master_host and new_slave_hosts are set only when recovering master succeeded</span></span><br><span class="line">my ( $dead_master_host, $new_master_host, $new_slave_hosts, $subject, $body );</span><br><span class="line">my $smtp=<span class="string">'smtp.126.com'</span>;</span><br><span class="line">my $mail_from=<span class="string">'xxx@126.com'</span>;</span><br><span class="line">my $mail_user=<span class="string">'xxx@126.com'</span>;</span><br><span class="line">my $mail_pass=<span class="string">'xxx'</span>;</span><br><span class="line"><span class="comment">#my $mail_to=['xxx','xxx'];</span></span><br><span class="line">my $mail_to=<span class="string">'xxx'</span>;</span><br><span class="line">GetOptions(</span><br><span class="line">  <span class="string">'orig_master_host=s'</span> =&gt; \$dead_master_host,</span><br><span class="line">  <span class="string">'new_master_host=s'</span>  =&gt; \$new_master_host,</span><br><span class="line">  <span class="string">'new_slave_hosts=s'</span>  =&gt; \$new_slave_hosts,</span><br><span class="line">  <span class="string">'subject=s'</span>          =&gt; \$subject,</span><br><span class="line">  <span class="string">'body=s'</span>             =&gt; \$body,</span><br><span class="line">);</span><br><span class="line"> </span><br><span class="line">mailToContacts($smtp,$mail_from,$mail_user,$mail_pass,$mail_to,$subject,$body);</span><br><span class="line"> </span><br><span class="line">sub mailToContacts &#123;</span><br><span class="line">    my ( $smtp, $mail_from, $user, $passwd, $mail_to, $subject, $msg ) = @_;</span><br><span class="line">    open my $DEBUG, <span class="string">"&gt; /var/log/masterha/app1/manager.log"</span></span><br><span class="line">        <span class="keyword">or</span> <span class="keyword">die</span> <span class="string">"Can't open the debug      file:$!\n"</span>;</span><br><span class="line">    my $sender = <span class="keyword">new</span> Mail::Sender &#123;</span><br><span class="line">        ctype       =&gt; <span class="string">'text/plain; charset=utf-8'</span>,</span><br><span class="line">        encoding    =&gt; <span class="string">'utf-8'</span>,</span><br><span class="line">        smtp        =&gt; $smtp,</span><br><span class="line">        from        =&gt; $mail_from,</span><br><span class="line">        auth        =&gt; <span class="string">'LOGIN'</span>,</span><br><span class="line">        TLS_allowed =&gt; <span class="string">'0'</span>,</span><br><span class="line">        authid      =&gt; $user,</span><br><span class="line">        authpwd     =&gt; $passwd,</span><br><span class="line">        to          =&gt; $mail_to,</span><br><span class="line">        subject     =&gt; $subject,</span><br><span class="line">        debug       =&gt; $DEBUG</span><br><span class="line">    &#125;;</span><br><span class="line"> </span><br><span class="line">    $sender-&gt;MailMsg(</span><br><span class="line">        &#123;   msg   =&gt; $msg,</span><br><span class="line">            debug =&gt; $DEBUG</span><br><span class="line">        &#125;</span><br><span class="line">    ) <span class="keyword">or</span> <span class="keyword">print</span> $Mail::Sender::Error;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Do whatever you want here</span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">exit</span> <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<h2 id="主库手动绑定ENI和实例关系"><a href="#主库手动绑定ENI和实例关系" class="headerlink" title="主库手动绑定ENI和实例关系"></a>主库手动绑定ENI和实例关系</h2><p>在主库上先申请新的ENI，注意申请时先绑定的group，以满足其他EC2能够连接些ENI。<br>申请成功后，根据新的ENI和当前主实例的实例ID绑定，最终确认新的VIP是否绑定上。<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">ifconfig</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:E6:0B:68:5C:1C</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.13.126</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::e6:bff:fe68:5c1c/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:4063</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:3292</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:691839</span> <span class="string">(675.6</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:390499</span> <span class="string">(381.3</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="string">::1/128</span> <span class="attr">Scope:Host</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">aws</span> <span class="string">ec2</span> <span class="string">create-network-interface</span> <span class="bullet">--subnet-id</span> <span class="string">subnet-33859151</span> <span class="bullet">--private-ip-address</span> <span class="number">172.31</span><span class="number">.0</span><span class="number">.200</span> <span class="bullet">--groups</span> <span class="string">sg-e50a1c87</span> <span class="string">sg-6b1f0809</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "NetworkInterface":</span> <span class="string">&#123;</span></span><br><span class="line"><span class="attr">        "Status":</span> <span class="string">"pending"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "MacAddress":</span> <span class="string">"02:12:25:83:a0:22"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "SourceDestCheck":</span> <span class="literal">true</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "VpcId":</span> <span class="string">"vpc-b18195d3"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "Description":</span> <span class="string">""</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "NetworkInterfaceId":</span> <span class="string">"eni-7a5c7722"</span><span class="string">,</span>   <span class="comment">#新申请的ENI名字</span></span><br><span class="line"><span class="attr">        "PrivateIpAddresses":</span> <span class="string">[</span></span><br><span class="line">            <span class="string">&#123;</span></span><br><span class="line"><span class="attr">                "PrivateDnsName":</span> <span class="string">"ip-172-31-0-200.cn-north-1.compute.internal"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "Primary":</span> <span class="literal">true</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "PrivateIpAddress":</span> <span class="string">"172.31.0.200"</span>  <span class="comment">#新ENI绑定的私有IP</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">],</span> </span><br><span class="line"><span class="attr">        "RequesterManaged":</span> <span class="literal">false</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "Groups":</span> <span class="string">[</span></span><br><span class="line">            <span class="string">&#123;</span></span><br><span class="line"><span class="attr">                "GroupName":</span> <span class="string">"For Mysql"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "GroupId":</span> <span class="string">"sg-e50a1c87"</span></span><br><span class="line">            <span class="string">&#125;,</span> </span><br><span class="line">            <span class="string">&#123;</span></span><br><span class="line"><span class="attr">                "GroupName":</span> <span class="string">"OnlySSH-Allow"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">                "GroupId":</span> <span class="string">"sg-6b1f0809"</span></span><br><span class="line">            <span class="string">&#125;</span></span><br><span class="line">        <span class="string">],</span> </span><br><span class="line"><span class="attr">        "PrivateDnsName":</span> <span class="string">"ip-172-31-0-200.cn-north-1.compute.internal"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "AvailabilityZone":</span> <span class="string">"cn-north-1a"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "RequesterId":</span> <span class="string">"AIDAPVDKK6NLF6SZ553KS"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "SubnetId":</span> <span class="string">"subnet-33859151"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "OwnerId":</span> <span class="string">"981100955930"</span><span class="string">,</span> </span><br><span class="line"><span class="attr">        "TagSet":</span> <span class="string">[],</span> </span><br><span class="line"><span class="attr">        "PrivateIpAddress":</span> <span class="string">"172.31.0.200"</span></span><br><span class="line">    <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">aws</span> <span class="string">ec2</span> <span class="string">attach-network-interface</span> <span class="bullet">--network-interface-id</span> <span class="string">eni-7a5c7722</span> <span class="bullet">--instance-id</span> <span class="string">i-0a259e4950b0b3cf9</span> <span class="bullet">--device-index</span> <span class="number">1</span>    <span class="comment">#将ENI和实例绑定</span></span><br><span class="line"><span class="string">&#123;</span></span><br><span class="line"><span class="attr">    "AttachmentId":</span> <span class="string">"eni-attach-2b2c9345"</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span> <span class="string">ifconfig</span>   <span class="comment">#查看ip：172.31.0.200已绑定成功，同时要在其他EC2确定此安全组是否能够满足需求，否则还需要重新调整。</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:E6:0B:68:5C:1C</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.13.126</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::e6:bff:fe68:5c1c/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:5435</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:4190</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:810999</span> <span class="string">(791.9</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:501986</span> <span class="string">(490.2</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">eth4</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:12:25:83:A0:22</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.0.200</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::12:25ff:fe83:a022/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:11</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:26</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:1218</span> <span class="string">(1.1</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:2664</span> <span class="string">(2.6</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="string">::1/128</span> <span class="attr">Scope:Host</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:79</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:16736</span> <span class="string">(16.3</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@master</span> <span class="string">~]#</span></span><br></pre></td></tr></table></figure></p>
<h2 id="从库配置MHAManager"><a href="#从库配置MHAManager" class="headerlink" title="从库配置MHAManager"></a>从库配置MHAManager</h2><p>创建配置目录/etc/masterha/，同时创建一个项目上的配置文件，仅配置自动FailOver部分，只需要master_ip_failover和report_script脚本，其他脚本暂时不定义。<br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># mkdir -p /etc/masterha/</span></span><br><span class="line">[root@slave ~]<span class="comment"># cd /etc/masterha/</span></span><br><span class="line">[root@slave masterha]<span class="comment"># </span></span><br><span class="line">[root@slave masterha]<span class="comment"># cat app1.cnf </span></span><br><span class="line">[server default]</span><br><span class="line">manager_workdir=/var/log/masterha/app1                              <span class="comment">#manager工作目录</span></span><br><span class="line">manager_log=/var/log/masterha/app1/manager.log                      <span class="comment">#manager日志</span></span><br><span class="line">master_binlog_dir=/hwdata/data/percona                              <span class="comment">#mysql数据目录</span></span><br><span class="line">password=mha123456                                                  <span class="comment">#mha连接密码</span></span><br><span class="line">user=mha01                                                          <span class="comment">#mha连接用户</span></span><br><span class="line">ping_interval=1                                                     <span class="comment">#监控主库，发送ping包的时间间隔，默认是3秒，尝试三次没有回应的时候自动进行failover</span></span><br><span class="line">remote_workdir=/tmp                                                 <span class="comment">#远端mysql在发生切换时binlog的保存位置</span></span><br><span class="line">repl_password=slave123456                                           <span class="comment">#复制密码</span></span><br><span class="line">repl_user=slave01                                                   <span class="comment">#复制用户</span></span><br><span class="line">ssh_user=root                                                       <span class="comment">#ssh用户</span></span><br><span class="line">master_ip_failover_script=/usr/local/bin/master_ip_failover         <span class="comment">#自动failover切换脚本</span></span><br><span class="line"><span class="comment">#master_ip_online_change_script= /usr/local/bin/master_ip_online_change      #手动failover切换脚本</span></span><br><span class="line">report_script=/usr/local/bin/send_report                            <span class="comment">#报告发送脚本(不是必须)</span></span><br><span class="line"><span class="comment">#shutdown_script=                                                   #故障发生后关闭主机的脚本(不是必须)</span></span><br><span class="line">secondary_check_script = masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306 <span class="comment">#通过第三方机器确认目标主库是否存活，这里的ip可换成其他机器，用于检测</span></span><br><span class="line"></span><br><span class="line">[server1]</span><br><span class="line">hostname=172.31.13.126                                              <span class="comment">#主库地址</span></span><br><span class="line">port=3306</span><br><span class="line"></span><br><span class="line">[server2]</span><br><span class="line">hostname=172.31.9.182                                               <span class="comment">#从库地址</span></span><br><span class="line">port=3306</span><br><span class="line">candidate_master=1                                                  <span class="comment">#候选master</span></span><br></pre></td></tr></table></figure></p>
<h2 id="测试MHAManager-SSH"><a href="#测试MHAManager-SSH" class="headerlink" title="测试MHAManager SSH"></a>测试MHAManager SSH</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_ssh <span class="attribute">--conf</span>=/etc/masterha/app1.cnf </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">info</span>] Starting SSH<span class="built_in"> connection </span>tests<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@172.31.13.126(172.31.13.126:22) <span class="keyword">to</span> root@172.31.9.182(172.31.9.182:22)<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Mon Jul 24 13:58:05 2017 - [<span class="builtin-name">debug</span>] </span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]  Connecting via SSH <span class="keyword">from</span> root@172.31.9.182(172.31.9.182:22) <span class="keyword">to</span> root@172.31.13.126(172.31.13.126:22)<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:04 2017 - [<span class="builtin-name">debug</span>]   ok.</span><br><span class="line">Mon Jul 24 13:58:05 2017 - [<span class="builtin-name">info</span>] All SSH<span class="built_in"> connection </span>tests passed successfully.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h2 id="测试MHAManager-复制"><a href="#测试MHAManager-复制" class="headerlink" title="测试MHAManager 复制"></a>测试MHAManager 复制</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[root@slave masterha]# masterha_check_repl <span class="attribute">--conf</span>=/etc/masterha/app1.cnf </span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">warning</span>] Global configuration file /etc/masterha_default.cnf <span class="keyword">not</span> found. Skipping.</span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">info</span>] Reading application<span class="built_in"> default </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">info</span>] Reading<span class="built_in"> server </span>configuration <span class="keyword">from</span> /etc/masterha/app1.cnf<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:17 2017 - [<span class="builtin-name">info</span>] MHA::MasterMonitor version 0.57.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Master configurations are as below: </span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating <span class="keyword">from</span> 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating <span class="keyword">from</span> 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] GTID failover mode = 1</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Dead Servers:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Alive Servers:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Alive Slaves:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   172.31.9.182(172.31.9.182:3306)  <span class="attribute">Version</span>=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]     GTID ON</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]     Replicating <span class="keyword">from</span> 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]     Primary candidate <span class="keyword">for</span> the new Master (candidate_master is set)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Current Alive Master: 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking slave configurations<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking replication filtering settings<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  Replication filtering check ok.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] GTID (with auto-pos) is supported. Skipping all SSH <span class="keyword">and</span> Node package checking.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking SSH publickey authentication<span class="built_in"> settings </span>on the current master<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] HealthCheck: SSH <span class="keyword">to</span> 172.31.13.126 is reachable.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking replication<span class="built_in"> health </span>on 172.31.9.182<span class="built_in">..</span></span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  ok.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]   /usr/local/bin/master_ip_failover <span class="attribute">--command</span>=status <span class="attribute">--ssh_user</span>=root <span class="attribute">--orig_master_host</span>=172.31.13.126 <span class="attribute">--orig_master_ip</span>=172.31.13.126 <span class="attribute">--orig_master_port</span>=3306 </span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>]  OK.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">warning</span>] shutdown_script is <span class="keyword">not</span> defined.</span><br><span class="line">Mon Jul 24 13:58:18 2017 - [<span class="builtin-name">info</span>] Got exit code 0 (<span class="keyword">Not</span> master dead).</span><br><span class="line"></span><br><span class="line">MySQL Replication<span class="built_in"> Health </span>is OK.</span><br><span class="line">[root@slave masterha]#</span><br></pre></td></tr></table></figure>
<h2 id="启动MHAManager"><a href="#启动MHAManager" class="headerlink" title="启动MHAManager"></a>启动MHAManager</h2><h3 id="启动进程"><a href="#启动进程" class="headerlink" title="启动进程"></a>启动进程</h3><figure class="highlight cs"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta"># nohup masterha_manager --conf=/etc/masterha/app1.cnf &amp;</span></span><br><span class="line">[<span class="meta">1</span>] <span class="number">4439</span></span><br><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta"># nohup: ignoring input and appending output to ‘nohup.out’</span></span><br><span class="line"></span><br><span class="line">[<span class="meta">root@slave masterha</span>]<span class="meta">#</span></span><br></pre></td></tr></table></figure>
<h3 id="查看启动日志"><a href="#查看启动日志" class="headerlink" title="查看启动日志"></a>查看启动日志</h3><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">[root@slave ~]<span class="comment"># cat /var/log/masterha/app1/manager.log </span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:10<span class="number"> 2017 </span>- [info] MHA::MasterMonitor version 0.57.  <span class="comment">#检查版本</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306) <span class="comment">#获取当前主节点ip</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Master configurations are as below:   <span class="comment">#获取复制结构</span></span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating from 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating from 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] GTID failover mode =<span class="number"> 1 </span>   <span class="comment">#GTID模式</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Alive Servers:            <span class="comment">#当前在线实例列表</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Alive Slaves:             <span class="comment">#当前在线slave列表及版本信息</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Current Alive Master: 172.31.13.126(172.31.13.126:3306)   <span class="comment">#当前主实例信息</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking slave configurations..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]  binlog_do_db= , binlog_ignore_db=                        <span class="comment">#复制过滤</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] HealthCheck: SSH to 172.31.13.126 is reachable.           <span class="comment">#ssh可用</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)                                          <span class="comment">#再次确认当前复制架构</span></span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 </span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info]  OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [warning] shutdown_script is not defined.                        <span class="comment">#shutdown_script脚本未定义    </span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Set master ping interval<span class="number"> 1 </span>seconds.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Set secondary check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306                                                <span class="comment">#第三方检查登录</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Starting ping health check on 172.31.13.126(172.31.13.126:3306)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>14:04:11<span class="number"> 2017 </span>- [info] Ping(SELECT) succeeded, waiting until MySQL doesn't respond.. <span class="comment">#启动成功，等待failover</span></span><br><span class="line">[root@slave masterha]<span class="comment"># ps aux|grep master</span></span><br><span class="line">root     <span class="number"> 4439 </span> 0.0  0.2<span class="number"> 287004 </span>23636 pts/0    S    14:04   0:00 perl /usr/local/bin/masterha_manager --conf=/etc/masterha/app1.cnf <span class="comment">#进程存在</span></span><br><span class="line">root     <span class="number"> 5008 </span> 0.0  0.0<span class="number"> 110456 </span><span class="number"> 2092 </span>pts/0    S+   14:13   0:00 grep --color=auto master</span><br><span class="line">[root@slave masterha]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
<h2 id="模拟主库故障"><a href="#模拟主库故障" class="headerlink" title="模拟主库故障"></a>模拟主库故障</h2><h3 id="确认当前VIP状态"><a href="#确认当前VIP状态" class="headerlink" title="确认当前VIP状态"></a>确认当前VIP状态</h3><p>在主库上执行停止服务，观察MHAManager日志，并确认VIP是否切换到从库上<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>       #确认当前<span class="selector-tag">VIP</span>：<span class="selector-tag">172</span><span class="selector-class">.31</span><span class="selector-class">.0</span><span class="selector-class">.200</span>在主库上</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:E6</span><span class="selector-pseudo">:0B</span><span class="selector-pseudo">:68</span><span class="selector-pseudo">:5C</span><span class="selector-pseudo">:1C</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.13.126</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::e6</span><span class="selector-pseudo">:bff</span><span class="selector-pseudo">:fe68</span><span class="selector-pseudo">:5c1c</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:9629</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8119</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1202679</span> (<span class="number">1.1</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1113439</span> (<span class="number">1.0</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth4</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:25</span><span class="selector-pseudo">:83</span><span class="selector-pseudo">:A0</span><span class="selector-pseudo">:22</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.0.200</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::12</span><span class="selector-pseudo">:25ff</span><span class="selector-pseudo">:fe83</span><span class="selector-pseudo">:a022</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:4</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:4</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:562</span> (<span class="number">562.0</span> b)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:600</span> (<span class="number">600.0</span> b)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-pseudo">::1</span>/<span class="selector-tag">128</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Host</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:90</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:90</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17324</span> (<span class="number">16.9</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17324</span> (<span class="number">16.9</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure></p>
<h3 id="确认MHAManger进程状态"><a href="#确认MHAManger进程状态" class="headerlink" title="确认MHAManger进程状态"></a>确认MHAManger进程状态</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@slave</span> <span class="string">masterha]#</span> <span class="string">ps</span> <span class="string">aux|grep</span> <span class="string">master</span></span><br><span class="line"><span class="string">root</span>     <span class="number">11333</span>  <span class="number">0.4</span>  <span class="number">0.2</span> <span class="number">287004</span> <span class="number">23604</span> <span class="string">pts/0</span>    <span class="string">S</span>    <span class="number">15</span><span class="string">:36</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">perl</span> <span class="string">/usr/local/bin/masterha_manager</span> <span class="bullet">--conf=/etc/masterha/app1.cnf</span></span><br><span class="line"><span class="string">root</span>     <span class="number">11377</span>  <span class="number">0.0</span>  <span class="number">0.0</span> <span class="number">110456</span>  <span class="number">2252</span> <span class="string">pts/0</span>    <span class="string">S+</span>   <span class="number">15</span><span class="string">:37</span>   <span class="number">0</span><span class="string">:00</span> <span class="string">grep</span> <span class="bullet">--color=auto</span> <span class="string">master</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">masterha]#</span> <span class="string">cd</span> <span class="string">/var/log/masterha/app1/</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">ll</span></span><br><span class="line"><span class="string">total</span> <span class="number">8</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span>   <span class="number">36</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:37</span> <span class="string">app1.master_status.health</span></span><br><span class="line"><span class="bullet">-</span><span class="string">rw-r--r--</span> <span class="number">1</span> <span class="string">root</span> <span class="string">root</span> <span class="number">2833</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:36</span> <span class="string">manager.log</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">cat</span> <span class="string">manager.log</span> <span class="string">|tail</span> <span class="bullet">-2</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:36:54</span> <span class="number">2017</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Starting</span> <span class="string">ping</span> <span class="string">health</span> <span class="string">check</span> <span class="string">on</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)..</span></span><br><span class="line"><span class="string">Mon</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">15</span><span class="string">:36:54</span> <span class="number">2017</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Ping(SELECT)</span> <span class="string">succeeded,</span> <span class="string">waiting</span> <span class="string">until</span> <span class="string">MySQL</span> <span class="string">doesn't</span> <span class="string">respond..</span>     <span class="comment">#正在等待主库FailOver</span></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span> <span class="string">ifconfig</span>     <span class="comment">#当前从库没有存在VIP：172.31.0.200</span></span><br><span class="line"><span class="string">eth0</span>      <span class="string">Link</span> <span class="attr">encap:Ethernet</span>  <span class="string">HWaddr</span> <span class="number">02</span><span class="string">:0E:FB:F1:E9:4E</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:172.31.9.182</span>  <span class="attr">Bcast:172.31.15.255</span>  <span class="attr">Mask:255.255.240.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="attr">fe80::e:fbff:fef1:e94e/64</span> <span class="attr">Scope:Link</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">BROADCAST</span> <span class="string">RUNNING</span> <span class="string">MULTICAST</span>  <span class="attr">MTU:9001</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:16565</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:17269</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1000</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:2084631</span> <span class="string">(1.9</span> <span class="string">MiB)</span>  <span class="string">TX</span> <span class="attr">bytes:2304176</span> <span class="string">(2.1</span> <span class="string">MiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">lo</span>        <span class="string">Link</span> <span class="attr">encap:Local</span> <span class="string">Loopback</span>  </span><br><span class="line">          <span class="string">inet</span> <span class="attr">addr:127.0.0.1</span>  <span class="attr">Mask:255.0.0.0</span></span><br><span class="line">          <span class="string">inet6</span> <span class="attr">addr:</span> <span class="string">::1/128</span> <span class="attr">Scope:Host</span></span><br><span class="line">          <span class="string">UP</span> <span class="string">LOOPBACK</span> <span class="string">RUNNING</span>  <span class="attr">MTU:65536</span>  <span class="attr">Metric:1</span></span><br><span class="line">          <span class="string">RX</span> <span class="attr">packets:2556</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">frame:0</span></span><br><span class="line">          <span class="string">TX</span> <span class="attr">packets:2556</span> <span class="attr">errors:0</span> <span class="attr">dropped:0</span> <span class="attr">overruns:0</span> <span class="attr">carrier:0</span></span><br><span class="line"><span class="attr">          collisions:</span><span class="number">0</span> <span class="attr">txqueuelen:1</span> </span><br><span class="line">          <span class="string">RX</span> <span class="attr">bytes:605471</span> <span class="string">(591.2</span> <span class="string">KiB)</span>  <span class="string">TX</span> <span class="attr">bytes:605471</span> <span class="string">(591.2</span> <span class="string">KiB)</span></span><br><span class="line"></span><br><span class="line"><span class="string">[root@slave</span> <span class="string">app1]#</span></span><br></pre></td></tr></table></figure>
<h3 id="停止主库服务，触发主库FailOver"><a href="#停止主库服务，触发主库FailOver" class="headerlink" title="停止主库服务，触发主库FailOver"></a>停止主库服务，触发主库FailOver</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@master ~]</span># /<span class="selector-tag">etc</span>/<span class="selector-tag">init</span><span class="selector-class">.d</span>/<span class="selector-tag">mysqld</span> <span class="selector-tag">stop</span>                    #服务停止</span><br><span class="line"><span class="selector-tag">Shutting</span> <span class="selector-tag">down</span> <span class="selector-tag">MySQL</span> (Percona Server)............ <span class="selector-tag">SUCCESS</span>! </span><br><span class="line"><span class="selector-attr">[root@master ~]</span># <span class="selector-tag">ifconfig</span>                                   <span class="selector-id">#VIP</span>已经不存在</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:E6</span><span class="selector-pseudo">:0B</span><span class="selector-pseudo">:68</span><span class="selector-pseudo">:5C</span><span class="selector-pseudo">:1C</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.13.126</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::e6</span><span class="selector-pseudo">:bff</span><span class="selector-pseudo">:fe68</span><span class="selector-pseudo">:5c1c</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:10242</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8535</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1256340</span> (<span class="number">1.1</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1175340</span> (<span class="number">1.1</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-pseudo">::1</span>/<span class="selector-tag">128</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Host</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:92</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:92</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17424</span> (<span class="number">17.0</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:17424</span> (<span class="number">17.0</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@master ~]</span>#</span><br></pre></td></tr></table></figure>
<h3 id="观察FailOver日志"><a href="#观察FailOver日志" class="headerlink" title="观察FailOver日志"></a>观察FailOver日志</h3><p>登录从库，查看MHAManager日志<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line">[root@slave app1]<span class="comment"># cat manager.log </span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:52<span class="number"> 2017 </span>- [info] MHA::MasterMonitor version 0.57.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Multi-master configuration is detected. Current primary(writable) master is 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Master configurations are as below: </span><br><span class="line">Master 172.31.13.126(172.31.13.126:3306), replicating from 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Master 172.31.9.182(172.31.9.182:3306), replicating from 172.31.13.126(172.31.13.126:3306), read-only</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] GTID failover mode = 1</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Alive Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Alive Slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Current Alive Master: 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking slave configurations..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]  binlog_do_db= , binlog_ignore_db= </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] GTID (with auto-pos) is supported. Skipping all SSH and Node package checking.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking SSH publickey authentication settings on the current master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] HealthCheck: SSH to 172.31.13.126 is reachable.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] </span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Checking master_ip_failover_script status:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --command=status --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info]  OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [warning] shutdown_script is not defined.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Set master ping interval<span class="number"> 1 </span>seconds.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Set secondary check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Starting ping health check on 172.31.13.126(172.31.13.126:3306)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:36:54<span class="number"> 2017 </span>- [info] Ping(SELECT) succeeded, waiting until MySQL doesn't respond..         <span class="comment">#等待主库FailOver</span></span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [warning] Got error on MySQL select ping:<span class="number"> 2006 </span>(MySQL server has gone away)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] Executing secondary network check script: masterha_secondary_check -s 172.31.13.126 -s 172.31.9.182 --user=root hostname=172.31.13.126  --master_ip=172.31.13.126 --master_port=3306  --user=root  --master_host=172.31.13.126  --master_ip=172.31.13.126  --master_port=3306 --master_user=mha01 --master_password=mha123456 --ping_type=SELECT</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] Executing SSH check script: exit 0</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] HealthCheck: SSH to 172.31.13.126 is reachable.</span><br><span class="line">Monitoring server 172.31.13.126 is reachable, Master is not reachable from 172.31.13.126. OK.</span><br><span class="line">Monitoring server 172.31.9.182 is reachable, Master is not reachable from 172.31.9.182. OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:01<span class="number"> 2017 </span>- [info] Master is not reachable from all other monitoring servers. Failover should start.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:02<span class="number"> 2017 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '172.31.13.126' (111))</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:02<span class="number"> 2017 </span>- [warning] Connection failed<span class="number"> 2 </span>time(s)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:03<span class="number"> 2017 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '172.31.13.126' (111))</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:03<span class="number"> 2017 </span>- [warning] Connection failed<span class="number"> 3 </span>time(s)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Got error on MySQL connect:<span class="number"> 2003 </span>(Can't connect to MySQL server on '172.31.13.126' (111))</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Connection failed<span class="number"> 4 </span>time(s)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Master is not reachable from health checker!</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Master 172.31.13.126(172.31.13.126:3306) is not reachable!</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] SSH is reachable.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [info] Connecting to a master server failed. Reading configuration file /etc/masterha_default.cnf and /etc/masterha/app1.cnf again, and trying to connect to all servers to check server status..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [warning] Global configuration file /etc/masterha_default.cnf not found. Skipping.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [info] Reading application default configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:04<span class="number"> 2017 </span>- [info] Reading server configuration from /etc/masterha/app1.cnf..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] GTID failover mode = 1</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Alive Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Alive Slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Checking slave configurations..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Checking replication filtering settings..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info]  Replication filtering check ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Master is down!</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Terminating monitoring script.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Got exit code<span class="number"> 20 </span>(Master dead).</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] MHA::MasterFailover version 0.57.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] Starting master failover.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] * Phase 1: Configuration Check Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:05<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] GTID failover mode = 1</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Dead Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Checking master reachability via MySQL(double check)...</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Alive Servers:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Alive Slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Starting GTID based failover.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] ** Phase 1: Configuration Check Phase completed.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 2: Dead Master Shutdown Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Forcing shutdown so that applications never connect to the current master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Executing master IP deactivation script:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 --command=stopssh --ssh_user=root  </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  done.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [warning] shutdown_script is not set. Skipping explicit shutting down of the dead master.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 2: Dead Master Shutdown Phase completed.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3: Master Recovery Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3.1: Getting Latest Slaves Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] The latest binary log file/position on all slaves is mysql-bin.000011:234</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Latest slaves (Slaves that received relay log files to the latest):</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] The oldest binary log file/position on all slaves is mysql-bin.000011:234</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Oldest slaves:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3.3: Determining New Master Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Searching new master from slaves..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Candidate masters from the configuration file:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   172.31.9.182(172.31.9.182:3306)  Version=5.7.18-15-log (oldest major version between slaves) log-bin:enabled</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     GTID ON</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Replicating from 172.31.13.126(172.31.13.126:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]     Primary candidate for the new Master (candidate_master is set)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Non-candidate masters:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Searching from candidate_master slaves which have received the latest relay log events..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] New master is 172.31.9.182(172.31.9.182:3306)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Starting master failover..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">From:</span><br><span class="line">172.31.13.126(172.31.13.126:3306) (current master)</span><br><span class="line"> +--172.31.9.182(172.31.9.182:3306)</span><br><span class="line"></span><br><span class="line">To:</span><br><span class="line">172.31.9.182(172.31.9.182:3306) (new master)</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] * Phase 3.3: New Master Recovery Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  Waiting all logs to be applied.. </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   done.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Getting new master's binlog name and position..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  mysql-bin.000008:234</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='172.31.9.182', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='slave01', MASTER_PASSWORD='xxx';</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: mysql-bin.000008, 234, 28a037e5-6d0f-11e7-b43a-02e60b685c1c:1-15,</span><br><span class="line">39292a50-6d0f-11e7-999e-020efbf1e94e:1-4</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info] Executing master IP activate script:</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:07<span class="number"> 2017 </span>- [info]   /usr/local/bin/master_ip_failover --command=start --ssh_user=root --orig_master_host=172.31.13.126 --orig_master_ip=172.31.13.126 --orig_master_port=3306 --new_master_host=172.31.9.182 --new_master_ip=172.31.9.182 --new_master_port=3306 --new_master_user='mha01'   --new_master_password=xxx</span><br><span class="line">NEW_MASTER_IP=172.31.9.182,OLD_MASTER_IP=172.31.13.126</span><br><span class="line">Connection to 172.31.13.126 closed.</span><br><span class="line">VIP_ATTACHMENT_ID=eni-attach-5b219e35</span><br><span class="line">ATTACHMENT              eni-attach-5b219e35     detaching</span><br><span class="line">INSTANCE_ID=i-03135a59c242e9bad</span><br><span class="line">eni-attach-0f209f61</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info]  OK.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] Setting read_only=0 on 172.31.9.182(172.31.9.182:3306)..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info]  ok.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] ** Finished master recovery successfully.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 3: Master Recovery Phase completed.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 4: Slaves Recovery Phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 4.1: Starting Slaves in parallel..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] All new slave servers recovered successfully.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] * Phase 5: New master cleanup phase..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] Resetting slave info on the new master..</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info]  172.31.9.182: Resetting slave info succeeded.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] Master failover to 172.31.9.182(172.31.9.182:3306) completed successfully.</span><br><span class="line">Mon Jul<span class="number"> 24 </span>15:40:22<span class="number"> 2017 </span>- [info] </span><br><span class="line"></span><br><span class="line">----- Failover Report --<span class="yaml"><span class="meta">---</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="attr">app1:</span> <span class="string">MySQL</span> <span class="string">Master</span> <span class="string">failover</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">succeeded</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Master</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">is</span> <span class="string">down!</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Check</span> <span class="string">MHA</span> <span class="string">Manager</span> <span class="string">logs</span> <span class="string">at</span> <span class="attr">slave:/var/log/masterha/app1/manager.log</span> <span class="string">for</span> <span class="string">details.</span></span></span><br><span class="line"><span class="yaml"></span></span><br><span class="line"><span class="yaml"><span class="string">Started</span> <span class="string">automated(non-interactive)</span> <span class="string">failover.</span></span></span><br><span class="line"><span class="yaml"><span class="string">Invalidated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address</span> <span class="string">on</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span></span></span><br><span class="line"><span class="yaml"><span class="string">Selected</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">as</span> <span class="string">a</span> <span class="string">new</span> <span class="string">master.</span></span></span><br><span class="line"><span class="yaml"><span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Applying</span> <span class="string">all</span> <span class="string">logs</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Activated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address.</span></span></span><br><span class="line"><span class="yaml"><span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="string">Resetting</span> <span class="string">slave</span> <span class="string">info</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="string">Master</span> <span class="string">failover</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">completed</span> <span class="string">successfully.</span></span></span><br><span class="line"><span class="yaml"><span class="string">Mon</span> <span class="string">Jul</span> <span class="number">24</span> <span class="number">16</span><span class="string">:27:13</span> <span class="number">2017</span> <span class="bullet">-</span> <span class="string">[info]</span> <span class="string">Sending</span> <span class="string">mail..</span></span></span><br><span class="line"><span class="yaml"><span class="string">defined(@array)</span> <span class="string">is</span> <span class="string">deprecated</span> <span class="string">at</span> <span class="string">/usr/share/perl5/vendor_perl/Mail/Sender.pm</span> <span class="string">line</span> <span class="number">318.</span></span></span><br><span class="line"><span class="yaml">        <span class="string">(Maybe</span> <span class="string">you</span> <span class="string">should</span> <span class="string">just</span> <span class="string">omit</span> <span class="string">the</span> <span class="string">defined()?)</span></span></span><br><span class="line"><span class="yaml"><span class="string">defined(@array)</span> <span class="string">is</span> <span class="string">deprecated</span> <span class="string">at</span> <span class="string">/usr/share/perl5/vendor_perl/Mail/Sender.pm</span> <span class="string">line</span> <span class="number">2693.</span></span></span><br><span class="line"><span class="yaml">        <span class="string">(Maybe</span> <span class="string">you</span> <span class="string">should</span> <span class="string">just</span> <span class="string">omit</span> <span class="string">the</span> <span class="string">defined()?)</span></span></span><br><span class="line"><span class="yaml"><span class="string">Option</span> <span class="string">new_slave_hosts</span> <span class="string">requires</span> <span class="string">an</span> <span class="string">argument</span></span></span><br><span class="line"><span class="yaml"><span class="string">Unknown</span> <span class="attr">option:</span> <span class="string">conf</span></span></span><br><span class="line"><span class="yaml"><span class="attr">tail:</span> <span class="string">manager.log:</span> <span class="string">file</span> <span class="string">truncated</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">220</span> <span class="number">126.</span><span class="string">com</span> <span class="string">Anti-spam</span> <span class="string">GT</span> <span class="string">for</span> <span class="string">Coremail</span> <span class="string">System</span> <span class="string">(126com[20140526])</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">EHLO</span> <span class="string">slave</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-mail</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-PIPELINING</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-AUTH</span> <span class="string">LOGIN</span> <span class="string">PLAIN</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-AUTH=LOGIN</span> <span class="string">PLAIN</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-coremail</span> <span class="number">1</span><span class="string">Uxr2xKj7kG0xkI17xGrU7I0s8FY2U3Uj8Cz28x1UUUUU7Ic2I0Y2Ur0Vl_3UCa0xDrUUUUj</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span><span class="bullet">-STARTTLS</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="number">8</span><span class="string">BITMIME</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">AUTH</span> <span class="string">LOGIN</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">334</span> <span class="string">dXNlcm5hbWU6</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">ZHdqNTY4NTg4QDEyNi5jb20=</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">334</span> <span class="string">UGFzc3dvcmQ6</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">RHdqMTIzNDU=</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">235</span> <span class="string">Authentication</span> <span class="string">successful</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">MAIL</span> <span class="attr">FROM:&lt;dwj568588@126.com&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="string">Mail</span> <span class="string">OK</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">RCPT</span> <span class="attr">TO:&lt;duanwenjie@huan.tv&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="string">Mail</span> <span class="string">OK</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">DATA</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">354</span> <span class="string">End</span> <span class="string">data</span> <span class="string">with</span> <span class="string">&lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">To:</span> <span class="string">duanwenjie@huan.tv</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">From:</span> <span class="string">dwj568588@126.com</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Subject:</span> <span class="attr">app1:</span> <span class="string">MySQL</span> <span class="string">Master</span> <span class="string">failover</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">succeeded</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Date:</span> <span class="string">Mon,</span> <span class="number">24</span> <span class="string">Jul</span> <span class="number">2017</span> <span class="number">16</span><span class="string">:27:15</span> <span class="string">+0800</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">X-Mailer:</span> <span class="string">Perl</span> <span class="string">script</span> <span class="string">"send_report"</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span>      <span class="string">using</span> <span class="attr">Mail::Sender</span> <span class="number">0.8</span><span class="number">.16</span> <span class="string">by</span> <span class="string">Jenda</span> <span class="string">Krynicky,</span> <span class="string">Czechlands</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span>      <span class="string">running</span> <span class="string">on</span> <span class="string">slave</span> <span class="string">()</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span>      <span class="string">under</span> <span class="string">account</span> <span class="string">"zhouting"</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Message-ID:</span> <span class="string">&lt;20170724_082715_056339.dwj568588@126.com&gt;</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">MIME-Version:</span> <span class="number">1.0</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="attr">Content-type:</span> <span class="string">text/plain;</span> <span class="string">charset=utf-8</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Master</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span> <span class="string">is</span> <span class="string">down!</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Check</span> <span class="string">MHA</span> <span class="string">Manager</span> <span class="string">logs</span> <span class="string">at</span> <span class="attr">slave:/var/log/masterha/app1/manager.log</span> <span class="string">for</span> <span class="string">details.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Started</span> <span class="string">automated(non-interactive)</span> <span class="string">failover.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Invalidated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address</span> <span class="string">on</span> <span class="number">172.31</span><span class="number">.13</span><span class="number">.126</span><span class="string">(172.31.13.126:3306)</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Selected</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">as</span> <span class="string">a</span> <span class="string">new</span> <span class="string">master.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Applying</span> <span class="string">all</span> <span class="string">logs</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="attr">OK:</span> <span class="string">Activated</span> <span class="string">master</span> <span class="string">IP</span> <span class="string">address.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306):</span> <span class="string">Resetting</span> <span class="string">slave</span> <span class="string">info</span> <span class="string">succeeded.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">Master</span> <span class="string">failover</span> <span class="string">to</span> <span class="number">172.31</span><span class="number">.9</span><span class="number">.182</span><span class="string">(172.31.9.182:3306)</span> <span class="string">completed</span> <span class="string">successfully.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> </span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">.</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">250</span> <span class="string">Mail</span> <span class="string">OK</span> <span class="string">queued</span> <span class="string">as</span> <span class="string">smtp1,C8mowAAH7yZhr3VZFR+JCA--.54250S2</span> <span class="number">1500884834</span></span></span><br><span class="line"><span class="yaml"><span class="string">&lt;&lt;</span> <span class="string">QUIT</span></span></span><br><span class="line"><span class="yaml"><span class="string">&gt;&gt;</span> <span class="number">221</span> <span class="string">Bye</span></span></span><br><span class="line"><span class="yaml"><span class="string">[root@slave</span> <span class="string">app1]#</span></span></span><br></pre></td></tr></table></figure></p>
<h3 id="日志过程解析"><a href="#日志过程解析" class="headerlink" title="日志过程解析"></a>日志过程解析</h3><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">启动前的准备工作</span><br><span class="line">检查数据库服务器状态,获取相关参数设置</span><br><span class="line">检查GTID、candidate_master、过滤DB是否设置</span><br><span class="line">测试ssh连接是否成功</span><br><span class="line">测试MHA <span class="keyword">node</span><span class="title">是否可用</span></span><br><span class="line"><span class="title">创建MHA</span>日志目录</span><br><span class="line">开始检查<span class="literal">slave</span>的差异日志应用权限</span><br><span class="line">确定当前的复制架构</span><br><span class="line">调试master_ip_failover_script</span><br><span class="line">调试shutdown_script</span><br><span class="line">设置二次检查的主机masterha_secondary_check</span><br><span class="line">MHA启动完毕,进入监测状态</span><br><span class="line">监测<span class="literal">master</span>服务器挂了</span><br><span class="line">通过定义的二次监测,确认<span class="literal">master</span>是否挂了</span><br><span class="line">确认<span class="literal">master</span>挂了,开始进入failover流程</span><br><span class="line">再试尝试连接<span class="literal">master</span>和<span class="literal">master</span>的ssh</span><br><span class="line">通过MHA配置文件,监测其他<span class="literal">slave</span>的状态</span><br><span class="line">再次监测<span class="literal">slave</span>的配置是否有变化,是否符合failover条件</span><br><span class="line">正式开始failover</span><br><span class="line">再次对<span class="literal">slave</span>配置做检查</span><br><span class="line">对原<span class="literal">Master</span>做master_ip_failover_script和shutdown_script的操作</span><br><span class="line">开始差异日志的恢复，获取<span class="literal">slave</span>最后得到的binlog位置</span><br><span class="line">获取原<span class="literal">master</span>的binlog日志</span><br><span class="line">确定新的<span class="literal">master</span></span><br><span class="line">在new <span class="literal">master</span>上应用差异的binlog日志</span><br><span class="line">获取new <span class="literal">master</span>的binlog位置。</span><br><span class="line">执行master_ip_failover_script,调用aws_vip_change.sh，执行VIP漂移</span><br><span class="line">开始恢复其他<span class="literal">slave</span>的差异日志</span><br><span class="line">差异日志应用完成以后,切换所有<span class="literal">slave</span>到new <span class="literal">master</span>。</span><br><span class="line">failover操作完成,生成failover报告</span><br><span class="line">最后发送邮件通知</span><br></pre></td></tr></table></figure>
<h3 id="确认FailOver状态"><a href="#确认FailOver状态" class="headerlink" title="确认FailOver状态"></a>确认FailOver状态</h3><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@slave app1]</span># <span class="selector-tag">ifconfig</span>             <span class="selector-id">#vip</span>已经添加到从库上</span><br><span class="line"><span class="selector-tag">eth0</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:0E</span><span class="selector-pseudo">:FB</span><span class="selector-pseudo">:F1</span><span class="selector-pseudo">:E9</span><span class="selector-pseudo">:4E</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.9.182</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::e</span><span class="selector-pseudo">:fbff</span><span class="selector-pseudo">:fef1</span><span class="selector-pseudo">:e94e</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:17060</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:17883</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:2142676</span> (<span class="number">2.0</span> MiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:2390595</span> (<span class="number">2.2</span> MiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">eth1</span>      <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Ethernet</span>  <span class="selector-tag">HWaddr</span> <span class="selector-tag">02</span><span class="selector-pseudo">:12</span><span class="selector-pseudo">:25</span><span class="selector-pseudo">:83</span><span class="selector-pseudo">:A0</span><span class="selector-pseudo">:22</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:172.31.0.200</span>  <span class="selector-tag">Bcast</span><span class="selector-pseudo">:172.31.15.255</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.255.240.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-tag">fe80</span><span class="selector-pseudo">::12</span><span class="selector-pseudo">:25ff</span><span class="selector-pseudo">:fe83</span><span class="selector-pseudo">:a022</span>/<span class="selector-tag">64</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Link</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">BROADCAST</span> <span class="selector-tag">RUNNING</span> <span class="selector-tag">MULTICAST</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:9001</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:8</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:18</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1000</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:798</span> (<span class="number">798.0</span> b)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:1828</span> (<span class="number">1.7</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-tag">lo</span>        <span class="selector-tag">Link</span> <span class="selector-tag">encap</span><span class="selector-pseudo">:Local</span> <span class="selector-tag">Loopback</span>  </span><br><span class="line">          <span class="selector-tag">inet</span> <span class="selector-tag">addr</span><span class="selector-pseudo">:127.0.0.1</span>  <span class="selector-tag">Mask</span><span class="selector-pseudo">:255.0.0.0</span></span><br><span class="line">          <span class="selector-tag">inet6</span> <span class="selector-tag">addr</span>: <span class="selector-pseudo">::1</span>/<span class="selector-tag">128</span> <span class="selector-tag">Scope</span><span class="selector-pseudo">:Host</span></span><br><span class="line">          <span class="selector-tag">UP</span> <span class="selector-tag">LOOPBACK</span> <span class="selector-tag">RUNNING</span>  <span class="selector-tag">MTU</span><span class="selector-pseudo">:65536</span>  <span class="selector-tag">Metric</span><span class="selector-pseudo">:1</span></span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:2789</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">frame</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">TX</span> <span class="selector-tag">packets</span><span class="selector-pseudo">:2789</span> <span class="selector-tag">errors</span><span class="selector-pseudo">:0</span> <span class="selector-tag">dropped</span><span class="selector-pseudo">:0</span> <span class="selector-tag">overruns</span><span class="selector-pseudo">:0</span> <span class="selector-tag">carrier</span><span class="selector-pseudo">:0</span></span><br><span class="line">          <span class="selector-tag">collisions</span><span class="selector-pseudo">:0</span> <span class="selector-tag">txqueuelen</span><span class="selector-pseudo">:1</span> </span><br><span class="line">          <span class="selector-tag">RX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:669913</span> (<span class="number">654.2</span> KiB)  <span class="selector-tag">TX</span> <span class="selector-tag">bytes</span><span class="selector-pseudo">:669913</span> (<span class="number">654.2</span> KiB)</span><br><span class="line"></span><br><span class="line"><span class="selector-attr">[root@slave app1]</span>#</span><br></pre></td></tr></table></figure>
<h3 id="查看邮件发送状态"><a href="#查看邮件发送状态" class="headerlink" title="查看邮件发送状态"></a>查看邮件发送状态</h3><p>登录邮件，查看是否收到报警邮件。<br><img src="http://note.youdao.com/yws/public/resource/bba80193f9c2d29f073784f4e498b134/xmlnote/0A43FC640BD84154ADCD175F765F82E1/33468" alt="image">  </p>
<h3 id="手动FailOver"><a href="#手动FailOver" class="headerlink" title="手动FailOver"></a>手动FailOver</h3><p>MHA的手动FailOver不在本文范围，详情理论可参考官方文档。  </p>
<h3 id="参数列表"><a href="#参数列表" class="headerlink" title="参数列表"></a>参数列表</h3><table>
<thead>
<tr>
<th>参数名</th>
<th>是否必须</th>
<th>参数使用域</th>
<th>默认值</th>
<th>例子</th>
</tr>
</thead>
<tbody>
<tr>
<td>hostname</td>
<td>Yes</td>
<td>Local Only</td>
<td>-</td>
<td>hostname=master,hostname=slave</td>
</tr>
<tr>
<td>ip</td>
<td>No</td>
<td>Local Only</td>
<td>gethostbyname($hostname)</td>
<td>ip=192.168.1.100</td>
</tr>
<tr>
<td>port</td>
<td>No</td>
<td>Local/App/Global</td>
<td>3306</td>
<td>port=3306</td>
</tr>
<tr>
<td>ssh_host</td>
<td>No</td>
<td>Local Only</td>
<td>same as hostname</td>
<td>ssh_host=master,ssh_host=slave</td>
</tr>
<tr>
<td>ssh_ip</td>
<td>No</td>
<td>Local Only</td>
<td>gethostbyname($ssh_host)</td>
<td>ssh_ip=192.168.1.101</td>
</tr>
<tr>
<td>ssh_port</td>
<td>No</td>
<td>Local/App/Global</td>
<td>22</td>
<td>ssh_port=22</td>
</tr>
<tr>
<td>ssh_connection_timeout</td>
<td>No</td>
<td>Local/App/Global</td>
<td>5</td>
<td>ssh_connection_timeout=20</td>
</tr>
<tr>
<td>ssh_options</td>
<td>No</td>
<td>Local/App/Global</td>
<td>“”(empty string)</td>
<td>ssh_options=”-i /root/.ssh/id_dsa2”</td>
</tr>
<tr>
<td>candidate_master</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>candidate_master=1</td>
</tr>
<tr>
<td>no_master</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>no_master=1</td>
</tr>
<tr>
<td>ignore_fail</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>ignore_fail=1</td>
</tr>
<tr>
<td>skip_init_ssh_check</td>
<td>No</td>
<td>Local Only</td>
<td>0</td>
<td>skip_init_ssh_check=1</td>
</tr>
<tr>
<td>skip_reset_slave</td>
<td>No</td>
<td>Local/App/Global</td>
<td>0</td>
<td>skip_reset_slave=1</td>
</tr>
<tr>
<td>user</td>
<td>No</td>
<td>Local/App/Global</td>
<td>root</td>
<td>user=root</td>
</tr>
<tr>
<td>password</td>
<td>No</td>
<td>Local/App/Global</td>
<td>“”(empty string)</td>
<td>password=rootpass</td>
</tr>
<tr>
<td>repl_user</td>
<td>No</td>
<td>Local/App/Global</td>
<td>Master_User value from SHOW SLAVE STATUS</td>
<td>repl_user=repl</td>
</tr>
<tr>
<td>repl_password</td>
<td>No</td>
<td>Local/App/Global</td>
<td>(current replication password)</td>
<td>repl_user=replpass</td>
</tr>
<tr>
<td>disable_log_bin</td>
<td>No</td>
<td>Local/App/Global</td>
<td>0</td>
<td>disable_log_bin=1</td>
</tr>
<tr>
<td>master_pid_file</td>
<td>No</td>
<td>Local/App/Global</td>
<td>“”(empty string)</td>
<td>master_pid_file=/var/lib/mysql/master1.pid</td>
</tr>
<tr>
<td>ssh_user</td>
<td>No</td>
<td>Local/App/Global</td>
<td>current OS user</td>
<td>ssh_user=root</td>
</tr>
<tr>
<td>remote_workdir</td>
<td>No</td>
<td>Local/App/Global</td>
<td>/var/tmp</td>
<td>remote_workdir=/var/log/masterha/app1</td>
</tr>
<tr>
<td>master_binlog_dir</td>
<td>No</td>
<td>Local/App/Global</td>
<td>/var/lib/mysql</td>
<td>master_binlog_dir=/data/mysql1</td>
</tr>
<tr>
<td>log_level</td>
<td>No</td>
<td>App/Global</td>
<td>info</td>
<td>log_level=debug</td>
</tr>
<tr>
<td>manager_workdir</td>
<td>No</td>
<td>App</td>
<td>/var/tmp</td>
<td>manager_workdir=/var/log/masterha</td>
</tr>
<tr>
<td>client_bindir</td>
<td>No</td>
<td>App</td>
<td>-</td>
<td>client_bindir=/usr/mysql/bin</td>
</tr>
<tr>
<td>client_libdir</td>
<td>No</td>
<td>App</td>
<td>-</td>
<td>client_libdir=/usr/lib/mysql</td>
</tr>
<tr>
<td>manager_log</td>
<td>No</td>
<td>App</td>
<td>STDERR</td>
<td>manager_log=/var/log/masterha/app1.log</td>
</tr>
<tr>
<td>check_repl_delay</td>
<td>No</td>
<td>App/Global</td>
<td>1</td>
<td>check_repl_delay=0</td>
</tr>
<tr>
<td>check_repl_filter</td>
<td>No</td>
<td>App/Global</td>
<td>1</td>
<td>check_repl_filter=0</td>
</tr>
<tr>
<td>latest_priority</td>
<td>No</td>
<td>App/Global</td>
<td>1</td>
<td>latest_priority=0</td>
</tr>
<tr>
<td>multi_tier_slave</td>
<td>No</td>
<td>App/Global</td>
<td>0</td>
<td>multi_tier_slave=1</td>
</tr>
<tr>
<td>ping_interval</td>
<td>No</td>
<td>App/Global</td>
<td>3</td>
<td>ping_interval=5</td>
</tr>
<tr>
<td>ping_type</td>
<td>No</td>
<td>App/Global</td>
<td>SELECT</td>
<td>ping_type=CONNECT</td>
</tr>
<tr>
<td>secondary_check_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>secondary_check_script= masterha_secondary_check -s remote_dc1 -s remote_dc2</td>
</tr>
<tr>
<td>master_ip_failover_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>master_ip_failover_script=/usr/local/bin/master_ip_failover</td>
</tr>
<tr>
<td>master_ip_online_change_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>master_ip_online_change_script= /usr/local/bin/master_ip_online_change</td>
</tr>
<tr>
<td>shutdown_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>shutdown_script= /usr/local/bin/master_shutdown</td>
</tr>
<tr>
<td>report_script</td>
<td>No</td>
<td>App/Global</td>
<td>null</td>
<td>report_script= /usr/local/bin/report</td>
</tr>
</tbody>
</table>
<h4 id="详情解释"><a href="#详情解释" class="headerlink" title="详情解释"></a>详情解释</h4><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br></pre></td><td class="code"><pre><span class="line">Local Scope:        针对每个server级别有效的选项.local scope级别的参数需要在配置文件的 [server_xxx]段落配置  </span><br><span class="line">App Scope:          这个参数可以理解为针对一组master-slave集群. 这些参数需要在 [server_default]段落配置  </span><br><span class="line">Global Scope:       这个参数针对所有的MHA管理的实例. global scope级别的配置只有你在使用一个manager server管理多组master-slave时使用 </span><br><span class="line">hostname：          目标Mysql服务器的主机名或者IP地址,这个参数是强制的,并且必须配置在[server_xxx]段落</span><br><span class="line">ip：                目标Mysql服务器的IP地址,默认是通过$hostname变量获取.MHA manager和MHA Node</span><br><span class="line">                    内部使用这个IP地址链接到Mysql和SSH.通常你不需要配置这个参数,因为它可以通过$hostname解析获得</span><br><span class="line">port：              mysql服务器使用的端口号,默认是3306,MHA链接到mysql通过IP地址和端口</span><br><span class="line">ssh_host：          从0.53版本开始支持此参数,此参数的主要目的在于你mysql复制使用的IP地址由于安全策略,不能直接连接,</span><br><span class="line">                    所以需要通过其他IP和端口连接到mysql server或者ssh,默认这个参数和hostname的值相同</span><br><span class="line">ssh_ip：            从0.53版本开始支持此参数,连接到目标mysql server的ssh ip地址,默认从$ssh_host获取</span><br><span class="line">ssh_port：          从0.53版本开始支持此参数,连接到目标mysql server的ssh端口,默认是22</span><br><span class="line">ssh_connection_timeout：从0.54开始支持此参数,默认是5秒,添加此参数的原因是以前我们在程序里面写死了</span><br><span class="line">ssh_options：       从0.53开始支持此参数,可以添加SSH命令行的参数</span><br><span class="line">candidate_master：  </span><br><span class="line">你的slave的硬件配置或者用途可能不太一样,你想要提升更加可靠的slave作为新的master</span><br><span class="line">如果设置candidate_master的值为1,那么这个server会优先成为master,只要它满足成为master的条件(binlog开启的,没有严重的复制延时等)</span><br><span class="line">所以意味着配置了candiate_master=1的服务器并不是肯定可以成为new master,但是这个参数能够帮助提高优先级</span><br><span class="line">如果你在多个服务器上设置了candidate_master=1,那么在配置文件中[server_xxx]的配置顺序,会成为第二排序规则,排在上面的越优先</span><br><span class="line">no_master：         no_master=1是默认值,意思是这个server从来不会成为新的master,这个参数用来标记某些从来不用成为new master的服务器</span><br><span class="line">ignore_fail：       </span><br><span class="line">默认是0,当某个slave的ssh或者mysql当掉或者复制失败的时候,MHA manager不启动failover。</span><br><span class="line">但是有些环境下,你想要在某个特定的slave失败的时候继续执行failover,把么就设置这个ignore_fail=1,即时这个slave失败的时候,failover依然继续执行</span><br><span class="line">skip_init_ssh_check：启动的时候跳过ssh连接测试</span><br><span class="line">skip_reset_slave：  从0.56版本开始支持此参数,在master执行failover以后跳过执行<span class="keyword">reset</span> <span class="keyword">slave</span> all(译者感觉应该是方便MM复制的后期恢复)</span><br><span class="line"><span class="keyword">user</span>：              mysql管理员命令,建议赋予all <span class="keyword">privileges</span>权限</span><br><span class="line"><span class="keyword">password</span>：          上面mysql <span class="keyword">user</span>的密码</span><br><span class="line">repl_user：         mysql复制使用的用户名,需要执行<span class="keyword">change</span> <span class="keyword">master</span> <span class="keyword">to</span>命令和<span class="keyword">show</span> <span class="keyword">slave</span> <span class="keyword">status</span>命令等.一般赋予<span class="keyword">replication</span> <span class="keyword">slave</span>,<span class="keyword">replication</span> <span class="keyword">client</span>权限</span><br><span class="line">repl_password：     上面用户对应的密码.默认情况下,使用的是当前复制的密码</span><br><span class="line">disable_log_bin：   当这个参数设置以后,当应用差异日志到<span class="keyword">slave</span>的时候,<span class="keyword">slave</span>不会生成binlog. Internally MHA passes <span class="comment">--disable-log-bin to mysqlbinlog command</span></span><br><span class="line">master_pid_file：   设置<span class="keyword">master</span>的pid文件位置,当你的服务器上运行了多个mysql的时候使用</span><br><span class="line">ssh_user：          </span><br><span class="line">MHA manager和MHA node通过这个用户连接到mysql <span class="keyword">server</span>的OS上,在对应的OS上执行相关命令和拷贝差异日志等等</span><br><span class="line">这个用户必须有读取mysql <span class="built_in">binary</span>/relay 相关日志文件的权限,还有日志目录的写入权限.(remote_workdir目录)</span><br><span class="line">这个用户必须可以直接连接到服务器上,不用任何交互的操作.通过使用ssh <span class="keyword">public</span> <span class="keyword">key</span>作为认证方式.默认使用的用户是manager当前的用户</span><br><span class="line">remote_workdir：    </span><br><span class="line">每个MHA node上,MHA工作使用的目录的绝对路径.如果目录不存在,MHA会自动创建,如果权限不够,那么MHA node会意外终止,</span><br><span class="line">注意MHA manager和MHA node都不会检查这个目录的磁盘可用空间,你需要自己保证有足够的可用空间.默认的remote_workdir是<span class="string">'/var/tmp'</span></span><br><span class="line">master_binlog_dir： </span><br><span class="line"><span class="keyword">master</span> mysql保存<span class="keyword">binlog</span>的目录的绝对路径.如果参数的主要目的是在<span class="keyword">master</span> mysql宕机以后,为了通过ssh拷贝需要的<span class="keyword">binlog</span> <span class="keyword">event</span></span><br><span class="line">这个参数是需要的,因为当mysql宕机以后,没法自动获取<span class="built_in">binary</span> <span class="keyword">log</span>的目录</span><br><span class="line">默认情况下,master_binlog_dir的值是<span class="string">"/var/lib/mysql/,/var/log/mysql/"</span>,/<span class="keyword">var</span>/lib/mysql/是大部分mysql发布版本的默认mysql输出目录,</span><br><span class="line">你可以设置多个目录,使用逗号分隔.比如(/data1,/data2,/data3)</span><br><span class="line">log_level：         MHA manager 的日志级别,默认是info级别,在大多数环境下没有问题.可用的级别有.debug/info/<span class="keyword">warning</span>/<span class="keyword">error</span></span><br><span class="line">manager_workdir：   MHA manager使用的工作目录,如果没有设置,默认使用/<span class="keyword">var</span>/tmp</span><br><span class="line">client_bindir：     如果mysql命令行工具没有安装在默认目录,可以使用这个选项配置</span><br><span class="line">client_libdir：     如果mysql lib没有安装在默认目录,可以使用这个选项配置</span><br><span class="line">manager_log：       MHA manager日志文件的绝对目录和文件名,如果没有设置,那么将直接打印到标准输出和标准错误输出</span><br><span class="line">当执行交互式的<span class="keyword">failover</span>时,MHA manager将会忽略manager_log设置,直接答应到标准输出和标准错误输出</span><br><span class="line">check_repl_delay：  </span><br><span class="line">默认情况下如果一个<span class="keyword">slave</span>比<span class="keyword">master</span>延时了<span class="number">100</span>M的relay logs.MHA不会选择这个<span class="keyword">slave</span>作为新的master.因为他需要更多的时间来<span class="keyword">recovery</span></span><br><span class="line">设置check_repl_delay=<span class="number">0</span>,MHA在选择<span class="keyword">new</span> <span class="keyword">master</span>时将会忽略复制的延时.这个参数通常和candidate_master=<span class="number">1</span>同时使用</span><br><span class="line">check_repl_filter： </span><br><span class="line">默认情况下如果<span class="keyword">master</span>和<span class="keyword">slave</span>有不同的<span class="built_in">binary</span> <span class="keyword">log</span>/<span class="keyword">replication</span> 过滤规则的话,MHA打印错误,不进行<span class="keyword">start</span> <span class="keyword">monitoring</span>或者<span class="keyword">failover</span></span><br><span class="line">这么做的目的是为了避免<span class="keyword">recover</span>的时候出现意外的错误,例如<span class="string">"Table not exists"</span>,如果你<span class="number">100</span>%确定你不同的过滤规则不会导致<span class="keyword">recover</span>时候报错,</span><br><span class="line">那么你可以设置check_repl_fiter=<span class="number">0</span>,这样的话,MHA在应用差异日志的时候将不会在检查过滤规则.使用这个参数的时候需要非常小心</span><br><span class="line">latest_priority：   默认情况下,接收到了最新的<span class="keyword">binlog</span>的<span class="keyword">slave</span>优先被选为<span class="keyword">new</span> <span class="keyword">master</span>,如果你想要控制优先级的顺序,比如(host2&gt;host3&gt;host4),那么设置latest_priority=<span class="number">0</span>会有所帮助</span><br><span class="line">multi_tier_slave：  </span><br><span class="line">MHA manager从<span class="number">0.5</span><span class="number">.2</span>开始支持多主复制.默认情况下,它不支持三层以上的复制架构.例如,host2是host1的<span class="keyword">slave</span>,host3是host2的<span class="keyword">slave</span>,</span><br><span class="line">默认不允许把这个三个主机写到同一个配置文件中因为这是一个三层的复制架构,并且MHA会因此报错,并停止工作.如果设置了multi_tier_slave,</span><br><span class="line">MHA manager不会因为多层架构而终止,它会忽略三层及以上的主机,例如<span class="keyword">master</span>(host1)挂掉以后,host2会被选为新的<span class="keyword">master</span>,host3将继续从host2复制</span><br><span class="line">ping_interval：     </span><br><span class="line">这个参数声明MHA manager pings(通过执行<span class="keyword">sql</span>来ping) <span class="keyword">master</span>的间隔.当连续三次ping失败,MHA manager认为这个Mysql <span class="keyword">master</span>宕机,从宕机到检测到宕机,</span><br><span class="line">最大的消耗时间是这个参数的四倍,这个参数默认值是<span class="number">3</span>(<span class="number">3</span>秒),如果MHA manager因为权限问题多次连接失败,这不认为<span class="keyword">master</span> dead</span><br><span class="line">ping_type：</span><br><span class="line">从MHA manager <span class="number">0.53</span>开始支持这个参数, MHA建立一个长连接到<span class="keyword">master</span>,然后通过执行<span class="string">"SELECT 1"</span> (ping_type=<span class="keyword">SELECT</span>)来判断<span class="keyword">master</span>是否可用</span><br><span class="line">但是在一些环境下,最好使用短连接的方式,因为这样的方式更严格,也能检测TCP连接级别的失败.设置ping_type=<span class="keyword">CONNECT</span>可以实现.从<span class="number">0.56</span>版本开始,支持ping_type=<span class="keyword">INSERT</span></span><br><span class="line">secondary_check_script：</span><br><span class="line">通常情况,强力推荐使用两个或者多个路由检测Mysql <span class="keyword">master</span>默认MHA通过一个路由检测:从manager到master.这是不推荐的</span><br><span class="line">MHA manager可以通过secondary_check_script参数调用一个内部脚本来实现两个或者多个路由的检测.下面是一个配置实例</span><br><span class="line">secondary_check_script = masterha_secondary_check -s remote_host1 -s remote_host2</span><br><span class="line">MHA manager包含masterha_secondary_check 脚本.内置的masterha_secondary_check脚本可以满足大多是环境,当然你也可以调用你自定义的脚本.</span><br><span class="line">在上面的实例中,MHA manager通过这两个路由检测<span class="keyword">master</span>主机</span><br><span class="line">Manager-(A)-&gt;remote_host1-(B)-&gt;master_host</span><br><span class="line">Manager-(A)-&gt;remote_host2-(B)-&gt;master_host</span><br><span class="line">如果两条路径中,A都是成功的,B都是不成功的,那么masterha_secondary_check将会退出,返回状态<span class="number">0.</span>MHA manager将会认为Mysql <span class="keyword">master</span>宕机,开始<span class="keyword">failover</span></span><br><span class="line">如果A失败,那么masterha_secondary_check将退出,返回状态<span class="number">2</span>,MHA manager网络出现问题,不会开始<span class="keyword">failover</span></span><br><span class="line">如果B检测成功,masterha_secondary_check退出并返回状态<span class="number">3</span>,MHA manager明确的知道mysql <span class="keyword">master</span>是活跃的,不开始<span class="keyword">failover</span></span><br><span class="line">通常来讲,remote_host1和remote_host2必须和 MHA manager及Mysql <span class="keyword">server</span>不在同一个网段,这样才更有意义</span><br><span class="line">MHA调用secondary_check_script参数对应的脚本会自动传递以下参数(所以你不需要在配置文件中设置),</span><br><span class="line">masterha_secondary_check适用于大多数环境,如果你需要其他的功能可以自己写一个网络检查的脚本.</span><br><span class="line"><span class="comment">--user=(SSH username of the remote hosts. ssh_user parameter value will be passed)</span></span><br><span class="line"><span class="comment">--master_host=(master's hostname)</span></span><br><span class="line"><span class="comment">--master_ip=(master's ip address)</span></span><br><span class="line"><span class="comment">--master_port=(master's port number)</span></span><br><span class="line">注意:</span><br><span class="line">masterha_secondary_check脚本依赖于IO::Socket::INET perl包,在perl v5<span class="number">.6</span><span class="number">.0</span>中默认包含,masterha_secondary_check脚本会通过</span><br><span class="line">ssh连接到所有的remote servers.所以SSH <span class="keyword">public</span> <span class="keyword">key</span> 认证需要设置.另外masterha_secondary_check脚本尝试使用TCP连接从remote <span class="keyword">server</span>到mysql master.这意味着服务器设置的max_connections参数对此连接无效,并且如果TCP连接成功,Aborted_connects状态将会加<span class="number">1</span></span><br><span class="line">master_ip_failover_script：</span><br><span class="line">常见的HA环境下,大多是情况会给<span class="keyword">master</span>分配一个虚拟IP,如果<span class="keyword">master</span>宕机,HA软件像一个Pacemaker将虚拟IP转移到备用的<span class="keyword">master</span>上</span><br><span class="line">另外一种常见的方法就是创建一个全局目录数据库,包含所有应用和writer/reader ip地址.例如&#123;app_master1,<span class="number">192.168</span><span class="number">.0</span><span class="number">.1</span>&#125;,&#123;app_master2,<span class="number">192.168</span><span class="number">.0</span><span class="number">.2</span>&#125;...,代替使用虚拟IP,</span><br><span class="line">这种情况,你需要在<span class="keyword">master</span>宕机的时候更新目录数据库</span><br><span class="line">两种方法都有好的或者不好的地方,MHA不强制要求使用哪一种,但是提供了master_ip_failover_script参数来完成此目的</span><br><span class="line">换句话说,你需要写一个脚本来调整应用服务连接到新的<span class="keyword">master</span>,然后定义master_ip_failover_script的参数,下面是一个实例</span><br><span class="line">master_ip_failover_script= /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/master_ip_failover</span><br><span class="line">你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/master_ip_failover找到一个简单的脚本.这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">MHA manager会调用master_ip_failover_script三次,</span><br><span class="line">第一次,在开始<span class="keyword">master</span> monitor之前调用(目的是检查脚本是否可用),</span><br><span class="line">第二次是在调用shutdown_script脚本前调用,</span><br><span class="line">第三次是在<span class="keyword">new</span> <span class="keyword">master</span>应用完所有的差异日志以后,MHA manager会传递给脚本如下参数.(你不用在配置文件中指明这些参数)</span><br><span class="line">Checking phase</span><br><span class="line"><span class="comment">--command=status</span></span><br><span class="line"><span class="comment">--ssh_user=(current master's ssh username)</span></span><br><span class="line"><span class="comment">--orig_master_host=(current master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(current master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(current master's port number)</span></span><br><span class="line"><span class="keyword">Current</span> <span class="keyword">master</span> <span class="keyword">shutdown</span> phase</span><br><span class="line"><span class="comment">--command=stop or stopssh</span></span><br><span class="line"><span class="comment">--ssh_user=(dead master's ssh username, if reachable via ssh)</span></span><br><span class="line"><span class="comment">--orig_master_host=(current(dead) master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(current(dead) master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(current(dead) master's port number)</span></span><br><span class="line"><span class="keyword">New</span> <span class="keyword">master</span> activation phase</span><br><span class="line"><span class="comment">--command=start</span></span><br><span class="line"><span class="comment">--ssh_user=(new master's ssh username)</span></span><br><span class="line"><span class="comment">--orig_master_host=(dead master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(dead master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(dead master's port number)</span></span><br><span class="line"><span class="comment">--new_master_host=(new master's hostname)</span></span><br><span class="line"><span class="comment">--new_master_ip=(new master's ip address)</span></span><br><span class="line"><span class="comment">--new_master_port(new master's port number)</span></span><br><span class="line"><span class="comment">--new_master_user=(new master's user)</span></span><br><span class="line"><span class="comment">--new_master_password(new master's password)</span></span><br><span class="line">如果你使用共享虚拟IP的方法,你不需要在<span class="keyword">master</span> <span class="keyword">shutdown</span>阶段做任何事情,只要通过shutdown_script脚本关掉原来<span class="keyword">master</span>的电源,在激活<span class="keyword">new</span> <span class="keyword">master</span>阶段,</span><br><span class="line">你需要分配虚拟IP给<span class="keyword">new</span> master.如果你使用目录数据库的方法,你需要在宕机的<span class="keyword">master</span> <span class="keyword">shutdown</span>阶段删除或者更新失效<span class="keyword">master</span>的记录</span><br><span class="line">在<span class="keyword">new</span> <span class="keyword">master</span>生效阶段需要插入或者更新<span class="keyword">new</span> <span class="keyword">master</span>的记录.另外你可以做任何事情来保证应用程序可以成功的写入<span class="keyword">new</span> <span class="keyword">master</span></span><br><span class="line">比如<span class="keyword">SET</span> <span class="keyword">GLOBAL</span> read_only=<span class="number">0</span>，创建有写入权限的数据库用户等等</span><br><span class="line">MHA manager检查脚本的退出状态,如果脚本退出状态是<span class="number">0</span>或者<span class="number">10</span>,MHA manager继续操作,如果脚本退出状态不是<span class="number">0</span>或者<span class="number">10</span>,MHA manager将会意外终止,并不继续continue failover.默认这个参数是空的</span><br><span class="line">master_ip_online_change_script：</span><br><span class="line">这是几个简单版本的master_ip_failover_script参数,但是<span class="keyword">master</span> <span class="keyword">failover</span>命令并不调用它.master <span class="keyword">online</span> <span class="keyword">change</span>命令会调用它.(masterha_master_switch <span class="comment">--master_state=alive),传递以下参数</span></span><br><span class="line"><span class="keyword">Current</span> <span class="keyword">master</span> write freezing phase</span><br><span class="line"><span class="comment">--command=stop or stopssh</span></span><br><span class="line"><span class="comment">--orig_master_host=(current master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(current master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(current master's port number)</span></span><br><span class="line"><span class="comment">--orig_master_user=(current master's user)</span></span><br><span class="line"><span class="comment">--orig_master_password=(current master's password)</span></span><br><span class="line"><span class="comment">--orig_master_ssh_user=(from 0.56, current master's ssh user)</span></span><br><span class="line"><span class="comment">--orig_master_is_new_slave=(from 0.56, notifying whether the orig master will be new slave or not)</span></span><br><span class="line"><span class="keyword">New</span> <span class="keyword">master</span> granting write phase</span><br><span class="line"><span class="comment">--command=start</span></span><br><span class="line"><span class="comment">--orig_master_host=(orig master's hostname)</span></span><br><span class="line"><span class="comment">--orig_master_ip=(orig master's ip address)</span></span><br><span class="line"><span class="comment">--orig_master_port=(orig master's port number)</span></span><br><span class="line"><span class="comment">--new_master_host=(new master's hostname)</span></span><br><span class="line"><span class="comment">--new_master_ip=(new master's ip address)</span></span><br><span class="line"><span class="comment">--new_master_port(new master's port number)</span></span><br><span class="line"><span class="comment">--new_master_user=(new master's user)</span></span><br><span class="line"><span class="comment">--new_master_password=(new master's password)</span></span><br><span class="line"><span class="comment">--new_master_ssh_user=(from 0.56, new master's ssh user)</span></span><br><span class="line">MHA在当前的<span class="keyword">master</span> write freezing阶段后执行FLUASH <span class="keyword">TABLES</span> <span class="keyword">WITH</span> <span class="keyword">READ</span> <span class="keyword">LOCK</span>, 在<span class="keyword">new</span> mastergranting write阶段你可以执行一些类似master_ip_failover_script的操作</span><br><span class="line">比如创建一个有写入权限的用户,执行<span class="keyword">SET</span> <span class="keyword">GLOBAL</span> read_only=<span class="number">0</span>,更新目录数据库等.如果你的脚本退出返回状态不是<span class="number">1</span>或者<span class="number">10</span>,那么MHA manager将会意外终止,</span><br><span class="line">停止<span class="keyword">master</span> <span class="keyword">switch</span>这个参数默认为空,所以MHA manager不做任何调用你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/master_ip_online_change找到一个简单的脚本</span><br><span class="line">这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">shutdown_script：</span><br><span class="line">你可能需要强制关闭<span class="keyword">master</span>服务器,避免他再次提供服务,这对于避免脑裂很重要.下面是一个实例</span><br><span class="line">shutdown_script= /usr/<span class="keyword">local</span>/<span class="keyword">bin</span>/power_manager</span><br><span class="line">你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/power_manager找到一个简单的脚本.这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">在调用shutdown_script脚本之前,MHA manager内部会通过ssh尝试连接到mysql <span class="keyword">master</span>,如果ssh可以连接(意思就是OS是存活的,但是Mysqld没有运行),MHAmanager就会传递下面的参数</span><br><span class="line"><span class="comment">--command=stopssh (这个意思就是指停止服务,不会关机)</span></span><br><span class="line"><span class="comment">--ssh_user=(ssh username so that you can connect to the master)</span></span><br><span class="line"><span class="comment">--host=(master's hostname)</span></span><br><span class="line"><span class="comment">--ip=(master's ip address)</span></span><br><span class="line"><span class="comment">--port=(master's port number)</span></span><br><span class="line"><span class="comment">--pid_file=(master's pid file)</span></span><br><span class="line">如果<span class="keyword">master</span>主机的ssh不能连接,那么MHA会使用如下参数</span><br><span class="line"><span class="comment">--command=stop (这个会通过fence设备关掉电源)</span></span><br><span class="line"><span class="comment">--host=(master's hostname)</span></span><br><span class="line"><span class="comment">--ip=(master's ip address)</span></span><br><span class="line">这个脚本的大概功能如下,如果<span class="comment">--command=stopssh被调用,脚本会使用killall -9 杀掉目标服务器上所有的mysqld_safe服务</span></span><br><span class="line">如果<span class="comment">--pid_file被设置,脚本尝试kill指定的进程.如果脚本执行成功,那么脚本会退出返回状态10.如果退出状态为10,</span></span><br><span class="line">MHA manager后面会通过ssh连接到<span class="keyword">master</span>,获取需要的<span class="built_in">binary</span> log.如果脚本通过ssh连接到服务器失败,那么就会传递<span class="comment">--command=stop参数,这个参数尝试关闭机器的电源,</span></span><br><span class="line">关闭电源依赖于H/W.HP(ILO),DELL(DRAC).如果<span class="keyword">power</span> <span class="keyword">off</span>成功,脚本会然会状态<span class="number">0</span>,其他情况会返回状态<span class="number">1.</span>当返回状态是<span class="number">0</span>的时候MHA manager </span><br><span class="line">开始failover.如果返回状态不是<span class="number">0</span>或者<span class="number">10</span>,那么MHA manager会意外终止.这个参数默认是空,所以MHA manager不会调用任何脚本</span><br><span class="line">另外,MHA manager在启动<span class="keyword">monitoring</span>之前调用shutdown_script.这时候会传递下面的参数.目的是检测脚本是否可用,如果发现错误,你可以提前知道</span><br><span class="line"><span class="comment">--command=status</span></span><br><span class="line"><span class="comment">--host=(master's hostname)</span></span><br><span class="line"><span class="comment">--ip=(master's ip address)</span></span><br><span class="line">report_script：</span><br><span class="line">你希望当<span class="keyword">failover</span>发生以后可以发送一个报告(例如email),report_script可以达到这个目的,MHA manager传递下面的参数</span><br><span class="line"><span class="comment">--orig_master_host=(dead master's hostname)</span></span><br><span class="line"><span class="comment">--new_master_host=(new master's hostname)</span></span><br><span class="line"><span class="comment">--new_slave_hosts=(new slaves' hostnames, delimited by commas)</span></span><br><span class="line"><span class="comment">--subject=(mail subject)</span></span><br><span class="line"><span class="comment">--body=(body)</span></span><br><span class="line">默认这个参数是空的,所以MHA manager不调用任何脚本，你可以从(MHA Manager <span class="keyword">package</span>)/samples/scripts/send_report找到一个简单的脚本</span><br><span class="line">这个脚本在manager的tarball和GitHUb branch中才包含</span><br><span class="line">init_conf_load_script：</span><br><span class="line">这个脚本可以在你不想在配置文件中写明文密码的时候使用.你可以覆盖全局配置参数.实例脚本如下</span><br><span class="line">#!/usr/<span class="keyword">bin</span>/perl</span><br><span class="line">print <span class="string">"password=$ROOT_PASS\n"</span>;</span><br><span class="line">print "repl_password=$REPL_PASS\n";</span><br><span class="line">这个参数默认为空,所以MHA manager默认不调用任何脚本</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>MySQL Master High Available 理论篇：<br><a href="https://yq.aliyun.com/articles/58004?spm=5176.100239.blogcont57855.9.jUuCt0" target="_blank" rel="noopener">https://yq.aliyun.com/articles/58004?spm=5176.100239.blogcont57855.9.jUuCt0</a></p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>云服务器上MySQL高可用，也可通过云负载均衡产品+MySQL复制来实现，但在数据安全性上，没有MHA+VIP+MySQL相对安全。</p>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/MongoDB从MMAPv1在线迁移至WiredTiger引擎.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/MongoDB从MMAPv1在线迁移至WiredTiger引擎.html" itemprop="url">MongoDB从MMAPv1在线迁移至WiredTiger引擎</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-21T16:33:46+08:00">
                2017-07-21
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/mongodb/" itemprop="url" rel="index">
                    <span itemprop="name">mongodb</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>MongoDB是一个开源的文档型数据库，介于关系数据库和非关系数据库之间，是非关系数据库中功能最丰富，最像关系数据库的。它支持的数据结构非常松散，是类似json的bson格式，因此可以存储比较复杂的数据类型。Mongo最大的特点是它支持的查询语言非常强大，其语法有点类似于面向对象的查询语言，几乎可以实现类似关系数据库单表查询的绝大部分功能，而且还支持对数据建立索引。</p>
<h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><p>存储引擎是MongoDB的核心组件，负责管理数据如何存储在硬盘和内存上。从MongoDB3.0版本开始，MongoDB支持多数据存储引擎，如WiredTiger，MMAPv1，In-Memory等，每个存储引擎都有自己的优势，percona版本还支持RocksDB引擎。从3.2版本开始，WiredTiger成为了默认的存储引擎，在之前版本MMAPv1为默认存储引擎。这两种引擎在目前的使用量占比最大。</p>
<h3 id="WiredTiger、MMAPv1对比"><a href="#WiredTiger、MMAPv1对比" class="headerlink" title="WiredTiger、MMAPv1对比"></a>WiredTiger、MMAPv1对比</h3><h4 id="性能、性能"><a href="#性能、性能" class="headerlink" title="性能、性能"></a>性能、性能</h4><p>MMAPv1引擎使用的是表级锁，当单个集合上有并发操作时，吞吐会受限制。<br>Wiredtiger引擎使用文档级锁，通过多版本并发控制，带来并发和吞吐的提高。  </p>
<h4 id="压缩、加密"><a href="#压缩、加密" class="headerlink" title="压缩、加密"></a>压缩、加密</h4><p>MMAPv1引擎要求数据在内存和在磁盘的形式一致(map磁盘内存映射)，因此不支持压缩和加密。<br>Wiredtiger引擎支持对所有集合和索引进行Block压缩和前缀压缩，可以大大节省存储空间。但是消耗额外的CPU执行数据压缩和解压缩的操作。  </p>
<h4 id="存储方式"><a href="#存储方式" class="headerlink" title="存储方式"></a>存储方式</h4><p>MMAPv1引擎在数据库级别配置文件，数据库中的所有集合和索引都混合存储在数据库文件中，即使删掉了某个集合或者索引，占用的磁盘空间也很难回收。<br>WiredTiger引擎在集合和索引级别分配文件，数据库中的所有集合和索引都存储在单独的文件中，集合或者索引删除后，磁盘空间方便回收。  </p>
<h4 id="内存使用"><a href="#内存使用" class="headerlink" title="内存使用"></a>内存使用</h4><p>MMAPv1引擎消耗内存大，无有效控制手段。<br>WiredTiger引擎支持内存使用空间配置，可通过storage.wiredTiger.engineConfig.cacheSizeGB参控制MongoDB所能使用的最大内存。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：centos 6.5 x86_64</p>
<h2 id="迁移"><a href="#迁移" class="headerlink" title="迁移"></a>迁移</h2><p>变更存储引擎的常见方式有2种，分别是停机和不停机。本文只介绍在不停机的情况下从MMAPv1引擎副本集迁移至WiredTiger引擎副本集。</p>
<h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><p>注意：  </p>
<p><font color="#dd0000">迁移的成功取决于oplog的大小是否能够满足从库完全初始化数据。  </font><br><br>首先安装好mongodb，并依次启动，实例以3.4.4版本为例，端口分别是27017/28017/29017，部署在一台服务器，具体安装步骤省略。<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# /usr/local/mongodb1/bin/mongod -f /hwdata/data/mongodb1/conf/mongodb.conf </span><br><span class="line">note: noprealloc may hurt performance <span class="keyword">in</span> many applications</span><br><span class="line">about <span class="keyword">to</span> fork child process, waiting until<span class="built_in"> server </span>is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 14873</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# /usr/local/mongodb2/bin/mongod -f /hwdata/data/mongodb2/conf/mongodb.conf   </span><br><span class="line">note: noprealloc may hurt performance <span class="keyword">in</span> many applications</span><br><span class="line">about <span class="keyword">to</span> fork child process, waiting until<span class="built_in"> server </span>is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 14894</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# /usr/local/mongodb3/bin/mongod -f /hwdata/data/mongodb3/conf/mongodb.conf   </span><br><span class="line">note: noprealloc may hurt performance <span class="keyword">in</span> many applications</span><br><span class="line">about <span class="keyword">to</span> fork child process, waiting until<span class="built_in"> server </span>is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: 14919</span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# netstat -tunlp|grep mongo</span><br><span class="line">tcp        0      0 0.0.0.0:27017               0.0.0.0:*                   LISTEN      14873/mongod        </span><br><span class="line">tcp        0      0 0.0.0.0:28017               0.0.0.0:*                   LISTEN      14894/mongod        </span><br><span class="line">tcp        0      0 0.0.0.0:29017               0.0.0.0:*                   LISTEN      14919/mongod</span><br></pre></td></tr></table></figure></p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>详情的配置文件如下：<br><figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">[root@iZuf6c08fdv8duubho2b0rZ ~]</span><span class="comment"># cat /hwdata/data/mongodb1/conf/mongodb.conf </span></span><br><span class="line"><span class="attr">dbpath</span>=/hwdata/data/mongodb1/data</span><br><span class="line"><span class="attr">logpath</span>=/hwdata/data/mongodb1/logs/mongodb.log</span><br><span class="line"><span class="attr">pidfilepath</span>=/hwdata/data/mongodb1/logs/mongodb.pid</span><br><span class="line"><span class="attr">directoryperdb</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">logappend</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">27017</span></span><br><span class="line"><span class="attr">fork</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">noprealloc</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">maxConns</span>=<span class="number">10000</span></span><br><span class="line"><span class="attr">profile</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">slowms</span>=<span class="number">100</span></span><br><span class="line"><span class="attr">journal</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">replSet</span>=jiessie</span><br><span class="line"><span class="attr">storageEngine</span>=mmapv1</span><br><span class="line"><span class="section">[root@iZuf6c08fdv8duubho2b0rZ ~]</span><span class="comment"># cat /hwdata/data/mongodb2/conf/mongodb.conf  </span></span><br><span class="line"><span class="attr">dbpath</span>=/hwdata/data/mongodb2/data</span><br><span class="line"><span class="attr">logpath</span>=/hwdata/data/mongodb2/logs/mongodb.log</span><br><span class="line"><span class="attr">pidfilepath</span>=/hwdata/data/mongodb2/logs/mongodb.pid</span><br><span class="line"><span class="attr">directoryperdb</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">logappend</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">28017</span></span><br><span class="line"><span class="attr">fork</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">noprealloc</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">maxConns</span>=<span class="number">10000</span></span><br><span class="line"><span class="attr">profile</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">slowms</span>=<span class="number">100</span></span><br><span class="line"><span class="attr">journal</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">replSet</span>=jiessie</span><br><span class="line"><span class="attr">storageEngine</span>=mmapv1</span><br><span class="line"><span class="section">[root@iZuf6c08fdv8duubho2b0rZ ~]</span><span class="comment"># cat /hwdata/data/mongodb3/conf/mongodb.conf  </span></span><br><span class="line"><span class="attr">dbpath</span>=/hwdata/data/mongodb3/data</span><br><span class="line"><span class="attr">logpath</span>=/hwdata/data/mongodb3/logs/mongodb.log</span><br><span class="line"><span class="attr">pidfilepath</span>=/hwdata/data/mongodb3/logs/mongodb.pid</span><br><span class="line"><span class="attr">directoryperdb</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">logappend</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">port</span>=<span class="number">29017</span></span><br><span class="line"><span class="attr">fork</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">noprealloc</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">maxConns</span>=<span class="number">10000</span></span><br><span class="line"><span class="attr">profile</span>=<span class="number">1</span></span><br><span class="line"><span class="attr">slowms</span>=<span class="number">100</span></span><br><span class="line"><span class="attr">journal</span>=<span class="literal">true</span></span><br><span class="line"><span class="attr">replSet</span>=jiessie</span><br><span class="line"><span class="attr">storageEngine</span>=mmapv1</span><br></pre></td></tr></table></figure></p>
<h3 id="搭建副本集"><a href="#搭建副本集" class="headerlink" title="搭建副本集"></a>搭建副本集</h3><p>登录其中一个实例，这里以27017为例子，搭建副本<br><figure class="highlight objectivec"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="meta"># /usr/local/mongodb1/bin/mongo</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting to: mongodb:<span class="comment">//127.0.0.1:27017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">&gt; cfg = &#123;_<span class="keyword">id</span>: <span class="string">"jiessie"</span>, members: [&#123;_<span class="keyword">id</span>: <span class="number">0</span>, host: <span class="string">"192.168.7.50:27017"</span>,priority:<span class="number">3</span>&#125;,&#123;_<span class="keyword">id</span>: <span class="number">1</span>, host: <span class="string">"192.168.7.50:28017"</span>,priority:<span class="number">2</span>&#125;,&#123;_<span class="keyword">id</span>: <span class="number">2</span>, host: <span class="string">"192.168.7.50:29017"</span>,priority:<span class="number">3</span>&#125;]&#125;;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : <span class="number">3</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : <span class="number">2</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : <span class="number">3</span></span><br><span class="line">                &#125;</span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br><span class="line">&gt; rs.initiate(cfg);</span><br><span class="line">&#123; <span class="string">"ok"</span> : <span class="number">1</span> &#125;</span><br><span class="line">jiessie:SECONDARY&gt; </span><br><span class="line">jiessie:PRIMARY&gt; rs.status();</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"set"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"date"</span> : ISODate(<span class="string">"2017-07-21T09:47:24.215Z"</span>),</span><br><span class="line">        <span class="string">"myState"</span> : <span class="number">1</span>,</span><br><span class="line">        <span class="string">"term"</span> : NumberLong(<span class="number">1</span>),</span><br><span class="line">        <span class="string">"heartbeatIntervalMillis"</span> : NumberLong(<span class="number">2000</span>),</span><br><span class="line">        <span class="string">"optimes"</span> : &#123;</span><br><span class="line">                <span class="string">"lastCommittedOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"appliedOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"durableOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"PRIMARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : <span class="number">1056</span>,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-07-21T09:47:16Z"</span>),</span><br><span class="line">                        <span class="string">"infoMessage"</span> : <span class="string">"could not find member to sync from"</span>,</span><br><span class="line">                        <span class="string">"electionTime"</span> : Timestamp(<span class="number">1500630354</span>, <span class="number">1</span>),</span><br><span class="line">                        <span class="string">"electionDate"</span> : ISODate(<span class="string">"2017-07-21T09:45:54Z"</span>),</span><br><span class="line">                        <span class="string">"configVersion"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"self"</span> : <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : <span class="number">99</span>,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDurable"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-07-21T09:47:16Z"</span>),</span><br><span class="line">                        <span class="string">"optimeDurableDate"</span> : ISODate(<span class="string">"2017-07-21T09:47:16Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2017-07-21T09:47:22.597Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2017-07-21T09:47:23.554Z"</span>),</span><br><span class="line">                        <span class="string">"pingMs"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"configVersion"</span> : <span class="number">1</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : <span class="number">99</span>,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDurable"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500630436</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">1</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-07-21T09:47:16Z"</span>),</span><br><span class="line">                        <span class="string">"optimeDurableDate"</span> : ISODate(<span class="string">"2017-07-21T09:47:16Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2017-07-21T09:47:22.597Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2017-07-21T09:47:23.527Z"</span>),</span><br><span class="line">                        <span class="string">"pingMs"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"configVersion"</span> : <span class="number">1</span></span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"ok"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">jiessie:PRIMARY&gt;</span><br></pre></td></tr></table></figure></p>
<h4 id="查看存储引擎"><a href="#查看存储引擎" class="headerlink" title="查看存储引擎"></a>查看存储引擎</h4><p>登录其中一个实例，这里以27017为例子，当出现mmapv1时，代表当前使用存储引擎为mmapv1<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo --eval <span class="string">"db.serverStatus()"</span>|grep name</span></span><br><span class="line">                <span class="string">"name"</span> : <span class="string">"mmapv1"</span>,</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta">#</span></span><br></pre></td></tr></table></figure></p>
<h4 id="测试副本集"><a href="#测试副本集" class="headerlink" title="测试副本集"></a>测试副本集</h4><p>登录27017的主库，插入数据，在其他节点上查看<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo </span></span><br><span class="line">MongoDB shell version v3.<span class="number">4.4</span></span><br><span class="line">connecting to: mongodb:<span class="regexp">//</span><span class="number">127.0</span>.<span class="number">0.1</span>:<span class="number">27017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span>.<span class="number">4</span></span><br><span class="line">jiessie:PRIMARY&gt; show dbs;</span><br><span class="line">admin   <span class="number">0.078</span>GB</span><br><span class="line">local  <span class="number">12.072</span>GB</span><br><span class="line">jiessie:PRIMARY&gt; use test11;</span><br><span class="line">switched to db test11</span><br><span class="line">jiessie:PRIMARY&gt; db.tmp11.insert(&#123;<span class="string">"id"</span>:<span class="string">"11"</span>&#125;);</span><br><span class="line">WriteResult(&#123; <span class="string">"nInserted"</span> : <span class="number">1</span> &#125;)</span><br><span class="line">jiessie:PRIMARY&gt; db.tmp11.find();</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5971ced335d36a3364107ac7"</span>), <span class="string">"id"</span> : <span class="string">"11"</span> &#125;</span><br><span class="line">jiessie:PRIMARY&gt; <span class="keyword">exit</span></span><br><span class="line">bye</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo localhost:28017</span></span><br><span class="line">MongoDB shell version v3.<span class="number">4.4</span></span><br><span class="line">connecting to: localhost:<span class="number">28017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span>.<span class="number">4</span></span><br><span class="line">jiessie:SECONDARY&gt; rs.slaveOk();</span><br><span class="line">jiessie:SECONDARY&gt; use test11;</span><br><span class="line">switched to db test11</span><br><span class="line">jiessie:SECONDARY&gt; db.tmp11.find();</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5971ced335d36a3364107ac7"</span>), <span class="string">"id"</span> : <span class="string">"11"</span> &#125;</span><br><span class="line">jiessie:SECONDARY&gt; <span class="keyword">exit</span></span><br><span class="line">bye</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo localhost:29017</span></span><br><span class="line">MongoDB shell version v3.<span class="number">4.4</span></span><br><span class="line">connecting to: localhost:<span class="number">29017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span>.<span class="number">4</span></span><br><span class="line">jiessie:SECONDARY&gt; use test11;</span><br><span class="line">switched to db test11</span><br><span class="line">jiessie:SECONDARY&gt; rs.slaveOk();</span><br><span class="line">jiessie:SECONDARY&gt; db.tmp11.find();</span><br><span class="line">&#123; <span class="string">"_id"</span> : ObjectId(<span class="string">"5971ced335d36a3364107ac7"</span>), <span class="string">"id"</span> : <span class="string">"11"</span> &#125;</span><br><span class="line">jiessie:SECONDARY&gt; <span class="keyword">exit</span></span><br></pre></td></tr></table></figure></p>
<h3 id="迁移步骤"><a href="#迁移步骤" class="headerlink" title="迁移步骤"></a>迁移步骤</h3><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">将<span class="number">29017</span>的从节点设置为隐藏节点，不再成为主，对应用不可见</span><br><span class="line">把<span class="number">29017</span>的节点存储引擎从MMAPv1设置为WiredTiger，删除原MMAPv1数据，重新加入副本集中</span><br><span class="line">当<span class="number">29017</span>的WiredTiger节点从主节点初始化数据成功后，依次将其他从节点的引擎修改为的WiredTiger</span><br><span class="line">当所有从节点的引擎修改为WiredTiger后，在主节点执行rs.stepdown()将主降级，触发在其他从节点选举新主</span><br><span class="line">再将原主库按照以上的方式将引擎从MMAPv1设置为WiredTiger</span><br></pre></td></tr></table></figure>
<p>详情请参考：<a href="http://docs.mongoing.com/manual-zh/tutorial/configure-a-hidden-replica-set-member.html" target="_blank" rel="noopener">http://docs.mongoing.com/manual-zh/tutorial/configure-a-hidden-replica-set-member.html</a></p>
<h3 id="开始迁移"><a href="#开始迁移" class="headerlink" title="开始迁移"></a>开始迁移</h3><p>副本集的架构下，所有节点之间都是同步的，即使存储引擎不同也不受影响。<br>实验中的副本集端口分别为27017/28017/29017，其中主节点为27017，28017和29017为从节点。<br>27017权重为3，28017权重为2，29017权重为1。</p>
<p><font color="#dd0000">步骤最后一项，将原主库引擎从MMAPv1设置为WiredTiger，可在原主库上执行rs.stepDown()触发选举，也可提高其他从节点的权重，需要高于主节点。</font><br></p>
<h4 id="29017实例"><a href="#29017实例" class="headerlink" title="29017实例"></a>29017实例</h4><h5 id="设置节点隐藏"><a href="#设置节点隐藏" class="headerlink" title="设置节点隐藏"></a>设置节点隐藏</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo</span></span><br><span class="line">MongoDB shell <span class="keyword">version</span> v3.4.4</span><br><span class="line">connecting to: mongodb:<span class="string">//127.0.0.1</span><span class="function">:27017</span></span><br><span class="line">MongoDB server <span class="keyword">version</span>: 3.4.4</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg = rs.config<span class="params">()</span>;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"version"</span> : 1,</span><br><span class="line">        <span class="string">"protocolVersion"</span> : NumberLong<span class="params">(1)</span>,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 0,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 3,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 1,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 2,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 2,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 3,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"settings"</span> : &#123;</span><br><span class="line">                <span class="string">"chainingAllowed"</span> : <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"heartbeatIntervalMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"heartbeatTimeoutSecs"</span> : 10,</span><br><span class="line">                <span class="string">"electionTimeoutMillis"</span> : 10000,</span><br><span class="line">                <span class="string">"catchUpTimeoutMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"getLastErrorModes"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"getLastErrorDefaults"</span> : &#123;</span><br><span class="line">                        <span class="string">"w"</span> : 1,</span><br><span class="line">                        <span class="string">"wtimeout"</span> : 0</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"replicaSetId"</span> : ObjectId<span class="params">("5971cd4835e57f0331e944c8")</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[2]<span class="string">.host</span>;</span><br><span class="line">192.168.7.50<span class="function">:29017</span></span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[2]<span class="string">.priority</span> = 0;       <span class="comment">#优化级降为0，不再参数选主</span></span><br><span class="line">0</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[2]<span class="string">.hidden</span> = <span class="literal">true</span>;      <span class="comment">#对应用隐藏</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; rs.reconfig<span class="params">(cfg)</span>;</span><br><span class="line">&#123; <span class="string">"ok"</span> : 1 &#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt;</span><br></pre></td></tr></table></figure>
<h5 id="修改引擎，删除原数据"><a href="#修改引擎，删除原数据" class="headerlink" title="修改引擎，删除原数据"></a>修改引擎，删除原数据</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo localhost:29017</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: localhost:<span class="number">29017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:SECONDARY&gt; rs.slaveOk()<span class="comment">;</span></span><br><span class="line">jiessie:SECONDARY&gt; use admin<span class="comment">;</span></span><br><span class="line">switched <span class="keyword">to</span> db admin</span><br><span class="line">jiessie:SECONDARY&gt; db.shutdownServer()<span class="comment">;                                                      #关闭服务</span></span><br><span class="line">server should be down...</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># rm -rf /hwdata/data/mongodb3/data/*                        #删除原引擎数据</span></span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># cat /hwdata/data/mongodb3/conf/mongodb.conf |grep sto      #查看原配置</span></span><br><span class="line">storageEngine=mmapv1</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># sed -i <span class="string">'s@storageEngine=mmapv1@storageEngine=wiredTiger@g'</span> /hwdata/data/mongodb3/conf/mongodb.conf    #修改配置文件的引擎部分</span></span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># cat /hwdata/data/mongodb3/conf/mongodb.conf |grep sto      #查看新配置</span></span><br><span class="line">storageEngine=wiredTiger</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb3/bin/mongod -f /hwdata/data/mongodb3/conf/mongodb.conf     #启动服务</span></span><br><span class="line">note: noprealloc may hurt performance <span class="keyword">in</span> many applications</span><br><span class="line">about <span class="keyword">to</span> fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: <span class="number">613</span></span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb3/bin/mongo localhost:29017 --eval <span class="string">"db.serverStatus()"</span>|grep <span class="string">'"name"'</span>    #验证是否修改成功</span></span><br><span class="line">                <span class="string">"name"</span> : <span class="string">"wiredTiger"</span>,</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb3/bin/mongo localhost:29017</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: localhost:<span class="number">29017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:SECONDARY&gt; <span class="keyword">exit</span>                     <span class="meta">#验证初始化同步是否成功，SECONDARY状态表示已经是从节点</span></span><br></pre></td></tr></table></figure>
<h5 id="加入副本集"><a href="#加入副本集" class="headerlink" title="加入副本集"></a>加入副本集</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo</span></span><br><span class="line">MongoDB shell <span class="keyword">version</span> v3.4.4</span><br><span class="line">connecting to: mongodb:<span class="string">//127.0.0.1</span><span class="function">:27017</span></span><br><span class="line">MongoDB server <span class="keyword">version</span>: 3.4.4</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg = rs.config<span class="params">()</span>;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"version"</span> : 2,</span><br><span class="line">        <span class="string">"protocolVersion"</span> : NumberLong<span class="params">(1)</span>,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 0,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 3,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 1,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 2,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 2,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 0,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"settings"</span> : &#123;</span><br><span class="line">                <span class="string">"chainingAllowed"</span> : <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"heartbeatIntervalMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"heartbeatTimeoutSecs"</span> : 10,</span><br><span class="line">                <span class="string">"electionTimeoutMillis"</span> : 10000,</span><br><span class="line">                <span class="string">"catchUpTimeoutMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"getLastErrorModes"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"getLastErrorDefaults"</span> : &#123;</span><br><span class="line">                        <span class="string">"w"</span> : 1,</span><br><span class="line">                        <span class="string">"wtimeout"</span> : 0</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"replicaSetId"</span> : ObjectId<span class="params">("5971cd4835e57f0331e944c8")</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[2]<span class="string">.hidden=false</span>;       <span class="comment">#加入副本集，对应用可见，其中[2]表示29017端口</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[2]<span class="string">.priority</span> = 1;       <span class="comment">#修改为之前的优先级</span></span><br><span class="line">1</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; rs.reconfig<span class="params">(cfg)</span>;</span><br><span class="line">&#123; <span class="string">"ok"</span> : 1 &#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt;</span><br></pre></td></tr></table></figure>
<h4 id="28017实例"><a href="#28017实例" class="headerlink" title="28017实例"></a>28017实例</h4><h5 id="设置节点隐藏-1"><a href="#设置节点隐藏-1" class="headerlink" title="设置节点隐藏"></a>设置节点隐藏</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo</span></span><br><span class="line">MongoDB shell <span class="keyword">version</span> v3.4.4</span><br><span class="line">connecting to: mongodb:<span class="string">//127.0.0.1</span><span class="function">:27017</span></span><br><span class="line">MongoDB server <span class="keyword">version</span>: 3.4.4</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg = rs.config<span class="params">()</span>;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"version"</span> : 4,</span><br><span class="line">        <span class="string">"protocolVersion"</span> : NumberLong<span class="params">(1)</span>,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 0,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 3,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 1,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 2,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 2,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 1,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"settings"</span> : &#123;</span><br><span class="line">                <span class="string">"chainingAllowed"</span> : <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"heartbeatIntervalMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"heartbeatTimeoutSecs"</span> : 10,</span><br><span class="line">                <span class="string">"electionTimeoutMillis"</span> : 10000,</span><br><span class="line">                <span class="string">"catchUpTimeoutMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"getLastErrorModes"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"getLastErrorDefaults"</span> : &#123;</span><br><span class="line">                        <span class="string">"w"</span> : 1,</span><br><span class="line">                        <span class="string">"wtimeout"</span> : 0</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"replicaSetId"</span> : ObjectId<span class="params">("5971cd4835e57f0331e944c8")</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[1]<span class="string">.host</span></span><br><span class="line">192.168.7.50<span class="function">:28017</span></span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[1]<span class="string">.priority</span> = 0;</span><br><span class="line">0</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[1]<span class="string">.hidden</span> = <span class="literal">true</span>;</span><br><span class="line"><span class="literal">true</span></span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; rs.reconfig<span class="params">(cfg)</span>;</span><br><span class="line">&#123; <span class="string">"ok"</span> : 1 &#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt;</span><br></pre></td></tr></table></figure>
<h5 id="修改引擎，删除原数据-1"><a href="#修改引擎，删除原数据-1" class="headerlink" title="修改引擎，删除原数据"></a>修改引擎，删除原数据</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo localhost:28017</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: localhost:<span class="number">28017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:SECONDARY&gt; rs.slaveOk()<span class="comment">;</span></span><br><span class="line">jiessie:SECONDARY&gt; use admin<span class="comment">;</span></span><br><span class="line">switched <span class="keyword">to</span> db admin</span><br><span class="line">jiessie:SECONDARY&gt; db.shutdownServer()<span class="comment">;                                                      #关闭服务</span></span><br><span class="line">server should be down...</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># rm -rf /hwdata/data/mongodb2/data/*                        #删除原引擎数据</span></span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># cat /hwdata/data/mongodb2/conf/mongodb.conf |grep sto      #查看原配置</span></span><br><span class="line">storageEngine=mmapv1</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># sed -i <span class="string">'s@storageEngine=mmapv1@storageEngine=wiredTiger@g'</span> /hwdata/data/mongodb2/conf/mongodb.conf    #修改配置文件的引擎部分</span></span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># cat /hwdata/data/mongodb2/conf/mongodb.conf |grep sto      #查看新配置</span></span><br><span class="line">storageEngine=wiredTiger</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb2/bin/mongod -f /hwdata/data/mongodb2/conf/mongodb.conf     #启动服务</span></span><br><span class="line">note: noprealloc may hurt performance <span class="keyword">in</span> many applications</span><br><span class="line">about <span class="keyword">to</span> fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: <span class="number">1275</span></span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb2/bin/mongo localhost:28017 --eval <span class="string">"db.serverStatus()"</span>|grep <span class="string">'"name"'</span>    #验证是否修改成功</span></span><br><span class="line">                <span class="string">"name"</span> : <span class="string">"wiredTiger"</span>,</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb2/bin/mongo localhost:28017</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: localhost:<span class="number">28017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:SECONDARY&gt; <span class="keyword">exit</span>                     <span class="meta">#验证初始化同步是否成功，SECONDARY状态表示已经是从节点</span></span><br></pre></td></tr></table></figure>
<h5 id="加入副本集-1"><a href="#加入副本集-1" class="headerlink" title="加入副本集"></a>加入副本集</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo </span></span><br><span class="line">MongoDB shell <span class="keyword">version</span> v3.4.4</span><br><span class="line">connecting to: mongodb:<span class="string">//127.0.0.1</span><span class="function">:27017</span></span><br><span class="line">MongoDB server <span class="keyword">version</span>: 3.4.4</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg = rs.config<span class="params">()</span>;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"version"</span> : 5,</span><br><span class="line">        <span class="string">"protocolVersion"</span> : NumberLong<span class="params">(1)</span>,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 0,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 3,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 1,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 0,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 2,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 1,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"settings"</span> : &#123;</span><br><span class="line">                <span class="string">"chainingAllowed"</span> : <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"heartbeatIntervalMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"heartbeatTimeoutSecs"</span> : 10,</span><br><span class="line">                <span class="string">"electionTimeoutMillis"</span> : 10000,</span><br><span class="line">                <span class="string">"catchUpTimeoutMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"getLastErrorModes"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"getLastErrorDefaults"</span> : &#123;</span><br><span class="line">                        <span class="string">"w"</span> : 1,</span><br><span class="line">                        <span class="string">"wtimeout"</span> : 0</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"replicaSetId"</span> : ObjectId<span class="params">("5971cd4835e57f0331e944c8")</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[1]<span class="string">.hidden</span> = <span class="literal">false</span>;     <span class="comment">#加入副本集，对应用可见，其中[1]表示28017端口</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[1]<span class="string">.priority</span> = 2;       <span class="comment">#修改为之前的优先级</span></span><br><span class="line">2</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; rs.reconfig<span class="params">(cfg)</span>;</span><br><span class="line">&#123; <span class="string">"ok"</span> : 1 &#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt;</span><br></pre></td></tr></table></figure>
<h4 id="27017实例"><a href="#27017实例" class="headerlink" title="27017实例"></a>27017实例</h4><h5 id="设置节点隐藏-2"><a href="#设置节点隐藏-2" class="headerlink" title="设置节点隐藏"></a>设置节点隐藏</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: mongodb://<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">27017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:PRIMARY&gt; </span><br><span class="line">jiessie:PRIMARY&gt; rs.stepDown()<span class="comment">;</span></span><br><span class="line"><span class="number">2017</span><span class="number">-07</span><span class="number">-22</span>T21:<span class="number">51</span>:<span class="number">26.392</span>+<span class="number">0800</span> E QUERY    [thread1] Error: error doing query: failed: network error <span class="keyword">while</span> attempting <span class="keyword">to</span> <span class="built_in">run</span> command <span class="string">'replSetStepDown'</span> on host <span class="string">'127.0.0.1:27017'</span>  :</span><br><span class="line">DB.prototype.runCommand<span class="symbol">@src</span>/mongo/shell/db.js:<span class="number">132</span>:<span class="number">1</span></span><br><span class="line">DB.prototype.adminCommand<span class="symbol">@src</span>/mongo/shell/db.js:<span class="number">150</span>:<span class="number">16</span></span><br><span class="line">rs.stepDown<span class="symbol">@src</span>/mongo/shell/utils.js:<span class="number">1261</span>:<span class="number">12</span></span><br><span class="line">@(shell):<span class="number">1</span>:<span class="number">1</span></span><br><span class="line"><span class="number">2017</span><span class="number">-07</span><span class="number">-22</span>T21:<span class="number">51</span>:<span class="number">26.394</span>+<span class="number">0800</span> I NETWORK  [thread1] trying reconnect <span class="keyword">to</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">27017</span> (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>) failed</span><br><span class="line"><span class="number">2017</span><span class="number">-07</span><span class="number">-22</span>T21:<span class="number">51</span>:<span class="number">26.394</span>+<span class="number">0800</span> I NETWORK  [thread1] reconnect <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>:<span class="number">27017</span> (<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span>) ok</span><br><span class="line">jiessie:SECONDARY&gt; rs.slaveOk()<span class="comment">;</span></span><br><span class="line">jiessie:SECONDARY&gt; rs.status()<span class="comment">;                     #等待几秒，查看状态，此时28017实例是已经提升为新主库</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"set"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"date"</span> : ISODate(<span class="string">"2017-07-22T13:51:34.336Z"</span>),</span><br><span class="line">        <span class="string">"myState"</span> : <span class="number">2</span>,</span><br><span class="line">        <span class="string">"term"</span> : NumberLong(<span class="number">12</span>),</span><br><span class="line">        <span class="string">"heartbeatIntervalMillis"</span> : NumberLong(<span class="number">2000</span>),</span><br><span class="line">        <span class="string">"optimes"</span> : &#123;</span><br><span class="line">                <span class="string">"lastCommittedOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"appliedOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"durableOpTime"</span> : &#123;</span><br><span class="line">                        <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                        <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : <span class="number">102106</span>,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-07-22T13:51:20Z"</span>),</span><br><span class="line">                        <span class="string">"infoMessage"</span> : <span class="string">"could not find member to sync from"</span>,</span><br><span class="line">                        <span class="string">"configVersion"</span> : <span class="number">6</span>,</span><br><span class="line">                        <span class="string">"self"</span> : <span class="literal">true</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : <span class="number">2403</span>,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDurable"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-07-22T13:51:20Z"</span>),</span><br><span class="line">                        <span class="string">"optimeDurableDate"</span> : ISODate(<span class="string">"2017-07-22T13:51:20Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2017-07-22T13:51:31.557Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2017-07-22T13:51:33.176Z"</span>),</span><br><span class="line">                        <span class="string">"pingMs"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                        <span class="string">"syncingTo"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"configVersion"</span> : <span class="number">6</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"name"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"health"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"state"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"stateStr"</span> : <span class="string">"SECONDARY"</span>,</span><br><span class="line">                        <span class="string">"uptime"</span> : <span class="number">4846</span>,</span><br><span class="line">                        <span class="string">"optime"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDurable"</span> : &#123;</span><br><span class="line">                                <span class="string">"ts"</span> : Timestamp(<span class="number">1500731480</span>, <span class="number">1</span>),</span><br><span class="line">                                <span class="string">"t"</span> : NumberLong(<span class="number">12</span>)</span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"optimeDate"</span> : ISODate(<span class="string">"2017-07-22T13:51:20Z"</span>),</span><br><span class="line">                        <span class="string">"optimeDurableDate"</span> : ISODate(<span class="string">"2017-07-22T13:51:20Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeat"</span> : ISODate(<span class="string">"2017-07-22T13:51:31.557Z"</span>),</span><br><span class="line">                        <span class="string">"lastHeartbeatRecv"</span> : ISODate(<span class="string">"2017-07-22T13:51:30.019Z"</span>),</span><br><span class="line">                        <span class="string">"pingMs"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                        <span class="string">"configVersion"</span> : <span class="number">6</span></span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"ok"</span> : <span class="number">1</span></span><br><span class="line">&#125;</span><br><span class="line">jiessie:SECONDARY&gt; <span class="keyword">exit</span></span><br><span class="line">bye</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo localhost:28017     #登录新主库，原27017实例修改实例引擎</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: localhost:<span class="number">28017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:PRIMARY&gt; cfg = rs.config()<span class="comment">;</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"version"</span> : <span class="number">6</span>,</span><br><span class="line">        <span class="string">"protocolVersion"</span> : NumberLong(<span class="number">1</span>),</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">0</span>,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : <span class="number">3</span>,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                        <span class="string">"votes"</span> : <span class="number">1</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                        <span class="string">"votes"</span> : <span class="number">1</span></span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : <span class="number">2</span>,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong(<span class="number">0</span>),</span><br><span class="line">                        <span class="string">"votes"</span> : <span class="number">1</span></span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"settings"</span> : &#123;</span><br><span class="line">                <span class="string">"chainingAllowed"</span> : <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"heartbeatIntervalMillis"</span> : <span class="number">2000</span>,</span><br><span class="line">                <span class="string">"heartbeatTimeoutSecs"</span> : <span class="number">10</span>,</span><br><span class="line">                <span class="string">"electionTimeoutMillis"</span> : <span class="number">10000</span>,</span><br><span class="line">                <span class="string">"catchUpTimeoutMillis"</span> : <span class="number">2000</span>,</span><br><span class="line">                <span class="string">"getLastErrorModes"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"getLastErrorDefaults"</span> : &#123;</span><br><span class="line">                        <span class="string">"w"</span> : <span class="number">1</span>,</span><br><span class="line">                        <span class="string">"wtimeout"</span> : <span class="number">0</span></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"replicaSetId"</span> : ObjectId(<span class="string">"5971cd4835e57f0331e944c8"</span>)</span><br><span class="line">    essie:PRIMARY&gt; cfg.members[<span class="number">0</span>].priority = <span class="number">0</span><span class="comment">;</span></span><br><span class="line"><span class="number">0</span></span><br><span class="line">jiessie:PRIMARY&gt; cfg.members[<span class="number">0</span>].hidden = <span class="literal">true</span><span class="comment">;</span></span><br><span class="line"><span class="literal">true</span></span><br><span class="line">jiessie:PRIMARY&gt; rs.reconfig(cfg)<span class="comment">;</span></span><br><span class="line">&#123; <span class="string">"ok"</span> : <span class="number">1</span> &#125;</span><br><span class="line">jiessie:PRIMARY&gt;</span><br></pre></td></tr></table></figure>
<h5 id="修改引擎，删除原数据-2"><a href="#修改引擎，删除原数据-2" class="headerlink" title="修改引擎，删除原数据"></a>修改引擎，删除原数据</h5><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo localhost:27017</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: localhost:<span class="number">27017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:SECONDARY&gt; rs.slaveOk()<span class="comment">;</span></span><br><span class="line">jiessie:SECONDARY&gt; use admin<span class="comment">;</span></span><br><span class="line">switched <span class="keyword">to</span> db admin</span><br><span class="line">jiessie:SECONDARY&gt; db.shutdownServer()<span class="comment">;                                                      #关闭服务</span></span><br><span class="line">server should be down...</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># rm -rf /hwdata/data/mongodb1/data/*                        #删除原引擎数据</span></span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># cat /hwdata/data/mongodb1/conf/mongodb.conf |grep sto      #查看原配置</span></span><br><span class="line">storageEngine=mmapv1</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># sed -i <span class="string">'s@storageEngine=mmapv1@storageEngine=wiredTiger@g'</span> /hwdata/data/mongodb1/conf/mongodb.conf    #修改配置文件的引擎部分</span></span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># cat /hwdata/data/mongodb2/conf/mongodb.conf |grep sto      #查看新配置</span></span><br><span class="line">storageEngine=wiredTiger</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongod -f /hwdata/data/mongodb1/conf/mongodb.conf     #启动服务</span></span><br><span class="line">note: noprealloc may hurt performance <span class="keyword">in</span> many applications</span><br><span class="line">about <span class="keyword">to</span> fork child process, waiting <span class="keyword">until</span> server is ready <span class="keyword">for</span> connections.</span><br><span class="line">forked process: <span class="number">2157</span></span><br><span class="line">child process started successfully, parent exiting</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo localhost:27017 --eval <span class="string">"db.serverStatus()"</span>|grep <span class="string">'"name"'</span>    #验证是否修改成功</span></span><br><span class="line">                <span class="string">"name"</span> : <span class="string">"wiredTiger"</span>,</span><br><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> ~]<span class="meta"># /usr/local/mongodb1/bin/mongo localhost:27017</span></span><br><span class="line">MongoDB shell version v3<span class="number">.4</span><span class="number">.4</span></span><br><span class="line">connecting <span class="keyword">to</span>: localhost:<span class="number">27017</span></span><br><span class="line">MongoDB server version: <span class="number">3.4</span><span class="number">.4</span></span><br><span class="line">jiessie:SECONDARY&gt; <span class="keyword">exit</span>                     <span class="meta">#验证初始化同步是否成功，SECONDARY状态表示已经是从节点</span></span><br></pre></td></tr></table></figure>
<h5 id="加入副本集-2"><a href="#加入副本集-2" class="headerlink" title="加入副本集"></a>加入副本集</h5><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># /usr/local/mongodb1/bin/mongo localhost:28017</span></span><br><span class="line">MongoDB shell <span class="keyword">version</span> v3.4.4</span><br><span class="line">connecting to: mongodb:<span class="string">//127.0.0.1</span><span class="function">:27017</span></span><br><span class="line">MongoDB server <span class="keyword">version</span>: 3.4.4</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg = rs.config<span class="params">()</span>;</span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">"_id"</span> : <span class="string">"jiessie"</span>,</span><br><span class="line">        <span class="string">"version"</span> : 7,</span><br><span class="line">        <span class="string">"protocolVersion"</span> : NumberLong<span class="params">(1)</span>,</span><br><span class="line">        <span class="string">"members"</span> : [</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 0,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:27017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 0,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 1,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:28017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 2,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                        <span class="string">"_id"</span> : 2,</span><br><span class="line">                        <span class="string">"host"</span> : <span class="string">"192.168.7.50:29017"</span>,</span><br><span class="line">                        <span class="string">"arbiterOnly"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"buildIndexes"</span> : <span class="literal">true</span>,</span><br><span class="line">                        <span class="string">"hidden"</span> : <span class="literal">false</span>,</span><br><span class="line">                        <span class="string">"priority"</span> : 1,</span><br><span class="line">                        <span class="string">"tags"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                        &#125;,</span><br><span class="line">                        <span class="string">"slaveDelay"</span> : NumberLong<span class="params">(0)</span>,</span><br><span class="line">                        <span class="string">"votes"</span> : 1</span><br><span class="line">                &#125;</span><br><span class="line">        ],</span><br><span class="line">        <span class="string">"settings"</span> : &#123;</span><br><span class="line">                <span class="string">"chainingAllowed"</span> : <span class="literal">true</span>,</span><br><span class="line">                <span class="string">"heartbeatIntervalMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"heartbeatTimeoutSecs"</span> : 10,</span><br><span class="line">                <span class="string">"electionTimeoutMillis"</span> : 10000,</span><br><span class="line">                <span class="string">"catchUpTimeoutMillis"</span> : 2000,</span><br><span class="line">                <span class="string">"getLastErrorModes"</span> : &#123;</span><br><span class="line"></span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"getLastErrorDefaults"</span> : &#123;</span><br><span class="line">                        <span class="string">"w"</span> : 1,</span><br><span class="line">                        <span class="string">"wtimeout"</span> : 0</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="string">"replicaSetId"</span> : ObjectId<span class="params">("5971cd4835e57f0331e944c8")</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[0]<span class="string">.hidden</span> = <span class="literal">false</span>;     <span class="comment">#加入副本集，对应用可见，其中[0]表示27017端口</span></span><br><span class="line"><span class="literal">false</span></span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; cfg.members[0]<span class="string">.priority</span> = 3;       <span class="comment">#修改为之前的优先级</span></span><br><span class="line">3</span><br><span class="line">jiessie<span class="function">:PRIMARY</span>&gt; rs.reconfig<span class="params">(cfg)</span>;</span><br><span class="line">&#123; <span class="string">"ok"</span> : 1 &#125;</span><br><span class="line">jiessie<span class="function">:SECONDARY</span>&gt;                                  <span class="comment">#等待几秒后，PRIMARY会变成SECONDARY</span></span><br></pre></td></tr></table></figure>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>mongodb作为发展迅速的开源数据库一员，版本迭代升级很快，目前使用旧引擎的公司不在小数，新引擎的优点足以促使其升级引擎。</p>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/使用Percona-Data-Recovery-Tool-for-InnoDB恢复数据.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/使用Percona-Data-Recovery-Tool-for-InnoDB恢复数据.html" itemprop="url">使用Percona Data Recovery Tool for InnoDB恢复数据</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-14T14:28:11+08:00">
                2017-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/备份恢复/" itemprop="url" rel="index">
                    <span itemprop="name">备份恢复</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>数据是一个企业最重要的资产，备份的重要性不言而喻，有效的备份能够减少意外情况下的公司损失。当使用MySQL数据库时，mysqldump、mysqlpump、mydumper、xtrabackup等都是不错的备份工具，极端情况下，当开启了binlog，也可以成为恢复的救命稻草。但是，还有存在无备份，没有开启binlog的情况，如果是InnoDB表，这时percona推出的Percona Data Recovery Tool工具可以派上用场。</p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">此工具仅支持InnoDB/XtraDB表，不支持MyISAM表</span><br><span class="line">此工具可恢复数据文件的副本，并不要求是正在运行的MySQL服务器</span><br><span class="line">此工具并不保证数据一定可恢复，如数据被覆盖</span><br><span class="line">支持的误操作类型：<span class="keyword">DELETE</span>、<span class="keyword">TRUNCATE</span>，表格式为<span class="keyword">Compact</span></span><br><span class="line">在文件系统级别删除的文件</span><br><span class="line">如数据文件损失，此工具也无法恢复</span><br></pre></td></tr></table></figure>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>通过尝试在页面中找到有效的行来工作，InnoDB的数据都是索引的方式组织的，所有的数据都是存储在16KB的数据块中，每个页面都有属于特定表的特定索引。恢复时分解所有的数据文件为单个16kb大小的页面，根据每个页面的标记的数据起点开始尝试匹配，如果与给定表定义的属于匹配，则输出匹配记录。</p>
<h2 id="表空间"><a href="#表空间" class="headerlink" title="表空间"></a>表空间</h2><p>当服务器设置了innodb_file_per_table=1时，工具不需要再额外的从ibdata1中拆分数据，所有的数据都保存在ibd文件中。<br>当服务器设置了innodb_file_per_table=0时，工具需要先使用page_parser，把数据文件从ibdata1中拆分出来，再按照规则匹配记录。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：centos 6.5 x86_64</p>
<h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install</span> gcc gcc-c++ glibc glibc-<span class="keyword">static</span>  perl-DBI perl-DBD-MySQL</span><br></pre></td></tr></table></figure>
<h2 id="安装Percona-Data-Recovery-Tool"><a href="#安装Percona-Data-Recovery-Tool" class="headerlink" title="安装Percona Data Recovery Tool"></a>安装Percona Data Recovery Tool</h2><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># cd /usr/src/</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ src]<span class="comment"># wget https://launchpad.net/percona-data-recovery-tool-for-innodb/trunk/release-0.5/+download/percona-data-recovery-tool-for-innodb-0.5.tar.gz --no-check-certificate </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ src]<span class="comment"># tar -zxf percona-data-recovery-tool-for-innodb-0.5.tar.gz </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ src]<span class="comment"># cd percona-data-recovery-tool-for-innodb-0.5/mysql-source/</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ mysql-source]<span class="comment"># ./configure </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ mysql-source]<span class="comment"># cd ..</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># make</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># ll</span></span><br><span class="line">总用量 3168</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 6269 </span>8月 <span class="number"> 28 </span>2011 check_data.c</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root  <span class="number"> 748761 </span>7月 <span class="number"> 17 </span>09:06 constraints_parser</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 22172 </span>8月 <span class="number"> 28 </span>2011 constraints_parser.c</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 12051 </span>8月 <span class="number"> 28 </span>2011 create_defs.pl</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span><span class="number"> 510 </span>wheel   <span class="number"> 4096 </span>8月 <span class="number"> 28 </span>2011 docs</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 1978 </span>8月 <span class="number"> 28 </span>2011 fetch_data.sh</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root  <span class="number"> 979051 </span>7月 <span class="number"> 17 </span>09:06 ibdconnect</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 12200 </span>8月 <span class="number"> 28 </span>2011 ibdconnect.c</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span><span class="number"> 510 </span>wheel   <span class="number"> 4096 </span>8月 <span class="number"> 28 </span>2011 include</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 8262 </span>8月 <span class="number"> 28 </span>2011 incrementalupdate.c</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root   <span class="number"> 14873 </span>7月 <span class="number"> 17 </span>09:06 innochecksum</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 9117 </span>8月 <span class="number"> 28 </span>2011 innochecksum.c</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel     <span class="number"> 74 </span>8月 <span class="number"> 28 </span>2011 INSTALL</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span>root root    <span class="number"> 4096 </span>7月 <span class="number"> 17 </span>09:06 lib</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 2676 </span>8月 <span class="number"> 28 </span>2011 Makefile</span><br><span class="line">drwxr-xr-x<span class="number"> 40 </span><span class="number"> 510 </span>wheel   <span class="number"> 4096 </span>7月 <span class="number"> 17 </span>09:06 mysql-source</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1346155 </span>7月 <span class="number"> 17 </span>09:06 page_parser</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 15239 </span>8月 <span class="number"> 28 </span>2011 page_parser.c</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 10608 </span>8月 <span class="number"> 28 </span>2011 print_data.c</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span><span class="number"> 510 </span>wheel    <span class="number"> 302 </span>8月 <span class="number"> 28 </span>2011 split_dump.pl</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 2046 </span>8月 <span class="number"> 28 </span>2011 tables_dict.c</span><br></pre></td></tr></table></figure>
<h2 id="恢复实战-delete误操作"><a href="#恢复实战-delete误操作" class="headerlink" title="恢复实战(delete误操作)"></a>恢复实战(delete误操作)</h2><h3 id="innodb-file-per-table-1"><a href="#innodb-file-per-table-1" class="headerlink" title="innodb_file_per_table=1"></a>innodb_file_per_table=1</h3><h4 id="模拟数据被误删除"><a href="#模拟数据被误删除" class="headerlink" title="模拟数据被误删除"></a>模拟数据被误删除</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># mysql -uroot -p123456</span></span><br><span class="line">Warning: Using a password <span class="keyword">on</span> <span class="keyword">the</span> command line interface can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">35514</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.6</span><span class="number">.36</span><span class="number">-82.0</span>-<span class="built_in">log</span> Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">25</span>:<span class="number">34</span> &gt; create database test111;</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">25</span>:<span class="number">40</span> &gt; use test111;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">25</span>:<span class="number">43</span> &gt; create table t222(<span class="built_in">id</span> int unsigned <span class="keyword">not</span> null auto_increment,<span class="built_in">name</span> varchar(<span class="number">20</span>),age int,primary key(`<span class="built_in">id</span>`),key idx_age(`age`));   </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.02</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">25</span>:<span class="number">51</span> &gt; insert <span class="keyword">into</span> t222 values(null,'jiessie',<span class="number">18</span>);           </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">00</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;     </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">1</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">10</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">2</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">2</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">11</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">4</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">4</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">11</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">8</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">8</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">12</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">16</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">16</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">12</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">32</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">32</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">12</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">64</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">64</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">13</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">128</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">128</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">13</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">256</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">256</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">14</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;</span><br><span class="line">Query OK, <span class="number">512</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">512</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">26</span>:<span class="number">14</span> &gt; select <span class="built_in">count</span><span class="comment">(*) from t222;</span></span><br><span class="line"><span class="comment">+<span class="comment">----------+</span></span></span><br><span class="line"><span class="comment">| count<span class="comment">(*) |</span></span></span><br><span class="line"><span class="comment"><span class="comment">+<span class="comment">----------+</span></span></span></span><br><span class="line"><span class="comment"><span class="comment">|     1024 |</span></span></span><br><span class="line"><span class="comment"><span class="comment">+<span class="comment">----------+</span></span></span></span><br><span class="line"><span class="comment"><span class="comment">1 row in set (0.00 sec)</span></span></span><br><span class="line"><span class="comment"><span class="comment"></span></span></span><br><span class="line"><span class="comment"><span class="comment">MySQL [test111] 09:26:21 &gt; exit</span></span></span><br><span class="line"><span class="comment"><span class="comment">Bye</span></span></span><br><span class="line"><span class="comment"><span class="comment">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# mysql -uroot -p123456 test111 -e "delete from t222;select count<span class="comment">(*) from t222;" &amp;&amp; cp /hwdata/data/percona/test111/t222.* /tmp/</span></span></span></span><br><span class="line"><span class="comment"><span class="comment"><span class="comment">Warning: Using a password on the command line interface can be insecure.</span></span></span></span><br><span class="line"><span class="comment"><span class="comment"><span class="comment">+<span class="comment">----------+</span></span></span></span></span><br><span class="line"><span class="comment"><span class="comment"><span class="comment">| count<span class="comment">(*) |</span></span></span></span></span><br><span class="line"><span class="comment"><span class="comment"><span class="comment"><span class="comment">+<span class="comment">----------+</span></span></span></span></span></span><br><span class="line"><span class="comment"><span class="comment"><span class="comment"><span class="comment">|        0 |</span></span></span></span></span><br><span class="line"><span class="comment"><span class="comment"><span class="comment"><span class="comment">+<span class="comment">----------+</span></span></span></span></span></span><br></pre></td></tr></table></figure>
<h4 id="解析ibd文件"><a href="#解析ibd文件" class="headerlink" title="解析ibd文件"></a>解析ibd文件</h4><p>实战mysql安装在/usr/local/percona，数据目录在/hwdata/data/percona，注意保存数据文件。<br>此过程会将表的idb文件解析为很多的page，innodb的page分为两大部分，一部分一级索引部分（primary key），另一部分为二级索引部分（secondary key），所以解析出来的ibd包括了主键数据和索引数据两大部分（如果该表有多个二级索引，则会生成多个文件<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># ll -t /tmp/t222*</span></span><br><span class="line">-rw-r-----<span class="number"> 1 </span>root root<span class="number"> 163840 </span>7月 <span class="number"> 17 </span>09:26 /tmp/t222.ibd</span><br><span class="line">-rw-r-----<span class="number"> 1 </span>root root  <span class="number"> 8614 </span>7月 <span class="number"> 17 </span>09:26 /tmp/t222.frm</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># ./page_parser -5 -f /tmp/t222.ibd </span></span><br><span class="line">Opening file: /tmp/t222.ibd:</span><br><span class="line">64513           ID of device containing file</span><br><span class="line">1597422         inode number</span><br><span class="line">33184           protection</span><br><span class="line">1               number of hard links</span><br><span class="line">0               user ID of owner</span><br><span class="line">0               group ID of owner</span><br><span class="line">0               device ID (if special file)</span><br><span class="line">163840          total size, in bytes</span><br><span class="line">4096            blocksize for filesystem I/O</span><br><span class="line">320             number of blocks allocated</span><br><span class="line">1500254806      time of last access</span><br><span class="line">1500254806      time of last modification</span><br><span class="line">1500254806      time of last status change</span><br><span class="line">163840  Size to process in bytes</span><br><span class="line">104857600       Disk cache size in bytes</span><br><span class="line">19.97% done. 2017-07-17 09:27:37 ETA(in 00:00 hours). Processing speed:<span class="number"> 32723 </span>B/sec</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># ll -t</span></span><br><span class="line">总用量 3172</span><br><span class="line">drwxr-xr-x <span class="number"> 3 </span>root root    <span class="number"> 4096 </span>7月 <span class="number"> 17 </span>09:27 pages-1500254852</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root <span class="number"> 1346155 </span>7月 <span class="number"> 17 </span>09:21 page_parser</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root  <span class="number"> 748729 </span>7月 <span class="number"> 17 </span>09:21 constraints_parser</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span>root root    <span class="number"> 4096 </span>7月 <span class="number"> 17 </span>09:21 lib</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root  <span class="number"> 979051 </span>7月 <span class="number"> 17 </span>09:06 ibdconnect</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span>root root   <span class="number"> 14873 </span>7月 <span class="number"> 17 </span>09:06 innochecksum</span><br><span class="line">drwxr-xr-x<span class="number"> 40 </span><span class="number"> 510 </span>wheel   <span class="number"> 4096 </span>7月 <span class="number"> 17 </span>09:06 mysql-source</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span><span class="number"> 510 </span>wheel   <span class="number"> 4096 </span>8月 <span class="number"> 28 </span>2011 docs</span><br><span class="line">drwxr-xr-x <span class="number"> 2 </span><span class="number"> 510 </span>wheel   <span class="number"> 4096 </span>8月 <span class="number"> 28 </span>2011 include</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 6269 </span>8月 <span class="number"> 28 </span>2011 check_data.c</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 22172 </span>8月 <span class="number"> 28 </span>2011 constraints_parser.c</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 12051 </span>8月 <span class="number"> 28 </span>2011 create_defs.pl</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 1978 </span>8月 <span class="number"> 28 </span>2011 fetch_data.sh</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 12200 </span>8月 <span class="number"> 28 </span>2011 ibdconnect.c</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 8262 </span>8月 <span class="number"> 28 </span>2011 incrementalupdate.c</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 9117 </span>8月 <span class="number"> 28 </span>2011 innochecksum.c</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel     <span class="number"> 74 </span>8月 <span class="number"> 28 </span>2011 INSTALL</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 2676 </span>8月 <span class="number"> 28 </span>2011 Makefile</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 15239 </span>8月 <span class="number"> 28 </span>2011 page_parser.c</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel  <span class="number"> 10608 </span>8月 <span class="number"> 28 </span>2011 print_data.c</span><br><span class="line">-rwxr-xr-x <span class="number"> 1 </span><span class="number"> 510 </span>wheel    <span class="number"> 302 </span>8月 <span class="number"> 28 </span>2011 split_dump.pl</span><br><span class="line">-rw-r--r-- <span class="number"> 1 </span><span class="number"> 510 </span>wheel   <span class="number"> 2046 </span>8月 <span class="number"> 28 </span>2011 tables_dict.c</span><br></pre></td></tr></table></figure></p>
<p>参数解释：<br>-5：代表 row format为Compact mysql5.0后的版本，-4 代表mysql5.0前版本<br>-f：代表要解析的文件 </p>
<h4 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h4><p>从下面的解析后的结果看到，当前目录多了pages-1500254852，其中39为主键索引的index_id,40为二级索引的index_id,该id可以通过开启innodb_table_monitor查看<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-<span class="number">0</span>.<span class="number">5</span>]# ll pages-<span class="number">1500254852</span>/FIL_PAGE_INDEX/<span class="number">0</span>-*</span><br><span class="line">pages-<span class="number">1500254852</span>/FIL_PAGE_INDEX/<span class="number">0</span>-<span class="number">39</span>:</span><br><span class="line">总用量 <span class="number">64</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 09:27 0</span>-<span class="number">00000003</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 09:27 2</span>-<span class="number">00000005</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 09:27 3</span>-<span class="number">00000006</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 09:27 4</span>-<span class="number">00000007</span>.page</span><br><span class="line"></span><br><span class="line">pages-<span class="number">1500254852</span>/FIL_PAGE_INDEX/<span class="number">0</span>-<span class="number">40</span>:</span><br><span class="line">总用量 <span class="number">16</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 09:27 1</span>-<span class="number">00000004</span>.page</span><br></pre></td></tr></table></figure></p>
<h4 id="生成表定义"><a href="#生成表定义" class="headerlink" title="生成表定义"></a>生成表定义</h4><p>由于该工具在解析数据pages的时候，需要获得该table的表结构定义，所以需要执行如下命令。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]<span class="comment"># ./create_defs.pl --host localhost --user root --password 123456 --db test111 --table t222 &gt; include/table_defs.h</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]<span class="comment"># cat include/table_defs.h</span></span><br><span class="line"><span class="comment">#ifndef table_defs_h</span></span><br><span class="line"><span class="comment">#define table_defs_h</span></span><br><span class="line"></span><br><span class="line">/<span class="regexp">/ Table definitions</span></span><br><span class="line"><span class="regexp">table_def_t table_definitions[] = &#123;</span></span><br><span class="line"><span class="regexp">        &#123;</span></span><br><span class="line"><span class="regexp">                name: "t222",</span></span><br><span class="line"><span class="regexp">                &#123;</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>* int(<span class="number">10</span>) unsigned *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "id",</span></span><br><span class="line"><span class="regexp">                                type: FT_UINT,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 4,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                has_limits: FALSE,</span></span><br><span class="line"><span class="regexp">                                limits: &#123;</span></span><br><span class="line"><span class="regexp">                                        can_be_null: FALSE,</span></span><br><span class="line"><span class="regexp">                                        uint_min_val: 0,</span></span><br><span class="line"><span class="regexp">                                        uint_max_val: 4294967295ULL</span></span><br><span class="line"><span class="regexp">                                &#125;,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: FALSE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>*  *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "DB_TRX_ID",</span></span><br><span class="line"><span class="regexp">                                type: FT_INTERNAL,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 6,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: FALSE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>*  *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "DB_ROLL_PTR",</span></span><br><span class="line"><span class="regexp">                                type: FT_INTERNAL,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 7,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: FALSE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>* varchar(<span class="number">20</span>) *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "name",</span></span><br><span class="line"><span class="regexp">                                type: FT_CHAR,</span></span><br><span class="line"><span class="regexp">                                min_length: 0,</span></span><br><span class="line"><span class="regexp">                                max_length: 60,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                has_limits: FALSE,</span></span><br><span class="line"><span class="regexp">                                limits: &#123;</span></span><br><span class="line"><span class="regexp">                                        can_be_null: TRUE,</span></span><br><span class="line"><span class="regexp">                                        char_min_len: 0,</span></span><br><span class="line"><span class="regexp">                                        char_max_len: 60,</span></span><br><span class="line"><span class="regexp">                                        char_ascii_only: TRUE</span></span><br><span class="line"><span class="regexp">                                &#125;,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: TRUE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>* int(<span class="number">11</span>) *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "age",</span></span><br><span class="line"><span class="regexp">                                type: FT_INT,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 4,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                has_limits: FALSE,</span></span><br><span class="line"><span class="regexp">                                limits: &#123;</span></span><br><span class="line"><span class="regexp">                                        can_be_null: TRUE,</span></span><br><span class="line"><span class="regexp">                                        int_min_val: -2147483648LL,</span></span><br><span class="line"><span class="regexp">                                        int_max_val: 2147483647LL</span></span><br><span class="line"><span class="regexp">                                &#125;,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: TRUE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; type: FT_NONE &#125;</span></span><br><span class="line"><span class="regexp">                &#125;</span></span><br><span class="line"><span class="regexp">        &#125;,</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">#endif</span></span><br><span class="line"><span class="regexp">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# </span></span><br><span class="line"><span class="regexp">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# make</span></span><br><span class="line"><span class="regexp">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c tables_dict.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c check_data.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">check_data</span>.<span class="title">o</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -o constraints_parser constraints_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">print_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">check_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span> <span class="title">lib</span>/<span class="title">libmystrings</span>.<span class="title">a</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -static -lrt -o page_parser page_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span> </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]<span class="comment"># make</span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c tables_dict.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c print_data.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">print_data</span>.<span class="title">o</span> </span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -o constraints_parser constraints_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">print_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">check_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span> <span class="title">lib</span>/<span class="title">libmystrings</span>.<span class="title">a</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -static -lrt -o page_parser page_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span></span></span><br></pre></td></tr></table></figure></p>
<p>上面的命令会将t222表的表定义传入到table_defs.h中，在生成了表结构定义后，重新make该恢复工具  </p>
<p><font color="#dd0000">注意：需要make 2次</font><br> </p>
<h4 id="开始提取page中删除的数据"><a href="#开始提取page中删除的数据" class="headerlink" title="开始提取page中删除的数据"></a>开始提取page中删除的数据</h4><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># ./constraints_parser -5 -f pages-1500254852/FIL_PAGE_INDEX/0-39/ &gt; /tmp/t222.sql</span></span><br><span class="line">LOAD DATA INFILE <span class="string">'/usr/src/percona-data-recovery-tool-for-innodb-0.5/dumps/default/t222'</span> REPLACE INTO TABLE `<span class="javascript">t222</span>` FIELDS TERMINATED BY <span class="string">'\t'</span> OPTIONALLY ENCLOSED BY <span class="string">'"'</span> LINES STARTING BY <span class="string">'t222\t'</span> (id, name, age);</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># cat /tmp/t222.sql |wc -l</span></span><br><span class="line"><span class="number">1024</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># head -10 /tmp/t222.sql </span></span><br><span class="line">t222    <span class="number">1</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">2</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">3</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">4</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">6</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">7</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">8</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">9</span>       <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">13</span>      <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">14</span>      <span class="string">"jiessie"</span>       <span class="number">18</span></span><br></pre></td></tr></table></figure>
<p>参数解释：<br>-5 -f的参数和page_parser相同，代表 row format为Compact ；<br>-D:该参数的含义为代表恢复删除的数据页； </p>
<h4 id="恢复数据"><a href="#恢复数据" class="headerlink" title="恢复数据"></a>恢复数据</h4><p>使用上面constraints_parser执行后的load data导入数据，需要注意目录<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]# mysql -uroot -p123456 </span><br><span class="line">Warning: <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line <span class="keyword">interface</span> can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">35598</span></span><br><span class="line">Server version: <span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">32</span>:<span class="number">33</span> &gt; use test111;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">32</span>:<span class="number">35</span> &gt; LOAD DATA INFILE <span class="string">'/tmp/t222.sql'</span> REPLACE <span class="keyword">INTO</span> TABLE `t222` FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">'\t'</span> OPTIONALLY ENCLOSED <span class="keyword">BY</span> <span class="string">'"'</span> LINES STARTING <span class="keyword">BY</span> <span class="string">'t222\t'</span> (id, name, age);</span><br><span class="line">Query OK, <span class="number">1024</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">1024</span>  Deleted: <span class="number">0</span>  Skipped: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">32</span>:<span class="number">53</span> &gt; <span class="keyword">select</span> count<span class="comment">(*) from t222;</span></span><br><span class="line"><span class="comment">+----------+</span></span><br><span class="line"><span class="comment">| count(*)</span> |</span><br><span class="line">+----------+</span><br><span class="line">|     <span class="number">1024</span> |</span><br><span class="line">+----------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">32</span>:<span class="number">59</span> &gt; <span class="keyword">select</span> * <span class="keyword">from</span> t222 limit <span class="number">10</span>;</span><br><span class="line">+----+---------+------+</span><br><span class="line">| id | name    | age  |</span><br><span class="line">+----+---------+------+</span><br><span class="line">|  <span class="number">1</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">2</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">3</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">4</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">6</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">7</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">8</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">9</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">| <span class="number">13</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">| <span class="number">14</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">+----+---------+------+</span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据，数据恢复成功。从实验来看，当delete误操作，第一时间要保护好ibd数据，拷贝到其他目录。</p>
<h4 id="恢复脚本"><a href="#恢复脚本" class="headerlink" title="恢复脚本"></a>恢复脚本</h4><p>当误操作的数据量大时，constraints_parser恢复是单线程，速度较慢，此处引用了2个恢复脚本<br>详情请参考：<a href="http://www.orczhou.com/index.php/2013/07/how-to-recover-data-from-mysql-innodb-data-file-ibd-file/" target="_blank" rel="noopener">http://www.orczhou.com/index.php/2013/07/how-to-recover-data-from-mysql-innodb-data-file-ibd-file/</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># pwd</span></span><br><span class="line">/usr/src/percona-data-recovery-tool-for-innodb-0.5</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># cat parallel_exec.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">ws=/usr/src/percona-data-recovery-tool-for-innodb-0.5/</span><br><span class="line">pagedir=/usr/src/percona-data-recovery-tool-for-innodb-0.5/pages-1500255306/FIL_PAGE_INDEX</span><br><span class="line">logdir=/usr/src/percona-data-recovery-tool-for-innodb-0.5/<span class="built_in">log</span></span><br><span class="line">rectool=/usr/src/percona-data-recovery-tool-for-innodb-0.5/constraints_parser</span><br><span class="line"><span class="built_in">cd</span> `dirname <span class="variable">$rectool</span>`</span><br><span class="line">count=0</span><br><span class="line">page_count=353894</span><br><span class="line">page_done=0</span><br><span class="line">startdate=`date +%s`</span><br><span class="line"><span class="keyword">for</span> d1 <span class="keyword">in</span> `ls <span class="variable">$pagedir</span>`</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">  count=$((<span class="variable">$count</span>+1))</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"in page <span class="variable">$d2</span> at dir <span class="variable">$d1</span>"</span> &gt; <span class="variable">$logdir</span>/<span class="variable">$count</span>.<span class="built_in">log</span></span><br><span class="line">  thedate=`date +%s`</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"<span class="variable">$page_done</span> / <span class="variable">$page_count</span> at <span class="variable">$thedate</span> from <span class="variable">$startdate</span>"</span></span><br><span class="line">  total=`ls -l <span class="variable">$pagedir</span>/<span class="variable">$d1</span>/|wc -l`</span><br><span class="line">  page_done=$((<span class="variable">$page_done</span>+<span class="variable">$total</span>))</span><br><span class="line">  threads=`ps axu|grep parser_jobs|grep -v grep|wc -l`</span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$threads</span></span><br><span class="line">  <span class="keyword">while</span> [ <span class="variable">$threads</span> -gt 48 ];</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    sleep 1</span><br><span class="line">    threads=`ps axu|grep parser_jobs|grep -v grep|wc -l`</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line">  <span class="variable">$ws</span>/parser_jobs.sh <span class="variable">$pagedir</span>/<span class="variable">$d1</span> &gt; <span class="variable">$ws</span>/job.log 2&gt;&amp;1 &amp;</span><br><span class="line"><span class="keyword">done</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># cat parser_jobs.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">pagedir=/usr/src/percona-data-recovery-tool-for-innodb-0.5/pages-1500255306/FIL_PAGE_INDEX</span><br><span class="line">logdir=/usr/src/percona-data-recovery-tool-for-innodb-0.5/<span class="built_in">log</span></span><br><span class="line">rectool=/usr/src/percona-data-recovery-tool-for-innodb-0.5/constraints_parser</span><br><span class="line">logfile=<span class="string">"<span class="variable">$logdir</span>/`basename <span class="variable">$1</span>`.log"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$1</span>"</span> &gt; <span class="variable">$logfile</span></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="variable">$1</span> ];<span class="keyword">then</span></span><br><span class="line">  <span class="keyword">for</span> d2 <span class="keyword">in</span> `ls <span class="variable">$1</span>`</span><br><span class="line">  <span class="keyword">do</span></span><br><span class="line">    <span class="variable">$rectool</span> -5 -f <span class="variable">$1</span>/<span class="variable">$d2</span> &gt;&gt; <span class="variable">$logfile</span> 2&gt;/dev/null</span><br><span class="line">  <span class="keyword">done</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># ./parallel_exec.sh </span></span><br><span class="line">0 / 353894 at 1500255771 from 1500255771</span><br><span class="line">0</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># ll log/</span></span><br><span class="line">总用量 296</span><br><span class="line">-rw-r--r-- 1 root root 296770 7月  17 09:42 0-41.log</span><br><span class="line">-rw-r--r-- 1 root root     21 7月  17 09:42 1.log</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># cat log/0-41.log |wc -l</span></span><br><span class="line">10001</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># head -10 log/0-41.log </span></span><br><span class="line">/usr/src/percona-data-recovery-tool-for-innodb-0.5/pages-1500255306/FIL_PAGE_INDEX/0-41</span><br><span class="line">employee        3670    3670    <span class="string">"test3670"</span></span><br><span class="line">employee        3671    3671    <span class="string">"test3671"</span></span><br><span class="line">employee        3672    3672    <span class="string">"test3672"</span></span><br><span class="line">employee        3673    3673    <span class="string">"test3673"</span></span><br><span class="line">employee        3674    3674    <span class="string">"test3674"</span></span><br><span class="line">employee        3675    3675    <span class="string">"test3675"</span></span><br><span class="line">employee        3676    3676    <span class="string">"test3676"</span></span><br><span class="line">employee        3677    3677    <span class="string">"test3677"</span></span><br><span class="line">employee        3678    3678    <span class="string">"test3678"</span></span><br></pre></td></tr></table></figure></p>
<p>用法：<br>1.修改脚本路<br>2.修改page_parser后的pages目录<br>3.创建log目录<br>4.执行parallel_exec脚本<br>5.注意，上面演示的示例，0-41.log中在第一行多了一句待恢复innodb页的路径，实际恢复中应删除  </p>
<h3 id="innodb-file-per-table-0"><a href="#innodb-file-per-table-0" class="headerlink" title="innodb_file_per_table=0"></a>innodb_file_per_table=0</h3><h4 id="模拟数据被误删除-1"><a href="#模拟数据被误删除-1" class="headerlink" title="模拟数据被误删除"></a>模拟数据被误删除</h4><figure class="highlight applescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># mysql -uroot -p123456 -e "show variables like 'innodb_file_per_table'"</span></span><br><span class="line">Warning: Using a password <span class="keyword">on</span> <span class="keyword">the</span> command line interface can be insecure.</span><br><span class="line">+<span class="comment">-----------------------+-------+</span></span><br><span class="line">| Variable_name         | Value |</span><br><span class="line">+<span class="comment">-----------------------+-------+</span></span><br><span class="line">| innodb_file_per_table | OFF   |</span><br><span class="line">+<span class="comment">-----------------------+-------+</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># mysql -uroot -p123456</span></span><br><span class="line">Warning: Using a password <span class="keyword">on</span> <span class="keyword">the</span> command line interface can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> <span class="keyword">the</span> MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection <span class="built_in">id</span> <span class="keyword">is</span> <span class="number">9</span></span><br><span class="line">Server <span class="built_in">version</span>: <span class="number">5.6</span><span class="number">.36</span><span class="number">-82.0</span>-<span class="built_in">log</span> Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span><span class="number">-2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span> affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> <span class="keyword">its</span></span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' <span class="keyword">or</span> '\h' <span class="keyword">for</span> help. Type '\c' <span class="keyword">to</span> clear <span class="keyword">the</span> current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">58</span>:<span class="number">22</span> &gt; create database test111;</span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">09</span>:<span class="number">58</span>:<span class="number">31</span> &gt; use test111;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">58</span>:<span class="number">34</span> &gt; create table t222(<span class="built_in">id</span> int unsigned <span class="keyword">not</span> null auto_increment,<span class="built_in">name</span> varchar(<span class="number">20</span>),age int,primary key(`<span class="built_in">id</span>`),key idx_age(`age`)); </span><br><span class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">58</span>:<span class="number">52</span> &gt; insert <span class="keyword">into</span> t222 values(null,'jiessie',<span class="number">18</span>);   </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">58</span>:<span class="number">57</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">1</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">02</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">2</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">2</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">03</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">4</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">4</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">04</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">8</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">8</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">04</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;                                                                                       </span><br><span class="line">Query OK, <span class="number">16</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">16</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">06</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">32</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">32</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">07</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">64</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">64</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">07</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">128</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">128</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">08</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">256</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">256</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">08</span> &gt; insert <span class="keyword">into</span> t222 (<span class="built_in">name</span>,age) select <span class="built_in">name</span>,age <span class="keyword">from</span> t222;   </span><br><span class="line">Query OK, <span class="number">512</span> rows affected (<span class="number">0.00</span> sec)</span><br><span class="line">Records: <span class="number">512</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">09</span>:<span class="number">59</span>:<span class="number">09</span> &gt; select <span class="built_in">count</span><span class="comment">(*) from t222;</span></span><br><span class="line"><span class="comment">+<span class="comment">----------+</span></span></span><br><span class="line"><span class="comment">| count<span class="comment">(*) |</span></span></span><br><span class="line"><span class="comment"><span class="comment">+<span class="comment">----------+</span></span></span></span><br><span class="line"><span class="comment"><span class="comment">|     1024 |</span></span></span><br><span class="line"><span class="comment"><span class="comment">+<span class="comment">----------+</span></span></span></span><br><span class="line"><span class="comment"><span class="comment">1 row in set (0.00 sec)</span></span></span><br></pre></td></tr></table></figure>
<h4 id="解析ibd文件-1"><a href="#解析ibd文件-1" class="headerlink" title="解析ibd文件"></a>解析ibd文件</h4><p>实战mysql安装在/usr/local/percona，数据目录在/hwdata/data/percona，注意保存数据文件。<br>当设置了使用共享表空间(innodb_file_per_table=0)时，所有数据文件存在在ibdata1文件里面，不再是存在在单独表中，此时需要从ibdata1提取出需要被恢复的表<br><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]</span># ./<span class="selector-tag">page_parser</span> <span class="selector-tag">-5</span> <span class="selector-tag">-f</span> /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibdata1</span> </span><br><span class="line"><span class="selector-tag">Opening</span> <span class="selector-tag">file</span>: /<span class="selector-tag">tmp</span>/<span class="selector-tag">ibdata1</span>:</span><br><span class="line"><span class="selector-tag">64513</span>           <span class="selector-tag">ID</span> <span class="selector-tag">of</span> <span class="selector-tag">device</span> <span class="selector-tag">containing</span> <span class="selector-tag">file</span></span><br><span class="line"><span class="selector-tag">1597426</span>         <span class="selector-tag">inode</span> <span class="selector-tag">number</span></span><br><span class="line"><span class="selector-tag">33184</span>           <span class="selector-tag">protection</span></span><br><span class="line"><span class="selector-tag">1</span>               <span class="selector-tag">number</span> <span class="selector-tag">of</span> <span class="selector-tag">hard</span> <span class="selector-tag">links</span></span><br><span class="line"><span class="selector-tag">0</span>               <span class="selector-tag">user</span> <span class="selector-tag">ID</span> <span class="selector-tag">of</span> <span class="selector-tag">owner</span></span><br><span class="line"><span class="selector-tag">0</span>               <span class="selector-tag">group</span> <span class="selector-tag">ID</span> <span class="selector-tag">of</span> <span class="selector-tag">owner</span></span><br><span class="line"><span class="selector-tag">0</span>               <span class="selector-tag">device</span> <span class="selector-tag">ID</span> (if special file)</span><br><span class="line"><span class="selector-tag">1073741824</span>              <span class="selector-tag">total</span> <span class="selector-tag">size</span>, <span class="selector-tag">in</span> <span class="selector-tag">bytes</span></span><br><span class="line"><span class="selector-tag">4096</span>            <span class="selector-tag">blocksize</span> <span class="selector-tag">for</span> <span class="selector-tag">filesystem</span> <span class="selector-tag">I</span>/<span class="selector-tag">O</span></span><br><span class="line"><span class="selector-tag">2097160</span>         <span class="selector-tag">number</span> <span class="selector-tag">of</span> <span class="selector-tag">blocks</span> <span class="selector-tag">allocated</span></span><br><span class="line"><span class="selector-tag">1500256783</span>      <span class="selector-tag">time</span> <span class="selector-tag">of</span> <span class="selector-tag">last</span> <span class="selector-tag">access</span></span><br><span class="line"><span class="selector-tag">1500256790</span>      <span class="selector-tag">time</span> <span class="selector-tag">of</span> <span class="selector-tag">last</span> <span class="selector-tag">modification</span></span><br><span class="line"><span class="selector-tag">1500256790</span>      <span class="selector-tag">time</span> <span class="selector-tag">of</span> <span class="selector-tag">last</span> <span class="selector-tag">status</span> <span class="selector-tag">change</span></span><br><span class="line"><span class="selector-tag">1073741824</span>      <span class="selector-tag">Size</span> <span class="selector-tag">to</span> <span class="selector-tag">process</span> <span class="selector-tag">in</span> <span class="selector-tag">bytes</span></span><br><span class="line"><span class="selector-tag">104857600</span>       <span class="selector-tag">Disk</span> <span class="selector-tag">cache</span> <span class="selector-tag">size</span> <span class="selector-tag">in</span> <span class="selector-tag">bytes</span></span><br><span class="line"><span class="selector-tag">1</span><span class="selector-class">.65</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:48</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">17666552</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">3</span><span class="selector-class">.41</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19000304</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">5</span><span class="selector-class">.18</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19005354</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">6</span><span class="selector-class">.96</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19008049</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">8</span><span class="selector-class">.73</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19015298</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">10</span><span class="selector-class">.47</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:45</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18719062</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">12</span><span class="selector-class">.24</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19008805</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">14</span><span class="selector-class">.01</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19009523</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">15</span><span class="selector-class">.78</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19007004</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">17</span><span class="selector-class">.55</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19008533</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">19</span><span class="selector-class">.32</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19008676</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">21</span><span class="selector-class">.06</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:45</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18715203</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">22</span><span class="selector-class">.83</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19007750</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">24</span><span class="selector-class">.60</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19002802</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">26</span><span class="selector-class">.37</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18998409</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">28</span><span class="selector-class">.14</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18991699</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">29</span><span class="selector-class">.88</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:45</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18708371</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">31</span><span class="selector-class">.65</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18999365</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">33</span><span class="selector-class">.42</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18997104</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">35</span><span class="selector-class">.19</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19001358</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">36</span><span class="selector-class">.96</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18999823</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">38</span><span class="selector-class">.73</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18997814</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">40</span><span class="selector-class">.47</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:45</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18706585</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">42</span><span class="selector-class">.24</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18996668</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">44</span><span class="selector-class">.01</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18998094</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">45</span><span class="selector-class">.78</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18998427</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">47</span><span class="selector-class">.55</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19002403</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">49</span><span class="selector-class">.30</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:45</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18724158</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">51</span><span class="selector-class">.06</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18997507</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">52</span><span class="selector-class">.83</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18999524</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">54</span><span class="selector-class">.60</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18998796</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">56</span><span class="selector-class">.37</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19000200</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">58</span><span class="selector-class">.14</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18998670</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">59</span><span class="selector-class">.88</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:45</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18699601</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">61</span><span class="selector-class">.65</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19000413</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">63</span><span class="selector-class">.42</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18997737</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">65</span><span class="selector-class">.19</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18996538</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">66</span><span class="selector-class">.96</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18999244</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">68</span><span class="selector-class">.70</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18704824</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">70</span><span class="selector-class">.47</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19002702</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">72</span><span class="selector-class">.24</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19002732</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">74</span><span class="selector-class">.01</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18999341</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">75</span><span class="selector-class">.78</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19001510</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">77</span><span class="selector-class">.55</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18998098</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">79</span><span class="selector-class">.29</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18706109</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">81</span><span class="selector-class">.06</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19007616</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">82</span><span class="selector-class">.83</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19007630</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">84</span><span class="selector-class">.60</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19004630</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">86</span><span class="selector-class">.37</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19004716</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">88</span><span class="selector-class">.12</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18717386</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">89</span><span class="selector-class">.89</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19005803</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">91</span><span class="selector-class">.66</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19007785</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">93</span><span class="selector-class">.43</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19006419</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">95</span><span class="selector-class">.20</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19004360</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">96</span><span class="selector-class">.97</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">19008201</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-tag">98</span><span class="selector-class">.73</span>% <span class="selector-tag">done</span>. <span class="selector-tag">2017-07-17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:03</span><span class="selector-pseudo">:44</span> <span class="selector-tag">ETA</span>(in <span class="number">00</span>:<span class="number">00</span> hours). <span class="selector-tag">Processing</span> <span class="selector-tag">speed</span>: <span class="selector-tag">18940047</span> <span class="selector-tag">B</span>/<span class="selector-tag">sec</span></span><br><span class="line"><span class="selector-attr">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]</span># <span class="selector-tag">ll</span> <span class="selector-tag">-t</span></span><br><span class="line">总用量 <span class="selector-tag">3172</span></span><br><span class="line"><span class="selector-tag">drwxr-xr-x</span>  <span class="selector-tag">4</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>     <span class="selector-tag">4096</span> <span class="selector-tag">7</span>月  <span class="selector-tag">17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:18</span> <span class="selector-tag">pages-1500257904</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>  <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>   <span class="selector-tag">979051</span> <span class="selector-tag">7</span>月  <span class="selector-tag">17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:18</span> <span class="selector-tag">ibdconnect</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>  <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>    <span class="selector-tag">14873</span> <span class="selector-tag">7</span>月  <span class="selector-tag">17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:18</span> <span class="selector-tag">innochecksum</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>  <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>  <span class="selector-tag">1346155</span> <span class="selector-tag">7</span>月  <span class="selector-tag">17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:18</span> <span class="selector-tag">page_parser</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>  <span class="selector-tag">1</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>   <span class="selector-tag">748761</span> <span class="selector-tag">7</span>月  <span class="selector-tag">17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:18</span> <span class="selector-tag">constraints_parser</span></span><br><span class="line"><span class="selector-tag">drwxr-xr-x</span>  <span class="selector-tag">2</span> <span class="selector-tag">root</span> <span class="selector-tag">root</span>     <span class="selector-tag">4096</span> <span class="selector-tag">7</span>月  <span class="selector-tag">17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:18</span> <span class="selector-tag">lib</span></span><br><span class="line"><span class="selector-tag">drwxr-xr-x</span> <span class="selector-tag">40</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">4096</span> <span class="selector-tag">7</span>月  <span class="selector-tag">17</span> <span class="selector-tag">10</span><span class="selector-pseudo">:18</span> <span class="selector-tag">mysql-source</span></span><br><span class="line"><span class="selector-tag">drwxr-xr-x</span>  <span class="selector-tag">2</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">4096</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">docs</span></span><br><span class="line"><span class="selector-tag">drwxr-xr-x</span>  <span class="selector-tag">2</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">4096</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">include</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">6269</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">check_data</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>   <span class="selector-tag">22172</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">constraints_parser</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>   <span class="selector-tag">12051</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">create_defs</span><span class="selector-class">.pl</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">1978</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">fetch_data</span><span class="selector-class">.sh</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>   <span class="selector-tag">12200</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">ibdconnect</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">8262</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">incrementalupdate</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">9117</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">innochecksum</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>      <span class="selector-tag">74</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">INSTALL</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">2676</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">Makefile</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>   <span class="selector-tag">15239</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">page_parser</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>   <span class="selector-tag">10608</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">print_data</span><span class="selector-class">.c</span></span><br><span class="line"><span class="selector-tag">-rwxr-xr-x</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>     <span class="selector-tag">302</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">split_dump</span><span class="selector-class">.pl</span></span><br><span class="line"><span class="selector-tag">-rw-r--r--</span>  <span class="selector-tag">1</span>  <span class="selector-tag">510</span> <span class="selector-tag">wheel</span>    <span class="selector-tag">2046</span> <span class="selector-tag">8</span>月  <span class="selector-tag">28</span> <span class="selector-tag">2011</span> <span class="selector-tag">tables_dict</span><span class="selector-class">.c</span></span><br></pre></td></tr></table></figure></p>
<h4 id="从ibdata1提取待恢复数据"><a href="#从ibdata1提取待恢复数据" class="headerlink" title="从ibdata1提取待恢复数据"></a>从ibdata1提取待恢复数据</h4><p>由于ibdata1恢复的是所有数据，需要从这些数据找到误操作的表，通过查询元数据，得到表空间的id和name<br><figure class="highlight tap"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># mysql -uroot -p123456 </span></span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 39</span><br><span class="line">Server version: 5.6.36-82.0-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type 'help;' or '\h' for help. Type '\c' to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 10:06:55 &gt; use information_schema;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [information_schema] 10:06:58 &gt; select i.INDEX_ID, i.NAME FROM INNODB_SYS_INDEXES as i INNER JOIN INNODB_SYS_TABLES as t USING(TABLE_ID) WHERE t.NAME='test111/t222';</span><br><span class="line">+----------+---------+</span><br><span class="line">| INDEX_ID | NAME    |</span><br><span class="line">+----------+---------+</span><br><span class="line">|      <span class="number"> 20 </span>| PRIMARY |</span><br><span class="line">|      <span class="number"> 21 </span>| idx_age |</span><br><span class="line">+----------+---------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [information_schema] 10:06:59 &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment"># ll pages-1500256968/FIL_PAGE_INDEX/</span></span><br><span class="line">总用量 68</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-1</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-11</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-12</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-13</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-14</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-15</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-16</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-17</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-18</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-19</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-2</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-20</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-21</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-3</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-4</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 0-5</span><br><span class="line">drwxr-xr-x<span class="number"> 2 </span>root root<span class="number"> 4096 </span>7月 <span class="number"> 17 </span>10:02 4294967295-0</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]<span class="comment">#</span></span><br></pre></td></tr></table></figure></p>
<h4 id="结果分析-1"><a href="#结果分析-1" class="headerlink" title="结果分析"></a>结果分析</h4><p>从下面的解析后的结果看到，当前目录pages-1500257904，其中20为主键索引的index_id,21为二级索引的index_id,该id可以通过开启innodb_table_monitor查看<br><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-<span class="number">0</span>.<span class="number">5</span>]# ll pages-<span class="number">1500256968</span>/FIL_PAGE_INDEX/<span class="number">0</span>-<span class="number">20</span>/</span><br><span class="line">总用量 <span class="number">128</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 15</span>-<span class="number">00000054</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 17</span>-<span class="number">00000056</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 18</span>-<span class="number">00000057</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 19</span>-<span class="number">00000058</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 20</span>-<span class="number">00000054</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 22</span>-<span class="number">00000057</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 23</span>-<span class="number">00000056</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 24</span>-<span class="number">00000058</span>.page</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-<span class="number">0</span>.<span class="number">5</span>]# ll pages-<span class="number">1500256968</span>/FIL_PAGE_INDEX/<span class="number">0</span>-<span class="number">21</span></span><br><span class="line">总用量 <span class="number">32</span></span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 16</span>-<span class="number">00000055</span>.page</span><br><span class="line">-rw-r--r-- <span class="number">1</span> root root <span class="number">16384 7</span>月  <span class="number">17 10:02 21</span>-<span class="number">00000055</span>.page</span><br></pre></td></tr></table></figure></p>
<h4 id="生成表定义-1"><a href="#生成表定义-1" class="headerlink" title="生成表定义"></a>生成表定义</h4><p>由于该工具在解析数据pages的时候，需要获得该table的表结构定义，所以需要执行如下命令。<br><figure class="highlight crystal"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]<span class="comment"># ./create_defs.pl --host localhost --user root --password 123456 --db test111 --table t222 &gt; include/table_defs.h</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]<span class="comment"># cat include/table_defs.h</span></span><br><span class="line"><span class="comment">#ifndef table_defs_h</span></span><br><span class="line"><span class="comment">#define table_defs_h</span></span><br><span class="line"></span><br><span class="line">/<span class="regexp">/ Table definitions</span></span><br><span class="line"><span class="regexp">table_def_t table_definitions[] = &#123;</span></span><br><span class="line"><span class="regexp">        &#123;</span></span><br><span class="line"><span class="regexp">                name: "t222",</span></span><br><span class="line"><span class="regexp">                &#123;</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>* int(<span class="number">10</span>) unsigned *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "id",</span></span><br><span class="line"><span class="regexp">                                type: FT_UINT,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 4,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                has_limits: FALSE,</span></span><br><span class="line"><span class="regexp">                                limits: &#123;</span></span><br><span class="line"><span class="regexp">                                        can_be_null: FALSE,</span></span><br><span class="line"><span class="regexp">                                        uint_min_val: 0,</span></span><br><span class="line"><span class="regexp">                                        uint_max_val: 4294967295ULL</span></span><br><span class="line"><span class="regexp">                                &#125;,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: FALSE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>*  *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "DB_TRX_ID",</span></span><br><span class="line"><span class="regexp">                                type: FT_INTERNAL,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 6,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: FALSE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>*  *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "DB_ROLL_PTR",</span></span><br><span class="line"><span class="regexp">                                type: FT_INTERNAL,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 7,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: FALSE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>* varchar(<span class="number">20</span>) *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "name",</span></span><br><span class="line"><span class="regexp">                                type: FT_CHAR,</span></span><br><span class="line"><span class="regexp">                                min_length: 0,</span></span><br><span class="line"><span class="regexp">                                max_length: 60,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                has_limits: FALSE,</span></span><br><span class="line"><span class="regexp">                                limits: &#123;</span></span><br><span class="line"><span class="regexp">                                        can_be_null: TRUE,</span></span><br><span class="line"><span class="regexp">                                        char_min_len: 0,</span></span><br><span class="line"><span class="regexp">                                        char_max_len: 60,</span></span><br><span class="line"><span class="regexp">                                        char_ascii_only: TRUE</span></span><br><span class="line"><span class="regexp">                                &#125;,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: TRUE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; /</span>* int(<span class="number">11</span>) *<span class="regexp">/</span></span><br><span class="line"><span class="regexp">                                name: "age",</span></span><br><span class="line"><span class="regexp">                                type: FT_INT,</span></span><br><span class="line"><span class="regexp">                                fixed_length: 4,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                has_limits: FALSE,</span></span><br><span class="line"><span class="regexp">                                limits: &#123;</span></span><br><span class="line"><span class="regexp">                                        can_be_null: TRUE,</span></span><br><span class="line"><span class="regexp">                                        int_min_val: -2147483648LL,</span></span><br><span class="line"><span class="regexp">                                        int_max_val: 2147483647LL</span></span><br><span class="line"><span class="regexp">                                &#125;,</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">                                can_be_null: TRUE</span></span><br><span class="line"><span class="regexp">                        &#125;,</span></span><br><span class="line"><span class="regexp">                        &#123; type: FT_NONE &#125;</span></span><br><span class="line"><span class="regexp">                &#125;</span></span><br><span class="line"><span class="regexp">        &#125;,</span></span><br><span class="line"><span class="regexp">&#125;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">#endif</span></span><br><span class="line"><span class="regexp">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# </span></span><br><span class="line"><span class="regexp">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# make</span></span><br><span class="line"><span class="regexp">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c tables_dict.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c check_data.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">check_data</span>.<span class="title">o</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -o constraints_parser constraints_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">print_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">check_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span> <span class="title">lib</span>/<span class="title">libmystrings</span>.<span class="title">a</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -static -lrt -o page_parser page_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span> </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]<span class="comment"># make</span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c tables_dict.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -c print_data.c -o <span class="class"><span class="keyword">lib</span>/<span class="title">print_data</span>.<span class="title">o</span> </span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -o constraints_parser constraints_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">print_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">check_data</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span> <span class="title">lib</span>/<span class="title">libmystrings</span>.<span class="title">a</span></span></span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=<span class="number">64</span> -D_LARGEFILE64_SOURCE=<span class="number">1</span> -D_LARGEFILE_SOURCE=<span class="number">1</span> -Wall -O3 -g -I <span class="keyword">include</span> -I mysql-source/<span class="keyword">include</span> -I mysql-source/innobase/<span class="keyword">include</span> -static -lrt -o page_parser page_parser.c <span class="class"><span class="keyword">lib</span>/<span class="title">tables_dict</span>.<span class="title">o</span> <span class="title">lib</span>/<span class="title">libut</span>.<span class="title">a</span></span></span><br></pre></td></tr></table></figure></p>
<p>上面的命令会将t222表的表定义传入到table_defs.h中，在生成了表结构定义后，重新make该恢复工具  </p>
<p><font color="#dd0000">注意：需要make 2次</font><br> </p>
<h4 id="开始提取page中删除的数据-1"><a href="#开始提取page中删除的数据-1" class="headerlink" title="开始提取page中删除的数据"></a>开始提取page中删除的数据</h4><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># ./constraints_parser -5 -f pages-1500258331/FIL_PAGE_INDEX/0-20/ &gt; /tmp/0_t222.sql            </span></span><br><span class="line">LOAD DATA INFILE <span class="string">'/usr/src/percona-data-recovery-tool-for-innodb-0.5/dumps/default/t222'</span> REPLACE INTO TABLE `<span class="javascript">t222</span>` FIELDS TERMINATED BY <span class="string">'\t'</span> OPTIONALLY ENCLOSED BY <span class="string">'"'</span> LINES STARTING BY <span class="string">'t222\t'</span> (id, name, age);</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># cat /tmp/0_t222.sql |wc -l</span></span><br><span class="line"><span class="number">2048</span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb<span class="number">-0.5</span>]<span class="comment"># head -10 /tmp/0_t222.sql </span></span><br><span class="line">t222    <span class="number">1145</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1146</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1147</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1148</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1149</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1150</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1151</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1152</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1153</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br><span class="line">t222    <span class="number">1154</span>    <span class="string">"jiessie"</span>       <span class="number">18</span></span><br></pre></td></tr></table></figure>
<p>从结果上来看，数据重复了一份，通过load data导入只导入一份正常的数据<br>参数解释：<br>-5 -f的参数和page_parser相同，代表 row format为Compact ；<br>-D:该参数的含义为代表恢复删除的数据页； </p>
<h4 id="恢复数据-1"><a href="#恢复数据-1" class="headerlink" title="恢复数据"></a>恢复数据</h4><p>使用上面constraints_parser执行后的load data导入数据，需要注意目录<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-<span class="keyword">for</span>-innodb-<span class="number">0.5</span>]# mysql -uroot -p123456</span><br><span class="line">Warning: <span class="keyword">Using</span> a password <span class="keyword">on</span> the command line <span class="keyword">interface</span> can be insecure.</span><br><span class="line">Welcome <span class="keyword">to</span> the MySQL monitor.  Commands <span class="keyword">end</span> <span class="keyword">with</span> ; <span class="keyword">or</span> \g.</span><br><span class="line">Your MySQL connection id <span class="keyword">is</span> <span class="number">108</span></span><br><span class="line">Server version: <span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) <span class="number">2009</span>-<span class="number">2017</span> Percona LLC <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates</span><br><span class="line">Copyright (c) <span class="number">2000</span>, <span class="number">2017</span>, Oracle <span class="keyword">and</span>/<span class="keyword">or</span> its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle <span class="keyword">is</span> a registered trademark <span class="keyword">of</span> Oracle Corporation <span class="keyword">and</span>/<span class="keyword">or</span> its</span><br><span class="line">affiliates. Other names may be trademarks <span class="keyword">of</span> their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line"><span class="keyword">Type</span> <span class="string">'help;'</span> <span class="keyword">or</span> <span class="string">'\h'</span> <span class="keyword">for</span> help. <span class="keyword">Type</span> <span class="string">'\c'</span> <span class="keyword">to</span> clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] <span class="number">10</span>:<span class="number">28</span>:<span class="number">16</span> &gt; use test111;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [test111] <span class="number">10</span>:<span class="number">28</span>:<span class="number">20</span> &gt; LOAD DATA INFILE <span class="string">'/tmp/0_t222.sql'</span> REPLACE <span class="keyword">INTO</span> TABLE `t222` FIELDS TERMINATED <span class="keyword">BY</span> <span class="string">'\t'</span> OPTIONALLY ENCLOSED <span class="keyword">BY</span> <span class="string">'"'</span> LINES STARTING <span class="keyword">BY</span> <span class="string">'t222\t'</span> (id, name, age);</span><br><span class="line">Query OK, <span class="number">2048</span> rows affected (<span class="number">0.01</span> sec)</span><br><span class="line">Records: <span class="number">2048</span>  Deleted: <span class="number">0</span>  Skipped: <span class="number">0</span>  Warnings: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">10</span>:<span class="number">28</span>:<span class="number">39</span> &gt; <span class="keyword">select</span> count<span class="comment">(*) from t222;</span></span><br><span class="line"><span class="comment">+----------+</span></span><br><span class="line"><span class="comment">| count(*)</span> |</span><br><span class="line">+----------+</span><br><span class="line">|     <span class="number">1024</span> |</span><br><span class="line">+----------+</span><br><span class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] <span class="number">10</span>:<span class="number">28</span>:<span class="number">44</span> &gt; <span class="keyword">select</span> * <span class="keyword">from</span> t222 limit <span class="number">10</span>;</span><br><span class="line">+----+---------+------+</span><br><span class="line">| id | name    | age  |</span><br><span class="line">+----+---------+------+</span><br><span class="line">|  <span class="number">1</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">2</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">3</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">4</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">6</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">7</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">8</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">|  <span class="number">9</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">| <span class="number">13</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">| <span class="number">14</span> | jiessie |   <span class="number">18</span> |</span><br><span class="line">+----+---------+------+</span><br><span class="line"><span class="number">10</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure></p>
<p>从结果看，数据恢复完成   </p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>Percona Data Recovery Tool for InnoDB工具并不保证100%能够恢复数据，而且会存在丢失数据的现象，特别是当发生误删除后，数据文件并没有第一时间保存起来，而导致了被重写。truncate操作在此不做演示，建议还是做好备份恢复工作，并做日常的演练。</p>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/percona-server-5-6-自制rpm包.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/percona-server-5-6-自制rpm包.html" itemprop="url">percona server 5.6 自制rpm包</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-13T16:55:24+08:00">
                2017-07-13
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/安装/" itemprop="url" rel="index">
                    <span itemprop="name">安装</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>RPM是Red-hat系统的软件管理工具，目前，RPM已发展成为业界认可的Linux系统软件工具。RPM制作灵活方便，在安装、升级、卸载等方面有着显著的优点。mysql通过自制RPM包方式，可以缩短编译安装时间，简化安装过程，自定义数据库配置，非常灵活方便，可以极大的提升效率。<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">优点：</span><br><span class="line">RPM内含已编译过的程序与设置文件等数据，可以让用户免除重新编译的困扰。</span><br><span class="line">RPM在被安装之前，会先检查系统的硬盘容量、操作系统版本等，可避免文件被错误安装。</span><br><span class="line">RPM文件本身提供软件版本信息、依赖属性软件名称、软件用途说明、软件所含文件信息，便于了解软件。</span><br><span class="line">RPM管理的方式使用数据库记录RPM文件的相关参数，便于升级、删除、查询与验证。</span><br><span class="line">详情请参考：<span class="string">http:</span><span class="comment">//rpm.org/documentation.html</span></span><br></pre></td></tr></table></figure></p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：centos 6.5 x86_64<br>构建工具：rpmbuild</p>
<h2 id="RPM常用命令"><a href="#RPM常用命令" class="headerlink" title="RPM常用命令"></a>RPM常用命令</h2><h3 id="列出已安装的RPM包"><a href="#列出已安装的RPM包" class="headerlink" title="列出已安装的RPM包"></a>列出已安装的RPM包</h3><h4 id="列出系统中已安装的全部RPM包"><a href="#列出系统中已安装的全部RPM包" class="headerlink" title="列出系统中已安装的全部RPM包"></a>列出系统中已安装的全部RPM包</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -qa|head <span class="number">-10</span>  #由于包太多，用head过滤了前<span class="number">10</span>条</span><br><span class="line">glib2<span class="number">-2.28</span><span class="number">.8</span><span class="number">-5.</span>el6.x86_64</span><br><span class="line">gnome-icon-theme<span class="number">-2.28</span><span class="number">.0</span><span class="number">-8.</span>el6.noarch</span><br><span class="line">bind-libs<span class="number">-9.8</span><span class="number">.2</span><span class="number">-0.23</span>.rc1.el6_5<span class="number">.1</span>.x86_64</span><br><span class="line">mhash<span class="number">-0.9</span><span class="number">.9</span><span class="number">.9</span><span class="number">-3.</span>el6.x86_64</span><br><span class="line">libreport<span class="number">-2.0</span><span class="number">.9</span><span class="number">-19.</span>el6.centos.x86_64</span><br><span class="line">libcroco<span class="number">-0.6</span><span class="number">.2</span><span class="number">-5.</span>el6.x86_64</span><br><span class="line">libcap<span class="number">-2.16</span><span class="number">-5.5</span>.el6.x86_64</span><br><span class="line">libxml2-python<span class="number">-2.7</span><span class="number">.6</span><span class="number">-21.</span>el6_8<span class="number">.1</span>.x86_64</span><br><span class="line">abrt-addon-kerneloops<span class="number">-2.0</span><span class="number">.8</span><span class="number">-21.</span>el6.centos.x86_64</span><br><span class="line">libasyncns<span class="number">-0.8</span><span class="number">-1.1</span>.el6.x86_64</span><br></pre></td></tr></table></figure>
<h4 id="列出系统中以mysql开头的RPM包"><a href="#列出系统中以mysql开头的RPM包" class="headerlink" title="列出系统中以mysql开头的RPM包"></a>列出系统中以mysql开头的RPM包</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@iZuf6c08fdv8duubho2b0rZ ~]</span># <span class="selector-tag">rpm</span> <span class="selector-tag">-qa</span> "<span class="selector-tag">mysql</span>*"</span><br><span class="line"><span class="selector-tag">mysql-community-libs-5</span><span class="selector-class">.7</span><span class="selector-class">.16-1</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span></span><br><span class="line"><span class="selector-tag">mysql-libs-5</span><span class="selector-class">.1</span><span class="selector-class">.73-3</span><span class="selector-class">.el6_5</span><span class="selector-class">.x86_64</span></span><br><span class="line"><span class="selector-tag">mysql-devel-5</span><span class="selector-class">.1</span><span class="selector-class">.73-8</span><span class="selector-class">.el6_8</span><span class="selector-class">.x86_64</span></span><br><span class="line"><span class="selector-tag">mysql-5</span><span class="selector-class">.7</span><span class="selector-class">.17-1</span><span class="selector-class">.el6</span><span class="selector-class">.x86_64</span></span><br></pre></td></tr></table></figure>
<h4 id="列出系统中包括mysql关键字的RPM包"><a href="#列出系统中包括mysql关键字的RPM包" class="headerlink" title="列出系统中包括mysql关键字的RPM包"></a>列出系统中包括mysql关键字的RPM包</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -qa|grep <span class="string">"mysql"</span>  </span><br><span class="line">php56w-mysql<span class="number">-5.6</span><span class="number">.30</span><span class="number">-1.</span>w6.x86_64</span><br><span class="line">mysql-community-libs<span class="number">-5.7</span><span class="number">.16</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">zabbix-server-mysql<span class="number">-3.0</span><span class="number">.9</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">mysql-libs<span class="number">-5.1</span><span class="number">.73</span><span class="number">-3.</span>el6_5.x86_64</span><br><span class="line">mysql-devel<span class="number">-5.1</span><span class="number">.73</span><span class="number">-8.</span>el6_8.x86_64</span><br><span class="line">mysql<span class="number">-5.7</span><span class="number">.17</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">zabbix-web-mysql<span class="number">-3.0</span><span class="number">.9</span><span class="number">-1.</span>el6.noarch</span><br></pre></td></tr></table></figure>
<h4 id="列出系统中近期安装的RPM包"><a href="#列出系统中近期安装的RPM包" class="headerlink" title="列出系统中近期安装的RPM包"></a>列出系统中近期安装的RPM包</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -qa --last | head </span><br><span class="line">tree<span class="number">-1.5</span><span class="number">.3</span><span class="number">-3.</span>el6.x86_64                       <span class="number">2017</span>年<span class="number">07</span>月<span class="number">13</span>日 星期四 <span class="number">09</span>时<span class="number">35</span>分<span class="number">13</span>秒</span><br><span class="line">git<span class="number">-1.7</span><span class="number">.1</span><span class="number">-8.</span>el6.x86_64                        <span class="number">2017</span>年<span class="number">07</span>月<span class="number">12</span>日 星期三 <span class="number">10</span>时<span class="number">29</span>分<span class="number">20</span>秒</span><br><span class="line">perl-Git<span class="number">-1.7</span><span class="number">.1</span><span class="number">-8.</span>el6.noarch                   <span class="number">2017</span>年<span class="number">07</span>月<span class="number">12</span>日 星期三 <span class="number">10</span>时<span class="number">29</span>分<span class="number">19</span>秒</span><br><span class="line">elfutils<span class="number">-0.164</span><span class="number">-2.</span>el6.x86_64                   <span class="number">2017</span>年<span class="number">07</span>月<span class="number">11</span>日 星期二 <span class="number">10</span>时<span class="number">30</span>分<span class="number">26</span>秒</span><br><span class="line">perf<span class="number">-2.6</span><span class="number">.32</span><span class="number">-696.3</span><span class="number">.2</span>.el6.x86_64                <span class="number">2017</span>年<span class="number">07</span>月<span class="number">11</span>日 星期二 <span class="number">10</span>时<span class="number">30</span>分<span class="number">25</span>秒</span><br><span class="line">elfutils-libs<span class="number">-0.164</span><span class="number">-2.</span>el6.x86_64              <span class="number">2017</span>年<span class="number">07</span>月<span class="number">11</span>日 星期二 <span class="number">10</span>时<span class="number">30</span>分<span class="number">25</span>秒</span><br><span class="line">elfutils-libelf<span class="number">-0.164</span><span class="number">-2.</span>el6.x86_64            <span class="number">2017</span>年<span class="number">07</span>月<span class="number">11</span>日 星期二 <span class="number">10</span>时<span class="number">30</span>分<span class="number">25</span>秒</span><br><span class="line">pmm-client<span class="number">-1.1</span><span class="number">.6</span><span class="number">-1.</span>x86_64                     <span class="number">2017</span>年<span class="number">07</span>月<span class="number">10</span>日 星期一 <span class="number">16</span>时<span class="number">58</span>分<span class="number">04</span>秒</span><br><span class="line">gcc-gfortran<span class="number">-4.4</span><span class="number">.7</span><span class="number">-18.</span>el6.x86_64              <span class="number">2017</span>年<span class="number">07</span>月<span class="number">06</span>日 星期四 <span class="number">15</span>时<span class="number">40</span>分<span class="number">43</span>秒</span><br><span class="line">gcc-c++<span class="number">-4.4</span><span class="number">.7</span><span class="number">-18.</span>el6.x86_64                   <span class="number">2017</span>年<span class="number">07</span>月<span class="number">06</span>日 星期四 <span class="number">15</span>时<span class="number">40</span>分<span class="number">43</span>秒</span><br></pre></td></tr></table></figure>
<h3 id="查找特定RPM包"><a href="#查找特定RPM包" class="headerlink" title="查找特定RPM包"></a>查找特定RPM包</h3><h4 id="查找某RPM包是否安装"><a href="#查找某RPM包是否安装" class="headerlink" title="查找某RPM包是否安装"></a>查找某RPM包是否安装</h4><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># rpm -q mysql-server</span></span><br><span class="line">package mysql-server <span class="keyword">is</span> <span class="keyword">not</span> installed</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># rpm -q zabbix</span></span><br><span class="line">package zabbix <span class="keyword">is</span> <span class="keyword">not</span> installed</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># </span></span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># rpm -q gcc</span></span><br><span class="line">gcc<span class="number">-4.4</span><span class="number">.7</span><span class="number">-18.</span>el6.x86_64</span><br></pre></td></tr></table></figure>
<h4 id="查找某RPM包的基本信息"><a href="#查找某RPM包的基本信息" class="headerlink" title="查找某RPM包的基本信息"></a>查找某RPM包的基本信息</h4><figure class="highlight ada"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -q percona-server</span><br><span class="line">percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.x86_64</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# </span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -qi percona-server</span><br><span class="line">Name        : <span class="type">percona</span>-server               Relocations: /usr/local/percona </span><br><span class="line">Version     : 5.6.36                            <span class="type">Vendor</span>: Jiessie</span><br><span class="line">Release     : 82.0                          <span class="type">Build</span> Date: <span class="number">2017</span>年<span class="number">06</span>月<span class="number">20</span>日 星期二 <span class="number">13</span>时<span class="number">08</span>分<span class="number">20</span>秒</span><br><span class="line">Install Date: <span class="number">2017</span>年<span class="number">06</span>月<span class="number">20</span>日 星期二 <span class="number">13</span>时<span class="number">42</span>分<span class="number">36</span>秒      Build Host: iZuf6c08fdv8duubho2b0rZ</span><br><span class="line">Group       : <span class="type">applications</span>/database         Source RPM: percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.src.rpm</span><br><span class="line">Size        : 460543421                        <span class="type">License</span>: GPL</span><br><span class="line">Signature   : (<span class="type">none</span>)</span><br><span class="line">Packager    : <span class="type">dwj999</span>@<span class="number">163</span>.com</span><br><span class="line">URL         : <span class="type">https</span>://www.percona.com/downloads/Percona-Server-<span class="number">5.6</span>/Percona-Server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>/source/tarball/percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.tar.gz</span><br><span class="line">Summary     : <span class="type">percona</span>-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span></span><br><span class="line">Description :</span><br><span class="line">Percona Server <span class="keyword">is</span> an enhanced, drop-<span class="keyword">in</span> MySQL® replacement which has been downloaded more than <span class="number">1</span>,<span class="number">000</span>,<span class="number">000</span> times.</span><br><span class="line">A free open source solution, Percona Server <span class="keyword">is</span> a MySQL alternative which offers breakthrough performance, scalability, features, <span class="keyword">and</span> instrumentation. Self-tuning algorithms <span class="keyword">and</span> support <span class="keyword">for</span> extremely high-performance hardware make it the clear choice <span class="keyword">for</span> organizations that demand excellent performance <span class="keyword">and</span> reliability from their MySQL database server.</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]#</span><br></pre></td></tr></table></figure>
<h4 id="查找某RPM包的配置信息"><a href="#查找某RPM包的配置信息" class="headerlink" title="查找某RPM包的配置信息"></a>查找某RPM包的配置信息</h4><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -qc httpd</span><br><span class="line">/etc/httpd/<span class="keyword">conf</span>.<span class="keyword">d</span>/welcome.<span class="keyword">conf</span></span><br><span class="line">/etc/httpd/<span class="keyword">conf</span>/httpd.<span class="keyword">conf</span></span><br><span class="line">/etc/httpd/<span class="keyword">conf</span>/magic</span><br><span class="line">/etc/logrotate.<span class="keyword">d</span>/httpd</span><br><span class="line">/etc/sysconfig/htcacheclean</span><br><span class="line">/etc/sysconfig/httpd</span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_BAD_GATEWAY.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_BAD_REQUEST.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_FORBIDDEN.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_GONE.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_INTERNAL_SERVER_ERROR.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_LENGTH_REQUIRED.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_METHOD_NOT_ALLOWED.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_NOT_FOUND.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_NOT_IMPLEMENTED.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_PRECONDITION_FAILED.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_REQUEST_ENTITY_TOO_LARGE.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_REQUEST_TIME_OUT.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_REQUEST_URI_TOO_LARGE.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_SERVICE_UNAVAILABLE.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_UNAUTHORIZED.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_UNSUPPORTED_MEDIA_TYPE.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/HTTP_VARIANT_ALSO_VARIES.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/contact.html.<span class="keyword">var</span></span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/<span class="keyword">include</span>/bottom.html</span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/<span class="keyword">include</span>/spacer.html</span><br><span class="line">/<span class="keyword">var</span>/www/<span class="keyword">error</span>/<span class="keyword">include</span>/top.html</span><br></pre></td></tr></table></figure>
<h4 id="查找某RPM包的文档信息"><a href="#查找某RPM包的文档信息" class="headerlink" title="查找某RPM包的文档信息"></a>查找某RPM包的文档信息</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="meta"># rpm -qd httpd</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>httpd<span class="number">-2.2</span><span class="number">.15</span>/ABOUT_APACHE</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>httpd<span class="number">-2.2</span><span class="number">.15</span>/CHANGES</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>httpd<span class="number">-2.2</span><span class="number">.15</span>/LICENSE</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>httpd<span class="number">-2.2</span><span class="number">.15</span>/NOTICE</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>httpd<span class="number">-2.2</span><span class="number">.15</span>/README</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>httpd<span class="number">-2.2</span><span class="number">.15</span>/VERSIONING</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man8/apachectl<span class="number">.8</span>.gz</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man8/htcacheclean<span class="number">.8</span>.gz</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man8/httpd<span class="number">.8</span>.gz</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man8/rotatelogs<span class="number">.8</span>.gz</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man8/suexec<span class="number">.8</span>.gz</span><br></pre></td></tr></table></figure>
<h4 id="查找某RPM包的状态"><a href="#查找某RPM包的状态" class="headerlink" title="查找某RPM包的状态"></a>查找某RPM包的状态</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="meta"># rpm -qs rsync</span></span><br><span class="line">normal        <span class="meta-keyword">/etc/</span>xinetd.d/rsync</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>bin/rsync</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span></span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/COPYING</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/NEWS</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/OLDNEWS</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/README</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/support</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>Makefile</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>atomic-rsync</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>cvs2includes</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>deny-rsync</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>file-attr-restore</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>files-to-excludes</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>git-set-file-times</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>logfilter</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>lsh</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>mnt-excl</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>munge-symlinks</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>rrsync</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>rsyncstats</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>savetransfer.c</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/tech_report.tex</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man1/rsync<span class="number">.1</span>.gz</span><br><span class="line">normal        <span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man5/rsyncd.conf<span class="number">.5</span>.gz</span><br></pre></td></tr></table></figure>
<p>RPM包的状态</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>说明 </th>
</tr>
</thead>
<tbody>
<tr>
<td>Normal</td>
<td>正常，表明文件未被其他软件包修改过</td>
</tr>
<tr>
<td>not installed</td>
<td>未安装，表明文件未安装</td>
</tr>
<tr>
<td>Replaced</td>
<td>已替换，表明文件已被其他软件包修改替换过，不再是原先的文件</td>
</tr>
<tr>
<td>net shared</td>
<td>网络共享，表明文件处于网络共享状态</td>
</tr>
</tbody>
</table>
<h4 id="查找某RPM包的所有文件"><a href="#查找某RPM包的所有文件" class="headerlink" title="查找某RPM包的所有文件"></a>查找某RPM包的所有文件</h4><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="meta"># rpm -ql rsync</span></span><br><span class="line"><span class="meta-keyword">/etc/</span>xinetd.d/rsync</span><br><span class="line"><span class="meta-keyword">/usr/</span>bin/rsync</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span></span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/COPYING</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/NEWS</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/OLDNEWS</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/README</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/support</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>Makefile</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>atomic-rsync</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>cvs2includes</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>deny-rsync</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>file-attr-restore</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>files-to-excludes</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>git-set-file-times</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>logfilter</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>lsh</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>mnt-excl</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>munge-symlinks</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>rrsync</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>rsyncstats</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span><span class="meta-keyword">/support/</span>savetransfer.c</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/doc/</span>rsync<span class="number">-3.0</span><span class="number">.6</span>/tech_report.tex</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man1/rsync<span class="number">.1</span>.gz</span><br><span class="line"><span class="meta-keyword">/usr/</span>share<span class="meta-keyword">/man/</span>man5/rsyncd.conf<span class="number">.5</span>.gz</span><br></pre></td></tr></table></figure>
<h4 id="查找某RPM包的安装、卸载前后的脚本"><a href="#查找某RPM包的安装、卸载前后的脚本" class="headerlink" title="查找某RPM包的安装、卸载前后的脚本"></a>查找某RPM包的安装、卸载前后的脚本</h4><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -q --scripts httpd         </span><br><span class="line">preinstall scriptlet (using /bin/sh):</span><br><span class="line"><span class="comment"># Add the "apache" user</span></span><br><span class="line">getent<span class="built_in"> group </span>apache &gt;/dev/<span class="literal">null</span> || groupadd -g 48 -r apache</span><br><span class="line">getent passwd apache &gt;/dev/<span class="literal">null</span> || \</span><br><span class="line">  useradd -r -u 48 -g apache -s /sbin/nologin \</span><br><span class="line">    -d /var/www -c <span class="string">"Apache"</span> apache</span><br><span class="line">exit 0</span><br><span class="line">postinstall scriptlet (using /bin/sh):</span><br><span class="line"><span class="comment"># Register the httpd service</span></span><br><span class="line">/sbin/chkconfig --<span class="builtin-name">add</span> httpd</span><br><span class="line">/sbin/chkconfig --<span class="builtin-name">add</span> htcacheclean</span><br><span class="line">preuninstall scriptlet (using /bin/sh):</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$1</span> = 0 ]; then</span><br><span class="line">        /sbin<span class="built_in">/service </span>httpd stop &gt; /dev/<span class="literal">null</span> 2&gt;&amp;1</span><br><span class="line">        /sbin/chkconfig --del httpd</span><br><span class="line">        /sbin<span class="built_in">/service </span>htcacheclean stop &gt; /dev/<span class="literal">null</span> 2&gt;&amp;1</span><br><span class="line">        /sbin/chkconfig --del htcacheclean</span><br><span class="line">fi</span><br><span class="line">posttrans scriptlet (using /bin/sh):</span><br><span class="line">test -f /etc/sysconfig/httpd-disable-posttrans || \</span><br><span class="line"> /sbin<span class="built_in">/service </span>httpd condrestart &gt;/dev/<span class="literal">null</span> 2&gt;&amp;1 || :</span><br></pre></td></tr></table></figure>
<h4 id="查找某RPM包的修改历史"><a href="#查找某RPM包的修改历史" class="headerlink" title="查找某RPM包的修改历史"></a>查找某RPM包的修改历史</h4><figure class="highlight coffeescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="comment"># rpm -q --changelog python |head -10</span></span><br><span class="line">* 二 <span class="number">8</span>月 <span class="number">09</span> <span class="number">2016</span> Charalampos Stratakis &lt;cstratak@redhat.com&gt; - <span class="number">2.6</span><span class="number">.6</span><span class="number">-66</span></span><br><span class="line">- Fix <span class="keyword">for</span> CVE<span class="number">-2016</span><span class="number">-1000110</span> HTTPoxy attack</span><br><span class="line">Resolves: rhbz<span class="comment">#1359161</span></span><br><span class="line"></span><br><span class="line">* 二 <span class="number">6</span>月 <span class="number">21</span> <span class="number">2016</span> Tomas Orsava &lt;torsava@redhat.com&gt; - <span class="number">2.6</span><span class="number">.6</span><span class="number">-65</span></span><br><span class="line">- Fix <span class="keyword">for</span> CVE<span class="number">-2016</span><span class="number">-0772</span> python: smtplib StartTLS stripping attack (rhbz<span class="comment">#1303647)</span></span><br><span class="line">  Raise an error <span class="keyword">when</span> STARTTLS fails (upstream patch)</span><br><span class="line">- Fix <span class="keyword">for</span> CVE<span class="number">-2016</span><span class="number">-5699</span> python: http protocol steam injection attack (rhbz<span class="comment">#1303699)</span></span><br><span class="line">  Disabled HTTP header injections <span class="keyword">in</span> httplib (upstream patch)</span><br><span class="line">Resolves: rhbz<span class="comment">#1346354</span></span><br></pre></td></tr></table></figure>
<h4 id="查找某个组群里的RPM包"><a href="#查找某个组群里的RPM包" class="headerlink" title="查找某个组群里的RPM包"></a>查找某个组群里的RPM包</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -qg Applications/Databases </span><br><span class="line">db4-utils<span class="number">-4.7</span><span class="number">.25</span><span class="number">-18.</span>el6_4.x86_64</span><br><span class="line">mysql-libs<span class="number">-5.1</span><span class="number">.73</span><span class="number">-3.</span>el6_5.x86_64</span><br><span class="line">percona-xtrabackup<span class="number">-2.3</span><span class="number">.6</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">Percona-Server-client<span class="number">-51</span><span class="number">-5.1</span><span class="number">.73</span>-rel14<span class="number">.12</span><span class="number">.624</span>.rhel6.x86_64</span><br><span class="line">rh-postgresql95-postgresql-libs<span class="number">-9.5</span><span class="number">.4</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">postgresql95-libs<span class="number">-9.5</span><span class="number">.5</span><span class="number">-1</span>PGDG.rhel6.x86_64</span><br><span class="line">postgresql95<span class="number">-9.5</span><span class="number">.5</span><span class="number">-1</span>PGDG.rhel6.x86_64</span><br><span class="line">postgresql95-contrib<span class="number">-9.5</span><span class="number">.5</span><span class="number">-1</span>PGDG.rhel6.x86_64</span><br><span class="line">postgresql95-server<span class="number">-9.5</span><span class="number">.5</span><span class="number">-1</span>PGDG.rhel6.x86_64</span><br><span class="line">sqlite<span class="number">-3.6</span><span class="number">.20</span><span class="number">-1.</span>el6_7<span class="number">.2</span>.x86_64</span><br><span class="line">mongodb<span class="number">-2.4</span><span class="number">.14</span><span class="number">-4.</span>el6.x86_64</span><br><span class="line">mongodb-server<span class="number">-2.4</span><span class="number">.14</span><span class="number">-4.</span>el6.x86_64</span><br><span class="line">mysql-devel<span class="number">-5.1</span><span class="number">.73</span><span class="number">-8.</span>el6_8.x86_64</span><br><span class="line">innotop<span class="number">-1.11</span><span class="number">.4</span><span class="number">-1.</span>el6.noarch</span><br><span class="line">Percona-Server-shared<span class="number">-56</span><span class="number">-5.6</span><span class="number">.35</span>-rel80<span class="number">.0</span>.el6.x86_64</span><br><span class="line">mysql-community-libs<span class="number">-5.7</span><span class="number">.16</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">redis<span class="number">-2.4</span><span class="number">.10</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">percona-toolkit<span class="number">-3.0</span><span class="number">.3</span><span class="number">-1.</span>el6.x86_64</span><br><span class="line">percona-zabbix-templates<span class="number">-1.1</span><span class="number">.7</span><span class="number">-2.</span>noarch</span><br><span class="line">pmm-client<span class="number">-1.1</span><span class="number">.6</span><span class="number">-1.</span>x86_64</span><br></pre></td></tr></table></figure>
<p>通常，RPM 可以分为这几大类：娱乐（Amusement）、开发（Development）、文档（Document）、硬件（Hardware）、综合包（Metapackages）、多媒体（Multimedia）、生产力（Productivity）和系统（System）。</p>
<h3 id="查询特定RPM包依赖"><a href="#查询特定RPM包依赖" class="headerlink" title="查询特定RPM包依赖"></a>查询特定RPM包依赖</h3><h4 id="查询RPM包依赖"><a href="#查询RPM包依赖" class="headerlink" title="查询RPM包依赖"></a>查询RPM包依赖</h4><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -q --requires percona-server</span><br><span class="line">coreutils  </span><br><span class="line">shadow-utils  </span><br><span class="line">/bin/sh  </span><br><span class="line">/bin/sh  </span><br><span class="line">/bin/sh  </span><br><span class="line">/bin/sh  </span><br><span class="line">rpmlib(FileDigests) &lt;= <span class="number">4.6</span><span class="number">.0</span><span class="number">-1</span></span><br><span class="line">rpmlib(PayloadFilesHavePrefix) &lt;= <span class="number">4.0</span><span class="number">-1</span></span><br><span class="line">rpmlib(CompressedFileNames) &lt;= <span class="number">3.0</span><span class="number">.4</span><span class="number">-1</span></span><br><span class="line">rpmlib(PayloadIsXz) &lt;= <span class="number">5.2</span><span class="number">-1</span></span><br></pre></td></tr></table></figure>
<h4 id="查询RPM包提供"><a href="#查询RPM包提供" class="headerlink" title="查询RPM包提供"></a>查询RPM包提供</h4><figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# rpm -q --provides percona-server</span><br><span class="line">adt_null.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">audit_log.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">auth.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">auth_socket.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">auth_test_plugin.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">connection_control.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">ha_tokudb.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">handlersocket.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">innodb_engine.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libHotBackup.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libdaemon_example.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libfnv1a_udf.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libfnv_udf.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libmemcached.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libmurmur_udf.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libperconaserverclient.<span class="keyword">so</span>.<span class="number">18</span>()(<span class="number">64</span>bit)  </span><br><span class="line">libperconaserverclient.<span class="keyword">so</span>.<span class="number">18</span>(libperconaserverclient_18)(<span class="number">64</span>bit)  </span><br><span class="line">mypluglib.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">mysql_no_login.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line"><span class="keyword">perl</span>(My::Config)  </span><br><span class="line"><span class="keyword">perl</span>(My::Confi<span class="variable">g:</span>:Group)  </span><br><span class="line"><span class="keyword">perl</span>(My::Confi<span class="variable">g:</span>:Option)  </span><br><span class="line"><span class="keyword">perl</span>(My::ConfigFactory)  </span><br><span class="line"><span class="keyword">perl</span>(My::CoreDump)  </span><br><span class="line"><span class="keyword">perl</span>(My::Exec)  </span><br><span class="line"><span class="keyword">perl</span>(My::File::Path)  </span><br><span class="line"><span class="keyword">perl</span>(My::Find)  </span><br><span class="line"><span class="keyword">perl</span>(My::Handles)  </span><br><span class="line"><span class="keyword">perl</span>(My::Memcache)  </span><br><span class="line"><span class="keyword">perl</span>(My::Memcache::Binary)  </span><br><span class="line"><span class="keyword">perl</span>(My::Options)  </span><br><span class="line"><span class="keyword">perl</span>(My::Platform)  </span><br><span class="line"><span class="keyword">perl</span>(My::SafeProcess)  </span><br><span class="line"><span class="keyword">perl</span>(My::SafeProces<span class="variable">s:</span>:Base)  </span><br><span class="line"><span class="keyword">perl</span>(My::Suite::Query_response_time)  </span><br><span class="line"><span class="keyword">perl</span>(My::SysInfo)  </span><br><span class="line"><span class="keyword">perl</span>(My::Test)  </span><br><span class="line"><span class="keyword">perl</span>(Subunit) = <span class="number">0.0</span>.<span class="number">2</span></span><br><span class="line"><span class="keyword">perl</span>(mtr_cases)  </span><br><span class="line"><span class="keyword">perl</span>(mtr_match)  </span><br><span class="line"><span class="keyword">perl</span>(mtr_report)  </span><br><span class="line"><span class="keyword">perl</span>(mtr_results)  </span><br><span class="line"><span class="keyword">perl</span>(mtr_unique)  </span><br><span class="line">qa_auth_client.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">qa_auth_interface.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">qa_auth_server.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">query_response_time.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">semisync_master.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">semisync_slave.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">test_udf_services.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">tokudb_backup.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">validate_password.<span class="keyword">so</span>()(<span class="number">64</span>bit)  </span><br><span class="line">percona-server = <span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span></span><br><span class="line">percona-server(x86-<span class="number">64</span>) = <span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span></span><br></pre></td></tr></table></figure>
<h4 id="查询某依赖的RPM包"><a href="#查询某依赖的RPM包" class="headerlink" title="查询某依赖的RPM包"></a>查询某依赖的RPM包</h4><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-attr">[root@iZuf6c08fdv8duubho2b0rZ ~]</span># <span class="selector-tag">rpm</span> <span class="selector-tag">-q</span> <span class="selector-tag">--whatrequires</span> <span class="selector-tag">openssl</span> </span><br><span class="line"><span class="selector-tag">postfix-2</span><span class="selector-class">.6</span><span class="selector-class">.6-6</span><span class="selector-class">.el6_5</span><span class="selector-class">.x86_64</span></span><br><span class="line"><span class="selector-tag">openssl-devel-1</span><span class="selector-class">.0</span><span class="selector-class">.1e-48</span><span class="selector-class">.el6_8</span><span class="selector-class">.4</span><span class="selector-class">.x86_64</span></span><br></pre></td></tr></table></figure>
<h2 id="RPM包的验证"><a href="#RPM包的验证" class="headerlink" title="RPM包的验证"></a>RPM包的验证</h2><h3 id="验证某个RPM包状态"><a href="#验证某个RPM包状态" class="headerlink" title="验证某个RPM包状态"></a>验证某个RPM包状态</h3><figure class="highlight dts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]<span class="meta"># rpm -V percona-server</span></span><br><span class="line">missing     <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/percona/</span>data</span><br><span class="line">missing     <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/percona/</span>data/test</span><br><span class="line">missing     <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/percona/</span>data<span class="meta-keyword">/test/</span>db.opt</span><br><span class="line">missing     <span class="meta-keyword">/usr/</span>local<span class="meta-keyword">/percona/</span>my.cnf</span><br><span class="line">此处由于自定义了RPM包，配置文件和数据目录转移了，显示missing</span><br></pre></td></tr></table></figure>
<h2 id="RPM包的备份与恢复"><a href="#RPM包的备份与恢复" class="headerlink" title="RPM包的备份与恢复"></a>RPM包的备份与恢复</h2><p>RPM的Database文件存放在/var/lib/rpm目录。除了 __db.00* 是数据文件外，其他文件都属于 Berkeley DB 格式,所以要注意备份此目录。</p>
<h2 id="RPM延伸"><a href="#RPM延伸" class="headerlink" title="RPM延伸"></a>RPM延伸</h2><p>其他高级用法，请参考：<a href="https://docs.fedoraproject.org/en-US/Fedora_Draft_Documentation/0.1/html/RPM_Guide/index.html" target="_blank" rel="noopener">https://docs.fedoraproject.org/en-US/Fedora_Draft_Documentation/0.1/html/RPM_Guide/index.html</a></p>
<h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="keyword">install </span>rpm-<span class="keyword">build </span>readline-devel redhat-rpm-<span class="built_in">config</span> gcc gcc-c++ cmake make zlib-devel openssl-devel perl libtool automake autoconf time ccache <span class="keyword">bison </span>libaio-devel gperf</span><br></pre></td></tr></table></figure>
<h2 id="创建用户及配置"><a href="#创建用户及配置" class="headerlink" title="创建用户及配置"></a>创建用户及配置</h2><h3 id="创建用户"><a href="#创建用户" class="headerlink" title="创建用户"></a>创建用户</h3><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">useradd jiessie</span> </span><br><span class="line"><span class="attribute">su - jiessie</span></span><br></pre></td></tr></table></figure>
<h3 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h3><figure class="highlight jboss-cli"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~<span class="string">/rpmbuild/</span>&#123;BUILD,RPMS,SOURCES,SPECS,SRPMS&#125; </span><br><span class="line"><span class="keyword">echo</span> '%_topdir <span class="string">/home/jiessie/rpmbuild</span>' &gt; ~<span class="string">/.rpmmacros</span></span><br></pre></td></tr></table></figure>
<h2 id="RPMBUILD"><a href="#RPMBUILD" class="headerlink" title="RPMBUILD"></a>RPMBUILD</h2><h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root<span class="symbol">@iZuf6c08fdv8duubho2b0rZ</span> jiessie]<span class="meta"># tree rpmbuild/</span></span><br><span class="line">rpmbuild/</span><br><span class="line">├── BUILD   <span class="meta">#编译生成的临时文件</span></span><br><span class="line">├── RPMS    <span class="meta">#RPM包存放目录</span></span><br><span class="line">├── SOURCES <span class="meta">#源码存放目录</span></span><br><span class="line">├── SPECS   <span class="meta">#SPEC文件目录</span></span><br><span class="line">└── SRPMS   <span class="meta">#SRC RPM包存放目录</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span> directories, <span class="number">0</span> files</span><br></pre></td></tr></table></figure>
<h3 id="编写SPEC文件"><a href="#编写SPEC文件" class="headerlink" title="编写SPEC文件"></a>编写SPEC文件</h3><p>详情，请参考：<a href="https://fedoraproject.org/wiki/How_to_create_an_RPM_package/zh-cn#.25prep_.E9.83.A8.E5.88.86" target="_blank" rel="noopener">https://fedoraproject.org/wiki/How_to_create_an_RPM_package/zh-cn#.25prep_.E9.83.A8.E5.88.86</a><br><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">-bash-<span class="number">4.1</span>$ cat percona.<span class="number">5.6</span>.<span class="number">36</span>.spec </span><br><span class="line"><span class="symbol">Name:</span> percona-server    <span class="comment">#软件包名</span></span><br><span class="line"><span class="symbol">Version:</span><span class="number">5.6</span>.<span class="number">36</span>          <span class="comment">#版本号</span></span><br><span class="line"><span class="symbol">Release:</span> <span class="number">82.0</span>           <span class="comment">#发布序列号</span></span><br><span class="line"><span class="symbol">License:</span> GPL            <span class="comment">#软件授权方式      </span></span><br><span class="line"><span class="symbol">Vendor:</span> Jiessie         <span class="comment">#作者信息 </span></span><br><span class="line"></span><br><span class="line"><span class="symbol">Group:</span> applications/database        <span class="comment">#软件包所属类别</span></span><br><span class="line"><span class="symbol">URL:</span> <span class="symbol">https:</span>/<span class="regexp">/www.percona.com/downloads</span><span class="regexp">/Percona-Server-5.6/</span>Percona-Server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>/source/tarball/percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.tar.gz    <span class="comment">#软件的项目主页</span></span><br><span class="line"><span class="symbol">BuildRoot:</span> <span class="string">%&#123;_tmppath&#125;</span>/<span class="string">%&#123;name&#125;</span>-<span class="string">%&#123;version&#125;</span>-<span class="string">%&#123;release&#125;</span>-root   <span class="comment">#安装或编译时使用的虚拟目录，在生成rpm的过程中，执行make install时就会把软件安装到该路径中，默认构建根目录为%&#123;_topdir&#125;/BUILDROOT，可以用$RPM_BUILD_ROOT方式引用</span></span><br><span class="line"><span class="symbol">BuildRequires:</span> cmake                        <span class="comment">#编译过程中需要的包列表</span></span><br><span class="line"><span class="symbol">Requires:</span> coreutils,shadow-utils            <span class="comment">#程序安装时需要的包列表</span></span><br><span class="line"><span class="symbol">Packager:</span> dwj999@163.com                    <span class="comment">#打包者信息</span></span><br><span class="line"><span class="symbol">Autoreq:</span> no</span><br><span class="line"><span class="symbol">Source:</span> percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.tar.gz   <span class="comment">#源代码包</span></span><br><span class="line"><span class="symbol">prefix:</span> /usr/local/percona                  <span class="comment">#rpm包安装的路径</span></span><br><span class="line"><span class="symbol">Summary:</span> percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>         <span class="comment">#一行简短的软件包介绍</span></span><br><span class="line"></span><br><span class="line">%description                                <span class="comment">#软件包详细说明，可写在多个行上</span></span><br><span class="line">Percona Server is an enhanced, drop-<span class="keyword">in</span> MySQL® replacement which has been downloaded more than <span class="number">1</span>,<span class="number">000</span>,<span class="number">000</span> times.</span><br><span class="line">A free open source solution, Percona Server is a MySQL alternative which offers breakthrough performance, scalability, features, <span class="keyword">and</span> instrumentation. Self-tuning algorithms <span class="keyword">and</span> support <span class="keyword">for</span> extremely high-performance hardware make it the clear choice <span class="keyword">for</span> organizations that demand excellent performance <span class="keyword">and</span> reliability from their MySQL database server.</span><br><span class="line"></span><br><span class="line">%define MYSQL_USER mysql                    <span class="comment">#定义的MYSQL_USER变量</span></span><br><span class="line">%define MYSQL_GROUP mysql                   <span class="comment">#定义的MYSQL_GROUP变量</span></span><br><span class="line">%define __os_install_post <span class="string">%&#123;nil&#125;</span></span><br><span class="line"></span><br><span class="line">%prep                                       <span class="comment">#这个段是预处理段，通常用来执行一些解开源程序包的命令，为下一步的编译安装作准备。读取位于%_sourcedir(~/rpmbuild/SOURCES)目录的源代码和patch，随后会解压源代码至%_builddir(~/rpmbuild/BUILD)下的子目录并应用所有patch，描述解压源代码的方法，包含%setup和%patch命令</span></span><br><span class="line">%setup -q -n <span class="string">%&#123;name&#125;</span>-<span class="string">%&#123;version&#125;</span>-<span class="string">%&#123;release&#125;</span>  <span class="comment">#-q不输出信息，-n解压到指定目录中</span></span><br><span class="line"></span><br><span class="line">%build  <span class="comment">#包含构建阶段执行的命令，构建完成后便开始后续安装</span></span><br><span class="line">CFLAGS=<span class="string">"-O3 -g -static-libgcc -fno-omit-frame-pointer -fno-strict-aliasing"</span></span><br><span class="line">CXX=g++</span><br><span class="line">CXXFLAGS=<span class="string">"-O3 -g -fno-rtti -static-libgcc -fno-omit-frame-pointer -fno-strict-aliasing"</span></span><br><span class="line">export CFLAGS CXX CXXFLAGS</span><br><span class="line"></span><br><span class="line">cmake .                                                  \</span><br><span class="line">  -<span class="symbol">DSYSCONFDIR:</span>PATH=<span class="string">%&#123;prefix&#125;</span>                            \</span><br><span class="line">  -<span class="symbol">DCMAKE_INSTALL_PREFIX:</span>PATH=<span class="string">%&#123;prefix&#125;</span>                  \</span><br><span class="line">  -<span class="symbol">DCMAKE_BUILD_TYPE:</span>STRING=Release                      \</span><br><span class="line">  -<span class="symbol">DENABLE_PROFILING:</span>BOOL=ON                             \</span><br><span class="line">  -<span class="symbol">DWITH_DEBUG:</span>BOOL=OFF                                  \</span><br><span class="line">  -<span class="symbol">DWITH_VALGRIND:</span>BOOL=OFF                               \</span><br><span class="line">  -<span class="symbol">DENABLE_DEBUG_SYNC:</span>BOOL=OFF                           \</span><br><span class="line">  -<span class="symbol">DWITH_EXTRA_CHARSETS:</span>STRING=all                       \</span><br><span class="line">  -<span class="symbol">DWITH_SSL:</span>STRING=bundled                              \</span><br><span class="line">  -<span class="symbol">DWITH_UNIT_TESTS:</span>BOOL=OFF                             \</span><br><span class="line">  -<span class="symbol">DWITH_ZLIB:</span>STRING=bundled                             \</span><br><span class="line">  -<span class="symbol">DWITH_PARTITION_STORAGE_ENGINE:</span>BOOL=ON                \</span><br><span class="line">  -<span class="symbol">DWITH_INNOBASE_STORAGE_ENGINE:</span>BOOL=ON                 \</span><br><span class="line">  -<span class="symbol">DWITH_TOKUDB_STORAGE_ENGINE:</span>BOOL=ON                   \</span><br><span class="line">  -<span class="symbol">DWITH_ARCHIVE_STORAGE_ENGINE:</span>BOOL=ON                  \</span><br><span class="line">  -<span class="symbol">DWITH_BLACKHOLE_STORAGE_ENGINE:</span>BOOL=ON                \</span><br><span class="line">  -<span class="symbol">DWITH_PERFSCHEMA_STORAGE_ENGINE:</span>BOOL=ON               \</span><br><span class="line">  -DDEFAULT_CHARSET=utf8mb4                              \</span><br><span class="line">  -DDEFAULT_COLLATION=utf8mb4_general_ci                 \</span><br><span class="line">  -<span class="symbol">DENABLED_LOCAL_INFILE:</span>BOOL=ON                         \</span><br><span class="line">  -DWITH_EMBEDDED_SERVER=<span class="number">0</span>                               \</span><br><span class="line">  -<span class="symbol">DINSTALL_LAYOUT:</span>STRING=STANDALONE                     \</span><br><span class="line">  -<span class="symbol">DCOMMUNITY_BUILD:</span>BOOL=ON                              \</span><br><span class="line">  -DWITHOUT_EXAMPLE_STORAGE_ENGINE=<span class="number">1</span>                     \</span><br><span class="line">  -DWITHOUT_NDBCLUSTER_STORAGE_ENGINE=<span class="number">1</span>                  \</span><br><span class="line">  -DENABLED_PROFILING=<span class="number">1</span>                                  \</span><br><span class="line">  -DINNODB_PAGE_ATOMIC_REF_COUNT=<span class="number">1</span>                       \</span><br><span class="line">  -DWITH_INNODB_MEMCACHED=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">make -j <span class="string">`cat /proc/cpuinfo | grep processor| wc -l`</span></span><br><span class="line"></span><br><span class="line">%install    <span class="comment">#包含安装阶段执行的命令。命令将文件从 %&#123;_builddir&#125; 目录安装至 %&#123;buildroot&#125; 目录</span></span><br><span class="line">make DESTDIR=$RPM_BUILD_ROOT install</span><br><span class="line">cp <span class="string">%&#123;_sourcedir&#125;</span>/my.cnf $RPM_BUILD_ROOT<span class="string">%&#123;prefix&#125;</span>/   <span class="comment">#拷贝模板配置文件,下文会介绍配置文件</span></span><br><span class="line"></span><br><span class="line">%clean      <span class="comment">#清理安装目录的命令</span></span><br><span class="line">rm -rf $RPM_BUILD_ROOT</span><br><span class="line">rm -rf $RPM_BUILD_DIR/*</span><br><span class="line"></span><br><span class="line">%files      <span class="comment">#需要被打包/安装的文件列表</span></span><br><span class="line">%defattr(-, <span class="string">%&#123;MYSQL_USER&#125;</span>, <span class="string">%&#123;MYSQL_GROUP&#125;</span>)              <span class="comment">#设置默认文件权限格式%defattr(&lt;file permissions&gt;, &lt;user&gt;, &lt;group&gt;, &lt;directory permissions&gt;)，-使用默认的权限，文本文件是0644，可执行文件是0755</span></span><br><span class="line">%attr(<span class="number">755</span>, <span class="string">%&#123;MYSQL_USER&#125;</span>, <span class="string">%&#123;MYSQL_GROUP&#125;</span>) <span class="string">%&#123;prefix&#125;</span>/*   </span><br><span class="line"></span><br><span class="line">%pre        <span class="comment">#软件安装之前执行的脚本</span></span><br><span class="line"><span class="keyword">if</span> ! id <span class="string">%&#123;MYSQL_USER&#125;</span> &gt; <span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span>;<span class="keyword">then</span></span><br><span class="line">useradd -M -s /sbin/nologin <span class="string">%&#123;MYSQL_USER&#125;</span>               <span class="comment">#创建MySQL用户</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">%post       <span class="comment">#软件安装之后执行的脚本</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">%&#123;prefix&#125;</span>/support-files/mysql.server &gt; <span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> ]  &amp;&amp; [ ! -f <span class="string">%&#123;_initddir&#125;</span>/mysql &gt; <span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span> ];<span class="keyword">then</span></span><br><span class="line">cp <span class="string">%&#123;prefix&#125;</span>/support-files/mysql.server <span class="string">%&#123;_initddir&#125;</span>/mysqld <span class="comment">#拷贝启动脚本</span></span><br><span class="line">chmod +x <span class="string">%&#123;_initddir&#125;</span>/mysqld                                <span class="comment">#添加启动脚本执行权限</span></span><br><span class="line">chkconfig --level <span class="number">2345</span> <span class="string">%&#123;_initddir&#125;</span>/mysqld on               <span class="comment">#添加到系统启动服务中</span></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ ! -f <span class="string">%&#123;_sysconfdir&#125;</span>/my.cnf ];<span class="keyword">then</span></span><br><span class="line">cp <span class="string">%&#123;prefix&#125;</span>/my.cnf <span class="string">%&#123;_sysconfdir&#125;</span>/my.cnf                   <span class="comment">#拷贝配置文件</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">cp <span class="string">%&#123;prefix&#125;</span>/my.cnf <span class="string">%&#123;_sysconfdir&#125;</span>/my.cnf.rpmnew            <span class="comment">#如存在文件，则重命名</span></span><br><span class="line">fi</span><br><span class="line">mkdir -p /hwdata/data/percona                               <span class="comment">#创建数据目录</span></span><br><span class="line">chown -R <span class="symbol">mysql:</span>mysql /hwdata/data/percona                   <span class="comment">#授权数据目录</span></span><br><span class="line">rm -rf <span class="string">%&#123;prefix&#125;</span>/my.cnf                                     <span class="comment">#删除prefix目录的my.cnf</span></span><br><span class="line">rm -rf <span class="string">%&#123;prefix&#125;</span>/data                                       <span class="comment">#删除prefix目录的data目录</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/scripts/mysql_install_db --rpm --user=mysql --basedir=<span class="string">%&#123;prefix&#125;</span>   <span class="comment">#初始化安装 --datadir=/hwdata/data/percona</span></span><br><span class="line">/etc/init.d/mysqld start                                    <span class="comment">#开启MySQL服务</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysqladmin -uroot password <span class="string">'123456'</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysql -uroot -p123456 -e <span class="string">"grant all privileges on *.* to root@'127.0.0.1' identified by '123456' with grant option;"</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysql -uroot -p123456 -e <span class="string">"grant all privileges on *.* to root@'localhost' identified by '123456' with grant option;"</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysql -uroot -p123456 -e <span class="string">"delete from mysql.user where Password='';"</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysql -uroot -p123456 -e <span class="string">"delete from mysql.db where User='';"</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysql -uroot -p123456 -e <span class="string">"delete from mysql.proxies_priv where Host!='localhost';"</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysql -uroot -p123456 -e <span class="string">"drop database test;"</span></span><br><span class="line"><span class="string">%&#123;prefix&#125;</span>/bin/mysql -uroot -p123456 -e <span class="string">"reset master;"</span></span><br><span class="line"></span><br><span class="line">echo <span class="string">"PATH=/usr/local/percona/bin/:$PATH:$HOME/bin"</span> <span class="meta">&gt;&gt; </span>/etc/profile <span class="comment">#添加环境变量</span></span><br><span class="line">echo <span class="string">"export PATH"</span> <span class="meta">&gt;&gt; </span>/etc/profile  </span><br><span class="line">source /etc/profile     <span class="comment">#环境变量生效</span></span><br><span class="line"></span><br><span class="line">%preun      <span class="comment">#rpm卸载前执行的脚本，在升级的时候会执行</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">%&#123;_sysconfdir&#125;</span>/my.cnf ];<span class="keyword">then</span></span><br><span class="line">mv <span class="string">%&#123;_sysconfdir&#125;</span>/my.cnf <span class="string">%&#123;_sysconfdir&#125;</span>/my.cnf.rpmold</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">%&#123;_initddir&#125;</span>/mysql ];<span class="keyword">then</span></span><br><span class="line">mv <span class="string">%&#123;_initddir&#125;</span>/mysql <span class="string">%&#123;_initddir&#125;</span>/mysql.rpmold</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">%postun     <span class="comment">#rpm卸载后执行的脚本，在升级rpm包的时候不会执行</span></span><br><span class="line">rm -rf <span class="string">%&#123;prefix&#125;</span></span><br><span class="line">rm -rf /hwdata/data/percona </span><br><span class="line">userdel -r <span class="string">%&#123;MYSQL_USER&#125;</span> &gt;<span class="regexp">/dev/null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span></span><br><span class="line"></span><br><span class="line">%changelog  <span class="comment">#RPM 包变更日志</span></span><br></pre></td></tr></table></figure></p>
<h3 id="MySQL模板文件-my-cnf"><a href="#MySQL模板文件-my-cnf" class="headerlink" title="MySQL模板文件(my.cnf)"></a>MySQL模板文件(my.cnf)</h3><p>以下为my.cnf配置模板文件，不做过多解释，请参考：<a href="https://dev.mysql.com/doc/refman/5.6/en/option-files.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.6/en/option-files.html</a><br><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">-bash-4.1$ cat my.cnf </span><br><span class="line">[client]</span><br><span class="line">port = 3306</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">default-character-set = utf8</span><br><span class="line"></span><br><span class="line">[mysql]</span><br><span class="line"><span class="comment">#prompt="MySQL [\d]&gt; "</span></span><br><span class="line">prompt=<span class="string">"MySQL [\d] \R:\m:\\s &gt; "</span></span><br><span class="line">no-auto-rehash</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line"><span class="comment"># basic setting #</span></span><br><span class="line">port = 3306</span><br><span class="line">socket = /tmp/mysql.sock</span><br><span class="line">basedir = /usr/local/percona</span><br><span class="line">datadir = /hwdata/data/percona</span><br><span class="line">pid-file = /hwdata/data/percona/mysql.pid</span><br><span class="line">user = mysql</span><br><span class="line">bind-address = 0.0.0.0</span><br><span class="line">server-id = 1</span><br><span class="line">autocommit = 1</span><br><span class="line">auto_increment_increment = 1</span><br><span class="line">auto_increment_offset = 1</span><br><span class="line">event_scheduler = 1     <span class="comment">#slave need off</span></span><br><span class="line"><span class="comment">#read_only=ON           #slave need on</span></span><br><span class="line">skip-name-resolve</span><br><span class="line">skip-external-locking</span><br><span class="line">transaction_isolation = READ-COMMITTED</span><br><span class="line">init-connect = 'SET NAMES utf8'</span><br><span class="line">character-set-server = utf8</span><br><span class="line">query_cache_size = 0</span><br><span class="line">query_cache_type = 0</span><br><span class="line"></span><br><span class="line">max_connections = 2000</span><br><span class="line">max_connect_errors = 100000</span><br><span class="line">max_length_for_sort_data = 8192</span><br><span class="line">max_allowed_packet = 32M</span><br><span class="line">max_heap_table_size = 128M</span><br><span class="line">tmp_table_size = 128M</span><br><span class="line">open_files_limit = 65535</span><br><span class="line">table_open_cache = 1024</span><br><span class="line">table_definition_cache = 2048</span><br><span class="line">table_open_cache = 1024</span><br><span class="line"></span><br><span class="line">read_buffer_size = 4M</span><br><span class="line">read_rnd_buffer_size = 8M</span><br><span class="line">sort_buffer_size = 4M</span><br><span class="line">join_buffer_size = 16M</span><br><span class="line">key_buffer_size = 256M</span><br><span class="line"></span><br><span class="line">back_log = 300</span><br><span class="line">expire_logs_days = 7</span><br><span class="line">log_error = /hwdata/data/percona/mysql-error.log</span><br><span class="line">log_bin = mysql-bin</span><br><span class="line">log_warnings = 2</span><br><span class="line">log_queries_not_using_indexes = 1</span><br><span class="line">binlog_format = ROW</span><br><span class="line">slow_query_log = 1</span><br><span class="line">slow_query_log_file = /hwdata/data/percona/mysql-slow.log</span><br><span class="line">long_query_time = 1</span><br><span class="line">log_slow_rate_limit=100</span><br><span class="line">log_slow_rate_type=query</span><br><span class="line">log_slow_verbosity=full</span><br><span class="line">slow_query_log_always_write_time=1</span><br><span class="line">slow_query_log_use_global_control=all</span><br><span class="line">log_slow_admin_statements = 1</span><br><span class="line">log_slow_slave_statements = 1</span><br><span class="line">log_throttle_queries_not_using_indexes = 10</span><br><span class="line">min_examined_row_limit = 100</span><br><span class="line">binlog-rows-query-log-events = 1</span><br><span class="line">log-bin-trust-function-creators = 1</span><br><span class="line">binlog_cache_size = 1M</span><br><span class="line">userstat=1</span><br><span class="line">performance_schema = 0</span><br><span class="line"><span class="comment">#lower_case_table_names = 1</span></span><br><span class="line">default_storage_engine = InnoDB</span><br><span class="line">innodb_page_size = 16384</span><br><span class="line">innodb_data_file_path = ibdata1:1024M:autoextend</span><br><span class="line">innodb_file_per_table = 1</span><br><span class="line">innodb_open_files = 1024</span><br><span class="line">innodb_buffer_pool_size = 4096M</span><br><span class="line">innodb_buffer_pool_instances = 8</span><br><span class="line">innodb_buffer_pool_load_at_startup = 1</span><br><span class="line">innodb_buffer_pool_dump_at_shutdown = 1</span><br><span class="line">innodb_write_io_threads = 8</span><br><span class="line">innodb_read_io_threads = 8</span><br><span class="line">innodb_io_capacity = 4000</span><br><span class="line">innodb_io_capacity_max = 8000</span><br><span class="line">innodb_lru_scan_depth = 4000</span><br><span class="line">innodb_thread_concurrency = 0</span><br><span class="line">innodb_purge_threads = 1</span><br><span class="line">innodb_flush_log_at_trx_commit = 2</span><br><span class="line">innodb_flush_method=O_DIRECT</span><br><span class="line">innodb_file_format = Barracuda</span><br><span class="line">innodb_file_format_max = Barracuda</span><br><span class="line">innodb_undo_logs = 128</span><br><span class="line">innodb_undo_tablespaces = 3</span><br><span class="line">innodb_log_buffer_size = 16M</span><br><span class="line">innodb_log_file_size = 1536M</span><br><span class="line">innodb_log_files_in_group = 3</span><br><span class="line">innodb_max_dirty_pages_pct = 75</span><br><span class="line">innodb_lock_wait_timeout = 120</span><br><span class="line">innodb_large_prefix = 1</span><br><span class="line">innodb_print_all_deadlocks = 1</span><br><span class="line">innodb_autoinc_lock_mode = 2</span><br><span class="line">innodb_online_alter_log_max_size=1G</span><br><span class="line">innodb_sync_spin_loops = 100</span><br><span class="line">innodb_spin_wait_delay = 30</span><br><span class="line">metadata_locks_hash_instances = 8</span><br><span class="line"></span><br><span class="line">gtid_mode = on</span><br><span class="line">enforce_gtid_consistency = 1</span><br><span class="line">log_slave_updates</span><br><span class="line"></span><br><span class="line">slave_skip_errors = ddl_exist_errors</span><br><span class="line">slave-rows-search-algorithms = 'INDEX_SCAN,HASH_SCAN'</span><br><span class="line">slave_net_timeout = 60</span><br><span class="line">master_info_repository = TABLE</span><br><span class="line">relay_log_info_repository = TABLE</span><br><span class="line"></span><br><span class="line">thread_cache_size = 64</span><br><span class="line">thread_handling = pool-of-threads</span><br><span class="line">thread_pool_oversubscribe = 10</span><br><span class="line"></span><br><span class="line">bulk_insert_buffer_size = 8M</span><br><span class="line">myisam_sort_buffer_size = 64M</span><br><span class="line">myisam_max_sort_file_size = 10G</span><br><span class="line">myisam_repair_threads = 1</span><br><span class="line"></span><br><span class="line">interactive_timeout = 1800</span><br><span class="line">wait_timeout = 1800</span><br><span class="line">lock_wait_timeout = 1800</span><br><span class="line"></span><br><span class="line">[mysqldump]</span><br><span class="line">quick</span><br><span class="line">max_allowed_packet = 16M</span><br><span class="line"></span><br><span class="line">[myisamchk]</span><br><span class="line">key_buffer_size = 256M</span><br><span class="line">sort_buffer_size = 8M</span><br><span class="line">read_buffer = 4M</span><br><span class="line">write_buffer = 4M</span><br><span class="line">-bash-4.1$</span><br></pre></td></tr></table></figure></p>
<h3 id="上传源码文件及模板文件"><a href="#上传源码文件及模板文件" class="headerlink" title="上传源码文件及模板文件"></a>上传源码文件及模板文件</h3><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">bash-<span class="number">4.1</span>$ ls -l rpmbuild/SOURCES/</span></span><br><span class="line"><span class="ruby">总用量 <span class="number">54808</span></span></span><br><span class="line"><span class="ruby">-rw-r--r-- <span class="number">1</span> jiessie jiessie     <span class="number">3629</span> <span class="number">7</span>月  <span class="number">14</span> <span class="number">10</span><span class="symbol">:</span><span class="number">22</span> my.cnf</span></span><br><span class="line"><span class="ruby">-rw-r--r-- <span class="number">1</span> jiessie jiessie <span class="number">56116691</span> <span class="number">7</span>月  <span class="number">14</span> <span class="number">10</span><span class="symbol">:</span><span class="number">22</span> percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.tar.gz</span></span><br><span class="line"><span class="ruby">-bash-<span class="number">4.1</span>$</span></span><br></pre></td></tr></table></figure>
<h3 id="执行编译过程"><a href="#执行编译过程" class="headerlink" title="执行编译过程"></a>执行编译过程</h3><p>rpmbuild -bb percona.5.6.36.spec<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line">-bash<span class="number">-4.1</span>$ pwd</span><br><span class="line"><span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>SPECS</span><br><span class="line">-bash<span class="number">-4.1</span>$ rpmbuild -bb percona<span class="number">.5</span><span class="number">.6</span><span class="number">.36</span>.spec </span><br><span class="line">Executing(%prep): <span class="regexp">/bin/</span>sh -e <span class="regexp">/var/</span>tmp/rpm-tmp.YmJTDn</span><br><span class="line">+ umask <span class="number">022</span></span><br><span class="line">+ cd <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILD</span><br><span class="line">+ LANG=C</span><br><span class="line">+ export LANG</span><br><span class="line">+ unset DISPLAY</span><br><span class="line">+ cd <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILD</span><br><span class="line">+ rm -rf percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span></span><br><span class="line">+ <span class="regexp">/usr/</span>bin<span class="regexp">/gzip -dc /</span>home<span class="regexp">/jiessie/</span>rpmbuild<span class="regexp">/SOURCES/</span>percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.tar.gz</span><br><span class="line">+ <span class="regexp">/bin/</span>tar -xf -</span><br><span class="line">+ STATUS=<span class="number">0</span></span><br><span class="line">+ <span class="string">'['</span> <span class="number">0</span> -ne <span class="number">0</span> <span class="string">']'</span></span><br><span class="line">+ cd percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span></span><br><span class="line">+ <span class="regexp">/bin/</span>chmod -Rf a+rX,u+w,g-w,o-w .</span><br><span class="line">+ exit <span class="number">0</span></span><br><span class="line">Executing(%build): <span class="regexp">/bin/</span>sh -e <span class="regexp">/var/</span>tmp/rpm-tmp.vvnRcl</span><br><span class="line">+ umask <span class="number">022</span></span><br><span class="line">+ cd <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILD</span><br><span class="line">+ cd percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span></span><br><span class="line">+ LANG=C</span><br><span class="line">+ export LANG</span><br><span class="line">+ unset DISPLAY</span><br><span class="line">+ CFLAGS=<span class="string">'-O3 -g -static-libgcc -fno-omit-frame-pointer -fno-strict-aliasing'</span></span><br><span class="line">+ CXX=g++</span><br><span class="line">+ CXXFLAGS=<span class="string">'-O3 -g -fno-rtti -static-libgcc -fno-omit-frame-pointer -fno-strict-aliasing'</span></span><br><span class="line">+ export CFLAGS CXX CXXFLAGS</span><br><span class="line">+ cmake . -<span class="string">DSYSCONFDIR:</span>PATH=<span class="regexp">/usr/</span>local<span class="regexp">/percona -DCMAKE_INSTALL_PREFIX:PATH=/</span>usr<span class="regexp">/local/</span>percona -<span class="string">DCMAKE_BUILD_TYPE:</span>STRING=Release -<span class="string">DENABLE_PROFILING:</span>BOOL=ON -<span class="string">DWITH_DEBUG:</span>BOOL=OFF -<span class="string">DWITH_VALGRIND:</span>BOOL=OFF -<span class="string">DENABLE_DEBUG_SYNC:</span>BOOL=OFF -<span class="string">DWITH_EXTRA_CHARSETS:</span>STRING=all -<span class="string">DWITH_SSL:</span>STRING=bundled -<span class="string">DWITH_UNIT_TESTS:</span>BOOL=OFF -<span class="string">DWITH_ZLIB:</span>STRING=bundled -<span class="string">DWITH_PARTITION_STORAGE_ENGINE:</span>BOOL=ON -<span class="string">DWITH_INNOBASE_STORAGE_ENGINE:</span>BOOL=ON -<span class="string">DWITH_TOKUDB_STORAGE_ENGINE:</span>BOOL=ON -<span class="string">DWITH_ARCHIVE_STORAGE_ENGINE:</span>BOOL=ON -<span class="string">DWITH_BLACKHOLE_STORAGE_ENGINE:</span>BOOL=ON -<span class="string">DWITH_PERFSCHEMA_STORAGE_ENGINE:</span>BOOL=ON -DDEFAULT_CHARSET=utf8mb4 -DDEFAULT_COLLATION=utf8mb4_general_ci -<span class="string">DENABLED_LOCAL_INFILE:</span>BOOL=ON -DWITH_EMBEDDED_SERVER=<span class="number">0</span> -<span class="string">DINSTALL_LAYOUT:</span>STRING=STANDALONE -<span class="string">DCOMMUNITY_BUILD:</span>BOOL=ON -DWITHOUT_EXAMPLE_STORAGE_ENGINE=<span class="number">1</span> -DWITHOUT_NDBCLUSTER_STORAGE_ENGINE=<span class="number">1</span> -DENABLED_PROFILING=<span class="number">1</span> -DINNODB_PAGE_ATOMIC_REF_COUNT=<span class="number">1</span> -DWITH_INNODB_MEMCACHED=<span class="number">1</span></span><br><span class="line">-- Running cmake version <span class="number">2.8</span><span class="number">.12</span><span class="number">.2</span></span><br><span class="line">-- Found <span class="string">Git:</span> <span class="regexp">/usr/</span>bin/git (found version <span class="string">"1.7.1"</span>) </span><br><span class="line">-- The C compiler identification is GNU <span class="number">4.4</span><span class="number">.7</span></span><br><span class="line">-- The CXX compiler identification is GNU <span class="number">4.4</span><span class="number">.7</span></span><br><span class="line">-- Check <span class="keyword">for</span> working C <span class="string">compiler:</span> <span class="regexp">/usr/</span>bin/cc</span><br><span class="line">-- Check <span class="keyword">for</span> working C <span class="string">compiler:</span> <span class="regexp">/usr/</span>bin/cc -- works</span><br><span class="line">-- Detecting C compiler ABI info</span><br><span class="line">-- Detecting C compiler ABI info - done</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX <span class="string">compiler:</span> <span class="regexp">/usr/</span>bin/g++</span><br><span class="line">-- Check <span class="keyword">for</span> working CXX <span class="string">compiler:</span> <span class="regexp">/usr/</span>bin/g++ -- works</span><br><span class="line">-- Detecting CXX compiler ABI info</span><br><span class="line">-- Detecting CXX compiler ABI info - done</span><br><span class="line">-- ...省略部分...</span><br><span class="line">-- Not building tokudb-backup-plugin</span><br><span class="line">-- Library perconaserverclient depends on OSLIBS -lpthread;m;rt;dl</span><br><span class="line">-- Skipping deb packaging on unsupported platform Final.</span><br><span class="line">-- <span class="string">CMAKE_BUILD_TYPE:</span> Release</span><br><span class="line">-- <span class="string">COMPILE_DEFINITIONS:</span> HAVE_CONFIG_H</span><br><span class="line">-- <span class="string">CMAKE_C_FLAGS:</span> -O3 -g -<span class="keyword">static</span>-libgcc -fno-omit-frame-pointer -fno-strict-aliasing  -Wall -Wextra -Wformat-security -Wvla -Wwrite-strings -Wdeclaration-after-statement</span><br><span class="line">-- <span class="string">CMAKE_CXX_FLAGS:</span> -O3 -g -fno-rtti -<span class="keyword">static</span>-libgcc -fno-omit-frame-pointer -fno-strict-aliasing  -Wall -Wextra -Wformat-security -Wvla -Woverloaded-virtual -Wno-unused-parameter</span><br><span class="line">-- <span class="string">CMAKE_C_FLAGS_RELEASE:</span> -O3 -DNDEBUG -DDBUG_OFF</span><br><span class="line">-- <span class="string">CMAKE_CXX_FLAGS_RELEASE:</span> -O3 -DNDEBUG -DDBUG_OFF</span><br><span class="line">-- Configuring done</span><br><span class="line">-- Generating done</span><br><span class="line">CMake <span class="string">Warning:</span></span><br><span class="line">  Manually-specified variables were not used by the <span class="string">project:</span></span><br><span class="line"></span><br><span class="line">    COMMUNITY_BUILD</span><br><span class="line">    ENABLE_DEBUG_SYNC</span><br><span class="line">    ENABLE_PROFILING</span><br><span class="line">    WITH_TOKUDB_STORAGE_ENGINE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">-- Build files have been written <span class="string">to:</span> <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILD/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span></span><br><span class="line">++ cat <span class="regexp">/proc/</span>cpuinfo</span><br><span class="line">++ grep processor</span><br><span class="line">++ wc -l</span><br><span class="line">+ make -j <span class="number">4</span></span><br><span class="line">Scanning dependencies of target abi_check</span><br><span class="line">Scanning dependencies of target INFO_BIN</span><br><span class="line">Scanning dependencies of target INFO_SRC</span><br><span class="line">Scanning dependencies of target zlib</span><br><span class="line">[  <span class="number">0</span>%] [  <span class="number">0</span>%] Building C object zlib<span class="regexp">/CMakeFiles/</span>zlib.dir/adler32.c.o</span><br><span class="line">[<span class="number">100</span>%] ...省略部分...</span><br><span class="line">[<span class="number">100</span>%] Built target udf_example</span><br><span class="line">+ exit <span class="number">0</span></span><br><span class="line">Executing(%install): <span class="regexp">/bin/</span>sh -e <span class="regexp">/var/</span>tmp/rpm-tmp.MNmU8M</span><br><span class="line">+ umask <span class="number">022</span></span><br><span class="line">+ cd <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILD</span><br><span class="line">+ <span class="string">'['</span> <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT<span class="regexp">/percona-server-5.6.36-82.0.x86_64 '!=' /</span> <span class="string">']'</span></span><br><span class="line">+ rm -rf <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64</span><br><span class="line">++ dirname <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64</span><br><span class="line">+ mkdir -p <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT</span><br><span class="line">+ mkdir <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64</span><br><span class="line">+ cd percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span></span><br><span class="line">+ LANG=C</span><br><span class="line">+ export LANG</span><br><span class="line">+ unset DISPLAY</span><br><span class="line">+ make DESTDIR=<span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64 install</span><br><span class="line">[  <span class="number">0</span>%] Built target INFO_BIN</span><br><span class="line">[<span class="number">100</span>%] ...省略部分...</span><br><span class="line">[<span class="number">100</span>%] Built target my_safe_process</span><br><span class="line">Install the project...</span><br><span class="line">-- Install <span class="string">configuration:</span> <span class="string">"Release"</span></span><br><span class="line">-- <span class="string">Installing:</span> <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT<span class="regexp">/percona-server-5.6.36-82.0.x86_64/</span>usr<span class="regexp">/local/</span>percona<span class="regexp">/docs/</span>mysql.info</span><br><span class="line">-- ...省略部分...</span><br><span class="line"><span class="string">cpio:</span> percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span><span class="regexp">/storage/</span>innobase/pars0lex.<span class="string">l:</span> Cannot <span class="string">stat:</span> No such file or directory</span><br><span class="line"><span class="number">97189</span> blocks</span><br><span class="line">+ <span class="regexp">/usr/</span>lib<span class="regexp">/rpm/</span>check-buildroot</span><br><span class="line">Processing <span class="string">files:</span> percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64</span><br><span class="line"><span class="string">Provides:</span> adt_null.so()(<span class="number">64</span>bit) audit_log.so()(<span class="number">64</span>bit) auth.so()(<span class="number">64</span>bit) auth_socket.so()(<span class="number">64</span>bit) auth_test_plugin.so()(<span class="number">64</span>bit) connection_control.so()(<span class="number">64</span>bit) handlersocket.so()(<span class="number">64</span>bit) innodb_engine.so()(<span class="number">64</span>bit) libdaemon_example.so()(<span class="number">64</span>bit) libfnv1a_udf.so()(<span class="number">64</span>bit) libfnv_udf.so()(<span class="number">64</span>bit) libmemcached.so()(<span class="number">64</span>bit) libmurmur_udf.so()(<span class="number">64</span>bit) libperconaserverclient.so<span class="number">.18</span>()(<span class="number">64</span>bit) libperconaserverclient.so<span class="number">.18</span>(libperconaserverclient_18)(<span class="number">64</span>bit) mypluglib.so()(<span class="number">64</span>bit) mysql_no_login.so()(<span class="number">64</span>bit) perl(<span class="string">My:</span>:Config) perl(<span class="string">My:</span>:<span class="string">Config:</span>:Group) perl(<span class="string">My:</span>:<span class="string">Config:</span>:Option) perl(<span class="string">My:</span>:ConfigFactory) perl(<span class="string">My:</span>:CoreDump) perl(<span class="string">My:</span>:Exec) perl(<span class="string">My:</span>:<span class="string">File:</span>:Path) perl(<span class="string">My:</span>:Find) perl(<span class="string">My:</span>:Handles) perl(<span class="string">My:</span>:Memcache) perl(<span class="string">My:</span>:<span class="string">Memcache:</span>:Binary) perl(<span class="string">My:</span>:Options) perl(<span class="string">My:</span>:Platform) perl(<span class="string">My:</span>:SafeProcess) perl(<span class="string">My:</span>:<span class="string">SafeProcess:</span>:Base) perl(<span class="string">My:</span>:<span class="string">Suite:</span>:Query_response_time) perl(<span class="string">My:</span>:SysInfo) perl(<span class="string">My:</span>:Test) perl(Subunit) = <span class="number">0.0</span><span class="number">.2</span> perl(mtr_cases) perl(mtr_match) perl(mtr_report) perl(mtr_results) perl(mtr_unique) qa_auth_client.so()(<span class="number">64</span>bit) qa_auth_interface.so()(<span class="number">64</span>bit) qa_auth_server.so()(<span class="number">64</span>bit) query_response_time.so()(<span class="number">64</span>bit) semisync_master.so()(<span class="number">64</span>bit) semisync_slave.so()(<span class="number">64</span>bit) test_udf_services.so()(<span class="number">64</span>bit) validate_password.so()(<span class="number">64</span>bit)</span><br><span class="line">Requires(interp): <span class="regexp">/bin/</span>sh <span class="regexp">/bin/</span>sh <span class="regexp">/bin/</span>sh <span class="regexp">/bin/</span>sh</span><br><span class="line">Requires(rpmlib): rpmlib(FileDigests) &lt;= <span class="number">4.6</span><span class="number">.0</span><span class="number">-1</span> rpmlib(PayloadFilesHavePrefix) &lt;= <span class="number">4.0</span><span class="number">-1</span> rpmlib(CompressedFileNames) &lt;= <span class="number">3.0</span><span class="number">.4</span><span class="number">-1</span></span><br><span class="line">Requires(pre): <span class="regexp">/bin/</span>sh</span><br><span class="line">Requires(post): <span class="regexp">/bin/</span>sh</span><br><span class="line">Requires(preun): <span class="regexp">/bin/</span>sh</span><br><span class="line">Requires(postun): <span class="regexp">/bin/</span>sh</span><br><span class="line">Processing <span class="string">files:</span> percona-server-debuginfo<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64</span><br><span class="line">Checking <span class="keyword">for</span> unpackaged file(s): <span class="regexp">/usr/</span>lib<span class="regexp">/rpm/</span>check-files <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64</span><br><span class="line"><span class="string">Wrote:</span> <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>RPMS<span class="regexp">/x86_64/</span>percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64.rpm</span><br><span class="line"><span class="string">Wrote:</span> <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>RPMS<span class="regexp">/x86_64/</span>percona-server-debuginfo<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64.rpm</span><br><span class="line">Executing(%clean): <span class="regexp">/bin/</span>sh -e <span class="regexp">/var/</span>tmp/rpm-tmp.FOVDND</span><br><span class="line">+ umask <span class="number">022</span></span><br><span class="line">+ cd <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILD</span><br><span class="line">+ cd percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span></span><br><span class="line">+ rm -rf <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILDROOT/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span>.x86_64</span><br><span class="line">+ rm -rf <span class="regexp">/home/</span>jiessie<span class="regexp">/rpmbuild/</span>BUILD/percona-server<span class="number">-5.6</span><span class="number">.36</span><span class="number">-82.0</span></span><br><span class="line">+ exit <span class="number">0</span></span><br><span class="line">-bash<span class="number">-4.1</span>$</span><br></pre></td></tr></table></figure></p>
<h3 id="查看生成的RPM文件"><a href="#查看生成的RPM文件" class="headerlink" title="查看生成的RPM文件"></a>查看生成的RPM文件</h3><figure class="highlight haml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-<span class="ruby">bash-<span class="number">4.1</span>$ ls -l rpmbuild/RPMS/x86_64/</span></span><br><span class="line"><span class="ruby">总用量 <span class="number">99528</span></span></span><br><span class="line"><span class="ruby">-rw-rw-r-- <span class="number">1</span> jiessie jiessie <span class="number">53752860</span> <span class="number">7</span>月  <span class="number">14</span> <span class="number">10</span><span class="symbol">:</span><span class="number">34</span> percona-server-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.x86_64.rpm</span></span><br><span class="line"><span class="ruby">-rw-rw-r-- <span class="number">1</span> jiessie jiessie <span class="number">48158544</span> <span class="number">7</span>月  <span class="number">14</span> <span class="number">10</span><span class="symbol">:</span><span class="number">35</span> percona-server-debuginfo-<span class="number">5.6</span>.<span class="number">36</span>-<span class="number">82.0</span>.x86_64.rpm</span></span><br><span class="line"><span class="ruby">-bash-<span class="number">4.1</span>$</span></span><br></pre></td></tr></table></figure>
<p>percona-server-5.6.36-82.0.x86_64.rpm 此文件即是编译后生成的RPM安装文件</p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>随着云计算时代的到来，docker被越来越多的应用的实际生产中，但对于公司规模较小，自动化平台还不够完善的企业，自制RPM包安装MySQL也是一种不错的选择。</p>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/hexo-next-在github上搭建个人博客.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/hexo-next-在github上搭建个人博客.html" itemprop="url">hexo next 在github上搭建个人博客</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2013-07-12T15:56:07+08:00">
                2013-07-12
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工具/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>目前网上的很多平台都提供了博客功能，如csdn，51cto，cnblog，iteye等等，只要你想写博客，这些平台都可以选择。只需注册个帐号，就可以写博客，实现比较简单，但是局限性也很大，风格千篇一律，没有个性化，扩展也稍麻烦。并且，广告很多，这点很受不了。在此选择了hexo+next+github建立个人的博客平台。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>github：<a href="https://github.com/dwj999" target="_blank" rel="noopener">https://github.com/dwj999</a><br>发布平台：centos6.5 x86_64<br>发布工具：git<br>编写平台：windows7 x86_64<br>编写工具：有道云笔记<br>框架：hexo<br>主题：next </p>
<h2 id="安装Node-js"><a href="#安装Node-js" class="headerlink" title="安装Node.js"></a>安装Node.js</h2><p>操作系统为centos6.5，首先删除旧版本<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y <span class="builtin-name">remove</span> nodejs</span><br></pre></td></tr></table></figure></p>
<p>node使用最新版本，下载源码包<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://nodejs.org/dist/v8.<span class="number">1.4</span>/<span class="keyword">node</span><span class="title">-v8</span>.<span class="number">1.4</span>-linux-x64.tar.xz  </span><br><span class="line">tar -xvJf <span class="keyword">node</span><span class="title">-v8</span>.<span class="number">1.4</span>-linux-x64.tar.xz  </span><br><span class="line">mv <span class="keyword">node</span><span class="title">-v8</span>.<span class="number">1.4</span>-linux-x64 /usr/local/<span class="keyword">node</span><span class="title"></span></span><br></pre></td></tr></table></figure></p>
<p>配置系统环境变量<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vim /etc<span class="built_in">/profile </span> </span><br><span class="line">在底部添加 PATH 变量  </span><br><span class="line"><span class="builtin-name">export</span> <span class="attribute">PATH</span>=<span class="variable">$PATH</span>:/usr/local/node/bin  </span><br><span class="line">最后保存并使其生效即可  </span><br><span class="line">source /etc<span class="built_in">/profile </span> </span><br><span class="line">查看版本：node -v</span><br></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/public/resource/07bf646071b1146a82f5002fd9e53bcd/xmlnote/B1ED873C2C8143B2877B0AB88A07BC62/30674" alt="image">  </p>
<h2 id="安装Git-已安装可跳过"><a href="#安装Git-已安装可跳过" class="headerlink" title="安装Git(已安装可跳过)"></a>安装Git(已安装可跳过)</h2><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum <span class="keyword">install</span> git-core</span><br></pre></td></tr></table></figure>
<h2 id="安装Hexo"><a href="#安装Hexo" class="headerlink" title="安装Hexo"></a>安装Hexo</h2><p>这里以我的github为例，地址为：<a href="https://github.com/dwj999" target="_blank" rel="noopener">https://github.com/dwj999</a><br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">创建目录  </span><br><span class="line">mkdir /hwdata/dwj999  </span><br><span class="line">切换目录  </span><br><span class="line">cd /hwdata/dwj999  </span><br><span class="line">安装 Hexo  </span><br><span class="line">npm<span class="built_in"> config </span><span class="builtin-name">set</span><span class="built_in"> user </span>0  </span><br><span class="line">npm<span class="built_in"> config </span><span class="builtin-name">set</span> unsafe-perm <span class="literal">true</span>  </span><br><span class="line">npm install -g hexo-cli  </span><br><span class="line">初始化 Hexo(如果报Error: ENOENT: <span class="literal">no</span> such file <span class="keyword">or</span> directory, uv_cwd,可能是删除的旧版本nodejs导致,重启服务器再试) </span><br><span class="line">hexo init  </span><br><span class="line">生成静态网页</span><br><span class="line">hexo generate</span><br></pre></td></tr></table></figure></p>
<h2 id="安装插件"><a href="#安装插件" class="headerlink" title="安装插件"></a>安装插件</h2><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">npm <span class="keyword">install</span> hexo-generator-<span class="keyword">index</span> <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-generator-<span class="keyword">archive</span> <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-generator-<span class="keyword">category</span> <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-generator-tag <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-<span class="keyword">server</span> <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-deployer-git <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-deployer-heroku <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-deployer-rsync <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-deployer-openshift <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-renderer-marked <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-renderer-stylus <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-generator-feed <span class="comment">--save  </span></span><br><span class="line">npm <span class="keyword">install</span> hexo-generator-sitemap <span class="comment">--save</span></span><br></pre></td></tr></table></figure>
<p>目录结构<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">|-- _config.yml  </span></span><br><span class="line"><span class="string">|-- db.json  </span></span><br><span class="line"><span class="string">|-- node_modules  </span></span><br><span class="line"><span class="string">|-- package.json  </span></span><br><span class="line"><span class="string">|-- package-lock.json  </span></span><br><span class="line"><span class="string">|-- public  </span></span><br><span class="line"><span class="string">|-- scaffolds  </span></span><br><span class="line"><span class="string">|-- source  </span></span><br><span class="line">    <span class="string">|-- _posts  </span></span><br><span class="line"><span class="string">|-- themes</span></span><br></pre></td></tr></table></figure></p>
<p>目录结构说明<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">_config.yml <span class="meta">#全局配置文件，网站的很多信息都在这里配置，诸如网站名称，副标题，描述，作者，语言，主题，部署等等参数。请参考：https:<span class="comment">//hexo.io/zh-cn/docs/configuration.html</span></span></span><br><span class="line">db.json <span class="meta">#缓存文件</span></span><br><span class="line">node_modules <span class="meta">#hexo插件</span></span><br><span class="line">package.json <span class="meta">#hexo框架的参数</span></span><br><span class="line">package-lock.json <span class="meta">#根据package.json自动创建锁定依赖版本，删掉会重新创建</span></span><br><span class="line">public  <span class="meta">#生成的静态网页文件</span></span><br><span class="line">scaffolds   <span class="meta">#模板文件夹，请参考：https:<span class="comment">//hexo.io/zh-cn/docs/writing.html</span></span></span><br><span class="line">source  <span class="meta">#资源文件夹，用于存放用户资源。旧版本有两个文件夹，_drafts和_posts。新版本只有_posts，用于存放博客的正文。</span></span><br><span class="line">themes  <span class="meta">#网站主题目录，请参考：https:<span class="comment">//hexo.io/zh-cn/docs/themes.html</span></span></span><br><span class="line">详情请参考：请参考：https:<span class="comment">//hexo.io/zh-cn/docs/setup.html</span></span><br></pre></td></tr></table></figure></p>
<h2 id="部署到GitHub"><a href="#部署到GitHub" class="headerlink" title="部署到GitHub"></a>部署到GitHub</h2><h3 id="站点配置"><a href="#站点配置" class="headerlink" title="站点配置"></a>站点配置</h3><p>修改Hexo站点配置文件/hwdata/dwj999/_config.yml,以下为例<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Site  </span></span><br><span class="line"><span class="attr">title:</span> <span class="string">Jiessie's'</span> <span class="string">Blog</span> <span class="comment">#标题  </span></span><br><span class="line"><span class="attr">subtitle:</span> <span class="string">没伞的孩子必须努力奔跑</span>  <span class="comment">#副标题</span></span><br><span class="line"><span class="attr">description:</span> <span class="string">最怕一生碌碌无为,还说平凡难能可贵！</span>  </span><br><span class="line"><span class="attr">author:</span> <span class="string">Jiessie</span>  </span><br><span class="line"><span class="attr">language:</span> <span class="string">zh-Hans</span>  </span><br><span class="line"></span><br><span class="line"><span class="attr">url:</span> <span class="attr">http://dwj999.github.io</span>  </span><br><span class="line"></span><br><span class="line"><span class="attr">deploy:</span>  </span><br><span class="line"><span class="attr">  type:</span> <span class="string">git</span>  </span><br><span class="line"><span class="attr">  repo:</span> <span class="string">git@github.com:dwj999/dwj999.github.io.git</span>  </span><br><span class="line"><span class="attr">  branch:</span> <span class="string">master</span>  </span><br><span class="line"><span class="attr">  message:</span> <span class="string">'站点更新:<span class="template-variable">&#123;&#123;now("YYYY-MM-DD HH/mm/ss")&#125;&#125;</span>'</span></span><br></pre></td></tr></table></figure></p>
<h3 id="github创建项目"><a href="#github创建项目" class="headerlink" title="github创建项目"></a>github创建项目</h3><p>仓库的名字必须和你的帐号对应，比如我的github地址：<a href="https://github.com/dwj999" target="_blank" rel="noopener">https://github.com/dwj999</a> 新建仓库名为dwj999.github.io,因我的项目已创建，此为演示，故有提醒，可忽略<br><img src="http://note.youdao.com/yws/public/resource/07bf646071b1146a82f5002fd9e53bcd/xmlnote/4D97A1CDD66544C88937FF1635C584CB/30910" alt="image"></p>
<h3 id="git配置"><a href="#git配置" class="headerlink" title="git配置"></a>git配置</h3><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git<span class="built_in"> config </span>--global user.email <span class="string">"dwj999@163.com"</span> </span><br><span class="line">git<span class="built_in"> config </span>--global user.name <span class="string">"dwj999"</span></span><br><span class="line">ssh-keygen -t rsa -C <span class="string">"dwj999@163.com"</span>   #一路回车，如已生成过，可覆盖成功后会~/.ssh目录生成key，复制id_rsa.pub内容</span><br></pre></td></tr></table></figure>
<h3 id="添加key"><a href="#添加key" class="headerlink" title="添加key"></a>添加key</h3><p><img src="http://note.youdao.com/yws/public/resource/07bf646071b1146a82f5002fd9e53bcd/xmlnote/A9D5315CE0594ADE8E715BC14F63E122/30886" alt="image"></p>
<p>打开github地址：<a href="https://github.com/settings/ssh，打开ssh" target="_blank" rel="noopener">https://github.com/settings/ssh，打开ssh</a> keys，添加key<br><img src="http://note.youdao.com/yws/public/resource/07bf646071b1146a82f5002fd9e53bcd/xmlnote/1B4451F32C0642FEBD6868200D58DD70/30896" alt="image"></p>
<h3 id="代码上传"><a href="#代码上传" class="headerlink" title="代码上传"></a>代码上传</h3><figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># linux编译</span><br><span class="line">hexo <span class="keyword">generate</span></span><br><span class="line"># 在主机的hexo目录下 执行以下命令将自动更新到Github</span><br><span class="line">hexo d</span><br></pre></td></tr></table></figure>
<h3 id="站点访问，左面菜单和主题已经配置过"><a href="#站点访问，左面菜单和主题已经配置过" class="headerlink" title="站点访问，左面菜单和主题已经配置过"></a>站点访问，左面菜单和主题已经配置过</h3><p><img src="http://note.youdao.com/yws/public/resource/07bf646071b1146a82f5002fd9e53bcd/xmlnote/82160EF561E54B88B6428812E6822255/30925" alt="image"></p>
<h2 id="主题和配置文件"><a href="#主题和配置文件" class="headerlink" title="主题和配置文件"></a>主题和配置文件</h2><p>切换到站点目录，下载主题代码<br><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd <span class="regexp">/hwdata/</span>dwj999</span><br><span class="line">git clone https:<span class="regexp">//gi</span>thub.com<span class="regexp">/iissnan/</span>hexo-theme-<span class="keyword">next</span> themes<span class="regexp">/next    #主题的配置文件，位于 hexo/</span>theme<span class="regexp">/next/</span>_config.yml</span><br></pre></td></tr></table></figure></p>
<p>配置主题<br><figure class="highlight autoit"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim _config.yml</span><br><span class="line"><span class="meta"># 找到theme:修改后面的参数，默认是landscape</span></span><br><span class="line">theme: <span class="keyword">next</span></span><br><span class="line">hexo d -g <span class="meta">#重新编译，上传</span></span><br></pre></td></tr></table></figure></p>
<p>主题和第三方服务说明<br>官方文档很详情<br>请参考：<br><a href="http://theme-next.iissnan.com/getting-started.html" target="_blank" rel="noopener">http://theme-next.iissnan.com/getting-started.html</a><br><a href="http://theme-next.iissnan.com/theme-settings.html" target="_blank" rel="noopener">http://theme-next.iissnan.com/theme-settings.html</a><br><a href="http://theme-next.iissnan.com/third-party-services.html" target="_blank" rel="noopener">http://theme-next.iissnan.com/third-party-services.html</a>   </p>
<h2 id="发布文章"><a href="#发布文章" class="headerlink" title="发布文章"></a>发布文章</h2><p>由于hexo支持markdown写文章，并且我使用的是windows机器，代码发布在linux机器上，所以选择了有道云笔记的markdown笔记来写文章，虽然语法支持有缺陷，但是以前习惯了使用有道云，没有使用其他工具，像Cmd Markdown的在线编辑器也不错。<br><figure class="highlight axapta"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo <span class="keyword">new</span> <span class="string">"hexo next 在github上搭建个人博客"</span> <span class="meta">#创建了一个博客文章</span></span><br></pre></td></tr></table></figure></p>
<p><img src="http://note.youdao.com/yws/public/resource/07bf646071b1146a82f5002fd9e53bcd/xmlnote/86071474F1B14AAFAC852DF6D36FC8FB/30979" alt="image"><br>再使用有道云的markdown进行写文章，写好后，导出，上传到github。</p>

          
        
      
    </div>
    
    
    

    

    

    
<div>
  
</div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/jiessie.png"
                alt="Jiessie" />
            
              <p class="site-author-name" itemprop="name">Jiessie</p>
              <p class="site-description motion-element" itemprop="description">最怕一生碌碌无为,还说平凡难能可贵！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">15</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">25</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.percona.com/" target="_blank" title="Percona">
                      
                        <i class="fa fa-fw fa-globe"></i>Percona</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://mariadb.com/kb/zh-cn/mariadb/" target="_blank" title="MariaDB">
                      
                        <i class="fa fa-fw fa-globe"></i>MariaDB</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysqlserverteam.com/" target="_blank" title="serverteam">
                      
                        <i class="fa fa-fw fa-globe"></i>serverteam</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysqlhighavailability.com/" target="_blank" title="highavailability">
                      
                        <i class="fa fa-fw fa-globe"></i>highavailability</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysql.taobao.org/monthly/" target="_blank" title="淘宝月报">
                      
                        <i class="fa fa-fw fa-globe"></i>淘宝月报</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://dimitrik.free.fr/blog/" target="_blank" title="dimitrik">
                      
                        <i class="fa fa-fw fa-globe"></i>dimitrik</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiessie</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

</body>
</html>
