<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">



  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="percona," />




  


  <link rel="alternate" href="/atom.xml" title="Jiessie's' Blog" type="application/atom+xml" />






<meta name="description" content="介绍MySQL生产更改表结构的方式有很多，MySQL官方的Online DDL，github开源的gh-ost，此文仅介绍percona的工具包其中的pt-online-schema-change 原理general_log在mysql实例中开启general_log参数，观察pt-online-schema-change的执行过程。 执行pt-online-schema-change的语句如下：">
<meta name="keywords" content="percona">
<meta property="og:type" content="article">
<meta property="og:title" content="pt-online-schema-change 使用教程">
<meta property="og:url" content="https://dwj999.github.io/pt-online-schema-change-使用教程.html">
<meta property="og:site_name" content="Jiessie&#39;s&#39; Blog">
<meta property="og:description" content="介绍MySQL生产更改表结构的方式有很多，MySQL官方的Online DDL，github开源的gh-ost，此文仅介绍percona的工具包其中的pt-online-schema-change 原理general_log在mysql实例中开启general_log参数，观察pt-online-schema-change的执行过程。 执行pt-online-schema-change的语句如下：">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-05-28T02:11:48.762Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="pt-online-schema-change 使用教程">
<meta name="twitter:description" content="介绍MySQL生产更改表结构的方式有很多，MySQL官方的Online DDL，github开源的gh-ost，此文仅介绍percona的工具包其中的pt-online-schema-change 原理general_log在mysql实例中开启general_log参数，观察pt-online-schema-change的执行过程。 执行pt-online-schema-change的语句如下：">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dwj999.github.io/pt-online-schema-change-使用教程.html"/>





<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

  <title>pt-online-schema-change 使用教程 | Jiessie's' Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"><a href="https://github.com/dwj999" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#fff; color:#151513; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style></div>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jiessie's' Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">没伞的孩子必须努力奔跑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/pt-online-schema-change-使用教程.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/jiessie.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">pt-online-schema-change 使用教程</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-20T14:12:57+08:00">
                2018-09-20
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/工具/" itemprop="url" rel="index">
                    <span itemprop="name">工具</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">
      
      

      
        <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>MySQL生产更改表结构的方式有很多，MySQL官方的Online DDL，github开源的gh-ost，此文仅介绍percona的工具包其中的pt-online-schema-change</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><h3 id="general-log"><a href="#general-log" class="headerlink" title="general_log"></a>general_log</h3><p>在mysql实例中开启general_log参数，观察pt-online-schema-change的执行过程。</p>
<p>执行pt-online-schema-change的语句如下：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-online-schema-change <span class="attribute">--user</span>=root  <span class="attribute">--password</span>=xxx <span class="attribute">--socket</span>=/opt/mysql3306/data/mysql.sock  <span class="attribute">D</span>=test,t=employee1 --alter <span class="string">"engine=innodb"</span>  <span class="attribute">--recursion-method</span>=none --no-check-replication-filters --alter-foreign-keys-method auto --<span class="builtin-name">print</span> --execute <span class="attribute">--critical-load</span>=<span class="string">"Threads_running:200"</span> <span class="attribute">--charset</span>=utf8mb4</span><br></pre></td></tr></table></figure></p>
<p>以下为执行DDL过程中产生的general_log:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">2018-09-20T14:22:32.070723+08:00	   52 Connect	root@localhost on test using Socket</span><br><span class="line">2018-09-20T14:22:32.071066+08:00	   52 Query	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'innodb\_lock_wait_timeout'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.073617</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">SESSION</span> innodb_lock_wait_timeout=<span class="number">1</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.073760</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'lock\_wait_timeout'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.074808</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">SESSION</span> lock_wait_timeout=<span class="number">60</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.074930</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'wait\_timeout'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.075913</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">SESSION</span> wait_timeout=<span class="number">10000</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.076034</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@SQL_MODE</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.076153</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> @@SQL_QUOTE_SHOW_CREATE = <span class="number">1</span><span class="comment">/*!40101, @@SQL_MODE='NO_AUTO_VALUE_ON_ZERO,ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.076290</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@server_id <span class="comment">/*!50038 , @@hostname*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.077001</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Connect</span>	root@localhost <span class="keyword">on</span> <span class="keyword">test</span> <span class="keyword">using</span> Socket</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.077212</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'innodb\_lock_wait_timeout'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.078706</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">SESSION</span> innodb_lock_wait_timeout=<span class="number">1</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.078829</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'lock\_wait_timeout'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.079847</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">SESSION</span> lock_wait_timeout=<span class="number">60</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.079964</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'wait\_timeout'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.080952</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> <span class="keyword">SESSION</span> wait_timeout=<span class="number">10000</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.081068</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@SQL_MODE</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.081183</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SET</span> @@SQL_QUOTE_SHOW_CREATE = <span class="number">1</span><span class="comment">/*!40101, @@SQL_MODE='NO_AUTO_VALUE_ON_ZERO,ONLY_FULL_GROUP_BY,STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_ENGINE_SUBSTITUTION'*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.081314</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> @@server_id <span class="comment">/*!50038 , @@hostname*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.081664</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'wsrep_on'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.083211</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'version%'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.084429</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">ENGINES</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.084774</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'innodb_version'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.086177</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'innodb_stats_persistent'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.087447</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.088579</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.089437</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="keyword">CONCAT</span>(@@hostname, @@port)</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.089777</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">TABLES</span> <span class="keyword">FROM</span> <span class="string">`test`</span> <span class="keyword">LIKE</span> <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.131978</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="keyword">VERSION</span>()</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.132209</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">TRIGGERS</span> <span class="keyword">FROM</span> <span class="string">`test`</span> <span class="keyword">LIKE</span> <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.141352</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="comment">/*!40101 SET @OLD_SQL_MODE := @@SQL_MODE, @@SQL_MODE := '', @OLD_QUOTE := @@SQL_QUOTE_SHOW_CREATE, @@SQL_QUOTE_SHOW_CREATE := 1 */</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.141549</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">USE</span> <span class="string">`test`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.141731</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.142086</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="comment">/*!40101 SET @@SQL_MODE := @OLD_SQL_MODE, @@SQL_QUOTE_SHOW_CREATE := @OLD_QUOTE */</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.142497</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">WHERE</span> <span class="number">1</span>=<span class="number">1</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.142931</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> table_schema, table_name <span class="keyword">FROM</span> information_schema.key_column_usage <span class="keyword">WHERE</span> referenced_table_schema=<span class="string">'test'</span> <span class="keyword">AND</span> referenced_table_name=<span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.216829</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'wsrep_on'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.219654</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="comment">/*!40101 SET @OLD_SQL_MODE := @@SQL_MODE, @@SQL_MODE := '', @OLD_QUOTE := @@SQL_QUOTE_SHOW_CREATE, @@SQL_QUOTE_SHOW_CREATE := 1 */</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.219802</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">USE</span> <span class="string">`test`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.220004</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.220231</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="comment">/*!40101 SET @@SQL_MODE := @OLD_SQL_MODE, @@SQL_QUOTE_SHOW_CREATE := @OLD_QUOTE */</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.220455</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> (</span><br><span class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`employeeid`</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'0'</span>,</span><br><span class="line">  <span class="string">`employeename`</span> <span class="built_in">varchar</span>(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">''</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">10001</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.336287</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> <span class="keyword">engine</span>=<span class="keyword">innodb</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.499232</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="comment">/*!40101 SET @OLD_SQL_MODE := @@SQL_MODE, @@SQL_MODE := '', @OLD_QUOTE := @@SQL_QUOTE_SHOW_CREATE, @@SQL_QUOTE_SHOW_CREATE := 1 */</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.499400</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">USE</span> <span class="string">`test`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.499611</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.499866</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="comment">/*!40101 SET @@SQL_MODE := @OLD_SQL_MODE, @@SQL_QUOTE_SHOW_CREATE := @OLD_QUOTE */</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.500737</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> TRIGGER_SCHEMA, TRIGGER_NAME, DEFINER, ACTION_STATEMENT, SQL_MODE,        CHARACTER_SET_CLIENT, COLLATION_CONNECTION, EVENT_MANIPULATION, ACTION_TIMING   <span class="keyword">FROM</span> INFORMATION_SCHEMA.TRIGGERS  <span class="keyword">WHERE</span> EVENT_MANIPULATION = <span class="string">'DELETE'</span>    <span class="keyword">AND</span> ACTION_TIMING = <span class="string">'AFTER'</span>    <span class="keyword">AND</span> TRIGGER_SCHEMA = <span class="string">'test'</span>    <span class="keyword">AND</span> EVENT_OBJECT_TABLE = <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.502027</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> TRIGGER_SCHEMA, TRIGGER_NAME, DEFINER, ACTION_STATEMENT, SQL_MODE,        CHARACTER_SET_CLIENT, COLLATION_CONNECTION, EVENT_MANIPULATION, ACTION_TIMING   <span class="keyword">FROM</span> INFORMATION_SCHEMA.TRIGGERS  <span class="keyword">WHERE</span> EVENT_MANIPULATION = <span class="string">'UPDATE'</span>    <span class="keyword">AND</span> ACTION_TIMING = <span class="string">'AFTER'</span>    <span class="keyword">AND</span> TRIGGER_SCHEMA = <span class="string">'test'</span>    <span class="keyword">AND</span> EVENT_OBJECT_TABLE = <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.502989</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> TRIGGER_SCHEMA, TRIGGER_NAME, DEFINER, ACTION_STATEMENT, SQL_MODE,        CHARACTER_SET_CLIENT, COLLATION_CONNECTION, EVENT_MANIPULATION, ACTION_TIMING   <span class="keyword">FROM</span> INFORMATION_SCHEMA.TRIGGERS  <span class="keyword">WHERE</span> EVENT_MANIPULATION = <span class="string">'INSERT'</span>    <span class="keyword">AND</span> ACTION_TIMING = <span class="string">'AFTER'</span>    <span class="keyword">AND</span> TRIGGER_SCHEMA = <span class="string">'test'</span>    <span class="keyword">AND</span> EVENT_OBJECT_TABLE = <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.503974</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> TRIGGER_SCHEMA, TRIGGER_NAME, DEFINER, ACTION_STATEMENT, SQL_MODE,        CHARACTER_SET_CLIENT, COLLATION_CONNECTION, EVENT_MANIPULATION, ACTION_TIMING   <span class="keyword">FROM</span> INFORMATION_SCHEMA.TRIGGERS  <span class="keyword">WHERE</span> EVENT_MANIPULATION = <span class="string">'DELETE'</span>    <span class="keyword">AND</span> ACTION_TIMING = <span class="string">'BEFORE'</span>    <span class="keyword">AND</span> TRIGGER_SCHEMA = <span class="string">'test'</span>    <span class="keyword">AND</span> EVENT_OBJECT_TABLE = <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.504875</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> TRIGGER_SCHEMA, TRIGGER_NAME, DEFINER, ACTION_STATEMENT, SQL_MODE,        CHARACTER_SET_CLIENT, COLLATION_CONNECTION, EVENT_MANIPULATION, ACTION_TIMING   <span class="keyword">FROM</span> INFORMATION_SCHEMA.TRIGGERS  <span class="keyword">WHERE</span> EVENT_MANIPULATION = <span class="string">'UPDATE'</span>    <span class="keyword">AND</span> ACTION_TIMING = <span class="string">'BEFORE'</span>    <span class="keyword">AND</span> TRIGGER_SCHEMA = <span class="string">'test'</span>    <span class="keyword">AND</span> EVENT_OBJECT_TABLE = <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.505829</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> TRIGGER_SCHEMA, TRIGGER_NAME, DEFINER, ACTION_STATEMENT, SQL_MODE,        CHARACTER_SET_CLIENT, COLLATION_CONNECTION, EVENT_MANIPULATION, ACTION_TIMING   <span class="keyword">FROM</span> INFORMATION_SCHEMA.TRIGGERS  <span class="keyword">WHERE</span> EVENT_MANIPULATION = <span class="string">'INSERT'</span>    <span class="keyword">AND</span> ACTION_TIMING = <span class="string">'BEFORE'</span>    <span class="keyword">AND</span> TRIGGER_SCHEMA = <span class="string">'test'</span>    <span class="keyword">AND</span> EVENT_OBJECT_TABLE = <span class="string">'employee1'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.513721</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> <span class="string">`pt_osc_test_employee1_del`</span> <span class="keyword">AFTER</span> <span class="keyword">DELETE</span> <span class="keyword">ON</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">DELETE</span> <span class="keyword">IGNORE</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> <span class="keyword">WHERE</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span>.<span class="string">`id`</span> &lt;=&gt; OLD.<span class="string">`id`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.552672</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> <span class="string">`pt_osc_test_employee1_upd`</span> <span class="keyword">AFTER</span> <span class="keyword">UPDATE</span> <span class="keyword">ON</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">BEGIN</span> <span class="keyword">DELETE</span> <span class="keyword">IGNORE</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> <span class="keyword">WHERE</span> !(OLD.<span class="string">`id`</span> &lt;=&gt; NEW.<span class="string">`id`</span>) <span class="keyword">AND</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span>.<span class="string">`id`</span> &lt;=&gt; OLD.<span class="string">`id`</span>;<span class="keyword">REPLACE</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>) <span class="keyword">VALUES</span> (NEW.<span class="string">`id`</span>, NEW.<span class="string">`employeeid`</span>, NEW.<span class="string">`employeename`</span>);<span class="keyword">END</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.583800</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">CREATE</span> <span class="keyword">TRIGGER</span> <span class="string">`pt_osc_test_employee1_ins`</span> <span class="keyword">AFTER</span> <span class="keyword">INSERT</span> <span class="keyword">ON</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FOR</span> <span class="keyword">EACH</span> <span class="keyword">ROW</span> <span class="keyword">REPLACE</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>) <span class="keyword">VALUES</span> (NEW.<span class="string">`id`</span>, NEW.<span class="string">`employeeid`</span>, NEW.<span class="string">`employeename`</span>)</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.611701</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">WHERE</span> <span class="number">1</span>=<span class="number">1</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.613770</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="string">`id`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">LIMIT</span> <span class="number">1</span> <span class="comment">/*first lower boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.614250</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="string">`id`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span> (<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> <span class="string">`id`</span> <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">LIMIT</span> <span class="number">1</span> <span class="comment">/*key_len*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.614536</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> * <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span> (<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> <span class="string">`id`</span> &gt;= <span class="string">'1'</span> <span class="comment">/*key_len*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.614982</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="string">`id`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1'</span>)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">LIMIT</span> <span class="number">999</span>, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.615319</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="string">`id`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1'</span>)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">LIMIT</span> <span class="number">999</span>, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.615860</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1'</span>)) <span class="keyword">AND</span> ((<span class="string">`id`</span> &lt;= <span class="string">'1000'</span>)) <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span> <span class="comment">/*explain pt-online-schema-change 17673 copy nibble*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.616300</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">INSERT</span> <span class="keyword">LOW_PRIORITY</span> <span class="keyword">IGNORE</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>) <span class="keyword">SELECT</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1'</span>)) <span class="keyword">AND</span> ((<span class="string">`id`</span> &lt;= <span class="string">'1000'</span>)) <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span> <span class="comment">/*pt-online-schema-change 17673 copy nibble*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.652804</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">WARNINGS</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.653297</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.654684</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="string">`id`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1001'</span>)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">LIMIT</span> <span class="number">13729</span>, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.655061</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="string">`id`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1001'</span>)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">LIMIT</span> <span class="number">13729</span>, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.657464</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="string">`id`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="string">`id`</span> <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> <span class="number">1</span> <span class="comment">/*last upper boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.657712</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">EXPLAIN</span> <span class="keyword">SELECT</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1001'</span>)) <span class="keyword">AND</span> ((<span class="string">`id`</span> &lt;= <span class="string">'10000'</span>)) <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span> <span class="comment">/*explain pt-online-schema-change 17673 copy nibble*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.658105</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">INSERT</span> <span class="keyword">LOW_PRIORITY</span> <span class="keyword">IGNORE</span> <span class="keyword">INTO</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> (<span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span>) <span class="keyword">SELECT</span> <span class="string">`id`</span>, <span class="string">`employeeid`</span>, <span class="string">`employeename`</span> <span class="keyword">FROM</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="string">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="string">`id`</span> &gt;= <span class="string">'1001'</span>)) <span class="keyword">AND</span> ((<span class="string">`id`</span> &lt;= <span class="string">'10000'</span>)) <span class="keyword">LOCK</span> <span class="keyword">IN</span> <span class="keyword">SHARE</span> <span class="keyword">MODE</span> <span class="comment">/*pt-online-schema-change 17673 copy nibble*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.890346</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">WARNINGS</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.890850</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">GLOBAL</span> <span class="keyword">STATUS</span> <span class="keyword">LIKE</span> <span class="string">'Threads_running'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.892398</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'version%'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.895063</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">ENGINES</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.895463</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">VARIABLES</span> <span class="keyword">LIKE</span> <span class="string">'innodb_version'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.897284</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">ANALYZE</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> <span class="comment">/* pt-online-schema-change */</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">32.935080</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">RENAME</span> <span class="keyword">TABLE</span> <span class="string">`test`</span>.<span class="string">`employee1`</span> <span class="keyword">TO</span> <span class="string">`test`</span>.<span class="string">`_employee1_old`</span>, <span class="string">`test`</span>.<span class="string">`_employee1_new`</span> <span class="keyword">TO</span> <span class="string">`test`</span>.<span class="string">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">33.051130</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`test`</span>.<span class="string">`_employee1_old`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">33.147460</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`test`</span>.<span class="string">`pt_osc_test_employee1_del`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">33.153099</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`test`</span>.<span class="string">`pt_osc_test_employee1_upd`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">33.160364</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`test`</span>.<span class="string">`pt_osc_test_employee1_ins`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">33.170939</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> <span class="keyword">Query</span>	<span class="keyword">SHOW</span> <span class="keyword">TABLES</span> <span class="keyword">FROM</span> <span class="string">`test`</span> <span class="keyword">LIKE</span> <span class="string">'\_employee1\_new'</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">33.227570</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">53</span> Quit	</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-20</span>T14:<span class="number">22</span>:<span class="number">33.230437</span>+<span class="number">08</span>:<span class="number">00</span>	   <span class="number">52</span> Quit</span><br></pre></td></tr></table></figure></p>
<h3 id="执行过程"><a href="#执行过程" class="headerlink" title="执行过程"></a>执行过程</h3><ol>
<li>创建一个和要执行alter操作的表一样的新的空表，前缀为_开头，后缀以_new结尾。</li>
<li>在新表执行alter table 语句，因为是空表，执行速度很快。</li>
<li>在原表中创建3个触发器，分别对应insert,update,delete操作，<font color="FF000">在5.6版本中不允许存在其他触发器</font>，会报错，5.7版本中无此限制。</li>
<li>以一定块大小从原表拷贝数据到临时表，拷贝过程中通过原表上的触发器在原表进行的写操作都会更新到新建的临时表，注意这里INSERT和UPDATE采用INSERT LOW_PRIORITY IGNORE INTO操作，DELETE和UPDATE采用REPLACE INTO操作。</li>
<li>以原子重命名的方式，将原表名table修改为 _table_old, 将_table_new 表明修改为原表名。</li>
<li>如果有参考该表的外键，根据alter-foreign-keys-method参数的值，检测外键相关的表，做相应设置的处理。</li>
<li>默认最后将旧原表删除，触发器删除。</li>
</ol>
<h3 id="时序问题"><a href="#时序问题" class="headerlink" title="时序问题"></a>时序问题</h3><p>这里说明一下复制原表数据和触发器的执行顺序是否会产生数据不一致的问题</p>
<h4 id="UPDATE"><a href="#UPDATE" class="headerlink" title="UPDATE"></a>UPDATE</h4><p>1.假设pt-online-schema-change在T(10:00:00)执行<br><br>2.假设id=2000050这行数据，在T2(10:01:00)时间进行了update，生产的数据通过触发器同步到了临时表，update方式为先DELETE IGNORE，然后REPLCAE INTO，会有2种情况：<br><br>1)如果id=2000050这行数据还没从原表复制到临时表，此时DELETE IGNORE不会匹配到数据，REPLCAE INTO会插入新数据；后面执行到分批从原表复制数据到临时表时，包括将id=2000050这行，由于采用的用INSERT LOW_PRIORITY IGNORE INTO，也就不会插入；<br><br>2)如果id=2000050这行数据已经从原表复制到临时表，此时DELETE IGNORE会匹配到数据并删除，REPLCAE INTO重新插入新数据；<br><br>3.继续往后执行</p>
<h4 id="INSERT"><a href="#INSERT" class="headerlink" title="INSERT"></a>INSERT</h4><p>1.假设pt-online-schema-change在T(10:00:00)执行<br><br>2.假设新插入数据id=10000001这行数据，在T2(10:30:00)时间进行，由于新插入的数据原表不存在，通过触发器，采用REPLACE INTO，临时表如果存在这条数据，覆盖掉，理论上通过pt-online-schema-change正常执行，临时表也不会存在此行数据<br><br>3.继续往后执行</p>
<h4 id="DELETE"><a href="#DELETE" class="headerlink" title="DELETE"></a>DELETE</h4><p>1.假设pt-online-schema-change在T(10:00:00)执行<br><br>2.假设id=2000050这行数据，在T2(10:01:00)时间进行了delete，生产的数据通过触发器同步到了临时表，delete方式为先DELETE IGNORE<br><br>1)如果id=2000050这行数据还没从原表复制到临时表，此时DELETE IGNORE不会匹配到数据；后面执行到分批从原表复制数据到临时表时，包括将id=2000050这行，由于采用的用INSERT LOW_PRIORITY IGNORE INTO，也就不会插入；<br><br>2)如果id=2000050这行数据已经从原表复制到临时表，此时DELETE IGNORE会匹配到数据并删除<br><br>3.继续往后执行</p>
<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><p>pt-online-schema-change [OPTIONS] DSN</p>
<p>pt-online-schema-change在不阻塞读或写的情况下更改表的结构。在DSN中指定数据库和表。</p>
<p>sakila.actor增加字段：<br><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-online-schema-change --alter <span class="string">"ADD COLUMN c1 INT"</span> <span class="type">D</span>=sakila,t=<span class="class"><span class="keyword">actor</span></span></span><br></pre></td></tr></table></figure></p>
<p>sakila.actor更改存储引擎为InnoDB：<br><figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-online-schema-change --alter <span class="string">"ENGINE=InnoDB"</span> <span class="type">D</span>=sakila,t=<span class="class"><span class="keyword">actor</span></span></span><br></pre></td></tr></table></figure></p>
<h2 id="风险"><a href="#风险" class="headerlink" title="风险"></a>风险</h2><p>Percona Toolkit已经成熟，并得到了验证，并经过了充分测试，但所有数据库工具都可能对系统和数据库服务器造成风险，在使用此工具前注意:</p>
<ul>
<li>阅读工具的文档</li>
<li>查看工具已知的bug列表</li>
<li>在非生产服务器上测试</li>
<li>备份生产服务器并验证备份有效性</li>
</ul>
<h2 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h2><ol>
<li>表中无主键或唯一索引，pt-online-schema-change拒绝执行。</li>
<li>复制集群中存在过滤复制，pt-online-schema-change拒绝执行，修改参数为–[no]check-replication-filters</li>
<li>执行过程中检测到从库延迟，暂停数据复制，调节参数为–max-lag</li>
<li>执行过程中检测到负载过高，pt-online-schema-change暂停或中止执行，调节参数为–max-load和–critical-load</li>
<li>不能通过删除一列，然后再新增一列的方式来完成对列的重命名操作。</li>
<li>新增字段，如果这个字段是NOT NULL，必须要指定default值，否则报错，你必须指定默认值。</li>
<li>如果是DROP FOREIGN KEY constraint_name ， 那么必须指定 _ 加上 constraint_name ， 而不是 constraint_name。</li>
<li>默认会设置锁等待超时时间为1s来避免干扰其他事务的进行，调节参数为–lock-wait-timeout。</li>
<li>默认如果检测到外键冲突后会拒绝改表，调节参数为–alter-foreign-keys-method。</li>
<li>该工具不能在PXC（Percona XtraDB Cluster）集群中对myisam表进行改表操作。</li>
</ol>
<h2 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h2><p>–dry-run 和 –execute 互斥,前者为打印,后者为执行</p>
<h3 id="选项"><a href="#选项" class="headerlink" title="选项"></a>选项</h3><table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>–alter</td>
<td>通过这个选项，就不需要alter table关键字了，可以通过逗号来指定多个修改操作。<br>例如：ADD COLUMN c1 INT</td>
</tr>
<tr>
<td>–alter-foreign-keys-method</td>
<td>如何把外键引用到新表?需要特殊处理带有外键约束的表,以保证它们可以应用到新表.当重命名表的时候,外键关系会带到重命名后的表上。<br><br>该工具有两种方法,可以自动找到子表,并修改约束关系。<br>auto： 在rebuild_constraints和drop_swap两种处理方式中选择一个。<br>rebuild_constraints：使用 ALTER TABLE语句先删除外键约束,然后再添加.如果子表很大的话,会导致长时间的阻塞。<br>drop_swap： 执行FOREIGN_KEY_CHECKS=0,禁止外键约束,删除原表,再重命名新表。这种方式很快,也不会产生阻塞,但是有风险：<br>  1.在删除原表和重命名新表的短时间内,表是不存在的,程序会返回错误。<br>  2.如果重命名表出现错误,也不能回滚了.因为原表已经被删除。<br>none： 类似”drop_swap”的处理方式,但是它不删除原表,并且外键关系会随着重命名转到老表上面。</td>
</tr>
<tr>
<td>–[no]analyze-before-swap</td>
<td>默认 yes，在新表与旧表完成转换之前对新表执行ANALYZE TABLE操作，默认会在MySQL5.6及之后版本并且开启innodb_stats_persistent的情况下执行。</td>
</tr>
<tr>
<td>–ask-pass</td>
<td>命令行提示密码输入，保护密码安全，前提需安装模块perl-TermReadKey。</td>
</tr>
<tr>
<td>–channel</td>
<td>指定当主从复制环境是多源复制时需要进行同步哪个主库的数据，适用于多源复制中多个主库对应一个从库的情形。</td>
</tr>
<tr>
<td>–charset</td>
<td>指定连接字符集。</td>
</tr>
<tr>
<td>–[no]check-alter</td>
<td>默认 yes，解析变更选项的内容，发出表变更警告，主要警告项为：<br><br>1.字段重命名<br>在工具的早期版本中，通过指定CHANGE COLUMN name new_name进行字段重命名会导致数据库的丢失，现在的版本已经通过代码解决了数据一致性问题。但这段代码并不能保证能够确保数据的不丢失。所以当涉及到字段名变更时应通过添加选项’–dry-run’和’–print’查看变更是否可以正确执行。<br>2.删除主键<br>如果’–alter’选项中包含DROP PRIMARY KEY删除主键的操作，除非指定选项’–dry-run’，否则工具将退出。变更表的主键是十分危险的，工具变更时建立的触发器，尤其是DELETE触发器，是基于主键的，在做主键变更前先添加选项’–dry-run’和’–print’验证触发器是可用的。</td>
</tr>
<tr>
<td>–check-interval</td>
<td>指定出现从库滞后超过max-lag，则该工具将睡眠多长时间，默认1s，再检查。</td>
</tr>
<tr>
<td>–[no]check-plan</td>
<td>默认 yes，检查查询执行计划的安全性。</td>
</tr>
<tr>
<td>–[no]check-replication-filters</td>
<td>默认 yes，如果工具检测到服务器选项中有任何复制相关的筛选，如指定 binlog_ignore_db 和 replicate_do_db 此类。发现有这样的筛选，工具会报错且退出。因为如果更新的表 Master 上存在，而 Slave 上不存在，会导致复制的失败。使用–no-check-replication-filters 选项来禁用该检查。</td>
</tr>
<tr>
<td>–check-slave-lag</td>
<td>指定一个从库的 DSN 连接地址，如果从库超过 –max-lag 参数设置的值，就会暂停操作。</td>
</tr>
<tr>
<td>–chunk-index</td>
<td>指定使用哪个索引对表进行chunk分块操作。默认情况下会选择最优的索引，工具会在SQL语句中添加FORCE INDEX子句。</td>
</tr>
<tr>
<td>–chunk-index-columns</td>
<td>指定使用选项’–chunk-index’的索引使用最左前缀几个索引字段，只适用于复合索引。</td>
</tr>
<tr>
<td>–chunk-size</td>
<td>指定表分块的chunk大小，每个chunk对应的表行数，默认是 1000 行，也可以是数据块大小，当指定大小时允许的后缀单位为k、M、G。这个块的大小要尽量与 –chunk-time 匹配，如果明确指定这个选项，那么每个块就会指定行数的大小。<font color="FF0000">如果块索引不是唯一的，那么块可能会比期望的大</font></td>
</tr>
<tr>
<td>–chunk-size-limit</td>
<td>当需要复制的块远大于设置的 chunk-size 大小，就不复制。默认值是 4.0，一个没有主键或唯一索引的表，块大小就是不确定的。</td>
</tr>
<tr>
<td>–chunk-time</td>
<td>在 chunk-time 执行的时间内，动态调整 chunk-size 的大小，以适应服务器性能的变化，该参数设置为 0, 或者指定 chunk-size, 都可以禁止动态调整。</td>
</tr>
<tr>
<td>–config</td>
<td>读取以逗号分隔的配置文件列表，如果指定，则必须要在命令行的第一个选项位置</td>
</tr>
<tr>
<td>–critical-load</td>
<td>默认为 Threads_running=50。用法基本与 –max-load 类似，如果不指定 MAX_VALUE，那么工具会这只其为当前值的 200%。如果超过指定值，则工具直接退出，而不是暂停。</td>
</tr>
<tr>
<td>–database</td>
<td>指定连接的数据库，如有多个则用’,’(逗号)隔开。</td>
</tr>
<tr>
<td>–default-engine</td>
<td>默认情况下，新的表与原始表是相同的存储引擎，所以如果原来的表使用 InnoDB 的，那么新表将使用 InnoDB 的。在涉及复制某些情况下，很可能主从的存储引擎不一样。使用该选项会默认使用默认的存储引擎。</td>
</tr>
<tr>
<td>–data-dir</td>
<td>使用DATA DIRECTORY特性在不同的分区上创建新表。只能在5.6以上版本中使用。如果与remove-data-dir同时使用，则忽略此参数。</td>
</tr>
<tr>
<td>–remove-data-dir</td>
<td>如果原始表是使用DATA DIRECTORY特性创建的，那么删除它并在MySQL默认目录中创建新表，而不创建新的isl文件。</td>
</tr>
<tr>
<td>–defaults-file</td>
<td>读取配置文件。</td>
</tr>
<tr>
<td>–[no]drop-new-table</td>
<td>默认 yes。如果拷贝旧表数据到新表时失败，则删除新表。如果指定选项’–no-drop-new-table’以及’–no-swap-tables’将保留一份变更后的副本，但不会对旧表进行修改。-no-drop-new-table不能用于修改-foreign-key -method drop_swap。</td>
</tr>
<tr>
<td>–[no]drop-old-table</td>
<td>默认 yes。复制数据完成重命名之后，删除原表，如果有错误则会保留原表，指定选项’–no-swap-tables’同样不会删除旧表。</td>
</tr>
<tr>
<td>–[no]drop-trigger</td>
<td>默认 yes，删除原表上的触发器。 –no-drop-triggers 会强制开启 –no-drop-old-table 即：不删除触发器就会强制不删除原表。</td>
</tr>
<tr>
<td>–dry-run</td>
<td>创建和修改新表，但不会创建触发器、复制数据、和替换原表。并不真正执行，可以看到生成的执行语句，了解其执行步骤与细节。–dry-run 与 –execute 必须指定一个，二者相互排斥。和 –print 配合最佳。</td>
</tr>
<tr>
<td>–execute</td>
<td>确定修改表，则指定该参数。真正执行。–dry-run 与 –execute 必须指定一个，二者相互排斥。</td>
</tr>
<tr>
<td>–[no]check-unique-key-change</td>
<td>默认值：yes，当工具要进行添加唯一索引的变更时停止运行。因为工具使用语句INSERT IGNORE从旧表进行数据拷贝插入新表，如果插入的值违返唯一性约束，数据插入不会明确提示失败但这样会造成数据丢失。</td>
</tr>
<tr>
<td>–force</td>
<td>强制运行，可能打破外键约束。</td>
</tr>
<tr>
<td>–help</td>
<td>打印帮助。</td>
</tr>
<tr>
<td>–host</td>
<td>连接的host。</td>
</tr>
<tr>
<td>–max-flow-ctl</td>
<td>类似-max-lag，适用于PXC集群。检查用于流控制的平均暂停时间集群，如果超过选项中指定的百分比，则使工具暂停。当检测到任何流控制活动时，值0将使工具暂停。默认情况下没有流控制检查。此选项适用于PXC版本5.6或更高版本。</td>
</tr>
<tr>
<td>–max-lag</td>
<td>默认 1s。每个 chunk 拷贝完成后，会查看所有复制 Slave 的延迟情况。要是延迟大于该值，则暂停复制数据，直到所有从的滞后小于这个值，使用 Seconds_Behind_Master。如果有任何从滞后超过此选项的值，则该工具将睡眠 –check-interval 指定的时间，再检查。如果从被停止，将会永远等待，直到从开始同步，并且延迟小于该值。如果指定 –check-slave-lag，该工具只检查该服务器的延迟，而不是所有服务器。</td>
</tr>
<tr>
<td>–max-load</td>
<td>默认为 Threads_running=25。每个 chunk 拷贝完后，会检查 SHOW GLOBAL STATUS 的内容，检查指标是否超过了tatus 指标 =MAX_VALUE 或者 status 指标：MAX_VALUE。如果不指定 MAX_VALUE，那么工具会这只其为当前值的 120%。</td>
</tr>
<tr>
<td>–preserve-triggers</td>
<td>指定保留旧表的触发器。从MySQL5.7.2起开始支持在同一张给定的表上定义具有相同触发事件和触发时间的多个触发器。这意味着如果表原来已有触发器，那么工具所需的触发器也可以创建成功。如果指定了该选项，则工具将旧表上所有的触发器复制到新表上，然后再进行表数据行的拷贝操作。<br><br>限制：<br>1.如果旧表上的触发器引用了将被工具删除的字段，则触发器失效；<br>2.该选项不能与选项’–no-drop-triggers’、’–no-drop-old-table’和’–no-swap-tables’一起使用，因为该选项需要删除旧表的触发器并在新表上重新创建，因为表不可能有多个同名的触发器。</td>
</tr>
<tr>
<td>–new-table-name</td>
<td>复制创建新表的名称，默认 %T_new。</td>
</tr>
<tr>
<td>–null-to-not-null</td>
<td>指定可以将允许NULL的字段转换为NOT NULL字段。其中如有包含NULL行的字段值转换为字段默认值，如果没有字段值，则根字段类型来分配默认值。如：字符串类型为’’(空字符串)，数值类型为0。</td>
</tr>
<tr>
<td>–only-same-schema-fks</td>
<td>仅在与原始表相同模式的表上检查外键。 此选项很危险，因为如果您有FL引用其他架构中的表，则不会检测到它们。</td>
</tr>
<tr>
<td>–password</td>
<td>连接的密码。</td>
</tr>
<tr>
<td>–pause-file</td>
<td>当此参数指定的文件存在时，执行将暂停。</td>
</tr>
<tr>
<td>–pid</td>
<td>创建给定的PID文件。 如果PID文件已经存在并且包含的PID与当前的PID不同，则该工具将无法启动。但是，如果存在PID文件，并且其中包含的PID不再运行，则该工具将使用当前PID覆盖PID文件。 工具退出后，PID文件将自动删除。</td>
</tr>
<tr>
<td>–plugin</td>
<td>定义”pt_online_schema_change_plugin”类的Perl模块文件。 使用插件，您可以编写一个Perl模块，该模块可以连接到pt-online-schema-change的许多部分。 这需要对Perl和Percona Toolkit约定的充分了解，而这些约定不在本文档的讨论范围之内。 如有疑问或需要帮助，请联系Percona。</td>
</tr>
<tr>
<td>–port</td>
<td>连接的端口。</td>
</tr>
<tr>
<td>–print</td>
<td>打印 SQL 语句到标准输出。指定此选项可以让你看到该工具所执行的语句，和 –dry-run 配合最佳。</td>
</tr>
<tr>
<td>–progress</td>
<td>复制数据的时候打印进度报告，二部分组成：第一部分是百分比，第二部分是时间。</td>
</tr>
<tr>
<td>–quiet</td>
<td>-q，不把信息标准输出。</td>
</tr>
<tr>
<td>–recurse</td>
<td>指定搜寻从库的层级，默认无限级。</td>
</tr>
<tr>
<td>–recursion-method</td>
<td>默认是 show processlist，发现从的方法，也可以是 host，但需要在从上指定 report_host，通过 show slave hosts 来找到，可以指定 none 来不检查 Slave。<br><br>METHOD       USES<br>=====  ========<br>processlist  SHOW PROCESSLIST<br>hosts        SHOW SLAVE HOSTS<br>dsn=DSN      DSNs from a table<br>none         Do not find slaves<br>指定 none 则表示不在乎从的延迟。</td>
</tr>
<tr>
<td>–skip-check-slave-lag</td>
<td>检查SLAVE的时候，指定该SLAVE跳过。</td>
</tr>
<tr>
<td>–slave-user</td>
<td>设置用于连接到从库的用户。</td>
</tr>
<tr>
<td>–slave-password</td>
<td>设置用于连接到从库的密码。</td>
</tr>
<tr>
<td>–set-vars</td>
<td>默认：<br>wait_timeout=10000<br>innodb_lock_wait_timeout=1<br>lock_wait_timeout=60<br>运行检查时指定参数值，如有多个用’,’(逗号)分隔。如’–set-vars wait_timeout=500’。</td>
</tr>
<tr>
<td>–sleep</td>
<td>默认值：0s，每个chunk导入后与下一次chunk导入开始前sleep一会，sleep时间越长，对于磁盘IO的冲击就越小。</td>
</tr>
<tr>
<td>–socket</td>
<td>连接实例的socket。</td>
</tr>
<tr>
<td>–statistics</td>
<td>打印出内部事件的数目，可以看到复制数据插入的数目。</td>
</tr>
<tr>
<td>–[no]swap-tables</td>
<td>默认 yes。交换原始表和新表，除非你禁止 –[no]drop-old-table。</td>
</tr>
<tr>
<td>–tries</td>
<td>尝试几次关键操作。 如果某些操作由于非致命的可恢复错误而失败，则该工具将等待并再次尝试该操作。<br>这些是重试的操作，其默认尝试次数和两次尝试之间的等待时间（以秒为单位）：<br><br>OPERATION            TRIES   WAIT<br>=======  ====   ====<br>create_triggers         10      1<br>drop_triggers           10      1<br>copy_rows               10   0.25<br>swap_tables             10      1<br>update_foreign_keys     10      1<br>analyze_table           10      1<br><br>要更改默认值，请指定新值，例如：–tries create_triggers:5:0.5,drop_triggers:5:0.5</td>
</tr>
<tr>
<td>–user</td>
<td>连接的用户。</td>
</tr>
<tr>
<td>–version</td>
<td>打印版本信息。</td>
</tr>
<tr>
<td>–[no]version-check</td>
<td>默认值：yes，检查Percona Toolkit、MySQL和其他程序的最新版本。</td>
</tr>
</tbody>
</table>
<h3 id="DSN选项"><a href="#DSN选项" class="headerlink" title="DSN选项"></a>DSN选项</h3><p>这些选项选用于创建DSN,每个选项都给出了option=value,选项区分大小写</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>dsn: charset; copy: yes 默认字符集</td>
</tr>
<tr>
<td>D</td>
<td>dsn: database; copy: yes 默认数据库</td>
</tr>
<tr>
<td>F</td>
<td>dsn: mysql_read_default_file; copy: yes 仅从指定文件读取参数</td>
</tr>
<tr>
<td>h</td>
<td>dsn: host; copy: yes 连接的host</td>
</tr>
<tr>
<td>p</td>
<td>dsn: password; copy: yes 连接的密码</td>
</tr>
<tr>
<td>P</td>
<td>dsn: port; copy: yes 连接的端口</td>
</tr>
<tr>
<td>S</td>
<td>dsn: mysql_socket; copy: yes 连接的socket</td>
</tr>
<tr>
<td>u</td>
<td>dsn: user; copy: yes 连接的用户</td>
</tr>
<tr>
<td>t</td>
<td>记录操作的表,通过–log-dsn指定</td>
</tr>
</tbody>
</table>
<h2 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h2><h3 id="创建测试表"><a href="#创建测试表" class="headerlink" title="创建测试表"></a>创建测试表</h3><p>通过存储过程，在test库下创建employee1表<br><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">DROP <span class="function"><span class="keyword">PROCEDURE</span> <span class="title">IF</span> <span class="title">EXISTS</span> <span class="title">my_test1</span>$$</span></span><br><span class="line"><span class="function"><span class="title">CREATE</span> <span class="title">PROCEDURE</span> <span class="title">my_test1</span><span class="params">(<span class="keyword">IN</span> loop_times INT)</span></span></span><br><span class="line"><span class="function"><span class="title">BEGIN</span></span></span><br><span class="line"><span class="function"><span class="title">DECLARE</span> <span class="title">var</span> <span class="title">INT</span> <span class="title">DEFAULT</span> 0;</span></span><br><span class="line"></span><br><span class="line">PREPARE MSQL <span class="keyword">FROM</span> <span class="string">'CREATE TABLE IF NOT EXISTS `employee1` (`id` int(10) unsigned NOT NULL AUTO_INCREMENT,`employeeid` int(10) unsigned NOT NULL COMMENT ''0'',`employeename` varchar(64) NOT NULL DEFAULT '''',PRIMARY KEY (`id`)) ENGINE=InnoDB'</span>;</span><br><span class="line">EXECUTE MSQL;</span><br><span class="line"></span><br><span class="line">START TRANSACTION;</span><br><span class="line"><span class="keyword">WHILE</span> <span class="keyword">var</span>&lt;loop_times <span class="keyword">DO</span></span><br><span class="line"><span class="keyword">SET</span> <span class="keyword">var</span>=<span class="keyword">var</span>+<span class="number">1</span>;</span><br><span class="line">INSERT <span class="keyword">INTO</span> employee1 (employeeid,employeename) VALUES (<span class="keyword">var</span>,<span class="keyword">CONCAT</span>(<span class="string">'test'</span>,<span class="keyword">var</span>));</span><br><span class="line"> </span><br><span class="line"><span class="keyword">END</span> <span class="keyword">WHILE</span>;</span><br><span class="line">COMMIT;</span><br><span class="line"><span class="keyword">END</span>$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure></p>
<h3 id="查看表信息及创建过程"><a href="#查看表信息及创建过程" class="headerlink" title="查看表信息及创建过程"></a>查看表信息及创建过程</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">10:20:39</span>]&gt; CREATE PROCEDURE my<span class="emphasis">_test1(IN loop_</span>times INT)</span><br><span class="line"><span class="code">    -&gt; BEGIN</span></span><br><span class="line"><span class="code">    -&gt; DECLARE var INT DEFAULT 0;</span></span><br><span class="line"><span class="code">    -&gt; </span></span><br><span class="line"><span class="code">    -&gt; PREPARE MSQL FROM 'CREATE TABLE IF NOT EXISTS `employee1` (`id` int(10) unsigned NOT NULL AUTO_INCREMENT,`employeeid` int(10) unsigned NOT NULL COMMENT ''0'',`employeename` varchar(64) NOT NULL DEFAULT '''',PRIMARY KEY (`id`)) ENGINE=InnoDB';</span></span><br><span class="line"><span class="code">    -&gt; EXECUTE MSQL;</span></span><br><span class="line"><span class="code">    -&gt; </span></span><br><span class="line"><span class="code">    -&gt; START TRANSACTION;</span></span><br><span class="line"><span class="code">    -&gt; WHILE var&lt;loop_times DO</span></span><br><span class="line"><span class="code">    -&gt; SET var=var+1;</span></span><br><span class="line"><span class="code">    -&gt; INSERT INTO employee1 (employeeid,employeename) VALUES (var,CONCAT('test',var));</span></span><br><span class="line"><span class="code">    -&gt;  </span></span><br><span class="line"><span class="code">    -&gt; END WHILE;</span></span><br><span class="line"><span class="code">    -&gt; COMMIT;</span></span><br><span class="line"><span class="code">    -&gt; END$$</span></span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">10:20:39</span>]&gt; DELIMITER ;</span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">10:20:39</span>]&gt; </span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">10:20:43</span>]&gt; CALL my_test1(10000);</span><br><span class="line">Query OK, 0 rows affected (0.93 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">10:20:59</span>]&gt; select * from employee1 limit 10;</span><br><span class="line">+----+------------+--------------+</span><br><span class="line">| id | employeeid | employeename |</span><br><span class="line">+----+------------+--------------+</span><br><span class="line">|  1 |          1 | test1        |</span><br><span class="line">|  2 |          2 | test2        |</span><br><span class="line">|  3 |          3 | test3        |</span><br><span class="line">|  4 |          4 | test4        |</span><br><span class="line">|  5 |          5 | test5        |</span><br><span class="line">|  6 |          6 | test6        |</span><br><span class="line">|  7 |          7 | test7        |</span><br><span class="line">|  8 |          8 | test8        |</span><br><span class="line">|  9 |          9 | test9        |</span><br><span class="line">| 10 |         10 | test10       |</span><br><span class="line">+----+------------+--------------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">10:21:08</span>]&gt; show create table employee1\G</span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line"><span class="code">       Table: employee1</span></span><br><span class="line">Create Table: CREATE TABLE <span class="code">`employee1`</span> (</span><br><span class="line">  <span class="code">`id`</span> int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  <span class="code">`employeeid`</span> int(10) unsigned NOT NULL COMMENT '0',</span><br><span class="line">  <span class="code">`employeename`</span> varchar(64) NOT NULL DEFAULT '',</span><br><span class="line">  PRIMARY KEY (<span class="code">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO<span class="emphasis">_INCREMENT=10001 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_</span>0900<span class="emphasis">_ai_</span>ci</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h3 id="添加字段"><a href="#添加字段" class="headerlink" title="添加字段"></a>添加字段</h3><p>添加字段语句：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-online-schema-change <span class="attribute">--user</span>=root  <span class="attribute">--password</span>=111111 <span class="attribute">--socket</span>=/opt/mysql3306/data/mysql.sock  <span class="attribute">D</span>=test,t=employee1 --alter <span class="string">"ADD COLUMN update_time datetime  DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间';"</span>  <span class="attribute">--recursion-method</span>=none --no-check-replication-filters --alter-foreign-keys-method auto --<span class="builtin-name">print</span> --execute <span class="attribute">--critical-load</span>=<span class="string">"Threads_running:200"</span> <span class="attribute">--charset</span>=utf8mb4</span><br></pre></td></tr></table></figure></p>
<p>执行过程：<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_101_centos ~]# pt-online-schema-change --user=root  --password=111111 --socket=/opt/mysql3306/data/mysql.sock  D=test,t=employee1 --alter "ADD COLUMN update_time datetime  DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间';"  --recursion-method=none --no-check-replication-filters --alter-foreign-keys-method auto --print --execute --critical-load="Threads_running:200" --charset=utf8mb4</span><br><span class="line">No slaves found.  See --recursion-method if host VM_24_101_centos has slaves.</span><br><span class="line">Not checking slave lag because no slaves were found and --check-slave-lag was not specified.</span><br><span class="line">Operation, tries, wait:</span><br><span class="line">  analyze_table, 10, <span class="number">1</span></span><br><span class="line">  copy_rows, <span class="number">10</span>, <span class="number">0.25</span></span><br><span class="line">  create_triggers, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  drop_triggers, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  swap_tables, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  update_foreign_keys, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">No foreign <span class="keyword">keys</span> reference <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>; ignoring --alter-foreign-keys-method.</span><br><span class="line">Altering `test`.`employee1`...</span><br><span class="line">Creating new table...</span><br><span class="line"><span class="keyword">CREATE</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> (</span><br><span class="line">  <span class="symbol">`id`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="symbol">`employeeid`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'0'</span>,</span><br><span class="line">  <span class="symbol">`employeename`</span> varchar(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">10001</span> DEFAULT CHARSET=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br><span class="line">Created new table test._employee1_new OK.</span><br><span class="line">Altering new table...</span><br><span class="line"><span class="keyword">ALTER</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> ADD COLUMN update_time datetime  DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">'更新时间'</span>;</span><br><span class="line">Altered `test`.`_employee1_new` OK.</span><br><span class="line">2018-09-21T10:33:08 Creating triggers...</span><br><span class="line">2018-09-21T10:33:08 Created triggers OK.</span><br><span class="line">2018-09-21T10:33:08 Copying approximately 10000 rows...</span><br><span class="line"><span class="keyword">INSERT</span> LOW_PRIORITY <span class="keyword">IGNORE</span> <span class="keyword">INTO</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> (<span class="symbol">`id`</span>, <span class="symbol">`employeeid`</span>, <span class="symbol">`employeename`</span>) <span class="keyword">SELECT</span> <span class="symbol">`id`</span>, <span class="symbol">`employeeid`</span>, <span class="symbol">`employeename`</span> <span class="keyword">FROM</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="symbol">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="symbol">`id`</span> &gt;= ?)) <span class="keyword">AND</span> ((<span class="symbol">`id`</span> &lt;= ?)) LOCK <span class="keyword">IN</span> SHARE MODE <span class="comment">/*pt-online-schema-change 10925 copy nibble*/</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="symbol">`id`</span> <span class="keyword">FROM</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="symbol">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="symbol">`id`</span> &gt;= ?)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="symbol">`id`</span> <span class="keyword">LIMIT</span> ?, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Copied rows OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Analyzing new table...</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Swapping tables...</span><br><span class="line"><span class="keyword">RENAME</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">TO</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span>, <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> <span class="keyword">TO</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Swapped original <span class="keyword">and</span> new tables OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Dropping old table...</span><br><span class="line"><span class="keyword">DROP</span> TABLE <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Dropped old table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span> OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Dropping triggers...</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_del`</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_upd`</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_ins`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">33</span>:<span class="number">08</span> Dropped triggers OK.</span><br><span class="line">Successfully altered <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>.</span><br><span class="line">[root@VM_24_101_centos ~]# mysql test -<span class="built_in">e</span> <span class="string">"show create table employee1\G"</span></span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a <span class="keyword">password</span> <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       Table: employee1</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE <span class="symbol">`employee1`</span> (</span><br><span class="line">  <span class="symbol">`id`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="symbol">`employeeid`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'0'</span>,</span><br><span class="line">  <span class="symbol">`employeename`</span> varchar(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>,</span><br><span class="line">  <span class="symbol">`update_time`</span> datetime DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">'更新时间'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">10001</span> DEFAULT CHARSET=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br><span class="line">[root@VM_24_101_centos ~]# mysql test -<span class="built_in">e</span> <span class="string">"select * from employee1 limit 10"</span></span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a <span class="keyword">password</span> <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">+----+------------+--------------+---------------------+</span><br><span class="line">| id | employeeid | employeename | update_time         |</span><br><span class="line">+----+------------+--------------+---------------------+</span><br><span class="line">|  <span class="number">1</span> |          <span class="number">1</span> | test1        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">2</span> |          <span class="number">2</span> | test2        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">3</span> |          <span class="number">3</span> | test3        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">4</span> |          <span class="number">4</span> | test4        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">5</span> |          <span class="number">5</span> | test5        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">6</span> |          <span class="number">6</span> | test6        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">7</span> |          <span class="number">7</span> | test7        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">8</span> |          <span class="number">8</span> | test8        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">|  <span class="number">9</span> |          <span class="number">9</span> | test9        | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">| <span class="number">10</span> |         <span class="number">10</span> | test10       | <span class="number">2018</span><span class="number">-09</span><span class="number">-21</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">08</span> |</span><br><span class="line">+----+------------+--------------+---------------------+</span><br><span class="line">[root@VM_24_101_centos ~]#</span><br></pre></td></tr></table></figure></p>
<h3 id="删除字段"><a href="#删除字段" class="headerlink" title="删除字段"></a>删除字段</h3><p>删除字段语句：<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-online-schema-change <span class="attribute">--user</span>=root  <span class="attribute">--password</span>=111111 <span class="attribute">--socket</span>=/opt/mysql3306/data/mysql.sock  <span class="attribute">D</span>=test,t=employee1 --alter <span class="string">"DROP COLUMN update_time;"</span>  <span class="attribute">--recursion-method</span>=none --no-check-replication-filters --alter-foreign-keys-method auto --<span class="builtin-name">print</span> --execute <span class="attribute">--critical-load</span>=<span class="string">"Threads_running:200"</span></span><br></pre></td></tr></table></figure></p>
<p>执行过程：<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_101_centos ~]# pt-online-schema-change --user=root  --password=111111 --socket=/opt/mysql3306/data/mysql.sock  D=test,t=employee1 --alter "<span class="keyword">DROP</span> COLUMN update_time;"  --recursion-method=none --no-check-replication-filters --alter-foreign-keys-method auto --print --execute --critical-load="Threads_running:200" </span><br><span class="line">No slaves found.  See --recursion-method if host VM_24_101_centos has slaves.</span><br><span class="line">Not checking slave lag because no slaves were found and --check-slave-lag was not specified.</span><br><span class="line">Operation, tries, wait:</span><br><span class="line">  analyze_table, 10, <span class="number">1</span></span><br><span class="line">  copy_rows, <span class="number">10</span>, <span class="number">0.25</span></span><br><span class="line">  create_triggers, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  drop_triggers, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  swap_tables, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  update_foreign_keys, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">No foreign <span class="keyword">keys</span> reference <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>; ignoring --alter-foreign-keys-method.</span><br><span class="line">Altering `test`.`employee1`...</span><br><span class="line">Creating new table...</span><br><span class="line"><span class="keyword">CREATE</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> (</span><br><span class="line">  <span class="symbol">`id`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="symbol">`employeeid`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'0'</span>,</span><br><span class="line">  <span class="symbol">`employeename`</span> varchar(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>,</span><br><span class="line">  <span class="symbol">`update_time`</span> datetime DEFAULT CURRENT_TIMESTAMP COMMENT <span class="string">'????'</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">10001</span> DEFAULT CHARSET=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br><span class="line">Created new table test._employee1_new OK.</span><br><span class="line">Altering new table...</span><br><span class="line"><span class="keyword">ALTER</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> <span class="keyword">DROP</span> COLUMN update_time;</span><br><span class="line">Altered `test`.`_employee1_new` OK.</span><br><span class="line">2018-09-21T10:36:47 Creating triggers...</span><br><span class="line">2018-09-21T10:36:47 Created triggers OK.</span><br><span class="line">2018-09-21T10:36:47 Copying approximately 10000 rows...</span><br><span class="line"><span class="keyword">INSERT</span> LOW_PRIORITY <span class="keyword">IGNORE</span> <span class="keyword">INTO</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> (<span class="symbol">`id`</span>, <span class="symbol">`employeeid`</span>, <span class="symbol">`employeename`</span>) <span class="keyword">SELECT</span> <span class="symbol">`id`</span>, <span class="symbol">`employeeid`</span>, <span class="symbol">`employeename`</span> <span class="keyword">FROM</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="symbol">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="symbol">`id`</span> &gt;= ?)) <span class="keyword">AND</span> ((<span class="symbol">`id`</span> &lt;= ?)) LOCK <span class="keyword">IN</span> SHARE MODE <span class="comment">/*pt-online-schema-change 11401 copy nibble*/</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="symbol">`id`</span> <span class="keyword">FROM</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="symbol">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="symbol">`id`</span> &gt;= ?)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="symbol">`id`</span> <span class="keyword">LIMIT</span> ?, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Copied rows OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Analyzing new table...</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Swapping tables...</span><br><span class="line"><span class="keyword">RENAME</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">TO</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span>, <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> <span class="keyword">TO</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Swapped original <span class="keyword">and</span> new tables OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Dropping old table...</span><br><span class="line"><span class="keyword">DROP</span> TABLE <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Dropped old table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span> OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Dropping triggers...</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_del`</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_upd`</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_ins`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">36</span>:<span class="number">48</span> Dropped triggers OK.</span><br><span class="line">Successfully altered <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>.</span><br><span class="line">[root@VM_24_101_centos ~]# mysql test -<span class="built_in">e</span> <span class="string">"show create table employee1\G"</span></span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a <span class="keyword">password</span> <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       Table: employee1</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE <span class="symbol">`employee1`</span> (</span><br><span class="line">  <span class="symbol">`id`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="symbol">`employeeid`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'0'</span>,</span><br><span class="line">  <span class="symbol">`employeename`</span> varchar(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">10001</span> DEFAULT CHARSET=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br><span class="line">[root@VM_24_101_centos ~]#</span><br></pre></td></tr></table></figure></p>
<p>此时，需要将–charset=utf8mb4删除，不然会报错：<font color="FF0000">Error creating new table: Wide character in print at /bin/pt-online-schema-change line 10510. </font></p>
<h3 id="改变字段属性"><a href="#改变字段属性" class="headerlink" title="改变字段属性"></a>改变字段属性</h3><p>改变字段属性的语句：<br><figure class="highlight n1ql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_101_centos ~]# pt-online-schema-change --user=root  --password=111111 --socket=/opt/mysql3306/data/mysql.sock  D=test,t=employee1 --alter "MODIFY employeename varchar(300) NOT NULL DEFAULT '';"  --recursion-method=none --no-check-replication-filters --alter-foreign-keys-method auto --print --execute --critical-load="Threads_running:200" --charset=utf8mb4 </span><br><span class="line">No slaves found.  See --recursion-method if host VM_24_101_centos has slaves.</span><br><span class="line">Not checking slave lag because no slaves were found and --check-slave-lag was not specified.</span><br><span class="line">Operation, tries, wait:</span><br><span class="line">  analyze_table, 10, <span class="number">1</span></span><br><span class="line">  copy_rows, <span class="number">10</span>, <span class="number">0.25</span></span><br><span class="line">  create_triggers, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  drop_triggers, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  swap_tables, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">  update_foreign_keys, <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">No foreign <span class="keyword">keys</span> reference <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>; ignoring --alter-foreign-keys-method.</span><br><span class="line">Altering `test`.`employee1`...</span><br><span class="line">Creating new table...</span><br><span class="line"><span class="keyword">CREATE</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> (</span><br><span class="line">  <span class="symbol">`id`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="symbol">`employeeid`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'0'</span>,</span><br><span class="line">  <span class="symbol">`employeename`</span> varchar(<span class="number">64</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">10001</span> DEFAULT CHARSET=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br><span class="line">Created new table test._employee1_new OK.</span><br><span class="line">Altering new table...</span><br><span class="line"><span class="keyword">ALTER</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> MODIFY employeename varchar(<span class="number">300</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>;</span><br><span class="line">Altered `test`.`_employee1_new` OK.</span><br><span class="line">2018-09-21T10:45:34 Creating triggers...</span><br><span class="line">2018-09-21T10:45:34 Created triggers OK.</span><br><span class="line">2018-09-21T10:45:34 Copying approximately 10000 rows...</span><br><span class="line"><span class="keyword">INSERT</span> LOW_PRIORITY <span class="keyword">IGNORE</span> <span class="keyword">INTO</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> (<span class="symbol">`id`</span>, <span class="symbol">`employeeid`</span>, <span class="symbol">`employeename`</span>) <span class="keyword">SELECT</span> <span class="symbol">`id`</span>, <span class="symbol">`employeeid`</span>, <span class="symbol">`employeename`</span> <span class="keyword">FROM</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="symbol">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="symbol">`id`</span> &gt;= ?)) <span class="keyword">AND</span> ((<span class="symbol">`id`</span> &lt;= ?)) LOCK <span class="keyword">IN</span> SHARE MODE <span class="comment">/*pt-online-schema-change 12515 copy nibble*/</span></span><br><span class="line"><span class="keyword">SELECT</span> <span class="comment">/*!40001 SQL_NO_CACHE */</span> <span class="symbol">`id`</span> <span class="keyword">FROM</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">FORCE</span> <span class="keyword">INDEX</span>(<span class="symbol">`PRIMARY`</span>) <span class="keyword">WHERE</span> ((<span class="symbol">`id`</span> &gt;= ?)) <span class="keyword">ORDER</span> <span class="keyword">BY</span> <span class="symbol">`id`</span> <span class="keyword">LIMIT</span> ?, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Copied rows OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Analyzing new table...</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Swapping tables...</span><br><span class="line"><span class="keyword">RENAME</span> TABLE <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span> <span class="keyword">TO</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span>, <span class="symbol">`test`</span>.<span class="symbol">`_employee1_new`</span> <span class="keyword">TO</span> <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Swapped original <span class="keyword">and</span> new tables OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Dropping old table...</span><br><span class="line"><span class="keyword">DROP</span> TABLE <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Dropped old table <span class="symbol">`test`</span>.<span class="symbol">`_employee1_old`</span> OK.</span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Dropping triggers...</span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_del`</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_upd`</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TRIGGER</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="symbol">`test`</span>.<span class="symbol">`pt_osc_test_employee1_ins`</span></span><br><span class="line"><span class="number">2018</span><span class="number">-09</span><span class="number">-21</span>T10:<span class="number">45</span>:<span class="number">34</span> Dropped triggers OK.</span><br><span class="line">Successfully altered <span class="symbol">`test`</span>.<span class="symbol">`employee1`</span>.</span><br><span class="line">[root@VM_24_101_centos ~]# mysql test -<span class="built_in">e</span> <span class="string">"show create table employee1\G"</span></span><br><span class="line">mysql: [Warning] <span class="keyword">Using</span> a <span class="keyword">password</span> <span class="keyword">on</span> the command line interface can be insecure.</span><br><span class="line">*************************** <span class="number">1.</span> row ***************************</span><br><span class="line">       Table: employee1</span><br><span class="line"><span class="keyword">Create</span> Table: <span class="keyword">CREATE</span> TABLE <span class="symbol">`employee1`</span> (</span><br><span class="line">  <span class="symbol">`id`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="symbol">`employeeid`</span> int(<span class="number">10</span>) unsigned <span class="keyword">NOT</span> <span class="literal">NULL</span> COMMENT <span class="string">'0'</span>,</span><br><span class="line">  <span class="symbol">`employeename`</span> varchar(<span class="number">300</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> DEFAULT <span class="string">''</span>,</span><br><span class="line">  <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="symbol">`id`</span>)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=<span class="number">10001</span> DEFAULT CHARSET=utf8mb4 <span class="keyword">COLLATE</span>=utf8mb4_0900_ai_ci</span><br></pre></td></tr></table></figure></p>
<h3 id="非分区表改为分区表"><a href="#非分区表改为分区表" class="headerlink" title="非分区表改为分区表"></a>非分区表改为分区表</h3><p>1.将原表的id自增改为非自增，使用mysql online ddl，不锁表的方式<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql test -e "<span class="keyword">alter</span> <span class="keyword">table</span> employee1 <span class="keyword">modify</span> <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">unsigned</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,algorithm=inplace,<span class="keyword">lock</span>=<span class="keyword">none</span>;"</span><br></pre></td></tr></table></figure></p>
<p>2.删除分区字段内的空值，省略</p>
<p>3.删除原主键，添加联合主键<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql test -e "<span class="keyword">alter</span> <span class="keyword">table</span> employee1 <span class="keyword">drop</span> primary <span class="keyword">key</span>,<span class="keyword">ADD</span> PRIMARY <span class="keyword">KEY</span> (update_time,<span class="keyword">id</span>),algorithm=inplace,<span class="keyword">lock</span>=<span class="keyword">none</span>;"</span><br></pre></td></tr></table></figure></p>
<p>4.使用pt-online-schema-change建分区<br><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pt-online-schema-change <span class="attribute">--user</span>=root  <span class="attribute">--password</span>=111111 <span class="attribute">--socket</span>=/opt/mysql3306/data/mysql.sock  <span class="attribute">D</span>=test,t=employee1 --alter <span class="string">"partition by RANGE COLUMNS (update_time)(PARTITION P202003 VALUES LESS THAN ('2020-04-01'),PARTITION P202004 VALUES LESS THAN ('2020-05-01'),PARTITION P202005 VALUES LESS THAN ('2020-06-01'), PARTITION PMAX VALUES LESS THAN  MAXVALUE  ) "</span>  <span class="attribute">--recursion-method</span>=none --no-check-replication-filters --alter-foreign-keys-method auto --<span class="builtin-name">print</span> --execute <span class="attribute">--critical-load</span>=<span class="string">"Threads_running:200"</span></span><br></pre></td></tr></table></figure></p>
<p>5.以下为执行日志：<br><figure class="highlight autohotkey"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">[root@VM_24_101_centos ~]# mysql test -e <span class="string">"alter table employee1 modify id int(10) unsigned NOT NULL,algorithm=inplace,lock=none;"</span></span><br><span class="line"><span class="symbol">mysql:</span> [Warning] Using <span class="literal">a</span> password on the command line interface can be insecure.</span><br><span class="line">[root@VM_24_101_centos ~]# mysql test -e <span class="string">"alter table employee1 drop primary key,ADD PRIMARY KEY (update_time,id),algorithm=inplace,lock=none;"</span></span><br><span class="line"><span class="symbol">mysql:</span> [Warning] Using <span class="literal">a</span> password on the command line interface can be insecure.</span><br><span class="line">[root@VM_24_101_centos ~]# mysql test -e <span class="string">"show create table employee1\G"</span></span><br><span class="line"><span class="symbol">mysql:</span> [Warning] Using <span class="literal">a</span> password on the command line interface can be insecure.</span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line"><span class="symbol">       Table:</span> employee1</span><br><span class="line"><span class="symbol">Create Table:</span> CREATE TABLE `employee1` (</span><br><span class="line">  `id` int(<span class="number">10</span>) unsigned <span class="literal">NOT</span> NULL,</span><br><span class="line">  `employeeid` int(<span class="number">10</span>) unsigned <span class="literal">NOT</span> NULL COMMENT '<span class="number">0</span>',</span><br><span class="line">  `employeename` varchar(<span class="number">300</span>) <span class="literal">NOT</span> NULL DEFAULT '',</span><br><span class="line">  `update_time` datetime <span class="literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',</span><br><span class="line">  PRIMARY KEY (`update_time`,`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci</span><br><span class="line">[root@VM_24_101_centos ~]# pt-online-schema-change --user=root  --password=<span class="number">111111</span> --socket=/opt/mysql3306/data/mysql.sock  D=test,t=employee1 --alter <span class="string">"partition by RANGE COLUMNS (update_time)(PARTITION P202003 VALUES LESS THAN ('2020-04-01'),PARTITION P202004 VALUES LESS THAN ('2020-05-01'),PARTITION P202005 VALUES LESS THAN ('2020-06-01'), PARTITION PMAX VALUES LESS THAN  MAXVALUE  ) "</span>  --recursion-method=none --no-check-replication-filters --alter-foreign-keys-method auto --print --execute --<span class="keyword">critical</span>-load=<span class="string">"Threads_running:200"</span> --charset=utf8mb4</span><br><span class="line">No slaves found.  See --recursion-method if host VM_24_101_centos has slaves.</span><br><span class="line"><span class="literal">Not</span> checking slave lag because no slaves were found <span class="literal">and</span> --check-slave-lag was <span class="literal">not</span> specified.</span><br><span class="line"><span class="built_in">Operation,</span> tries, wait:</span><br><span class="line"><span class="built_in">  analyze_table,</span> <span class="number">10</span>, <span class="number">1</span></span><br><span class="line"><span class="built_in">  copy_rows,</span> <span class="number">10</span>, <span class="number">0.25</span></span><br><span class="line"><span class="built_in">  create_triggers,</span> <span class="number">10</span>, <span class="number">1</span></span><br><span class="line"><span class="built_in">  drop_triggers,</span> <span class="number">10</span>, <span class="number">1</span></span><br><span class="line"><span class="built_in">  swap_tables,</span> <span class="number">10</span>, <span class="number">1</span></span><br><span class="line"><span class="built_in">  update_foreign_keys,</span> <span class="number">10</span>, <span class="number">1</span></span><br><span class="line">No foreign keys reference `test`.`employee1`; ignoring --alter-foreign-keys-method.</span><br><span class="line">Altering `test`.`employee1`...</span><br><span class="line">Creating <span class="keyword">new</span> table...</span><br><span class="line">CREATE TABLE `test`.`_employee1_new` (</span><br><span class="line">  `id` int(<span class="number">10</span>) unsigned <span class="literal">NOT</span> NULL,</span><br><span class="line">  `employeeid` int(<span class="number">10</span>) unsigned <span class="literal">NOT</span> NULL COMMENT '<span class="number">0</span>',</span><br><span class="line">  `employeename` varchar(<span class="number">300</span>) <span class="literal">NOT</span> NULL DEFAULT '',</span><br><span class="line">  `update_time` datetime <span class="literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',</span><br><span class="line">  PRIMARY KEY (`update_time`,`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci</span><br><span class="line">Created <span class="keyword">new</span> table test._employee1_new OK.</span><br><span class="line">Altering <span class="keyword">new</span> table...</span><br><span class="line">ALTER TABLE `test`.`_employee1_new` partition by RANGE COLUMNS (update_time)(PARTITION P202003 VALUES LESS THAN ('<span class="number">2020</span>-<span class="number">04</span>-<span class="number">01</span>'),PARTITION P202004 VALUES LESS THAN ('<span class="number">2020</span>-<span class="number">05</span>-<span class="number">01</span>'),PARTITION P202005 VALUES LESS THAN ('<span class="number">2020</span>-<span class="number">06</span>-<span class="number">01</span>'), PARTITION PMAX VALUES LESS THAN  MAXVALUE  ) </span><br><span class="line">Altered `test`.`_employee1_new` OK.</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">14</span> Creating triggers...</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">14</span> Created triggers OK.</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">14</span> Copying approximately <span class="number">10000</span> rows...</span><br><span class="line">INSERT LOW_PRIORITY IGNORE INTO `test`.`_employee1_new` (`id`, `employeeid`, `employeename`, `update_time`) SELECT `id`, `employeeid`, `employeename`, `update_time` FROM `test`.`employee1` FORCE INDEX(`PRIMARY`) WHERE ((`update_time` &gt; ?) <span class="literal">OR</span> (`update_time` = ? <span class="literal">AND</span> `id` &gt;= ?)) <span class="literal">AND</span> ((`update_time` &lt; ?) <span class="literal">OR</span> (`update_time` = ? <span class="literal">AND</span> `id` &lt;= ?)) LOCK IN SHARE MODE <span class="comment">/*pt-online-schema-change 16863 copy nibble*/</span></span><br><span class="line">SELECT <span class="comment">/*!40001 SQL_NO_CACHE */</span> `update_time`, `update_time`, `id` FROM `test`.`employee1` FORCE INDEX(`PRIMARY`) WHERE ((`update_time` &gt; ?) <span class="literal">OR</span> (`update_time` = ? <span class="literal">AND</span> `id` &gt;= ?)) ORDER BY `update_time`, `id` LIMIT ?, <span class="number">2</span> <span class="comment">/*next chunk boundary*/</span></span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Copied rows OK.</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Analyzing <span class="keyword">new</span> table...</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Swapping tables...</span><br><span class="line">RENAME TABLE `test`.`employee1` TO `test`.`_employee1_old`, `test`.`_employee1_new` TO `test`.`employee1`</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Swapped original <span class="literal">and</span> <span class="keyword">new</span> tables OK.</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Dropping old table...</span><br><span class="line">DROP TABLE IF EXISTS `test`.`_employee1_old`</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Dropped old table `test`.`_employee1_old` OK.</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Dropping triggers...</span><br><span class="line">DROP TRIGGER IF EXISTS `test`.`pt_osc_test_employee1_del`</span><br><span class="line">DROP TRIGGER IF EXISTS `test`.`pt_osc_test_employee1_upd`</span><br><span class="line">DROP TRIGGER IF EXISTS `test`.`pt_osc_test_employee1_ins`</span><br><span class="line"><span class="number">2018</span>-<span class="number">09</span>-<span class="number">21</span>T11:<span class="number">19</span>:<span class="number">15</span> Dropped triggers OK.</span><br><span class="line">Successfully altered `test`.`employee1`.</span><br><span class="line">[root@VM_24_101_centos ~]# mysql test -e <span class="string">"show create table employee1\G"</span></span><br><span class="line"><span class="symbol">mysql:</span> [Warning] Using <span class="literal">a</span> password on the command line interface can be insecure.</span><br><span class="line">*************************** <span class="number">1</span>. row ***************************</span><br><span class="line"><span class="symbol">       Table:</span> employee1</span><br><span class="line"><span class="symbol">Create Table:</span> CREATE TABLE `employee1` (</span><br><span class="line">  `id` int(<span class="number">10</span>) unsigned <span class="literal">NOT</span> NULL,</span><br><span class="line">  `employeeid` int(<span class="number">10</span>) unsigned <span class="literal">NOT</span> NULL COMMENT '<span class="number">0</span>',</span><br><span class="line">  `employeename` varchar(<span class="number">300</span>) <span class="literal">NOT</span> NULL DEFAULT '',</span><br><span class="line">  `update_time` datetime <span class="literal">NOT</span> NULL DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',</span><br><span class="line">  PRIMARY KEY (`update_time`,`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci</span><br><span class="line"><span class="comment">/*!50500 PARTITION BY RANGE  COLUMNS(update_time)</span></span><br><span class="line"><span class="comment">(PARTITION P202003 VALUES LESS THAN ('2020-04-01') ENGINE = InnoDB,</span></span><br><span class="line"><span class="comment"> PARTITION P202004 VALUES LESS THAN ('2020-05-01') ENGINE = InnoDB,</span></span><br><span class="line"><span class="comment"> PARTITION P202005 VALUES LESS THAN ('2020-06-01') ENGINE = InnoDB,</span></span><br><span class="line"><span class="comment"> PARTITION PMAX VALUES LESS THAN (MAXVALUE) ENGINE = InnoDB) */</span></span><br><span class="line">[root@VM_24_101_centos ~]#</span><br></pre></td></tr></table></figure></p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><h3 id="慎用参数–set-vars-’sql-log-bin-0’"><a href="#慎用参数–set-vars-’sql-log-bin-0’" class="headerlink" title="慎用参数–set-vars=’sql_log_bin=0’"></a>慎用参数–set-vars=’sql_log_bin=0’</h3><p>生产环境，当表中数据量过大，如果遇到添加索引的需求，部分人可能会采用分别在主库和从库加索引的方式，当在主库添加索引的时候，使用了–set-vars=’sql_log_bin=0’参数，可能会导致主从中断。</p>
<p><font color="FF0000">原因：</font><br><br>因为 –set-vars=’sql_log_bin=0’的原因，创建表的DDL语句，无法通过binlog在从库建表，所以临时表主库存在，从库不存在。<br><br>由于增量数据通过触发器将对原表的操作同步到临时表中，此时，对原表的操作会产生binlog，从库在应用此部分的binlog时会报错，提示表不存在。</p>
<p>建议：<br><br>低峰期在主库执行，不要使用参数–set-vars=’sql_log_bin=0’。</p>
<h3 id="谨慎在从库执行-ROW格式"><a href="#谨慎在从库执行-ROW格式" class="headerlink" title="谨慎在从库执行(ROW格式)"></a>谨慎在从库执行(ROW格式)</h3><p>对于生产大表加字段，有种方式是：先在从库加字段，主从切换，再在原主上加字段，可能有效的减小加字段对生产的影响。但是，当复制格式为ROW时，可能会出现复制中断的情况。</p>
<p><font color="FF0000">原因：</font><br><br>当使用pt-online-schema-change在从库执行时，会先创建临时表，在临时表上做DDL变更，然后，通过创建触发器的方式同步增量数据。由于从库同步是应用主库的binlog，从库创建的触发器就不会产生效果，增量数据也就不会同步到临时表，最后在做了临时表和原表的原子重命名后，会丢失数据，复制就会报1032错误，找不到行记录，复制中断。</p>
<p>建议：<br><br>低峰期在主库执行，不要在从库执行。</p>
<h3 id="自增锁"><a href="#自增锁" class="headerlink" title="自增锁"></a>自增锁</h3><p>模拟一种场景：<br><br>1.创建测试表，创建测试临时表，同时在原表上创建更新的触发器，模拟pt-online-schema-change，由于是人工模拟，在触发器中添加了sleep(5)。<br><br>分别在session1更新，session2执行insert low_priority ignore into(session1执行后的5s内执行)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> t1 (<span class="keyword">id</span> <span class="built_in">int</span> auto_increment primary <span class="keyword">key</span>,<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">10</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="literal">null</span>,<span class="string">'A1'</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="literal">null</span>,<span class="string">'B2'</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="literal">null</span>,<span class="string">'C3'</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="literal">null</span>,<span class="string">'D4'</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> t1 <span class="keyword">select</span> <span class="literal">null</span>,<span class="string">'E5'</span>;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span>  _t1_new <span class="keyword">like</span> t1;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> _t1_new <span class="keyword">engine</span> = <span class="keyword">innodb</span>;</span><br></pre></td></tr></table></figure></p>
<p>2.session1:更新原表<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">update</span> t1 <span class="keyword">set</span> <span class="keyword">name</span> = <span class="string">'DDD4'</span> <span class="keyword">where</span> <span class="keyword">id</span> = <span class="number">4</span>;</span><br></pre></td></tr></table></figure></p>
<p>3.session2:插入数据到临时表(session1执行后的5s内执行)<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">begin</span>;</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">low_priority</span> <span class="keyword">ignore</span> <span class="keyword">into</span> _t1_new(<span class="keyword">id</span>,<span class="keyword">name</span>) <span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> <span class="keyword">id</span> &gt; <span class="number">2</span> <span class="keyword">and</span> <span class="keyword">id</span> &lt;<span class="number">5</span> <span class="keyword">lock</span> <span class="keyword">in</span> <span class="keyword">share</span> <span class="keyword">mode</span>;</span><br></pre></td></tr></table></figure></p>
<p>4.session1出现死锁<br><figure class="highlight subunit"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">ERROR </span>1213 (40001): Deadlock found when trying to get lock; try restarting transaction</span><br></pre></td></tr></table></figure></p>
<p>5.以下为mysql5.7，rc隔离级别的测试案例<br><br>session1:<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:06</span>]&gt; create table t1 (id int auto_increment primary key,name varchar(10));</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:07</span>]&gt; insert into t1 select null,'A1';</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:07</span>]&gt; insert into t1 select null,'B2';</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:07</span>]&gt; insert into t1 select null,'C3';</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:07</span>]&gt; insert into t1 select null,'D4';</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:07</span>]&gt; insert into t1 select null,'E5';</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:07</span>]&gt; create table  <span class="emphasis">_t1_</span>new like t1;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:07</span>]&gt; alter table <span class="emphasis">_t1_</span>new engine = innodb;</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:08</span>]&gt; delimiter //</span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:11</span>]&gt; create trigger  pt<span class="emphasis">_osc_</span>test<span class="emphasis">_t1_</span>upd  after update on test.t1 for  each row  begin  declare x int; set x = sleep(5); delete  IGNORE from  test.<span class="emphasis">_t1_</span>new  where  !(OLD.<span class="code">`id`</span> <span class="xml"><span class="tag">&lt;<span class="name">=</span>&gt;</span></span> NEW.<span class="code">`id`</span>) and  test.<span class="emphasis">_t1_</span>new.id  <span class="xml"><span class="tag">&lt;<span class="name">=</span>&gt;</span></span> OLD.<span class="code">`id`</span>;replace into test.<span class="emphasis">_t1_</span>new  (<span class="code">`id`</span>, <span class="code">`name`</span>)  values  (NEW.<span class="code">`id`</span>, NEW.<span class="code">`name`</span>);END//</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:11</span>]&gt; delimiter ;</span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:16</span>]&gt; select * from t1;</span><br><span class="line">+----+------+</span><br><span class="line">| id | name |</span><br><span class="line">+----+------+</span><br><span class="line">|  1 | A1   |</span><br><span class="line">|  2 | B2   |</span><br><span class="line">|  3 | C3   |</span><br><span class="line">|  4 | D4   |</span><br><span class="line">|  5 | E5   |</span><br><span class="line">+----+------+</span><br><span class="line">5 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:16</span>]&gt; </span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:25</span>]&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:26</span>]&gt; update t1 set name = 'DDD4' where id = 4;</span><br><span class="line">ERROR 1213 (40001): Deadlock found when trying to get lock; try restarting transaction</span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:31</span>]&gt; </span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:34</span>]&gt; show engine innodb status\G</span><br><span class="line"><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">** 1. row **</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span><span class="strong">*****</span></span><br><span class="line">  Type: InnoDB</span><br><span class="line">  Name: </span><br><span class="line">Status: </span><br><span class="line">=====================================</span><br><span class="line">2020-05-28 08:44:38 0x7fa64c23e700 INNODB MONITOR OUTPUT</span><br><span class="line">=====================================</span><br><span class="line">Per second averages calculated from the last 28 seconds</span><br><span class="line">-----------------</span><br><span class="line">BACKGROUND THREAD</span><br><span class="line">-----------------</span><br><span class="line">srv<span class="emphasis">_master_</span>thread loops: 26639 srv<span class="emphasis">_active, 0 srv_</span>shutdown, 395877 srv_idle</span><br><span class="line">srv<span class="emphasis">_master_</span>thread log flush and writes: 422516</span><br><span class="line">----------</span><br><span class="line">SEMAPHORES</span><br><span class="line">----------</span><br><span class="line">OS WAIT ARRAY INFO: reservation count 10330755</span><br><span class="line">OS WAIT ARRAY INFO: signal count 23257527</span><br><span class="line">RW-shared spins 0, rounds 26575782, OS waits 8009821</span><br><span class="line">RW-excl spins 0, rounds 48751926, OS waits 641098</span><br><span class="line">RW-sx spins 299480, rounds 8787074, OS waits 284218</span><br><span class="line">Spin rounds per wait: 26575782.00 RW-shared, 48751926.00 RW-excl, 29.34 RW-sx</span><br><span class="line">------------------------</span><br><span class="line">LATEST DETECTED DEADLOCK</span><br><span class="line">------------------------</span><br><span class="line">2020-05-28 08:44:31 0x7fa64c23e700</span><br><span class="line"><span class="emphasis">***</span> (1) TRANSACTION:</span><br><span class="line">TRANSACTION 4481653631, ACTIVE 1 sec fetching rows</span><br><span class="line">mysql tables in use 2, locked 2</span><br><span class="line">LOCK WAIT 5 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1</span><br><span class="line">MySQL thread id 36589, OS thread handle 140352217921280, query id 207646444 localhost root Sending data</span><br><span class="line">insert low<span class="emphasis">_priority ignore into _</span>t1_new(id,name) select id,name from t1 where id &gt; 2 and id <span class="xml"><span class="tag">&lt;<span class="name">5</span> <span class="attr">lock</span> <span class="attr">in</span> <span class="attr">share</span> <span class="attr">mode</span></span></span></span><br><span class="line"><span class="xml">*** (1) WAITING FOR THIS LOCK TO BE GRANTED:</span></span><br><span class="line"><span class="xml">RECORD LOCKS space id 346 page no 3 n bits 80 index PRIMARY of table `test`.`t1` trx id 4481653631 lock mode S locks rec but not gap waiting</span></span><br><span class="line"><span class="xml">Record lock, heap no 7 PHYSICAL RECORD: n_fields 4; compact format; info bits 0</span></span><br><span class="line"><span class="xml"> 0: len 4; hex 80000004; asc     ;;</span></span><br><span class="line"><span class="xml"> 1: len 6; hex 00010b209b7e; asc      ~;;</span></span><br><span class="line"><span class="xml"> 2: len 7; hex 580004fd7008c3; asc X   p  ;;</span></span><br><span class="line"><span class="xml"> 3: len 4; hex 44444434; asc DDD4;;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">*** (2) TRANSACTION:</span></span><br><span class="line"><span class="xml">TRANSACTION 4481653630, ACTIVE 5 sec setting auto-inc lock, thread declared inside InnoDB 5000</span></span><br><span class="line"><span class="xml">mysql tables in use 2, locked 2</span></span><br><span class="line"><span class="xml">4 lock struct(s), heap size 1136, 1 row lock(s), undo log entries 2</span></span><br><span class="line"><span class="xml">MySQL thread id 36587, OS thread handle 140352218720000, query id 207646446 localhost root update</span></span><br><span class="line"><span class="xml">replace into test._t1_new  (`id`, `name`)  values  (NEW.`id`, NEW.`name`)</span></span><br><span class="line"><span class="xml">*** (2) HOLDS THE LOCK(S):</span></span><br><span class="line"><span class="xml">RECORD LOCKS space id 346 page no 3 n bits 72 index PRIMARY of table `test`.`t1` trx id 4481653630 lock_mode X locks rec but not gap</span></span><br><span class="line"><span class="xml">Record lock, heap no 7 PHYSICAL RECORD: n_fields 4; compact format; info bits 0</span></span><br><span class="line"><span class="xml"> 0: len 4; hex 80000004; asc     ;;</span></span><br><span class="line"><span class="xml"> 1: len 6; hex 00010b209b7e; asc      ~;;</span></span><br><span class="line"><span class="xml"> 2: len 7; hex 580004fd7008c3; asc X   p  ;;</span></span><br><span class="line"><span class="xml"> 3: len 4; hex 44444434; asc DDD4;;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">*** (2) WAITING FOR THIS LOCK TO BE GRANTED:</span></span><br><span class="line"><span class="xml">TABLE LOCK table `test`.`_t1_new` trx id 4481653630 lock mode AUTO-INC waiting</span></span><br><span class="line"><span class="xml">*** WE ROLL BACK TRANSACTION (2)</span></span><br><span class="line"><span class="xml">------------</span></span><br><span class="line"><span class="xml">TRANSACTIONS</span></span><br><span class="line"><span class="xml">------------</span></span><br><span class="line"><span class="xml">Trx id counter 4481653637</span></span><br><span class="line"><span class="xml">Purge done for trx's n:o <span class="tag">&lt; <span class="attr">4481653637</span> <span class="attr">undo</span> <span class="attr">n:o</span> &lt; <span class="attr">0</span> <span class="attr">state:</span> <span class="attr">running</span> <span class="attr">but</span> <span class="attr">idle</span></span></span></span><br><span class="line"><span class="xml">History list length 60</span></span><br><span class="line"><span class="xml">LIST OF TRANSACTIONS FOR EACH SESSION:</span></span><br><span class="line"><span class="xml">---TRANSACTION 421829777725264, not started</span></span><br><span class="line"><span class="xml">0 lock struct(s), heap size 1136, 0 row lock(s)</span></span><br><span class="line"><span class="xml">---TRANSACTION 421829777727088, not started</span></span><br><span class="line"><span class="xml">0 lock struct(s), heap size 1136, 0 row lock(s)</span></span><br><span class="line"><span class="xml">---TRANSACTION 4481653631, ACTIVE 8 sec</span></span><br><span class="line"><span class="xml">6 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 2</span></span><br><span class="line"><span class="xml">MySQL thread id 36589, OS thread handle 140352217921280, query id 207646444 localhost root</span></span><br><span class="line"><span class="xml">--------</span></span><br><span class="line"><span class="xml">FILE I/O</span></span><br><span class="line"><span class="xml">--------</span></span><br><span class="line"><span class="xml">...</span></span><br></pre></td></tr></table></figure></p>
<p>session2:<br><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:29</span>]&gt; begin;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">[<span class="string">root@localhost</span>][<span class="symbol">test</span>][<span class="string">08:44:30</span>]&gt; insert low<span class="emphasis">_priority ignore into _</span>t1_new(id,name) select id,name from t1 where id &gt; 2 and id <span class="xml"><span class="tag">&lt;<span class="name">5</span> <span class="attr">lock</span> <span class="attr">in</span> <span class="attr">share</span> <span class="attr">mode</span>;</span></span></span><br><span class="line"><span class="xml">Query OK, 2 rows affected (1.06 sec)</span></span><br><span class="line"><span class="xml">Records: 2  Duplicates: 0  Warnings: 0</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">[root@localhost][test][08:44:31]&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>分析:<br><br>1.原表更新和触发器触发后的临时表更新在同一事务内，通过查看binlog可以看到<br><br><figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*!50530 SET @@SESSION.PSEUDO_SLAVE_MODE=1*/</span><span class="comment">;</span></span><br><span class="line"><span class="comment">/*!50003 SET @OLD_COMPLETION_TYPE=@@COMPLETION_TYPE,COMPLETION_TYPE=0*/</span><span class="comment">;</span></span><br><span class="line">DELIMITER <span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line"><span class="comment"># at 4</span></span><br><span class="line"><span class="comment">#180920  8:58:06 server id 1  end_log_pos 124 CRC32 0x9dc68bf8 	Start: binlog v 4, server v 8.0.18 created 180920  8:58:06</span></span><br><span class="line"><span class="comment"># Warning: this binlog is either in use or was not closed properly.</span></span><br><span class="line"><span class="keyword">BINLOG </span><span class="string">'</span></span><br><span class="line"><span class="string">ngzPXg8BAAAAeAAAAHwAAAABAAQAOC4wLjE4AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA</span></span><br><span class="line"><span class="string">AAAAAAAAAAAAAAAAAAAAAAAAEwANAAgAAAAABAAEAAAAYAAEGggAAAAICAgCAAAACgoKKioAEjQA</span></span><br><span class="line"><span class="string">CgH4i8ad</span></span><br><span class="line"><span class="string">'/*!*/;</span></span><br><span class="line"><span class="string"># at 124</span></span><br><span class="line"><span class="string">#180920  8:58:06 server id 1  end_log_pos 195 CRC32 0x16f7d4d2 	Previous-GTIDs</span></span><br><span class="line"><span class="string"># 3e5359e7-6ca7-11e8-b856-525400931d92:470870-495654</span></span><br><span class="line"><span class="string"># at 195</span></span><br><span class="line"><span class="string">#180920  8:58:21 server id 1  end_log_pos 274 CRC32 0x5e21ec93 	GTID	last_committed=0	sequence_number=1	rbr_only=yes	original_committed_timestamp=1590627501692250	immediate_commit_timestamp=1590627501692250	transaction_length=474</span></span><br><span class="line"><span class="string">/*!50718 SET TRANSACTION ISOLATION LEVEL READ COMMITTED*//*!*/;</span></span><br><span class="line"><span class="string"># original_commit_timestamp=1590627501692250 (2020-05-28 08:58:21.692250 CST)</span></span><br><span class="line"><span class="string"># immediate_commit_timestamp=1590627501692250 (2020-05-28 08:58:21.692250 CST)</span></span><br><span class="line"><span class="string">/*!80001 SET @@session.original_commit_timestamp=1590627501692250*//*!*/;</span></span><br><span class="line"><span class="string">/*!80014 SET @@session.original_server_version=80018*//*!*/;</span></span><br><span class="line"><span class="string">/*!80014 SET @@session.immediate_server_version=80018*//*!*/;</span></span><br><span class="line"><span class="string">SET @@SESSION.GTID_NEXT= '</span><span class="number">3</span>e5359e7-6ca7-11e8-<span class="keyword">b856-525400931d92:495655'/*!*/;</span></span><br><span class="line"><span class="keyword"># </span><span class="built_in">at</span> <span class="number">274</span></span><br><span class="line"><span class="comment">#180920  8:58:15 server id 1  end_log_pos 358 CRC32 0xedf75521 	Query	thread_id=781	exec_time=0	error_code=0</span></span><br><span class="line">SET TIMESTAMP=<span class="number">1590627495</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line">SET @@session.pseudo_thread_id=<span class="number">781</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line">SET @@session.foreign_key_checks=<span class="number">1</span>, @@session.sql_auto_is_null=<span class="number">0</span>, @@session.unique_checks=<span class="number">1</span>, @@session.autocommit=<span class="number">1</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line">SET @@session.sql_mode=<span class="number">1168113696</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line">SET @@session.auto_increment_increment=<span class="number">1</span>, @@session.auto_increment_offset=<span class="number">1</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line"><span class="comment">/*!\C utf8 */</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line">SET @@session.character_set_client=<span class="number">33</span>,@@session.collation_connection=<span class="number">33</span>,@@session.collation_server=<span class="number">255</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line">SET @@session.lc_time_names=<span class="number">0</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line">SET @@session.collation_database=DEFAULT<span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line"><span class="comment">/*!80011 SET @@session.default_collation_for_utf8mb4=255*/</span><span class="comment">/*!*/</span><span class="comment">;</span></span><br><span class="line"><span class="keyword">BEGIN</span></span><br><span class="line"><span class="keyword">/*!*/;</span></span><br><span class="line"><span class="keyword"># </span><span class="built_in">at</span> <span class="number">358</span></span><br><span class="line"><span class="comment">#180920  8:58:15 server id 1  end_log_pos 422 CRC32 0x3e869251 	Rows_query</span></span><br><span class="line"><span class="comment"># update t1 set name = 'DDD4' where id = 4</span></span><br><span class="line"><span class="comment"># at 422</span></span><br><span class="line"><span class="comment">#180920  8:58:15 server id 1  end_log_pos 478 CRC32 0x6c91a26c 	Table_map: `test`.`t1` mapped to number 287</span></span><br><span class="line"><span class="comment"># at 478</span></span><br><span class="line"><span class="comment">#180920  8:58:15 server id 1  end_log_pos 539 CRC32 0xe153a38c 	Table_map: `test`.`_t1_new` mapped to number 286</span></span><br><span class="line"><span class="comment"># at 539</span></span><br><span class="line"><span class="comment">#180920  8:58:15 server id 1  end_log_pos 593 CRC32 0xa2ff1eed 	Update_rows: table id 287</span></span><br><span class="line"><span class="comment"># at 593</span></span><br><span class="line"><span class="comment">#180920  8:58:15 server id 1  end_log_pos 638 CRC32 0xd6d9a8bf 	Write_rows: table id 286 flags: STMT_END_F</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">BINLOG </span><span class="string">'</span></span><br><span class="line"><span class="string">pwzPXh0BAAAAQAAAAKYBAACAACh1cGRhdGUgdDEgc2V0IG5hbWUgPSAnRERENCcgd2hlcmUgaWQg</span></span><br><span class="line"><span class="string">PSA0UZKGPg==</span></span><br><span class="line"><span class="string">pwzPXhMBAAAAOAAAAN4BAAAAAB8BAAAAAAEABHRlc3QAAnQxAAIDDwIoAAIBAQACA/z/AGyikWw=</span></span><br><span class="line"><span class="string">pwzPXhMBAAAAPQAAABsCAAAAAB4BAAAAAAEABHRlc3QAB190MV9uZXcAAgMPAigAAgEBAAID/P8A</span></span><br><span class="line"><span class="string">jKNT4Q==</span></span><br><span class="line"><span class="string">pwzPXh8BAAAANgAAAFECAAAAAB8BAAAAAAAAAgAC//8ABAAAAAJENAAEAAAABERERDTtHv+i</span></span><br><span class="line"><span class="string">pwzPXh4BAAAALQAAAH4CAAAAAB4BAAAAAAEAAgAC/wAEAAAABERERDS/qNnW</span></span><br><span class="line"><span class="string">'/*!*/;</span></span><br><span class="line"><span class="string">### UPDATE `test`.`t1`</span></span><br><span class="line"><span class="string">### WHERE</span></span><br><span class="line"><span class="string">###   @1=4 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="string">###   @2='</span>D4<span class="string">' /* VARSTRING(40) meta=40 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="string">### SET</span></span><br><span class="line"><span class="string">###   @1=4 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="string">###   @2='</span>DDD4<span class="string">' /* VARSTRING(40) meta=40 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="string">### INSERT INTO `test`.`_t1_new`</span></span><br><span class="line"><span class="string">### SET</span></span><br><span class="line"><span class="string">###   @1=4 /* INT meta=0 nullable=0 is_null=0 */</span></span><br><span class="line"><span class="string">###   @2='</span>DDD4<span class="string">' /* VARSTRING(40) meta=40 nullable=1 is_null=0 */</span></span><br><span class="line"><span class="string"># at 638</span></span><br><span class="line"><span class="string">#180920  8:58:21 server id 1  end_log_pos 669 CRC32 0x4847dd4b 	Xid = 61574</span></span><br><span class="line"><span class="string">COMMIT/*!*/;</span></span><br></pre></td></tr></table></figure></p>
<p>其中，最后面的UPDATE <code>test</code>.<code>t1</code>和INSERT INTO <code>test</code>.<code>_t1_new</code>可以看出来。</p>
<p>2.session1执行update t1 set name = ‘DDD4’ where id = 4;时，对应的show engine innodb status中的TRANSACTION 2<br><br>此时，TRANSACTION 2持有t1表id=4的x锁，由于触发器的原因，t1和_t1_new的更新在同一事务内，等待获取_t1_new表的auto-inc lock，等待的语句为：replace into test._t1_new  (<code>id</code>, <code>name</code>)  values  (NEW.<code>id</code>, NEW.<code>name</code>)<br></p>
<p>3.session2执行insert low_priority ignore into _t1_new(id,name) select id,name from t1 where id &gt; 2 and id &lt;5 lock in share mode;时，对应的show engine innodb status中的TRANSACTION 1<br><br>此时，TRANSACTION 1持有_t1_new的auto-inc lock，等待获取t1的记录锁</p>
<p>4.session1和session2产生了死锁，回滚了TRANSACTION 2</p>
<p><font color="FF0000">注意：</font><br><br>MySQL8.0在上述实验场景中，并不会出现死锁。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>pt-online-schema-change是一个很优秀的在线DDL工具，在gh-ost出现之前，广泛应用于生产。同时，为了更好的使用他提高工作效率，需要了解其应用场景与内部工作原理，避免踩到坑。</p>

      
    </div>
    
    
    

    

    

    
<div>
  
    <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

  
</div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/percona/" rel="tag"># percona</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/MySQL-TimeOut分析.html" rel="next" title="MySQL TimeOut分析">
                <i class="fa fa-chevron-left"></i> MySQL TimeOut分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/gh-ost-使用教程.html" rel="prev" title="gh-ost 使用教程">
                gh-ost 使用教程 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/jiessie.png"
                alt="Jiessie" />
            
              <p class="site-author-name" itemprop="name">Jiessie</p>
              <p class="site-description motion-element" itemprop="description">最怕一生碌碌无为,还说平凡难能可贵！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">14</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">25</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://www.percona.com/" target="_blank" title="Percona">
                      
                        <i class="fa fa-fw fa-globe"></i>Percona</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://mariadb.com/kb/zh-cn/mariadb/" target="_blank" title="MariaDB">
                      
                        <i class="fa fa-fw fa-globe"></i>MariaDB</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysqlserverteam.com/" target="_blank" title="serverteam">
                      
                        <i class="fa fa-fw fa-globe"></i>serverteam</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysqlhighavailability.com/" target="_blank" title="highavailability">
                      
                        <i class="fa fa-fw fa-globe"></i>highavailability</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://mysql.taobao.org/monthly/" target="_blank" title="淘宝月报">
                      
                        <i class="fa fa-fw fa-globe"></i>淘宝月报</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="http://dimitrik.free.fr/blog/" target="_blank" title="dimitrik">
                      
                        <i class="fa fa-fw fa-globe"></i>dimitrik</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#介绍"><span class="nav-number">1.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#原理"><span class="nav-number">2.</span> <span class="nav-text">原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#general-log"><span class="nav-number">2.1.</span> <span class="nav-text">general_log</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#执行过程"><span class="nav-number">2.2.</span> <span class="nav-text">执行过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#时序问题"><span class="nav-number">2.3.</span> <span class="nav-text">时序问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#UPDATE"><span class="nav-number">2.3.1.</span> <span class="nav-text">UPDATE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#INSERT"><span class="nav-number">2.3.2.</span> <span class="nav-text">INSERT</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DELETE"><span class="nav-number">2.3.3.</span> <span class="nav-text">DELETE</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#用法"><span class="nav-number">3.</span> <span class="nav-text">用法</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#风险"><span class="nav-number">4.</span> <span class="nav-text">风险</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#限制"><span class="nav-number">5.</span> <span class="nav-text">限制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参数"><span class="nav-number">6.</span> <span class="nav-text">参数</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#选项"><span class="nav-number">6.1.</span> <span class="nav-text">选项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#DSN选项"><span class="nav-number">6.2.</span> <span class="nav-text">DSN选项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#案例"><span class="nav-number">7.</span> <span class="nav-text">案例</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#创建测试表"><span class="nav-number">7.1.</span> <span class="nav-text">创建测试表</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#查看表信息及创建过程"><span class="nav-number">7.2.</span> <span class="nav-text">查看表信息及创建过程</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#添加字段"><span class="nav-number">7.3.</span> <span class="nav-text">添加字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#删除字段"><span class="nav-number">7.4.</span> <span class="nav-text">删除字段</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#改变字段属性"><span class="nav-number">7.5.</span> <span class="nav-text">改变字段属性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#非分区表改为分区表"><span class="nav-number">7.6.</span> <span class="nav-text">非分区表改为分区表</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注意事项"><span class="nav-number">8.</span> <span class="nav-text">注意事项</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#慎用参数–set-vars-’sql-log-bin-0’"><span class="nav-number">8.1.</span> <span class="nav-text">慎用参数–set-vars=’sql_log_bin=0’</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#谨慎在从库执行-ROW格式"><span class="nav-number">8.2.</span> <span class="nav-text">谨慎在从库执行(ROW格式)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#自增锁"><span class="nav-number">8.3.</span> <span class="nav-text">自增锁</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-number">9.</span> <span class="nav-text">总结</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiessie</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共字</span>
</div>

        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  


  











  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  

  
  
    <script type="text/javascript" src="/lib/canvas-nest/canvas-nest.min.js"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  


<script type="text/javascript" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

</body>
</html>
