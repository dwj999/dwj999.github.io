<!DOCTYPE html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="percona,innodb,recovery," />





  <link rel="alternate" href="/atom.xml" title="Jiessie's' Blog" type="application/atom+xml" />






<meta name="description" content="前言数据是一个企业最重要的资产，备份的重要性不言而喻，有效的备份能够减少意外情况下的公司损失。当使用MySQL数据库时，mysqldump、mysqlpump、mydumper、xtrabackup等都是不错的备份工具，极端情况下，当开启了binlog，也可以成为恢复的救命稻草。但是，还有存在无备份，没有开启binlog的情况，如果是InnoDB表，这时percona推出的Percona Data">
<meta name="keywords" content="percona,innodb,recovery">
<meta property="og:type" content="article">
<meta property="og:title" content="hexo next 使用Percona Data Recovery Tool for InnoDB恢复数据">
<meta property="og:url" content="https://dwj999.github.io/使用Percona-Data-Recovery-Tool-for-InnoDB恢复数据.html">
<meta property="og:site_name" content="Jiessie&#39;s&#39; Blog">
<meta property="og:description" content="前言数据是一个企业最重要的资产，备份的重要性不言而喻，有效的备份能够减少意外情况下的公司损失。当使用MySQL数据库时，mysqldump、mysqlpump、mydumper、xtrabackup等都是不错的备份工具，极端情况下，当开启了binlog，也可以成为恢复的救命稻草。但是，还有存在无备份，没有开启binlog的情况，如果是InnoDB表，这时percona推出的Percona Data">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2020-05-20T03:47:55.682Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="hexo next 使用Percona Data Recovery Tool for InnoDB恢复数据">
<meta name="twitter:description" content="前言数据是一个企业最重要的资产，备份的重要性不言而喻，有效的备份能够减少意外情况下的公司损失。当使用MySQL数据库时，mysqldump、mysqlpump、mydumper、xtrabackup等都是不错的备份工具，极端情况下，当开启了binlog，也可以成为恢复的救命稻草。但是，还有存在无备份，没有开启binlog的情况，如果是InnoDB表，这时percona推出的Percona Data">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://dwj999.github.io/使用Percona-Data-Recovery-Tool-for-InnoDB恢复数据.html"/>





  <title>hexo next 使用Percona Data Recovery Tool for InnoDB恢复数据 | Jiessie's' Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
<a href="https://github.com/you"><img width="149" height="149" src="https://github.blog/wp-content/uploads/2008/12/forkme_right_darkblue_121621.png?resize=149%2C149" class="attachment-full size-full" alt="Fork me on GitHub" data-recalc-dims="1"></a>
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Jiessie's' Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">没伞的孩子必须努力奔跑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://dwj999.github.io/使用Percona-Data-Recovery-Tool-for-InnoDB恢复数据.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Jiessie">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Jiessie's' Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">hexo next 使用Percona Data Recovery Tool for InnoDB恢复数据</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-07-14T14:28:11+08:00">
                2017-07-14
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/备份恢复/" itemprop="url" rel="index">
                    <span itemprop="name">备份恢复</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>数据是一个企业最重要的资产，备份的重要性不言而喻，有效的备份能够减少意外情况下的公司损失。当使用MySQL数据库时，mysqldump、mysqlpump、mydumper、xtrabackup等都是不错的备份工具，极端情况下，当开启了binlog，也可以成为恢复的救命稻草。但是，还有存在无备份，没有开启binlog的情况，如果是InnoDB表，这时percona推出的Percona Data Recovery Tool工具可以派上用场。</p>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">此工具仅支持InnoDB/XtraDB表，不支持MyISAM表</span><br><span class="line">此工具可恢复数据文件的副本，并不要求是正在运行的MySQL服务器</span><br><span class="line">此工具并不保证数据一定可恢复，如数据被覆盖</span><br><span class="line">支持的误操作类型：DELETE、TRUNCATE，表格式为Compact</span><br><span class="line">在文件系统级别删除的文件</span><br><span class="line">如数据文件损失，此工具也无法恢复</span><br></pre></td></tr></table></figure>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>通过尝试在页面中找到有效的行来工作，InnoDB的数据都是索引的方式组织的，所有的数据都是存储在16KB的数据块中，每个页面都有属于特定表的特定索引。恢复时分解所有的数据文件为单个16kb大小的页面，根据每个页面的标记的数据起点开始尝试匹配，如果与给定表定义的属于匹配，则输出匹配记录。</p>
<h2 id="表空间"><a href="#表空间" class="headerlink" title="表空间"></a>表空间</h2><p>当服务器设置了innodb_file_per_table=1时，工具不需要再额外的从ibdata1中拆分数据，所有的数据都保存在ibd文件中。<br>当服务器设置了innodb_file_per_table=0时，工具需要先使用page_parser，把数据文件从ibdata1中拆分出来，再按照规则匹配记录。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>操作系统：centos 6.5 x86_64</p>
<h2 id="安装依赖"><a href="#安装依赖" class="headerlink" title="安装依赖"></a>安装依赖</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum -y install gcc gcc-c++ glibc glibc-static  perl-DBI perl-DBD-MySQL</span><br></pre></td></tr></table></figure>
<h2 id="安装Percona-Data-Recovery-Tool"><a href="#安装Percona-Data-Recovery-Tool" class="headerlink" title="安装Percona Data Recovery Tool"></a>安装Percona Data Recovery Tool</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ ~]# cd /usr/src/</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ src]# wget https://launchpad.net/percona-data-recovery-tool-for-innodb/trunk/release-0.5/+download/percona-data-recovery-tool-for-innodb-0.5.tar.gz --no-check-certificate </span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ src]# tar -zxf percona-data-recovery-tool-for-innodb-0.5.tar.gz </span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ src]# cd percona-data-recovery-tool-for-innodb-0.5/mysql-source/</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ mysql-source]# ./configure </span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ mysql-source]# cd ..</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# make</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ll</span><br><span class="line">总用量 3168</span><br><span class="line">-rw-r--r--  1  510 wheel    6269 8月  28 2011 check_data.c</span><br><span class="line">-rwxr-xr-x  1 root root   748761 7月  17 09:06 constraints_parser</span><br><span class="line">-rw-r--r--  1  510 wheel   22172 8月  28 2011 constraints_parser.c</span><br><span class="line">-rwxr-xr-x  1  510 wheel   12051 8月  28 2011 create_defs.pl</span><br><span class="line">drwxr-xr-x  2  510 wheel    4096 8月  28 2011 docs</span><br><span class="line">-rwxr-xr-x  1  510 wheel    1978 8月  28 2011 fetch_data.sh</span><br><span class="line">-rwxr-xr-x  1 root root   979051 7月  17 09:06 ibdconnect</span><br><span class="line">-rw-r--r--  1  510 wheel   12200 8月  28 2011 ibdconnect.c</span><br><span class="line">drwxr-xr-x  2  510 wheel    4096 8月  28 2011 include</span><br><span class="line">-rw-r--r--  1  510 wheel    8262 8月  28 2011 incrementalupdate.c</span><br><span class="line">-rwxr-xr-x  1 root root    14873 7月  17 09:06 innochecksum</span><br><span class="line">-rw-r--r--  1  510 wheel    9117 8月  28 2011 innochecksum.c</span><br><span class="line">-rw-r--r--  1  510 wheel      74 8月  28 2011 INSTALL</span><br><span class="line">drwxr-xr-x  2 root root     4096 7月  17 09:06 lib</span><br><span class="line">-rw-r--r--  1  510 wheel    2676 8月  28 2011 Makefile</span><br><span class="line">drwxr-xr-x 40  510 wheel    4096 7月  17 09:06 mysql-source</span><br><span class="line">-rwxr-xr-x  1 root root  1346155 7月  17 09:06 page_parser</span><br><span class="line">-rw-r--r--  1  510 wheel   15239 8月  28 2011 page_parser.c</span><br><span class="line">-rw-r--r--  1  510 wheel   10608 8月  28 2011 print_data.c</span><br><span class="line">-rwxr-xr-x  1  510 wheel     302 8月  28 2011 split_dump.pl</span><br><span class="line">-rw-r--r--  1  510 wheel    2046 8月  28 2011 tables_dict.c</span><br></pre></td></tr></table></figure>
<h2 id="恢复实战-delete误操作"><a href="#恢复实战-delete误操作" class="headerlink" title="恢复实战(delete误操作)"></a>恢复实战(delete误操作)</h2><h3 id="innodb-file-per-table-1"><a href="#innodb-file-per-table-1" class="headerlink" title="innodb_file_per_table=1"></a>innodb_file_per_table=1</h3><h4 id="模拟数据被误删除"><a href="#模拟数据被误删除" class="headerlink" title="模拟数据被误删除"></a>模拟数据被误删除</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# mysql -uroot -p123456</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 35514</span><br><span class="line">Server version: 5.6.36-82.0-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 09:25:34 &gt; create database test111;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 09:25:40 &gt; use test111;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [test111] 09:25:43 &gt; create table t222(id int unsigned not null auto_increment,name varchar(20),age int,primary key(`id`),key idx_age(`age`));   </span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:25:51 &gt; insert into t222 values(null,&apos;jiessie&apos;,18);           </span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:26:00 &gt; insert into t222 (name,age) select name,age from t222;     </span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:26:10 &gt; insert into t222 (name,age) select name,age from t222;</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line">Records: 2  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:26:11 &gt; insert into t222 (name,age) select name,age from t222;</span><br><span class="line">Query OK, 4 rows affected (0.00 sec)</span><br><span class="line">Records: 4  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:26:11 &gt; insert into t222 (name,age) select name,age from t222;</span><br><span class="line">Query OK, 8 rows affected (0.00 sec)</span><br><span class="line">Records: 8  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:26:12 &gt; insert into t222 (name,age) select name,age from t222;</span><br><span class="line">Query OK, 16 rows affected (0.00 sec)</span><br><span class="line">Records: 16  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:26:12 &gt; insert into t222 (name,age) select name,age from t222;</span><br><span class="line">Query OK, 32 rows affected (0.00 sec)</span><br><span class="line">Records: 32  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:26:12 &gt; insert into t222 (name,age) select name,age from t222;</span><br><span class="line">Query OK, 64 rows affected (0.00 sec)</span><br><span class="line">Records: 64  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:26:13 &gt; insert into t222 (name,age) select name,age from t222;</span><br><span class="line">Query OK, 128 rows affected (0.01 sec)</span><br><span class="line">Records: 128  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:26:13 &gt; insert into t222 (name,age) select name,age from t222;</span><br><span class="line">Query OK, 256 rows affected (0.00 sec)</span><br><span class="line">Records: 256  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:26:14 &gt; insert into t222 (name,age) select name,age from t222;</span><br><span class="line">Query OK, 512 rows affected (0.01 sec)</span><br><span class="line">Records: 512  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:26:14 &gt; select count(*) from t222;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     1024 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:26:21 &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# mysql -uroot -p123456 test111 -e &quot;delete from t222;select count(*) from t222;&quot; &amp;&amp; cp /hwdata/data/percona/test111/t222.* /tmp/</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|        0 |</span><br><span class="line">+----------+</span><br></pre></td></tr></table></figure>
<h4 id="解析ibd文件"><a href="#解析ibd文件" class="headerlink" title="解析ibd文件"></a>解析ibd文件</h4><p>实战mysql安装在/usr/local/percona，数据目录在/hwdata/data/percona，注意保存数据文件。<br>此过程会将表的idb文件解析为很多的page，innodb的page分为两大部分，一部分一级索引部分（primary key），另一部分为二级索引部分（secondary key），所以解析出来的ibd包括了主键数据和索引数据两大部分（如果该表有多个二级索引，则会生成多个文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ll -t /tmp/t222*</span><br><span class="line">-rw-r----- 1 root root 163840 7月  17 09:26 /tmp/t222.ibd</span><br><span class="line">-rw-r----- 1 root root   8614 7月  17 09:26 /tmp/t222.frm</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ./page_parser -5 -f /tmp/t222.ibd </span><br><span class="line">Opening file: /tmp/t222.ibd:</span><br><span class="line">64513           ID of device containing file</span><br><span class="line">1597422         inode number</span><br><span class="line">33184           protection</span><br><span class="line">1               number of hard links</span><br><span class="line">0               user ID of owner</span><br><span class="line">0               group ID of owner</span><br><span class="line">0               device ID (if special file)</span><br><span class="line">163840          total size, in bytes</span><br><span class="line">4096            blocksize for filesystem I/O</span><br><span class="line">320             number of blocks allocated</span><br><span class="line">1500254806      time of last access</span><br><span class="line">1500254806      time of last modification</span><br><span class="line">1500254806      time of last status change</span><br><span class="line">163840  Size to process in bytes</span><br><span class="line">104857600       Disk cache size in bytes</span><br><span class="line">19.97% done. 2017-07-17 09:27:37 ETA(in 00:00 hours). Processing speed: 32723 B/sec</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ll -t</span><br><span class="line">总用量 3172</span><br><span class="line">drwxr-xr-x  3 root root     4096 7月  17 09:27 pages-1500254852</span><br><span class="line">-rwxr-xr-x  1 root root  1346155 7月  17 09:21 page_parser</span><br><span class="line">-rwxr-xr-x  1 root root   748729 7月  17 09:21 constraints_parser</span><br><span class="line">drwxr-xr-x  2 root root     4096 7月  17 09:21 lib</span><br><span class="line">-rwxr-xr-x  1 root root   979051 7月  17 09:06 ibdconnect</span><br><span class="line">-rwxr-xr-x  1 root root    14873 7月  17 09:06 innochecksum</span><br><span class="line">drwxr-xr-x 40  510 wheel    4096 7月  17 09:06 mysql-source</span><br><span class="line">drwxr-xr-x  2  510 wheel    4096 8月  28 2011 docs</span><br><span class="line">drwxr-xr-x  2  510 wheel    4096 8月  28 2011 include</span><br><span class="line">-rw-r--r--  1  510 wheel    6269 8月  28 2011 check_data.c</span><br><span class="line">-rw-r--r--  1  510 wheel   22172 8月  28 2011 constraints_parser.c</span><br><span class="line">-rwxr-xr-x  1  510 wheel   12051 8月  28 2011 create_defs.pl</span><br><span class="line">-rwxr-xr-x  1  510 wheel    1978 8月  28 2011 fetch_data.sh</span><br><span class="line">-rw-r--r--  1  510 wheel   12200 8月  28 2011 ibdconnect.c</span><br><span class="line">-rw-r--r--  1  510 wheel    8262 8月  28 2011 incrementalupdate.c</span><br><span class="line">-rw-r--r--  1  510 wheel    9117 8月  28 2011 innochecksum.c</span><br><span class="line">-rw-r--r--  1  510 wheel      74 8月  28 2011 INSTALL</span><br><span class="line">-rw-r--r--  1  510 wheel    2676 8月  28 2011 Makefile</span><br><span class="line">-rw-r--r--  1  510 wheel   15239 8月  28 2011 page_parser.c</span><br><span class="line">-rw-r--r--  1  510 wheel   10608 8月  28 2011 print_data.c</span><br><span class="line">-rwxr-xr-x  1  510 wheel     302 8月  28 2011 split_dump.pl</span><br><span class="line">-rw-r--r--  1  510 wheel    2046 8月  28 2011 tables_dict.c</span><br></pre></td></tr></table></figure></p>
<p>参数解释：<br>-5：代表 row format为Compact mysql5.0后的版本，-4 代表mysql5.0前版本<br>-f：代表要解析的文件 </p>
<h4 id="结果分析"><a href="#结果分析" class="headerlink" title="结果分析"></a>结果分析</h4><p>从下面的解析后的结果看到，当前目录多了pages-1500254852，其中39为主键索引的index_id,40为二级索引的index_id,该id可以通过开启innodb_table_monitor查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ll pages-1500254852/FIL_PAGE_INDEX/0-*</span><br><span class="line">pages-1500254852/FIL_PAGE_INDEX/0-39:</span><br><span class="line">总用量 64</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 09:27 0-00000003.page</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 09:27 2-00000005.page</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 09:27 3-00000006.page</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 09:27 4-00000007.page</span><br><span class="line"></span><br><span class="line">pages-1500254852/FIL_PAGE_INDEX/0-40:</span><br><span class="line">总用量 16</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 09:27 1-00000004.page</span><br></pre></td></tr></table></figure></p>
<h4 id="生成表定义"><a href="#生成表定义" class="headerlink" title="生成表定义"></a>生成表定义</h4><p>由于该工具在解析数据pages的时候，需要获得该table的表结构定义，所以需要执行如下命令。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ./create_defs.pl --host localhost --user root --password 123456 --db test111 --table t222 &gt; include/table_defs.h</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# cat include/table_defs.h</span><br><span class="line">#ifndef table_defs_h</span><br><span class="line">#define table_defs_h</span><br><span class="line"></span><br><span class="line">// Table definitions</span><br><span class="line">table_def_t table_definitions[] = &#123;</span><br><span class="line">        &#123;</span><br><span class="line">                name: &quot;t222&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &#123; /* int(10) unsigned */</span><br><span class="line">                                name: &quot;id&quot;,</span><br><span class="line">                                type: FT_UINT,</span><br><span class="line">                                fixed_length: 4,</span><br><span class="line"></span><br><span class="line">                                has_limits: FALSE,</span><br><span class="line">                                limits: &#123;</span><br><span class="line">                                        can_be_null: FALSE,</span><br><span class="line">                                        uint_min_val: 0,</span><br><span class="line">                                        uint_max_val: 4294967295ULL</span><br><span class="line">                                &#125;,</span><br><span class="line"></span><br><span class="line">                                can_be_null: FALSE</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123; /*  */</span><br><span class="line">                                name: &quot;DB_TRX_ID&quot;,</span><br><span class="line">                                type: FT_INTERNAL,</span><br><span class="line">                                fixed_length: 6,</span><br><span class="line"></span><br><span class="line">                                can_be_null: FALSE</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123; /*  */</span><br><span class="line">                                name: &quot;DB_ROLL_PTR&quot;,</span><br><span class="line">                                type: FT_INTERNAL,</span><br><span class="line">                                fixed_length: 7,</span><br><span class="line"></span><br><span class="line">                                can_be_null: FALSE</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123; /* varchar(20) */</span><br><span class="line">                                name: &quot;name&quot;,</span><br><span class="line">                                type: FT_CHAR,</span><br><span class="line">                                min_length: 0,</span><br><span class="line">                                max_length: 60,</span><br><span class="line"></span><br><span class="line">                                has_limits: FALSE,</span><br><span class="line">                                limits: &#123;</span><br><span class="line">                                        can_be_null: TRUE,</span><br><span class="line">                                        char_min_len: 0,</span><br><span class="line">                                        char_max_len: 60,</span><br><span class="line">                                        char_ascii_only: TRUE</span><br><span class="line">                                &#125;,</span><br><span class="line"></span><br><span class="line">                                can_be_null: TRUE</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123; /* int(11) */</span><br><span class="line">                                name: &quot;age&quot;,</span><br><span class="line">                                type: FT_INT,</span><br><span class="line">                                fixed_length: 4,</span><br><span class="line"></span><br><span class="line">                                has_limits: FALSE,</span><br><span class="line">                                limits: &#123;</span><br><span class="line">                                        can_be_null: TRUE,</span><br><span class="line">                                        int_min_val: -2147483648LL,</span><br><span class="line">                                        int_max_val: 2147483647LL</span><br><span class="line">                                &#125;,</span><br><span class="line"></span><br><span class="line">                                can_be_null: TRUE</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123; type: FT_NONE &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#endif</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# </span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# make</span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -c tables_dict.c -o lib/tables_dict.o</span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -c check_data.c -o lib/check_data.o</span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -o constraints_parser constraints_parser.c lib/tables_dict.o lib/print_data.o lib/check_data.o lib/libut.a lib/libmystrings.a</span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -static -lrt -o page_parser page_parser.c lib/tables_dict.o lib/libut.a </span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# make</span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -c tables_dict.c -o lib/tables_dict.o</span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -c print_data.c -o lib/print_data.o </span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -o constraints_parser constraints_parser.c lib/tables_dict.o lib/print_data.o lib/check_data.o lib/libut.a lib/libmystrings.a</span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -static -lrt -o page_parser page_parser.c lib/tables_dict.o lib/libut.a</span><br></pre></td></tr></table></figure></p>
<p>上面的命令会将t222表的表定义传入到table_defs.h中，在生成了表结构定义后，重新make该恢复工具  </p>
<p><font color="#dd0000">注意：需要make 2次</font><br> </p>
<h4 id="开始提取page中删除的数据"><a href="#开始提取page中删除的数据" class="headerlink" title="开始提取page中删除的数据"></a>开始提取page中删除的数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ./constraints_parser -5 -f pages-1500254852/FIL_PAGE_INDEX/0-39/ &gt; /tmp/t222.sql</span><br><span class="line">LOAD DATA INFILE &apos;/usr/src/percona-data-recovery-tool-for-innodb-0.5/dumps/default/t222&apos; REPLACE INTO TABLE `t222` FIELDS TERMINATED BY &apos;\t&apos; OPTIONALLY ENCLOSED BY &apos;&quot;&apos; LINES STARTING BY &apos;t222\t&apos; (id, name, age);</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# cat /tmp/t222.sql |wc -l</span><br><span class="line">1024</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# head -10 /tmp/t222.sql </span><br><span class="line">t222    1       &quot;jiessie&quot;       18</span><br><span class="line">t222    2       &quot;jiessie&quot;       18</span><br><span class="line">t222    3       &quot;jiessie&quot;       18</span><br><span class="line">t222    4       &quot;jiessie&quot;       18</span><br><span class="line">t222    6       &quot;jiessie&quot;       18</span><br><span class="line">t222    7       &quot;jiessie&quot;       18</span><br><span class="line">t222    8       &quot;jiessie&quot;       18</span><br><span class="line">t222    9       &quot;jiessie&quot;       18</span><br><span class="line">t222    13      &quot;jiessie&quot;       18</span><br><span class="line">t222    14      &quot;jiessie&quot;       18</span><br></pre></td></tr></table></figure>
<p>参数解释：<br>-5 -f的参数和page_parser相同，代表 row format为Compact ；<br>-D:该参数的含义为代表恢复删除的数据页； </p>
<h4 id="恢复数据"><a href="#恢复数据" class="headerlink" title="恢复数据"></a>恢复数据</h4><p>使用上面constraints_parser执行后的load data导入数据，需要注意目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# mysql -uroot -p123456 </span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 35598</span><br><span class="line">Server version: 5.6.36-82.0-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 09:32:33 &gt; use test111;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [test111] 09:32:35 &gt; LOAD DATA INFILE &apos;/tmp/t222.sql&apos; REPLACE INTO TABLE `t222` FIELDS TERMINATED BY &apos;\t&apos; OPTIONALLY ENCLOSED BY &apos;&quot;&apos; LINES STARTING BY &apos;t222\t&apos; (id, name, age);</span><br><span class="line">Query OK, 1024 rows affected (0.00 sec)</span><br><span class="line">Records: 1024  Deleted: 0  Skipped: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:32:53 &gt; select count(*) from t222;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     1024 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:32:59 &gt; select * from t222 limit 10;</span><br><span class="line">+----+---------+------+</span><br><span class="line">| id | name    | age  |</span><br><span class="line">+----+---------+------+</span><br><span class="line">|  1 | jiessie |   18 |</span><br><span class="line">|  2 | jiessie |   18 |</span><br><span class="line">|  3 | jiessie |   18 |</span><br><span class="line">|  4 | jiessie |   18 |</span><br><span class="line">|  6 | jiessie |   18 |</span><br><span class="line">|  7 | jiessie |   18 |</span><br><span class="line">|  8 | jiessie |   18 |</span><br><span class="line">|  9 | jiessie |   18 |</span><br><span class="line">| 13 | jiessie |   18 |</span><br><span class="line">| 14 | jiessie |   18 |</span><br><span class="line">+----+---------+------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>查看数据，数据恢复成功。从实验来看，当delete误操作，第一时间要保护好ibd数据，拷贝到其他目录。</p>
<h4 id="恢复脚本"><a href="#恢复脚本" class="headerlink" title="恢复脚本"></a>恢复脚本</h4><p>当误操作的数据量大时，constraints_parser恢复是单线程，速度较慢，此处引用了2个恢复脚本<br>详情请参考：<a href="http://www.orczhou.com/index.php/2013/07/how-to-recover-data-from-mysql-innodb-data-file-ibd-file/" target="_blank" rel="noopener">http://www.orczhou.com/index.php/2013/07/how-to-recover-data-from-mysql-innodb-data-file-ibd-file/</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# pwd</span><br><span class="line">/usr/src/percona-data-recovery-tool-for-innodb-0.5</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# cat parallel_exec.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">ws=/usr/src/percona-data-recovery-tool-for-innodb-0.5/</span><br><span class="line">pagedir=/usr/src/percona-data-recovery-tool-for-innodb-0.5/pages-1500255306/FIL_PAGE_INDEX</span><br><span class="line">logdir=/usr/src/percona-data-recovery-tool-for-innodb-0.5/log</span><br><span class="line">rectool=/usr/src/percona-data-recovery-tool-for-innodb-0.5/constraints_parser</span><br><span class="line">cd `dirname $rectool`</span><br><span class="line">count=0</span><br><span class="line">page_count=353894</span><br><span class="line">page_done=0</span><br><span class="line">startdate=`date +%s`</span><br><span class="line">for d1 in `ls $pagedir`</span><br><span class="line">do</span><br><span class="line">  count=$(($count+1))</span><br><span class="line">  echo &quot;in page $d2 at dir $d1&quot; &gt; $logdir/$count.log</span><br><span class="line">  thedate=`date +%s`</span><br><span class="line">  echo &quot;$page_done / $page_count at $thedate from $startdate&quot;</span><br><span class="line">  total=`ls -l $pagedir/$d1/|wc -l`</span><br><span class="line">  page_done=$(($page_done+$total))</span><br><span class="line">  threads=`ps axu|grep parser_jobs|grep -v grep|wc -l`</span><br><span class="line">  echo $threads</span><br><span class="line">  while [ $threads -gt 48 ];</span><br><span class="line">  do</span><br><span class="line">    sleep 1</span><br><span class="line">    threads=`ps axu|grep parser_jobs|grep -v grep|wc -l`</span><br><span class="line">  done</span><br><span class="line">  $ws/parser_jobs.sh $pagedir/$d1 &gt; $ws/job.log 2&gt;&amp;1 &amp;</span><br><span class="line">done</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# cat parser_jobs.sh </span><br><span class="line">#!/bin/bash</span><br><span class="line">pagedir=/usr/src/percona-data-recovery-tool-for-innodb-0.5/pages-1500255306/FIL_PAGE_INDEX</span><br><span class="line">logdir=/usr/src/percona-data-recovery-tool-for-innodb-0.5/log</span><br><span class="line">rectool=/usr/src/percona-data-recovery-tool-for-innodb-0.5/constraints_parser</span><br><span class="line">logfile=&quot;$logdir/`basename $1`.log&quot;</span><br><span class="line">echo &quot;$1&quot; &gt; $logfile</span><br><span class="line">if [ -d $1 ];then</span><br><span class="line">  for d2 in `ls $1`</span><br><span class="line">  do</span><br><span class="line">    $rectool -5 -f $1/$d2 &gt;&gt; $logfile 2&gt;/dev/null</span><br><span class="line">  done</span><br><span class="line">fi</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ./parallel_exec.sh </span><br><span class="line">0 / 353894 at 1500255771 from 1500255771</span><br><span class="line">0</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ll log/</span><br><span class="line">总用量 296</span><br><span class="line">-rw-r--r-- 1 root root 296770 7月  17 09:42 0-41.log</span><br><span class="line">-rw-r--r-- 1 root root     21 7月  17 09:42 1.log</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# cat log/0-41.log |wc -l</span><br><span class="line">10001</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# head -10 log/0-41.log </span><br><span class="line">/usr/src/percona-data-recovery-tool-for-innodb-0.5/pages-1500255306/FIL_PAGE_INDEX/0-41</span><br><span class="line">employee        3670    3670    &quot;test3670&quot;</span><br><span class="line">employee        3671    3671    &quot;test3671&quot;</span><br><span class="line">employee        3672    3672    &quot;test3672&quot;</span><br><span class="line">employee        3673    3673    &quot;test3673&quot;</span><br><span class="line">employee        3674    3674    &quot;test3674&quot;</span><br><span class="line">employee        3675    3675    &quot;test3675&quot;</span><br><span class="line">employee        3676    3676    &quot;test3676&quot;</span><br><span class="line">employee        3677    3677    &quot;test3677&quot;</span><br><span class="line">employee        3678    3678    &quot;test3678&quot;</span><br></pre></td></tr></table></figure></p>
<p>用法：<br>1.修改脚本路<br>2.修改page_parser后的pages目录<br>3.创建log目录<br>4.执行parallel_exec脚本<br>5.注意，上面演示的示例，0-41.log中在第一行多了一句待恢复innodb页的路径，实际恢复中应删除  </p>
<h3 id="innodb-file-per-table-0"><a href="#innodb-file-per-table-0" class="headerlink" title="innodb_file_per_table=0"></a>innodb_file_per_table=0</h3><h4 id="模拟数据被误删除-1"><a href="#模拟数据被误删除-1" class="headerlink" title="模拟数据被误删除"></a>模拟数据被误删除</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# mysql -uroot -p123456 -e &quot;show variables like &apos;innodb_file_per_table&apos;&quot;</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| Variable_name         | Value |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| innodb_file_per_table | OFF   |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# mysql -uroot -p123456</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 9</span><br><span class="line">Server version: 5.6.36-82.0-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 09:58:22 &gt; create database test111;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 09:58:31 &gt; use test111;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [test111] 09:58:34 &gt; create table t222(id int unsigned not null auto_increment,name varchar(20),age int,primary key(`id`),key idx_age(`age`)); </span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:58:52 &gt; insert into t222 values(null,&apos;jiessie&apos;,18);   </span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:58:57 &gt; insert into t222 (name,age) select name,age from t222;   </span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">Records: 1  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:59:02 &gt; insert into t222 (name,age) select name,age from t222;   </span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line">Records: 2  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:59:03 &gt; insert into t222 (name,age) select name,age from t222;   </span><br><span class="line">Query OK, 4 rows affected (0.00 sec)</span><br><span class="line">Records: 4  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:59:04 &gt; insert into t222 (name,age) select name,age from t222;   </span><br><span class="line">Query OK, 8 rows affected (0.00 sec)</span><br><span class="line">Records: 8  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:59:04 &gt; insert into t222 (name,age) select name,age from t222;                                                                                       </span><br><span class="line">Query OK, 16 rows affected (0.00 sec)</span><br><span class="line">Records: 16  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:59:06 &gt; insert into t222 (name,age) select name,age from t222;   </span><br><span class="line">Query OK, 32 rows affected (0.00 sec)</span><br><span class="line">Records: 32  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:59:07 &gt; insert into t222 (name,age) select name,age from t222;   </span><br><span class="line">Query OK, 64 rows affected (0.00 sec)</span><br><span class="line">Records: 64  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:59:07 &gt; insert into t222 (name,age) select name,age from t222;   </span><br><span class="line">Query OK, 128 rows affected (0.00 sec)</span><br><span class="line">Records: 128  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:59:08 &gt; insert into t222 (name,age) select name,age from t222;   </span><br><span class="line">Query OK, 256 rows affected (0.00 sec)</span><br><span class="line">Records: 256  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:59:08 &gt; insert into t222 (name,age) select name,age from t222;   </span><br><span class="line">Query OK, 512 rows affected (0.00 sec)</span><br><span class="line">Records: 512  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 09:59:09 &gt; select count(*) from t222;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     1024 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>
<h4 id="解析ibd文件-1"><a href="#解析ibd文件-1" class="headerlink" title="解析ibd文件"></a>解析ibd文件</h4><p>实战mysql安装在/usr/local/percona，数据目录在/hwdata/data/percona，注意保存数据文件。<br>当设置了使用共享表空间(innodb_file_per_table=0)时，所有数据文件存在在ibdata1文件里面，不再是存在在单独表中，此时需要从ibdata1提取出需要被恢复的表<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ./page_parser -5 -f /tmp/ibdata1 </span><br><span class="line">Opening file: /tmp/ibdata1:</span><br><span class="line">64513           ID of device containing file</span><br><span class="line">1597426         inode number</span><br><span class="line">33184           protection</span><br><span class="line">1               number of hard links</span><br><span class="line">0               user ID of owner</span><br><span class="line">0               group ID of owner</span><br><span class="line">0               device ID (if special file)</span><br><span class="line">1073741824              total size, in bytes</span><br><span class="line">4096            blocksize for filesystem I/O</span><br><span class="line">2097160         number of blocks allocated</span><br><span class="line">1500256783      time of last access</span><br><span class="line">1500256790      time of last modification</span><br><span class="line">1500256790      time of last status change</span><br><span class="line">1073741824      Size to process in bytes</span><br><span class="line">104857600       Disk cache size in bytes</span><br><span class="line">1.65% done. 2017-07-17 10:03:48 ETA(in 00:00 hours). Processing speed: 17666552 B/sec</span><br><span class="line">3.41% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19000304 B/sec</span><br><span class="line">5.18% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19005354 B/sec</span><br><span class="line">6.96% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19008049 B/sec</span><br><span class="line">8.73% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19015298 B/sec</span><br><span class="line">10.47% done. 2017-07-17 10:03:45 ETA(in 00:00 hours). Processing speed: 18719062 B/sec</span><br><span class="line">12.24% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19008805 B/sec</span><br><span class="line">14.01% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19009523 B/sec</span><br><span class="line">15.78% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19007004 B/sec</span><br><span class="line">17.55% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19008533 B/sec</span><br><span class="line">19.32% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19008676 B/sec</span><br><span class="line">21.06% done. 2017-07-17 10:03:45 ETA(in 00:00 hours). Processing speed: 18715203 B/sec</span><br><span class="line">22.83% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19007750 B/sec</span><br><span class="line">24.60% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19002802 B/sec</span><br><span class="line">26.37% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18998409 B/sec</span><br><span class="line">28.14% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18991699 B/sec</span><br><span class="line">29.88% done. 2017-07-17 10:03:45 ETA(in 00:00 hours). Processing speed: 18708371 B/sec</span><br><span class="line">31.65% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18999365 B/sec</span><br><span class="line">33.42% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18997104 B/sec</span><br><span class="line">35.19% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19001358 B/sec</span><br><span class="line">36.96% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18999823 B/sec</span><br><span class="line">38.73% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18997814 B/sec</span><br><span class="line">40.47% done. 2017-07-17 10:03:45 ETA(in 00:00 hours). Processing speed: 18706585 B/sec</span><br><span class="line">42.24% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18996668 B/sec</span><br><span class="line">44.01% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18998094 B/sec</span><br><span class="line">45.78% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18998427 B/sec</span><br><span class="line">47.55% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19002403 B/sec</span><br><span class="line">49.30% done. 2017-07-17 10:03:45 ETA(in 00:00 hours). Processing speed: 18724158 B/sec</span><br><span class="line">51.06% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18997507 B/sec</span><br><span class="line">52.83% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18999524 B/sec</span><br><span class="line">54.60% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18998796 B/sec</span><br><span class="line">56.37% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19000200 B/sec</span><br><span class="line">58.14% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18998670 B/sec</span><br><span class="line">59.88% done. 2017-07-17 10:03:45 ETA(in 00:00 hours). Processing speed: 18699601 B/sec</span><br><span class="line">61.65% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19000413 B/sec</span><br><span class="line">63.42% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18997737 B/sec</span><br><span class="line">65.19% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18996538 B/sec</span><br><span class="line">66.96% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18999244 B/sec</span><br><span class="line">68.70% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18704824 B/sec</span><br><span class="line">70.47% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19002702 B/sec</span><br><span class="line">72.24% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19002732 B/sec</span><br><span class="line">74.01% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18999341 B/sec</span><br><span class="line">75.78% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19001510 B/sec</span><br><span class="line">77.55% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18998098 B/sec</span><br><span class="line">79.29% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18706109 B/sec</span><br><span class="line">81.06% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19007616 B/sec</span><br><span class="line">82.83% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19007630 B/sec</span><br><span class="line">84.60% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19004630 B/sec</span><br><span class="line">86.37% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19004716 B/sec</span><br><span class="line">88.12% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18717386 B/sec</span><br><span class="line">89.89% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19005803 B/sec</span><br><span class="line">91.66% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19007785 B/sec</span><br><span class="line">93.43% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19006419 B/sec</span><br><span class="line">95.20% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19004360 B/sec</span><br><span class="line">96.97% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 19008201 B/sec</span><br><span class="line">98.73% done. 2017-07-17 10:03:44 ETA(in 00:00 hours). Processing speed: 18940047 B/sec</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ll -t</span><br><span class="line">总用量 3172</span><br><span class="line">drwxr-xr-x  4 root root     4096 7月  17 10:18 pages-1500257904</span><br><span class="line">-rwxr-xr-x  1 root root   979051 7月  17 10:18 ibdconnect</span><br><span class="line">-rwxr-xr-x  1 root root    14873 7月  17 10:18 innochecksum</span><br><span class="line">-rwxr-xr-x  1 root root  1346155 7月  17 10:18 page_parser</span><br><span class="line">-rwxr-xr-x  1 root root   748761 7月  17 10:18 constraints_parser</span><br><span class="line">drwxr-xr-x  2 root root     4096 7月  17 10:18 lib</span><br><span class="line">drwxr-xr-x 40  510 wheel    4096 7月  17 10:18 mysql-source</span><br><span class="line">drwxr-xr-x  2  510 wheel    4096 8月  28 2011 docs</span><br><span class="line">drwxr-xr-x  2  510 wheel    4096 8月  28 2011 include</span><br><span class="line">-rw-r--r--  1  510 wheel    6269 8月  28 2011 check_data.c</span><br><span class="line">-rw-r--r--  1  510 wheel   22172 8月  28 2011 constraints_parser.c</span><br><span class="line">-rwxr-xr-x  1  510 wheel   12051 8月  28 2011 create_defs.pl</span><br><span class="line">-rwxr-xr-x  1  510 wheel    1978 8月  28 2011 fetch_data.sh</span><br><span class="line">-rw-r--r--  1  510 wheel   12200 8月  28 2011 ibdconnect.c</span><br><span class="line">-rw-r--r--  1  510 wheel    8262 8月  28 2011 incrementalupdate.c</span><br><span class="line">-rw-r--r--  1  510 wheel    9117 8月  28 2011 innochecksum.c</span><br><span class="line">-rw-r--r--  1  510 wheel      74 8月  28 2011 INSTALL</span><br><span class="line">-rw-r--r--  1  510 wheel    2676 8月  28 2011 Makefile</span><br><span class="line">-rw-r--r--  1  510 wheel   15239 8月  28 2011 page_parser.c</span><br><span class="line">-rw-r--r--  1  510 wheel   10608 8月  28 2011 print_data.c</span><br><span class="line">-rwxr-xr-x  1  510 wheel     302 8月  28 2011 split_dump.pl</span><br><span class="line">-rw-r--r--  1  510 wheel    2046 8月  28 2011 tables_dict.c</span><br></pre></td></tr></table></figure></p>
<h4 id="从ibdata1提取待恢复数据"><a href="#从ibdata1提取待恢复数据" class="headerlink" title="从ibdata1提取待恢复数据"></a>从ibdata1提取待恢复数据</h4><p>由于ibdata1恢复的是所有数据，需要从这些数据找到误操作的表，通过查询元数据，得到表空间的id和name<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# mysql -uroot -p123456 </span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 39</span><br><span class="line">Server version: 5.6.36-82.0-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 10:06:55 &gt; use information_schema;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [information_schema] 10:06:58 &gt; select i.INDEX_ID, i.NAME FROM INNODB_SYS_INDEXES as i INNER JOIN INNODB_SYS_TABLES as t USING(TABLE_ID) WHERE t.NAME=&apos;test111/t222&apos;;</span><br><span class="line">+----------+---------+</span><br><span class="line">| INDEX_ID | NAME    |</span><br><span class="line">+----------+---------+</span><br><span class="line">|       20 | PRIMARY |</span><br><span class="line">|       21 | idx_age |</span><br><span class="line">+----------+---------+</span><br><span class="line">2 rows in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [information_schema] 10:06:59 &gt; exit</span><br><span class="line">Bye</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ll pages-1500256968/FIL_PAGE_INDEX/</span><br><span class="line">总用量 68</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-1</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-11</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-12</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-13</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-14</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-15</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-16</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-17</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-18</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-19</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-2</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-20</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-21</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-3</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-4</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 0-5</span><br><span class="line">drwxr-xr-x 2 root root 4096 7月  17 10:02 4294967295-0</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]#</span><br></pre></td></tr></table></figure></p>
<h4 id="结果分析-1"><a href="#结果分析-1" class="headerlink" title="结果分析"></a>结果分析</h4><p>从下面的解析后的结果看到，当前目录pages-1500257904，其中20为主键索引的index_id,21为二级索引的index_id,该id可以通过开启innodb_table_monitor查看<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ll pages-1500256968/FIL_PAGE_INDEX/0-20/</span><br><span class="line">总用量 128</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 10:02 15-00000054.page</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 10:02 17-00000056.page</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 10:02 18-00000057.page</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 10:02 19-00000058.page</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 10:02 20-00000054.page</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 10:02 22-00000057.page</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 10:02 23-00000056.page</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 10:02 24-00000058.page</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ll pages-1500256968/FIL_PAGE_INDEX/0-21</span><br><span class="line">总用量 32</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 10:02 16-00000055.page</span><br><span class="line">-rw-r--r-- 1 root root 16384 7月  17 10:02 21-00000055.page</span><br></pre></td></tr></table></figure></p>
<h4 id="生成表定义-1"><a href="#生成表定义-1" class="headerlink" title="生成表定义"></a>生成表定义</h4><p>由于该工具在解析数据pages的时候，需要获得该table的表结构定义，所以需要执行如下命令。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ./create_defs.pl --host localhost --user root --password 123456 --db test111 --table t222 &gt; include/table_defs.h</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# cat include/table_defs.h</span><br><span class="line">#ifndef table_defs_h</span><br><span class="line">#define table_defs_h</span><br><span class="line"></span><br><span class="line">// Table definitions</span><br><span class="line">table_def_t table_definitions[] = &#123;</span><br><span class="line">        &#123;</span><br><span class="line">                name: &quot;t222&quot;,</span><br><span class="line">                &#123;</span><br><span class="line">                        &#123; /* int(10) unsigned */</span><br><span class="line">                                name: &quot;id&quot;,</span><br><span class="line">                                type: FT_UINT,</span><br><span class="line">                                fixed_length: 4,</span><br><span class="line"></span><br><span class="line">                                has_limits: FALSE,</span><br><span class="line">                                limits: &#123;</span><br><span class="line">                                        can_be_null: FALSE,</span><br><span class="line">                                        uint_min_val: 0,</span><br><span class="line">                                        uint_max_val: 4294967295ULL</span><br><span class="line">                                &#125;,</span><br><span class="line"></span><br><span class="line">                                can_be_null: FALSE</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123; /*  */</span><br><span class="line">                                name: &quot;DB_TRX_ID&quot;,</span><br><span class="line">                                type: FT_INTERNAL,</span><br><span class="line">                                fixed_length: 6,</span><br><span class="line"></span><br><span class="line">                                can_be_null: FALSE</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123; /*  */</span><br><span class="line">                                name: &quot;DB_ROLL_PTR&quot;,</span><br><span class="line">                                type: FT_INTERNAL,</span><br><span class="line">                                fixed_length: 7,</span><br><span class="line"></span><br><span class="line">                                can_be_null: FALSE</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123; /* varchar(20) */</span><br><span class="line">                                name: &quot;name&quot;,</span><br><span class="line">                                type: FT_CHAR,</span><br><span class="line">                                min_length: 0,</span><br><span class="line">                                max_length: 60,</span><br><span class="line"></span><br><span class="line">                                has_limits: FALSE,</span><br><span class="line">                                limits: &#123;</span><br><span class="line">                                        can_be_null: TRUE,</span><br><span class="line">                                        char_min_len: 0,</span><br><span class="line">                                        char_max_len: 60,</span><br><span class="line">                                        char_ascii_only: TRUE</span><br><span class="line">                                &#125;,</span><br><span class="line"></span><br><span class="line">                                can_be_null: TRUE</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123; /* int(11) */</span><br><span class="line">                                name: &quot;age&quot;,</span><br><span class="line">                                type: FT_INT,</span><br><span class="line">                                fixed_length: 4,</span><br><span class="line"></span><br><span class="line">                                has_limits: FALSE,</span><br><span class="line">                                limits: &#123;</span><br><span class="line">                                        can_be_null: TRUE,</span><br><span class="line">                                        int_min_val: -2147483648LL,</span><br><span class="line">                                        int_max_val: 2147483647LL</span><br><span class="line">                                &#125;,</span><br><span class="line"></span><br><span class="line">                                can_be_null: TRUE</span><br><span class="line">                        &#125;,</span><br><span class="line">                        &#123; type: FT_NONE &#125;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">#endif</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# </span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# make</span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -c tables_dict.c -o lib/tables_dict.o</span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -c check_data.c -o lib/check_data.o</span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -o constraints_parser constraints_parser.c lib/tables_dict.o lib/print_data.o lib/check_data.o lib/libut.a lib/libmystrings.a</span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -static -lrt -o page_parser page_parser.c lib/tables_dict.o lib/libut.a </span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# make</span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -c tables_dict.c -o lib/tables_dict.o</span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -c print_data.c -o lib/print_data.o </span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -o constraints_parser constraints_parser.c lib/tables_dict.o lib/print_data.o lib/check_data.o lib/libut.a lib/libmystrings.a</span><br><span class="line">gcc -DHAVE_OFFSET64_T -D_FILE_OFFSET_BITS=64 -D_LARGEFILE64_SOURCE=1 -D_LARGEFILE_SOURCE=1 -Wall -O3 -g -I include -I mysql-source/include -I mysql-source/innobase/include -static -lrt -o page_parser page_parser.c lib/tables_dict.o lib/libut.a</span><br></pre></td></tr></table></figure></p>
<p>上面的命令会将t222表的表定义传入到table_defs.h中，在生成了表结构定义后，重新make该恢复工具  </p>
<p><font color="#dd0000">注意：需要make 2次</font><br> </p>
<h4 id="开始提取page中删除的数据-1"><a href="#开始提取page中删除的数据-1" class="headerlink" title="开始提取page中删除的数据"></a>开始提取page中删除的数据</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# ./constraints_parser -5 -f pages-1500258331/FIL_PAGE_INDEX/0-20/ &gt; /tmp/0_t222.sql            </span><br><span class="line">LOAD DATA INFILE &apos;/usr/src/percona-data-recovery-tool-for-innodb-0.5/dumps/default/t222&apos; REPLACE INTO TABLE `t222` FIELDS TERMINATED BY &apos;\t&apos; OPTIONALLY ENCLOSED BY &apos;&quot;&apos; LINES STARTING BY &apos;t222\t&apos; (id, name, age);</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# cat /tmp/0_t222.sql |wc -l</span><br><span class="line">2048</span><br><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# head -10 /tmp/0_t222.sql </span><br><span class="line">t222    1145    &quot;jiessie&quot;       18</span><br><span class="line">t222    1146    &quot;jiessie&quot;       18</span><br><span class="line">t222    1147    &quot;jiessie&quot;       18</span><br><span class="line">t222    1148    &quot;jiessie&quot;       18</span><br><span class="line">t222    1149    &quot;jiessie&quot;       18</span><br><span class="line">t222    1150    &quot;jiessie&quot;       18</span><br><span class="line">t222    1151    &quot;jiessie&quot;       18</span><br><span class="line">t222    1152    &quot;jiessie&quot;       18</span><br><span class="line">t222    1153    &quot;jiessie&quot;       18</span><br><span class="line">t222    1154    &quot;jiessie&quot;       18</span><br></pre></td></tr></table></figure>
<p>从结果上来看，数据重复了一份，通过load data导入只导入一份正常的数据<br>参数解释：<br>-5 -f的参数和page_parser相同，代表 row format为Compact ；<br>-D:该参数的含义为代表恢复删除的数据页； </p>
<h4 id="恢复数据-1"><a href="#恢复数据-1" class="headerlink" title="恢复数据"></a>恢复数据</h4><p>使用上面constraints_parser执行后的load data导入数据，需要注意目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">[root@iZuf6c08fdv8duubho2b0rZ percona-data-recovery-tool-for-innodb-0.5]# mysql -uroot -p123456</span><br><span class="line">Warning: Using a password on the command line interface can be insecure.</span><br><span class="line">Welcome to the MySQL monitor.  Commands end with ; or \g.</span><br><span class="line">Your MySQL connection id is 108</span><br><span class="line">Server version: 5.6.36-82.0-log Source distribution</span><br><span class="line"></span><br><span class="line">Copyright (c) 2009-2017 Percona LLC and/or its affiliates</span><br><span class="line">Copyright (c) 2000, 2017, Oracle and/or its affiliates. All rights reserved.</span><br><span class="line"></span><br><span class="line">Oracle is a registered trademark of Oracle Corporation and/or its</span><br><span class="line">affiliates. Other names may be trademarks of their respective</span><br><span class="line">owners.</span><br><span class="line"></span><br><span class="line">Type &apos;help;&apos; or &apos;\h&apos; for help. Type &apos;\c&apos; to clear the current input statement.</span><br><span class="line"></span><br><span class="line">MySQL [(none)] 10:28:16 &gt; use test111;</span><br><span class="line">Database changed</span><br><span class="line">MySQL [test111] 10:28:20 &gt; LOAD DATA INFILE &apos;/tmp/0_t222.sql&apos; REPLACE INTO TABLE `t222` FIELDS TERMINATED BY &apos;\t&apos; OPTIONALLY ENCLOSED BY &apos;&quot;&apos; LINES STARTING BY &apos;t222\t&apos; (id, name, age);</span><br><span class="line">Query OK, 2048 rows affected (0.01 sec)</span><br><span class="line">Records: 2048  Deleted: 0  Skipped: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MySQL [test111] 10:28:39 &gt; select count(*) from t222;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|     1024 |</span><br><span class="line">+----------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">MySQL [test111] 10:28:44 &gt; select * from t222 limit 10;</span><br><span class="line">+----+---------+------+</span><br><span class="line">| id | name    | age  |</span><br><span class="line">+----+---------+------+</span><br><span class="line">|  1 | jiessie |   18 |</span><br><span class="line">|  2 | jiessie |   18 |</span><br><span class="line">|  3 | jiessie |   18 |</span><br><span class="line">|  4 | jiessie |   18 |</span><br><span class="line">|  6 | jiessie |   18 |</span><br><span class="line">|  7 | jiessie |   18 |</span><br><span class="line">|  8 | jiessie |   18 |</span><br><span class="line">|  9 | jiessie |   18 |</span><br><span class="line">| 13 | jiessie |   18 |</span><br><span class="line">| 14 | jiessie |   18 |</span><br><span class="line">+----+---------+------+</span><br><span class="line">10 rows in set (0.00 sec)</span><br></pre></td></tr></table></figure></p>
<p>从结果看，数据恢复完成   </p>
<h2 id="结束语"><a href="#结束语" class="headerlink" title="结束语"></a>结束语</h2><p>Percona Data Recovery Tool for InnoDB工具并不保证100%能够恢复数据，而且会存在丢失数据的现象，特别是当发生误删除后，数据文件并没有第一时间保存起来，而导致了被重写。truncate操作在此不做演示，建议还是做好备份恢复工作，并做日常的演练。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/percona/" rel="tag"># percona</a>
          
            <a href="/tags/innodb/" rel="tag"># innodb</a>
          
            <a href="/tags/recovery/" rel="tag"># recovery</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/percona-server-5-6-自制rpm包.html" rel="next" title="percona server 5.6 自制rpm包">
                <i class="fa fa-chevron-left"></i> percona server 5.6 自制rpm包
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/MongoDB从MMAPv1在线迁移至WiredTiger引擎.html" rel="prev" title="MongoDB从MMAPv1在线迁移至WiredTiger引擎">
                MongoDB从MMAPv1在线迁移至WiredTiger引擎 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Jiessie</p>
              <p class="site-description motion-element" itemprop="description">最怕一生碌碌无为,还说平凡难能可贵！</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">10</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                
                  <span class="site-state-item-count">7</span>
                  <span class="site-state-item-name">分类</span>
                
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">标签</span>
                
              </div>
            

          </nav>

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#注意事项"><span class="nav-number">2.</span> <span class="nav-text">注意事项</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#原理"><span class="nav-number">3.</span> <span class="nav-text">原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#表空间"><span class="nav-number">4.</span> <span class="nav-text">表空间</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#准备"><span class="nav-number">5.</span> <span class="nav-text">准备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装依赖"><span class="nav-number">6.</span> <span class="nav-text">安装依赖</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#安装Percona-Data-Recovery-Tool"><span class="nav-number">7.</span> <span class="nav-text">安装Percona Data Recovery Tool</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#恢复实战-delete误操作"><span class="nav-number">8.</span> <span class="nav-text">恢复实战(delete误操作)</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#innodb-file-per-table-1"><span class="nav-number">8.1.</span> <span class="nav-text">innodb_file_per_table=1</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#模拟数据被误删除"><span class="nav-number">8.1.1.</span> <span class="nav-text">模拟数据被误删除</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解析ibd文件"><span class="nav-number">8.1.2.</span> <span class="nav-text">解析ibd文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#结果分析"><span class="nav-number">8.1.3.</span> <span class="nav-text">结果分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成表定义"><span class="nav-number">8.1.4.</span> <span class="nav-text">生成表定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#开始提取page中删除的数据"><span class="nav-number">8.1.5.</span> <span class="nav-text">开始提取page中删除的数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#恢复数据"><span class="nav-number">8.1.6.</span> <span class="nav-text">恢复数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#恢复脚本"><span class="nav-number">8.1.7.</span> <span class="nav-text">恢复脚本</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#innodb-file-per-table-0"><span class="nav-number">8.2.</span> <span class="nav-text">innodb_file_per_table=0</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#模拟数据被误删除-1"><span class="nav-number">8.2.1.</span> <span class="nav-text">模拟数据被误删除</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#解析ibd文件-1"><span class="nav-number">8.2.2.</span> <span class="nav-text">解析ibd文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#从ibdata1提取待恢复数据"><span class="nav-number">8.2.3.</span> <span class="nav-text">从ibdata1提取待恢复数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#结果分析-1"><span class="nav-number">8.2.4.</span> <span class="nav-text">结果分析</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#生成表定义-1"><span class="nav-number">8.2.5.</span> <span class="nav-text">生成表定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#开始提取page中删除的数据-1"><span class="nav-number">8.2.6.</span> <span class="nav-text">开始提取page中删除的数据</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#恢复数据-1"><span class="nav-number">8.2.7.</span> <span class="nav-text">恢复数据</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#结束语"><span class="nav-number">9.</span> <span class="nav-text">结束语</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jiessie</span>

  
</div>


  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Muse</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
